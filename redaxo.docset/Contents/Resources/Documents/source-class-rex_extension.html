<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1"> 1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2"> 2 
</span><span class="l" id="3"> 3 <span class="php-comment">/**
</span></span><span class="l" id="4"> 4 <span class="php-comment"> * Klasse die Einsprungpunkte zur Erweiterung der Kernfunktionalitaetet bietet.
</span></span><span class="l" id="5"> 5 <span class="php-comment"> *
</span></span><span class="l" id="6"> 6 <span class="php-comment"> * @author Markus Staab
</span></span><span class="l" id="7"> 7 <span class="php-comment"> *
</span></span><span class="l" id="8"> 8 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="9"> 9 <span class="php-comment"> */</span>
</span><span class="l" id="10">10 <span class="php-keyword1">abstract</span> <span class="php-keyword1">class</span> rex_extension
</span><span class="l" id="11">11 {
</span><span class="l" id="12">12     <span class="php-keyword1">use</span> rex_factory_trait;
</span><span class="l" id="13">13 
</span><span class="l" id="14">14     <span class="php-keyword1">const</span> EARLY = -<span class="php-num">1</span>;
</span><span class="l" id="15">15     <span class="php-keyword1">const</span> NORMAL = <span class="php-num">0</span>;
</span><span class="l" id="16">16     <span class="php-keyword1">const</span> LATE = <span class="php-num">1</span>;
</span><span class="l" id="17">17 
</span><span class="l" id="18">18     <span class="php-comment">/**
</span></span><span class="l" id="19">19 <span class="php-comment">     * Array of registered extensions.
</span></span><span class="l" id="20">20 <span class="php-comment">     *
</span></span><span class="l" id="21">21 <span class="php-comment">     * @var array
</span></span><span class="l" id="22">22 <span class="php-comment">     */</span>
</span><span class="l" id="23">23     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$extensions</span> = [];
</span><span class="l" id="24">24 
</span><span class="l" id="25">25     <span class="php-comment">/**
</span></span><span class="l" id="26">26 <span class="php-comment">     * Registers an extension point.
</span></span><span class="l" id="27">27 <span class="php-comment">     *
</span></span><span class="l" id="28">28 <span class="php-comment">     * @param rex_extension_point $extensionPoint Extension point
</span></span><span class="l" id="29">29 <span class="php-comment">     *
</span></span><span class="l" id="30">30 <span class="php-comment">     * @return mixed Subject, maybe adjusted by the extensions
</span></span><span class="l" id="31">31 <span class="php-comment">     */</span>
</span><span class="l" id="32">32     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> registerPoint(rex_extension_point <span class="php-var">$extensionPoint</span>)
</span><span class="l" id="33">33     {
</span><span class="l" id="34">34         <span class="php-keyword1">if</span> (<span class="php-keyword1">static</span>::hasFactoryClass()) {
</span><span class="l" id="35">35             <span class="php-keyword1">return</span> <span class="php-keyword1">static</span>::callFactoryClass(__FUNCTION__, <span class="php-keyword2">func_get_args</span>());
</span><span class="l" id="36">36         }
</span><span class="l" id="37">37 
</span><span class="l" id="38">38         <span class="php-var">$name</span> = <span class="php-var">$extensionPoint</span>-&gt;getName();
</span><span class="l" id="39">39 
</span><span class="l" id="40">40         <span class="php-keyword1">foreach</span> ([self::EARLY, self::NORMAL, self::LATE] <span class="php-keyword1">as</span> <span class="php-var">$level</span>) {
</span><span class="l" id="41">41             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(self::<span class="php-var">$extensions</span>[<span class="php-var">$name</span>][<span class="php-var">$level</span>]) &amp;&amp; <span class="php-keyword2">is_array</span>(self::<span class="php-var">$extensions</span>[<span class="php-var">$name</span>][<span class="php-var">$level</span>])) {
</span><span class="l" id="42">42                 <span class="php-keyword1">foreach</span> (self::<span class="php-var">$extensions</span>[<span class="php-var">$name</span>][<span class="php-var">$level</span>] <span class="php-keyword1">as</span> <span class="php-var">$extensionAndParams</span>) {
</span><span class="l" id="43">43                     <span class="php-keyword1">list</span>(<span class="php-var">$extension</span>, <span class="php-var">$params</span>) = <span class="php-var">$extensionAndParams</span>;
</span><span class="l" id="44">44                     <span class="php-var">$extensionPoint</span>-&gt;setExtensionParams(<span class="php-var">$params</span>);
</span><span class="l" id="45">45                     <span class="php-var">$subject</span> = <span class="php-keyword2">call_user_func</span>(<span class="php-var">$extension</span>, <span class="php-var">$extensionPoint</span>);
</span><span class="l" id="46">46                     <span class="php-comment">// Update subject only if the EP is not readonly and the extension has returned something</span>
</span><span class="l" id="47">47                     <span class="php-keyword1">if</span> (!<span class="php-var">$extensionPoint</span>-&gt;isReadonly() &amp;&amp; <span class="php-keyword1">null</span> !== <span class="php-var">$subject</span>) {
</span><span class="l" id="48">48                         <span class="php-var">$extensionPoint</span>-&gt;setSubject(<span class="php-var">$subject</span>);
</span><span class="l" id="49">49                     }
</span><span class="l" id="50">50                 }
</span><span class="l" id="51">51             }
</span><span class="l" id="52">52         }
</span><span class="l" id="53">53 
</span><span class="l" id="54">54         <span class="php-keyword1">return</span> <span class="php-var">$extensionPoint</span>-&gt;getSubject();
</span><span class="l" id="55">55     }
</span><span class="l" id="56">56 
</span><span class="l" id="57">57     <span class="php-comment">/**
</span></span><span class="l" id="58">58 <span class="php-comment">     * Registers an extension for an extension point.
</span></span><span class="l" id="59">59 <span class="php-comment">     *
</span></span><span class="l" id="60">60 <span class="php-comment">     * @param string|string[] $extensionPoint Name(s) of extension point(s)
</span></span><span class="l" id="61">61 <span class="php-comment">     * @param callable        $extension      Callback extension
</span></span><span class="l" id="62">62 <span class="php-comment">     * @param int             $level          Runlevel (`rex_extension::EARLY`, `rex_extension::NORMAL` or `rex_extension::LATE`)
</span></span><span class="l" id="63">63 <span class="php-comment">     * @param array           $params         Additional params
</span></span><span class="l" id="64">64 <span class="php-comment">     */</span>
</span><span class="l" id="65">65     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> register(<span class="php-var">$extensionPoint</span>, <span class="php-keyword1">callable</span> <span class="php-var">$extension</span>, <span class="php-var">$level</span> = self::NORMAL, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [])
</span><span class="l" id="66">66     {
</span><span class="l" id="67">67         <span class="php-keyword1">if</span> (<span class="php-keyword1">static</span>::hasFactoryClass()) {
</span><span class="l" id="68">68             <span class="php-keyword1">static</span>::callFactoryClass(__FUNCTION__, <span class="php-keyword2">func_get_args</span>());
</span><span class="l" id="69">69             <span class="php-keyword1">return</span>;
</span><span class="l" id="70">70         }
</span><span class="l" id="71">71         <span class="php-keyword1">foreach</span> ((<span class="php-keyword1">array</span>) <span class="php-var">$extensionPoint</span> <span class="php-keyword1">as</span> <span class="php-var">$ep</span>) {
</span><span class="l" id="72">72             self::<span class="php-var">$extensions</span>[<span class="php-var">$ep</span>][(int) <span class="php-var">$level</span>][] = [<span class="php-var">$extension</span>, <span class="php-var">$params</span>];
</span><span class="l" id="73">73         }
</span><span class="l" id="74">74     }
</span><span class="l" id="75">75 
</span><span class="l" id="76">76     <span class="php-comment">/**
</span></span><span class="l" id="77">77 <span class="php-comment">     * Checks whether an extension is registered for the given extension point.
</span></span><span class="l" id="78">78 <span class="php-comment">     *
</span></span><span class="l" id="79">79 <span class="php-comment">     * @param string $extensionPoint Name of extension point
</span></span><span class="l" id="80">80 <span class="php-comment">     *
</span></span><span class="l" id="81">81 <span class="php-comment">     * @return bool
</span></span><span class="l" id="82">82 <span class="php-comment">     */</span>
</span><span class="l" id="83">83     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> isRegistered(<span class="php-var">$extensionPoint</span>)
</span><span class="l" id="84">84     {
</span><span class="l" id="85">85         <span class="php-keyword1">if</span> (<span class="php-keyword1">static</span>::hasFactoryClass()) {
</span><span class="l" id="86">86             <span class="php-keyword1">return</span> <span class="php-keyword1">static</span>::callFactoryClass(__FUNCTION__, <span class="php-keyword2">func_get_args</span>());
</span><span class="l" id="87">87         }
</span><span class="l" id="88">88         <span class="php-keyword1">return</span> !<span class="php-keyword1">empty</span>(self::<span class="php-var">$extensions</span>[<span class="php-var">$extensionPoint</span>]);
</span><span class="l" id="89">89     }
</span><span class="l" id="90">90 }
</span><span class="l" id="91">91 </span></code></pre>
 </body>
</html>
