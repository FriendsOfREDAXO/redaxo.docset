<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Class to execute a sql dump.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="7">  7 <span class="php-comment"> */</span>
</span><span class="l" id="8">  8 <span class="php-keyword1">class</span> rex_sql_util
</span><span class="l" id="9">  9 {
</span><span class="l" id="10"> 10     <span class="php-comment">/**
</span></span><span class="l" id="11"> 11 <span class="php-comment">     * Allgemeine funktion die eine Datenbankspalte fortlaufend durchnummeriert.
</span></span><span class="l" id="12"> 12 <span class="php-comment">     * Dies ist z.B. nützlich beim Umgang mit einer Prioritäts-Spalte.
</span></span><span class="l" id="13"> 13 <span class="php-comment">     *
</span></span><span class="l" id="14"> 14 <span class="php-comment">     * @param string $tableName       Name der Datenbanktabelle
</span></span><span class="l" id="15"> 15 <span class="php-comment">     * @param string $priorColumnName Name der Spalte in der Tabelle, in der die Priorität (Integer) gespeichert wird
</span></span><span class="l" id="16"> 16 <span class="php-comment">     * @param string $whereCondition  Where-Bedingung zur Einschränkung des ResultSets
</span></span><span class="l" id="17"> 17 <span class="php-comment">     * @param string $orderBy         Sortierung des ResultSets
</span></span><span class="l" id="18"> 18 <span class="php-comment">     * @param int    $startBy         Startpriorität
</span></span><span class="l" id="19"> 19 <span class="php-comment">     */</span>
</span><span class="l" id="20"> 20     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> organizePriorities(<span class="php-var">$tableName</span>, <span class="php-var">$priorColumnName</span>, <span class="php-var">$whereCondition</span> = <span class="php-quote">''</span>, <span class="php-var">$orderBy</span> = <span class="php-quote">''</span>, <span class="php-var">$startBy</span> = <span class="php-num">1</span>)
</span><span class="l" id="21"> 21     {
</span><span class="l" id="22"> 22         <span class="php-comment">// Datenbankvariable initialisieren</span>
</span><span class="l" id="23"> 23         <span class="php-var">$qry</span> = <span class="php-quote">'SET @count='</span> . (<span class="php-var">$startBy</span> - <span class="php-num">1</span>);
</span><span class="l" id="24"> 24         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="25"> 25         <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-var">$qry</span>);
</span><span class="l" id="26"> 26 
</span><span class="l" id="27"> 27         <span class="php-comment">// Spalte updaten</span>
</span><span class="l" id="28"> 28         <span class="php-var">$qry</span> = <span class="php-quote">'UPDATE '</span> . <span class="php-var">$tableName</span> . <span class="php-quote">' SET '</span> . <span class="php-var">$priorColumnName</span> . <span class="php-quote">' = ( SELECT @count := @count +1 )'</span>;
</span><span class="l" id="29"> 29 
</span><span class="l" id="30"> 30         <span class="php-keyword1">if</span> (<span class="php-var">$whereCondition</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="31"> 31             <span class="php-var">$qry</span> .= <span class="php-quote">' WHERE '</span> . <span class="php-var">$whereCondition</span>;
</span><span class="l" id="32"> 32         }
</span><span class="l" id="33"> 33 
</span><span class="l" id="34"> 34         <span class="php-keyword1">if</span> (<span class="php-var">$orderBy</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="35"> 35             <span class="php-var">$qry</span> .= <span class="php-quote">' ORDER BY '</span> . <span class="php-var">$orderBy</span>;
</span><span class="l" id="36"> 36         }
</span><span class="l" id="37"> 37 
</span><span class="l" id="38"> 38         <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-var">$qry</span>);
</span><span class="l" id="39"> 39     }
</span><span class="l" id="40"> 40 
</span><span class="l" id="41"> 41     <span class="php-comment">/**
</span></span><span class="l" id="42"> 42 <span class="php-comment">     * Importiert die gegebene SQL-Datei in die Datenbank.
</span></span><span class="l" id="43"> 43 <span class="php-comment">     *
</span></span><span class="l" id="44"> 44 <span class="php-comment">     * @param string $file
</span></span><span class="l" id="45"> 45 <span class="php-comment">     * @param bool   $debug
</span></span><span class="l" id="46"> 46 <span class="php-comment">     *
</span></span><span class="l" id="47"> 47 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="48"> 48 <span class="php-comment">     *
</span></span><span class="l" id="49"> 49 <span class="php-comment">     * @return bool true bei Erfolg
</span></span><span class="l" id="50"> 50 <span class="php-comment">     */</span>
</span><span class="l" id="51"> 51     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> importDump(<span class="php-var">$file</span>, <span class="php-var">$debug</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="52"> 52     {
</span><span class="l" id="53"> 53         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="54"> 54         <span class="php-var">$sql</span>-&gt;setDebug(<span class="php-var">$debug</span>);
</span><span class="l" id="55"> 55         <span class="php-var">$error</span> = <span class="php-quote">''</span>;
</span><span class="l" id="56"> 56 
</span><span class="l" id="57"> 57         <span class="php-keyword1">foreach</span> (self::readSqlDump(<span class="php-var">$file</span>) <span class="php-keyword1">as</span> <span class="php-var">$query</span>) {
</span><span class="l" id="58"> 58             <span class="php-keyword1">try</span> {
</span><span class="l" id="59"> 59                 <span class="php-var">$sql</span>-&gt;setQuery(self::prepareQuery(<span class="php-var">$query</span>));
</span><span class="l" id="60"> 60             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="61"> 61                 <span class="php-var">$error</span> .= <span class="php-var">$e</span>-&gt;getMessage() . <span class="php-quote">"\n&lt;br /&gt;"</span>;
</span><span class="l" id="62"> 62             }
</span><span class="l" id="63"> 63         }
</span><span class="l" id="64"> 64         <span class="php-keyword1">if</span> (<span class="php-var">$error</span>) {
</span><span class="l" id="65"> 65             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-var">$error</span>, <span class="php-keyword1">null</span>, <span class="php-var">$sql</span>);
</span><span class="l" id="66"> 66         }
</span><span class="l" id="67"> 67 
</span><span class="l" id="68"> 68         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="69"> 69     }
</span><span class="l" id="70"> 70 
</span><span class="l" id="71"> 71     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> prepareQuery(<span class="php-var">$qry</span>)
</span><span class="l" id="72"> 72     {
</span><span class="l" id="73"> 73         <span class="php-comment">// rex::getUser() gibts im Setup nicht</span>
</span><span class="l" id="74"> 74         <span class="php-var">$user</span> = rex::getUser() ? rex::getUser()-&gt;getValue(<span class="php-quote">'login'</span>) : <span class="php-quote">''</span>;
</span><span class="l" id="75"> 75 
</span><span class="l" id="76"> 76         <span class="php-var">$qry</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'%USER%'</span>, <span class="php-var">$user</span>, <span class="php-var">$qry</span>);
</span><span class="l" id="77"> 77         <span class="php-var">$qry</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'%TIME%'</span>, <span class="php-keyword2">time</span>(), <span class="php-var">$qry</span>);
</span><span class="l" id="78"> 78         <span class="php-var">$qry</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'%TABLE_PREFIX%'</span>, rex::getTablePrefix(), <span class="php-var">$qry</span>);
</span><span class="l" id="79"> 79         <span class="php-var">$qry</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'%TEMP_PREFIX%'</span>, rex::getTempPrefix(), <span class="php-var">$qry</span>);
</span><span class="l" id="80"> 80 
</span><span class="l" id="81"> 81         <span class="php-keyword1">return</span> <span class="php-var">$qry</span>;
</span><span class="l" id="82"> 82     }
</span><span class="l" id="83"> 83 
</span><span class="l" id="84"> 84     <span class="php-comment">/**
</span></span><span class="l" id="85"> 85 <span class="php-comment">     * Reads a file and split all statements in it.
</span></span><span class="l" id="86"> 86 <span class="php-comment">     *
</span></span><span class="l" id="87"> 87 <span class="php-comment">     * @param string $file Path to the SQL-dump-file
</span></span><span class="l" id="88"> 88 <span class="php-comment">     *
</span></span><span class="l" id="89"> 89 <span class="php-comment">     * @return array
</span></span><span class="l" id="90"> 90 <span class="php-comment">     */</span>
</span><span class="l" id="91"> 91     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> readSqlDump(<span class="php-var">$file</span>)
</span><span class="l" id="92"> 92     {
</span><span class="l" id="93"> 93         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_file</span>(<span class="php-var">$file</span>) &amp;&amp; <span class="php-keyword2">is_readable</span>(<span class="php-var">$file</span>)) {
</span><span class="l" id="94"> 94             <span class="php-var">$ret</span> = [];
</span><span class="l" id="95"> 95             <span class="php-var">$sqlsplit</span> = [];
</span><span class="l" id="96"> 96             <span class="php-var">$fileContent</span> = <span class="php-keyword2">file_get_contents</span>(<span class="php-var">$file</span>);
</span><span class="l" id="97"> 97             self::splitSqlFile(<span class="php-var">$sqlsplit</span>, <span class="php-var">$fileContent</span>, <span class="php-quote">''</span>);
</span><span class="l" id="98"> 98 
</span><span class="l" id="99"> 99             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$sqlsplit</span>)) {
</span><span class="l" id="100">100                 <span class="php-keyword1">foreach</span> (<span class="php-var">$sqlsplit</span> <span class="php-keyword1">as</span> <span class="php-var">$qry</span>) {
</span><span class="l" id="101">101                     <span class="php-var">$ret</span>[] = <span class="php-var">$qry</span>[<span class="php-quote">'query'</span>];
</span><span class="l" id="102">102                 }
</span><span class="l" id="103">103             }
</span><span class="l" id="104">104 
</span><span class="l" id="105">105             <span class="php-keyword1">return</span> <span class="php-var">$ret</span>;
</span><span class="l" id="106">106         }
</span><span class="l" id="107">107 
</span><span class="l" id="108">108         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="109">109     }
</span><span class="l" id="110">110 
</span><span class="l" id="111">111     <span class="php-comment">/**
</span></span><span class="l" id="112">112 <span class="php-comment">     * Removes comment lines and splits up large sql files into individual queries.
</span></span><span class="l" id="113">113 <span class="php-comment">     *
</span></span><span class="l" id="114">114 <span class="php-comment">     * Last revision: September 23, 2001 - gandon
</span></span><span class="l" id="115">115 <span class="php-comment">     *
</span></span><span class="l" id="116">116 <span class="php-comment">     * @param array  $ret     the splitted sql commands
</span></span><span class="l" id="117">117 <span class="php-comment">     * @param string $sql     the sql commands
</span></span><span class="l" id="118">118 <span class="php-comment">     * @param int    $release the MySQL release number (because certains php3 versions
</span></span><span class="l" id="119">119 <span class="php-comment">     *                        can't get the value of a constant from within a function)
</span></span><span class="l" id="120">120 <span class="php-comment">     *
</span></span><span class="l" id="121">121 <span class="php-comment">     * @return bool always true
</span></span><span class="l" id="122">122 <span class="php-comment">     */</span>
</span><span class="l" id="123">123     <span class="php-comment">// Taken from phpmyadmin (read_dump.lib.php: PMA_splitSqlFile)</span>
</span><span class="l" id="124">124     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> splitSqlFile(&amp;<span class="php-var">$ret</span>, <span class="php-var">$sql</span>, <span class="php-var">$release</span>)
</span><span class="l" id="125">125     {
</span><span class="l" id="126">126         <span class="php-comment">// do not trim, see bug #1030644</span>
</span><span class="l" id="127">127         <span class="php-comment">//$sql          = trim($sql);</span>
</span><span class="l" id="128">128         <span class="php-var">$sql</span> = <span class="php-keyword2">rtrim</span>(<span class="php-var">$sql</span>, <span class="php-quote">"\n\r"</span>);
</span><span class="l" id="129">129         <span class="php-var">$sql_len</span> = <span class="php-keyword2">strlen</span>(<span class="php-var">$sql</span>);
</span><span class="l" id="130">130         <span class="php-var">$string_start</span> = <span class="php-quote">''</span>;
</span><span class="l" id="131">131         <span class="php-var">$in_string</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="132">132         <span class="php-var">$nothing</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="133">133         <span class="php-var">$time0</span> = <span class="php-keyword2">time</span>();
</span><span class="l" id="134">134 
</span><span class="l" id="135">135         <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$sql_len</span>; ++<span class="php-var">$i</span>) {
</span><span class="l" id="136">136             <span class="php-var">$char</span> = <span class="php-var">$sql</span>[<span class="php-var">$i</span>];
</span><span class="l" id="137">137 
</span><span class="l" id="138">138             <span class="php-comment">// We are in a string, check for not escaped end of strings except for</span>
</span><span class="l" id="139">139             <span class="php-comment">// backquotes that can't be escaped</span>
</span><span class="l" id="140">140             <span class="php-keyword1">if</span> (<span class="php-var">$in_string</span>) {
</span><span class="l" id="141">141                 <span class="php-keyword1">for</span> (; ;) {
</span><span class="l" id="142">142                     <span class="php-var">$i</span> = <span class="php-keyword2">strpos</span>(<span class="php-var">$sql</span>, <span class="php-var">$string_start</span>, <span class="php-var">$i</span>);
</span><span class="l" id="143">143                     <span class="php-comment">// No end of string found -&gt; add the current substring to the</span>
</span><span class="l" id="144">144                     <span class="php-comment">// returned array</span>
</span><span class="l" id="145">145                     <span class="php-keyword1">if</span> (!<span class="php-var">$i</span>) {
</span><span class="l" id="146">146                         <span class="php-var">$ret</span>[] = <span class="php-var">$sql</span>;
</span><span class="l" id="147">147                         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="148">148                     }
</span><span class="l" id="149">149                     <span class="php-comment">// Backquotes or no backslashes before quotes: it's indeed the</span>
</span><span class="l" id="150">150                     <span class="php-comment">// end of the string -&gt; exit the loop</span>
</span><span class="l" id="151">151                     <span class="php-keyword1">if</span> (<span class="php-var">$string_start</span> == <span class="php-quote">'`'</span> || <span class="php-var">$sql</span>[<span class="php-var">$i</span> - <span class="php-num">1</span>] != <span class="php-quote">'\\'</span>) {
</span><span class="l" id="152">152                         <span class="php-var">$string_start</span> = <span class="php-quote">''</span>;
</span><span class="l" id="153">153                         <span class="php-var">$in_string</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="154">154                         <span class="php-keyword1">break</span>;
</span><span class="l" id="155">155                     }
</span><span class="l" id="156">156                     <span class="php-comment">// one or more Backslashes before the presumed end of string...</span>
</span><span class="l" id="157">157 
</span><span class="l" id="158">158                     <span class="php-comment">// ... first checks for escaped backslashes</span>
</span><span class="l" id="159">159                     <span class="php-var">$j</span> = <span class="php-num">2</span>;
</span><span class="l" id="160">160                     <span class="php-var">$escaped_backslash</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="161">161                     <span class="php-keyword1">while</span> (<span class="php-var">$i</span> - <span class="php-var">$j</span> &gt; <span class="php-num">0</span> &amp;&amp; <span class="php-var">$sql</span>[<span class="php-var">$i</span> - <span class="php-var">$j</span>] == <span class="php-quote">'\\'</span>) {
</span><span class="l" id="162">162                         <span class="php-var">$escaped_backslash</span> = !<span class="php-var">$escaped_backslash</span>;
</span><span class="l" id="163">163                         ++<span class="php-var">$j</span>;
</span><span class="l" id="164">164                     }
</span><span class="l" id="165">165                     <span class="php-comment">// ... if escaped backslashes: it's really the end of the</span>
</span><span class="l" id="166">166                     <span class="php-comment">// string -&gt; exit the loop</span>
</span><span class="l" id="167">167                     <span class="php-keyword1">if</span> (<span class="php-var">$escaped_backslash</span>) {
</span><span class="l" id="168">168                         <span class="php-var">$string_start</span> = <span class="php-quote">''</span>;
</span><span class="l" id="169">169                         <span class="php-var">$in_string</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="170">170                         <span class="php-keyword1">break</span>;
</span><span class="l" id="171">171                     }
</span><span class="l" id="172">172                     <span class="php-comment">// ... else loop</span>
</span><span class="l" id="173">173 
</span><span class="l" id="174">174                     ++<span class="php-var">$i</span>;
</span><span class="l" id="175">175 
</span><span class="l" id="176">176                     <span class="php-comment">// end if...elseif...else</span>
</span><span class="l" id="177">177                 } <span class="php-comment">// end for</span>
</span><span class="l" id="178">178             } <span class="php-comment">// end if (in string)</span>
</span><span class="l" id="179">179 
</span><span class="l" id="180">180             <span class="php-comment">// lets skip comments (/*, -- and #)</span>
</span><span class="l" id="181">181             <span class="php-keyword1">elseif</span> ((<span class="php-var">$char</span> == <span class="php-quote">'-'</span> &amp;&amp; <span class="php-var">$sql_len</span> &gt; <span class="php-var">$i</span> + <span class="php-num">2</span> &amp;&amp; <span class="php-var">$sql</span>[<span class="php-var">$i</span> + <span class="php-num">1</span>] == <span class="php-quote">'-'</span> &amp;&amp; <span class="php-var">$sql</span>[<span class="php-var">$i</span> + <span class="php-num">2</span>] &lt;= <span class="php-quote">' '</span>) || <span class="php-var">$char</span> == <span class="php-quote">'#'</span> || (<span class="php-var">$char</span> == <span class="php-quote">'/'</span> &amp;&amp; <span class="php-var">$sql_len</span> &gt; <span class="php-var">$i</span> + <span class="php-num">1</span> &amp;&amp; <span class="php-var">$sql</span>[<span class="php-var">$i</span> + <span class="php-num">1</span>] == <span class="php-quote">'*'</span>)) {
</span><span class="l" id="182">182                 <span class="php-var">$i</span> = <span class="php-keyword2">strpos</span>(<span class="php-var">$sql</span>, <span class="php-var">$char</span> == <span class="php-quote">'/'</span> ? <span class="php-quote">'*/'</span> : <span class="php-quote">"\n"</span>, <span class="php-var">$i</span>);
</span><span class="l" id="183">183                 <span class="php-comment">// didn't we hit end of string?</span>
</span><span class="l" id="184">184                 <span class="php-keyword1">if</span> (<span class="php-var">$i</span> === <span class="php-keyword1">false</span>) {
</span><span class="l" id="185">185                     <span class="php-keyword1">break</span>;
</span><span class="l" id="186">186                 }
</span><span class="l" id="187">187                 <span class="php-keyword1">if</span> (<span class="php-var">$char</span> == <span class="php-quote">'/'</span>) {
</span><span class="l" id="188">188                     ++<span class="php-var">$i</span>;
</span><span class="l" id="189">189                 }
</span><span class="l" id="190">190             }
</span><span class="l" id="191">191 
</span><span class="l" id="192">192             <span class="php-comment">// We are not in a string, first check for delimiter...</span>
</span><span class="l" id="193">193             <span class="php-keyword1">elseif</span> (<span class="php-var">$char</span> == <span class="php-quote">';'</span>) {
</span><span class="l" id="194">194                 <span class="php-comment">// if delimiter found, add the parsed part to the returned array</span>
</span><span class="l" id="195">195                 <span class="php-var">$ret</span>[] = [<span class="php-quote">'query'</span> =&gt; <span class="php-keyword2">substr</span>(<span class="php-var">$sql</span>, <span class="php-num">0</span>, <span class="php-var">$i</span>), <span class="php-quote">'empty'</span> =&gt; <span class="php-var">$nothing</span>];
</span><span class="l" id="196">196                 <span class="php-var">$nothing</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="197">197                 <span class="php-var">$sql</span> = <span class="php-keyword2">ltrim</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$sql</span>, <span class="php-keyword2">min</span>(<span class="php-var">$i</span> + <span class="php-num">1</span>, <span class="php-var">$sql_len</span>)));
</span><span class="l" id="198">198                 <span class="php-var">$sql_len</span> = <span class="php-keyword2">strlen</span>(<span class="php-var">$sql</span>);
</span><span class="l" id="199">199                 <span class="php-keyword1">if</span> (<span class="php-var">$sql_len</span>) {
</span><span class="l" id="200">200                     <span class="php-var">$i</span> = -<span class="php-num">1</span>;
</span><span class="l" id="201">201                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="202">202                     <span class="php-comment">// The submited statement(s) end(s) here</span>
</span><span class="l" id="203">203                     <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="204">204                 }
</span><span class="l" id="205">205             } <span class="php-comment">// end else if (is delimiter)</span>
</span><span class="l" id="206">206 
</span><span class="l" id="207">207             <span class="php-comment">// ... then check for start of a string,...</span>
</span><span class="l" id="208">208             <span class="php-keyword1">elseif</span> ((<span class="php-var">$char</span> == <span class="php-quote">'"'</span>) || (<span class="php-var">$char</span> == <span class="php-quote">'\''</span>) || (<span class="php-var">$char</span> == <span class="php-quote">'`'</span>)) {
</span><span class="l" id="209">209                 <span class="php-var">$in_string</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="210">210                 <span class="php-var">$nothing</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="211">211                 <span class="php-var">$string_start</span> = <span class="php-var">$char</span>;
</span><span class="l" id="212">212             } <span class="php-comment">// end else if (is start of string)</span>
</span><span class="l" id="213">213 
</span><span class="l" id="214">214             <span class="php-keyword1">elseif</span> (<span class="php-var">$nothing</span>) {
</span><span class="l" id="215">215                 <span class="php-var">$nothing</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="216">216             }
</span><span class="l" id="217">217 
</span><span class="l" id="218">218             <span class="php-comment">// loic1: send a fake header each 30 sec. to bypass browser timeout</span>
</span><span class="l" id="219">219             <span class="php-var">$time1</span> = <span class="php-keyword2">time</span>();
</span><span class="l" id="220">220             <span class="php-keyword1">if</span> (<span class="php-var">$time1</span> &gt;= <span class="php-var">$time0</span> + <span class="php-num">30</span>) {
</span><span class="l" id="221">221                 <span class="php-var">$time0</span> = <span class="php-var">$time1</span>;
</span><span class="l" id="222">222                 <span class="php-keyword2">header</span>(<span class="php-quote">'X-pmaPing: Pong'</span>);
</span><span class="l" id="223">223             } <span class="php-comment">// end if</span>
</span><span class="l" id="224">224         } <span class="php-comment">// end for</span>
</span><span class="l" id="225">225 
</span><span class="l" id="226">226         <span class="php-comment">// add any rest to the returned array</span>
</span><span class="l" id="227">227         <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$sql</span>) &amp;&amp; <span class="php-keyword2">preg_match</span>(<span class="php-quote">'@[^[:space:]]+@'</span>, <span class="php-var">$sql</span>)) {
</span><span class="l" id="228">228             <span class="php-var">$ret</span>[] = [<span class="php-quote">'query'</span> =&gt; <span class="php-var">$sql</span>, <span class="php-quote">'empty'</span> =&gt; <span class="php-var">$nothing</span>];
</span><span class="l" id="229">229         }
</span><span class="l" id="230">230 
</span><span class="l" id="231">231         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="232">232     }
</span><span class="l" id="233">233 }
</span><span class="l" id="234">234 </span></code></pre>
 </body>
</html>
