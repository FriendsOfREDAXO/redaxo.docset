<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Klasse regelt den Zugriff auf Artikelinhalte.
</span></span><span class="l" id="5">  5 <span class="php-comment"> * Alle benötigten Daten werden von der DB bezogen.
</span></span><span class="l" id="6">  6 <span class="php-comment"> *
</span></span><span class="l" id="7">  7 <span class="php-comment"> * @package redaxo\structure\content
</span></span><span class="l" id="8">  8 <span class="php-comment"> */</span>
</span><span class="l" id="9">  9 <span class="php-keyword1">class</span> rex_article_content_base
</span><span class="l" id="10"> 10 {
</span><span class="l" id="11"> 11     <span class="php-keyword1">public</span> <span class="php-var">$warning</span>;
</span><span class="l" id="12"> 12     <span class="php-keyword1">public</span> <span class="php-var">$info</span>;
</span><span class="l" id="13"> 13     <span class="php-keyword1">public</span> <span class="php-var">$debug</span>;
</span><span class="l" id="14"> 14 
</span><span class="l" id="15"> 15     <span class="php-keyword1">public</span> <span class="php-var">$template_id</span>;
</span><span class="l" id="16"> 16     <span class="php-keyword1">public</span> <span class="php-var">$template_attributes</span>;
</span><span class="l" id="17"> 17 
</span><span class="l" id="18"> 18     <span class="php-keyword1">protected</span> <span class="php-var">$category_id</span>;
</span><span class="l" id="19"> 19     <span class="php-keyword1">protected</span> <span class="php-var">$article_id</span>;
</span><span class="l" id="20"> 20     <span class="php-keyword1">protected</span> <span class="php-var">$slice_id</span>;
</span><span class="l" id="21"> 21     <span class="php-keyword1">protected</span> <span class="php-var">$getSlice</span>;
</span><span class="l" id="22"> 22     <span class="php-keyword1">protected</span> <span class="php-var">$mode</span>;
</span><span class="l" id="23"> 23     <span class="php-keyword1">protected</span> <span class="php-var">$function</span>;
</span><span class="l" id="24"> 24 
</span><span class="l" id="25"> 25     <span class="php-keyword1">protected</span> <span class="php-var">$ctype</span>;
</span><span class="l" id="26"> 26     <span class="php-keyword1">protected</span> <span class="php-var">$clang</span>;
</span><span class="l" id="27"> 27 
</span><span class="l" id="28"> 28     <span class="php-keyword1">protected</span> <span class="php-var">$eval</span>;
</span><span class="l" id="29"> 29 
</span><span class="l" id="30"> 30     <span class="php-keyword1">protected</span> <span class="php-var">$slice_revision</span>;
</span><span class="l" id="31"> 31 
</span><span class="l" id="32"> 32     <span class="php-keyword1">protected</span> <span class="php-var">$ARTICLE</span>;
</span><span class="l" id="33"> 33 
</span><span class="l" id="34"> 34     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> __construct(<span class="php-var">$article_id</span> = <span class="php-keyword1">null</span>, <span class="php-var">$clang</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="35"> 35     {
</span><span class="l" id="36"> 36         <span class="php-var">$this</span>-&gt;article_id = <span class="php-num">0</span>;
</span><span class="l" id="37"> 37         <span class="php-var">$this</span>-&gt;template_id = <span class="php-num">0</span>;
</span><span class="l" id="38"> 38         <span class="php-var">$this</span>-&gt;ctype = -<span class="php-num">1</span>; <span class="php-comment">// zeigt alles an</span>
</span><span class="l" id="39"> 39         <span class="php-var">$this</span>-&gt;slice_id = <span class="php-num">0</span>;
</span><span class="l" id="40"> 40         <span class="php-var">$this</span>-&gt;getSlice = <span class="php-num">0</span>;
</span><span class="l" id="41"> 41 
</span><span class="l" id="42"> 42         <span class="php-var">$this</span>-&gt;mode = <span class="php-quote">'view'</span>;
</span><span class="l" id="43"> 43         <span class="php-var">$this</span>-&gt;<span class="php-keyword2">eval</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="44"> 44 
</span><span class="l" id="45"> 45         <span class="php-var">$this</span>-&gt;slice_revision = <span class="php-num">0</span>;
</span><span class="l" id="46"> 46 
</span><span class="l" id="47"> 47         <span class="php-var">$this</span>-&gt;debug = <span class="php-keyword1">false</span>;
</span><span class="l" id="48"> 48 
</span><span class="l" id="49"> 49         <span class="php-keyword1">if</span> (<span class="php-var">$clang</span> !== <span class="php-keyword1">null</span>) {
</span><span class="l" id="50"> 50             <span class="php-var">$this</span>-&gt;setCLang(<span class="php-var">$clang</span>);
</span><span class="l" id="51"> 51         } <span class="php-keyword1">else</span> {
</span><span class="l" id="52"> 52             <span class="php-var">$this</span>-&gt;setClang(rex_clang::getCurrentId());
</span><span class="l" id="53"> 53         }
</span><span class="l" id="54"> 54 
</span><span class="l" id="55"> 55         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="56"> 56         rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_INIT'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="57"> 57             <span class="php-quote">'article'</span> =&gt; <span class="php-var">$this</span>,
</span><span class="l" id="58"> 58             <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$article_id</span>,
</span><span class="l" id="59"> 59             <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="60"> 60         ]));
</span><span class="l" id="61"> 61 
</span><span class="l" id="62"> 62         <span class="php-keyword1">if</span> (<span class="php-var">$article_id</span> !== <span class="php-keyword1">null</span>) {
</span><span class="l" id="63"> 63             <span class="php-var">$this</span>-&gt;setArticleId(<span class="php-var">$article_id</span>);
</span><span class="l" id="64"> 64         }
</span><span class="l" id="65"> 65     }
</span><span class="l" id="66"> 66 
</span><span class="l" id="67"> 67     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> getSqlInstance()
</span><span class="l" id="68"> 68     {
</span><span class="l" id="69"> 69         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_object</span>(<span class="php-var">$this</span>-&gt;ARTICLE)) {
</span><span class="l" id="70"> 70             <span class="php-var">$this</span>-&gt;ARTICLE = rex_sql::factory();
</span><span class="l" id="71"> 71             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;debug) {
</span><span class="l" id="72"> 72                 <span class="php-var">$this</span>-&gt;ARTICLE-&gt;setDebug();
</span><span class="l" id="73"> 73             }
</span><span class="l" id="74"> 74         }
</span><span class="l" id="75"> 75         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;ARTICLE;
</span><span class="l" id="76"> 76     }
</span><span class="l" id="77"> 77 
</span><span class="l" id="78"> 78     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setSliceRevision(<span class="php-var">$sr</span>)
</span><span class="l" id="79"> 79     {
</span><span class="l" id="80"> 80         <span class="php-var">$this</span>-&gt;slice_revision = (int) <span class="php-var">$sr</span>;
</span><span class="l" id="81"> 81     }
</span><span class="l" id="82"> 82 
</span><span class="l" id="83"> 83     <span class="php-comment">// ----- Slice Id setzen für Editiermodus</span>
</span><span class="l" id="84"> 84     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setSliceId(<span class="php-var">$value</span>)
</span><span class="l" id="85"> 85     {
</span><span class="l" id="86"> 86         <span class="php-var">$this</span>-&gt;slice_id = <span class="php-var">$value</span>;
</span><span class="l" id="87"> 87     }
</span><span class="l" id="88"> 88 
</span><span class="l" id="89"> 89     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setClang(<span class="php-var">$value</span>)
</span><span class="l" id="90"> 90     {
</span><span class="l" id="91"> 91         <span class="php-keyword1">if</span> (!rex_clang::exists(<span class="php-var">$value</span>)) {
</span><span class="l" id="92"> 92             <span class="php-var">$value</span> = rex_clang::getCurrentId();
</span><span class="l" id="93"> 93         }
</span><span class="l" id="94"> 94         <span class="php-var">$this</span>-&gt;clang = <span class="php-var">$value</span>;
</span><span class="l" id="95"> 95     }
</span><span class="l" id="96"> 96 
</span><span class="l" id="97"> 97     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getArticleId()
</span><span class="l" id="98"> 98     {
</span><span class="l" id="99"> 99         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;article_id;
</span><span class="l" id="100">100     }
</span><span class="l" id="101">101 
</span><span class="l" id="102">102     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getClangId()
</span><span class="l" id="103">103     {
</span><span class="l" id="104">104         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;clang;
</span><span class="l" id="105">105     }
</span><span class="l" id="106">106 
</span><span class="l" id="107">107     <span class="php-comment">/**
</span></span><span class="l" id="108">108 <span class="php-comment">     * @deprecated since redaxo 5.6, use getClangId() instead
</span></span><span class="l" id="109">109 <span class="php-comment">     */</span>
</span><span class="l" id="110">110     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getClang()
</span><span class="l" id="111">111     {
</span><span class="l" id="112">112         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;clang;
</span><span class="l" id="113">113     }
</span><span class="l" id="114">114 
</span><span class="l" id="115">115     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setArticleId(<span class="php-var">$article_id</span>)
</span><span class="l" id="116">116     {
</span><span class="l" id="117">117         <span class="php-var">$article_id</span> = (int) <span class="php-var">$article_id</span>;
</span><span class="l" id="118">118         <span class="php-var">$this</span>-&gt;article_id = <span class="php-var">$article_id</span>;
</span><span class="l" id="119">119 
</span><span class="l" id="120">120         <span class="php-comment">// ---------- select article</span>
</span><span class="l" id="121">121         <span class="php-var">$sql</span> = <span class="php-var">$this</span>-&gt;getSqlInstance();
</span><span class="l" id="122">122         <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SELECT * FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article WHERE '</span> . rex::getTablePrefix() . <span class="php-quote">'article.id=? AND clang_id=?'</span>, [<span class="php-var">$article_id</span>, <span class="php-var">$this</span>-&gt;clang]);
</span><span class="l" id="123">123 
</span><span class="l" id="124">124         <span class="php-keyword1">if</span> (<span class="php-var">$sql</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="125">125             <span class="php-var">$this</span>-&gt;template_id = <span class="php-var">$this</span>-&gt;getValue(<span class="php-quote">'template_id'</span>);
</span><span class="l" id="126">126             <span class="php-var">$this</span>-&gt;category_id = <span class="php-var">$this</span>-&gt;getValue(<span class="php-quote">'category_id'</span>);
</span><span class="l" id="127">127             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="128">128         }
</span><span class="l" id="129">129 
</span><span class="l" id="130">130         <span class="php-var">$this</span>-&gt;article_id = <span class="php-num">0</span>;
</span><span class="l" id="131">131         <span class="php-var">$this</span>-&gt;template_id = <span class="php-num">0</span>;
</span><span class="l" id="132">132         <span class="php-var">$this</span>-&gt;category_id = <span class="php-num">0</span>;
</span><span class="l" id="133">133         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="134">134     }
</span><span class="l" id="135">135 
</span><span class="l" id="136">136     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setTemplateId(<span class="php-var">$template_id</span>)
</span><span class="l" id="137">137     {
</span><span class="l" id="138">138         <span class="php-var">$this</span>-&gt;template_id = <span class="php-var">$template_id</span>;
</span><span class="l" id="139">139     }
</span><span class="l" id="140">140 
</span><span class="l" id="141">141     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getTemplateId()
</span><span class="l" id="142">142     {
</span><span class="l" id="143">143         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;template_id;
</span><span class="l" id="144">144     }
</span><span class="l" id="145">145 
</span><span class="l" id="146">146     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setMode(<span class="php-var">$mode</span>)
</span><span class="l" id="147">147     {
</span><span class="l" id="148">148         <span class="php-var">$this</span>-&gt;mode = <span class="php-var">$mode</span>;
</span><span class="l" id="149">149     }
</span><span class="l" id="150">150 
</span><span class="l" id="151">151     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setFunction(<span class="php-var">$function</span>)
</span><span class="l" id="152">152     {
</span><span class="l" id="153">153         <span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span> = <span class="php-var">$function</span>;
</span><span class="l" id="154">154     }
</span><span class="l" id="155">155 
</span><span class="l" id="156">156     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setEval(<span class="php-var">$value</span>)
</span><span class="l" id="157">157     {
</span><span class="l" id="158">158         <span class="php-keyword1">if</span> (<span class="php-var">$value</span>) {
</span><span class="l" id="159">159             <span class="php-var">$this</span>-&gt;<span class="php-keyword2">eval</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="160">160         } <span class="php-keyword1">else</span> {
</span><span class="l" id="161">161             <span class="php-var">$this</span>-&gt;<span class="php-keyword2">eval</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="162">162         }
</span><span class="l" id="163">163     }
</span><span class="l" id="164">164 
</span><span class="l" id="165">165     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> correctValue(<span class="php-var">$value</span>)
</span><span class="l" id="166">166     {
</span><span class="l" id="167">167         <span class="php-keyword1">if</span> (<span class="php-var">$value</span> == <span class="php-quote">'category_id'</span>) {
</span><span class="l" id="168">168             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getValue(<span class="php-quote">'startarticle'</span>) != <span class="php-num">1</span>) {
</span><span class="l" id="169">169                 <span class="php-var">$value</span> = <span class="php-quote">'parent_id'</span>;
</span><span class="l" id="170">170             } <span class="php-keyword1">else</span> {
</span><span class="l" id="171">171                 <span class="php-var">$value</span> = <span class="php-quote">'id'</span>;
</span><span class="l" id="172">172             }
</span><span class="l" id="173">173         } <span class="php-keyword1">elseif</span> (<span class="php-var">$value</span> == <span class="php-quote">'article_id'</span>) {
</span><span class="l" id="174">174             <span class="php-var">$value</span> = <span class="php-quote">'id'</span>;
</span><span class="l" id="175">175         }
</span><span class="l" id="176">176 
</span><span class="l" id="177">177         <span class="php-keyword1">return</span> <span class="php-var">$value</span>;
</span><span class="l" id="178">178     }
</span><span class="l" id="179">179 
</span><span class="l" id="180">180     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> _getValue(<span class="php-var">$value</span>)
</span><span class="l" id="181">181     {
</span><span class="l" id="182">182         <span class="php-var">$value</span> = <span class="php-var">$this</span>-&gt;correctValue(<span class="php-var">$value</span>);
</span><span class="l" id="183">183 
</span><span class="l" id="184">184         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getSqlInstance()-&gt;getValue(<span class="php-var">$value</span>);
</span><span class="l" id="185">185     }
</span><span class="l" id="186">186 
</span><span class="l" id="187">187     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getValue(<span class="php-var">$value</span>)
</span><span class="l" id="188">188     {
</span><span class="l" id="189">189         <span class="php-comment">// damit alte rex_article felder wie teaser, online_from etc</span>
</span><span class="l" id="190">190         <span class="php-comment">// noch funktionieren</span>
</span><span class="l" id="191">191         <span class="php-comment">// gleicher BC code nochmals in rex_structure_element::getValue</span>
</span><span class="l" id="192">192         <span class="php-keyword1">foreach</span> ([<span class="php-quote">''</span>, <span class="php-quote">'art_'</span>, <span class="php-quote">'cat_'</span>] <span class="php-keyword1">as</span> <span class="php-var">$prefix</span>) {
</span><span class="l" id="193">193             <span class="php-var">$val</span> = <span class="php-var">$prefix</span> . <span class="php-var">$value</span>;
</span><span class="l" id="194">194             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasValue(<span class="php-var">$val</span>)) {
</span><span class="l" id="195">195                 <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;_getValue(<span class="php-var">$val</span>);
</span><span class="l" id="196">196             }
</span><span class="l" id="197">197         }
</span><span class="l" id="198">198         <span class="php-keyword1">return</span> <span class="php-quote">'['</span> . <span class="php-var">$value</span> . <span class="php-quote">' not found]'</span>;
</span><span class="l" id="199">199     }
</span><span class="l" id="200">200 
</span><span class="l" id="201">201     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasValue(<span class="php-var">$value</span>)
</span><span class="l" id="202">202     {
</span><span class="l" id="203">203         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getSqlInstance()-&gt;hasValue(<span class="php-var">$this</span>-&gt;correctValue(<span class="php-var">$value</span>));
</span><span class="l" id="204">204     }
</span><span class="l" id="205">205 
</span><span class="l" id="206">206     <span class="php-comment">/**
</span></span><span class="l" id="207">207 <span class="php-comment">     * Outputs a slice.
</span></span><span class="l" id="208">208 <span class="php-comment">     *
</span></span><span class="l" id="209">209 <span class="php-comment">     * @param rex_sql $artDataSql    A rex_sql instance containing all slice and module data
</span></span><span class="l" id="210">210 <span class="php-comment">     * @param int     $moduleIdToAdd The id of the module, which was selected using the ModuleSelect
</span></span><span class="l" id="211">211 <span class="php-comment">     *
</span></span><span class="l" id="212">212 <span class="php-comment">     * @return string
</span></span><span class="l" id="213">213 <span class="php-comment">     */</span>
</span><span class="l" id="214">214     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> outputSlice(rex_sql <span class="php-var">$artDataSql</span>, <span class="php-var">$moduleIdToAdd</span>)
</span><span class="l" id="215">215     {
</span><span class="l" id="216">216         <span class="php-var">$output</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(
</span><span class="l" id="217">217             <span class="php-quote">'SLICE_OUTPUT'</span>,
</span><span class="l" id="218">218             <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.output'</span>),
</span><span class="l" id="219">219             [
</span><span class="l" id="220">220                 <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id,
</span><span class="l" id="221">221                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="222">222                 <span class="php-quote">'slice_data'</span> =&gt; <span class="php-var">$artDataSql</span>,
</span><span class="l" id="223">223             ]
</span><span class="l" id="224">224         ));
</span><span class="l" id="225">225         <span class="php-var">$output</span> = <span class="php-var">$this</span>-&gt;replaceVars(<span class="php-var">$artDataSql</span>, <span class="php-var">$output</span>);
</span><span class="l" id="226">226 
</span><span class="l" id="227">227         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getStreamOutput(<span class="php-quote">'module/'</span> . <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.id'</span>) . <span class="php-quote">'/output'</span>, <span class="php-var">$output</span>);
</span><span class="l" id="228">228     }
</span><span class="l" id="229">229 
</span><span class="l" id="230">230     <span class="php-comment">/**
</span></span><span class="l" id="231">231 <span class="php-comment">     * Returns the content of the given slice-id.
</span></span><span class="l" id="232">232 <span class="php-comment">     *
</span></span><span class="l" id="233">233 <span class="php-comment">     * @param int $sliceId A article-slice id
</span></span><span class="l" id="234">234 <span class="php-comment">     *
</span></span><span class="l" id="235">235 <span class="php-comment">     * @return string
</span></span><span class="l" id="236">236 <span class="php-comment">     */</span>
</span><span class="l" id="237">237     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getSlice(<span class="php-var">$sliceId</span>)
</span><span class="l" id="238">238     {
</span><span class="l" id="239">239         <span class="php-var">$oldEval</span> = <span class="php-var">$this</span>-&gt;<span class="php-keyword2">eval</span>;
</span><span class="l" id="240">240         <span class="php-var">$this</span>-&gt;setEval(<span class="php-keyword1">true</span>);
</span><span class="l" id="241">241 
</span><span class="l" id="242">242         <span class="php-var">$this</span>-&gt;getSlice = <span class="php-var">$sliceId</span>;
</span><span class="l" id="243">243         <span class="php-var">$sliceContent</span> = <span class="php-var">$this</span>-&gt;getArticle();
</span><span class="l" id="244">244         <span class="php-var">$this</span>-&gt;getSlice = <span class="php-num">0</span>;
</span><span class="l" id="245">245 
</span><span class="l" id="246">246         <span class="php-var">$this</span>-&gt;setEval(<span class="php-var">$oldEval</span>);
</span><span class="l" id="247">247         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;replaceLinks(<span class="php-var">$sliceContent</span>);
</span><span class="l" id="248">248     }
</span><span class="l" id="249">249 
</span><span class="l" id="250">250     <span class="php-comment">/**
</span></span><span class="l" id="251">251 <span class="php-comment">     * Returns the content of the article of the given ctype. If no ctype is given, content of all ctypes is returned.
</span></span><span class="l" id="252">252 <span class="php-comment">     *
</span></span><span class="l" id="253">253 <span class="php-comment">     * @param int $curctype The ctype to fetch, or -1 for all ctypes
</span></span><span class="l" id="254">254 <span class="php-comment">     *
</span></span><span class="l" id="255">255 <span class="php-comment">     * @return string
</span></span><span class="l" id="256">256 <span class="php-comment">     */</span>
</span><span class="l" id="257">257     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getArticle(<span class="php-var">$curctype</span> = -<span class="php-num">1</span>)
</span><span class="l" id="258">258     {
</span><span class="l" id="259">259         <span class="php-var">$this</span>-&gt;ctype = <span class="php-var">$curctype</span>;
</span><span class="l" id="260">260 
</span><span class="l" id="261">261         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;article_id == <span class="php-num">0</span> &amp;&amp; <span class="php-var">$this</span>-&gt;getSlice == <span class="php-num">0</span>) {
</span><span class="l" id="262">262             <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'no_article_available'</span>);
</span><span class="l" id="263">263         }
</span><span class="l" id="264">264 
</span><span class="l" id="265">265         <span class="php-var">$articleLimit</span> = <span class="php-quote">''</span>;
</span><span class="l" id="266">266         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;article_id != <span class="php-num">0</span>) {
</span><span class="l" id="267">267             <span class="php-var">$articleLimit</span> = <span class="php-quote">' AND '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice.article_id='</span> . (int) <span class="php-var">$this</span>-&gt;article_id;
</span><span class="l" id="268">268         }
</span><span class="l" id="269">269 
</span><span class="l" id="270">270         <span class="php-var">$sliceLimit</span> = <span class="php-quote">''</span>;
</span><span class="l" id="271">271         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getSlice != <span class="php-num">0</span>) {
</span><span class="l" id="272">272             <span class="php-var">$sliceLimit</span> = <span class="php-quote">' AND '</span> . rex::getTablePrefix() . <span class="php-quote">"article_slice.id = '"</span> . ((int) <span class="php-var">$this</span>-&gt;getSlice) . <span class="php-quote">"' "</span>;
</span><span class="l" id="273">273         }
</span><span class="l" id="274">274 
</span><span class="l" id="275">275         <span class="php-comment">// ----- start: article caching</span>
</span><span class="l" id="276">276         <span class="php-keyword2">ob_start</span>();
</span><span class="l" id="277">277         <span class="php-keyword2">ob_implicit_flush</span>(<span class="php-num">0</span>);
</span><span class="l" id="278">278         <span class="php-var">$module_id</span> = rex_request(<span class="php-quote">'module_id'</span>, <span class="php-quote">'int'</span>);
</span><span class="l" id="279">279 
</span><span class="l" id="280">280         <span class="php-comment">// ---------- alle teile/slices eines artikels auswaehlen</span>
</span><span class="l" id="281">281         <span class="php-var">$query</span> = <span class="php-quote">'SELECT '</span> . rex::getTablePrefix() . <span class="php-quote">'module.id, '</span> . rex::getTablePrefix() . <span class="php-quote">'module.name, '</span> . rex::getTablePrefix() . <span class="php-quote">'module.output, '</span> . rex::getTablePrefix() . <span class="php-quote">'module.input, '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice.*, '</span> . rex::getTablePrefix() . <span class="php-quote">'article.parent_id
</span></span><span class="l" id="282">282 <span class="php-quote">                        FROM
</span></span><span class="l" id="283">283 <span class="php-quote">                            '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice
</span></span><span class="l" id="284">284 <span class="php-quote">                        LEFT JOIN '</span> . rex::getTablePrefix() . <span class="php-quote">'module ON '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice.module_id='</span> . rex::getTablePrefix() . <span class="php-quote">'module.id
</span></span><span class="l" id="285">285 <span class="php-quote">                        LEFT JOIN '</span> . rex::getTablePrefix() . <span class="php-quote">'article ON '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice.article_id='</span> . rex::getTablePrefix() . <span class="php-quote">'article.id
</span></span><span class="l" id="286">286 <span class="php-quote">                        WHERE
</span></span><span class="l" id="287">287 <span class="php-quote">                            '</span> . rex::getTablePrefix() . <span class="php-quote">"article_slice.clang_id='"</span> . <span class="php-var">$this</span>-&gt;clang . <span class="php-quote">"' AND
</span></span><span class="l" id="288">288 <span class="php-quote">                            "</span> . rex::getTablePrefix() . <span class="php-quote">"article.clang_id='"</span> . <span class="php-var">$this</span>-&gt;clang . <span class="php-quote">"' AND
</span></span><span class="l" id="289">289 <span class="php-quote">                            "</span> . rex::getTablePrefix() . <span class="php-quote">"article_slice.revision='"</span> . <span class="php-var">$this</span>-&gt;slice_revision . <span class="php-quote">"'
</span></span><span class="l" id="290">290 <span class="php-quote">                            "</span> . <span class="php-var">$articleLimit</span> . <span class="php-quote">'
</span></span><span class="l" id="291">291 <span class="php-quote">                            '</span> . <span class="php-var">$sliceLimit</span> . <span class="php-quote">'
</span></span><span class="l" id="292">292 <span class="php-quote">                            ORDER BY '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice.priority'</span>;
</span><span class="l" id="293">293 
</span><span class="l" id="294">294         <span class="php-var">$query</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(
</span><span class="l" id="295">295             <span class="php-quote">'ART_SLICES_QUERY'</span>,
</span><span class="l" id="296">296             <span class="php-var">$query</span>,
</span><span class="l" id="297">297             [<span class="php-quote">'article'</span> =&gt; <span class="php-var">$this</span>]
</span><span class="l" id="298">298         ));
</span><span class="l" id="299">299 
</span><span class="l" id="300">300         <span class="php-var">$artDataSql</span> = rex_sql::factory();
</span><span class="l" id="301">301         <span class="php-var">$artDataSql</span>-&gt;setDebug(<span class="php-var">$this</span>-&gt;debug);
</span><span class="l" id="302">302         <span class="php-var">$artDataSql</span>-&gt;setQuery(<span class="php-var">$query</span>);
</span><span class="l" id="303">303 
</span><span class="l" id="304">304         <span class="php-comment">// pre hook</span>
</span><span class="l" id="305">305         <span class="php-var">$articleContent</span> = <span class="php-quote">''</span>;
</span><span class="l" id="306">306         <span class="php-var">$articleContent</span> = <span class="php-var">$this</span>-&gt;preArticle(<span class="php-var">$articleContent</span>, <span class="php-var">$module_id</span>);
</span><span class="l" id="307">307 
</span><span class="l" id="308">308         <span class="php-comment">// ---------- SLICES AUSGEBEN</span>
</span><span class="l" id="309">309 
</span><span class="l" id="310">310         <span class="php-var">$prevCtype</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="311">311         <span class="php-var">$artDataSql</span>-&gt;<span class="php-keyword2">reset</span>();
</span><span class="l" id="312">312         <span class="php-var">$rows</span> = <span class="php-var">$artDataSql</span>-&gt;getRows();
</span><span class="l" id="313">313         <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$rows</span>; ++<span class="php-var">$i</span>) {
</span><span class="l" id="314">314             <span class="php-var">$sliceId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.id'</span>);
</span><span class="l" id="315">315             <span class="php-var">$sliceCtypeId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.ctype_id'</span>);
</span><span class="l" id="316">316             <span class="php-var">$sliceModuleId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.id'</span>);
</span><span class="l" id="317">317 
</span><span class="l" id="318">318             <span class="php-comment">// ----- ctype unterscheidung</span>
</span><span class="l" id="319">319             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;mode != <span class="php-quote">'edit'</span> &amp;&amp; !<span class="php-var">$this</span>-&gt;<span class="php-keyword2">eval</span>) {
</span><span class="l" id="320">320                 <span class="php-keyword1">if</span> (<span class="php-num">0</span> == <span class="php-var">$i</span>) {
</span><span class="l" id="321">321                     <span class="php-var">$articleContent</span> = <span class="php-quote">"&lt;?php if (\</span><span class="php-var">$this</span><span class="php-quote">-&gt;ctype == '"</span> . <span class="php-var">$sliceCtypeId</span> . <span class="php-quote">"' || (\</span><span class="php-var">$this</span><span class="php-quote">-&gt;ctype == '-1')) { \n"</span>;
</span><span class="l" id="322">322                 } <span class="php-keyword1">elseif</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$prevCtype</span>) &amp;&amp; <span class="php-var">$sliceCtypeId</span> != <span class="php-var">$prevCtype</span>) {
</span><span class="l" id="323">323                     <span class="php-comment">// ----- zwischenstand: ctype .. wenn ctype neu dann if</span>
</span><span class="l" id="324">324                     <span class="php-var">$articleContent</span> .= <span class="php-quote">"\n } if(\</span><span class="php-var">$this</span><span class="php-quote">-&gt;ctype == '"</span> . <span class="php-var">$sliceCtypeId</span> . <span class="php-quote">"' || \</span><span class="php-var">$this</span><span class="php-quote">-&gt;ctype == '-1'){ \n"</span>;
</span><span class="l" id="325">325                 }
</span><span class="l" id="326">326             }
</span><span class="l" id="327">327 
</span><span class="l" id="328">328             <span class="php-comment">// ------------- EINZELNER SLICE - AUSGABE</span>
</span><span class="l" id="329">329             <span class="php-var">$slice_content</span> = <span class="php-var">$this</span>-&gt;outputSlice(
</span><span class="l" id="330">330                 <span class="php-var">$artDataSql</span>,
</span><span class="l" id="331">331                 <span class="php-var">$module_id</span>
</span><span class="l" id="332">332             );
</span><span class="l" id="333">333             <span class="php-comment">// --------------- ENDE EINZELNER SLICE</span>
</span><span class="l" id="334">334 
</span><span class="l" id="335">335             <span class="php-comment">// --------------- EP: SLICE_SHOW</span>
</span><span class="l" id="336">336             <span class="php-var">$slice_content</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(
</span><span class="l" id="337">337                 <span class="php-quote">'SLICE_SHOW'</span>,
</span><span class="l" id="338">338                 <span class="php-var">$slice_content</span>,
</span><span class="l" id="339">339                 [
</span><span class="l" id="340">340                     <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id,
</span><span class="l" id="341">341                     <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="342">342                     <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$sliceCtypeId</span>,
</span><span class="l" id="343">343                     <span class="php-quote">'module_id'</span> =&gt; <span class="php-var">$sliceModuleId</span>,
</span><span class="l" id="344">344                     <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$sliceId</span>,
</span><span class="l" id="345">345                     <span class="php-quote">'function'</span> =&gt; <span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span>,
</span><span class="l" id="346">346                     <span class="php-quote">'function_slice_id'</span> =&gt; <span class="php-var">$this</span>-&gt;slice_id,
</span><span class="l" id="347">347                     <span class="php-quote">'sql'</span> =&gt; <span class="php-var">$artDataSql</span>,
</span><span class="l" id="348">348                 ]
</span><span class="l" id="349">349             ));
</span><span class="l" id="350">350 
</span><span class="l" id="351">351             <span class="php-comment">// ---------- slice in ausgabe speichern wenn ctype richtig</span>
</span><span class="l" id="352">352             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;ctype == -<span class="php-num">1</span> || <span class="php-var">$this</span>-&gt;ctype == <span class="php-var">$sliceCtypeId</span>) {
</span><span class="l" id="353">353                 <span class="php-var">$articleContent</span> .= <span class="php-var">$slice_content</span>;
</span><span class="l" id="354">354             }
</span><span class="l" id="355">355 
</span><span class="l" id="356">356             <span class="php-var">$prevCtype</span> = <span class="php-var">$sliceCtypeId</span>;
</span><span class="l" id="357">357 
</span><span class="l" id="358">358             <span class="php-var">$artDataSql</span>-&gt;flushValues();
</span><span class="l" id="359">359             <span class="php-var">$artDataSql</span>-&gt;<span class="php-keyword2">next</span>();
</span><span class="l" id="360">360         }
</span><span class="l" id="361">361 
</span><span class="l" id="362">362         <span class="php-comment">// ----- end: ctype unterscheidung</span>
</span><span class="l" id="363">363         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;mode != <span class="php-quote">'edit'</span> &amp;&amp; !<span class="php-var">$this</span>-&gt;<span class="php-keyword2">eval</span> &amp;&amp; <span class="php-var">$i</span> &gt; <span class="php-num">0</span>) {
</span><span class="l" id="364">364             <span class="php-var">$articleContent</span> .= <span class="php-quote">"\n } ?&gt;"</span>;
</span><span class="l" id="365">365         }
</span><span class="l" id="366">366 
</span><span class="l" id="367">367         <span class="php-comment">// ----- post hook</span>
</span><span class="l" id="368">368         <span class="php-var">$articleContent</span> = <span class="php-var">$this</span>-&gt;postArticle(<span class="php-var">$articleContent</span>, <span class="php-var">$module_id</span>);
</span><span class="l" id="369">369 
</span><span class="l" id="370">370         <span class="php-comment">// -------------------------- schreibe content</span>
</span><span class="l" id="371">371         <span class="php-keyword1">echo</span> <span class="php-var">$articleContent</span>;
</span><span class="l" id="372">372 
</span><span class="l" id="373">373         <span class="php-comment">// ----- end: article caching</span>
</span><span class="l" id="374">374         <span class="php-var">$CONTENT</span> = <span class="php-keyword2">ob_get_clean</span>();
</span><span class="l" id="375">375 
</span><span class="l" id="376">376         <span class="php-keyword1">return</span> <span class="php-var">$CONTENT</span>;
</span><span class="l" id="377">377     }
</span><span class="l" id="378">378 
</span><span class="l" id="379">379     <span class="php-comment">/**
</span></span><span class="l" id="380">380 <span class="php-comment">     * Method which gets called, before the slices of the article are processed.
</span></span><span class="l" id="381">381 <span class="php-comment">     *
</span></span><span class="l" id="382">382 <span class="php-comment">     * @param string $articleContent The content of the article
</span></span><span class="l" id="383">383 <span class="php-comment">     * @param int    $module_id      A module id
</span></span><span class="l" id="384">384 <span class="php-comment">     *
</span></span><span class="l" id="385">385 <span class="php-comment">     * @return string
</span></span><span class="l" id="386">386 <span class="php-comment">     */</span>
</span><span class="l" id="387">387     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> preArticle(<span class="php-var">$articleContent</span>, <span class="php-var">$module_id</span>)
</span><span class="l" id="388">388     {
</span><span class="l" id="389">389         <span class="php-comment">// nichts tun</span>
</span><span class="l" id="390">390         <span class="php-keyword1">return</span> <span class="php-var">$articleContent</span>;
</span><span class="l" id="391">391     }
</span><span class="l" id="392">392 
</span><span class="l" id="393">393     <span class="php-comment">/**
</span></span><span class="l" id="394">394 <span class="php-comment">     * Method which gets called, after all slices have been processed.
</span></span><span class="l" id="395">395 <span class="php-comment">     *
</span></span><span class="l" id="396">396 <span class="php-comment">     * @param string $articleContent The content of the article
</span></span><span class="l" id="397">397 <span class="php-comment">     * @param int    $module_id      A module id
</span></span><span class="l" id="398">398 <span class="php-comment">     *
</span></span><span class="l" id="399">399 <span class="php-comment">     * @return string
</span></span><span class="l" id="400">400 <span class="php-comment">     */</span>
</span><span class="l" id="401">401     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> postArticle(<span class="php-var">$articleContent</span>, <span class="php-var">$module_id</span>)
</span><span class="l" id="402">402     {
</span><span class="l" id="403">403         <span class="php-comment">// nichts tun</span>
</span><span class="l" id="404">404         <span class="php-keyword1">return</span> <span class="php-var">$articleContent</span>;
</span><span class="l" id="405">405     }
</span><span class="l" id="406">406 
</span><span class="l" id="407">407     <span class="php-comment">// ----- Template inklusive Artikel zurückgeben</span>
</span><span class="l" id="408">408     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getArticleTemplate()
</span><span class="l" id="409">409     {
</span><span class="l" id="410">410         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;template_id != <span class="php-num">0</span> &amp;&amp; <span class="php-var">$this</span>-&gt;article_id != <span class="php-num">0</span>) {
</span><span class="l" id="411">411             <span class="php-keyword2">ob_start</span>();
</span><span class="l" id="412">412             <span class="php-keyword2">ob_implicit_flush</span>(<span class="php-num">0</span>);
</span><span class="l" id="413">413 
</span><span class="l" id="414">414             <span class="php-var">$TEMPLATE</span> = <span class="php-keyword1">new</span> rex_template(<span class="php-var">$this</span>-&gt;template_id);
</span><span class="l" id="415">415             <span class="php-var">$tplContent</span> = <span class="php-var">$this</span>-&gt;replaceCommonVars(<span class="php-var">$TEMPLATE</span>-&gt;getTemplate());
</span><span class="l" id="416">416             <span class="php-keyword1">require</span> rex_stream::factory(<span class="php-quote">'template/'</span> . <span class="php-var">$this</span>-&gt;template_id, <span class="php-var">$tplContent</span>);
</span><span class="l" id="417">417 
</span><span class="l" id="418">418             <span class="php-var">$CONTENT</span> = <span class="php-keyword2">ob_get_clean</span>();
</span><span class="l" id="419">419 
</span><span class="l" id="420">420             <span class="php-var">$CONTENT</span> = <span class="php-var">$this</span>-&gt;replaceLinks(<span class="php-var">$CONTENT</span>);
</span><span class="l" id="421">421         } <span class="php-keyword1">else</span> {
</span><span class="l" id="422">422             <span class="php-var">$CONTENT</span> = <span class="php-quote">'no template'</span>;
</span><span class="l" id="423">423         }
</span><span class="l" id="424">424 
</span><span class="l" id="425">425         <span class="php-keyword1">return</span> <span class="php-var">$CONTENT</span>;
</span><span class="l" id="426">426     }
</span><span class="l" id="427">427 
</span><span class="l" id="428">428     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> getStreamOutput(<span class="php-var">$path</span>, <span class="php-var">$content</span>)
</span><span class="l" id="429">429     {
</span><span class="l" id="430">430         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;<span class="php-keyword2">eval</span>) {
</span><span class="l" id="431">431             <span class="php-var">$key</span> = <span class="php-quote">'EOD_'</span> . <span class="php-keyword2">strtoupper</span>(<span class="php-keyword2">sha1</span>(<span class="php-keyword2">time</span>()));
</span><span class="l" id="432">432             <span class="php-keyword1">return</span> <span class="php-quote">"require rex_stream::factory('</span><span class="php-var">$path</span><span class="php-quote">', \n&lt;&lt;&lt;'</span><span class="php-var">$key</span><span class="php-quote">'\n</span><span class="php-var">$content</span><span class="php-quote">\n</span><span class="php-var">$key</span><span class="php-quote">\n);\n"</span>;
</span><span class="l" id="433">433         }
</span><span class="l" id="434">434 
</span><span class="l" id="435">435         <span class="php-keyword2">ob_start</span>();
</span><span class="l" id="436">436         <span class="php-keyword2">ob_implicit_flush</span>(<span class="php-num">0</span>);
</span><span class="l" id="437">437         <span class="php-keyword1">require</span> rex_stream::factory(<span class="php-var">$path</span>, <span class="php-var">$content</span>);
</span><span class="l" id="438">438         <span class="php-var">$CONTENT</span> = <span class="php-keyword2">ob_get_clean</span>();
</span><span class="l" id="439">439 
</span><span class="l" id="440">440         <span class="php-keyword1">return</span> <span class="php-var">$CONTENT</span>;
</span><span class="l" id="441">441     }
</span><span class="l" id="442">442 
</span><span class="l" id="443">443     <span class="php-comment">// ----- Modulvariablen werden ersetzt</span>
</span><span class="l" id="444">444     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> replaceVars(rex_sql <span class="php-var">$sql</span>, <span class="php-var">$content</span>)
</span><span class="l" id="445">445     {
</span><span class="l" id="446">446         <span class="php-var">$content</span> = <span class="php-var">$this</span>-&gt;replaceCommonVars(<span class="php-var">$content</span>);
</span><span class="l" id="447">447         <span class="php-var">$content</span> = <span class="php-var">$this</span>-&gt;replaceObjectVars(<span class="php-var">$sql</span>, <span class="php-var">$content</span>);
</span><span class="l" id="448">448         <span class="php-var">$content</span> = <span class="php-keyword2">str_replace</span>(
</span><span class="l" id="449">449             [
</span><span class="l" id="450">450                 <span class="php-quote">'REX_MODULE_ID'</span>,
</span><span class="l" id="451">451                 <span class="php-quote">'REX_SLICE_ID'</span>,
</span><span class="l" id="452">452                 <span class="php-quote">'REX_CTYPE_ID'</span>,
</span><span class="l" id="453">453             ],
</span><span class="l" id="454">454             [
</span><span class="l" id="455">455                 (int) <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'module_id'</span>),
</span><span class="l" id="456">456                 (int) <span class="php-var">$sql</span>-&gt;getValue(rex::getTable(<span class="php-quote">'article_slice'</span>) . <span class="php-quote">'.id'</span>),
</span><span class="l" id="457">457                 (int) <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'ctype_id'</span>),
</span><span class="l" id="458">458             ],
</span><span class="l" id="459">459             <span class="php-var">$content</span>
</span><span class="l" id="460">460         );
</span><span class="l" id="461">461         <span class="php-keyword1">return</span> <span class="php-var">$content</span>;
</span><span class="l" id="462">462     }
</span><span class="l" id="463">463 
</span><span class="l" id="464">464     <span class="php-comment">// ----- REX_VAR Ersetzungen</span>
</span><span class="l" id="465">465     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> replaceObjectVars(rex_sql <span class="php-var">$sql</span>, <span class="php-var">$content</span>)
</span><span class="l" id="466">466     {
</span><span class="l" id="467">467         <span class="php-var">$sliceId</span> = <span class="php-var">$sql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.id'</span>);
</span><span class="l" id="468">468 
</span><span class="l" id="469">469         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;mode == <span class="php-quote">'edit'</span>) {
</span><span class="l" id="470">470             <span class="php-var">$env</span> = rex_var::ENV_BACKEND;
</span><span class="l" id="471">471             <span class="php-keyword1">if</span> ((<span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span> == <span class="php-quote">'add'</span> &amp;&amp; <span class="php-var">$sliceId</span> == <span class="php-keyword1">null</span>) || (<span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span> == <span class="php-quote">'edit'</span> &amp;&amp; <span class="php-var">$sliceId</span> == <span class="php-var">$this</span>-&gt;slice_id)) {
</span><span class="l" id="472">472                 <span class="php-var">$env</span> = <span class="php-var">$env</span> | rex_var::ENV_INPUT;
</span><span class="l" id="473">473             }
</span><span class="l" id="474">474         } <span class="php-keyword1">else</span> {
</span><span class="l" id="475">475             <span class="php-var">$env</span> = rex_var::ENV_FRONTEND;
</span><span class="l" id="476">476         }
</span><span class="l" id="477">477         <span class="php-var">$content</span> = rex_var::parse(<span class="php-var">$content</span>, <span class="php-var">$env</span>, <span class="php-quote">'module'</span>, <span class="php-var">$sql</span>);
</span><span class="l" id="478">478 
</span><span class="l" id="479">479         <span class="php-keyword1">return</span> <span class="php-var">$content</span>;
</span><span class="l" id="480">480     }
</span><span class="l" id="481">481 
</span><span class="l" id="482">482     <span class="php-comment">// ---- Artikelweite globale variablen werden ersetzt</span>
</span><span class="l" id="483">483     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> replaceCommonVars(<span class="php-var">$content</span>, <span class="php-var">$template_id</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="484">484     {
</span><span class="l" id="485">485         <span class="php-keyword1">static</span> <span class="php-var">$user_id</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="486">486         <span class="php-keyword1">static</span> <span class="php-var">$user_login</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="487">487 
</span><span class="l" id="488">488         <span class="php-comment">// UserId gibts nur im Backend</span>
</span><span class="l" id="489">489         <span class="php-keyword1">if</span> (<span class="php-var">$user_id</span> === <span class="php-keyword1">null</span>) {
</span><span class="l" id="490">490             <span class="php-keyword1">if</span> (rex::getUser()) {
</span><span class="l" id="491">491                 <span class="php-var">$user_id</span> = rex::getUser()-&gt;getId();
</span><span class="l" id="492">492                 <span class="php-var">$user_login</span> = rex::getUser()-&gt;getLogin();
</span><span class="l" id="493">493             } <span class="php-keyword1">else</span> {
</span><span class="l" id="494">494                 <span class="php-var">$user_id</span> = <span class="php-quote">''</span>;
</span><span class="l" id="495">495                 <span class="php-var">$user_login</span> = <span class="php-quote">''</span>;
</span><span class="l" id="496">496             }
</span><span class="l" id="497">497         }
</span><span class="l" id="498">498 
</span><span class="l" id="499">499         <span class="php-keyword1">if</span> (!<span class="php-var">$template_id</span>) {
</span><span class="l" id="500">500             <span class="php-var">$template_id</span> = <span class="php-var">$this</span>-&gt;getTemplateId();
</span><span class="l" id="501">501         }
</span><span class="l" id="502">502 
</span><span class="l" id="503">503         <span class="php-keyword1">static</span> <span class="php-var">$search</span> = [
</span><span class="l" id="504">504             <span class="php-quote">'REX_ARTICLE_ID'</span>,
</span><span class="l" id="505">505             <span class="php-quote">'REX_CATEGORY_ID'</span>,
</span><span class="l" id="506">506             <span class="php-quote">'REX_CLANG_ID'</span>,
</span><span class="l" id="507">507             <span class="php-quote">'REX_TEMPLATE_ID'</span>,
</span><span class="l" id="508">508             <span class="php-quote">'REX_USER_ID'</span>,
</span><span class="l" id="509">509             <span class="php-quote">'REX_USER_LOGIN'</span>,
</span><span class="l" id="510">510         ];
</span><span class="l" id="511">511 
</span><span class="l" id="512">512         <span class="php-var">$replace</span> = [
</span><span class="l" id="513">513             <span class="php-var">$this</span>-&gt;article_id,
</span><span class="l" id="514">514             <span class="php-var">$this</span>-&gt;category_id,
</span><span class="l" id="515">515             <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="516">516             <span class="php-var">$template_id</span>,
</span><span class="l" id="517">517             <span class="php-var">$user_id</span>,
</span><span class="l" id="518">518             <span class="php-var">$user_login</span>,
</span><span class="l" id="519">519         ];
</span><span class="l" id="520">520 
</span><span class="l" id="521">521         <span class="php-keyword1">return</span> <span class="php-keyword2">str_replace</span>(<span class="php-var">$search</span>, <span class="php-var">$replace</span>, <span class="php-var">$content</span>);
</span><span class="l" id="522">522     }
</span><span class="l" id="523">523 
</span><span class="l" id="524">524     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> replaceLinks(<span class="php-var">$content</span>)
</span><span class="l" id="525">525     {
</span><span class="l" id="526">526         <span class="php-keyword1">return</span> <span class="php-keyword2">preg_replace_callback</span>(
</span><span class="l" id="527">527             <span class="php-quote">'@redaxo://(\d+)(?:-(\d+))?/?@i'</span>,
</span><span class="l" id="528">528             <span class="php-keyword1">function</span> (<span class="php-var">$matches</span>) {
</span><span class="l" id="529">529                 <span class="php-keyword1">return</span> rex_getUrl(<span class="php-var">$matches</span>[<span class="php-num">1</span>], <span class="php-keyword1">isset</span>(<span class="php-var">$matches</span>[<span class="php-num">2</span>]) ? <span class="php-var">$matches</span>[<span class="php-num">2</span>] : (int) <span class="php-var">$this</span>-&gt;clang);
</span><span class="l" id="530">530             },
</span><span class="l" id="531">531             <span class="php-var">$content</span>
</span><span class="l" id="532">532         );
</span><span class="l" id="533">533     }
</span><span class="l" id="534">534 }
</span><span class="l" id="535">535 </span></code></pre>
 </body>
</html>
