<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Class for var casting.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @author gharlan
</span></span><span class="l" id="7">  7 <span class="php-comment"> *
</span></span><span class="l" id="8">  8 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="9">  9 <span class="php-comment"> */</span>
</span><span class="l" id="10"> 10 <span class="php-keyword1">class</span> rex_type
</span><span class="l" id="11"> 11 {
</span><span class="l" id="12"> 12     <span class="php-comment">/**
</span></span><span class="l" id="13"> 13 <span class="php-comment">     * Casts the variable $var to $vartype.
</span></span><span class="l" id="14"> 14 <span class="php-comment">     *
</span></span><span class="l" id="15"> 15 <span class="php-comment">     * Possible types:
</span></span><span class="l" id="16"> 16 <span class="php-comment">     *  - 'bool' (or 'boolean')
</span></span><span class="l" id="17"> 17 <span class="php-comment">     *  - 'int' (or 'integer')
</span></span><span class="l" id="18"> 18 <span class="php-comment">     *  - 'double'
</span></span><span class="l" id="19"> 19 <span class="php-comment">     *  - 'string'
</span></span><span class="l" id="20"> 20 <span class="php-comment">     *  - 'float'
</span></span><span class="l" id="21"> 21 <span class="php-comment">     *  - 'real'
</span></span><span class="l" id="22"> 22 <span class="php-comment">     *  - 'object'
</span></span><span class="l" id="23"> 23 <span class="php-comment">     *  - 'array'
</span></span><span class="l" id="24"> 24 <span class="php-comment">     *  - 'array[&lt;type&gt;]', e.g. 'array[int]'
</span></span><span class="l" id="25"> 25 <span class="php-comment">     *  - '' (don't cast)
</span></span><span class="l" id="26"> 26 <span class="php-comment">     *  - a callable
</span></span><span class="l" id="27"> 27 <span class="php-comment">     *  - array(
</span></span><span class="l" id="28"> 28 <span class="php-comment">     *      array(&lt;key&gt;, &lt;vartype&gt;, &lt;default&gt;),
</span></span><span class="l" id="29"> 29 <span class="php-comment">     *      array(&lt;key&gt;, &lt;vartype&gt;, &lt;default&gt;),
</span></span><span class="l" id="30"> 30 <span class="php-comment">     *      ...
</span></span><span class="l" id="31"> 31 <span class="php-comment">     *    )
</span></span><span class="l" id="32"> 32 <span class="php-comment">     *
</span></span><span class="l" id="33"> 33 <span class="php-comment">     * @param mixed $var     Variable to cast
</span></span><span class="l" id="34"> 34 <span class="php-comment">     * @param mixed $vartype Variable type
</span></span><span class="l" id="35"> 35 <span class="php-comment">     *
</span></span><span class="l" id="36"> 36 <span class="php-comment">     * @throws InvalidArgumentException
</span></span><span class="l" id="37"> 37 <span class="php-comment">     *
</span></span><span class="l" id="38"> 38 <span class="php-comment">     * @return mixed Castet value
</span></span><span class="l" id="39"> 39 <span class="php-comment">     */</span>
</span><span class="l" id="40"> 40     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> cast(<span class="php-var">$var</span>, <span class="php-var">$vartype</span>)
</span><span class="l" id="41"> 41     {
</span><span class="l" id="42"> 42         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_string</span>(<span class="php-var">$vartype</span>)) {
</span><span class="l" id="43"> 43             <span class="php-var">$casted</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="44"> 44             <span class="php-keyword1">switch</span> (<span class="php-var">$vartype</span>) {
</span><span class="l" id="45"> 45                 <span class="php-comment">// ---------------- PHP types</span>
</span><span class="l" id="46"> 46                 <span class="php-keyword1">case</span> <span class="php-quote">'bool'</span>:
</span><span class="l" id="47"> 47                 <span class="php-keyword1">case</span> <span class="php-quote">'boolean'</span>:
</span><span class="l" id="48"> 48                     <span class="php-var">$var</span> = (bool) <span class="php-var">$var</span>;
</span><span class="l" id="49"> 49                     <span class="php-keyword1">break</span>;
</span><span class="l" id="50"> 50                 <span class="php-keyword1">case</span> <span class="php-quote">'int'</span>:
</span><span class="l" id="51"> 51                 <span class="php-keyword1">case</span> <span class="php-quote">'integer'</span>:
</span><span class="l" id="52"> 52                     <span class="php-var">$var</span> = (int) <span class="php-var">$var</span>;
</span><span class="l" id="53"> 53                     <span class="php-keyword1">break</span>;
</span><span class="l" id="54"> 54                 <span class="php-keyword1">case</span> <span class="php-quote">'double'</span>:
</span><span class="l" id="55"> 55                     <span class="php-var">$var</span> = (float) <span class="php-var">$var</span>;
</span><span class="l" id="56"> 56                     <span class="php-keyword1">break</span>;
</span><span class="l" id="57"> 57                 <span class="php-keyword1">case</span> <span class="php-quote">'float'</span>:
</span><span class="l" id="58"> 58                 <span class="php-keyword1">case</span> <span class="php-quote">'real'</span>:
</span><span class="l" id="59"> 59                     <span class="php-var">$var</span> = (float) <span class="php-var">$var</span>;
</span><span class="l" id="60"> 60                     <span class="php-keyword1">break</span>;
</span><span class="l" id="61"> 61                 <span class="php-keyword1">case</span> <span class="php-quote">'string'</span>:
</span><span class="l" id="62"> 62                     <span class="php-var">$var</span> = (string) <span class="php-var">$var</span>;
</span><span class="l" id="63"> 63                     <span class="php-keyword1">break</span>;
</span><span class="l" id="64"> 64                 <span class="php-keyword1">case</span> <span class="php-quote">'object'</span>:
</span><span class="l" id="65"> 65                     <span class="php-var">$var</span> = (object) <span class="php-var">$var</span>;
</span><span class="l" id="66"> 66                     <span class="php-keyword1">break</span>;
</span><span class="l" id="67"> 67                 <span class="php-keyword1">case</span> <span class="php-quote">'array'</span>:
</span><span class="l" id="68"> 68                     <span class="php-keyword1">if</span> (<span class="php-quote">''</span> === <span class="php-var">$var</span>) {
</span><span class="l" id="69"> 69                         <span class="php-var">$var</span> = [];
</span><span class="l" id="70"> 70                     } <span class="php-keyword1">else</span> {
</span><span class="l" id="71"> 71                         <span class="php-var">$var</span> = (<span class="php-keyword1">array</span>) <span class="php-var">$var</span>;
</span><span class="l" id="72"> 72                     }
</span><span class="l" id="73"> 73                     <span class="php-keyword1">break</span>;
</span><span class="l" id="74"> 74 
</span><span class="l" id="75"> 75                     <span class="php-comment">// kein Cast, nichts tun</span>
</span><span class="l" id="76"> 76                 <span class="php-keyword1">case</span> <span class="php-quote">''</span>: <span class="php-keyword1">break</span>;
</span><span class="l" id="77"> 77 
</span><span class="l" id="78"> 78                 <span class="php-keyword1">default</span>:
</span><span class="l" id="79"> 79                     <span class="php-comment">// check for array with generic type</span>
</span><span class="l" id="80"> 80                     <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$vartype</span>, <span class="php-quote">'array['</span>) === <span class="php-num">0</span>) {
</span><span class="l" id="81"> 81                         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$var</span>)) {
</span><span class="l" id="82"> 82                             <span class="php-var">$var</span> = [];
</span><span class="l" id="83"> 83                         } <span class="php-keyword1">else</span> {
</span><span class="l" id="84"> 84                             <span class="php-var">$var</span> = (<span class="php-keyword1">array</span>) <span class="php-var">$var</span>;
</span><span class="l" id="85"> 85                         }
</span><span class="l" id="86"> 86 
</span><span class="l" id="87"> 87                         <span class="php-comment">// check if every element in the array is from the generic type</span>
</span><span class="l" id="88"> 88                         <span class="php-var">$matches</span> = [];
</span><span class="l" id="89"> 89                         <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'@array\[([^\]]*)\]@'</span>, <span class="php-var">$vartype</span>, <span class="php-var">$matches</span>)) {
</span><span class="l" id="90"> 90                             <span class="php-keyword1">foreach</span> (<span class="php-var">$var</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="91"> 91                                 <span class="php-keyword1">try</span> {
</span><span class="l" id="92"> 92                                     <span class="php-var">$var</span>[<span class="php-var">$key</span>] = self::cast(<span class="php-var">$value</span>, <span class="php-var">$matches</span>[<span class="php-num">1</span>]);
</span><span class="l" id="93"> 93                                 } <span class="php-keyword1">catch</span> (InvalidArgumentException <span class="php-var">$e</span>) {
</span><span class="l" id="94"> 94                                     <span class="php-comment">// Evtl Typo im vartype, mit urspr. typ als fehler melden</span>
</span><span class="l" id="95"> 95                                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Unexpected vartype "'</span> . <span class="php-var">$vartype</span> . <span class="php-quote">'" in cast()!'</span>);
</span><span class="l" id="96"> 96                                 }
</span><span class="l" id="97"> 97                             }
</span><span class="l" id="98"> 98                         } <span class="php-keyword1">else</span> {
</span><span class="l" id="99"> 99                             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Unexpected vartype "'</span> . <span class="php-var">$vartype</span> . <span class="php-quote">'" in cast()!'</span>);
</span><span class="l" id="100">100                         }
</span><span class="l" id="101">101                     } <span class="php-keyword1">else</span> {
</span><span class="l" id="102">102                         <span class="php-var">$casted</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="103">103                     }
</span><span class="l" id="104">104             }
</span><span class="l" id="105">105             <span class="php-keyword1">if</span> (<span class="php-var">$casted</span>) {
</span><span class="l" id="106">106                 <span class="php-keyword1">return</span> <span class="php-var">$var</span>;
</span><span class="l" id="107">107             }
</span><span class="l" id="108">108         }
</span><span class="l" id="109">109 
</span><span class="l" id="110">110         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_callable</span>(<span class="php-var">$vartype</span>)) {
</span><span class="l" id="111">111             <span class="php-var">$var</span> = <span class="php-keyword2">call_user_func</span>(<span class="php-var">$vartype</span>, <span class="php-var">$var</span>);
</span><span class="l" id="112">112         } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$vartype</span>)) {
</span><span class="l" id="113">113             <span class="php-var">$var</span> = self::cast(<span class="php-var">$var</span>, <span class="php-quote">'array'</span>);
</span><span class="l" id="114">114             <span class="php-var">$newVar</span> = [];
</span><span class="l" id="115">115             <span class="php-keyword1">foreach</span> (<span class="php-var">$vartype</span> <span class="php-keyword1">as</span> <span class="php-var">$cast</span>) {
</span><span class="l" id="116">116                 <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$cast</span>) || !<span class="php-keyword1">isset</span>(<span class="php-var">$cast</span>[<span class="php-num">0</span>])) {
</span><span class="l" id="117">117                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Unexpected vartype in cast()!'</span>);
</span><span class="l" id="118">118                 }
</span><span class="l" id="119">119                 <span class="php-var">$key</span> = <span class="php-var">$cast</span>[<span class="php-num">0</span>];
</span><span class="l" id="120">120                 <span class="php-var">$innerVartype</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$cast</span>[<span class="php-num">1</span>]) ? <span class="php-var">$cast</span>[<span class="php-num">1</span>] : <span class="php-quote">''</span>;
</span><span class="l" id="121">121                 <span class="php-keyword1">if</span> (<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$key</span>, <span class="php-var">$var</span>)) {
</span><span class="l" id="122">122                     <span class="php-var">$newVar</span>[<span class="php-var">$key</span>] = self::cast(<span class="php-var">$var</span>[<span class="php-var">$key</span>], <span class="php-var">$innerVartype</span>);
</span><span class="l" id="123">123                 } <span class="php-keyword1">elseif</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$cast</span>[<span class="php-num">2</span>])) {
</span><span class="l" id="124">124                     <span class="php-var">$newVar</span>[<span class="php-var">$key</span>] = self::cast(<span class="php-quote">''</span>, <span class="php-var">$innerVartype</span>);
</span><span class="l" id="125">125                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="126">126                     <span class="php-var">$newVar</span>[<span class="php-var">$key</span>] = <span class="php-var">$cast</span>[<span class="php-num">2</span>];
</span><span class="l" id="127">127                 }
</span><span class="l" id="128">128             }
</span><span class="l" id="129">129             <span class="php-var">$var</span> = <span class="php-var">$newVar</span>;
</span><span class="l" id="130">130         } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_string</span>(<span class="php-var">$vartype</span>)) {
</span><span class="l" id="131">131             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Unexpected vartype "'</span> . <span class="php-var">$vartype</span> . <span class="php-quote">'" in cast()!'</span>);
</span><span class="l" id="132">132         } <span class="php-keyword1">else</span> {
</span><span class="l" id="133">133             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Unexpected vartype in cast()!'</span>);
</span><span class="l" id="134">134         }
</span><span class="l" id="135">135 
</span><span class="l" id="136">136         <span class="php-keyword1">return</span> <span class="php-var">$var</span>;
</span><span class="l" id="137">137     }
</span><span class="l" id="138">138 }
</span><span class="l" id="139">139 </span></code></pre>
 </body>
</html>
