<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Class to represent sql tables.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @author gharlan
</span></span><span class="l" id="7">  7 <span class="php-comment"> *
</span></span><span class="l" id="8">  8 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="9">  9 <span class="php-comment"> */</span>
</span><span class="l" id="10"> 10 <span class="php-keyword1">class</span> rex_sql_table
</span><span class="l" id="11"> 11 {
</span><span class="l" id="12"> 12     <span class="php-keyword1">use</span> rex_instance_pool_trait;
</span><span class="l" id="13"> 13 
</span><span class="l" id="14"> 14     <span class="php-keyword1">const</span> FIRST = <span class="php-quote">'FIRST '</span>; <span class="php-comment">// The space is intended: column names cannot end with space</span>
</span><span class="l" id="15"> 15 
</span><span class="l" id="16"> 16     <span class="php-comment">/** @var rex_sql */</span>
</span><span class="l" id="17"> 17     <span class="php-keyword1">private</span> <span class="php-var">$sql</span>;
</span><span class="l" id="18"> 18 
</span><span class="l" id="19"> 19     <span class="php-comment">/** @var bool */</span>
</span><span class="l" id="20"> 20     <span class="php-keyword1">private</span> <span class="php-var">$new</span>;
</span><span class="l" id="21"> 21 
</span><span class="l" id="22"> 22     <span class="php-comment">/** @var string */</span>
</span><span class="l" id="23"> 23     <span class="php-keyword1">private</span> <span class="php-var">$name</span>;
</span><span class="l" id="24"> 24 
</span><span class="l" id="25"> 25     <span class="php-comment">/** @var string */</span>
</span><span class="l" id="26"> 26     <span class="php-keyword1">private</span> <span class="php-var">$originalName</span>;
</span><span class="l" id="27"> 27 
</span><span class="l" id="28"> 28     <span class="php-comment">/** @var rex_sql_column[] */</span>
</span><span class="l" id="29"> 29     <span class="php-keyword1">private</span> <span class="php-var">$columns</span> = [];
</span><span class="l" id="30"> 30 
</span><span class="l" id="31"> 31     <span class="php-comment">/** @var string[] mapping from current (new) name to existing (old) name in database */</span>
</span><span class="l" id="32"> 32     <span class="php-keyword1">private</span> <span class="php-var">$columnsExisting</span> = [];
</span><span class="l" id="33"> 33 
</span><span class="l" id="34"> 34     <span class="php-comment">/** @var string[] */</span>
</span><span class="l" id="35"> 35     <span class="php-keyword1">private</span> <span class="php-var">$implicitOrder</span> = [];
</span><span class="l" id="36"> 36 
</span><span class="l" id="37"> 37     <span class="php-comment">/** @var string[] */</span>
</span><span class="l" id="38"> 38     <span class="php-keyword1">private</span> <span class="php-var">$positions</span> = [];
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40     <span class="php-comment">/** @var string[] */</span>
</span><span class="l" id="41"> 41     <span class="php-keyword1">private</span> <span class="php-var">$primaryKey</span> = [];
</span><span class="l" id="42"> 42 
</span><span class="l" id="43"> 43     <span class="php-comment">/** @var bool */</span>
</span><span class="l" id="44"> 44     <span class="php-keyword1">private</span> <span class="php-var">$primaryKeyModified</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="45"> 45 
</span><span class="l" id="46"> 46     <span class="php-comment">/** @var rex_sql_index[] */</span>
</span><span class="l" id="47"> 47     <span class="php-keyword1">private</span> <span class="php-var">$indexes</span> = [];
</span><span class="l" id="48"> 48 
</span><span class="l" id="49"> 49     <span class="php-comment">/** @var string[] mapping from current (new) name to existing (old) name in database */</span>
</span><span class="l" id="50"> 50     <span class="php-keyword1">private</span> <span class="php-var">$indexesExisting</span> = [];
</span><span class="l" id="51"> 51 
</span><span class="l" id="52"> 52     <span class="php-comment">/** @var rex_sql_foreign_key[] */</span>
</span><span class="l" id="53"> 53     <span class="php-keyword1">private</span> <span class="php-var">$foreignKeys</span> = [];
</span><span class="l" id="54"> 54 
</span><span class="l" id="55"> 55     <span class="php-comment">/** @var string[] mapping from current (new) name to existing (old) name in database */</span>
</span><span class="l" id="56"> 56     <span class="php-keyword1">private</span> <span class="php-var">$foreignKeysExisting</span> = [];
</span><span class="l" id="57"> 57 
</span><span class="l" id="58"> 58     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> __construct(<span class="php-var">$name</span>)
</span><span class="l" id="59"> 59     {
</span><span class="l" id="60"> 60         <span class="php-var">$this</span>-&gt;sql = rex_sql::factory();
</span><span class="l" id="61"> 61         <span class="php-var">$this</span>-&gt;name = <span class="php-var">$name</span>;
</span><span class="l" id="62"> 62         <span class="php-var">$this</span>-&gt;originalName = <span class="php-var">$name</span>;
</span><span class="l" id="63"> 63 
</span><span class="l" id="64"> 64         <span class="php-keyword1">try</span> {
</span><span class="l" id="65"> 65             <span class="php-var">$columns</span> = rex_sql::showColumns(<span class="php-var">$name</span>);
</span><span class="l" id="66"> 66             <span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="67"> 67         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$exception</span>) {
</span><span class="l" id="68"> 68             <span class="php-comment">// Error code 42S02 means: Table does not exist</span>
</span><span class="l" id="69"> 69             <span class="php-keyword1">if</span> (<span class="php-var">$exception</span>-&gt;getSql() &amp;&amp; <span class="php-quote">'42S02'</span> !== <span class="php-var">$exception</span>-&gt;getSql()-&gt;getErrno()) {
</span><span class="l" id="70"> 70                 <span class="php-keyword1">throw</span> <span class="php-var">$exception</span>;
</span><span class="l" id="71"> 71             }
</span><span class="l" id="72"> 72 
</span><span class="l" id="73"> 73             <span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="74"> 74 
</span><span class="l" id="75"> 75             <span class="php-keyword1">return</span>;
</span><span class="l" id="76"> 76         }
</span><span class="l" id="77"> 77 
</span><span class="l" id="78"> 78         <span class="php-keyword1">foreach</span> (<span class="php-var">$columns</span> <span class="php-keyword1">as</span> <span class="php-var">$column</span>) {
</span><span class="l" id="79"> 79             <span class="php-var">$this</span>-&gt;columns[<span class="php-var">$column</span>[<span class="php-quote">'name'</span>]] = <span class="php-keyword1">new</span> rex_sql_column(
</span><span class="l" id="80"> 80                 <span class="php-var">$column</span>[<span class="php-quote">'name'</span>],
</span><span class="l" id="81"> 81                 <span class="php-var">$column</span>[<span class="php-quote">'type'</span>],
</span><span class="l" id="82"> 82                 <span class="php-quote">'YES'</span> === <span class="php-var">$column</span>[<span class="php-quote">'null'</span>],
</span><span class="l" id="83"> 83                 <span class="php-var">$column</span>[<span class="php-quote">'default'</span>],
</span><span class="l" id="84"> 84                 <span class="php-var">$column</span>[<span class="php-quote">'extra'</span>] ?: <span class="php-keyword1">null</span>
</span><span class="l" id="85"> 85             );
</span><span class="l" id="86"> 86 
</span><span class="l" id="87"> 87             <span class="php-var">$this</span>-&gt;columnsExisting[<span class="php-var">$column</span>[<span class="php-quote">'name'</span>]] = <span class="php-var">$column</span>[<span class="php-quote">'name'</span>];
</span><span class="l" id="88"> 88 
</span><span class="l" id="89"> 89             <span class="php-keyword1">if</span> (<span class="php-quote">'PRI'</span> === <span class="php-var">$column</span>[<span class="php-quote">'key'</span>]) {
</span><span class="l" id="90"> 90                 <span class="php-var">$this</span>-&gt;primaryKey[] = <span class="php-var">$column</span>[<span class="php-quote">'name'</span>];
</span><span class="l" id="91"> 91             }
</span><span class="l" id="92"> 92         }
</span><span class="l" id="93"> 93 
</span><span class="l" id="94"> 94         <span class="php-var">$indexParts</span> = <span class="php-var">$this</span>-&gt;sql-&gt;getArray(<span class="php-quote">'SHOW INDEXES FROM '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$name</span>));
</span><span class="l" id="95"> 95         <span class="php-var">$indexes</span> = [];
</span><span class="l" id="96"> 96         <span class="php-keyword1">foreach</span> (<span class="php-var">$indexParts</span> <span class="php-keyword1">as</span> <span class="php-var">$part</span>) {
</span><span class="l" id="97"> 97             <span class="php-keyword1">if</span> (<span class="php-quote">'PRIMARY'</span> !== <span class="php-var">$part</span>[<span class="php-quote">'Key_name'</span>]) {
</span><span class="l" id="98"> 98                 <span class="php-var">$indexes</span>[<span class="php-var">$part</span>[<span class="php-quote">'Key_name'</span>]][] = <span class="php-var">$part</span>;
</span><span class="l" id="99"> 99             }
</span><span class="l" id="100">100         }
</span><span class="l" id="101">101 
</span><span class="l" id="102">102         <span class="php-keyword1">foreach</span> (<span class="php-var">$indexes</span> <span class="php-keyword1">as</span> <span class="php-var">$indexName</span> =&gt; <span class="php-var">$parts</span>) {
</span><span class="l" id="103">103             <span class="php-var">$columns</span> = [];
</span><span class="l" id="104">104             <span class="php-keyword1">foreach</span> (<span class="php-var">$parts</span> <span class="php-keyword1">as</span> <span class="php-var">$part</span>) {
</span><span class="l" id="105">105                 <span class="php-var">$columns</span>[] = <span class="php-var">$part</span>[<span class="php-quote">'Column_name'</span>];
</span><span class="l" id="106">106             }
</span><span class="l" id="107">107 
</span><span class="l" id="108">108             <span class="php-keyword1">if</span> (<span class="php-quote">'FULLTEXT'</span> === <span class="php-var">$parts</span>[<span class="php-num">0</span>][<span class="php-quote">'Index_type'</span>]) {
</span><span class="l" id="109">109                 <span class="php-var">$type</span> = rex_sql_index::FULLTEXT;
</span><span class="l" id="110">110             } <span class="php-keyword1">elseif</span> (<span class="php-num">0</span> === (int) <span class="php-var">$parts</span>[<span class="php-num">0</span>][<span class="php-quote">'Non_unique'</span>]) {
</span><span class="l" id="111">111                 <span class="php-var">$type</span> = rex_sql_index::UNIQUE;
</span><span class="l" id="112">112             } <span class="php-keyword1">else</span> {
</span><span class="l" id="113">113                 <span class="php-var">$type</span> = rex_sql_index::INDEX;
</span><span class="l" id="114">114             }
</span><span class="l" id="115">115 
</span><span class="l" id="116">116             <span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$indexName</span>] = <span class="php-keyword1">new</span> rex_sql_index(<span class="php-var">$indexName</span>, <span class="php-var">$columns</span>, <span class="php-var">$type</span>);
</span><span class="l" id="117">117             <span class="php-var">$this</span>-&gt;indexesExisting[<span class="php-var">$indexName</span>] = <span class="php-var">$indexName</span>;
</span><span class="l" id="118">118         }
</span><span class="l" id="119">119 
</span><span class="l" id="120">120         <span class="php-var">$foreignKeyParts</span> = <span class="php-var">$this</span>-&gt;sql-&gt;getArray(<span class="php-quote">'
</span></span><span class="l" id="121">121 <span class="php-quote">            SELECT c.constraint_name, c.referenced_table_name, c.update_rule, c.delete_rule, k.column_name, k.referenced_column_name
</span></span><span class="l" id="122">122 <span class="php-quote">            FROM information_schema.referential_constraints c
</span></span><span class="l" id="123">123 <span class="php-quote">            LEFT JOIN information_schema.key_column_usage k ON c.constraint_name = k.constraint_name 
</span></span><span class="l" id="124">124 <span class="php-quote">            WHERE c.constraint_schema = DATABASE() AND c.table_name = ?'</span>, [<span class="php-var">$name</span>]);
</span><span class="l" id="125">125         <span class="php-var">$foreignKeys</span> = [];
</span><span class="l" id="126">126         <span class="php-keyword1">foreach</span> (<span class="php-var">$foreignKeyParts</span> <span class="php-keyword1">as</span> <span class="php-var">$part</span>) {
</span><span class="l" id="127">127             <span class="php-var">$foreignKeys</span>[<span class="php-var">$part</span>[<span class="php-quote">'constraint_name'</span>]][] = <span class="php-var">$part</span>;
</span><span class="l" id="128">128         }
</span><span class="l" id="129">129 
</span><span class="l" id="130">130         <span class="php-keyword1">foreach</span> (<span class="php-var">$foreignKeys</span> <span class="php-keyword1">as</span> <span class="php-var">$fkName</span> =&gt; <span class="php-var">$parts</span>) {
</span><span class="l" id="131">131             <span class="php-var">$columns</span> = [];
</span><span class="l" id="132">132             <span class="php-keyword1">foreach</span> (<span class="php-var">$parts</span> <span class="php-keyword1">as</span> <span class="php-var">$part</span>) {
</span><span class="l" id="133">133                 <span class="php-var">$columns</span>[<span class="php-var">$part</span>[<span class="php-quote">'column_name'</span>]] = <span class="php-var">$part</span>[<span class="php-quote">'referenced_column_name'</span>];
</span><span class="l" id="134">134             }
</span><span class="l" id="135">135 
</span><span class="l" id="136">136             <span class="php-var">$fk</span> = <span class="php-var">$parts</span>[<span class="php-num">0</span>];
</span><span class="l" id="137">137 
</span><span class="l" id="138">138             <span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$fkName</span>] = <span class="php-keyword1">new</span> rex_sql_foreign_key(<span class="php-var">$fkName</span>, <span class="php-var">$fk</span>[<span class="php-quote">'referenced_table_name'</span>], <span class="php-var">$columns</span>, <span class="php-var">$fk</span>[<span class="php-quote">'update_rule'</span>], <span class="php-var">$fk</span>[<span class="php-quote">'delete_rule'</span>]);
</span><span class="l" id="139">139             <span class="php-var">$this</span>-&gt;foreignKeysExisting[<span class="php-var">$fkName</span>] = <span class="php-var">$fkName</span>;
</span><span class="l" id="140">140         }
</span><span class="l" id="141">141     }
</span><span class="l" id="142">142 
</span><span class="l" id="143">143     <span class="php-comment">/**
</span></span><span class="l" id="144">144 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="145">145 <span class="php-comment">     *
</span></span><span class="l" id="146">146 <span class="php-comment">     * @return self
</span></span><span class="l" id="147">147 <span class="php-comment">     */</span>
</span><span class="l" id="148">148     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> get(<span class="php-var">$name</span>)
</span><span class="l" id="149">149     {
</span><span class="l" id="150">150         <span class="php-keyword1">return</span> self::getInstance(<span class="php-var">$name</span>, <span class="php-keyword1">function</span> (<span class="php-var">$name</span>) {
</span><span class="l" id="151">151             <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> self(<span class="php-var">$name</span>);
</span><span class="l" id="152">152         });
</span><span class="l" id="153">153     }
</span><span class="l" id="154">154 
</span><span class="l" id="155">155     <span class="php-comment">/**
</span></span><span class="l" id="156">156 <span class="php-comment">     * @return bool
</span></span><span class="l" id="157">157 <span class="php-comment">     */</span>
</span><span class="l" id="158">158     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> exists()
</span><span class="l" id="159">159     {
</span><span class="l" id="160">160         <span class="php-keyword1">return</span> !<span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span>;
</span><span class="l" id="161">161     }
</span><span class="l" id="162">162 
</span><span class="l" id="163">163     <span class="php-comment">/**
</span></span><span class="l" id="164">164 <span class="php-comment">     * @return string
</span></span><span class="l" id="165">165 <span class="php-comment">     */</span>
</span><span class="l" id="166">166     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getName()
</span><span class="l" id="167">167     {
</span><span class="l" id="168">168         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;name;
</span><span class="l" id="169">169     }
</span><span class="l" id="170">170 
</span><span class="l" id="171">171     <span class="php-comment">/**
</span></span><span class="l" id="172">172 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="173">173 <span class="php-comment">     *
</span></span><span class="l" id="174">174 <span class="php-comment">     * @return $this
</span></span><span class="l" id="175">175 <span class="php-comment">     */</span>
</span><span class="l" id="176">176     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setName(<span class="php-var">$name</span>)
</span><span class="l" id="177">177     {
</span><span class="l" id="178">178         <span class="php-var">$this</span>-&gt;name = <span class="php-var">$name</span>;
</span><span class="l" id="179">179 
</span><span class="l" id="180">180         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="181">181     }
</span><span class="l" id="182">182 
</span><span class="l" id="183">183     <span class="php-comment">/**
</span></span><span class="l" id="184">184 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="185">185 <span class="php-comment">     *
</span></span><span class="l" id="186">186 <span class="php-comment">     * @return bool
</span></span><span class="l" id="187">187 <span class="php-comment">     */</span>
</span><span class="l" id="188">188     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasColumn(<span class="php-var">$name</span>)
</span><span class="l" id="189">189     {
</span><span class="l" id="190">190         <span class="php-keyword1">return</span> <span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;columns[<span class="php-var">$name</span>]);
</span><span class="l" id="191">191     }
</span><span class="l" id="192">192 
</span><span class="l" id="193">193     <span class="php-comment">/**
</span></span><span class="l" id="194">194 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="195">195 <span class="php-comment">     *
</span></span><span class="l" id="196">196 <span class="php-comment">     * @return null|rex_sql_column
</span></span><span class="l" id="197">197 <span class="php-comment">     */</span>
</span><span class="l" id="198">198     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getColumn(<span class="php-var">$name</span>)
</span><span class="l" id="199">199     {
</span><span class="l" id="200">200         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasColumn(<span class="php-var">$name</span>)) {
</span><span class="l" id="201">201             <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="202">202         }
</span><span class="l" id="203">203 
</span><span class="l" id="204">204         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;columns[<span class="php-var">$name</span>];
</span><span class="l" id="205">205     }
</span><span class="l" id="206">206 
</span><span class="l" id="207">207     <span class="php-comment">/**
</span></span><span class="l" id="208">208 <span class="php-comment">     * @return rex_sql_column[]
</span></span><span class="l" id="209">209 <span class="php-comment">     */</span>
</span><span class="l" id="210">210     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getColumns()
</span><span class="l" id="211">211     {
</span><span class="l" id="212">212         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;columns;
</span><span class="l" id="213">213     }
</span><span class="l" id="214">214 
</span><span class="l" id="215">215     <span class="php-comment">/**
</span></span><span class="l" id="216">216 <span class="php-comment">     * @param rex_sql_column $column
</span></span><span class="l" id="217">217 <span class="php-comment">     * @param null|string    $afterColumn Column name or `rex_sql_table::FIRST`
</span></span><span class="l" id="218">218 <span class="php-comment">     *
</span></span><span class="l" id="219">219 <span class="php-comment">     * @return $this
</span></span><span class="l" id="220">220 <span class="php-comment">     */</span>
</span><span class="l" id="221">221     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> addColumn(rex_sql_column <span class="php-var">$column</span>, <span class="php-var">$afterColumn</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="222">222     {
</span><span class="l" id="223">223         <span class="php-var">$name</span> = <span class="php-var">$column</span>-&gt;getName();
</span><span class="l" id="224">224 
</span><span class="l" id="225">225         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasColumn(<span class="php-var">$name</span>)) {
</span><span class="l" id="226">226             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> RuntimeException(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Column "%s" already exists.'</span>, <span class="php-var">$name</span>));
</span><span class="l" id="227">227         }
</span><span class="l" id="228">228 
</span><span class="l" id="229">229         <span class="php-var">$this</span>-&gt;columns[<span class="php-var">$name</span>] = <span class="php-var">$column</span>;
</span><span class="l" id="230">230 
</span><span class="l" id="231">231         <span class="php-var">$this</span>-&gt;setPosition(<span class="php-var">$name</span>, <span class="php-var">$afterColumn</span>);
</span><span class="l" id="232">232 
</span><span class="l" id="233">233         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="234">234     }
</span><span class="l" id="235">235 
</span><span class="l" id="236">236     <span class="php-comment">/**
</span></span><span class="l" id="237">237 <span class="php-comment">     * @param rex_sql_column $column
</span></span><span class="l" id="238">238 <span class="php-comment">     * @param null|string    $afterColumn Column name or `rex_sql_table::FIRST`
</span></span><span class="l" id="239">239 <span class="php-comment">     *
</span></span><span class="l" id="240">240 <span class="php-comment">     * @return $this
</span></span><span class="l" id="241">241 <span class="php-comment">     */</span>
</span><span class="l" id="242">242     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> ensureColumn(rex_sql_column <span class="php-var">$column</span>, <span class="php-var">$afterColumn</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="243">243     {
</span><span class="l" id="244">244         <span class="php-var">$name</span> = <span class="php-var">$column</span>-&gt;getName();
</span><span class="l" id="245">245 
</span><span class="l" id="246">246         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasColumn(<span class="php-var">$name</span>)) {
</span><span class="l" id="247">247             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;addColumn(<span class="php-var">$column</span>, <span class="php-var">$afterColumn</span>);
</span><span class="l" id="248">248         }
</span><span class="l" id="249">249 
</span><span class="l" id="250">250         <span class="php-var">$this</span>-&gt;setPosition(<span class="php-var">$name</span>, <span class="php-var">$afterColumn</span>);
</span><span class="l" id="251">251 
</span><span class="l" id="252">252         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getColumn(<span class="php-var">$name</span>)-&gt;equals(<span class="php-var">$column</span>)) {
</span><span class="l" id="253">253             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="254">254         }
</span><span class="l" id="255">255 
</span><span class="l" id="256">256         <span class="php-var">$this</span>-&gt;columns[<span class="php-var">$name</span>] = <span class="php-var">$column</span>-&gt;setModified(<span class="php-keyword1">true</span>);
</span><span class="l" id="257">257 
</span><span class="l" id="258">258         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="259">259     }
</span><span class="l" id="260">260 
</span><span class="l" id="261">261     <span class="php-comment">/**
</span></span><span class="l" id="262">262 <span class="php-comment">     * @return $this
</span></span><span class="l" id="263">263 <span class="php-comment">     */</span>
</span><span class="l" id="264">264     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> ensurePrimaryIdColumn()
</span><span class="l" id="265">265     {
</span><span class="l" id="266">266         <span class="php-keyword1">return</span> <span class="php-var">$this</span>
</span><span class="l" id="267">267             -&gt;ensureColumn(<span class="php-keyword1">new</span> rex_sql_column(<span class="php-quote">'id'</span>, <span class="php-quote">'int(10) unsigned'</span>, <span class="php-keyword1">false</span>, <span class="php-keyword1">null</span>, <span class="php-quote">'auto_increment'</span>))
</span><span class="l" id="268">268             -&gt;setPrimaryKey(<span class="php-quote">'id'</span>)
</span><span class="l" id="269">269         ;
</span><span class="l" id="270">270     }
</span><span class="l" id="271">271 
</span><span class="l" id="272">272     <span class="php-comment">/**
</span></span><span class="l" id="273">273 <span class="php-comment">     * @return $this
</span></span><span class="l" id="274">274 <span class="php-comment">     */</span>
</span><span class="l" id="275">275     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> ensureGlobalColumns()
</span><span class="l" id="276">276     {
</span><span class="l" id="277">277         <span class="php-keyword1">return</span> <span class="php-var">$this</span>
</span><span class="l" id="278">278             -&gt;ensureColumn(<span class="php-keyword1">new</span> rex_sql_column(<span class="php-quote">'createdate'</span>, <span class="php-quote">'datetime'</span>))
</span><span class="l" id="279">279             -&gt;ensureColumn(<span class="php-keyword1">new</span> rex_sql_column(<span class="php-quote">'createuser'</span>, <span class="php-quote">'varchar(255)'</span>))
</span><span class="l" id="280">280             -&gt;ensureColumn(<span class="php-keyword1">new</span> rex_sql_column(<span class="php-quote">'updatedate'</span>, <span class="php-quote">'datetime'</span>))
</span><span class="l" id="281">281             -&gt;ensureColumn(<span class="php-keyword1">new</span> rex_sql_column(<span class="php-quote">'updateuser'</span>, <span class="php-quote">'varchar(255)'</span>))
</span><span class="l" id="282">282         ;
</span><span class="l" id="283">283     }
</span><span class="l" id="284">284 
</span><span class="l" id="285">285     <span class="php-comment">/**
</span></span><span class="l" id="286">286 <span class="php-comment">     * @param string $oldName
</span></span><span class="l" id="287">287 <span class="php-comment">     * @param string $newName
</span></span><span class="l" id="288">288 <span class="php-comment">     *
</span></span><span class="l" id="289">289 <span class="php-comment">     * @return $this
</span></span><span class="l" id="290">290 <span class="php-comment">     *
</span></span><span class="l" id="291">291 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="292">292 <span class="php-comment">     */</span>
</span><span class="l" id="293">293     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> renameColumn(<span class="php-var">$oldName</span>, <span class="php-var">$newName</span>)
</span><span class="l" id="294">294     {
</span><span class="l" id="295">295         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasColumn(<span class="php-var">$oldName</span>)) {
</span><span class="l" id="296">296             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Column with name "%s" does not exist.'</span>, <span class="php-var">$oldName</span>));
</span><span class="l" id="297">297         }
</span><span class="l" id="298">298 
</span><span class="l" id="299">299         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasColumn(<span class="php-var">$newName</span>)) {
</span><span class="l" id="300">300             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Column with the new name "%s" already exists.'</span>, <span class="php-var">$newName</span>));
</span><span class="l" id="301">301         }
</span><span class="l" id="302">302 
</span><span class="l" id="303">303         <span class="php-keyword1">if</span> (<span class="php-var">$oldName</span> === <span class="php-var">$newName</span>) {
</span><span class="l" id="304">304             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="305">305         }
</span><span class="l" id="306">306 
</span><span class="l" id="307">307         <span class="php-var">$column</span> = <span class="php-var">$this</span>-&gt;getColumn(<span class="php-var">$oldName</span>)-&gt;setName(<span class="php-var">$newName</span>);
</span><span class="l" id="308">308 
</span><span class="l" id="309">309         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;columns[<span class="php-var">$oldName</span>]);
</span><span class="l" id="310">310         <span class="php-var">$this</span>-&gt;columns[<span class="php-var">$newName</span>] = <span class="php-var">$column</span>;
</span><span class="l" id="311">311 
</span><span class="l" id="312">312         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;columnsExisting[<span class="php-var">$oldName</span>])) {
</span><span class="l" id="313">313             <span class="php-var">$this</span>-&gt;columnsExisting[<span class="php-var">$newName</span>] = <span class="php-var">$this</span>-&gt;columnsExisting[<span class="php-var">$oldName</span>];
</span><span class="l" id="314">314             <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;columnsExisting[<span class="php-var">$oldName</span>]);
</span><span class="l" id="315">315         }
</span><span class="l" id="316">316 
</span><span class="l" id="317">317         <span class="php-keyword1">if</span> (<span class="php-keyword1">false</span> !== <span class="php-var">$key</span> = <span class="php-keyword2">array_search</span>(<span class="php-var">$oldName</span>, <span class="php-var">$this</span>-&gt;primaryKey)) {
</span><span class="l" id="318">318             <span class="php-var">$this</span>-&gt;primaryKey[<span class="php-var">$key</span>] = <span class="php-var">$newName</span>;
</span><span class="l" id="319">319             <span class="php-var">$this</span>-&gt;primaryKeyModified = <span class="php-keyword1">true</span>;
</span><span class="l" id="320">320         }
</span><span class="l" id="321">321 
</span><span class="l" id="322">322         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="323">323     }
</span><span class="l" id="324">324 
</span><span class="l" id="325">325     <span class="php-comment">/**
</span></span><span class="l" id="326">326 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="327">327 <span class="php-comment">     *
</span></span><span class="l" id="328">328 <span class="php-comment">     * @return $this
</span></span><span class="l" id="329">329 <span class="php-comment">     */</span>
</span><span class="l" id="330">330     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> removeColumn(<span class="php-var">$name</span>)
</span><span class="l" id="331">331     {
</span><span class="l" id="332">332         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;columns[<span class="php-var">$name</span>]);
</span><span class="l" id="333">333 
</span><span class="l" id="334">334         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="335">335     }
</span><span class="l" id="336">336 
</span><span class="l" id="337">337     <span class="php-comment">/**
</span></span><span class="l" id="338">338 <span class="php-comment">     * @return null|string[] Column names
</span></span><span class="l" id="339">339 <span class="php-comment">     */</span>
</span><span class="l" id="340">340     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getPrimaryKey()
</span><span class="l" id="341">341     {
</span><span class="l" id="342">342         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;primaryKey ?: <span class="php-keyword1">null</span>;
</span><span class="l" id="343">343     }
</span><span class="l" id="344">344 
</span><span class="l" id="345">345     <span class="php-comment">/**
</span></span><span class="l" id="346">346 <span class="php-comment">     * @param null|string|string[] $columns Column name(s)
</span></span><span class="l" id="347">347 <span class="php-comment">     *
</span></span><span class="l" id="348">348 <span class="php-comment">     * @return $this
</span></span><span class="l" id="349">349 <span class="php-comment">     *
</span></span><span class="l" id="350">350 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="351">351 <span class="php-comment">     */</span>
</span><span class="l" id="352">352     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setPrimaryKey(<span class="php-var">$columns</span>)
</span><span class="l" id="353">353     {
</span><span class="l" id="354">354         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$columns</span>) &amp;&amp; !<span class="php-var">$columns</span>) {
</span><span class="l" id="355">355             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-quote">'The primary key column array can not be empty. To delete the primary key use `null` instead.'</span>);
</span><span class="l" id="356">356         }
</span><span class="l" id="357">357 
</span><span class="l" id="358">358         <span class="php-var">$columns</span> = <span class="php-keyword1">null</span> === <span class="php-var">$columns</span> ? [] : (<span class="php-keyword1">array</span>) <span class="php-var">$columns</span>;
</span><span class="l" id="359">359 
</span><span class="l" id="360">360         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;primaryKey === <span class="php-var">$columns</span>) {
</span><span class="l" id="361">361             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="362">362         }
</span><span class="l" id="363">363 
</span><span class="l" id="364">364         <span class="php-var">$this</span>-&gt;primaryKey = (<span class="php-keyword1">array</span>) <span class="php-var">$columns</span>;
</span><span class="l" id="365">365         <span class="php-var">$this</span>-&gt;primaryKeyModified = <span class="php-keyword1">true</span>;
</span><span class="l" id="366">366 
</span><span class="l" id="367">367         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="368">368     }
</span><span class="l" id="369">369 
</span><span class="l" id="370">370     <span class="php-comment">/**
</span></span><span class="l" id="371">371 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="372">372 <span class="php-comment">     *
</span></span><span class="l" id="373">373 <span class="php-comment">     * @return bool
</span></span><span class="l" id="374">374 <span class="php-comment">     */</span>
</span><span class="l" id="375">375     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasIndex(<span class="php-var">$name</span>)
</span><span class="l" id="376">376     {
</span><span class="l" id="377">377         <span class="php-keyword1">return</span> <span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$name</span>]);
</span><span class="l" id="378">378     }
</span><span class="l" id="379">379 
</span><span class="l" id="380">380     <span class="php-comment">/**
</span></span><span class="l" id="381">381 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="382">382 <span class="php-comment">     *
</span></span><span class="l" id="383">383 <span class="php-comment">     * @return null|rex_sql_index
</span></span><span class="l" id="384">384 <span class="php-comment">     */</span>
</span><span class="l" id="385">385     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getIndex(<span class="php-var">$name</span>)
</span><span class="l" id="386">386     {
</span><span class="l" id="387">387         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasIndex(<span class="php-var">$name</span>)) {
</span><span class="l" id="388">388             <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="389">389         }
</span><span class="l" id="390">390 
</span><span class="l" id="391">391         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$name</span>];
</span><span class="l" id="392">392     }
</span><span class="l" id="393">393 
</span><span class="l" id="394">394     <span class="php-comment">/**
</span></span><span class="l" id="395">395 <span class="php-comment">     * @return rex_sql_index[]
</span></span><span class="l" id="396">396 <span class="php-comment">     */</span>
</span><span class="l" id="397">397     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getIndexes()
</span><span class="l" id="398">398     {
</span><span class="l" id="399">399         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;indexes;
</span><span class="l" id="400">400     }
</span><span class="l" id="401">401 
</span><span class="l" id="402">402     <span class="php-comment">/**
</span></span><span class="l" id="403">403 <span class="php-comment">     * @param rex_sql_index $index
</span></span><span class="l" id="404">404 <span class="php-comment">     *
</span></span><span class="l" id="405">405 <span class="php-comment">     * @return $this
</span></span><span class="l" id="406">406 <span class="php-comment">     */</span>
</span><span class="l" id="407">407     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> addIndex(rex_sql_index <span class="php-var">$index</span>)
</span><span class="l" id="408">408     {
</span><span class="l" id="409">409         <span class="php-var">$name</span> = <span class="php-var">$index</span>-&gt;getName();
</span><span class="l" id="410">410 
</span><span class="l" id="411">411         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasIndex(<span class="php-var">$name</span>)) {
</span><span class="l" id="412">412             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> RuntimeException(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Index "%s" already exists.'</span>, <span class="php-var">$name</span>));
</span><span class="l" id="413">413         }
</span><span class="l" id="414">414 
</span><span class="l" id="415">415         <span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$name</span>] = <span class="php-var">$index</span>;
</span><span class="l" id="416">416 
</span><span class="l" id="417">417         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="418">418     }
</span><span class="l" id="419">419 
</span><span class="l" id="420">420     <span class="php-comment">/**
</span></span><span class="l" id="421">421 <span class="php-comment">     * @param rex_sql_index $index
</span></span><span class="l" id="422">422 <span class="php-comment">     *
</span></span><span class="l" id="423">423 <span class="php-comment">     * @return $this
</span></span><span class="l" id="424">424 <span class="php-comment">     */</span>
</span><span class="l" id="425">425     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> ensureIndex(rex_sql_index <span class="php-var">$index</span>)
</span><span class="l" id="426">426     {
</span><span class="l" id="427">427         <span class="php-var">$name</span> = <span class="php-var">$index</span>-&gt;getName();
</span><span class="l" id="428">428 
</span><span class="l" id="429">429         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasIndex(<span class="php-var">$name</span>)) {
</span><span class="l" id="430">430             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;addIndex(<span class="php-var">$index</span>);
</span><span class="l" id="431">431         }
</span><span class="l" id="432">432 
</span><span class="l" id="433">433         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getIndex(<span class="php-var">$name</span>)-&gt;equals(<span class="php-var">$index</span>)) {
</span><span class="l" id="434">434             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="435">435         }
</span><span class="l" id="436">436 
</span><span class="l" id="437">437         <span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$name</span>] = <span class="php-var">$index</span>-&gt;setModified(<span class="php-keyword1">true</span>);
</span><span class="l" id="438">438 
</span><span class="l" id="439">439         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="440">440     }
</span><span class="l" id="441">441 
</span><span class="l" id="442">442     <span class="php-comment">/**
</span></span><span class="l" id="443">443 <span class="php-comment">     * @param string $oldName
</span></span><span class="l" id="444">444 <span class="php-comment">     * @param string $newName
</span></span><span class="l" id="445">445 <span class="php-comment">     *
</span></span><span class="l" id="446">446 <span class="php-comment">     * @return $this
</span></span><span class="l" id="447">447 <span class="php-comment">     *
</span></span><span class="l" id="448">448 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="449">449 <span class="php-comment">     */</span>
</span><span class="l" id="450">450     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> renameIndex(<span class="php-var">$oldName</span>, <span class="php-var">$newName</span>)
</span><span class="l" id="451">451     {
</span><span class="l" id="452">452         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasIndex(<span class="php-var">$oldName</span>)) {
</span><span class="l" id="453">453             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Index with name "%s" does not exist.'</span>, <span class="php-var">$oldName</span>));
</span><span class="l" id="454">454         }
</span><span class="l" id="455">455 
</span><span class="l" id="456">456         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasIndex(<span class="php-var">$newName</span>)) {
</span><span class="l" id="457">457             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Index with the new name "%s" already exists.'</span>, <span class="php-var">$newName</span>));
</span><span class="l" id="458">458         }
</span><span class="l" id="459">459 
</span><span class="l" id="460">460         <span class="php-keyword1">if</span> (<span class="php-var">$oldName</span> === <span class="php-var">$newName</span>) {
</span><span class="l" id="461">461             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="462">462         }
</span><span class="l" id="463">463 
</span><span class="l" id="464">464         <span class="php-var">$index</span> = <span class="php-var">$this</span>-&gt;getIndex(<span class="php-var">$oldName</span>)-&gt;setName(<span class="php-var">$newName</span>);
</span><span class="l" id="465">465 
</span><span class="l" id="466">466         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$oldName</span>]);
</span><span class="l" id="467">467         <span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$newName</span>] = <span class="php-var">$index</span>;
</span><span class="l" id="468">468 
</span><span class="l" id="469">469         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;indexesExisting[<span class="php-var">$oldName</span>])) {
</span><span class="l" id="470">470             <span class="php-var">$this</span>-&gt;indexesExisting[<span class="php-var">$newName</span>] = <span class="php-var">$this</span>-&gt;indexesExisting[<span class="php-var">$oldName</span>];
</span><span class="l" id="471">471             <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;indexesExisting[<span class="php-var">$oldName</span>]);
</span><span class="l" id="472">472         }
</span><span class="l" id="473">473 
</span><span class="l" id="474">474         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="475">475     }
</span><span class="l" id="476">476 
</span><span class="l" id="477">477     <span class="php-comment">/**
</span></span><span class="l" id="478">478 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="479">479 <span class="php-comment">     *
</span></span><span class="l" id="480">480 <span class="php-comment">     * @return $this
</span></span><span class="l" id="481">481 <span class="php-comment">     */</span>
</span><span class="l" id="482">482     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> removeIndex(<span class="php-var">$name</span>)
</span><span class="l" id="483">483     {
</span><span class="l" id="484">484         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$name</span>]);
</span><span class="l" id="485">485 
</span><span class="l" id="486">486         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="487">487     }
</span><span class="l" id="488">488 
</span><span class="l" id="489">489     <span class="php-comment">/**
</span></span><span class="l" id="490">490 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="491">491 <span class="php-comment">     *
</span></span><span class="l" id="492">492 <span class="php-comment">     * @return bool
</span></span><span class="l" id="493">493 <span class="php-comment">     */</span>
</span><span class="l" id="494">494     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasForeignKey(<span class="php-var">$name</span>)
</span><span class="l" id="495">495     {
</span><span class="l" id="496">496         <span class="php-keyword1">return</span> <span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$name</span>]);
</span><span class="l" id="497">497     }
</span><span class="l" id="498">498 
</span><span class="l" id="499">499     <span class="php-comment">/**
</span></span><span class="l" id="500">500 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="501">501 <span class="php-comment">     *
</span></span><span class="l" id="502">502 <span class="php-comment">     * @return null|rex_sql_foreign_key
</span></span><span class="l" id="503">503 <span class="php-comment">     */</span>
</span><span class="l" id="504">504     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getForeignKey(<span class="php-var">$name</span>)
</span><span class="l" id="505">505     {
</span><span class="l" id="506">506         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasForeignKey(<span class="php-var">$name</span>)) {
</span><span class="l" id="507">507             <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="508">508         }
</span><span class="l" id="509">509 
</span><span class="l" id="510">510         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$name</span>];
</span><span class="l" id="511">511     }
</span><span class="l" id="512">512 
</span><span class="l" id="513">513     <span class="php-comment">/**
</span></span><span class="l" id="514">514 <span class="php-comment">     * @return rex_sql_foreign_key[]
</span></span><span class="l" id="515">515 <span class="php-comment">     */</span>
</span><span class="l" id="516">516     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getForeignKeys()
</span><span class="l" id="517">517     {
</span><span class="l" id="518">518         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;foreignKeys;
</span><span class="l" id="519">519     }
</span><span class="l" id="520">520 
</span><span class="l" id="521">521     <span class="php-comment">/**
</span></span><span class="l" id="522">522 <span class="php-comment">     * @return $this
</span></span><span class="l" id="523">523 <span class="php-comment">     */</span>
</span><span class="l" id="524">524     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> addForeignKey(rex_sql_foreign_key <span class="php-var">$foreignKey</span>)
</span><span class="l" id="525">525     {
</span><span class="l" id="526">526         <span class="php-var">$name</span> = <span class="php-var">$foreignKey</span>-&gt;getName();
</span><span class="l" id="527">527 
</span><span class="l" id="528">528         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasForeignKey(<span class="php-var">$name</span>)) {
</span><span class="l" id="529">529             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> RuntimeException(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Foreign key "%s" already exists.'</span>, <span class="php-var">$name</span>));
</span><span class="l" id="530">530         }
</span><span class="l" id="531">531 
</span><span class="l" id="532">532         <span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$name</span>] = <span class="php-var">$foreignKey</span>;
</span><span class="l" id="533">533 
</span><span class="l" id="534">534         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="535">535     }
</span><span class="l" id="536">536 
</span><span class="l" id="537">537     <span class="php-comment">/**
</span></span><span class="l" id="538">538 <span class="php-comment">     * @return $this
</span></span><span class="l" id="539">539 <span class="php-comment">     */</span>
</span><span class="l" id="540">540     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> ensureForeignKey(rex_sql_foreign_key <span class="php-var">$foreignKey</span>)
</span><span class="l" id="541">541     {
</span><span class="l" id="542">542         <span class="php-var">$name</span> = <span class="php-var">$foreignKey</span>-&gt;getName();
</span><span class="l" id="543">543 
</span><span class="l" id="544">544         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasForeignKey(<span class="php-var">$name</span>)) {
</span><span class="l" id="545">545             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;addForeignKey(<span class="php-var">$foreignKey</span>);
</span><span class="l" id="546">546         }
</span><span class="l" id="547">547 
</span><span class="l" id="548">548         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getForeignKey(<span class="php-var">$name</span>)-&gt;equals(<span class="php-var">$foreignKey</span>)) {
</span><span class="l" id="549">549             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="550">550         }
</span><span class="l" id="551">551 
</span><span class="l" id="552">552         <span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$name</span>] = <span class="php-var">$foreignKey</span>-&gt;setModified(<span class="php-keyword1">true</span>);
</span><span class="l" id="553">553 
</span><span class="l" id="554">554         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="555">555     }
</span><span class="l" id="556">556 
</span><span class="l" id="557">557     <span class="php-comment">/**
</span></span><span class="l" id="558">558 <span class="php-comment">     * @param string $oldName
</span></span><span class="l" id="559">559 <span class="php-comment">     * @param string $newName
</span></span><span class="l" id="560">560 <span class="php-comment">     *
</span></span><span class="l" id="561">561 <span class="php-comment">     * @return $this
</span></span><span class="l" id="562">562 <span class="php-comment">     *
</span></span><span class="l" id="563">563 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="564">564 <span class="php-comment">     */</span>
</span><span class="l" id="565">565     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> renameForeignKey(<span class="php-var">$oldName</span>, <span class="php-var">$newName</span>)
</span><span class="l" id="566">566     {
</span><span class="l" id="567">567         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;hasForeignKey(<span class="php-var">$oldName</span>)) {
</span><span class="l" id="568">568             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Foreign key with name "%s" does not exist.'</span>, <span class="php-var">$oldName</span>));
</span><span class="l" id="569">569         }
</span><span class="l" id="570">570 
</span><span class="l" id="571">571         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasForeignKey(<span class="php-var">$newName</span>)) {
</span><span class="l" id="572">572             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Foreign key with the new name "%s" already exists.'</span>, <span class="php-var">$newName</span>));
</span><span class="l" id="573">573         }
</span><span class="l" id="574">574 
</span><span class="l" id="575">575         <span class="php-keyword1">if</span> (<span class="php-var">$oldName</span> === <span class="php-var">$newName</span>) {
</span><span class="l" id="576">576             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="577">577         }
</span><span class="l" id="578">578 
</span><span class="l" id="579">579         <span class="php-var">$foreignKey</span> = <span class="php-var">$this</span>-&gt;getForeignKey(<span class="php-var">$oldName</span>)-&gt;setName(<span class="php-var">$newName</span>);
</span><span class="l" id="580">580 
</span><span class="l" id="581">581         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$oldName</span>]);
</span><span class="l" id="582">582         <span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$newName</span>] = <span class="php-var">$foreignKey</span>;
</span><span class="l" id="583">583 
</span><span class="l" id="584">584         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;foreignKeysExisting[<span class="php-var">$oldName</span>])) {
</span><span class="l" id="585">585             <span class="php-var">$this</span>-&gt;foreignKeysExisting[<span class="php-var">$newName</span>] = <span class="php-var">$this</span>-&gt;foreignKeysExisting[<span class="php-var">$oldName</span>];
</span><span class="l" id="586">586             <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;foreignKeysExisting[<span class="php-var">$oldName</span>]);
</span><span class="l" id="587">587         }
</span><span class="l" id="588">588 
</span><span class="l" id="589">589         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="590">590     }
</span><span class="l" id="591">591 
</span><span class="l" id="592">592     <span class="php-comment">/**
</span></span><span class="l" id="593">593 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="594">594 <span class="php-comment">     *
</span></span><span class="l" id="595">595 <span class="php-comment">     * @return $this
</span></span><span class="l" id="596">596 <span class="php-comment">     */</span>
</span><span class="l" id="597">597     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> removeForeignKey(<span class="php-var">$name</span>)
</span><span class="l" id="598">598     {
</span><span class="l" id="599">599         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$name</span>]);
</span><span class="l" id="600">600 
</span><span class="l" id="601">601         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="602">602     }
</span><span class="l" id="603">603 
</span><span class="l" id="604">604     <span class="php-comment">/**
</span></span><span class="l" id="605">605 <span class="php-comment">     * Ensures that the table exists with the given definition.
</span></span><span class="l" id="606">606 <span class="php-comment">     */</span>
</span><span class="l" id="607">607     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> ensure()
</span><span class="l" id="608">608     {
</span><span class="l" id="609">609         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span>) {
</span><span class="l" id="610">610             <span class="php-var">$this</span>-&gt;create();
</span><span class="l" id="611">611 
</span><span class="l" id="612">612             <span class="php-keyword1">return</span>;
</span><span class="l" id="613">613         }
</span><span class="l" id="614">614 
</span><span class="l" id="615">615         <span class="php-var">$positions</span> = <span class="php-var">$this</span>-&gt;positions;
</span><span class="l" id="616">616         <span class="php-var">$this</span>-&gt;positions = [];
</span><span class="l" id="617">617 
</span><span class="l" id="618">618         <span class="php-var">$previous</span> = self::FIRST;
</span><span class="l" id="619">619         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;implicitOrder <span class="php-keyword1">as</span> <span class="php-var">$name</span>) {
</span><span class="l" id="620">620             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>])) {
</span><span class="l" id="621">621                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="622">622             }
</span><span class="l" id="623">623 
</span><span class="l" id="624">624             <span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>] = <span class="php-var">$previous</span>;
</span><span class="l" id="625">625             <span class="php-var">$previous</span> = <span class="php-var">$name</span>;
</span><span class="l" id="626">626         }
</span><span class="l" id="627">627 
</span><span class="l" id="628">628         <span class="php-keyword1">foreach</span> (<span class="php-var">$positions</span> <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$after</span>) {
</span><span class="l" id="629">629             <span class="php-comment">// unset is necessary to add new position as last array element</span>
</span><span class="l" id="630">630             <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>]);
</span><span class="l" id="631">631             <span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>] = <span class="php-var">$after</span>;
</span><span class="l" id="632">632         }
</span><span class="l" id="633">633 
</span><span class="l" id="634">634         <span class="php-var">$this</span>-&gt;alter();
</span><span class="l" id="635">635     }
</span><span class="l" id="636">636 
</span><span class="l" id="637">637     <span class="php-comment">/**
</span></span><span class="l" id="638">638 <span class="php-comment">     * Drops the table if it exists.
</span></span><span class="l" id="639">639 <span class="php-comment">     */</span>
</span><span class="l" id="640">640     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> drop()
</span><span class="l" id="641">641     {
</span><span class="l" id="642">642         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span>) {
</span><span class="l" id="643">643             <span class="php-var">$this</span>-&gt;sql-&gt;setQuery(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'DROP TABLE %s'</span>, <span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;name)));
</span><span class="l" id="644">644         }
</span><span class="l" id="645">645 
</span><span class="l" id="646">646         <span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="647">647         <span class="php-var">$this</span>-&gt;originalName = <span class="php-var">$this</span>-&gt;name;
</span><span class="l" id="648">648         <span class="php-var">$this</span>-&gt;columnsExisting = [];
</span><span class="l" id="649">649         <span class="php-var">$this</span>-&gt;implicitOrder = [];
</span><span class="l" id="650">650         <span class="php-var">$this</span>-&gt;positions = [];
</span><span class="l" id="651">651         <span class="php-var">$this</span>-&gt;primaryKeyModified = !<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;primaryKey);
</span><span class="l" id="652">652     }
</span><span class="l" id="653">653 
</span><span class="l" id="654">654     <span class="php-comment">/**
</span></span><span class="l" id="655">655 <span class="php-comment">     * Creates the table.
</span></span><span class="l" id="656">656 <span class="php-comment">     *
</span></span><span class="l" id="657">657 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="658">658 <span class="php-comment">     */</span>
</span><span class="l" id="659">659     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> create()
</span><span class="l" id="660">660     {
</span><span class="l" id="661">661         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span>) {
</span><span class="l" id="662">662             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Table "%s" already exists.'</span>, <span class="php-var">$this</span>-&gt;name));
</span><span class="l" id="663">663         }
</span><span class="l" id="664">664         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;columns) {
</span><span class="l" id="665">665             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-quote">'A table must have at least one column.'</span>);
</span><span class="l" id="666">666         }
</span><span class="l" id="667">667 
</span><span class="l" id="668">668         <span class="php-var">$this</span>-&gt;sortColumns();
</span><span class="l" id="669">669 
</span><span class="l" id="670">670         <span class="php-var">$parts</span> = [];
</span><span class="l" id="671">671 
</span><span class="l" id="672">672         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;columns <span class="php-keyword1">as</span> <span class="php-var">$column</span>) {
</span><span class="l" id="673">673             <span class="php-var">$parts</span>[] = <span class="php-var">$this</span>-&gt;getColumnDefinition(<span class="php-var">$column</span>);
</span><span class="l" id="674">674         }
</span><span class="l" id="675">675 
</span><span class="l" id="676">676         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;primaryKey) {
</span><span class="l" id="677">677             <span class="php-var">$parts</span>[] = <span class="php-quote">'PRIMARY KEY '</span>.<span class="php-var">$this</span>-&gt;getKeyColumnsDefintion(<span class="php-var">$this</span>-&gt;primaryKey);
</span><span class="l" id="678">678         }
</span><span class="l" id="679">679 
</span><span class="l" id="680">680         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;indexes <span class="php-keyword1">as</span> <span class="php-var">$index</span>) {
</span><span class="l" id="681">681             <span class="php-var">$parts</span>[] = <span class="php-var">$this</span>-&gt;getIndexDefinition(<span class="php-var">$index</span>);
</span><span class="l" id="682">682         }
</span><span class="l" id="683">683 
</span><span class="l" id="684">684         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;foreignKeys <span class="php-keyword1">as</span> <span class="php-var">$foreignKey</span>) {
</span><span class="l" id="685">685             <span class="php-var">$parts</span>[] = <span class="php-var">$this</span>-&gt;getForeignKeyDefinition(<span class="php-var">$foreignKey</span>);
</span><span class="l" id="686">686         }
</span><span class="l" id="687">687 
</span><span class="l" id="688">688         <span class="php-var">$query</span> = <span class="php-quote">'CREATE TABLE '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;name).<span class="php-quote">" (\n    "</span>;
</span><span class="l" id="689">689         <span class="php-var">$query</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">",\n    "</span>, <span class="php-var">$parts</span>);
</span><span class="l" id="690">690         <span class="php-var">$query</span> .= <span class="php-quote">"\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;"</span>;
</span><span class="l" id="691">691 
</span><span class="l" id="692">692         <span class="php-var">$this</span>-&gt;sql-&gt;setQuery(<span class="php-var">$query</span>);
</span><span class="l" id="693">693 
</span><span class="l" id="694">694         <span class="php-var">$this</span>-&gt;resetModified();
</span><span class="l" id="695">695     }
</span><span class="l" id="696">696 
</span><span class="l" id="697">697     <span class="php-comment">/**
</span></span><span class="l" id="698">698 <span class="php-comment">     * Alters the table.
</span></span><span class="l" id="699">699 <span class="php-comment">     *
</span></span><span class="l" id="700">700 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="701">701 <span class="php-comment">     */</span>
</span><span class="l" id="702">702     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> alter()
</span><span class="l" id="703">703     {
</span><span class="l" id="704">704         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span>) {
</span><span class="l" id="705">705             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Table "%s" does not exist.'</span>, <span class="php-var">$this</span>-&gt;name));
</span><span class="l" id="706">706         }
</span><span class="l" id="707">707 
</span><span class="l" id="708">708         <span class="php-var">$parts</span> = [];
</span><span class="l" id="709">709         <span class="php-var">$dropForeignKeys</span> = [];
</span><span class="l" id="710">710 
</span><span class="l" id="711">711         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;name !== <span class="php-var">$this</span>-&gt;originalName) {
</span><span class="l" id="712">712             <span class="php-var">$parts</span>[] = <span class="php-quote">'RENAME '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;name);
</span><span class="l" id="713">713         }
</span><span class="l" id="714">714 
</span><span class="l" id="715">715         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;primaryKeyModified) {
</span><span class="l" id="716">716             <span class="php-var">$parts</span>[] = <span class="php-quote">'DROP PRIMARY KEY'</span>;
</span><span class="l" id="717">717         }
</span><span class="l" id="718">718 
</span><span class="l" id="719">719         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;indexesExisting <span class="php-keyword1">as</span> <span class="php-var">$newName</span> =&gt; <span class="php-var">$oldName</span>) {
</span><span class="l" id="720">720             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$newName</span>]) || <span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$newName</span>]-&gt;isModified()) {
</span><span class="l" id="721">721                 <span class="php-var">$parts</span>[] = <span class="php-quote">'DROP INDEX '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$oldName</span>);
</span><span class="l" id="722">722             }
</span><span class="l" id="723">723         }
</span><span class="l" id="724">724 
</span><span class="l" id="725">725         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;foreignKeysExisting <span class="php-keyword1">as</span> <span class="php-var">$newName</span> =&gt; <span class="php-var">$oldName</span>) {
</span><span class="l" id="726">726             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$newName</span>]) || <span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$newName</span>]-&gt;isModified()) {
</span><span class="l" id="727">727                 <span class="php-var">$dropForeignKeys</span>[] = <span class="php-quote">'DROP FOREIGN KEY '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$oldName</span>);
</span><span class="l" id="728">728             }
</span><span class="l" id="729">729         }
</span><span class="l" id="730">730 
</span><span class="l" id="731">731         <span class="php-var">$columns</span> = <span class="php-var">$this</span>-&gt;columns;
</span><span class="l" id="732">732         <span class="php-var">$columnsExisting</span> = <span class="php-var">$this</span>-&gt;columnsExisting;
</span><span class="l" id="733">733 
</span><span class="l" id="734">734         <span class="php-var">$handle</span> = <span class="php-keyword1">function</span> (<span class="php-var">$name</span>, <span class="php-var">$after</span> = <span class="php-keyword1">null</span>) <span class="php-keyword1">use</span> (&amp;<span class="php-var">$parts</span>, &amp;<span class="php-var">$columns</span>, &amp;<span class="php-var">$columnsExisting</span>) {
</span><span class="l" id="735">735             <span class="php-var">$column</span> = <span class="php-var">$columns</span>[<span class="php-var">$name</span>];
</span><span class="l" id="736">736             <span class="php-var">$new</span> = !<span class="php-keyword1">isset</span>(<span class="php-var">$columnsExisting</span>[<span class="php-var">$name</span>]);
</span><span class="l" id="737">737             <span class="php-var">$oldName</span> = <span class="php-var">$new</span> ? <span class="php-keyword1">null</span> : <span class="php-var">$columnsExisting</span>[<span class="php-var">$name</span>];
</span><span class="l" id="738">738             <span class="php-keyword1">unset</span>(<span class="php-var">$columns</span>[<span class="php-var">$name</span>], <span class="php-var">$columnsExisting</span>[<span class="php-var">$name</span>]);
</span><span class="l" id="739">739 
</span><span class="l" id="740">740             <span class="php-keyword1">if</span> (!<span class="php-var">$new</span> &amp;&amp; !<span class="php-var">$column</span>-&gt;isModified() &amp;&amp; <span class="php-keyword1">null</span> === <span class="php-var">$after</span>) {
</span><span class="l" id="741">741                 <span class="php-keyword1">return</span>;
</span><span class="l" id="742">742             }
</span><span class="l" id="743">743 
</span><span class="l" id="744">744             <span class="php-var">$definition</span> = <span class="php-var">$this</span>-&gt;getColumnDefinition(<span class="php-var">$column</span>);
</span><span class="l" id="745">745 
</span><span class="l" id="746">746             <span class="php-keyword1">if</span> (self::FIRST === <span class="php-var">$after</span>) {
</span><span class="l" id="747">747                 <span class="php-var">$definition</span> .= <span class="php-quote">' FIRST'</span>;
</span><span class="l" id="748">748             } <span class="php-keyword1">elseif</span> (<span class="php-keyword1">null</span> !== <span class="php-var">$after</span>) {
</span><span class="l" id="749">749                 <span class="php-var">$definition</span> .= <span class="php-quote">' AFTER '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$after</span>);
</span><span class="l" id="750">750             }
</span><span class="l" id="751">751 
</span><span class="l" id="752">752             <span class="php-keyword1">if</span> (<span class="php-var">$new</span>) {
</span><span class="l" id="753">753                 <span class="php-var">$parts</span>[] = <span class="php-quote">'ADD '</span>.<span class="php-var">$definition</span>;
</span><span class="l" id="754">754             } <span class="php-keyword1">else</span> {
</span><span class="l" id="755">755                 <span class="php-var">$parts</span>[] = <span class="php-quote">'CHANGE '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$oldName</span>).<span class="php-quote">' '</span>.<span class="php-var">$definition</span>;
</span><span class="l" id="756">756             }
</span><span class="l" id="757">757         };
</span><span class="l" id="758">758 
</span><span class="l" id="759">759         <span class="php-var">$currentOrder</span> = [];
</span><span class="l" id="760">760         <span class="php-var">$after</span> = self::FIRST;
</span><span class="l" id="761">761         <span class="php-keyword1">foreach</span> (<span class="php-var">$columns</span> <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$column</span>) {
</span><span class="l" id="762">762             <span class="php-var">$currentOrder</span>[<span class="php-var">$after</span>] = <span class="php-var">$name</span>;
</span><span class="l" id="763">763             <span class="php-var">$after</span> = <span class="php-var">$name</span>;
</span><span class="l" id="764">764 
</span><span class="l" id="765">765             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>])) {
</span><span class="l" id="766">766                 <span class="php-var">$handle</span>(<span class="php-var">$name</span>);
</span><span class="l" id="767">767             }
</span><span class="l" id="768">768         }
</span><span class="l" id="769">769 
</span><span class="l" id="770">770         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;positions <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$after</span>) {
</span><span class="l" id="771">771             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$columns</span>[<span class="php-var">$name</span>])) {
</span><span class="l" id="772">772                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="773">773             }
</span><span class="l" id="774">774 
</span><span class="l" id="775">775             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$currentOrder</span>[<span class="php-var">$after</span>]) &amp;&amp; <span class="php-var">$currentOrder</span>[<span class="php-var">$after</span>] === <span class="php-var">$name</span>) {
</span><span class="l" id="776">776                 <span class="php-var">$after</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="777">777             } <span class="php-keyword1">else</span> {
</span><span class="l" id="778">778                 <span class="php-keyword1">unset</span>(<span class="php-var">$currentOrder</span>[<span class="php-var">$name</span>]);
</span><span class="l" id="779">779             }
</span><span class="l" id="780">780 
</span><span class="l" id="781">781             <span class="php-var">$handle</span>(<span class="php-var">$name</span>, <span class="php-var">$after</span>);
</span><span class="l" id="782">782         }
</span><span class="l" id="783">783 
</span><span class="l" id="784">784         <span class="php-keyword1">foreach</span> (<span class="php-var">$columnsExisting</span> <span class="php-keyword1">as</span> <span class="php-var">$oldName</span>) {
</span><span class="l" id="785">785             <span class="php-var">$parts</span>[] = <span class="php-quote">'DROP '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$oldName</span>);
</span><span class="l" id="786">786         }
</span><span class="l" id="787">787 
</span><span class="l" id="788">788         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;primaryKeyModified &amp;&amp; <span class="php-var">$this</span>-&gt;primaryKey) {
</span><span class="l" id="789">789             <span class="php-var">$parts</span>[] = <span class="php-quote">'ADD PRIMARY KEY '</span>.<span class="php-var">$this</span>-&gt;getKeyColumnsDefintion(<span class="php-var">$this</span>-&gt;primaryKey);
</span><span class="l" id="790">790         }
</span><span class="l" id="791">791 
</span><span class="l" id="792">792         <span class="php-var">$fulltextIndexes</span> = [];
</span><span class="l" id="793">793         <span class="php-var">$fulltextAdded</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="794">794         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;indexes <span class="php-keyword1">as</span> <span class="php-var">$index</span>) {
</span><span class="l" id="795">795             <span class="php-keyword1">if</span> (!<span class="php-var">$index</span>-&gt;isModified() &amp;&amp; <span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;indexesExisting[<span class="php-var">$index</span>-&gt;getName()])) {
</span><span class="l" id="796">796                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="797">797             }
</span><span class="l" id="798">798 
</span><span class="l" id="799">799             <span class="php-keyword1">if</span> (rex_sql_index::FULLTEXT === <span class="php-var">$index</span>-&gt;<span class="php-keyword2">getType</span>()) {
</span><span class="l" id="800">800                 <span class="php-keyword1">if</span> (<span class="php-var">$fulltextAdded</span>) {
</span><span class="l" id="801">801                     <span class="php-var">$fulltextIndexes</span>[] = <span class="php-quote">'ADD '</span>.<span class="php-var">$this</span>-&gt;getIndexDefinition(<span class="php-var">$index</span>);
</span><span class="l" id="802">802 
</span><span class="l" id="803">803                     <span class="php-keyword1">continue</span>;
</span><span class="l" id="804">804                 }
</span><span class="l" id="805">805 
</span><span class="l" id="806">806                 <span class="php-var">$fulltextAdded</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="807">807             }
</span><span class="l" id="808">808 
</span><span class="l" id="809">809             <span class="php-var">$parts</span>[] = <span class="php-quote">'ADD '</span>.<span class="php-var">$this</span>-&gt;getIndexDefinition(<span class="php-var">$index</span>);
</span><span class="l" id="810">810         }
</span><span class="l" id="811">811 
</span><span class="l" id="812">812         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;foreignKeys <span class="php-keyword1">as</span> <span class="php-var">$foreignKey</span>) {
</span><span class="l" id="813">813             <span class="php-keyword1">if</span> (<span class="php-var">$foreignKey</span>-&gt;isModified() || !<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;foreignKeysExisting[<span class="php-var">$foreignKey</span>-&gt;getName()])) {
</span><span class="l" id="814">814                 <span class="php-var">$parts</span>[] = <span class="php-quote">'ADD '</span>.<span class="php-var">$this</span>-&gt;getForeignKeyDefinition(<span class="php-var">$foreignKey</span>);
</span><span class="l" id="815">815             }
</span><span class="l" id="816">816         }
</span><span class="l" id="817">817 
</span><span class="l" id="818">818         <span class="php-keyword1">if</span> (!<span class="php-var">$parts</span> &amp;&amp; !<span class="php-var">$dropForeignKeys</span>) {
</span><span class="l" id="819">819             <span class="php-keyword1">return</span>;
</span><span class="l" id="820">820         }
</span><span class="l" id="821">821 
</span><span class="l" id="822">822         <span class="php-keyword1">foreach</span> ([<span class="php-var">$dropForeignKeys</span>, <span class="php-var">$parts</span>] <span class="php-keyword1">as</span> <span class="php-var">$stepParts</span>) {
</span><span class="l" id="823">823             <span class="php-keyword1">if</span> (<span class="php-var">$stepParts</span>) {
</span><span class="l" id="824">824                 <span class="php-var">$query</span> = <span class="php-quote">'ALTER TABLE '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;originalName).<span class="php-quote">"\n    "</span>;
</span><span class="l" id="825">825                 <span class="php-var">$query</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">",\n    "</span>, <span class="php-var">$stepParts</span>);
</span><span class="l" id="826">826                 <span class="php-var">$query</span> .= <span class="php-quote">';'</span>;
</span><span class="l" id="827">827 
</span><span class="l" id="828">828                 <span class="php-var">$this</span>-&gt;sql-&gt;setQuery(<span class="php-var">$query</span>);
</span><span class="l" id="829">829             }
</span><span class="l" id="830">830         }
</span><span class="l" id="831">831 
</span><span class="l" id="832">832         <span class="php-keyword1">foreach</span> (<span class="php-var">$fulltextIndexes</span> <span class="php-keyword1">as</span> <span class="php-var">$fulltextIndex</span>) {
</span><span class="l" id="833">833             <span class="php-var">$this</span>-&gt;sql-&gt;setQuery(<span class="php-quote">'ALTER TABLE '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;originalName).<span class="php-quote">' '</span>.<span class="php-var">$fulltextIndex</span>.<span class="php-quote">';'</span>);
</span><span class="l" id="834">834         }
</span><span class="l" id="835">835 
</span><span class="l" id="836">836         <span class="php-var">$this</span>-&gt;sortColumns();
</span><span class="l" id="837">837         <span class="php-var">$this</span>-&gt;resetModified();
</span><span class="l" id="838">838     }
</span><span class="l" id="839">839 
</span><span class="l" id="840">840     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> setPosition(<span class="php-var">$name</span>, <span class="php-var">$afterColumn</span>)
</span><span class="l" id="841">841     {
</span><span class="l" id="842">842         <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> === <span class="php-var">$afterColumn</span>) {
</span><span class="l" id="843">843             <span class="php-var">$this</span>-&gt;implicitOrder[] = <span class="php-var">$name</span>;
</span><span class="l" id="844">844 
</span><span class="l" id="845">845             <span class="php-keyword1">return</span>;
</span><span class="l" id="846">846         }
</span><span class="l" id="847">847 
</span><span class="l" id="848">848         <span class="php-keyword1">if</span> (self::FIRST !== <span class="php-var">$afterColumn</span> &amp;&amp; !<span class="php-var">$this</span>-&gt;hasColumn(<span class="php-var">$afterColumn</span>)) {
</span><span class="l" id="849">849             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Column "%s" can not be placed after "%s", because that column does not exist.'</span>, <span class="php-var">$name</span>, <span class="php-var">$afterColumn</span>));
</span><span class="l" id="850">850         }
</span><span class="l" id="851">851 
</span><span class="l" id="852">852         <span class="php-comment">// unset is necessary to add new position as last array element</span>
</span><span class="l" id="853">853         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>]);
</span><span class="l" id="854">854         <span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>] = <span class="php-var">$afterColumn</span>;
</span><span class="l" id="855">855     }
</span><span class="l" id="856">856 
</span><span class="l" id="857">857     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getColumnDefinition(rex_sql_column <span class="php-var">$column</span>)
</span><span class="l" id="858">858     {
</span><span class="l" id="859">859         <span class="php-keyword1">return</span> <span class="php-keyword2">sprintf</span>(
</span><span class="l" id="860">860             <span class="php-quote">'%s %s %s %s %s'</span>,
</span><span class="l" id="861">861             <span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$column</span>-&gt;getName()),
</span><span class="l" id="862">862             <span class="php-var">$column</span>-&gt;<span class="php-keyword2">getType</span>(),
</span><span class="l" id="863">863             <span class="php-var">$column</span>-&gt;getDefault() ? <span class="php-quote">'DEFAULT '</span>.<span class="php-var">$this</span>-&gt;sql-&gt;escape(<span class="php-var">$column</span>-&gt;getDefault()) : <span class="php-quote">''</span>,
</span><span class="l" id="864">864             <span class="php-var">$column</span>-&gt;isNullable() ? <span class="php-quote">''</span> : <span class="php-quote">'NOT NULL'</span>,
</span><span class="l" id="865">865             <span class="php-var">$column</span>-&gt;getExtra()
</span><span class="l" id="866">866         );
</span><span class="l" id="867">867     }
</span><span class="l" id="868">868 
</span><span class="l" id="869">869     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getIndexDefinition(rex_sql_index <span class="php-var">$index</span>)
</span><span class="l" id="870">870     {
</span><span class="l" id="871">871         <span class="php-keyword1">return</span> <span class="php-keyword2">sprintf</span>(
</span><span class="l" id="872">872             <span class="php-quote">'%s %s %s'</span>,
</span><span class="l" id="873">873             <span class="php-var">$index</span>-&gt;<span class="php-keyword2">getType</span>(),
</span><span class="l" id="874">874             <span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$index</span>-&gt;getName()),
</span><span class="l" id="875">875             <span class="php-var">$this</span>-&gt;getKeyColumnsDefintion(<span class="php-var">$index</span>-&gt;getColumns())
</span><span class="l" id="876">876         );
</span><span class="l" id="877">877     }
</span><span class="l" id="878">878 
</span><span class="l" id="879">879     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getForeignKeyDefinition(rex_sql_foreign_key <span class="php-var">$foreignKey</span>)
</span><span class="l" id="880">880     {
</span><span class="l" id="881">881         <span class="php-keyword1">return</span> <span class="php-keyword2">sprintf</span>(
</span><span class="l" id="882">882             <span class="php-quote">'CONSTRAINT %s FOREIGN KEY %s REFERENCES %s %s ON UPDATE %s ON DELETE %s'</span>,
</span><span class="l" id="883">883             <span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$foreignKey</span>-&gt;getName()),
</span><span class="l" id="884">884             <span class="php-var">$this</span>-&gt;getKeyColumnsDefintion(<span class="php-keyword2">array_keys</span>(<span class="php-var">$foreignKey</span>-&gt;getColumns())),
</span><span class="l" id="885">885             <span class="php-var">$this</span>-&gt;sql-&gt;escapeIdentifier(<span class="php-var">$foreignKey</span>-&gt;getTable()),
</span><span class="l" id="886">886             <span class="php-var">$this</span>-&gt;getKeyColumnsDefintion(<span class="php-var">$foreignKey</span>-&gt;getColumns()),
</span><span class="l" id="887">887             <span class="php-var">$foreignKey</span>-&gt;getOnUpdate(),
</span><span class="l" id="888">888             <span class="php-var">$foreignKey</span>-&gt;getOnDelete()
</span><span class="l" id="889">889         );
</span><span class="l" id="890">890     }
</span><span class="l" id="891">891 
</span><span class="l" id="892">892     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getKeyColumnsDefintion(<span class="php-keyword1">array</span> <span class="php-var">$columns</span>)
</span><span class="l" id="893">893     {
</span><span class="l" id="894">894         <span class="php-var">$columns</span> = <span class="php-keyword2">array_map</span>([<span class="php-var">$this</span>-&gt;sql, <span class="php-quote">'escapeIdentifier'</span>], <span class="php-var">$columns</span>);
</span><span class="l" id="895">895 
</span><span class="l" id="896">896         <span class="php-keyword1">return</span> <span class="php-quote">'('</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">', '</span>, <span class="php-var">$columns</span>).<span class="php-quote">')'</span>;
</span><span class="l" id="897">897     }
</span><span class="l" id="898">898 
</span><span class="l" id="899">899     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> sortColumns()
</span><span class="l" id="900">900     {
</span><span class="l" id="901">901         <span class="php-var">$columns</span> = [];
</span><span class="l" id="902">902 
</span><span class="l" id="903">903         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;columns <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$column</span>) {
</span><span class="l" id="904">904             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;positions[<span class="php-var">$name</span>])) {
</span><span class="l" id="905">905                 <span class="php-var">$columns</span>[<span class="php-var">$name</span>] = <span class="php-var">$column</span>;
</span><span class="l" id="906">906             }
</span><span class="l" id="907">907         }
</span><span class="l" id="908">908 
</span><span class="l" id="909">909         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;positions <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$after</span>) {
</span><span class="l" id="910">910             <span class="php-var">$insert</span> = [<span class="php-var">$name</span> =&gt; <span class="php-var">$this</span>-&gt;columns[<span class="php-var">$name</span>]];
</span><span class="l" id="911">911 
</span><span class="l" id="912">912             <span class="php-keyword1">if</span> (self::FIRST === <span class="php-var">$after</span>) {
</span><span class="l" id="913">913                 <span class="php-var">$columns</span> = <span class="php-var">$insert</span> + <span class="php-var">$columns</span>;
</span><span class="l" id="914">914 
</span><span class="l" id="915">915                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="916">916             }
</span><span class="l" id="917">917 
</span><span class="l" id="918">918             <span class="php-var">$offset</span> = <span class="php-keyword2">array_search</span>(<span class="php-var">$after</span>, <span class="php-keyword2">array_keys</span>(<span class="php-var">$columns</span>)) + <span class="php-num">1</span>;
</span><span class="l" id="919">919             <span class="php-var">$columns</span> = <span class="php-keyword2">array_slice</span>(<span class="php-var">$columns</span>, <span class="php-num">0</span>, <span class="php-var">$offset</span>) + <span class="php-var">$insert</span> + <span class="php-keyword2">array_slice</span>(<span class="php-var">$columns</span>, <span class="php-var">$offset</span>);
</span><span class="l" id="920">920         }
</span><span class="l" id="921">921 
</span><span class="l" id="922">922         <span class="php-var">$this</span>-&gt;columns = <span class="php-var">$columns</span>;
</span><span class="l" id="923">923     }
</span><span class="l" id="924">924 
</span><span class="l" id="925">925     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> resetModified()
</span><span class="l" id="926">926     {
</span><span class="l" id="927">927         <span class="php-var">$this</span>-&gt;<span class="php-keyword1">new</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="928">928 
</span><span class="l" id="929">929         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;originalName !== <span class="php-var">$this</span>-&gt;name) {
</span><span class="l" id="930">930             self::clearInstance(<span class="php-var">$this</span>-&gt;originalName);
</span><span class="l" id="931">931             self::addInstance(<span class="php-var">$this</span>-&gt;name, <span class="php-var">$this</span>);
</span><span class="l" id="932">932         }
</span><span class="l" id="933">933 
</span><span class="l" id="934">934         <span class="php-var">$this</span>-&gt;originalName = <span class="php-var">$this</span>-&gt;name;
</span><span class="l" id="935">935 
</span><span class="l" id="936">936         <span class="php-var">$columns</span> = <span class="php-var">$this</span>-&gt;columns;
</span><span class="l" id="937">937         <span class="php-var">$this</span>-&gt;columns = [];
</span><span class="l" id="938">938         <span class="php-var">$this</span>-&gt;columnsExisting = [];
</span><span class="l" id="939">939         <span class="php-keyword1">foreach</span> (<span class="php-var">$columns</span> <span class="php-keyword1">as</span> <span class="php-var">$column</span>) {
</span><span class="l" id="940">940             <span class="php-var">$column</span>-&gt;setModified(<span class="php-keyword1">false</span>);
</span><span class="l" id="941">941             <span class="php-var">$this</span>-&gt;columns[<span class="php-var">$column</span>-&gt;getName()] = <span class="php-var">$column</span>;
</span><span class="l" id="942">942             <span class="php-var">$this</span>-&gt;columnsExisting[<span class="php-var">$column</span>-&gt;getName()] = <span class="php-var">$column</span>-&gt;getName();
</span><span class="l" id="943">943         }
</span><span class="l" id="944">944 
</span><span class="l" id="945">945         <span class="php-var">$this</span>-&gt;implicitOrder = [];
</span><span class="l" id="946">946         <span class="php-var">$this</span>-&gt;positions = [];
</span><span class="l" id="947">947 
</span><span class="l" id="948">948         <span class="php-var">$this</span>-&gt;primaryKeyModified = <span class="php-keyword1">false</span>;
</span><span class="l" id="949">949 
</span><span class="l" id="950">950         <span class="php-var">$indexes</span> = <span class="php-var">$this</span>-&gt;indexes;
</span><span class="l" id="951">951         <span class="php-var">$this</span>-&gt;indexes = [];
</span><span class="l" id="952">952         <span class="php-var">$this</span>-&gt;indexesExisting = [];
</span><span class="l" id="953">953         <span class="php-keyword1">foreach</span> (<span class="php-var">$indexes</span> <span class="php-keyword1">as</span> <span class="php-var">$index</span>) {
</span><span class="l" id="954">954             <span class="php-var">$index</span>-&gt;setModified(<span class="php-keyword1">false</span>);
</span><span class="l" id="955">955             <span class="php-var">$this</span>-&gt;indexes[<span class="php-var">$index</span>-&gt;getName()] = <span class="php-var">$index</span>;
</span><span class="l" id="956">956             <span class="php-var">$this</span>-&gt;indexesExisting[<span class="php-var">$index</span>-&gt;getName()] = <span class="php-var">$index</span>-&gt;getName();
</span><span class="l" id="957">957         }
</span><span class="l" id="958">958 
</span><span class="l" id="959">959         <span class="php-var">$foreignKeys</span> = <span class="php-var">$this</span>-&gt;foreignKeys;
</span><span class="l" id="960">960         <span class="php-var">$this</span>-&gt;foreignKeys = [];
</span><span class="l" id="961">961         <span class="php-var">$this</span>-&gt;foreignKeysExisting = [];
</span><span class="l" id="962">962         <span class="php-keyword1">foreach</span> (<span class="php-var">$foreignKeys</span> <span class="php-keyword1">as</span> <span class="php-var">$foreignKey</span>) {
</span><span class="l" id="963">963             <span class="php-var">$foreignKey</span>-&gt;setModified(<span class="php-keyword1">false</span>);
</span><span class="l" id="964">964             <span class="php-var">$this</span>-&gt;foreignKeys[<span class="php-var">$foreignKey</span>-&gt;getName()] = <span class="php-var">$foreignKey</span>;
</span><span class="l" id="965">965             <span class="php-var">$this</span>-&gt;foreignKeysExisting[<span class="php-var">$foreignKey</span>-&gt;getName()] = <span class="php-var">$foreignKey</span>-&gt;getName();
</span><span class="l" id="966">966         }
</span><span class="l" id="967">967     }
</span><span class="l" id="968">968 }
</span><span class="l" id="969">969 </span></code></pre>
 </body>
</html>
