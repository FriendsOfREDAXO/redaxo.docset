<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * @package redaxo\structure
</span></span><span class="l" id="5">  5 <span class="php-comment"> */</span>
</span><span class="l" id="6">  6 <span class="php-keyword1">class</span> rex_article_service
</span><span class="l" id="7">  7 {
</span><span class="l" id="8">  8     <span class="php-comment">/**
</span></span><span class="l" id="9">  9 <span class="php-comment">     * Erstellt einen neuen Artikel.
</span></span><span class="l" id="10"> 10 <span class="php-comment">     *
</span></span><span class="l" id="11"> 11 <span class="php-comment">     * @param array $data Array mit den Daten des Artikels
</span></span><span class="l" id="12"> 12 <span class="php-comment">     *
</span></span><span class="l" id="13"> 13 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="14"> 14 <span class="php-comment">     *
</span></span><span class="l" id="15"> 15 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="16"> 16 <span class="php-comment">     */</span>
</span><span class="l" id="17"> 17     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> addArticle(<span class="php-var">$data</span>)
</span><span class="l" id="18"> 18     {
</span><span class="l" id="19"> 19         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$data</span>)) {
</span><span class="l" id="20"> 20             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-quote">'Expecting $data to be an array!'</span>);
</span><span class="l" id="21"> 21         }
</span><span class="l" id="22"> 22 
</span><span class="l" id="23"> 23         self::reqKey(<span class="php-var">$data</span>, <span class="php-quote">'category_id'</span>);
</span><span class="l" id="24"> 24         self::reqKey(<span class="php-var">$data</span>, <span class="php-quote">'priority'</span>);
</span><span class="l" id="25"> 25         self::reqKey(<span class="php-var">$data</span>, <span class="php-quote">'name'</span>);
</span><span class="l" id="26"> 26 
</span><span class="l" id="27"> 27         <span class="php-keyword1">if</span> (<span class="php-var">$data</span>[<span class="php-quote">'priority'</span>] &lt;= <span class="php-num">0</span>) {
</span><span class="l" id="28"> 28             <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>] = <span class="php-num">1</span>;
</span><span class="l" id="29"> 29         }
</span><span class="l" id="30"> 30 
</span><span class="l" id="31"> 31         <span class="php-comment">// parent may be null, when adding in the root cat</span>
</span><span class="l" id="32"> 32         <span class="php-var">$parent</span> = rex_category::get(<span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>]);
</span><span class="l" id="33"> 33         <span class="php-keyword1">if</span> (<span class="php-var">$parent</span>) {
</span><span class="l" id="34"> 34             <span class="php-var">$path</span> = <span class="php-var">$parent</span>-&gt;getPath();
</span><span class="l" id="35"> 35             <span class="php-var">$path</span> .= <span class="php-var">$parent</span>-&gt;getId() . <span class="php-quote">'|'</span>;
</span><span class="l" id="36"> 36         } <span class="php-keyword1">else</span> {
</span><span class="l" id="37"> 37             <span class="php-var">$path</span> = <span class="php-quote">'|'</span>;
</span><span class="l" id="38"> 38         }
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40         <span class="php-keyword1">if</span> (rex_plugin::get(<span class="php-quote">'structure'</span>, <span class="php-quote">'content'</span>)-&gt;isAvailable()) {
</span><span class="l" id="41"> 41             <span class="php-var">$templates</span> = rex_template::getTemplatesForCategory(<span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>]);
</span><span class="l" id="42"> 42 
</span><span class="l" id="43"> 43             <span class="php-comment">// Wenn Template nicht vorhanden, dann entweder erlaubtes nehmen</span>
</span><span class="l" id="44"> 44             <span class="php-comment">// oder leer setzen.</span>
</span><span class="l" id="45"> 45             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$templates</span>[<span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>]])) {
</span><span class="l" id="46"> 46                 <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>] = <span class="php-num">0</span>;
</span><span class="l" id="47"> 47                 <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="48"> 48                     <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>] = <span class="php-keyword2">key</span>(<span class="php-var">$templates</span>);
</span><span class="l" id="49"> 49                 }
</span><span class="l" id="50"> 50             }
</span><span class="l" id="51"> 51         }
</span><span class="l" id="52"> 52 
</span><span class="l" id="53"> 53         <span class="php-var">$message</span> = rex_i18n::msg(<span class="php-quote">'article_added'</span>);
</span><span class="l" id="54"> 54 
</span><span class="l" id="55"> 55         <span class="php-var">$AART</span> = rex_sql::factory();
</span><span class="l" id="56"> 56         <span class="php-keyword1">unset</span>(<span class="php-var">$id</span>);
</span><span class="l" id="57"> 57         <span class="php-var">$user</span> = self::getUser();
</span><span class="l" id="58"> 58         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$key</span>) {
</span><span class="l" id="59"> 59             <span class="php-comment">// ------- Kategorienamen holen</span>
</span><span class="l" id="60"> 60             <span class="php-var">$category</span> = rex_category::get(<span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>], <span class="php-var">$key</span>);
</span><span class="l" id="61"> 61 
</span><span class="l" id="62"> 62             <span class="php-var">$categoryName</span> = <span class="php-quote">''</span>;
</span><span class="l" id="63"> 63             <span class="php-keyword1">if</span> (<span class="php-var">$category</span>) {
</span><span class="l" id="64"> 64                 <span class="php-var">$categoryName</span> = <span class="php-var">$category</span>-&gt;getName();
</span><span class="l" id="65"> 65             }
</span><span class="l" id="66"> 66 
</span><span class="l" id="67"> 67             <span class="php-var">$AART</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="68"> 68             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$id</span>) || !<span class="php-var">$id</span>) {
</span><span class="l" id="69"> 69                 <span class="php-var">$id</span> = <span class="php-var">$AART</span>-&gt;setNewId(<span class="php-quote">'id'</span>);
</span><span class="l" id="70"> 70             } <span class="php-keyword1">else</span> {
</span><span class="l" id="71"> 71                 <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'id'</span>, <span class="php-var">$id</span>);
</span><span class="l" id="72"> 72             }
</span><span class="l" id="73"> 73             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'name'</span>, <span class="php-var">$data</span>[<span class="php-quote">'name'</span>]);
</span><span class="l" id="74"> 74             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'catname'</span>, <span class="php-var">$categoryName</span>);
</span><span class="l" id="75"> 75             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'clang_id'</span>, <span class="php-var">$key</span>);
</span><span class="l" id="76"> 76             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>]);
</span><span class="l" id="77"> 77             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>]);
</span><span class="l" id="78"> 78             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'path'</span>, <span class="php-var">$path</span>);
</span><span class="l" id="79"> 79             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'startarticle'</span>, <span class="php-num">0</span>);
</span><span class="l" id="80"> 80             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'status'</span>, <span class="php-num">0</span>);
</span><span class="l" id="81"> 81             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'template_id'</span>, <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>]);
</span><span class="l" id="82"> 82             <span class="php-var">$AART</span>-&gt;addGlobalCreateFields(<span class="php-var">$user</span>);
</span><span class="l" id="83"> 83             <span class="php-var">$AART</span>-&gt;addGlobalUpdateFields(<span class="php-var">$user</span>);
</span><span class="l" id="84"> 84 
</span><span class="l" id="85"> 85             <span class="php-keyword1">try</span> {
</span><span class="l" id="86"> 86                 <span class="php-var">$AART</span>-&gt;insert();
</span><span class="l" id="87"> 87                 <span class="php-comment">// ----- PRIOR</span>
</span><span class="l" id="88"> 88                 self::newArtPrio(<span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>], <span class="php-var">$key</span>, <span class="php-num">0</span>, <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>]);
</span><span class="l" id="89"> 89             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="90"> 90                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-var">$e</span>);
</span><span class="l" id="91"> 91             }
</span><span class="l" id="92"> 92 
</span><span class="l" id="93"> 93             rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$id</span>, <span class="php-var">$key</span>);
</span><span class="l" id="94"> 94 
</span><span class="l" id="95"> 95             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="96"> 96             <span class="php-var">$message</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_ADDED'</span>, <span class="php-var">$message</span>, [
</span><span class="l" id="97"> 97                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>,
</span><span class="l" id="98"> 98                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$key</span>,
</span><span class="l" id="99"> 99                 <span class="php-quote">'status'</span> =&gt; <span class="php-num">0</span>,
</span><span class="l" id="100">100                 <span class="php-quote">'name'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'name'</span>],
</span><span class="l" id="101">101                 <span class="php-quote">'parent_id'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>],
</span><span class="l" id="102">102                 <span class="php-quote">'priority'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>],
</span><span class="l" id="103">103                 <span class="php-quote">'path'</span> =&gt; <span class="php-var">$path</span>,
</span><span class="l" id="104">104                 <span class="php-quote">'template_id'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>],
</span><span class="l" id="105">105                 <span class="php-quote">'data'</span> =&gt; <span class="php-var">$data</span>,
</span><span class="l" id="106">106             ]));
</span><span class="l" id="107">107         }
</span><span class="l" id="108">108 
</span><span class="l" id="109">109         <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
</span><span class="l" id="110">110     }
</span><span class="l" id="111">111 
</span><span class="l" id="112">112     <span class="php-comment">/**
</span></span><span class="l" id="113">113 <span class="php-comment">     * Bearbeitet einen Artikel.
</span></span><span class="l" id="114">114 <span class="php-comment">     *
</span></span><span class="l" id="115">115 <span class="php-comment">     * @param int   $article_id Id des Artikels der verändert werden soll
</span></span><span class="l" id="116">116 <span class="php-comment">     * @param int   $clang      Id der Sprache
</span></span><span class="l" id="117">117 <span class="php-comment">     * @param array $data       Array mit den Daten des Artikels
</span></span><span class="l" id="118">118 <span class="php-comment">     *
</span></span><span class="l" id="119">119 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="120">120 <span class="php-comment">     *
</span></span><span class="l" id="121">121 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="122">122 <span class="php-comment">     */</span>
</span><span class="l" id="123">123     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> editArticle(<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>, <span class="php-var">$data</span>)
</span><span class="l" id="124">124     {
</span><span class="l" id="125">125         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$data</span>)) {
</span><span class="l" id="126">126             <span class="php-keyword1">throw</span>  <span class="php-keyword1">new</span> rex_api_exception(<span class="php-quote">'Expecting $data to be an array!'</span>);
</span><span class="l" id="127">127         }
</span><span class="l" id="128">128 
</span><span class="l" id="129">129         self::reqKey(<span class="php-var">$data</span>, <span class="php-quote">'name'</span>);
</span><span class="l" id="130">130 
</span><span class="l" id="131">131         <span class="php-comment">// Artikel mit alten Daten selektieren</span>
</span><span class="l" id="132">132         <span class="php-var">$thisArt</span> = rex_sql::factory();
</span><span class="l" id="133">133         <span class="php-var">$thisArt</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and clang_id=?'</span>, [<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="134">134 
</span><span class="l" id="135">135         <span class="php-keyword1">if</span> (<span class="php-var">$thisArt</span>-&gt;getRows() != <span class="php-num">1</span>) {
</span><span class="l" id="136">136             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-quote">'Unable to find article with id "'</span> . <span class="php-var">$article_id</span> . <span class="php-quote">'" and clang "'</span> . <span class="php-var">$clang</span> . <span class="php-quote">'"!'</span>);
</span><span class="l" id="137">137         }
</span><span class="l" id="138">138 
</span><span class="l" id="139">139         <span class="php-var">$ooArt</span> = rex_article::get(<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>);
</span><span class="l" id="140">140         <span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>] = <span class="php-var">$ooArt</span>-&gt;getCategoryId();
</span><span class="l" id="141">141 
</span><span class="l" id="142">142         <span class="php-keyword1">if</span> (rex_plugin::get(<span class="php-quote">'structure'</span>, <span class="php-quote">'content'</span>)-&gt;isAvailable()) {
</span><span class="l" id="143">143             <span class="php-var">$templates</span> = rex_template::getTemplatesForCategory(<span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>]);
</span><span class="l" id="144">144 
</span><span class="l" id="145">145             <span class="php-comment">// Wenn Template nicht vorhanden, dann entweder erlaubtes nehmen</span>
</span><span class="l" id="146">146             <span class="php-comment">// oder leer setzen.</span>
</span><span class="l" id="147">147             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$templates</span>[<span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>]])) {
</span><span class="l" id="148">148                 <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>] = <span class="php-num">0</span>;
</span><span class="l" id="149">149                 <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="150">150                     <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>] = <span class="php-keyword2">key</span>(<span class="php-var">$templates</span>);
</span><span class="l" id="151">151                 }
</span><span class="l" id="152">152             }
</span><span class="l" id="153">153         }
</span><span class="l" id="154">154 
</span><span class="l" id="155">155         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'priority'</span>])) {
</span><span class="l" id="156">156             <span class="php-keyword1">if</span> (<span class="php-var">$data</span>[<span class="php-quote">'priority'</span>] &lt;= <span class="php-num">0</span>) {
</span><span class="l" id="157">157                 <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>] = <span class="php-num">1</span>;
</span><span class="l" id="158">158             }
</span><span class="l" id="159">159         }
</span><span class="l" id="160">160 
</span><span class="l" id="161">161         <span class="php-comment">// complete remaining optional aprams</span>
</span><span class="l" id="162">162         <span class="php-keyword1">foreach</span> ([<span class="php-quote">'path'</span>, <span class="php-quote">'priority'</span>] <span class="php-keyword1">as</span> <span class="php-var">$optionalData</span>) {
</span><span class="l" id="163">163             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-var">$optionalData</span>])) {
</span><span class="l" id="164">164                 <span class="php-var">$data</span>[<span class="php-var">$optionalData</span>] = <span class="php-var">$thisArt</span>-&gt;getValue(<span class="php-var">$optionalData</span>);
</span><span class="l" id="165">165             }
</span><span class="l" id="166">166         }
</span><span class="l" id="167">167 
</span><span class="l" id="168">168         <span class="php-var">$EA</span> = rex_sql::factory();
</span><span class="l" id="169">169         <span class="php-var">$EA</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="170">170         <span class="php-var">$EA</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$article_id</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="171">171         <span class="php-var">$EA</span>-&gt;setValue(<span class="php-quote">'name'</span>, <span class="php-var">$data</span>[<span class="php-quote">'name'</span>]);
</span><span class="l" id="172">172         <span class="php-var">$EA</span>-&gt;setValue(<span class="php-quote">'template_id'</span>, <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>]);
</span><span class="l" id="173">173         <span class="php-var">$EA</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>]);
</span><span class="l" id="174">174         <span class="php-var">$EA</span>-&gt;addGlobalUpdateFields(self::getUser());
</span><span class="l" id="175">175 
</span><span class="l" id="176">176         <span class="php-keyword1">try</span> {
</span><span class="l" id="177">177             <span class="php-var">$EA</span>-&gt;update();
</span><span class="l" id="178">178             <span class="php-var">$message</span> = rex_i18n::msg(<span class="php-quote">'article_updated'</span>);
</span><span class="l" id="179">179 
</span><span class="l" id="180">180             <span class="php-comment">// ----- PRIOR</span>
</span><span class="l" id="181">181             rex_sql::factory()
</span><span class="l" id="182">182                 -&gt;setTable(rex::getTable(<span class="php-quote">'article'</span>))
</span><span class="l" id="183">183                 -&gt;setWhere(<span class="php-quote">'id = :id AND clang_id != :clang'</span>, [<span class="php-quote">'id'</span> =&gt; <span class="php-var">$article_id</span>, <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>])
</span><span class="l" id="184">184                 -&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>])
</span><span class="l" id="185">185                 -&gt;addGlobalUpdateFields(self::getUser())
</span><span class="l" id="186">186                 -&gt;update();
</span><span class="l" id="187">187 
</span><span class="l" id="188">188             <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clangId</span>) {
</span><span class="l" id="189">189                 self::newArtPrio(<span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>], <span class="php-var">$clangId</span>, <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>], <span class="php-var">$thisArt</span>-&gt;getValue(<span class="php-quote">'priority'</span>));
</span><span class="l" id="190">190             }
</span><span class="l" id="191">191             rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$article_id</span>);
</span><span class="l" id="192">192 
</span><span class="l" id="193">193             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="194">194             <span class="php-var">$message</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_UPDATED'</span>, <span class="php-var">$message</span>, [
</span><span class="l" id="195">195                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$article_id</span>,
</span><span class="l" id="196">196                 <span class="php-quote">'article'</span> =&gt; <span class="php-keyword1">clone</span> <span class="php-var">$EA</span>,
</span><span class="l" id="197">197                 <span class="php-quote">'article_old'</span> =&gt; <span class="php-keyword1">clone</span> <span class="php-var">$thisArt</span>,
</span><span class="l" id="198">198                 <span class="php-quote">'status'</span> =&gt; <span class="php-var">$thisArt</span>-&gt;getValue(<span class="php-quote">'status'</span>),
</span><span class="l" id="199">199                 <span class="php-quote">'name'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'name'</span>],
</span><span class="l" id="200">200                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="201">201                 <span class="php-quote">'parent_id'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'category_id'</span>],
</span><span class="l" id="202">202                 <span class="php-quote">'priority'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'priority'</span>],
</span><span class="l" id="203">203                 <span class="php-quote">'path'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'path'</span>],
</span><span class="l" id="204">204                 <span class="php-quote">'template_id'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'template_id'</span>],
</span><span class="l" id="205">205                 <span class="php-quote">'data'</span> =&gt; <span class="php-var">$data</span>,
</span><span class="l" id="206">206             ]));
</span><span class="l" id="207">207         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="208">208             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-var">$e</span>);
</span><span class="l" id="209">209         }
</span><span class="l" id="210">210 
</span><span class="l" id="211">211         <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
</span><span class="l" id="212">212     }
</span><span class="l" id="213">213 
</span><span class="l" id="214">214     <span class="php-comment">/**
</span></span><span class="l" id="215">215 <span class="php-comment">     * Löscht einen Artikel und reorganisiert die Prioritäten verbleibender Geschwister-Artikel.
</span></span><span class="l" id="216">216 <span class="php-comment">     *
</span></span><span class="l" id="217">217 <span class="php-comment">     * @param int $article_id Id des Artikels die gelöscht werden soll
</span></span><span class="l" id="218">218 <span class="php-comment">     *
</span></span><span class="l" id="219">219 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="220">220 <span class="php-comment">     *
</span></span><span class="l" id="221">221 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="222">222 <span class="php-comment">     */</span>
</span><span class="l" id="223">223     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> deleteArticle(<span class="php-var">$article_id</span>)
</span><span class="l" id="224">224     {
</span><span class="l" id="225">225         <span class="php-var">$Art</span> = rex_sql::factory();
</span><span class="l" id="226">226         <span class="php-var">$Art</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=0'</span>, [<span class="php-var">$article_id</span>]);
</span><span class="l" id="227">227 
</span><span class="l" id="228">228         <span class="php-keyword1">if</span> (<span class="php-var">$Art</span>-&gt;getRows() &gt; <span class="php-num">0</span>) {
</span><span class="l" id="229">229             <span class="php-var">$message</span> = self::_deleteArticle(<span class="php-var">$article_id</span>);
</span><span class="l" id="230">230             <span class="php-var">$parent_id</span> = <span class="php-var">$Art</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="231">231 
</span><span class="l" id="232">232             <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="233">233                 <span class="php-comment">// ----- PRIOR</span>
</span><span class="l" id="234">234                 self::newArtPrio(<span class="php-var">$Art</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>), <span class="php-var">$clang</span>, <span class="php-num">0</span>, <span class="php-num">1</span>);
</span><span class="l" id="235">235 
</span><span class="l" id="236">236                 <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="237">237                 <span class="php-var">$message</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_DELETED'</span>, <span class="php-var">$message</span>, [
</span><span class="l" id="238">238                     <span class="php-quote">'id'</span> =&gt; <span class="php-var">$article_id</span>,
</span><span class="l" id="239">239                     <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="240">240                     <span class="php-quote">'parent_id'</span> =&gt; <span class="php-var">$parent_id</span>,
</span><span class="l" id="241">241                     <span class="php-quote">'name'</span> =&gt; <span class="php-var">$Art</span>-&gt;getValue(<span class="php-quote">'name'</span>),
</span><span class="l" id="242">242                     <span class="php-quote">'status'</span> =&gt; <span class="php-var">$Art</span>-&gt;getValue(<span class="php-quote">'status'</span>),
</span><span class="l" id="243">243                     <span class="php-quote">'priority'</span> =&gt; <span class="php-var">$Art</span>-&gt;getValue(<span class="php-quote">'priority'</span>),
</span><span class="l" id="244">244                     <span class="php-quote">'path'</span> =&gt; <span class="php-var">$Art</span>-&gt;getValue(<span class="php-quote">'path'</span>),
</span><span class="l" id="245">245                     <span class="php-quote">'template_id'</span> =&gt; <span class="php-var">$Art</span>-&gt;getValue(<span class="php-quote">'template_id'</span>),
</span><span class="l" id="246">246                 ]));
</span><span class="l" id="247">247 
</span><span class="l" id="248">248                 <span class="php-var">$Art</span>-&gt;<span class="php-keyword2">next</span>();
</span><span class="l" id="249">249             }
</span><span class="l" id="250">250         } <span class="php-keyword1">else</span> {
</span><span class="l" id="251">251             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'article_doesnt_exist'</span>));
</span><span class="l" id="252">252         }
</span><span class="l" id="253">253 
</span><span class="l" id="254">254         <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
</span><span class="l" id="255">255     }
</span><span class="l" id="256">256 
</span><span class="l" id="257">257     <span class="php-comment">/**
</span></span><span class="l" id="258">258 <span class="php-comment">     * Löscht einen Artikel.
</span></span><span class="l" id="259">259 <span class="php-comment">     *
</span></span><span class="l" id="260">260 <span class="php-comment">     * @param int $id ArtikelId des Artikels, der gelöscht werden soll
</span></span><span class="l" id="261">261 <span class="php-comment">     *
</span></span><span class="l" id="262">262 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="263">263 <span class="php-comment">     *
</span></span><span class="l" id="264">264 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="265">265 <span class="php-comment">     */</span>
</span><span class="l" id="266">266     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> _deleteArticle(<span class="php-var">$id</span>)
</span><span class="l" id="267">267     {
</span><span class="l" id="268">268         <span class="php-comment">// artikel loeschen</span>
</span><span class="l" id="269">269 
</span><span class="l" id="270">270         <span class="php-comment">// kontrolle ob erlaubnis nicht hier.. muss vorher geschehen</span>
</span><span class="l" id="271">271 
</span><span class="l" id="272">272         <span class="php-comment">// -&gt; startarticle = 0</span>
</span><span class="l" id="273">273         <span class="php-comment">// --&gt; artikelfiles löschen</span>
</span><span class="l" id="274">274         <span class="php-comment">// ---&gt; article</span>
</span><span class="l" id="275">275         <span class="php-comment">// ---&gt; content</span>
</span><span class="l" id="276">276         <span class="php-comment">// ---&gt; clist</span>
</span><span class="l" id="277">277         <span class="php-comment">// ---&gt; alist</span>
</span><span class="l" id="278">278         <span class="php-comment">// -&gt; startarticle = 1</span>
</span><span class="l" id="279">279         <span class="php-comment">// --&gt; rekursiv aufrufen</span>
</span><span class="l" id="280">280 
</span><span class="l" id="281">281         <span class="php-keyword1">if</span> (<span class="php-var">$id</span> == rex_article::getSiteStartArticleId()) {
</span><span class="l" id="282">282             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'cant_delete_sitestartarticle'</span>));
</span><span class="l" id="283">283         }
</span><span class="l" id="284">284         <span class="php-keyword1">if</span> (<span class="php-var">$id</span> == rex_article::getNotfoundArticleId()) {
</span><span class="l" id="285">285             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'cant_delete_notfoundarticle'</span>));
</span><span class="l" id="286">286         }
</span><span class="l" id="287">287 
</span><span class="l" id="288">288         <span class="php-var">$ART</span> = rex_sql::factory();
</span><span class="l" id="289">289         <span class="php-var">$ART</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and clang_id=?'</span>, [<span class="php-var">$id</span>, rex_clang::getStartId()]);
</span><span class="l" id="290">290 
</span><span class="l" id="291">291         <span class="php-var">$message</span> = <span class="php-quote">''</span>;
</span><span class="l" id="292">292         <span class="php-keyword1">if</span> (<span class="php-var">$ART</span>-&gt;getRows() &gt; <span class="php-num">0</span>) {
</span><span class="l" id="293">293             <span class="php-var">$parent_id</span> = <span class="php-var">$ART</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="294">294             <span class="php-var">$message</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_PRE_DELETED'</span>, <span class="php-var">$message</span>, [
</span><span class="l" id="295">295                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>,
</span><span class="l" id="296">296                 <span class="php-quote">'parent_id'</span> =&gt; <span class="php-var">$parent_id</span>,
</span><span class="l" id="297">297                 <span class="php-quote">'name'</span> =&gt; <span class="php-var">$ART</span>-&gt;getValue(<span class="php-quote">'name'</span>),
</span><span class="l" id="298">298                 <span class="php-quote">'status'</span> =&gt; <span class="php-var">$ART</span>-&gt;getValue(<span class="php-quote">'status'</span>),
</span><span class="l" id="299">299                 <span class="php-quote">'priority'</span> =&gt; <span class="php-var">$ART</span>-&gt;getValue(<span class="php-quote">'priority'</span>),
</span><span class="l" id="300">300                 <span class="php-quote">'path'</span> =&gt; <span class="php-var">$ART</span>-&gt;getValue(<span class="php-quote">'path'</span>),
</span><span class="l" id="301">301                 <span class="php-quote">'template_id'</span> =&gt; <span class="php-var">$ART</span>-&gt;getValue(<span class="php-quote">'template_id'</span>),
</span><span class="l" id="302">302             ]));
</span><span class="l" id="303">303 
</span><span class="l" id="304">304             <span class="php-keyword1">if</span> (<span class="php-var">$ART</span>-&gt;getValue(<span class="php-quote">'startarticle'</span>) == <span class="php-num">1</span>) {
</span><span class="l" id="305">305                 <span class="php-var">$message</span> = rex_i18n::msg(<span class="php-quote">'category_deleted'</span>);
</span><span class="l" id="306">306                 <span class="php-var">$SART</span> = rex_sql::factory();
</span><span class="l" id="307">307                 <span class="php-var">$SART</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where parent_id=? and clang_id=?'</span>, [<span class="php-var">$id</span>, rex_clang::getStartId()]);
</span><span class="l" id="308">308                 <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$SART</span>-&gt;getRows(); ++<span class="php-var">$i</span>) {
</span><span class="l" id="309">309                     self::_deleteArticle(<span class="php-var">$id</span>);
</span><span class="l" id="310">310                     <span class="php-var">$SART</span>-&gt;<span class="php-keyword2">next</span>();
</span><span class="l" id="311">311                 }
</span><span class="l" id="312">312             } <span class="php-keyword1">else</span> {
</span><span class="l" id="313">313                 <span class="php-var">$message</span> = rex_i18n::msg(<span class="php-quote">'article_deleted'</span>);
</span><span class="l" id="314">314             }
</span><span class="l" id="315">315 
</span><span class="l" id="316">316             rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$id</span>);
</span><span class="l" id="317">317             <span class="php-var">$ART</span>-&gt;setQuery(<span class="php-quote">'delete from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=?'</span>, [<span class="php-var">$id</span>]);
</span><span class="l" id="318">318             <span class="php-var">$ART</span>-&gt;setQuery(<span class="php-quote">'delete from '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice where article_id=?'</span>, [<span class="php-var">$id</span>]);
</span><span class="l" id="319">319 
</span><span class="l" id="320">320             <span class="php-comment">// --------------------------------------------------- Listen generieren</span>
</span><span class="l" id="321">321             rex_article_cache::deleteLists(<span class="php-var">$parent_id</span>);
</span><span class="l" id="322">322 
</span><span class="l" id="323">323             <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
</span><span class="l" id="324">324         }
</span><span class="l" id="325">325         <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'category_doesnt_exist'</span>));
</span><span class="l" id="326">326     }
</span><span class="l" id="327">327 
</span><span class="l" id="328">328     <span class="php-comment">/**
</span></span><span class="l" id="329">329 <span class="php-comment">     * Ändert den Status des Artikels.
</span></span><span class="l" id="330">330 <span class="php-comment">     *
</span></span><span class="l" id="331">331 <span class="php-comment">     * @param int      $article_id Id des Artikels die gelöscht werden soll
</span></span><span class="l" id="332">332 <span class="php-comment">     * @param int      $clang      Id der Sprache
</span></span><span class="l" id="333">333 <span class="php-comment">     * @param int|null $status     Status auf den der Artikel gesetzt werden soll, oder NULL wenn zum nächsten Status weitergeschaltet werden soll
</span></span><span class="l" id="334">334 <span class="php-comment">     *
</span></span><span class="l" id="335">335 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="336">336 <span class="php-comment">     *
</span></span><span class="l" id="337">337 <span class="php-comment">     * @return int Der neue Status des Artikels
</span></span><span class="l" id="338">338 <span class="php-comment">     */</span>
</span><span class="l" id="339">339     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> articleStatus(<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>, <span class="php-var">$status</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="340">340     {
</span><span class="l" id="341">341         <span class="php-var">$GA</span> = rex_sql::factory();
</span><span class="l" id="342">342         <span class="php-var">$GA</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and clang_id=?'</span>, [<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="343">343         <span class="php-keyword1">if</span> (<span class="php-var">$GA</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="344">344             <span class="php-comment">// Status wurde nicht von außen vorgegeben,</span>
</span><span class="l" id="345">345             <span class="php-comment">// =&gt; zyklisch auf den nächsten Weiterschalten</span>
</span><span class="l" id="346">346             <span class="php-keyword1">if</span> (!<span class="php-var">$status</span>) {
</span><span class="l" id="347">347                 <span class="php-var">$newstatus</span> = self::nextStatus(<span class="php-var">$GA</span>-&gt;getValue(<span class="php-quote">'status'</span>));
</span><span class="l" id="348">348             } <span class="php-keyword1">else</span> {
</span><span class="l" id="349">349                 <span class="php-var">$newstatus</span> = <span class="php-var">$status</span>;
</span><span class="l" id="350">350             }
</span><span class="l" id="351">351 
</span><span class="l" id="352">352             <span class="php-var">$EA</span> = rex_sql::factory();
</span><span class="l" id="353">353             <span class="php-var">$EA</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="354">354             <span class="php-var">$EA</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$article_id</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="355">355             <span class="php-var">$EA</span>-&gt;setValue(<span class="php-quote">'status'</span>, <span class="php-var">$newstatus</span>);
</span><span class="l" id="356">356             <span class="php-var">$EA</span>-&gt;addGlobalUpdateFields(self::getUser());
</span><span class="l" id="357">357 
</span><span class="l" id="358">358             <span class="php-keyword1">try</span> {
</span><span class="l" id="359">359                 <span class="php-var">$EA</span>-&gt;update();
</span><span class="l" id="360">360 
</span><span class="l" id="361">361                 rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>);
</span><span class="l" id="362">362 
</span><span class="l" id="363">363                 <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="364">364                 rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_STATUS'</span>, <span class="php-keyword1">null</span>, [
</span><span class="l" id="365">365                     <span class="php-quote">'id'</span> =&gt; <span class="php-var">$article_id</span>,
</span><span class="l" id="366">366                     <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="367">367                     <span class="php-quote">'status'</span> =&gt; <span class="php-var">$newstatus</span>,
</span><span class="l" id="368">368                 ]));
</span><span class="l" id="369">369             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="370">370                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-var">$e</span>);
</span><span class="l" id="371">371             }
</span><span class="l" id="372">372         } <span class="php-keyword1">else</span> {
</span><span class="l" id="373">373             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'no_such_category'</span>));
</span><span class="l" id="374">374         }
</span><span class="l" id="375">375 
</span><span class="l" id="376">376         <span class="php-keyword1">return</span> <span class="php-var">$newstatus</span>;
</span><span class="l" id="377">377     }
</span><span class="l" id="378">378 
</span><span class="l" id="379">379     <span class="php-comment">/**
</span></span><span class="l" id="380">380 <span class="php-comment">     * Gibt alle Stati zurück, die für einen Artikel gültig sind.
</span></span><span class="l" id="381">381 <span class="php-comment">     *
</span></span><span class="l" id="382">382 <span class="php-comment">     * @return array Array von Stati
</span></span><span class="l" id="383">383 <span class="php-comment">     */</span>
</span><span class="l" id="384">384     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> statusTypes()
</span><span class="l" id="385">385     {
</span><span class="l" id="386">386         <span class="php-keyword1">static</span> <span class="php-var">$artStatusTypes</span>;
</span><span class="l" id="387">387 
</span><span class="l" id="388">388         <span class="php-keyword1">if</span> (!<span class="php-var">$artStatusTypes</span>) {
</span><span class="l" id="389">389             <span class="php-var">$artStatusTypes</span> = [
</span><span class="l" id="390">390                 <span class="php-comment">// Name, CSS-Class</span>
</span><span class="l" id="391">391                 [rex_i18n::msg(<span class="php-quote">'status_offline'</span>), <span class="php-quote">'rex-offline'</span>, <span class="php-quote">'rex-icon-offline'</span>],
</span><span class="l" id="392">392                 [rex_i18n::msg(<span class="php-quote">'status_online'</span>), <span class="php-quote">'rex-online'</span>, <span class="php-quote">'rex-icon-online'</span>],
</span><span class="l" id="393">393             ];
</span><span class="l" id="394">394 
</span><span class="l" id="395">395             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="396">396             <span class="php-var">$artStatusTypes</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_STATUS_TYPES'</span>, <span class="php-var">$artStatusTypes</span>));
</span><span class="l" id="397">397         }
</span><span class="l" id="398">398 
</span><span class="l" id="399">399         <span class="php-keyword1">return</span> <span class="php-var">$artStatusTypes</span>;
</span><span class="l" id="400">400     }
</span><span class="l" id="401">401 
</span><span class="l" id="402">402     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> nextStatus(<span class="php-var">$currentStatus</span>)
</span><span class="l" id="403">403     {
</span><span class="l" id="404">404         <span class="php-var">$artStatusTypes</span> = self::statusTypes();
</span><span class="l" id="405">405         <span class="php-keyword1">return</span> (<span class="php-var">$currentStatus</span> + <span class="php-num">1</span>) % <span class="php-keyword2">count</span>(<span class="php-var">$artStatusTypes</span>);
</span><span class="l" id="406">406     }
</span><span class="l" id="407">407 
</span><span class="l" id="408">408     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> prevStatus(<span class="php-var">$currentStatus</span>)
</span><span class="l" id="409">409     {
</span><span class="l" id="410">410         <span class="php-var">$artStatusTypes</span> = self::statusTypes();
</span><span class="l" id="411">411         <span class="php-keyword1">if</span> ((<span class="php-var">$currentStatus</span> - <span class="php-num">1</span>) &lt; <span class="php-num">0</span>) {
</span><span class="l" id="412">412             <span class="php-keyword1">return</span> <span class="php-keyword2">count</span>(<span class="php-var">$artStatusTypes</span>) - <span class="php-num">1</span>;
</span><span class="l" id="413">413         }
</span><span class="l" id="414">414 
</span><span class="l" id="415">415         <span class="php-keyword1">return</span> (<span class="php-var">$currentStatus</span> - <span class="php-num">1</span>) % <span class="php-keyword2">count</span>(<span class="php-var">$artStatusTypes</span>);
</span><span class="l" id="416">416     }
</span><span class="l" id="417">417 
</span><span class="l" id="418">418     <span class="php-comment">/**
</span></span><span class="l" id="419">419 <span class="php-comment">     * Berechnet die Prios der Artikel in einer Kategorie neu.
</span></span><span class="l" id="420">420 <span class="php-comment">     *
</span></span><span class="l" id="421">421 <span class="php-comment">     * @param int $parent_id KategorieId der Kategorie, die erneuert werden soll
</span></span><span class="l" id="422">422 <span class="php-comment">     * @param int $clang     ClangId der Kategorie, die erneuert werden soll
</span></span><span class="l" id="423">423 <span class="php-comment">     * @param int $new_prio  Neue PrioNr der Kategorie
</span></span><span class="l" id="424">424 <span class="php-comment">     * @param int $old_prio  Alte PrioNr der Kategorie
</span></span><span class="l" id="425">425 <span class="php-comment">     */</span>
</span><span class="l" id="426">426     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> newArtPrio(<span class="php-var">$parent_id</span>, <span class="php-var">$clang</span>, <span class="php-var">$new_prio</span>, <span class="php-var">$old_prio</span>)
</span><span class="l" id="427">427     {
</span><span class="l" id="428">428         <span class="php-keyword1">if</span> (<span class="php-var">$new_prio</span> != <span class="php-var">$old_prio</span>) {
</span><span class="l" id="429">429             <span class="php-keyword1">if</span> (<span class="php-var">$new_prio</span> &lt; <span class="php-var">$old_prio</span>) {
</span><span class="l" id="430">430                 <span class="php-var">$addsql</span> = <span class="php-quote">'desc'</span>;
</span><span class="l" id="431">431             } <span class="php-keyword1">else</span> {
</span><span class="l" id="432">432                 <span class="php-var">$addsql</span> = <span class="php-quote">'asc'</span>;
</span><span class="l" id="433">433             }
</span><span class="l" id="434">434 
</span><span class="l" id="435">435             rex_sql_util::organizePriorities(
</span><span class="l" id="436">436                 rex::getTable(<span class="php-quote">'article'</span>),
</span><span class="l" id="437">437                 <span class="php-quote">'priority'</span>,
</span><span class="l" id="438">438                 <span class="php-quote">'clang_id='</span> . (int) <span class="php-var">$clang</span> . <span class="php-quote">' AND ((startarticle&lt;&gt;1 AND parent_id='</span> . (int) <span class="php-var">$parent_id</span> . <span class="php-quote">') OR (startarticle=1 AND id='</span> . (int) <span class="php-var">$parent_id</span> . <span class="php-quote">'))'</span>,
</span><span class="l" id="439">439                 <span class="php-quote">'priority,updatedate '</span> . <span class="php-var">$addsql</span>
</span><span class="l" id="440">440             );
</span><span class="l" id="441">441 
</span><span class="l" id="442">442             rex_article_cache::deleteLists(<span class="php-var">$parent_id</span>);
</span><span class="l" id="443">443         }
</span><span class="l" id="444">444     }
</span><span class="l" id="445">445 
</span><span class="l" id="446">446     <span class="php-comment">/**
</span></span><span class="l" id="447">447 <span class="php-comment">     * Konvertiert einen Artikel in eine Kategorie.
</span></span><span class="l" id="448">448 <span class="php-comment">     *
</span></span><span class="l" id="449">449 <span class="php-comment">     * @param int $art_id Artikel ID des Artikels, der in eine Kategorie umgewandelt werden soll
</span></span><span class="l" id="450">450 <span class="php-comment">     *
</span></span><span class="l" id="451">451 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="452">452 <span class="php-comment">     */</span>
</span><span class="l" id="453">453     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> article2category(<span class="php-var">$art_id</span>)
</span><span class="l" id="454">454     {
</span><span class="l" id="455">455         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="456">456 
</span><span class="l" id="457">457         <span class="php-comment">// LANG SCHLEIFE</span>
</span><span class="l" id="458">458         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="459">459             <span class="php-comment">// artikel</span>
</span><span class="l" id="460">460             <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'select parent_id, name from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=0 and clang_id=?'</span>, [<span class="php-var">$art_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="461">461 
</span><span class="l" id="462">462             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$parent_id</span>)) {
</span><span class="l" id="463">463                 <span class="php-var">$parent_id</span> = <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="464">464             }
</span><span class="l" id="465">465 
</span><span class="l" id="466">466             <span class="php-comment">// artikel updaten</span>
</span><span class="l" id="467">467             <span class="php-var">$sql</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="468">468             <span class="php-var">$sql</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$art_id</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="469">469             <span class="php-var">$sql</span>-&gt;setValue(<span class="php-quote">'startarticle'</span>, <span class="php-num">1</span>);
</span><span class="l" id="470">470             <span class="php-var">$sql</span>-&gt;setValue(<span class="php-quote">'catname'</span>, <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'name'</span>));
</span><span class="l" id="471">471             <span class="php-var">$sql</span>-&gt;setValue(<span class="php-quote">'catpriority'</span>, <span class="php-num">100</span>);
</span><span class="l" id="472">472             <span class="php-var">$sql</span>-&gt;update();
</span><span class="l" id="473">473 
</span><span class="l" id="474">474             rex_category_service::newCatPrio(<span class="php-var">$parent_id</span>, <span class="php-var">$clang</span>, <span class="php-num">0</span>, <span class="php-num">100</span>);
</span><span class="l" id="475">475         }
</span><span class="l" id="476">476 
</span><span class="l" id="477">477         rex_article_cache::deleteLists(<span class="php-var">$parent_id</span>);
</span><span class="l" id="478">478         rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$art_id</span>);
</span><span class="l" id="479">479 
</span><span class="l" id="480">480         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="481">481             rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_TO_CAT'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="482">482                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$art_id</span>,
</span><span class="l" id="483">483                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="484">484             ]));
</span><span class="l" id="485">485         }
</span><span class="l" id="486">486 
</span><span class="l" id="487">487         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="488">488     }
</span><span class="l" id="489">489 
</span><span class="l" id="490">490     <span class="php-comment">/**
</span></span><span class="l" id="491">491 <span class="php-comment">     * Konvertiert eine Kategorie in einen Artikel.
</span></span><span class="l" id="492">492 <span class="php-comment">     *
</span></span><span class="l" id="493">493 <span class="php-comment">     * @param int $art_id Artikel ID der Kategorie, die in einen Artikel umgewandelt werden soll
</span></span><span class="l" id="494">494 <span class="php-comment">     *
</span></span><span class="l" id="495">495 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="496">496 <span class="php-comment">     */</span>
</span><span class="l" id="497">497     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> category2article(<span class="php-var">$art_id</span>)
</span><span class="l" id="498">498     {
</span><span class="l" id="499">499         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="500">500 
</span><span class="l" id="501">501         <span class="php-comment">// Kategorie muss leer sein</span>
</span><span class="l" id="502">502         <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SELECT pid FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article WHERE parent_id=? LIMIT 1'</span>, [<span class="php-var">$art_id</span>]);
</span><span class="l" id="503">503         <span class="php-keyword1">if</span> (<span class="php-var">$sql</span>-&gt;getRows() != <span class="php-num">0</span>) {
</span><span class="l" id="504">504             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="505">505         }
</span><span class="l" id="506">506 
</span><span class="l" id="507">507         <span class="php-comment">// LANG SCHLEIFE</span>
</span><span class="l" id="508">508         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="509">509             <span class="php-comment">// artikel</span>
</span><span class="l" id="510">510             <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'select parent_id, name from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=1 and clang_id=?'</span>, [<span class="php-var">$art_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="511">511 
</span><span class="l" id="512">512             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$parent_id</span>)) {
</span><span class="l" id="513">513                 <span class="php-var">$parent_id</span> = <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="514">514             }
</span><span class="l" id="515">515 
</span><span class="l" id="516">516             <span class="php-comment">// artikel updaten</span>
</span><span class="l" id="517">517             <span class="php-var">$sql</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="518">518             <span class="php-var">$sql</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$art_id</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="519">519             <span class="php-var">$sql</span>-&gt;setValue(<span class="php-quote">'startarticle'</span>, <span class="php-num">0</span>);
</span><span class="l" id="520">520             <span class="php-var">$sql</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-num">100</span>);
</span><span class="l" id="521">521             <span class="php-var">$sql</span>-&gt;update();
</span><span class="l" id="522">522 
</span><span class="l" id="523">523             self::newArtPrio(<span class="php-var">$parent_id</span>, <span class="php-var">$clang</span>, <span class="php-num">0</span>, <span class="php-num">100</span>);
</span><span class="l" id="524">524         }
</span><span class="l" id="525">525 
</span><span class="l" id="526">526         rex_article_cache::deleteLists(<span class="php-var">$parent_id</span>);
</span><span class="l" id="527">527         rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$art_id</span>);
</span><span class="l" id="528">528 
</span><span class="l" id="529">529         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="530">530             rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'CAT_TO_ART'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="531">531                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$art_id</span>,
</span><span class="l" id="532">532                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="533">533             ]));
</span><span class="l" id="534">534         }
</span><span class="l" id="535">535 
</span><span class="l" id="536">536         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="537">537     }
</span><span class="l" id="538">538 
</span><span class="l" id="539">539     <span class="php-comment">/**
</span></span><span class="l" id="540">540 <span class="php-comment">     * Konvertiert einen Artikel zum Startartikel der eigenen Kategorie.
</span></span><span class="l" id="541">541 <span class="php-comment">     *
</span></span><span class="l" id="542">542 <span class="php-comment">     * @param int $neu_id Artikel ID des Artikels, der Startartikel werden soll
</span></span><span class="l" id="543">543 <span class="php-comment">     *
</span></span><span class="l" id="544">544 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="545">545 <span class="php-comment">     */</span>
</span><span class="l" id="546">546     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> article2startarticle(<span class="php-var">$neu_id</span>)
</span><span class="l" id="547">547     {
</span><span class="l" id="548">548         <span class="php-var">$GAID</span> = [];
</span><span class="l" id="549">549 
</span><span class="l" id="550">550         <span class="php-comment">// neuen startartikel holen und schauen ob da</span>
</span><span class="l" id="551">551         <span class="php-var">$neu</span> = rex_sql::factory();
</span><span class="l" id="552">552         <span class="php-var">$neu</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=0 and clang_id=?'</span>, [<span class="php-var">$neu_id</span>, rex_clang::getStartId()]);
</span><span class="l" id="553">553         <span class="php-keyword1">if</span> (<span class="php-var">$neu</span>-&gt;getRows() != <span class="php-num">1</span>) {
</span><span class="l" id="554">554             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="555">555         }
</span><span class="l" id="556">556         <span class="php-var">$neu_cat_id</span> = <span class="php-var">$neu</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="557">557 
</span><span class="l" id="558">558         <span class="php-comment">// in oberster kategorie dann return</span>
</span><span class="l" id="559">559         <span class="php-keyword1">if</span> (<span class="php-var">$neu_cat_id</span> == <span class="php-num">0</span>) {
</span><span class="l" id="560">560             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="561">561         }
</span><span class="l" id="562">562 
</span><span class="l" id="563">563         <span class="php-comment">// alten startartikel</span>
</span><span class="l" id="564">564         <span class="php-var">$alt</span> = rex_sql::factory();
</span><span class="l" id="565">565         <span class="php-var">$alt</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=1 and clang_id=?'</span>, [<span class="php-var">$neu_cat_id</span>, rex_clang::getStartId()]);
</span><span class="l" id="566">566         <span class="php-keyword1">if</span> (<span class="php-var">$alt</span>-&gt;getRows() != <span class="php-num">1</span>) {
</span><span class="l" id="567">567             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="568">568         }
</span><span class="l" id="569">569         <span class="php-var">$alt_id</span> = <span class="php-var">$alt</span>-&gt;getValue(<span class="php-quote">'id'</span>);
</span><span class="l" id="570">570         <span class="php-var">$parent_id</span> = <span class="php-var">$alt</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="571">571 
</span><span class="l" id="572">572         <span class="php-comment">// cat felder sammeln. +</span>
</span><span class="l" id="573">573         <span class="php-var">$params</span> = [<span class="php-quote">'path'</span>, <span class="php-quote">'priority'</span>, <span class="php-quote">'catname'</span>, <span class="php-quote">'startarticle'</span>, <span class="php-quote">'catpriority'</span>, <span class="php-quote">'status'</span>];
</span><span class="l" id="574">574         <span class="php-var">$db_fields</span> = rex_structure_element::getClassVars();
</span><span class="l" id="575">575         <span class="php-keyword1">foreach</span> (<span class="php-var">$db_fields</span> <span class="php-keyword1">as</span> <span class="php-var">$field</span>) {
</span><span class="l" id="576">576             <span class="php-keyword1">if</span> (<span class="php-keyword2">substr</span>(<span class="php-var">$field</span>, <span class="php-num">0</span>, <span class="php-num">4</span>) == <span class="php-quote">'cat_'</span>) {
</span><span class="l" id="577">577                 <span class="php-var">$params</span>[] = <span class="php-var">$field</span>;
</span><span class="l" id="578">578             }
</span><span class="l" id="579">579         }
</span><span class="l" id="580">580 
</span><span class="l" id="581">581         <span class="php-comment">// LANG SCHLEIFE</span>
</span><span class="l" id="582">582         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="583">583             <span class="php-comment">// alter startartikel</span>
</span><span class="l" id="584">584             <span class="php-var">$alt</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=1 and clang_id=?'</span>, [<span class="php-var">$neu_cat_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="585">585 
</span><span class="l" id="586">586             <span class="php-comment">// neuer startartikel</span>
</span><span class="l" id="587">587             <span class="php-var">$neu</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=0 and clang_id=?'</span>, [<span class="php-var">$neu_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="588">588 
</span><span class="l" id="589">589             <span class="php-comment">// alter startartikel updaten</span>
</span><span class="l" id="590">590             <span class="php-var">$alt2</span> = rex_sql::factory();
</span><span class="l" id="591">591             <span class="php-var">$alt2</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="592">592             <span class="php-var">$alt2</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$alt_id</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="593">593             <span class="php-var">$alt2</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$neu_id</span>);
</span><span class="l" id="594">594 
</span><span class="l" id="595">595             <span class="php-comment">// neuer startartikel updaten</span>
</span><span class="l" id="596">596             <span class="php-var">$neu2</span> = rex_sql::factory();
</span><span class="l" id="597">597             <span class="php-var">$neu2</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="598">598             <span class="php-var">$neu2</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$neu_id</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="599">599             <span class="php-var">$neu2</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$alt</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>));
</span><span class="l" id="600">600 
</span><span class="l" id="601">601             <span class="php-comment">// austauschen der definierten paramater</span>
</span><span class="l" id="602">602             <span class="php-keyword1">foreach</span> (<span class="php-var">$params</span> <span class="php-keyword1">as</span> <span class="php-var">$param</span>) {
</span><span class="l" id="603">603                 <span class="php-var">$alt2</span>-&gt;setValue(<span class="php-var">$param</span>, <span class="php-var">$neu</span>-&gt;getValue(<span class="php-var">$param</span>));
</span><span class="l" id="604">604                 <span class="php-var">$neu2</span>-&gt;setValue(<span class="php-var">$param</span>, <span class="php-var">$alt</span>-&gt;getValue(<span class="php-var">$param</span>));
</span><span class="l" id="605">605             }
</span><span class="l" id="606">606             <span class="php-var">$alt2</span>-&gt;update();
</span><span class="l" id="607">607             <span class="php-var">$neu2</span>-&gt;update();
</span><span class="l" id="608">608         }
</span><span class="l" id="609">609 
</span><span class="l" id="610">610         <span class="php-comment">// alle artikel suchen nach |art_id| und pfade ersetzen</span>
</span><span class="l" id="611">611         <span class="php-comment">// alles artikel mit parent_id alt_id suchen und ersetzen</span>
</span><span class="l" id="612">612 
</span><span class="l" id="613">613         <span class="php-var">$articles</span> = rex_sql::factory();
</span><span class="l" id="614">614         <span class="php-var">$ia</span> = rex_sql::factory();
</span><span class="l" id="615">615         <span class="php-var">$articles</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">"article where path like '%|</span><span class="php-var">$alt_id</span><span class="php-quote">|%'"</span>);
</span><span class="l" id="616">616         <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$articles</span>-&gt;getRows(); ++<span class="php-var">$i</span>) {
</span><span class="l" id="617">617             <span class="php-var">$iid</span> = <span class="php-var">$articles</span>-&gt;getValue(<span class="php-quote">'id'</span>);
</span><span class="l" id="618">618             <span class="php-var">$ipath</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">"|</span><span class="php-var">$alt_id</span><span class="php-quote">|"</span>, <span class="php-quote">"|</span><span class="php-var">$neu_id</span><span class="php-quote">|"</span>, <span class="php-var">$articles</span>-&gt;getValue(<span class="php-quote">'path'</span>));
</span><span class="l" id="619">619 
</span><span class="l" id="620">620             <span class="php-var">$ia</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="621">621             <span class="php-var">$ia</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$iid</span>]);
</span><span class="l" id="622">622             <span class="php-var">$ia</span>-&gt;setValue(<span class="php-quote">'path'</span>, <span class="php-var">$ipath</span>);
</span><span class="l" id="623">623             <span class="php-keyword1">if</span> (<span class="php-var">$articles</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>) == <span class="php-var">$alt_id</span>) {
</span><span class="l" id="624">624                 <span class="php-var">$ia</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$neu_id</span>);
</span><span class="l" id="625">625             }
</span><span class="l" id="626">626             <span class="php-var">$ia</span>-&gt;update();
</span><span class="l" id="627">627             <span class="php-var">$GAID</span>[<span class="php-var">$iid</span>] = <span class="php-var">$iid</span>;
</span><span class="l" id="628">628             <span class="php-var">$articles</span>-&gt;<span class="php-keyword2">next</span>();
</span><span class="l" id="629">629         }
</span><span class="l" id="630">630 
</span><span class="l" id="631">631         <span class="php-var">$GAID</span>[<span class="php-var">$neu_id</span>] = <span class="php-var">$neu_id</span>;
</span><span class="l" id="632">632         <span class="php-var">$GAID</span>[<span class="php-var">$alt_id</span>] = <span class="php-var">$alt_id</span>;
</span><span class="l" id="633">633         <span class="php-var">$GAID</span>[<span class="php-var">$parent_id</span>] = <span class="php-var">$parent_id</span>;
</span><span class="l" id="634">634 
</span><span class="l" id="635">635         <span class="php-keyword1">foreach</span> (<span class="php-var">$GAID</span> <span class="php-keyword1">as</span> <span class="php-var">$gid</span>) {
</span><span class="l" id="636">636             rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$gid</span>);
</span><span class="l" id="637">637         }
</span><span class="l" id="638">638 
</span><span class="l" id="639">639         rex_complex_perm::replaceItem(<span class="php-quote">'structure'</span>, <span class="php-var">$alt_id</span>, <span class="php-var">$neu_id</span>);
</span><span class="l" id="640">640 
</span><span class="l" id="641">641         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="642">642             rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_TO_STARTARTICLE'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="643">643                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$neu_id</span>,
</span><span class="l" id="644">644                 <span class="php-quote">'id_old'</span> =&gt; <span class="php-var">$alt_id</span>,
</span><span class="l" id="645">645                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="646">646             ]));
</span><span class="l" id="647">647         }
</span><span class="l" id="648">648 
</span><span class="l" id="649">649         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="650">650     }
</span><span class="l" id="651">651 
</span><span class="l" id="652">652     <span class="php-comment">/**
</span></span><span class="l" id="653">653 <span class="php-comment">     * Kopiert die Metadaten eines Artikels in einen anderen Artikel.
</span></span><span class="l" id="654">654 <span class="php-comment">     *
</span></span><span class="l" id="655">655 <span class="php-comment">     * @param int   $from_id    ArtikelId des Artikels, aus dem kopiert werden (Quell ArtikelId)
</span></span><span class="l" id="656">656 <span class="php-comment">     * @param int   $to_id      ArtikelId des Artikel, in den kopiert werden sollen (Ziel ArtikelId)
</span></span><span class="l" id="657">657 <span class="php-comment">     * @param int   $from_clang ClangId des Artikels, aus dem kopiert werden soll (Quell ClangId)
</span></span><span class="l" id="658">658 <span class="php-comment">     * @param int   $to_clang   ClangId des Artikels, in den kopiert werden soll (Ziel ClangId)
</span></span><span class="l" id="659">659 <span class="php-comment">     * @param array $params     Array von Spaltennamen, welche kopiert werden sollen
</span></span><span class="l" id="660">660 <span class="php-comment">     *
</span></span><span class="l" id="661">661 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="662">662 <span class="php-comment">     */</span>
</span><span class="l" id="663">663     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> copyMeta(<span class="php-var">$from_id</span>, <span class="php-var">$to_id</span>, <span class="php-var">$from_clang</span> = <span class="php-num">1</span>, <span class="php-var">$to_clang</span> = <span class="php-num">1</span>, <span class="php-var">$params</span> = [])
</span><span class="l" id="664">664     {
</span><span class="l" id="665">665         <span class="php-var">$from_clang</span> = (int) <span class="php-var">$from_clang</span>;
</span><span class="l" id="666">666         <span class="php-var">$to_clang</span> = (int) <span class="php-var">$to_clang</span>;
</span><span class="l" id="667">667         <span class="php-var">$from_id</span> = (int) <span class="php-var">$from_id</span>;
</span><span class="l" id="668">668         <span class="php-var">$to_id</span> = (int) <span class="php-var">$to_id</span>;
</span><span class="l" id="669">669         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$params</span>)) {
</span><span class="l" id="670">670             <span class="php-var">$params</span> = [];
</span><span class="l" id="671">671         }
</span><span class="l" id="672">672 
</span><span class="l" id="673">673         <span class="php-keyword1">if</span> (<span class="php-var">$from_id</span> == <span class="php-var">$to_id</span> &amp;&amp; <span class="php-var">$from_clang</span> == <span class="php-var">$to_clang</span>) {
</span><span class="l" id="674">674             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="675">675         }
</span><span class="l" id="676">676 
</span><span class="l" id="677">677         <span class="php-var">$gc</span> = rex_sql::factory();
</span><span class="l" id="678">678         <span class="php-var">$gc</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where clang_id=? and id=?'</span>, [<span class="php-var">$from_clang</span>, <span class="php-var">$from_id</span>]);
</span><span class="l" id="679">679 
</span><span class="l" id="680">680         <span class="php-keyword1">if</span> (<span class="php-var">$gc</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="681">681             <span class="php-var">$uc</span> = rex_sql::factory();
</span><span class="l" id="682">682             <span class="php-comment">// $uc-&gt;setDebug();</span>
</span><span class="l" id="683">683             <span class="php-var">$uc</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="684">684             <span class="php-var">$uc</span>-&gt;setWhere([<span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$to_clang</span>, <span class="php-quote">'id'</span> =&gt; <span class="php-var">$to_id</span>]);
</span><span class="l" id="685">685             <span class="php-var">$uc</span>-&gt;addGlobalUpdateFields(self::getUser());
</span><span class="l" id="686">686 
</span><span class="l" id="687">687             <span class="php-keyword1">foreach</span> (<span class="php-var">$params</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="688">688                 <span class="php-var">$uc</span>-&gt;setValue(<span class="php-var">$value</span>, <span class="php-var">$gc</span>-&gt;getValue(<span class="php-var">$value</span>));
</span><span class="l" id="689">689             }
</span><span class="l" id="690">690 
</span><span class="l" id="691">691             <span class="php-var">$uc</span>-&gt;update();
</span><span class="l" id="692">692 
</span><span class="l" id="693">693             rex_article_cache::deleteMeta(<span class="php-var">$to_id</span>, <span class="php-var">$to_clang</span>);
</span><span class="l" id="694">694             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="695">695         }
</span><span class="l" id="696">696         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="697">697     }
</span><span class="l" id="698">698 
</span><span class="l" id="699">699     <span class="php-comment">/**
</span></span><span class="l" id="700">700 <span class="php-comment">     * Kopieren eines Artikels von einer Kategorie in eine andere.
</span></span><span class="l" id="701">701 <span class="php-comment">     *
</span></span><span class="l" id="702">702 <span class="php-comment">     * @param int $id        ArtikelId des zu kopierenden Artikels
</span></span><span class="l" id="703">703 <span class="php-comment">     * @param int $to_cat_id KategorieId in die der Artikel kopiert werden soll
</span></span><span class="l" id="704">704 <span class="php-comment">     *
</span></span><span class="l" id="705">705 <span class="php-comment">     * @return bool FALSE bei Fehler, sonst die Artikel Id des neue kopierten Artikels
</span></span><span class="l" id="706">706 <span class="php-comment">     */</span>
</span><span class="l" id="707">707     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> copyArticle(<span class="php-var">$id</span>, <span class="php-var">$to_cat_id</span>)
</span><span class="l" id="708">708     {
</span><span class="l" id="709">709         <span class="php-var">$id</span> = (int) <span class="php-var">$id</span>;
</span><span class="l" id="710">710         <span class="php-var">$to_cat_id</span> = (int) <span class="php-var">$to_cat_id</span>;
</span><span class="l" id="711">711         <span class="php-var">$new_id</span> = <span class="php-quote">''</span>;
</span><span class="l" id="712">712 
</span><span class="l" id="713">713         <span class="php-var">$user</span> = self::getUser();
</span><span class="l" id="714">714 
</span><span class="l" id="715">715         <span class="php-comment">// Artikel in jeder Sprache kopieren</span>
</span><span class="l" id="716">716         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="717">717             <span class="php-comment">// validierung der id &amp; from_cat_id</span>
</span><span class="l" id="718">718             <span class="php-var">$from_sql</span> = rex_sql::factory();
</span><span class="l" id="719">719             <span class="php-var">$from_sql</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where clang_id=? and id=?'</span>, [<span class="php-var">$clang</span>, <span class="php-var">$id</span>]);
</span><span class="l" id="720">720 
</span><span class="l" id="721">721             <span class="php-keyword1">if</span> (<span class="php-var">$from_sql</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="722">722                 <span class="php-comment">// validierung der to_cat_id</span>
</span><span class="l" id="723">723                 <span class="php-var">$to_sql</span> = rex_sql::factory();
</span><span class="l" id="724">724                 <span class="php-var">$to_sql</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where clang_id=? and startarticle=1 and id=?'</span>, [<span class="php-var">$clang</span>, <span class="php-var">$to_cat_id</span>]);
</span><span class="l" id="725">725 
</span><span class="l" id="726">726                 <span class="php-keyword1">if</span> (<span class="php-var">$to_sql</span>-&gt;getRows() == <span class="php-num">1</span> || <span class="php-var">$to_cat_id</span> == <span class="php-num">0</span>) {
</span><span class="l" id="727">727                     <span class="php-keyword1">if</span> (<span class="php-var">$to_sql</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="728">728                         <span class="php-var">$path</span> = <span class="php-var">$to_sql</span>-&gt;getValue(<span class="php-quote">'path'</span>) . <span class="php-var">$to_sql</span>-&gt;getValue(<span class="php-quote">'id'</span>) . <span class="php-quote">'|'</span>;
</span><span class="l" id="729">729                         <span class="php-var">$catname</span> = <span class="php-var">$to_sql</span>-&gt;getValue(<span class="php-quote">'catname'</span>);
</span><span class="l" id="730">730                     } <span class="php-keyword1">else</span> {
</span><span class="l" id="731">731                         <span class="php-comment">// In RootEbene</span>
</span><span class="l" id="732">732                         <span class="php-var">$path</span> = <span class="php-quote">'|'</span>;
</span><span class="l" id="733">733                         <span class="php-var">$catname</span> = <span class="php-var">$from_sql</span>-&gt;getValue(<span class="php-quote">'name'</span>);
</span><span class="l" id="734">734                     }
</span><span class="l" id="735">735 
</span><span class="l" id="736">736                     <span class="php-var">$art_sql</span> = rex_sql::factory();
</span><span class="l" id="737">737                     <span class="php-var">$art_sql</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="738">738                     <span class="php-keyword1">if</span> (<span class="php-var">$new_id</span> == <span class="php-quote">''</span>) {
</span><span class="l" id="739">739                         <span class="php-var">$new_id</span> = <span class="php-var">$art_sql</span>-&gt;setNewId(<span class="php-quote">'id'</span>);
</span><span class="l" id="740">740                     }
</span><span class="l" id="741">741                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'id'</span>, <span class="php-var">$new_id</span>); <span class="php-comment">// neuen auto_incrment erzwingen</span>
</span><span class="l" id="742">742                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$to_cat_id</span>);
</span><span class="l" id="743">743                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'catname'</span>, <span class="php-var">$catname</span>);
</span><span class="l" id="744">744                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'catpriority'</span>, <span class="php-num">0</span>);
</span><span class="l" id="745">745                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'path'</span>, <span class="php-var">$path</span>);
</span><span class="l" id="746">746                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'name'</span>, <span class="php-var">$from_sql</span>-&gt;getValue(<span class="php-quote">'name'</span>) . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'structure_copy'</span>));
</span><span class="l" id="747">747                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-num">99999</span>); <span class="php-comment">// Artikel als letzten Artikel in die neue Kat einfügen</span>
</span><span class="l" id="748">748                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'status'</span>, <span class="php-num">0</span>); <span class="php-comment">// Kopierter Artikel offline setzen</span>
</span><span class="l" id="749">749                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'startarticle'</span>, <span class="php-num">0</span>);
</span><span class="l" id="750">750                     <span class="php-var">$art_sql</span>-&gt;addGlobalUpdateFields(<span class="php-var">$user</span>);
</span><span class="l" id="751">751                     <span class="php-var">$art_sql</span>-&gt;addGlobalCreateFields(<span class="php-var">$user</span>);
</span><span class="l" id="752">752 
</span><span class="l" id="753">753                     <span class="php-comment">// schon gesetzte Felder nicht wieder überschreiben</span>
</span><span class="l" id="754">754                     <span class="php-var">$dont_copy</span> = [<span class="php-quote">'id'</span>, <span class="php-quote">'pid'</span>, <span class="php-quote">'parent_id'</span>, <span class="php-quote">'catname'</span>, <span class="php-quote">'name'</span>, <span class="php-quote">'catpriority'</span>, <span class="php-quote">'path'</span>, <span class="php-quote">'priority'</span>, <span class="php-quote">'status'</span>, <span class="php-quote">'updatedate'</span>, <span class="php-quote">'updateuser'</span>, <span class="php-quote">'createdate'</span>, <span class="php-quote">'createuser'</span>, <span class="php-quote">'startarticle'</span>];
</span><span class="l" id="755">755 
</span><span class="l" id="756">756                     <span class="php-keyword1">foreach</span> (<span class="php-keyword2">array_diff</span>(<span class="php-var">$from_sql</span>-&gt;getFieldnames(), <span class="php-var">$dont_copy</span>) <span class="php-keyword1">as</span> <span class="php-var">$fld_name</span>) {
</span><span class="l" id="757">757                         <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-var">$fld_name</span>, <span class="php-var">$from_sql</span>-&gt;getValue(<span class="php-var">$fld_name</span>));
</span><span class="l" id="758">758                     }
</span><span class="l" id="759">759 
</span><span class="l" id="760">760                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'clang_id'</span>, <span class="php-var">$clang</span>);
</span><span class="l" id="761">761                     <span class="php-var">$art_sql</span>-&gt;insert();
</span><span class="l" id="762">762 
</span><span class="l" id="763">763                     <span class="php-var">$revisions</span> = rex_sql::factory();
</span><span class="l" id="764">764                     <span class="php-var">$revisions</span>-&gt;setQuery(<span class="php-quote">'select revision from '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice where priority=1 AND article_id=? AND clang_id=? GROUP BY revision'</span>, [<span class="php-var">$id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="765">765                     <span class="php-keyword1">foreach</span> (<span class="php-var">$revisions</span> <span class="php-keyword1">as</span> <span class="php-var">$rev</span>) {
</span><span class="l" id="766">766                         <span class="php-comment">// FIXME this dependency is very ugly!</span>
</span><span class="l" id="767">767                         <span class="php-comment">// ArticleSlices kopieren</span>
</span><span class="l" id="768">768                         rex_content_service::copyContent(<span class="php-var">$id</span>, <span class="php-var">$new_id</span>, <span class="php-var">$clang</span>, <span class="php-var">$clang</span>, <span class="php-var">$rev</span>-&gt;getValue(<span class="php-quote">'revision'</span>));
</span><span class="l" id="769">769                     }
</span><span class="l" id="770">770 
</span><span class="l" id="771">771                     <span class="php-comment">// Prios neu berechnen</span>
</span><span class="l" id="772">772                     self::newArtPrio(<span class="php-var">$to_cat_id</span>, <span class="php-var">$clang</span>, <span class="php-num">1</span>, <span class="php-num">0</span>);
</span><span class="l" id="773">773 
</span><span class="l" id="774">774                     rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_COPIED'</span>, <span class="php-keyword1">null</span>, [
</span><span class="l" id="775">775                         <span class="php-quote">'id_source'</span> =&gt; <span class="php-var">$id</span>,
</span><span class="l" id="776">776                         <span class="php-quote">'id'</span> =&gt; <span class="php-var">$new_id</span>,
</span><span class="l" id="777">777                         <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="778">778                         <span class="php-quote">'category_id'</span> =&gt; <span class="php-var">$to_cat_id</span>,
</span><span class="l" id="779">779                     ]));
</span><span class="l" id="780">780                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="781">781                     <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="782">782                 }
</span><span class="l" id="783">783             } <span class="php-keyword1">else</span> {
</span><span class="l" id="784">784                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="785">785             }
</span><span class="l" id="786">786         }
</span><span class="l" id="787">787 
</span><span class="l" id="788">788         <span class="php-comment">// Caches des Artikels löschen, in allen Sprachen</span>
</span><span class="l" id="789">789         rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$id</span>);
</span><span class="l" id="790">790 
</span><span class="l" id="791">791         <span class="php-comment">// Caches der Kategorien löschen, da sich derin befindliche Artikel geändert haben</span>
</span><span class="l" id="792">792         rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$to_cat_id</span>);
</span><span class="l" id="793">793 
</span><span class="l" id="794">794         <span class="php-keyword1">return</span> <span class="php-var">$new_id</span>;
</span><span class="l" id="795">795     }
</span><span class="l" id="796">796 
</span><span class="l" id="797">797     <span class="php-comment">/**
</span></span><span class="l" id="798">798 <span class="php-comment">     * Verschieben eines Artikels von einer Kategorie in eine Andere.
</span></span><span class="l" id="799">799 <span class="php-comment">     *
</span></span><span class="l" id="800">800 <span class="php-comment">     * @param int $id          ArtikelId des zu verschiebenden Artikels
</span></span><span class="l" id="801">801 <span class="php-comment">     * @param int $from_cat_id KategorieId des Artikels, der Verschoben wird
</span></span><span class="l" id="802">802 <span class="php-comment">     * @param int $to_cat_id   KategorieId in die der Artikel verschoben werden soll
</span></span><span class="l" id="803">803 <span class="php-comment">     *
</span></span><span class="l" id="804">804 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="805">805 <span class="php-comment">     */</span>
</span><span class="l" id="806">806     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> moveArticle(<span class="php-var">$id</span>, <span class="php-var">$from_cat_id</span>, <span class="php-var">$to_cat_id</span>)
</span><span class="l" id="807">807     {
</span><span class="l" id="808">808         <span class="php-var">$id</span> = (int) <span class="php-var">$id</span>;
</span><span class="l" id="809">809         <span class="php-var">$to_cat_id</span> = (int) <span class="php-var">$to_cat_id</span>;
</span><span class="l" id="810">810         <span class="php-var">$from_cat_id</span> = (int) <span class="php-var">$from_cat_id</span>;
</span><span class="l" id="811">811 
</span><span class="l" id="812">812         <span class="php-keyword1">if</span> (<span class="php-var">$from_cat_id</span> == <span class="php-var">$to_cat_id</span>) {
</span><span class="l" id="813">813             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="814">814         }
</span><span class="l" id="815">815 
</span><span class="l" id="816">816         <span class="php-comment">// Artikel in jeder Sprache verschieben</span>
</span><span class="l" id="817">817         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="818">818             <span class="php-comment">// validierung der id &amp; from_cat_id</span>
</span><span class="l" id="819">819             <span class="php-var">$from_sql</span> = rex_sql::factory();
</span><span class="l" id="820">820             <span class="php-var">$from_sql</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where clang_id=? and startarticle&lt;&gt;1 and id=? and parent_id=?'</span>, [<span class="php-var">$clang</span>, <span class="php-var">$id</span>, <span class="php-var">$from_cat_id</span>]);
</span><span class="l" id="821">821 
</span><span class="l" id="822">822             <span class="php-keyword1">if</span> (<span class="php-var">$from_sql</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="823">823                 <span class="php-comment">// validierung der to_cat_id</span>
</span><span class="l" id="824">824                 <span class="php-var">$to_sql</span> = rex_sql::factory();
</span><span class="l" id="825">825                 <span class="php-var">$to_sql</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where clang_id=? and startarticle=1 and id=?'</span>, [<span class="php-var">$clang</span>, <span class="php-var">$to_cat_id</span>]);
</span><span class="l" id="826">826 
</span><span class="l" id="827">827                 <span class="php-keyword1">if</span> (<span class="php-var">$to_sql</span>-&gt;getRows() == <span class="php-num">1</span> || <span class="php-var">$to_cat_id</span> == <span class="php-num">0</span>) {
</span><span class="l" id="828">828                     <span class="php-keyword1">if</span> (<span class="php-var">$to_sql</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="829">829                         <span class="php-var">$parent_id</span> = <span class="php-var">$to_sql</span>-&gt;getValue(<span class="php-quote">'id'</span>);
</span><span class="l" id="830">830                         <span class="php-var">$path</span> = <span class="php-var">$to_sql</span>-&gt;getValue(<span class="php-quote">'path'</span>) . <span class="php-var">$to_sql</span>-&gt;getValue(<span class="php-quote">'id'</span>) . <span class="php-quote">'|'</span>;
</span><span class="l" id="831">831                         <span class="php-var">$catname</span> = <span class="php-var">$to_sql</span>-&gt;getValue(<span class="php-quote">'catname'</span>);
</span><span class="l" id="832">832                     } <span class="php-keyword1">else</span> {
</span><span class="l" id="833">833                         <span class="php-comment">// In RootEbene</span>
</span><span class="l" id="834">834                         <span class="php-var">$parent_id</span> = <span class="php-num">0</span>;
</span><span class="l" id="835">835                         <span class="php-var">$path</span> = <span class="php-quote">'|'</span>;
</span><span class="l" id="836">836                         <span class="php-var">$catname</span> = <span class="php-var">$from_sql</span>-&gt;getValue(<span class="php-quote">'name'</span>);
</span><span class="l" id="837">837                     }
</span><span class="l" id="838">838 
</span><span class="l" id="839">839                     <span class="php-var">$art_sql</span> = rex_sql::factory();
</span><span class="l" id="840">840                     <span class="php-comment">//$art_sql-&gt;setDebug();</span>
</span><span class="l" id="841">841 
</span><span class="l" id="842">842                     <span class="php-var">$art_sql</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="843">843                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$parent_id</span>);
</span><span class="l" id="844">844                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'path'</span>, <span class="php-var">$path</span>);
</span><span class="l" id="845">845                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'catname'</span>, <span class="php-var">$catname</span>);
</span><span class="l" id="846">846                     <span class="php-comment">// Artikel als letzten Artikel in die neue Kat einfügen</span>
</span><span class="l" id="847">847                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-quote">'99999'</span>);
</span><span class="l" id="848">848                     <span class="php-comment">// Kopierter Artikel offline setzen</span>
</span><span class="l" id="849">849                     <span class="php-var">$art_sql</span>-&gt;setValue(<span class="php-quote">'status'</span>, <span class="php-var">$from_sql</span>-&gt;getValue(<span class="php-quote">'status'</span>));
</span><span class="l" id="850">850                     <span class="php-var">$art_sql</span>-&gt;addGlobalUpdateFields(self::getUser());
</span><span class="l" id="851">851 
</span><span class="l" id="852">852                     <span class="php-var">$art_sql</span>-&gt;setWhere(<span class="php-quote">'clang_id="'</span> . <span class="php-var">$clang</span> . <span class="php-quote">'" and startarticle&lt;&gt;1 and id="'</span> . <span class="php-var">$id</span> . <span class="php-quote">'" and parent_id="'</span> . <span class="php-var">$from_cat_id</span> . <span class="php-quote">'"'</span>);
</span><span class="l" id="853">853                     <span class="php-var">$art_sql</span>-&gt;update();
</span><span class="l" id="854">854 
</span><span class="l" id="855">855                     <span class="php-comment">// Prios neu berechnen</span>
</span><span class="l" id="856">856                     self::newArtPrio(<span class="php-var">$to_cat_id</span>, <span class="php-var">$clang</span>, <span class="php-num">1</span>, <span class="php-num">0</span>);
</span><span class="l" id="857">857                     self::newArtPrio(<span class="php-var">$from_cat_id</span>, <span class="php-var">$clang</span>, <span class="php-num">1</span>, <span class="php-num">0</span>);
</span><span class="l" id="858">858 
</span><span class="l" id="859">859                     rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_MOVED'</span>, <span class="php-keyword1">null</span>, [
</span><span class="l" id="860">860                         <span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>,
</span><span class="l" id="861">861                         <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="862">862                         <span class="php-quote">'category_id'</span> =&gt; <span class="php-var">$parent_id</span>,
</span><span class="l" id="863">863                     ]));
</span><span class="l" id="864">864                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="865">865                     <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="866">866                 }
</span><span class="l" id="867">867             } <span class="php-keyword1">else</span> {
</span><span class="l" id="868">868                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="869">869             }
</span><span class="l" id="870">870         }
</span><span class="l" id="871">871 
</span><span class="l" id="872">872         <span class="php-comment">// Caches des Artikels löschen, in allen Sprachen</span>
</span><span class="l" id="873">873         rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$id</span>);
</span><span class="l" id="874">874 
</span><span class="l" id="875">875         <span class="php-comment">// Caches der Kategorien löschen, da sich derin befindliche Artikel geändert haben</span>
</span><span class="l" id="876">876         rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$from_cat_id</span>);
</span><span class="l" id="877">877         rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$to_cat_id</span>);
</span><span class="l" id="878">878 
</span><span class="l" id="879">879         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="880">880     }
</span><span class="l" id="881">881 
</span><span class="l" id="882">882     <span class="php-comment">/**
</span></span><span class="l" id="883">883 <span class="php-comment">     * Checks whether the required array key $keyName isset.
</span></span><span class="l" id="884">884 <span class="php-comment">     *
</span></span><span class="l" id="885">885 <span class="php-comment">     * @param array  $array   The array
</span></span><span class="l" id="886">886 <span class="php-comment">     * @param string $keyName The key
</span></span><span class="l" id="887">887 <span class="php-comment">     *
</span></span><span class="l" id="888">888 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="889">889 <span class="php-comment">     */</span>
</span><span class="l" id="890">890     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> reqKey(<span class="php-var">$array</span>, <span class="php-var">$keyName</span>)
</span><span class="l" id="891">891     {
</span><span class="l" id="892">892         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$array</span>[<span class="php-var">$keyName</span>])) {
</span><span class="l" id="893">893             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-quote">'Missing required parameter "'</span> . <span class="php-var">$keyName</span> . <span class="php-quote">'"!'</span>);
</span><span class="l" id="894">894         }
</span><span class="l" id="895">895     }
</span><span class="l" id="896">896 
</span><span class="l" id="897">897     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getUser()
</span><span class="l" id="898">898     {
</span><span class="l" id="899">899         <span class="php-keyword1">if</span> (rex::getUser()) {
</span><span class="l" id="900">900             <span class="php-keyword1">return</span> rex::getUser()-&gt;getLogin();
</span><span class="l" id="901">901         }
</span><span class="l" id="902">902 
</span><span class="l" id="903">903         <span class="php-keyword1">if</span> (<span class="php-keyword2">method_exists</span>(rex::<span class="php-keyword1">class</span>, <span class="php-quote">'getEnvironment'</span>)) {
</span><span class="l" id="904">904             <span class="php-keyword1">return</span> rex::getEnvironment();
</span><span class="l" id="905">905         }
</span><span class="l" id="906">906 
</span><span class="l" id="907">907         <span class="php-keyword1">return</span> <span class="php-quote">'frontend'</span>;
</span><span class="l" id="908">908     }
</span><span class="l" id="909">909 }
</span><span class="l" id="910">910 </span></code></pre>
 </body>
</html>
