<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Benutzt den Konsolen convert Befehl.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @author jan
</span></span><span class="l" id="7">  7 <span class="php-comment"> *
</span></span><span class="l" id="8">  8 <span class="php-comment"> * @package redaxo\media-manager
</span></span><span class="l" id="9">  9 <span class="php-comment"> */</span>
</span><span class="l" id="10"> 10 
</span><span class="l" id="11"> 11 <span class="php-keyword1">class</span> rex_effect_convert2img <span class="php-keyword1">extends</span> rex_effect_abstract
</span><span class="l" id="12"> 12 {
</span><span class="l" id="13"> 13     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$convert_types</span> = [
</span><span class="l" id="14"> 14         <span class="php-quote">'pdf'</span>,
</span><span class="l" id="15"> 15         <span class="php-quote">'ps'</span>,
</span><span class="l" id="16"> 16         <span class="php-quote">'psd'</span>,
</span><span class="l" id="17"> 17         <span class="php-quote">'tif'</span>,
</span><span class="l" id="18"> 18         <span class="php-quote">'tiff'</span>,
</span><span class="l" id="19"> 19         <span class="php-quote">'bmp'</span>,
</span><span class="l" id="20"> 20         <span class="php-quote">'eps'</span>,
</span><span class="l" id="21"> 21         <span class="php-quote">'ico'</span>,
</span><span class="l" id="22"> 22         <span class="php-comment">// 'svg'</span>
</span><span class="l" id="23"> 23     ];
</span><span class="l" id="24"> 24     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$convert_to</span> = [
</span><span class="l" id="25"> 25         <span class="php-quote">'jpg'</span> =&gt; [
</span><span class="l" id="26"> 26             <span class="php-quote">'ext'</span> =&gt; <span class="php-quote">'jpg'</span>,
</span><span class="l" id="27"> 27             <span class="php-quote">'content-type'</span> =&gt; <span class="php-quote">'image/jpeg'</span>,
</span><span class="l" id="28"> 28         ],
</span><span class="l" id="29"> 29         <span class="php-quote">'png'</span> =&gt; [
</span><span class="l" id="30"> 30             <span class="php-quote">'ext'</span> =&gt; <span class="php-quote">'png'</span>,
</span><span class="l" id="31"> 31             <span class="php-quote">'content-type'</span> =&gt; <span class="php-quote">'image/png'</span>,
</span><span class="l" id="32"> 32         ],
</span><span class="l" id="33"> 33     ];
</span><span class="l" id="34"> 34     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$densities</span> = [<span class="php-num">100</span>, <span class="php-num">150</span>, <span class="php-num">200</span>, <span class="php-num">300</span>, <span class="php-num">600</span>];
</span><span class="l" id="35"> 35     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$density_default</span> = <span class="php-num">150</span>;
</span><span class="l" id="36"> 36     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$convert_tos</span> = [<span class="php-quote">'jpg'</span>, <span class="php-quote">'png'</span>];
</span><span class="l" id="37"> 37     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$convert_to_default</span> = <span class="php-quote">'jpg'</span>
</span><span class="l" id="38"> 38     ;
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> execute()
</span><span class="l" id="41"> 41     {
</span><span class="l" id="42"> 42         <span class="php-comment">// error_reporting(E_ALL);ini_set("display_errors",1);</span>
</span><span class="l" id="43"> 43 
</span><span class="l" id="44"> 44         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$convert_to</span>[<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'convert_to'</span>]])) {
</span><span class="l" id="45"> 45             <span class="php-var">$convert_to</span> = self::<span class="php-var">$convert_to</span>[self::<span class="php-var">$convert_to_default</span>];
</span><span class="l" id="46"> 46         } <span class="php-keyword1">else</span> {
</span><span class="l" id="47"> 47             <span class="php-var">$convert_to</span> = self::<span class="php-var">$convert_to</span>[<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'convert_to'</span>]];
</span><span class="l" id="48"> 48         }
</span><span class="l" id="49"> 49 
</span><span class="l" id="50"> 50         <span class="php-var">$density</span> = (int) <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'density'</span>];
</span><span class="l" id="51"> 51 
</span><span class="l" id="52"> 52         <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$density</span>, self::<span class="php-var">$densities</span>)) {
</span><span class="l" id="53"> 53             <span class="php-var">$density</span> = self::<span class="php-var">$density_default</span>;
</span><span class="l" id="54"> 54         }
</span><span class="l" id="55"> 55 
</span><span class="l" id="56"> 56         <span class="php-var">$from_path</span> = <span class="php-keyword2">realpath</span>(<span class="php-var">$this</span>-&gt;media-&gt;getMediaPath());
</span><span class="l" id="57"> 57         <span class="php-var">$ext</span> = rex_file::extension(<span class="php-var">$from_path</span>);
</span><span class="l" id="58"> 58 
</span><span class="l" id="59"> 59         <span class="php-keyword1">if</span> (!<span class="php-var">$ext</span>) {
</span><span class="l" id="60"> 60             <span class="php-keyword1">return</span>;
</span><span class="l" id="61"> 61         }
</span><span class="l" id="62"> 62 
</span><span class="l" id="63"> 63         <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-keyword2">strtolower</span>(<span class="php-var">$ext</span>), self::<span class="php-var">$convert_types</span>)) {
</span><span class="l" id="64"> 64             <span class="php-keyword1">return</span>;
</span><span class="l" id="65"> 65         }
</span><span class="l" id="66"> 66 
</span><span class="l" id="67"> 67         <span class="php-var">$convert_path</span> = self::getConvertPath();
</span><span class="l" id="68"> 68 
</span><span class="l" id="69"> 69         <span class="php-keyword1">if</span> (<span class="php-var">$convert_path</span> == <span class="php-quote">''</span>) {
</span><span class="l" id="70"> 70             <span class="php-keyword1">return</span>;
</span><span class="l" id="71"> 71         }
</span><span class="l" id="72"> 72 
</span><span class="l" id="73"> 73         <span class="php-var">$filename</span> = <span class="php-var">$this</span>-&gt;media-&gt;getMediaFilename();
</span><span class="l" id="74"> 74         <span class="php-var">$filename_wo_ext</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$filename</span>, <span class="php-num">0</span>, (<span class="php-keyword2">strlen</span>(<span class="php-var">$filename</span>) - <span class="php-keyword2">strlen</span>(<span class="php-var">$ext</span>)));
</span><span class="l" id="75"> 75 
</span><span class="l" id="76"> 76         <span class="php-var">$to_path</span> = rex_path::addonCache(<span class="php-quote">'media_manager'</span>, <span class="php-quote">'media_manager__convert2img_'</span> . <span class="php-keyword2">md5</span>(<span class="php-var">$this</span>-&gt;media-&gt;getMediaPath()) . <span class="php-quote">'_'</span> . <span class="php-var">$filename_wo_ext</span> . <span class="php-var">$convert_to</span>[<span class="php-quote">'ext'</span>]);
</span><span class="l" id="77"> 77 
</span><span class="l" id="78"> 78         <span class="php-var">$cmd</span> = <span class="php-var">$convert_path</span> . <span class="php-quote">' -density '</span>.<span class="php-var">$density</span>.<span class="php-quote">' "'</span> . <span class="php-var">$from_path</span> . <span class="php-quote">'[0]" -colorspace RGB "'</span> . <span class="php-var">$to_path</span> . <span class="php-quote">'"'</span>;
</span><span class="l" id="79"> 79 
</span><span class="l" id="80"> 80         <span class="php-keyword2">exec</span>(<span class="php-var">$cmd</span>, <span class="php-var">$out</span>, <span class="php-var">$ret</span>);
</span><span class="l" id="81"> 81 
</span><span class="l" id="82"> 82         <span class="php-keyword1">if</span> (<span class="php-var">$ret</span> != <span class="php-num">0</span>) {
</span><span class="l" id="83"> 83             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="84"> 84         }
</span><span class="l" id="85"> 85 
</span><span class="l" id="86"> 86         <span class="php-var">$this</span>-&gt;media-&gt;setSourcePath(<span class="php-var">$to_path</span>);
</span><span class="l" id="87"> 87         <span class="php-var">$this</span>-&gt;media-&gt;refreshImageDimensions();
</span><span class="l" id="88"> 88         <span class="php-var">$this</span>-&gt;media-&gt;setFormat(<span class="php-var">$convert_to</span>[<span class="php-quote">'ext'</span>]);
</span><span class="l" id="89"> 89         <span class="php-var">$this</span>-&gt;media-&gt;setMediaFilename(<span class="php-var">$filename</span>);
</span><span class="l" id="90"> 90         <span class="php-var">$this</span>-&gt;media-&gt;setHeader(<span class="php-quote">'Content-Type'</span>, <span class="php-var">$convert_to</span>[<span class="php-quote">'content-type'</span>]);
</span><span class="l" id="91"> 91 
</span><span class="l" id="92"> 92         <span class="php-keyword2">register_shutdown_function</span>(<span class="php-keyword1">function</span> () <span class="php-keyword1">use</span> (<span class="php-var">$to_path</span>) {
</span><span class="l" id="93"> 93             rex_file::<span class="php-keyword2">delete</span>(<span class="php-var">$to_path</span>);
</span><span class="l" id="94"> 94         });
</span><span class="l" id="95"> 95     }
</span><span class="l" id="96"> 96 
</span><span class="l" id="97"> 97     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getName()
</span><span class="l" id="98"> 98     {
</span><span class="l" id="99"> 99         <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'media_manager_effect_convert2img'</span>);
</span><span class="l" id="100">100     }
</span><span class="l" id="101">101 
</span><span class="l" id="102">102     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getParams()
</span><span class="l" id="103">103     {
</span><span class="l" id="104">104         <span class="php-keyword1">return</span> [
</span><span class="l" id="105">105             [
</span><span class="l" id="106">106                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'media_manager_effect_convert2img_convertto'</span>),
</span><span class="l" id="107">107                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'convert_to'</span>,
</span><span class="l" id="108">108                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'select'</span>,
</span><span class="l" id="109">109                 <span class="php-quote">'options'</span> =&gt; self::<span class="php-var">$convert_tos</span>,
</span><span class="l" id="110">110                 <span class="php-quote">'default'</span> =&gt; self::<span class="php-var">$convert_to_default</span>,
</span><span class="l" id="111">111             ],
</span><span class="l" id="112">112             [
</span><span class="l" id="113">113                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'media_manager_effect_convert2img_density'</span>),
</span><span class="l" id="114">114                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'density'</span>,
</span><span class="l" id="115">115                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'select'</span>,
</span><span class="l" id="116">116                 <span class="php-quote">'options'</span> =&gt; self::<span class="php-var">$densities</span>,
</span><span class="l" id="117">117                 <span class="php-quote">'default'</span> =&gt; self::<span class="php-var">$density_default</span>,
</span><span class="l" id="118">118             ],
</span><span class="l" id="119">119         ];
</span><span class="l" id="120">120     }
</span><span class="l" id="121">121 
</span><span class="l" id="122">122     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getConvertPath()
</span><span class="l" id="123">123     {
</span><span class="l" id="124">124         <span class="php-var">$path</span> = <span class="php-quote">''</span>;
</span><span class="l" id="125">125 
</span><span class="l" id="126">126         <span class="php-keyword1">if</span> (<span class="php-keyword2">function_exists</span>(<span class="php-quote">'exec'</span>)) {
</span><span class="l" id="127">127             <span class="php-var">$out</span> = [];
</span><span class="l" id="128">128             <span class="php-var">$cmd</span> = <span class="php-quote">'which convert'</span>;
</span><span class="l" id="129">129             <span class="php-keyword2">exec</span>(<span class="php-var">$cmd</span>, <span class="php-var">$out</span>, <span class="php-var">$ret</span>);
</span><span class="l" id="130">130 
</span><span class="l" id="131">131             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$ret</span>) &amp;&amp; <span class="php-var">$ret</span> !== <span class="php-keyword1">null</span>) {
</span><span class="l" id="132">132                 <span class="php-keyword1">switch</span> (<span class="php-var">$ret</span>) {
</span><span class="l" id="133">133                     <span class="php-keyword1">case</span> <span class="php-num">0</span>:
</span><span class="l" id="134">134                         <span class="php-var">$path</span> = <span class="php-var">$out</span>[<span class="php-num">0</span>];
</span><span class="l" id="135">135                         <span class="php-keyword1">break</span>;
</span><span class="l" id="136">136                     <span class="php-keyword1">case</span> <span class="php-num">1</span>:
</span><span class="l" id="137">137                         <span class="php-var">$path</span> = <span class="php-quote">''</span>;
</span><span class="l" id="138">138                         <span class="php-keyword1">break</span>;
</span><span class="l" id="139">139                     <span class="php-keyword1">default</span>:
</span><span class="l" id="140">140                 }
</span><span class="l" id="141">141             }
</span><span class="l" id="142">142         }
</span><span class="l" id="143">143         <span class="php-keyword1">return</span> <span class="php-var">$path</span>;
</span><span class="l" id="144">144     }
</span><span class="l" id="145">145 }
</span><span class="l" id="146">146 </span></code></pre>
 </body>
</html>
