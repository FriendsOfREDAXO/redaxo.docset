<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Funktionensammlung für den Medienpool.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @package redaxo\mediapool
</span></span><span class="l" id="7">  7 <span class="php-comment"> */</span>
</span><span class="l" id="8">  8 
</span><span class="l" id="9">  9 <span class="php-comment">/**
</span></span><span class="l" id="10"> 10 <span class="php-comment"> * Erstellt einen Filename der eindeutig ist für den Medienpool.
</span></span><span class="l" id="11"> 11 <span class="php-comment"> *
</span></span><span class="l" id="12"> 12 <span class="php-comment"> * @param string $FILENAME      Dateiname
</span></span><span class="l" id="13"> 13 <span class="php-comment"> * @param bool   $doSubindexing
</span></span><span class="l" id="14"> 14 <span class="php-comment"> *
</span></span><span class="l" id="15"> 15 <span class="php-comment"> * @return string
</span></span><span class="l" id="16"> 16 <span class="php-comment"> */</span>
</span><span class="l" id="17"> 17 <span class="php-keyword1">function</span> rex_mediapool_filename(<span class="php-var">$FILENAME</span>, <span class="php-var">$doSubindexing</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="18"> 18 {
</span><span class="l" id="19"> 19     <span class="php-comment">// ----- neuer filename und extension holen</span>
</span><span class="l" id="20"> 20     <span class="php-var">$NFILENAME</span> = rex_string::normalize(<span class="php-var">$FILENAME</span>, <span class="php-quote">'_'</span>, <span class="php-quote">'.-'</span>);
</span><span class="l" id="21"> 21 
</span><span class="l" id="22"> 22     <span class="php-keyword1">if</span> (<span class="php-quote">'.'</span> === <span class="php-var">$NFILENAME</span>[<span class="php-num">0</span>]) {
</span><span class="l" id="23"> 23         <span class="php-var">$NFILENAME</span>[<span class="php-num">0</span>] = <span class="php-quote">'_'</span>;
</span><span class="l" id="24"> 24     }
</span><span class="l" id="25"> 25 
</span><span class="l" id="26"> 26     <span class="php-keyword1">if</span> (<span class="php-keyword2">strrpos</span>(<span class="php-var">$NFILENAME</span>, <span class="php-quote">'.'</span>) != <span class="php-quote">''</span>) {
</span><span class="l" id="27"> 27         <span class="php-var">$NFILE_NAME</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$NFILENAME</span>, <span class="php-num">0</span>, <span class="php-keyword2">strlen</span>(<span class="php-var">$NFILENAME</span>) - (<span class="php-keyword2">strlen</span>(<span class="php-var">$NFILENAME</span>) - <span class="php-keyword2">strrpos</span>(<span class="php-var">$NFILENAME</span>, <span class="php-quote">'.'</span>)));
</span><span class="l" id="28"> 28         <span class="php-var">$NFILE_EXT</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$NFILENAME</span>, <span class="php-keyword2">strrpos</span>(<span class="php-var">$NFILENAME</span>, <span class="php-quote">'.'</span>), <span class="php-keyword2">strlen</span>(<span class="php-var">$NFILENAME</span>) - <span class="php-keyword2">strrpos</span>(<span class="php-var">$NFILENAME</span>, <span class="php-quote">'.'</span>));
</span><span class="l" id="29"> 29     } <span class="php-keyword1">else</span> {
</span><span class="l" id="30"> 30         <span class="php-var">$NFILE_NAME</span> = <span class="php-var">$NFILENAME</span>;
</span><span class="l" id="31"> 31         <span class="php-var">$NFILE_EXT</span> = <span class="php-quote">''</span>;
</span><span class="l" id="32"> 32     }
</span><span class="l" id="33"> 33 
</span><span class="l" id="34"> 34     <span class="php-comment">// ---- ext checken - alle scriptendungen rausfiltern</span>
</span><span class="l" id="35"> 35     <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-keyword2">ltrim</span>(<span class="php-var">$NFILE_EXT</span>, <span class="php-quote">'.'</span>), rex_addon::get(<span class="php-quote">'mediapool'</span>)-&gt;getProperty(<span class="php-quote">'blocked_extensions'</span>))) {
</span><span class="l" id="36"> 36         <span class="php-var">$NFILE_NAME</span> .= <span class="php-var">$NFILE_EXT</span>;
</span><span class="l" id="37"> 37         <span class="php-var">$NFILE_EXT</span> = <span class="php-quote">'.txt'</span>;
</span><span class="l" id="38"> 38     }
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40     <span class="php-comment">// ---- multiple extension check</span>
</span><span class="l" id="41"> 41     <span class="php-keyword1">foreach</span> (rex_addon::get(<span class="php-quote">'mediapool'</span>)-&gt;getProperty(<span class="php-quote">'blocked_extensions'</span>) <span class="php-keyword1">as</span> <span class="php-var">$ext</span>) {
</span><span class="l" id="42"> 42         <span class="php-var">$NFILE_NAME</span> = <span class="php-keyword2">str_replace</span>(<span class="php-var">$ext</span> . <span class="php-quote">'.'</span>, <span class="php-var">$ext</span> . <span class="php-quote">'_.'</span>, <span class="php-var">$NFILE_NAME</span>);
</span><span class="l" id="43"> 43     }
</span><span class="l" id="44"> 44 
</span><span class="l" id="45"> 45     <span class="php-var">$NFILENAME</span> = <span class="php-var">$NFILE_NAME</span> . <span class="php-var">$NFILE_EXT</span>;
</span><span class="l" id="46"> 46 
</span><span class="l" id="47"> 47     <span class="php-keyword1">if</span> (<span class="php-var">$doSubindexing</span> || <span class="php-var">$FILENAME</span> != <span class="php-var">$NFILENAME</span>) {
</span><span class="l" id="48"> 48         <span class="php-comment">// ----- datei schon vorhanden -&gt; namen aendern -&gt; _1 ..</span>
</span><span class="l" id="49"> 49         <span class="php-keyword1">if</span> (<span class="php-keyword2">file_exists</span>(rex_path::media(<span class="php-var">$NFILENAME</span>))) {
</span><span class="l" id="50"> 50             <span class="php-var">$cnt</span> = <span class="php-num">1</span>;
</span><span class="l" id="51"> 51             <span class="php-keyword1">while</span> (<span class="php-keyword2">file_exists</span>(rex_path::media(<span class="php-var">$NFILE_NAME</span> . <span class="php-quote">'_'</span> . <span class="php-var">$cnt</span> . <span class="php-var">$NFILE_EXT</span>))) {
</span><span class="l" id="52"> 52                 ++<span class="php-var">$cnt</span>;
</span><span class="l" id="53"> 53             }
</span><span class="l" id="54"> 54 
</span><span class="l" id="55"> 55             <span class="php-var">$NFILENAME</span> = <span class="php-var">$NFILE_NAME</span> . <span class="php-quote">'_'</span> . <span class="php-var">$cnt</span> . <span class="php-var">$NFILE_EXT</span>;
</span><span class="l" id="56"> 56         }
</span><span class="l" id="57"> 57     }
</span><span class="l" id="58"> 58 
</span><span class="l" id="59"> 59     <span class="php-keyword1">return</span> <span class="php-var">$NFILENAME</span>;
</span><span class="l" id="60"> 60 }
</span><span class="l" id="61"> 61 
</span><span class="l" id="62"> 62 <span class="php-comment">/**
</span></span><span class="l" id="63"> 63 <span class="php-comment"> * Holt ein upgeloadetes File und legt es in den Medienpool
</span></span><span class="l" id="64"> 64 <span class="php-comment"> * Dabei wird kontrolliert ob das File schon vorhanden ist und es
</span></span><span class="l" id="65"> 65 <span class="php-comment"> * wird eventuell angepasst, weiterhin werden die Fileinformationen übergeben.
</span></span><span class="l" id="66"> 66 <span class="php-comment"> *
</span></span><span class="l" id="67"> 67 <span class="php-comment"> * @param array  $FILE
</span></span><span class="l" id="68"> 68 <span class="php-comment"> * @param int    $rex_file_category
</span></span><span class="l" id="69"> 69 <span class="php-comment"> * @param array  $FILEINFOS
</span></span><span class="l" id="70"> 70 <span class="php-comment"> * @param string $userlogin
</span></span><span class="l" id="71"> 71 <span class="php-comment"> * @param bool   $doSubindexing
</span></span><span class="l" id="72"> 72 <span class="php-comment"> *
</span></span><span class="l" id="73"> 73 <span class="php-comment"> * @return array
</span></span><span class="l" id="74"> 74 <span class="php-comment"> */</span>
</span><span class="l" id="75"> 75 <span class="php-keyword1">function</span> rex_mediapool_saveMedia(<span class="php-var">$FILE</span>, <span class="php-var">$rex_file_category</span>, <span class="php-var">$FILEINFOS</span>, <span class="php-var">$userlogin</span> = <span class="php-keyword1">null</span>, <span class="php-var">$doSubindexing</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="76"> 76 {
</span><span class="l" id="77"> 77     <span class="php-var">$rex_file_category</span> = (int) <span class="php-var">$rex_file_category</span>;
</span><span class="l" id="78"> 78 
</span><span class="l" id="79"> 79     <span class="php-var">$gc</span> = rex_sql::factory();
</span><span class="l" id="80"> 80     <span class="php-var">$gc</span>-&gt;setQuery(<span class="php-quote">'SELECT * FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'media_category WHERE id='</span> . <span class="php-var">$rex_file_category</span>);
</span><span class="l" id="81"> 81     <span class="php-keyword1">if</span> (<span class="php-var">$gc</span>-&gt;getRows() != <span class="php-num">1</span>) {
</span><span class="l" id="82"> 82         <span class="php-var">$rex_file_category</span> = <span class="php-num">0</span>;
</span><span class="l" id="83"> 83     }
</span><span class="l" id="84"> 84 
</span><span class="l" id="85"> 85     <span class="php-var">$isFileUpload</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$FILE</span>[<span class="php-quote">'tmp_name'</span>]);
</span><span class="l" id="86"> 86     <span class="php-keyword1">if</span> (<span class="php-var">$isFileUpload</span>) {
</span><span class="l" id="87"> 87         <span class="php-var">$doSubindexing</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="88"> 88     }
</span><span class="l" id="89"> 89 
</span><span class="l" id="90"> 90     <span class="php-var">$FILENAME</span> = <span class="php-var">$FILE</span>[<span class="php-quote">'name'</span>];
</span><span class="l" id="91"> 91     <span class="php-var">$FILESIZE</span> = <span class="php-var">$FILE</span>[<span class="php-quote">'size'</span>];
</span><span class="l" id="92"> 92     <span class="php-var">$FILETYPE</span> = <span class="php-var">$FILE</span>[<span class="php-quote">'type'</span>];
</span><span class="l" id="93"> 93     <span class="php-var">$NFILENAME</span> = rex_mediapool_filename(<span class="php-var">$FILENAME</span>, <span class="php-var">$doSubindexing</span>);
</span><span class="l" id="94"> 94     <span class="php-var">$message</span> = [];
</span><span class="l" id="95"> 95 
</span><span class="l" id="96"> 96     <span class="php-comment">// ----- alter/neuer filename</span>
</span><span class="l" id="97"> 97     <span class="php-var">$srcFile</span> = rex_path::media(<span class="php-var">$FILENAME</span>);
</span><span class="l" id="98"> 98     <span class="php-var">$dstFile</span> = rex_path::media(<span class="php-var">$NFILENAME</span>);
</span><span class="l" id="99"> 99 
</span><span class="l" id="100">100     <span class="php-var">$success</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="101">101     <span class="php-keyword1">if</span> (<span class="php-var">$isFileUpload</span>) { <span class="php-comment">// Fileupload?</span>
</span><span class="l" id="102">102         <span class="php-keyword1">if</span> (!@<span class="php-keyword2">move_uploaded_file</span>(<span class="php-var">$FILE</span>[<span class="php-quote">'tmp_name'</span>], <span class="php-var">$dstFile</span>)) {
</span><span class="l" id="103">103             <span class="php-var">$message</span>[] = rex_i18n::msg(<span class="php-quote">'pool_file_movefailed'</span>);
</span><span class="l" id="104">104             <span class="php-var">$success</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="105">105         }
</span><span class="l" id="106">106     } <span class="php-keyword1">else</span> { <span class="php-comment">// Filesync?</span>
</span><span class="l" id="107">107         <span class="php-keyword1">if</span> (!@<span class="php-keyword2">rename</span>(<span class="php-var">$srcFile</span>, <span class="php-var">$dstFile</span>)) {
</span><span class="l" id="108">108             <span class="php-var">$message</span>[] = rex_i18n::msg(<span class="php-quote">'pool_file_movefailed'</span>);
</span><span class="l" id="109">109             <span class="php-var">$success</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="110">110         }
</span><span class="l" id="111">111     }
</span><span class="l" id="112">112 
</span><span class="l" id="113">113     <span class="php-keyword1">if</span> (<span class="php-var">$success</span>) {
</span><span class="l" id="114">114         @<span class="php-keyword2">chmod</span>(<span class="php-var">$dstFile</span>, rex::getFilePerm());
</span><span class="l" id="115">115 
</span><span class="l" id="116">116         <span class="php-comment">// get widht height</span>
</span><span class="l" id="117">117         <span class="php-var">$size</span> = @<span class="php-keyword2">getimagesize</span>(<span class="php-var">$dstFile</span>);
</span><span class="l" id="118">118 
</span><span class="l" id="119">119         <span class="php-keyword1">if</span> (<span class="php-var">$FILETYPE</span> == <span class="php-quote">''</span> &amp;&amp; <span class="php-keyword1">isset</span>(<span class="php-var">$size</span>[<span class="php-quote">'mime'</span>])) {
</span><span class="l" id="120">120             <span class="php-var">$FILETYPE</span> = <span class="php-var">$size</span>[<span class="php-quote">'mime'</span>];
</span><span class="l" id="121">121         }
</span><span class="l" id="122">122 
</span><span class="l" id="123">123         <span class="php-var">$FILESQL</span> = rex_sql::factory();
</span><span class="l" id="124">124         <span class="php-var">$FILESQL</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'media'</span>);
</span><span class="l" id="125">125         <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'filetype'</span>, <span class="php-var">$FILETYPE</span>);
</span><span class="l" id="126">126         <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'title'</span>, <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'title'</span>]);
</span><span class="l" id="127">127         <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'filename'</span>, <span class="php-var">$NFILENAME</span>);
</span><span class="l" id="128">128         <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'originalname'</span>, <span class="php-var">$FILENAME</span>);
</span><span class="l" id="129">129         <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'filesize'</span>, <span class="php-var">$FILESIZE</span>);
</span><span class="l" id="130">130 
</span><span class="l" id="131">131         <span class="php-keyword1">if</span> (<span class="php-var">$size</span>) {
</span><span class="l" id="132">132             <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'width'</span>, <span class="php-var">$size</span>[<span class="php-num">0</span>]);
</span><span class="l" id="133">133             <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'height'</span>, <span class="php-var">$size</span>[<span class="php-num">1</span>]);
</span><span class="l" id="134">134         }
</span><span class="l" id="135">135 
</span><span class="l" id="136">136         <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'category_id'</span>, <span class="php-var">$rex_file_category</span>);
</span><span class="l" id="137">137         <span class="php-var">$FILESQL</span>-&gt;addGlobalCreateFields(<span class="php-var">$userlogin</span>);
</span><span class="l" id="138">138         <span class="php-var">$FILESQL</span>-&gt;addGlobalUpdateFields(<span class="php-var">$userlogin</span>);
</span><span class="l" id="139">139         <span class="php-var">$FILESQL</span>-&gt;insert();
</span><span class="l" id="140">140 
</span><span class="l" id="141">141         <span class="php-keyword1">if</span> (<span class="php-var">$isFileUpload</span>) {
</span><span class="l" id="142">142             <span class="php-var">$message</span>[] = rex_i18n::msg(<span class="php-quote">'pool_file_added'</span>);
</span><span class="l" id="143">143         }
</span><span class="l" id="144">144 
</span><span class="l" id="145">145         <span class="php-keyword1">if</span> (<span class="php-var">$NFILENAME</span> != <span class="php-var">$FILENAME</span>) {
</span><span class="l" id="146">146             <span class="php-var">$message</span>[] = rex_i18n::rawMsg(<span class="php-quote">'pool_file_renamed'</span>, <span class="php-var">$FILENAME</span>, <span class="php-var">$NFILENAME</span>);
</span><span class="l" id="147">147         }
</span><span class="l" id="148">148 
</span><span class="l" id="149">149         rex_media_cache::deleteList(<span class="php-var">$rex_file_category</span>);
</span><span class="l" id="150">150     }
</span><span class="l" id="151">151 
</span><span class="l" id="152">152     <span class="php-var">$RETURN</span>[<span class="php-quote">'title'</span>] = <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'title'</span>];
</span><span class="l" id="153">153     <span class="php-var">$RETURN</span>[<span class="php-quote">'type'</span>] = <span class="php-var">$FILETYPE</span>;
</span><span class="l" id="154">154     <span class="php-var">$RETURN</span>[<span class="php-quote">'msg'</span>] = <span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$message</span>);
</span><span class="l" id="155">155     <span class="php-comment">// Aus BC gruenden hier mit int 1/0</span>
</span><span class="l" id="156">156     <span class="php-var">$RETURN</span>[<span class="php-quote">'ok'</span>] = <span class="php-var">$success</span> ? <span class="php-num">1</span> : <span class="php-num">0</span>;
</span><span class="l" id="157">157     <span class="php-var">$RETURN</span>[<span class="php-quote">'filename'</span>] = <span class="php-var">$NFILENAME</span>;
</span><span class="l" id="158">158     <span class="php-var">$RETURN</span>[<span class="php-quote">'old_filename'</span>] = <span class="php-var">$FILENAME</span>;
</span><span class="l" id="159">159 
</span><span class="l" id="160">160     <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$size</span>)) {
</span><span class="l" id="161">161         <span class="php-var">$RETURN</span>[<span class="php-quote">'width'</span>] = <span class="php-var">$size</span>[<span class="php-num">0</span>];
</span><span class="l" id="162">162         <span class="php-var">$RETURN</span>[<span class="php-quote">'height'</span>] = <span class="php-var">$size</span>[<span class="php-num">1</span>];
</span><span class="l" id="163">163     }
</span><span class="l" id="164">164 
</span><span class="l" id="165">165     <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="166">166     <span class="php-keyword1">if</span> (<span class="php-var">$success</span>) {
</span><span class="l" id="167">167         rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'MEDIA_ADDED'</span>, <span class="php-quote">''</span>, <span class="php-var">$RETURN</span>));
</span><span class="l" id="168">168     }
</span><span class="l" id="169">169 
</span><span class="l" id="170">170     <span class="php-keyword1">return</span> <span class="php-var">$RETURN</span>;
</span><span class="l" id="171">171 }
</span><span class="l" id="172">172 
</span><span class="l" id="173">173 <span class="php-comment">/**
</span></span><span class="l" id="174">174 <span class="php-comment"> * Holt ein upgeloadetes File und legt es in den Medienpool
</span></span><span class="l" id="175">175 <span class="php-comment"> * Dabei wird kontrolliert ob das File schon vorhanden ist und es
</span></span><span class="l" id="176">176 <span class="php-comment"> * wird eventuell angepasst, weiterhin werden die Fileinformationen übergeben.
</span></span><span class="l" id="177">177 <span class="php-comment"> *
</span></span><span class="l" id="178">178 <span class="php-comment"> * @param array  $FILE
</span></span><span class="l" id="179">179 <span class="php-comment"> * @param array  $FILEINFOS
</span></span><span class="l" id="180">180 <span class="php-comment"> * @param string $userlogin
</span></span><span class="l" id="181">181 <span class="php-comment"> *
</span></span><span class="l" id="182">182 <span class="php-comment"> * @return array
</span></span><span class="l" id="183">183 <span class="php-comment"> */</span>
</span><span class="l" id="184">184 <span class="php-keyword1">function</span> rex_mediapool_updateMedia(<span class="php-var">$FILE</span>, &amp;<span class="php-var">$FILEINFOS</span>, <span class="php-var">$userlogin</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="185">185 {
</span><span class="l" id="186">186     <span class="php-var">$RETURN</span> = [];
</span><span class="l" id="187">187 
</span><span class="l" id="188">188     <span class="php-var">$FILESQL</span> = rex_sql::factory();
</span><span class="l" id="189">189     <span class="php-comment">// $FILESQL-&gt;setDebug();</span>
</span><span class="l" id="190">190     <span class="php-var">$FILESQL</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'media'</span>);
</span><span class="l" id="191">191     <span class="php-var">$FILESQL</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'file_id'</span>]]);
</span><span class="l" id="192">192     <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'title'</span>, <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'title'</span>]);
</span><span class="l" id="193">193     <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'category_id'</span>, <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'rex_file_category'</span>]);
</span><span class="l" id="194">194 
</span><span class="l" id="195">195     <span class="php-var">$updated</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="196">196     <span class="php-keyword1">if</span> (<span class="php-var">$_FILES</span>[<span class="php-quote">'file_new'</span>][<span class="php-quote">'name'</span>] != <span class="php-quote">''</span> &amp;&amp; <span class="php-var">$_FILES</span>[<span class="php-quote">'file_new'</span>][<span class="php-quote">'name'</span>] != <span class="php-quote">'none'</span>) {
</span><span class="l" id="197">197         <span class="php-var">$ffilename</span> = <span class="php-var">$_FILES</span>[<span class="php-quote">'file_new'</span>][<span class="php-quote">'tmp_name'</span>];
</span><span class="l" id="198">198         <span class="php-var">$ffiletype</span> = <span class="php-var">$_FILES</span>[<span class="php-quote">'file_new'</span>][<span class="php-quote">'type'</span>];
</span><span class="l" id="199">199         <span class="php-var">$ffilesize</span> = <span class="php-var">$_FILES</span>[<span class="php-quote">'file_new'</span>][<span class="php-quote">'size'</span>];
</span><span class="l" id="200">200 
</span><span class="l" id="201">201         <span class="php-var">$extensionNew</span> = <span class="php-keyword2">mb_strtolower</span>(<span class="php-keyword2">pathinfo</span>(<span class="php-var">$_FILES</span>[<span class="php-quote">'file_new'</span>][<span class="php-quote">'name'</span>], PATHINFO_EXTENSION));
</span><span class="l" id="202">202         <span class="php-var">$extensionOld</span> = <span class="php-keyword2">mb_strtolower</span>(<span class="php-keyword2">pathinfo</span>(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>], PATHINFO_EXTENSION));
</span><span class="l" id="203">203 
</span><span class="l" id="204">204         <span class="php-keyword1">static</span> <span class="php-var">$jpgExtensions</span> = [<span class="php-quote">'jpg'</span>, <span class="php-quote">'jpeg'</span>];
</span><span class="l" id="205">205 
</span><span class="l" id="206">206         <span class="php-keyword1">if</span> (
</span><span class="l" id="207">207             <span class="php-var">$extensionNew</span> == <span class="php-var">$extensionOld</span> ||
</span><span class="l" id="208">208             <span class="php-keyword2">in_array</span>(<span class="php-var">$extensionNew</span>, <span class="php-var">$jpgExtensions</span>) &amp;&amp; <span class="php-keyword2">in_array</span>(<span class="php-var">$extensionOld</span>, <span class="php-var">$jpgExtensions</span>)
</span><span class="l" id="209">209         ) {
</span><span class="l" id="210">210             <span class="php-keyword1">if</span> (<span class="php-keyword2">move_uploaded_file</span>(<span class="php-var">$ffilename</span>, rex_path::media(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>])) ||
</span><span class="l" id="211">211                     <span class="php-keyword2">copy</span>(<span class="php-var">$ffilename</span>, rex_path::media(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>]))
</span><span class="l" id="212">212             ) {
</span><span class="l" id="213">213                 <span class="php-var">$RETURN</span>[<span class="php-quote">'msg'</span>] = rex_i18n::msg(<span class="php-quote">'pool_file_changed'</span>);
</span><span class="l" id="214">214                 <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filetype'</span>] = <span class="php-var">$ffiletype</span>;
</span><span class="l" id="215">215                 <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filesize'</span>] = <span class="php-var">$ffilesize</span>;
</span><span class="l" id="216">216 
</span><span class="l" id="217">217                 <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'filetype'</span>, <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filetype'</span>]);
</span><span class="l" id="218">218                 <span class="php-comment">// $FILESQL-&gt;setValue('originalname',$ffilename);</span>
</span><span class="l" id="219">219                 <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'filesize'</span>, <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filesize'</span>]);
</span><span class="l" id="220">220                 <span class="php-keyword1">if</span> (<span class="php-var">$size</span> = @<span class="php-keyword2">getimagesize</span>(rex_path::media(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>]))) {
</span><span class="l" id="221">221                     <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'width'</span>, <span class="php-var">$size</span>[<span class="php-num">0</span>]);
</span><span class="l" id="222">222                     <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'height'</span>, <span class="php-var">$size</span>[<span class="php-num">1</span>]);
</span><span class="l" id="223">223                 }
</span><span class="l" id="224">224                 @<span class="php-keyword2">chmod</span>(rex_path::media(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>]), rex::getFilePerm());
</span><span class="l" id="225">225                 <span class="php-var">$updated</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="226">226             } <span class="php-keyword1">else</span> {
</span><span class="l" id="227">227                 <span class="php-var">$RETURN</span>[<span class="php-quote">'msg'</span>] = rex_i18n::msg(<span class="php-quote">'pool_file_upload_error'</span>);
</span><span class="l" id="228">228             }
</span><span class="l" id="229">229         } <span class="php-keyword1">else</span> {
</span><span class="l" id="230">230             <span class="php-var">$RETURN</span>[<span class="php-quote">'msg'</span>] = rex_i18n::msg(<span class="php-quote">'pool_file_upload_errortype'</span>);
</span><span class="l" id="231">231         }
</span><span class="l" id="232">232     } <span class="php-keyword1">else</span> {
</span><span class="l" id="233">233         <span class="php-keyword1">if</span> (<span class="php-var">$size</span> = @<span class="php-keyword2">getimagesize</span>(rex_path::media(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>]))) {
</span><span class="l" id="234">234             <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'width'</span>, <span class="php-var">$size</span>[<span class="php-num">0</span>]);
</span><span class="l" id="235">235             <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'height'</span>, <span class="php-var">$size</span>[<span class="php-num">1</span>]);
</span><span class="l" id="236">236         }
</span><span class="l" id="237">237         <span class="php-var">$FILESQL</span>-&gt;setValue(<span class="php-quote">'filesize'</span>, @<span class="php-keyword2">filesize</span>(rex_path::media(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>])));
</span><span class="l" id="238">238     }
</span><span class="l" id="239">239 
</span><span class="l" id="240">240     <span class="php-comment">// Aus BC gruenden hier mit int 1/0</span>
</span><span class="l" id="241">241     <span class="php-var">$RETURN</span>[<span class="php-quote">'ok'</span>] = <span class="php-var">$updated</span> ? <span class="php-num">1</span> : <span class="php-num">0</span>;
</span><span class="l" id="242">242     <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$RETURN</span>[<span class="php-quote">'msg'</span>])) {
</span><span class="l" id="243">243         <span class="php-var">$RETURN</span>[<span class="php-quote">'msg'</span>] = rex_i18n::msg(<span class="php-quote">'pool_file_infos_updated'</span>);
</span><span class="l" id="244">244         <span class="php-var">$RETURN</span>[<span class="php-quote">'ok'</span>] = <span class="php-num">1</span>;
</span><span class="l" id="245">245     }
</span><span class="l" id="246">246     <span class="php-keyword1">if</span> (<span class="php-var">$RETURN</span>[<span class="php-quote">'ok'</span>] == <span class="php-num">1</span>) {
</span><span class="l" id="247">247         <span class="php-var">$RETURN</span>[<span class="php-quote">'filename'</span>] = <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>];
</span><span class="l" id="248">248         <span class="php-var">$RETURN</span>[<span class="php-quote">'filetype'</span>] = <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filetype'</span>];
</span><span class="l" id="249">249         <span class="php-var">$RETURN</span>[<span class="php-quote">'id'</span>] = <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'file_id'</span>];
</span><span class="l" id="250">250     }
</span><span class="l" id="251">251 
</span><span class="l" id="252">252     <span class="php-var">$FILESQL</span>-&gt;addGlobalUpdateFields();
</span><span class="l" id="253">253     <span class="php-var">$FILESQL</span>-&gt;update();
</span><span class="l" id="254">254 
</span><span class="l" id="255">255     rex_media_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$FILEINFOS</span>[<span class="php-quote">'filename'</span>]);
</span><span class="l" id="256">256 
</span><span class="l" id="257">257     <span class="php-comment">/*
</span></span><span class="l" id="258">258 <span class="php-comment">    $RETURN['title'] = $FILEINFOS['title'];
</span></span><span class="l" id="259">259 <span class="php-comment">    $RETURN['type'] = $FILETYPE;
</span></span><span class="l" id="260">260 <span class="php-comment">    $RETURN['msg'] = $message;
</span></span><span class="l" id="261">261 <span class="php-comment">    // Aus BC gruenden hier mit int 1/0
</span></span><span class="l" id="262">262 <span class="php-comment">    $RETURN['ok'] = $success ? 1 : 0;
</span></span><span class="l" id="263">263 <span class="php-comment">    $RETURN['filename'] = $NFILENAME;
</span></span><span class="l" id="264">264 <span class="php-comment">    $RETURN['old_filename'] = $FILENAME;
</span></span><span class="l" id="265">265 <span class="php-comment">    */</span>
</span><span class="l" id="266">266 
</span><span class="l" id="267">267     <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="268">268     <span class="php-keyword1">if</span> (<span class="php-var">$RETURN</span>[<span class="php-quote">'ok'</span>]) {
</span><span class="l" id="269">269         rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'MEDIA_UPDATED'</span>, <span class="php-quote">''</span>, <span class="php-var">$RETURN</span>));
</span><span class="l" id="270">270     }
</span><span class="l" id="271">271 
</span><span class="l" id="272">272     <span class="php-keyword1">return</span> <span class="php-var">$RETURN</span>;
</span><span class="l" id="273">273 }
</span><span class="l" id="274">274 
</span><span class="l" id="275">275 <span class="php-comment">/**
</span></span><span class="l" id="276">276 <span class="php-comment"> * Synchronisiert die Datei $physical_filename des Mediafolders in den
</span></span><span class="l" id="277">277 <span class="php-comment"> * Medienpool.
</span></span><span class="l" id="278">278 <span class="php-comment"> *
</span></span><span class="l" id="279">279 <span class="php-comment"> * @param string $physical_filename
</span></span><span class="l" id="280">280 <span class="php-comment"> * @param int    $category_id
</span></span><span class="l" id="281">281 <span class="php-comment"> * @param string $title
</span></span><span class="l" id="282">282 <span class="php-comment"> * @param int    $filesize
</span></span><span class="l" id="283">283 <span class="php-comment"> * @param string $filetype
</span></span><span class="l" id="284">284 <span class="php-comment"> * @param bool   $doSubindexing
</span></span><span class="l" id="285">285 <span class="php-comment"> *
</span></span><span class="l" id="286">286 <span class="php-comment"> * @return bool|array
</span></span><span class="l" id="287">287 <span class="php-comment"> */</span>
</span><span class="l" id="288">288 <span class="php-keyword1">function</span> rex_mediapool_syncFile(<span class="php-var">$physical_filename</span>, <span class="php-var">$category_id</span>, <span class="php-var">$title</span>, <span class="php-var">$filesize</span> = <span class="php-keyword1">null</span>, <span class="php-var">$filetype</span> = <span class="php-keyword1">null</span>, <span class="php-var">$doSubindexing</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="289">289 {
</span><span class="l" id="290">290     <span class="php-var">$abs_file</span> = rex_path::media(<span class="php-var">$physical_filename</span>);
</span><span class="l" id="291">291 
</span><span class="l" id="292">292     <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$abs_file</span>)) {
</span><span class="l" id="293">293         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="294">294     }
</span><span class="l" id="295">295 
</span><span class="l" id="296">296     <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$filesize</span>)) {
</span><span class="l" id="297">297         <span class="php-var">$filesize</span> = <span class="php-keyword2">filesize</span>(<span class="php-var">$abs_file</span>);
</span><span class="l" id="298">298     }
</span><span class="l" id="299">299 
</span><span class="l" id="300">300     <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$filetype</span>) &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-quote">'mime_content_type'</span>)) {
</span><span class="l" id="301">301         <span class="php-var">$filetype</span> = <span class="php-keyword2">mime_content_type</span>(<span class="php-var">$abs_file</span>);
</span><span class="l" id="302">302     }
</span><span class="l" id="303">303 
</span><span class="l" id="304">304     <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$filetype</span>) &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-quote">'finfo_open'</span>)) {
</span><span class="l" id="305">305         <span class="php-var">$finfo</span> = <span class="php-keyword2">finfo_open</span>(FILEINFO_MIME_TYPE); <span class="php-comment">// return mime type ala mimetype extension</span>
</span><span class="l" id="306">306         <span class="php-var">$filetype</span> = <span class="php-keyword2">finfo_file</span>(<span class="php-var">$finfo</span>, <span class="php-var">$abs_file</span>);
</span><span class="l" id="307">307     }
</span><span class="l" id="308">308 
</span><span class="l" id="309">309     <span class="php-var">$FILE</span> = [];
</span><span class="l" id="310">310     <span class="php-var">$FILE</span>[<span class="php-quote">'name'</span>] = <span class="php-var">$physical_filename</span>;
</span><span class="l" id="311">311     <span class="php-var">$FILE</span>[<span class="php-quote">'size'</span>] = <span class="php-var">$filesize</span>;
</span><span class="l" id="312">312     <span class="php-var">$FILE</span>[<span class="php-quote">'type'</span>] = <span class="php-var">$filetype</span>;
</span><span class="l" id="313">313 
</span><span class="l" id="314">314     <span class="php-var">$FILEINFOS</span> = [];
</span><span class="l" id="315">315     <span class="php-var">$FILEINFOS</span>[<span class="php-quote">'title'</span>] = <span class="php-var">$title</span>;
</span><span class="l" id="316">316 
</span><span class="l" id="317">317     <span class="php-var">$RETURN</span> = rex_mediapool_saveMedia(<span class="php-var">$FILE</span>, <span class="php-var">$category_id</span>, <span class="php-var">$FILEINFOS</span>, <span class="php-keyword1">null</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="318">318     <span class="php-keyword1">return</span> <span class="php-var">$RETURN</span>;
</span><span class="l" id="319">319 }
</span><span class="l" id="320">320 
</span><span class="l" id="321">321 <span class="php-comment">/**
</span></span><span class="l" id="322">322 <span class="php-comment"> * @param string $filename
</span></span><span class="l" id="323">323 <span class="php-comment"> *
</span></span><span class="l" id="324">324 <span class="php-comment"> * @return bool
</span></span><span class="l" id="325">325 <span class="php-comment"> */</span>
</span><span class="l" id="326">326 <span class="php-keyword1">function</span> rex_mediapool_deleteMedia(<span class="php-var">$filename</span>)
</span><span class="l" id="327">327 {
</span><span class="l" id="328">328     <span class="php-keyword1">if</span> (<span class="php-var">$uses</span> = rex_mediapool_mediaIsInUse(<span class="php-var">$filename</span>)) {
</span><span class="l" id="329">329         <span class="php-var">$msg</span> = <span class="php-quote">'&lt;strong&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_file_delete_error_1'</span>, <span class="php-var">$filename</span>) . <span class="php-quote">' '</span>
</span><span class="l" id="330">330             . rex_i18n::msg(<span class="php-quote">'pool_file_delete_error_2'</span>) . <span class="php-quote">'&lt;/strong&gt;&lt;br /&gt;'</span> . <span class="php-var">$uses</span>;
</span><span class="l" id="331">331         <span class="php-keyword1">return</span> [<span class="php-quote">'ok'</span> =&gt; <span class="php-keyword1">false</span>, <span class="php-quote">'msg'</span> =&gt; <span class="php-var">$msg</span>];
</span><span class="l" id="332">332     }
</span><span class="l" id="333">333 
</span><span class="l" id="334">334     <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="335">335     <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'DELETE FROM '</span> . rex::getTable(<span class="php-quote">'media'</span>) . <span class="php-quote">' WHERE filename = ? LIMIT 1'</span>, [<span class="php-var">$filename</span>]);
</span><span class="l" id="336">336 
</span><span class="l" id="337">337     rex_file::<span class="php-keyword2">delete</span>(rex_path::media(<span class="php-var">$filename</span>));
</span><span class="l" id="338">338 
</span><span class="l" id="339">339     rex_media_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$filename</span>);
</span><span class="l" id="340">340 
</span><span class="l" id="341">341     rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'MEDIA_DELETED'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="342">342         <span class="php-quote">'filename'</span> =&gt; <span class="php-var">$filename</span>,
</span><span class="l" id="343">343     ]));
</span><span class="l" id="344">344 
</span><span class="l" id="345">345     <span class="php-keyword1">return</span> [<span class="php-quote">'ok'</span> =&gt; <span class="php-keyword1">true</span>, <span class="php-quote">'msg'</span> =&gt; rex_i18n::msg(<span class="php-quote">'pool_file_deleted'</span>)];
</span><span class="l" id="346">346 }
</span><span class="l" id="347">347 
</span><span class="l" id="348">348 <span class="php-comment">/**
</span></span><span class="l" id="349">349 <span class="php-comment"> * @param $filename
</span></span><span class="l" id="350">350 <span class="php-comment"> *
</span></span><span class="l" id="351">351 <span class="php-comment"> * @return bool|string
</span></span><span class="l" id="352">352 <span class="php-comment"> */</span>
</span><span class="l" id="353">353 <span class="php-keyword1">function</span> rex_mediapool_mediaIsInUse(<span class="php-var">$filename</span>)
</span><span class="l" id="354">354 {
</span><span class="l" id="355">355     <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="356">356 
</span><span class="l" id="357">357     <span class="php-comment">// FIXME move structure stuff into structure addon</span>
</span><span class="l" id="358">358     <span class="php-var">$values</span> = [];
</span><span class="l" id="359">359     <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>; <span class="php-var">$i</span> &lt; <span class="php-num">21</span>; ++<span class="php-var">$i</span>) {
</span><span class="l" id="360">360         <span class="php-var">$values</span>[] = <span class="php-quote">'value'</span> . <span class="php-var">$i</span> . <span class="php-quote">' REGEXP '</span> . <span class="php-var">$sql</span>-&gt;escape(<span class="php-quote">'(^|[^[:alnum:]+_-])'</span>.<span class="php-var">$filename</span>);
</span><span class="l" id="361">361     }
</span><span class="l" id="362">362 
</span><span class="l" id="363">363     <span class="php-var">$files</span> = [];
</span><span class="l" id="364">364     <span class="php-var">$filelists</span> = [];
</span><span class="l" id="365">365     <span class="php-var">$escapedFilename</span> = <span class="php-var">$sql</span>-&gt;escape(<span class="php-var">$filename</span>);
</span><span class="l" id="366">366     <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>; <span class="php-var">$i</span> &lt; <span class="php-num">11</span>; ++<span class="php-var">$i</span>) {
</span><span class="l" id="367">367         <span class="php-var">$files</span>[] = <span class="php-quote">'media'</span> . <span class="php-var">$i</span> . <span class="php-quote">' = '</span> . <span class="php-var">$escapedFilename</span>;
</span><span class="l" id="368">368         <span class="php-var">$filelists</span>[] = <span class="php-quote">'FIND_IN_SET('</span> . <span class="php-var">$escapedFilename</span> . <span class="php-quote">', medialist'</span> . <span class="php-var">$i</span> . <span class="php-quote">')'</span>;
</span><span class="l" id="369">369     }
</span><span class="l" id="370">370 
</span><span class="l" id="371">371     <span class="php-var">$where</span> = <span class="php-quote">''</span>;
</span><span class="l" id="372">372     <span class="php-var">$where</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">' OR '</span>, <span class="php-var">$files</span>) . <span class="php-quote">' OR '</span>;
</span><span class="l" id="373">373     <span class="php-var">$where</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">' OR '</span>, <span class="php-var">$filelists</span>) . <span class="php-quote">' OR '</span>;
</span><span class="l" id="374">374     <span class="php-var">$where</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">' OR '</span>, <span class="php-var">$values</span>);
</span><span class="l" id="375">375     <span class="php-var">$query</span> = <span class="php-quote">'SELECT DISTINCT article_id, clang_id FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice WHERE '</span> . <span class="php-var">$where</span>;
</span><span class="l" id="376">376 
</span><span class="l" id="377">377     <span class="php-var">$warning</span> = [];
</span><span class="l" id="378">378     <span class="php-var">$res</span> = <span class="php-var">$sql</span>-&gt;getArray(<span class="php-var">$query</span>);
</span><span class="l" id="379">379     <span class="php-keyword1">if</span> (<span class="php-var">$sql</span>-&gt;getRows() &gt; <span class="php-num">0</span>) {
</span><span class="l" id="380">380         <span class="php-var">$warning</span>[<span class="php-num">0</span>] = rex_i18n::msg(<span class="php-quote">'pool_file_in_use_articles'</span>) . <span class="php-quote">'&lt;br /&gt;&lt;ul&gt;'</span>;
</span><span class="l" id="381">381         <span class="php-keyword1">foreach</span> (<span class="php-var">$res</span> <span class="php-keyword1">as</span> <span class="php-var">$art_arr</span>) {
</span><span class="l" id="382">382             <span class="php-var">$aid</span> = <span class="php-var">$art_arr</span>[<span class="php-quote">'article_id'</span>];
</span><span class="l" id="383">383             <span class="php-var">$clang</span> = <span class="php-var">$art_arr</span>[<span class="php-quote">'clang_id'</span>];
</span><span class="l" id="384">384             <span class="php-var">$ooa</span> = rex_article::get(<span class="php-var">$aid</span>, <span class="php-var">$clang</span>);
</span><span class="l" id="385">385             <span class="php-var">$name</span> = <span class="php-var">$ooa</span>-&gt;getName();
</span><span class="l" id="386">386             <span class="php-var">$warning</span>[<span class="php-num">0</span>] .= <span class="php-quote">'&lt;li&gt;&lt;a href="javascript:openPage(\''</span> . rex_url::backendPage(<span class="php-quote">'content'</span>, [<span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$aid</span>, <span class="php-quote">'mode'</span> =&gt; <span class="php-quote">'edit'</span>, <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>]) . <span class="php-quote">'\')"&gt;'</span> . <span class="php-var">$name</span> . <span class="php-quote">'&lt;/a&gt;&lt;/li&gt;'</span>;
</span><span class="l" id="387">387         }
</span><span class="l" id="388">388         <span class="php-var">$warning</span>[<span class="php-num">0</span>] .= <span class="php-quote">'&lt;/ul&gt;'</span>;
</span><span class="l" id="389">389     }
</span><span class="l" id="390">390 
</span><span class="l" id="391">391     <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="392">392     <span class="php-var">$warning</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'MEDIA_IS_IN_USE'</span>, <span class="php-var">$warning</span>, [
</span><span class="l" id="393">393         <span class="php-quote">'filename'</span> =&gt; <span class="php-var">$filename</span>,
</span><span class="l" id="394">394     ]));
</span><span class="l" id="395">395 
</span><span class="l" id="396">396     <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$warning</span>)) {
</span><span class="l" id="397">397         <span class="php-keyword1">return</span> <span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$warning</span>);
</span><span class="l" id="398">398     }
</span><span class="l" id="399">399 
</span><span class="l" id="400">400     <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="401">401 }
</span><span class="l" id="402">402 
</span><span class="l" id="403">403 <span class="php-comment">/**
</span></span><span class="l" id="404">404 <span class="php-comment"> * Ausgabe des Medienpool Formulars.
</span></span><span class="l" id="405">405 <span class="php-comment"> */</span>
</span><span class="l" id="406">406 <span class="php-keyword1">function</span> rex_mediapool_Mediaform(<span class="php-var">$form_title</span>, <span class="php-var">$button_title</span>, <span class="php-var">$rex_file_category</span>, <span class="php-var">$file_chooser</span>, <span class="php-var">$close_form</span>)
</span><span class="l" id="407">407 {
</span><span class="l" id="408">408     <span class="php-keyword1">global</span> <span class="php-var">$ftitle</span>, <span class="php-var">$warning</span>, <span class="php-var">$info</span>;
</span><span class="l" id="409">409 
</span><span class="l" id="410">410     <span class="php-var">$s</span> = <span class="php-quote">''</span>;
</span><span class="l" id="411">411 
</span><span class="l" id="412">412     <span class="php-var">$cats_sel</span> = <span class="php-keyword1">new</span> rex_media_category_select();
</span><span class="l" id="413">413     <span class="php-var">$cats_sel</span>-&gt;setStyle(<span class="php-quote">'class="form-control"'</span>);
</span><span class="l" id="414">414     <span class="php-var">$cats_sel</span>-&gt;setSize(<span class="php-num">1</span>);
</span><span class="l" id="415">415     <span class="php-var">$cats_sel</span>-&gt;setName(<span class="php-quote">'rex_file_category'</span>);
</span><span class="l" id="416">416     <span class="php-var">$cats_sel</span>-&gt;setId(<span class="php-quote">'rex-mediapool-category'</span>);
</span><span class="l" id="417">417     <span class="php-var">$cats_sel</span>-&gt;setAttribute(<span class="php-quote">'class'</span>, <span class="php-quote">'selectpicker form-control'</span>);
</span><span class="l" id="418">418     <span class="php-var">$cats_sel</span>-&gt;setAttribute(<span class="php-quote">'data-live-search'</span>, <span class="php-quote">'true'</span>);
</span><span class="l" id="419">419     <span class="php-var">$cats_sel</span>-&gt;setAttribute(<span class="php-quote">'onchange'</span>, <span class="php-quote">'this.form.submit()'</span>);
</span><span class="l" id="420">420     <span class="php-var">$cats_sel</span>-&gt;setSelected(<span class="php-var">$rex_file_category</span>);
</span><span class="l" id="421">421 
</span><span class="l" id="422">422     <span class="php-keyword1">if</span> (rex::getUser()-&gt;getComplexPerm(<span class="php-quote">'media'</span>)-&gt;hasAll()) {
</span><span class="l" id="423">423         <span class="php-var">$cats_sel</span>-&gt;addOption(rex_i18n::msg(<span class="php-quote">'pool_kats_no'</span>), <span class="php-quote">'0'</span>);
</span><span class="l" id="424">424     }
</span><span class="l" id="425">425 
</span><span class="l" id="426">426     <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$warning</span>)) {
</span><span class="l" id="427">427         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$warning</span>)) {
</span><span class="l" id="428">428             <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$warning</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="429">429                 <span class="php-var">$s</span> .= rex_view::error(<span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$warning</span>));
</span><span class="l" id="430">430             }
</span><span class="l" id="431">431         } <span class="php-keyword1">elseif</span> (<span class="php-var">$warning</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="432">432             <span class="php-var">$s</span> .= rex_view::error(<span class="php-var">$warning</span>);
</span><span class="l" id="433">433         }
</span><span class="l" id="434">434         <span class="php-var">$warning</span> = <span class="php-quote">''</span>;
</span><span class="l" id="435">435     }
</span><span class="l" id="436">436 
</span><span class="l" id="437">437     <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$info</span>)) {
</span><span class="l" id="438">438         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$info</span>)) {
</span><span class="l" id="439">439             <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$info</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="440">440                 <span class="php-var">$s</span> .= rex_view::success(<span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$info</span>));
</span><span class="l" id="441">441             }
</span><span class="l" id="442">442         } <span class="php-keyword1">elseif</span> (<span class="php-var">$info</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="443">443             <span class="php-var">$s</span> .= rex_view::success(<span class="php-var">$info</span>);
</span><span class="l" id="444">444         }
</span><span class="l" id="445">445         <span class="php-var">$info</span> = <span class="php-quote">''</span>;
</span><span class="l" id="446">446     }
</span><span class="l" id="447">447 
</span><span class="l" id="448">448     <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$ftitle</span>)) {
</span><span class="l" id="449">449         <span class="php-var">$ftitle</span> = <span class="php-quote">''</span>;
</span><span class="l" id="450">450     }
</span><span class="l" id="451">451 
</span><span class="l" id="452">452     <span class="php-var">$arg_fields</span> = <span class="php-quote">''</span>;
</span><span class="l" id="453">453     <span class="php-keyword1">foreach</span> (rex_request(<span class="php-quote">'args'</span>, <span class="php-quote">'array'</span>) <span class="php-keyword1">as</span> <span class="php-var">$arg_name</span> =&gt; <span class="php-var">$arg_value</span>) {
</span><span class="l" id="454">454         <span class="php-var">$arg_fields</span> .= <span class="php-quote">'&lt;input type="hidden" name="args['</span> . <span class="php-var">$arg_name</span> . <span class="php-quote">']" value="'</span> . <span class="php-var">$arg_value</span> . <span class="php-quote">'" /&gt;'</span> . <span class="php-quote">"\n"</span>;
</span><span class="l" id="455">455     }
</span><span class="l" id="456">456 
</span><span class="l" id="457">457     <span class="php-var">$opener_input_field</span> = rex_request(<span class="php-quote">'opener_input_field'</span>, <span class="php-quote">'string'</span>);
</span><span class="l" id="458">458     <span class="php-keyword1">if</span> (<span class="php-var">$opener_input_field</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="459">459         <span class="php-var">$arg_fields</span> .= <span class="php-quote">'&lt;input type="hidden" name="opener_input_field" value="'</span> . <span class="php-keyword2">htmlspecialchars</span>(<span class="php-var">$opener_input_field</span>) . <span class="php-quote">'" /&gt;'</span> . <span class="php-quote">"\n"</span>;
</span><span class="l" id="460">460     }
</span><span class="l" id="461">461 
</span><span class="l" id="462">462     <span class="php-var">$add_submit</span> = <span class="php-quote">''</span>;
</span><span class="l" id="463">463     <span class="php-keyword1">if</span> (<span class="php-var">$close_form</span> &amp;&amp; <span class="php-var">$opener_input_field</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="464">464         <span class="php-var">$add_submit</span> = <span class="php-quote">'&lt;button class="btn btn-save" type="submit" name="saveandexit" value="'</span> . rex_i18n::msg(<span class="php-quote">'pool_file_upload_get'</span>) . <span class="php-quote">'"'</span> . rex::getAccesskey(rex_i18n::msg(<span class="php-quote">'pool_file_upload_get'</span>), <span class="php-quote">'save'</span>) . <span class="php-quote">'&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_file_upload_get'</span>) . <span class="php-quote">'&lt;/button&gt;'</span>;
</span><span class="l" id="465">465     }
</span><span class="l" id="466">466 
</span><span class="l" id="467">467     <span class="php-var">$panel</span> = <span class="php-quote">''</span>;
</span><span class="l" id="468">468     <span class="php-var">$panel</span> .= <span class="php-quote">'&lt;fieldset&gt;'</span>;
</span><span class="l" id="469">469     <span class="php-var">$formElements</span> = [];
</span><span class="l" id="470">470 
</span><span class="l" id="471">471     <span class="php-var">$e</span> = [];
</span><span class="l" id="472">472     <span class="php-var">$e</span>[<span class="php-quote">'label'</span>] = <span class="php-quote">'&lt;label for="rex-mediapool-category"&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_file_category'</span>) . <span class="php-quote">'&lt;/label&gt;'</span>;
</span><span class="l" id="473">473     <span class="php-var">$e</span>[<span class="php-quote">'field'</span>] = <span class="php-var">$cats_sel</span>-&gt;get();
</span><span class="l" id="474">474     <span class="php-var">$formElements</span>[] = <span class="php-var">$e</span>;
</span><span class="l" id="475">475 
</span><span class="l" id="476">476     <span class="php-var">$e</span> = [];
</span><span class="l" id="477">477     <span class="php-var">$e</span>[<span class="php-quote">'label'</span>] = <span class="php-quote">'&lt;label for="rex-mediapool-title"&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_file_title'</span>) . <span class="php-quote">'&lt;/label&gt;'</span>;
</span><span class="l" id="478">478     <span class="php-var">$e</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;input class="form-control" type="text" id="rex-mediapool-title" name="ftitle" value="'</span> . <span class="php-keyword2">htmlspecialchars</span>(<span class="php-var">$ftitle</span>) . <span class="php-quote">'" /&gt;'</span>;
</span><span class="l" id="479">479     <span class="php-var">$formElements</span>[] = <span class="php-var">$e</span>;
</span><span class="l" id="480">480 
</span><span class="l" id="481">481     <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="482">482     <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'elements'</span>, <span class="php-var">$formElements</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="483">483     <span class="php-var">$panel</span> .= <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/form/form.php'</span>);
</span><span class="l" id="484">484 
</span><span class="l" id="485">485     <span class="php-var">$panel</span> .= rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'MEDIA_FORM_ADD'</span>, <span class="php-quote">''</span>));
</span><span class="l" id="486">486 
</span><span class="l" id="487">487     <span class="php-keyword1">if</span> (<span class="php-var">$file_chooser</span>) {
</span><span class="l" id="488">488         <span class="php-var">$e</span> = [];
</span><span class="l" id="489">489         <span class="php-var">$e</span>[<span class="php-quote">'label'</span>] = <span class="php-quote">'&lt;label for="rex-mediapool-choose-file"&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_file_file'</span>) . <span class="php-quote">'&lt;/label&gt;'</span>;
</span><span class="l" id="490">490         <span class="php-var">$e</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;input id="rex-mediapool-choose-file" type="file" name="file_new" /&gt;'</span>;
</span><span class="l" id="491">491         <span class="php-var">$e</span>[<span class="php-quote">'after'</span>] = <span class="php-quote">'&lt;h3&gt;'</span> . rex_i18n::msg(<span class="php-quote">'phpini_settings'</span>) . <span class="php-quote">'&lt;/h3&gt;
</span></span><span class="l" id="492">492 <span class="php-quote">                        &lt;dl class="dl-horizontal text-left"&gt;
</span></span><span class="l" id="493">493 <span class="php-quote">                        '</span> . ((rex_ini_get(<span class="php-quote">'file_uploads'</span>) == <span class="php-num">0</span>) ? <span class="php-quote">'&lt;dt&gt;&lt;span class="text-warning"&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_upload'</span>) . <span class="php-quote">'&lt;/span&gt;&lt;/dt&gt;&lt;dd&gt;&lt;span class="text-warning"&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_upload_disabled'</span>) . <span class="php-quote">'&lt;/span&gt;&lt;/dd&gt;'</span> : <span class="php-quote">''</span>) . <span class="php-quote">'
</span></span><span class="l" id="494">494 <span class="php-quote">                            &lt;dt&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_max_uploadsize'</span>) . <span class="php-quote">':&lt;/dt&gt;&lt;dd&gt;'</span> . rex_formatter::bytes(rex_ini_get(<span class="php-quote">'upload_max_filesize'</span>)) . <span class="php-quote">'&lt;/dd&gt;
</span></span><span class="l" id="495">495 <span class="php-quote">                            &lt;dt&gt;'</span> . rex_i18n::msg(<span class="php-quote">'pool_max_uploadtime'</span>) . <span class="php-quote">':&lt;/dt&gt;&lt;dd&gt;'</span> . rex_ini_get(<span class="php-quote">'max_input_time'</span>) . <span class="php-quote">'s&lt;/dd&gt;
</span></span><span class="l" id="496">496 <span class="php-quote">                        &lt;/dl&gt;'</span>;
</span><span class="l" id="497">497 
</span><span class="l" id="498">498         <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="499">499         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'elements'</span>, [<span class="php-var">$e</span>], <span class="php-keyword1">false</span>);
</span><span class="l" id="500">500         <span class="php-var">$panel</span> .= <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/form/form.php'</span>);
</span><span class="l" id="501">501     }
</span><span class="l" id="502">502     <span class="php-var">$panel</span> .= <span class="php-quote">'&lt;/fieldset&gt;'</span>;
</span><span class="l" id="503">503 
</span><span class="l" id="504">504     <span class="php-var">$formElements</span> = [];
</span><span class="l" id="505">505 
</span><span class="l" id="506">506     <span class="php-var">$e</span> = [];
</span><span class="l" id="507">507     <span class="php-var">$e</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;button class="btn btn-save rex-form-aligned" type="submit" name="save" value="'</span> . <span class="php-var">$button_title</span> . <span class="php-quote">'"'</span> . rex::getAccesskey(<span class="php-var">$button_title</span>, <span class="php-quote">'save'</span>) . <span class="php-quote">'&gt;'</span> . <span class="php-var">$button_title</span> . <span class="php-quote">'&lt;/button&gt;'</span>;
</span><span class="l" id="508">508     <span class="php-var">$formElements</span>[] = <span class="php-var">$e</span>;
</span><span class="l" id="509">509 
</span><span class="l" id="510">510     <span class="php-var">$e</span> = [];
</span><span class="l" id="511">511     <span class="php-var">$e</span>[<span class="php-quote">'field'</span>] = <span class="php-var">$add_submit</span>;
</span><span class="l" id="512">512     <span class="php-var">$formElements</span>[] = <span class="php-var">$e</span>;
</span><span class="l" id="513">513 
</span><span class="l" id="514">514     <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="515">515     <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'elements'</span>, <span class="php-var">$formElements</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="516">516     <span class="php-var">$buttons</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/form/submit.php'</span>);
</span><span class="l" id="517">517 
</span><span class="l" id="518">518     <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="519">519     <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'class'</span>, <span class="php-quote">'edit'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="520">520     <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'title'</span>, <span class="php-var">$form_title</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="521">521     <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'body'</span>, <span class="php-var">$panel</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="522">522     <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'buttons'</span>, <span class="php-var">$buttons</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="523">523     <span class="php-var">$content</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/page/section.php'</span>);
</span><span class="l" id="524">524 
</span><span class="l" id="525">525     <span class="php-var">$s</span> .= <span class="php-quote">' &lt;form action="'</span> . rex_url::currentBackendPage() . <span class="php-quote">'" method="post" enctype="multipart/form-data"&gt;
</span></span><span class="l" id="526">526 <span class="php-quote">                '</span> . rex_csrf_token::factory(<span class="php-quote">'mediapool'</span>)-&gt;getHiddenField() . <span class="php-quote">'
</span></span><span class="l" id="527">527 <span class="php-quote">                &lt;fieldset&gt;
</span></span><span class="l" id="528">528 <span class="php-quote">                    &lt;input type="hidden" name="media_method" value="add_file" /&gt;
</span></span><span class="l" id="529">529 <span class="php-quote">                    '</span> . <span class="php-var">$arg_fields</span> . <span class="php-quote">'
</span></span><span class="l" id="530">530 <span class="php-quote">                    '</span> . <span class="php-var">$content</span> . <span class="php-quote">'
</span></span><span class="l" id="531">531 <span class="php-quote">                &lt;/fieldset&gt;
</span></span><span class="l" id="532">532 <span class="php-quote">            '</span>;
</span><span class="l" id="533">533 
</span><span class="l" id="534">534     <span class="php-keyword1">if</span> (<span class="php-var">$close_form</span>) {
</span><span class="l" id="535">535         <span class="php-var">$s</span> .= <span class="php-quote">'&lt;/form&gt;'</span> . <span class="php-quote">"\n"</span>;
</span><span class="l" id="536">536     }
</span><span class="l" id="537">537 
</span><span class="l" id="538">538     <span class="php-keyword1">return</span> <span class="php-var">$s</span>;
</span><span class="l" id="539">539 }
</span><span class="l" id="540">540 
</span><span class="l" id="541">541 <span class="php-comment">/**
</span></span><span class="l" id="542">542 <span class="php-comment"> * Ausgabe des Medienpool Upload-Formulars.
</span></span><span class="l" id="543">543 <span class="php-comment"> */</span>
</span><span class="l" id="544">544 <span class="php-keyword1">function</span> rex_mediapool_Uploadform(<span class="php-var">$rex_file_category</span>)
</span><span class="l" id="545">545 {
</span><span class="l" id="546">546     <span class="php-keyword1">return</span> rex_mediapool_Mediaform(rex_i18n::msg(<span class="php-quote">'pool_file_insert'</span>), rex_i18n::msg(<span class="php-quote">'pool_file_upload'</span>), <span class="php-var">$rex_file_category</span>, <span class="php-keyword1">true</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="547">547 }
</span><span class="l" id="548">548 
</span><span class="l" id="549">549 <span class="php-comment">/**
</span></span><span class="l" id="550">550 <span class="php-comment"> * Ausgabe des Medienpool Sync-Formulars.
</span></span><span class="l" id="551">551 <span class="php-comment"> */</span>
</span><span class="l" id="552">552 <span class="php-keyword1">function</span> rex_mediapool_Syncform(<span class="php-var">$rex_file_category</span>)
</span><span class="l" id="553">553 {
</span><span class="l" id="554">554     <span class="php-keyword1">return</span> rex_mediapool_Mediaform(rex_i18n::msg(<span class="php-quote">'pool_sync_title'</span>), rex_i18n::msg(<span class="php-quote">'pool_sync_button'</span>), <span class="php-var">$rex_file_category</span>, <span class="php-keyword1">false</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="555">555 }
</span><span class="l" id="556">556 
</span><span class="l" id="557">557 <span class="php-comment">/**
</span></span><span class="l" id="558">558 <span class="php-comment"> * check if mediatpye(extension) is allowed for upload.
</span></span><span class="l" id="559">559 <span class="php-comment"> *
</span></span><span class="l" id="560">560 <span class="php-comment"> * @param string $filename
</span></span><span class="l" id="561">561 <span class="php-comment"> * @param array  $args
</span></span><span class="l" id="562">562 <span class="php-comment"> *
</span></span><span class="l" id="563">563 <span class="php-comment"> * @return bool
</span></span><span class="l" id="564">564 <span class="php-comment"> */</span>
</span><span class="l" id="565">565 <span class="php-keyword1">function</span> rex_mediapool_isAllowedMediaType(<span class="php-var">$filename</span>, <span class="php-keyword1">array</span> <span class="php-var">$args</span> = [])
</span><span class="l" id="566">566 {
</span><span class="l" id="567">567     <span class="php-var">$file_ext</span> = <span class="php-keyword2">mb_strtolower</span>(rex_file::extension(<span class="php-var">$filename</span>));
</span><span class="l" id="568">568 
</span><span class="l" id="569">569     <span class="php-keyword1">if</span> (<span class="php-var">$filename</span> === <span class="php-quote">''</span> || <span class="php-keyword2">strpos</span>(<span class="php-var">$file_ext</span>, <span class="php-quote">' '</span>) !== <span class="php-keyword1">false</span> || <span class="php-var">$file_ext</span> === <span class="php-quote">''</span>) {
</span><span class="l" id="570">570         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="571">571     }
</span><span class="l" id="572">572 
</span><span class="l" id="573">573     <span class="php-var">$blacklist</span> = rex_mediapool_getMediaTypeBlacklist();
</span><span class="l" id="574">574     <span class="php-var">$whitelist</span> = rex_mediapool_getMediaTypeWhitelist(<span class="php-var">$args</span>);
</span><span class="l" id="575">575 
</span><span class="l" id="576">576     <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$file_ext</span>, <span class="php-var">$blacklist</span>)) {
</span><span class="l" id="577">577         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="578">578     }
</span><span class="l" id="579">579     <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$whitelist</span>) &gt; <span class="php-num">0</span> &amp;&amp; !<span class="php-keyword2">in_array</span>(<span class="php-var">$file_ext</span>, <span class="php-var">$whitelist</span>)) {
</span><span class="l" id="580">580         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="581">581     }
</span><span class="l" id="582">582     <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="583">583 }
</span><span class="l" id="584">584 
</span><span class="l" id="585">585 <span class="php-comment">/**
</span></span><span class="l" id="586">586 <span class="php-comment"> * get whitelist of mediatypes(extensions) given via media widget "types" param.
</span></span><span class="l" id="587">587 <span class="php-comment"> *
</span></span><span class="l" id="588">588 <span class="php-comment"> * @param array $args widget params
</span></span><span class="l" id="589">589 <span class="php-comment"> *
</span></span><span class="l" id="590">590 <span class="php-comment"> * @return array whitelisted extensions
</span></span><span class="l" id="591">591 <span class="php-comment"> */</span>
</span><span class="l" id="592">592 <span class="php-keyword1">function</span> rex_mediapool_getMediaTypeWhitelist(<span class="php-var">$args</span> = [])
</span><span class="l" id="593">593 {
</span><span class="l" id="594">594     <span class="php-var">$blacklist</span> = rex_mediapool_getMediaTypeBlacklist();
</span><span class="l" id="595">595 
</span><span class="l" id="596">596     <span class="php-var">$whitelist</span> = [];
</span><span class="l" id="597">597     <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$args</span>[<span class="php-quote">'types'</span>])) {
</span><span class="l" id="598">598         <span class="php-keyword1">foreach</span> (<span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-var">$args</span>[<span class="php-quote">'types'</span>]) <span class="php-keyword1">as</span> <span class="php-var">$ext</span>) {
</span><span class="l" id="599">599             <span class="php-var">$ext</span> = <span class="php-keyword2">ltrim</span>(<span class="php-var">$ext</span>, <span class="php-quote">'.'</span>);
</span><span class="l" id="600">600             <span class="php-var">$ext</span> = <span class="php-keyword2">mb_strtolower</span>(<span class="php-var">$ext</span>);
</span><span class="l" id="601">601             <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$ext</span>, <span class="php-var">$blacklist</span>)) { <span class="php-comment">// whitelist cannot override any blacklist entry from master</span>
</span><span class="l" id="602">602                 <span class="php-var">$whitelist</span>[] = <span class="php-var">$ext</span>;
</span><span class="l" id="603">603             }
</span><span class="l" id="604">604         }
</span><span class="l" id="605">605     }
</span><span class="l" id="606">606     <span class="php-keyword1">return</span> <span class="php-var">$whitelist</span>;
</span><span class="l" id="607">607 }
</span><span class="l" id="608">608 
</span><span class="l" id="609">609 <span class="php-comment">/**
</span></span><span class="l" id="610">610 <span class="php-comment"> * return global mediatype blacklist from master.inc.
</span></span><span class="l" id="611">611 <span class="php-comment"> *
</span></span><span class="l" id="612">612 <span class="php-comment"> * @return array blacklisted mediatype extensions
</span></span><span class="l" id="613">613 <span class="php-comment"> */</span>
</span><span class="l" id="614">614 <span class="php-keyword1">function</span> rex_mediapool_getMediaTypeBlacklist()
</span><span class="l" id="615">615 {
</span><span class="l" id="616">616     <span class="php-keyword1">return</span> rex_addon::get(<span class="php-quote">'mediapool'</span>)-&gt;getProperty(<span class="php-quote">'blocked_extensions'</span>);
</span><span class="l" id="617">617 }
</span><span class="l" id="618">618 </span></code></pre>
 </body>
</html>
