<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">   1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">   2 
</span><span class="l" id="3">   3 <span class="php-comment">/**
</span></span><span class="l" id="4">   4 <span class="php-comment"> * Klasse zur Verbindung und Interatkion mit der Datenbank.
</span></span><span class="l" id="5">   5 <span class="php-comment"> *
</span></span><span class="l" id="6">   6 <span class="php-comment"> * see http://net.tutsplus.com/tutorials/php/why-you-should-be-using-phps-pdo-for-database-access/
</span></span><span class="l" id="7">   7 <span class="php-comment"> *
</span></span><span class="l" id="8">   8 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="9">   9 <span class="php-comment"> */</span>
</span><span class="l" id="10">  10 <span class="php-keyword1">class</span> rex_sql <span class="php-keyword1">implements</span> Iterator
</span><span class="l" id="11">  11 {
</span><span class="l" id="12">  12     <span class="php-keyword1">use</span> rex_factory_trait;
</span><span class="l" id="13">  13 
</span><span class="l" id="14">  14     <span class="php-comment">/**
</span></span><span class="l" id="15">  15 <span class="php-comment">     * Default SQL datetime format.
</span></span><span class="l" id="16">  16 <span class="php-comment">     */</span>
</span><span class="l" id="17">  17     <span class="php-keyword1">const</span> FORMAT_DATETIME = <span class="php-quote">'Y-m-d H:i:s'</span>;
</span><span class="l" id="18">  18 
</span><span class="l" id="19">  19     <span class="php-comment">/**
</span></span><span class="l" id="20">  20 <span class="php-comment">     * Controls query buffering.
</span></span><span class="l" id="21">  21 <span class="php-comment">     *
</span></span><span class="l" id="22">  22 <span class="php-comment">     * View `PDO::MYSQL_ATTR_USE_BUFFERED_QUERY` for more details.
</span></span><span class="l" id="23">  23 <span class="php-comment">     */</span>
</span><span class="l" id="24">  24     <span class="php-keyword1">const</span> OPT_BUFFERED = <span class="php-quote">'buffered'</span>;
</span><span class="l" id="25">  25 
</span><span class="l" id="26">  26     <span class="php-keyword1">protected</span> <span class="php-var">$debug</span>; <span class="php-comment">// debug schalter</span>
</span><span class="l" id="27">  27     <span class="php-keyword1">protected</span> <span class="php-var">$values</span>; <span class="php-comment">// Werte von setValue</span>
</span><span class="l" id="28">  28     <span class="php-keyword1">protected</span> <span class="php-var">$rawValues</span>; <span class="php-comment">// Werte von setRawValue</span>
</span><span class="l" id="29">  29     <span class="php-keyword1">protected</span> <span class="php-var">$fieldnames</span>; <span class="php-comment">// Spalten im ResultSet</span>
</span><span class="l" id="30">  30     <span class="php-keyword1">protected</span> <span class="php-var">$rawFieldnames</span>;
</span><span class="l" id="31">  31     <span class="php-keyword1">protected</span> <span class="php-var">$tablenames</span>; <span class="php-comment">// Tabelle im ResultSet</span>
</span><span class="l" id="32">  32     <span class="php-keyword1">protected</span> <span class="php-var">$lastRow</span>; <span class="php-comment">// Wert der zuletzt gefetchten zeile</span>
</span><span class="l" id="33">  33     <span class="php-keyword1">protected</span> <span class="php-var">$table</span>; <span class="php-comment">// Tabelle setzen</span>
</span><span class="l" id="34">  34     <span class="php-keyword1">protected</span> <span class="php-var">$wherevar</span>; <span class="php-comment">// WHERE Bediengung</span>
</span><span class="l" id="35">  35     <span class="php-keyword1">protected</span> <span class="php-var">$whereParams</span>; <span class="php-comment">// WHERE parameter array</span>
</span><span class="l" id="36">  36     <span class="php-keyword1">protected</span> <span class="php-var">$rows</span>; <span class="php-comment">// anzahl der treffer</span>
</span><span class="l" id="37">  37     <span class="php-keyword1">protected</span> <span class="php-var">$counter</span>; <span class="php-comment">// pointer</span>
</span><span class="l" id="38">  38     <span class="php-keyword1">protected</span> <span class="php-var">$query</span>; <span class="php-comment">// Die Abfrage</span>
</span><span class="l" id="39">  39     <span class="php-keyword1">protected</span> <span class="php-var">$params</span>; <span class="php-comment">// Die Abfrage-Parameter</span>
</span><span class="l" id="40">  40     <span class="php-keyword1">protected</span> <span class="php-var">$DBID</span>; <span class="php-comment">// ID der Verbindung</span>
</span><span class="l" id="41">  41 
</span><span class="l" id="42">  42     <span class="php-comment">/** @var self[] */</span>
</span><span class="l" id="43">  43     <span class="php-keyword1">protected</span> <span class="php-var">$records</span>;
</span><span class="l" id="44">  44 
</span><span class="l" id="45">  45     <span class="php-comment">/**
</span></span><span class="l" id="46">  46 <span class="php-comment">     * @var PDOStatement
</span></span><span class="l" id="47">  47 <span class="php-comment">     */</span>
</span><span class="l" id="48">  48     <span class="php-keyword1">protected</span> <span class="php-var">$stmt</span>;
</span><span class="l" id="49">  49 
</span><span class="l" id="50">  50     <span class="php-comment">/**
</span></span><span class="l" id="51">  51 <span class="php-comment">     * @var PDO[]
</span></span><span class="l" id="52">  52 <span class="php-comment">     */</span>
</span><span class="l" id="53">  53     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$pdo</span> = [];
</span><span class="l" id="54">  54 
</span><span class="l" id="55">  55     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> __construct(<span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="56">  56     {
</span><span class="l" id="57">  57         <span class="php-var">$this</span>-&gt;debug = <span class="php-keyword1">false</span>;
</span><span class="l" id="58">  58         <span class="php-var">$this</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span class="l" id="59">  59         <span class="php-var">$this</span>-&gt;selectDB(<span class="php-var">$DBID</span>);
</span><span class="l" id="60">  60     }
</span><span class="l" id="61">  61 
</span><span class="l" id="62">  62     <span class="php-comment">/**
</span></span><span class="l" id="63">  63 <span class="php-comment">     * Stellt die Verbindung zur Datenbank her.
</span></span><span class="l" id="64">  64 <span class="php-comment">     */</span>
</span><span class="l" id="65">  65     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> selectDB(<span class="php-var">$DBID</span>)
</span><span class="l" id="66">  66     {
</span><span class="l" id="67">  67         <span class="php-var">$this</span>-&gt;DBID = <span class="php-var">$DBID</span>;
</span><span class="l" id="68">  68 
</span><span class="l" id="69">  69         <span class="php-keyword1">try</span> {
</span><span class="l" id="70">  70             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>])) {
</span><span class="l" id="71">  71                 <span class="php-var">$dbconfig</span> = rex::getProperty(<span class="php-quote">'db'</span>);
</span><span class="l" id="72">  72                 <span class="php-var">$conn</span> = self::createConnection(
</span><span class="l" id="73">  73                     <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'host'</span>],
</span><span class="l" id="74">  74                     <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'name'</span>],
</span><span class="l" id="75">  75                     <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'login'</span>],
</span><span class="l" id="76">  76                     <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'password'</span>],
</span><span class="l" id="77">  77                     <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'persistent'</span>]
</span><span class="l" id="78">  78                 );
</span><span class="l" id="79">  79                 self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>] = <span class="php-var">$conn</span>;
</span><span class="l" id="80">  80 
</span><span class="l" id="81">  81                 <span class="php-comment">// ggf. Strict Mode abschalten</span>
</span><span class="l" id="82">  82                 <span class="php-var">$this</span>-&gt;setQuery(<span class="php-quote">'SET SESSION SQL_MODE="", NAMES utf8mb4'</span>);
</span><span class="l" id="83">  83             }
</span><span class="l" id="84">  84         } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="85">  85             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Could not connect to database'</span>, <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="86">  86         }
</span><span class="l" id="87">  87     }
</span><span class="l" id="88">  88 
</span><span class="l" id="89">  89     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> createConnection(<span class="php-var">$host</span>, <span class="php-var">$database</span>, <span class="php-var">$login</span>, <span class="php-var">$password</span>, <span class="php-var">$persistent</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="90">  90     {
</span><span class="l" id="91">  91         <span class="php-keyword1">if</span> (!<span class="php-var">$database</span>) {
</span><span class="l" id="92">  92             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Database name can not be empty.'</span>);
</span><span class="l" id="93">  93         }
</span><span class="l" id="94">  94 
</span><span class="l" id="95">  95         <span class="php-var">$dsn</span> = <span class="php-quote">'mysql:host='</span> . <span class="php-var">$host</span> . <span class="php-quote">';dbname='</span> . <span class="php-var">$database</span>;
</span><span class="l" id="96">  96         <span class="php-var">$options</span> = [
</span><span class="l" id="97">  97             PDO::ATTR_PERSISTENT =&gt; (bool) <span class="php-var">$persistent</span>,
</span><span class="l" id="98">  98             PDO::ATTR_FETCH_TABLE_NAMES =&gt; <span class="php-keyword1">true</span>,
</span><span class="l" id="99">  99             <span class="php-comment">// PDO::ATTR_CURSOR =&gt; PDO::CURSOR_SCROLL,</span>
</span><span class="l" id="100"> 100             <span class="php-comment">// PDO::ATTR_EMULATE_PREPARES =&gt; true,</span>
</span><span class="l" id="101"> 101         ];
</span><span class="l" id="102"> 102 
</span><span class="l" id="103"> 103         <span class="php-var">$dbh</span> = @<span class="php-keyword1">new</span> PDO(<span class="php-var">$dsn</span>, <span class="php-var">$login</span>, <span class="php-var">$password</span>, <span class="php-var">$options</span>);
</span><span class="l" id="104"> 104         <span class="php-var">$dbh</span>-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</span><span class="l" id="105"> 105         <span class="php-keyword1">return</span> <span class="php-var">$dbh</span>;
</span><span class="l" id="106"> 106     }
</span><span class="l" id="107"> 107 
</span><span class="l" id="108"> 108     <span class="php-comment">/**
</span></span><span class="l" id="109"> 109 <span class="php-comment">     * Gibt die DatenbankId der Abfrage (SQL) zurueck,
</span></span><span class="l" id="110"> 110 <span class="php-comment">     * oder false wenn die Abfrage keine DBID enthaelt.
</span></span><span class="l" id="111"> 111 <span class="php-comment">     *
</span></span><span class="l" id="112"> 112 <span class="php-comment">     * @param string $qry
</span></span><span class="l" id="113"> 113 <span class="php-comment">     *
</span></span><span class="l" id="114"> 114 <span class="php-comment">     * @return bool
</span></span><span class="l" id="115"> 115 <span class="php-comment">     */</span>
</span><span class="l" id="116"> 116     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getQueryDBID(<span class="php-var">$qry</span>)
</span><span class="l" id="117"> 117     {
</span><span class="l" id="118"> 118         <span class="php-var">$qry</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>);
</span><span class="l" id="119"> 119 
</span><span class="l" id="120"> 120         <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/\(DB([1-9]){1}\)/i'</span>, <span class="php-var">$qry</span>, <span class="php-var">$matches</span>)) {
</span><span class="l" id="121"> 121             <span class="php-keyword1">return</span> <span class="php-var">$matches</span>[<span class="php-num">1</span>];
</span><span class="l" id="122"> 122         }
</span><span class="l" id="123"> 123 
</span><span class="l" id="124"> 124         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="125"> 125     }
</span><span class="l" id="126"> 126 
</span><span class="l" id="127"> 127     <span class="php-comment">/**
</span></span><span class="l" id="128"> 128 <span class="php-comment">     * Entfernt die DBID aus einer Abfrage (SQL) und gibt die DBID zurueck falls
</span></span><span class="l" id="129"> 129 <span class="php-comment">     * vorhanden, sonst false.
</span></span><span class="l" id="130"> 130 <span class="php-comment">     *
</span></span><span class="l" id="131"> 131 <span class="php-comment">     * @param string $qry Abfrage
</span></span><span class="l" id="132"> 132 <span class="php-comment">     *
</span></span><span class="l" id="133"> 133 <span class="php-comment">     * @return string
</span></span><span class="l" id="134"> 134 <span class="php-comment">     */</span>
</span><span class="l" id="135"> 135     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> stripQueryDBID(&amp;<span class="php-var">$qry</span>)
</span><span class="l" id="136"> 136     {
</span><span class="l" id="137"> 137         <span class="php-var">$qry</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>);
</span><span class="l" id="138"> 138 
</span><span class="l" id="139"> 139         <span class="php-keyword1">if</span> ((<span class="php-var">$qryDBID</span> = self::getQueryDBID(<span class="php-var">$qry</span>)) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="140"> 140             <span class="php-var">$qry</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$qry</span>, <span class="php-num">6</span>);
</span><span class="l" id="141"> 141         }
</span><span class="l" id="142"> 142 
</span><span class="l" id="143"> 143         <span class="php-keyword1">return</span> <span class="php-var">$qryDBID</span>;
</span><span class="l" id="144"> 144     }
</span><span class="l" id="145"> 145 
</span><span class="l" id="146"> 146     <span class="php-comment">/**
</span></span><span class="l" id="147"> 147 <span class="php-comment">     * Gibt den Typ der Abfrage (SQL) zurueck,
</span></span><span class="l" id="148"> 148 <span class="php-comment">     * oder false wenn die Abfrage keinen Typ enthaelt.
</span></span><span class="l" id="149"> 149 <span class="php-comment">     *
</span></span><span class="l" id="150"> 150 <span class="php-comment">     * Moegliche Typen:
</span></span><span class="l" id="151"> 151 <span class="php-comment">     * - SELECT
</span></span><span class="l" id="152"> 152 <span class="php-comment">     * - SHOW
</span></span><span class="l" id="153"> 153 <span class="php-comment">     * - UPDATE
</span></span><span class="l" id="154"> 154 <span class="php-comment">     * - INSERT
</span></span><span class="l" id="155"> 155 <span class="php-comment">     * - DELETE
</span></span><span class="l" id="156"> 156 <span class="php-comment">     * - REPLACE
</span></span><span class="l" id="157"> 157 <span class="php-comment">     * - CREATE
</span></span><span class="l" id="158"> 158 <span class="php-comment">     * - CALL
</span></span><span class="l" id="159"> 159 <span class="php-comment">     * - OPTIMIZE
</span></span><span class="l" id="160"> 160 <span class="php-comment">     *
</span></span><span class="l" id="161"> 161 <span class="php-comment">     * @param string $qry
</span></span><span class="l" id="162"> 162 <span class="php-comment">     *
</span></span><span class="l" id="163"> 163 <span class="php-comment">     * @return bool|string
</span></span><span class="l" id="164"> 164 <span class="php-comment">     */</span>
</span><span class="l" id="165"> 165     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getQueryType(<span class="php-var">$qry</span>)
</span><span class="l" id="166"> 166     {
</span><span class="l" id="167"> 167         <span class="php-var">$qry</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>);
</span><span class="l" id="168"> 168         <span class="php-comment">// DBID aus dem Query herausschneiden, falls vorhanden</span>
</span><span class="l" id="169"> 169         self::stripQueryDBID(<span class="php-var">$qry</span>);
</span><span class="l" id="170"> 170 
</span><span class="l" id="171"> 171         <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^(SELECT|SHOW|UPDATE|INSERT|DELETE|REPLACE|CREATE|CALL|OPTIMIZE)/i'</span>, <span class="php-var">$qry</span>, <span class="php-var">$matches</span>)) {
</span><span class="l" id="172"> 172             <span class="php-keyword1">return</span> <span class="php-keyword2">strtoupper</span>(<span class="php-var">$matches</span>[<span class="php-num">1</span>]);
</span><span class="l" id="173"> 173         }
</span><span class="l" id="174"> 174 
</span><span class="l" id="175"> 175         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="176"> 176     }
</span><span class="l" id="177"> 177 
</span><span class="l" id="178"> 178     <span class="php-comment">/**
</span></span><span class="l" id="179"> 179 <span class="php-comment">     * Returns a datetime string in sql datetime format (Y-m-d H:i:s) using the given timestamp or the current time
</span></span><span class="l" id="180"> 180 <span class="php-comment">     * if no timestamp (or `null`) is given.
</span></span><span class="l" id="181"> 181 <span class="php-comment">     *
</span></span><span class="l" id="182"> 182 <span class="php-comment">     * @param int|null $timestamp
</span></span><span class="l" id="183"> 183 <span class="php-comment">     *
</span></span><span class="l" id="184"> 184 <span class="php-comment">     * @return string
</span></span><span class="l" id="185"> 185 <span class="php-comment">     */</span>
</span><span class="l" id="186"> 186     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> datetime(<span class="php-var">$timestamp</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="187"> 187     {
</span><span class="l" id="188"> 188         <span class="php-keyword1">return</span> <span class="php-keyword2">date</span>(self::FORMAT_DATETIME, <span class="php-keyword1">null</span> === <span class="php-var">$timestamp</span> ? <span class="php-keyword2">time</span>() : <span class="php-var">$timestamp</span>);
</span><span class="l" id="189"> 189     }
</span><span class="l" id="190"> 190 
</span><span class="l" id="191"> 191     <span class="php-comment">/**
</span></span><span class="l" id="192"> 192 <span class="php-comment">     * Setzt eine Abfrage (SQL) ab, wechselt die DBID falls vorhanden.
</span></span><span class="l" id="193"> 193 <span class="php-comment">     *
</span></span><span class="l" id="194"> 194 <span class="php-comment">     * @param string $query   The sql-query
</span></span><span class="l" id="195"> 195 <span class="php-comment">     * @param array  $params  An optional array of statement parameter
</span></span><span class="l" id="196"> 196 <span class="php-comment">     * @param array  $options For possible option keys view `rex_sql::OPT_*` constants
</span></span><span class="l" id="197"> 197 <span class="php-comment">     *
</span></span><span class="l" id="198"> 198 <span class="php-comment">     * @return $this
</span></span><span class="l" id="199"> 199 <span class="php-comment">     *
</span></span><span class="l" id="200"> 200 <span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="201"> 201 <span class="php-comment">     */</span>
</span><span class="l" id="202"> 202     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setDBQuery(<span class="php-var">$query</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-keyword1">array</span> <span class="php-var">$options</span> = [])
</span><span class="l" id="203"> 203     {
</span><span class="l" id="204"> 204         <span class="php-comment">// save origin connection-id</span>
</span><span class="l" id="205"> 205         <span class="php-var">$oldDBID</span> = <span class="php-var">$this</span>-&gt;DBID;
</span><span class="l" id="206"> 206 
</span><span class="l" id="207"> 207         <span class="php-comment">// change connection-id but only for this one query</span>
</span><span class="l" id="208"> 208         <span class="php-keyword1">if</span> ((<span class="php-var">$qryDBID</span> = self::stripQueryDBID(<span class="php-var">$query</span>)) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="209"> 209             <span class="php-var">$this</span>-&gt;selectDB(<span class="php-var">$qryDBID</span>);
</span><span class="l" id="210"> 210         }
</span><span class="l" id="211"> 211 
</span><span class="l" id="212"> 212         <span class="php-var">$this</span>-&gt;setQuery(<span class="php-var">$query</span>, <span class="php-var">$params</span>, <span class="php-var">$options</span>);
</span><span class="l" id="213"> 213 
</span><span class="l" id="214"> 214         <span class="php-comment">// restore connection-id</span>
</span><span class="l" id="215"> 215         <span class="php-var">$this</span>-&gt;DBID = <span class="php-var">$oldDBID</span>;
</span><span class="l" id="216"> 216 
</span><span class="l" id="217"> 217         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="218"> 218     }
</span><span class="l" id="219"> 219 
</span><span class="l" id="220"> 220     <span class="php-comment">/**
</span></span><span class="l" id="221"> 221 <span class="php-comment">     * Setzt Debugmodus an/aus.
</span></span><span class="l" id="222"> 222 <span class="php-comment">     *
</span></span><span class="l" id="223"> 223 <span class="php-comment">     * @param bool $debug Debug TRUE/FALSE
</span></span><span class="l" id="224"> 224 <span class="php-comment">     *
</span></span><span class="l" id="225"> 225 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="226"> 226 <span class="php-comment">     */</span>
</span><span class="l" id="227"> 227     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setDebug(<span class="php-var">$debug</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="228"> 228     {
</span><span class="l" id="229"> 229         <span class="php-var">$this</span>-&gt;debug = <span class="php-var">$debug</span>;
</span><span class="l" id="230"> 230 
</span><span class="l" id="231"> 231         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="232"> 232     }
</span><span class="l" id="233"> 233 
</span><span class="l" id="234"> 234     <span class="php-comment">/**
</span></span><span class="l" id="235"> 235 <span class="php-comment">     * Prepares a PDOStatement.
</span></span><span class="l" id="236"> 236 <span class="php-comment">     *
</span></span><span class="l" id="237"> 237 <span class="php-comment">     * @param string $qry A query string with placeholders
</span></span><span class="l" id="238"> 238 <span class="php-comment">     *
</span></span><span class="l" id="239"> 239 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="240"> 240 <span class="php-comment">     *
</span></span><span class="l" id="241"> 241 <span class="php-comment">     * @return PDOStatement The prepared statement
</span></span><span class="l" id="242"> 242 <span class="php-comment">     */</span>
</span><span class="l" id="243"> 243     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> prepareQuery(<span class="php-var">$qry</span>)
</span><span class="l" id="244"> 244     {
</span><span class="l" id="245"> 245         <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="246"> 246         <span class="php-keyword1">try</span> {
</span><span class="l" id="247"> 247             <span class="php-var">$this</span>-&gt;query = <span class="php-var">$qry</span>;
</span><span class="l" id="248"> 248             <span class="php-var">$this</span>-&gt;stmt = <span class="php-var">$pdo</span>-&gt;prepare(<span class="php-var">$qry</span>);
</span><span class="l" id="249"> 249             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt;
</span><span class="l" id="250"> 250         } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="251"> 251             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while preparing statement "'</span> . <span class="php-var">$qry</span> . <span class="php-quote">'"! '</span> . <span class="php-var">$e</span>-&gt;getMessage(), <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="252"> 252         }
</span><span class="l" id="253"> 253     }
</span><span class="l" id="254"> 254 
</span><span class="l" id="255"> 255     <span class="php-comment">/**
</span></span><span class="l" id="256"> 256 <span class="php-comment">     * Executes the prepared statement with the given input parameters.
</span></span><span class="l" id="257"> 257 <span class="php-comment">     *
</span></span><span class="l" id="258"> 258 <span class="php-comment">     * @param array $params  Array of input parameters
</span></span><span class="l" id="259"> 259 <span class="php-comment">     * @param array $options For possible option keys view `rex_sql::OPT_*` constants
</span></span><span class="l" id="260"> 260 <span class="php-comment">     *
</span></span><span class="l" id="261"> 261 <span class="php-comment">     * @return $this
</span></span><span class="l" id="262"> 262 <span class="php-comment">     *
</span></span><span class="l" id="263"> 263 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="264"> 264 <span class="php-comment">     */</span>
</span><span class="l" id="265"> 265     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> execute(<span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-keyword1">array</span> <span class="php-var">$options</span> = [])
</span><span class="l" id="266"> 266     {
</span><span class="l" id="267"> 267         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;stmt) {
</span><span class="l" id="268"> 268             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'you need to prepare a query before calling execute()'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="269"> 269         }
</span><span class="l" id="270"> 270 
</span><span class="l" id="271"> 271         <span class="php-var">$buffered</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="272"> 272         <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="273"> 273         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[self::OPT_BUFFERED])) {
</span><span class="l" id="274"> 274             <span class="php-var">$buffered</span> = <span class="php-var">$pdo</span>-&gt;getAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY);
</span><span class="l" id="275"> 275             <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$options</span>[self::OPT_BUFFERED]);
</span><span class="l" id="276"> 276         }
</span><span class="l" id="277"> 277 
</span><span class="l" id="278"> 278         <span class="php-keyword1">try</span> {
</span><span class="l" id="279"> 279             <span class="php-var">$this</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span class="l" id="280"> 280             <span class="php-var">$this</span>-&gt;params = <span class="php-var">$params</span>;
</span><span class="l" id="281"> 281 
</span><span class="l" id="282"> 282             <span class="php-var">$this</span>-&gt;stmt-&gt;execute(<span class="php-var">$params</span>);
</span><span class="l" id="283"> 283             <span class="php-var">$this</span>-&gt;rows = <span class="php-var">$this</span>-&gt;stmt-&gt;rowCount();
</span><span class="l" id="284"> 284         } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="285"> 285             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while executing statement "'</span> . <span class="php-var">$this</span>-&gt;query . <span class="php-quote">'" using params '</span> . <span class="php-keyword2">json_encode</span>(<span class="php-var">$params</span>) . <span class="php-quote">'! '</span> . <span class="php-var">$e</span>-&gt;getMessage(), <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="286"> 286         } finally {
</span><span class="l" id="287"> 287             <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> !== <span class="php-var">$buffered</span>) {
</span><span class="l" id="288"> 288                 <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$buffered</span>);
</span><span class="l" id="289"> 289             }
</span><span class="l" id="290"> 290 
</span><span class="l" id="291"> 291             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;debug) {
</span><span class="l" id="292"> 292                 <span class="php-var">$this</span>-&gt;printError(<span class="php-var">$this</span>-&gt;query, <span class="php-var">$params</span>);
</span><span class="l" id="293"> 293             }
</span><span class="l" id="294"> 294         }
</span><span class="l" id="295"> 295 
</span><span class="l" id="296"> 296         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="297"> 297     }
</span><span class="l" id="298"> 298 
</span><span class="l" id="299"> 299     <span class="php-comment">/**
</span></span><span class="l" id="300"> 300 <span class="php-comment">     * Executes the given sql-query.
</span></span><span class="l" id="301"> 301 <span class="php-comment">     *
</span></span><span class="l" id="302"> 302 <span class="php-comment">     * If parameters will be provided, a prepared statement will be executed.
</span></span><span class="l" id="303"> 303 <span class="php-comment">     *
</span></span><span class="l" id="304"> 304 <span class="php-comment">     * example 1:
</span></span><span class="l" id="305"> 305 <span class="php-comment">     *    $sql-&gt;setQuery('SELECT * FROM mytable where id=:id', ['id' =&gt; 3]);
</span></span><span class="l" id="306"> 306 <span class="php-comment">     *
</span></span><span class="l" id="307"> 307 <span class="php-comment">     * NOTE: named-parameters/?-placeholders are not supported in LIMIT clause!
</span></span><span class="l" id="308"> 308 <span class="php-comment">     *
</span></span><span class="l" id="309"> 309 <span class="php-comment">     * @param string $query   The sql-query
</span></span><span class="l" id="310"> 310 <span class="php-comment">     * @param array  $params  An optional array of statement parameter
</span></span><span class="l" id="311"> 311 <span class="php-comment">     * @param array  $options For possible option keys view `rex_sql::OPT_*` constants
</span></span><span class="l" id="312"> 312 <span class="php-comment">     *
</span></span><span class="l" id="313"> 313 <span class="php-comment">     * @return $this
</span></span><span class="l" id="314"> 314 <span class="php-comment">     *
</span></span><span class="l" id="315"> 315 <span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="316"> 316 <span class="php-comment">     */</span>
</span><span class="l" id="317"> 317     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setQuery(<span class="php-var">$query</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-keyword1">array</span> <span class="php-var">$options</span> = [])
</span><span class="l" id="318"> 318     {
</span><span class="l" id="319"> 319         <span class="php-comment">// Alle Werte zuruecksetzen</span>
</span><span class="l" id="320"> 320         <span class="php-var">$this</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span class="l" id="321"> 321         <span class="php-var">$this</span>-&gt;query = <span class="php-var">$query</span>;
</span><span class="l" id="322"> 322         <span class="php-var">$this</span>-&gt;params = <span class="php-var">$params</span>;
</span><span class="l" id="323"> 323         <span class="php-var">$this</span>-&gt;stmt = <span class="php-keyword1">null</span>;
</span><span class="l" id="324"> 324 
</span><span class="l" id="325"> 325         <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>)) {
</span><span class="l" id="326"> 326             <span class="php-var">$this</span>-&gt;prepareQuery(<span class="php-var">$query</span>);
</span><span class="l" id="327"> 327             <span class="php-var">$this</span>-&gt;execute(<span class="php-var">$params</span>, <span class="php-var">$options</span>);
</span><span class="l" id="328"> 328 
</span><span class="l" id="329"> 329             <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="330"> 330         }
</span><span class="l" id="331"> 331 
</span><span class="l" id="332"> 332         <span class="php-var">$buffered</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="333"> 333         <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="334"> 334         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[self::OPT_BUFFERED])) {
</span><span class="l" id="335"> 335             <span class="php-var">$buffered</span> = <span class="php-var">$pdo</span>-&gt;getAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY);
</span><span class="l" id="336"> 336             <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$options</span>[self::OPT_BUFFERED]);
</span><span class="l" id="337"> 337         }
</span><span class="l" id="338"> 338 
</span><span class="l" id="339"> 339         <span class="php-keyword1">try</span> {
</span><span class="l" id="340"> 340             <span class="php-var">$this</span>-&gt;stmt = <span class="php-var">$pdo</span>-&gt;query(<span class="php-var">$query</span>);
</span><span class="l" id="341"> 341             <span class="php-var">$this</span>-&gt;rows = <span class="php-var">$this</span>-&gt;stmt-&gt;rowCount();
</span><span class="l" id="342"> 342         } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="343"> 343             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while executing statement "'</span> . <span class="php-var">$query</span> . <span class="php-quote">'"! '</span> . <span class="php-var">$e</span>-&gt;getMessage(), <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="344"> 344         } finally {
</span><span class="l" id="345"> 345             <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> !== <span class="php-var">$buffered</span>) {
</span><span class="l" id="346"> 346                 <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$buffered</span>);
</span><span class="l" id="347"> 347             }
</span><span class="l" id="348"> 348 
</span><span class="l" id="349"> 349             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;debug) {
</span><span class="l" id="350"> 350                 <span class="php-var">$this</span>-&gt;printError(<span class="php-var">$query</span>, <span class="php-var">$params</span>);
</span><span class="l" id="351"> 351             }
</span><span class="l" id="352"> 352         }
</span><span class="l" id="353"> 353 
</span><span class="l" id="354"> 354         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="355"> 355     }
</span><span class="l" id="356"> 356 
</span><span class="l" id="357"> 357     <span class="php-comment">/**
</span></span><span class="l" id="358"> 358 <span class="php-comment">     * Setzt den Tabellennamen.
</span></span><span class="l" id="359"> 359 <span class="php-comment">     *
</span></span><span class="l" id="360"> 360 <span class="php-comment">     * @param string $table Tabellenname
</span></span><span class="l" id="361"> 361 <span class="php-comment">     *
</span></span><span class="l" id="362"> 362 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="363"> 363 <span class="php-comment">     */</span>
</span><span class="l" id="364"> 364     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setTable(<span class="php-var">$table</span>)
</span><span class="l" id="365"> 365     {
</span><span class="l" id="366"> 366         <span class="php-var">$this</span>-&gt;table = <span class="php-var">$table</span>;
</span><span class="l" id="367"> 367 
</span><span class="l" id="368"> 368         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="369"> 369     }
</span><span class="l" id="370"> 370 
</span><span class="l" id="371"> 371     <span class="php-comment">/**
</span></span><span class="l" id="372"> 372 <span class="php-comment">     * Sets the raw value of a column.
</span></span><span class="l" id="373"> 373 <span class="php-comment">     *
</span></span><span class="l" id="374"> 374 <span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="375"> 375 <span class="php-comment">     * @param string $value   The raw value
</span></span><span class="l" id="376"> 376 <span class="php-comment">     *
</span></span><span class="l" id="377"> 377 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="378"> 378 <span class="php-comment">     */</span>
</span><span class="l" id="379"> 379     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setRawValue(<span class="php-var">$colName</span>, <span class="php-var">$value</span>)
</span><span class="l" id="380"> 380     {
</span><span class="l" id="381"> 381         <span class="php-var">$this</span>-&gt;rawValues[<span class="php-var">$colName</span>] = <span class="php-var">$value</span>;
</span><span class="l" id="382"> 382         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>]);
</span><span class="l" id="383"> 383 
</span><span class="l" id="384"> 384         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="385"> 385     }
</span><span class="l" id="386"> 386 
</span><span class="l" id="387"> 387     <span class="php-comment">/**
</span></span><span class="l" id="388"> 388 <span class="php-comment">     * Set the value of a column.
</span></span><span class="l" id="389"> 389 <span class="php-comment">     *
</span></span><span class="l" id="390"> 390 <span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="391"> 391 <span class="php-comment">     * @param mixed  $value   The value
</span></span><span class="l" id="392"> 392 <span class="php-comment">     *
</span></span><span class="l" id="393"> 393 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="394"> 394 <span class="php-comment">     */</span>
</span><span class="l" id="395"> 395     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setValue(<span class="php-var">$colName</span>, <span class="php-var">$value</span>)
</span><span class="l" id="396"> 396     {
</span><span class="l" id="397"> 397         <span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>] = <span class="php-var">$value</span>;
</span><span class="l" id="398"> 398         <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;rawValues[<span class="php-var">$colName</span>]);
</span><span class="l" id="399"> 399 
</span><span class="l" id="400"> 400         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="401"> 401     }
</span><span class="l" id="402"> 402 
</span><span class="l" id="403"> 403     <span class="php-comment">/**
</span></span><span class="l" id="404"> 404 <span class="php-comment">     * Set the array value of a column (json encoded).
</span></span><span class="l" id="405"> 405 <span class="php-comment">     *
</span></span><span class="l" id="406"> 406 <span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="407"> 407 <span class="php-comment">     * @param array  $value   The value
</span></span><span class="l" id="408"> 408 <span class="php-comment">     *
</span></span><span class="l" id="409"> 409 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="410"> 410 <span class="php-comment">     */</span>
</span><span class="l" id="411"> 411     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setArrayValue(<span class="php-var">$colName</span>, <span class="php-keyword1">array</span> <span class="php-var">$value</span>)
</span><span class="l" id="412"> 412     {
</span><span class="l" id="413"> 413         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$colName</span>, <span class="php-keyword2">json_encode</span>(<span class="php-var">$value</span>));
</span><span class="l" id="414"> 414     }
</span><span class="l" id="415"> 415 
</span><span class="l" id="416"> 416     <span class="php-comment">/**
</span></span><span class="l" id="417"> 417 <span class="php-comment">     * Sets the datetime value of a column.
</span></span><span class="l" id="418"> 418 <span class="php-comment">     *
</span></span><span class="l" id="419"> 419 <span class="php-comment">     * @param string   $colName   Name of the column
</span></span><span class="l" id="420"> 420 <span class="php-comment">     * @param int|null $timestamp Unix timestamp (if `null` is given, the current time is used)
</span></span><span class="l" id="421"> 421 <span class="php-comment">     *
</span></span><span class="l" id="422"> 422 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="423"> 423 <span class="php-comment">     */</span>
</span><span class="l" id="424"> 424     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setDateTimeValue(<span class="php-var">$colName</span>, <span class="php-var">$timestamp</span>)
</span><span class="l" id="425"> 425     {
</span><span class="l" id="426"> 426         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$colName</span>, self::datetime(<span class="php-var">$timestamp</span>));
</span><span class="l" id="427"> 427     }
</span><span class="l" id="428"> 428 
</span><span class="l" id="429"> 429     <span class="php-comment">/**
</span></span><span class="l" id="430"> 430 <span class="php-comment">     * Setzt ein Array von Werten zugleich.
</span></span><span class="l" id="431"> 431 <span class="php-comment">     *
</span></span><span class="l" id="432"> 432 <span class="php-comment">     * @param array $valueArray Ein Array von Werten
</span></span><span class="l" id="433"> 433 <span class="php-comment">     *
</span></span><span class="l" id="434"> 434 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="435"> 435 <span class="php-comment">     */</span>
</span><span class="l" id="436"> 436     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setValues(<span class="php-keyword1">array</span> <span class="php-var">$valueArray</span>)
</span><span class="l" id="437"> 437     {
</span><span class="l" id="438"> 438         <span class="php-keyword1">foreach</span> (<span class="php-var">$valueArray</span> <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="439"> 439             <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$name</span>, <span class="php-var">$value</span>);
</span><span class="l" id="440"> 440         }
</span><span class="l" id="441"> 441 
</span><span class="l" id="442"> 442         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="443"> 443     }
</span><span class="l" id="444"> 444 
</span><span class="l" id="445"> 445     <span class="php-comment">/**
</span></span><span class="l" id="446"> 446 <span class="php-comment">     * Returns whether values are set inside this rex_sql object.
</span></span><span class="l" id="447"> 447 <span class="php-comment">     *
</span></span><span class="l" id="448"> 448 <span class="php-comment">     * @return bool True if value isset and not null, otherwise False
</span></span><span class="l" id="449"> 449 <span class="php-comment">     */</span>
</span><span class="l" id="450"> 450     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasValues()
</span><span class="l" id="451"> 451     {
</span><span class="l" id="452"> 452         <span class="php-keyword1">return</span> !<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;values);
</span><span class="l" id="453"> 453     }
</span><span class="l" id="454"> 454 
</span><span class="l" id="455"> 455     <span class="php-comment">/**
</span></span><span class="l" id="456"> 456 <span class="php-comment">     * Prueft den Wert einer Spalte der aktuellen Zeile ob ein Wert enthalten ist.
</span></span><span class="l" id="457"> 457 <span class="php-comment">     *
</span></span><span class="l" id="458"> 458 <span class="php-comment">     * @param string $feld Spaltenname des zu pruefenden Feldes
</span></span><span class="l" id="459"> 459 <span class="php-comment">     * @param string $prop Wert, der enthalten sein soll
</span></span><span class="l" id="460"> 460 <span class="php-comment">     *
</span></span><span class="l" id="461"> 461 <span class="php-comment">     * @return bool
</span></span><span class="l" id="462"> 462 <span class="php-comment">     */</span>
</span><span class="l" id="463"> 463     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> isValueOf(<span class="php-var">$feld</span>, <span class="php-var">$prop</span>)
</span><span class="l" id="464"> 464     {
</span><span class="l" id="465"> 465         <span class="php-keyword1">if</span> (<span class="php-var">$prop</span> == <span class="php-quote">''</span>) {
</span><span class="l" id="466"> 466             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="467"> 467         }
</span><span class="l" id="468"> 468         <span class="php-keyword1">return</span> <span class="php-keyword2">strpos</span>(<span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$feld</span>), <span class="php-var">$prop</span>) !== <span class="php-keyword1">false</span>;
</span><span class="l" id="469"> 469     }
</span><span class="l" id="470"> 470 
</span><span class="l" id="471"> 471     <span class="php-comment">/**
</span></span><span class="l" id="472"> 472 <span class="php-comment">     * Adds a record for multi row/batch operations.
</span></span><span class="l" id="473"> 473 <span class="php-comment">     *
</span></span><span class="l" id="474"> 474 <span class="php-comment">     * This method can only be used in combination with `insert()` and `replace()`.
</span></span><span class="l" id="475"> 475 <span class="php-comment">     *
</span></span><span class="l" id="476"> 476 <span class="php-comment">     * Example:
</span></span><span class="l" id="477"> 477 <span class="php-comment">     *      $sql-&gt;addRecord(function (rex_sql $record) {
</span></span><span class="l" id="478"> 478 <span class="php-comment">     *          $record-&gt;setValue('title', 'Foo');
</span></span><span class="l" id="479"> 479 <span class="php-comment">     *          $record-&gt;setRawValue('created', 'NOW()');
</span></span><span class="l" id="480"> 480 <span class="php-comment">     *      });
</span></span><span class="l" id="481"> 481 <span class="php-comment">     *
</span></span><span class="l" id="482"> 482 <span class="php-comment">     * @param callable $callback The callback receives a new `rex_sql` instance for the new record
</span></span><span class="l" id="483"> 483 <span class="php-comment">     *                           and must set the values of the new record on that instance (see example above)
</span></span><span class="l" id="484"> 484 <span class="php-comment">     *
</span></span><span class="l" id="485"> 485 <span class="php-comment">     * @return $this
</span></span><span class="l" id="486"> 486 <span class="php-comment">     */</span>
</span><span class="l" id="487"> 487     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> addRecord(<span class="php-keyword1">callable</span> <span class="php-var">$callback</span>)
</span><span class="l" id="488"> 488     {
</span><span class="l" id="489"> 489         <span class="php-var">$record</span> = self::factory(<span class="php-var">$this</span>-&gt;DBID);
</span><span class="l" id="490"> 490 
</span><span class="l" id="491"> 491         <span class="php-var">$callback</span>(<span class="php-var">$record</span>);
</span><span class="l" id="492"> 492 
</span><span class="l" id="493"> 493         <span class="php-var">$this</span>-&gt;records[] = <span class="php-var">$record</span>;
</span><span class="l" id="494"> 494 
</span><span class="l" id="495"> 495         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="496"> 496     }
</span><span class="l" id="497"> 497 
</span><span class="l" id="498"> 498     <span class="php-comment">/**
</span></span><span class="l" id="499"> 499 <span class="php-comment">     * Setzt die WHERE Bedienung der Abfrage.
</span></span><span class="l" id="500"> 500 <span class="php-comment">     *
</span></span><span class="l" id="501"> 501 <span class="php-comment">     * example 1:
</span></span><span class="l" id="502"> 502 <span class="php-comment">     *    $sql-&gt;setWhere(['id' =&gt; 3, 'field' =&gt; '']); // results in id = 3 AND field = ''
</span></span><span class="l" id="503"> 503 <span class="php-comment">     *    $sql-&gt;setWhere([['id' =&gt; 3, 'field' =&gt; '']]); // results in id = 3 OR field = ''
</span></span><span class="l" id="504"> 504 <span class="php-comment">     *
</span></span><span class="l" id="505"> 505 <span class="php-comment">     * example 2:
</span></span><span class="l" id="506"> 506 <span class="php-comment">     *    $sql-&gt;setWhere('myid = :id OR anotherfield = :field', ['id' =&gt; 3, 'field' =&gt; '']);
</span></span><span class="l" id="507"> 507 <span class="php-comment">     *
</span></span><span class="l" id="508"> 508 <span class="php-comment">     * example 3 (deprecated):
</span></span><span class="l" id="509"> 509 <span class="php-comment">     *    $sql-&gt;setWhere('myid="35" OR abc="zdf"');
</span></span><span class="l" id="510"> 510 <span class="php-comment">     *
</span></span><span class="l" id="511"> 511 <span class="php-comment">     * @param string|array $where
</span></span><span class="l" id="512"> 512 <span class="php-comment">     * @param array        $whereParams
</span></span><span class="l" id="513"> 513 <span class="php-comment">     *
</span></span><span class="l" id="514"> 514 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="515"> 515 <span class="php-comment">     *
</span></span><span class="l" id="516"> 516 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="517"> 517 <span class="php-comment">     */</span>
</span><span class="l" id="518"> 518     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setWhere(<span class="php-var">$where</span>, <span class="php-var">$whereParams</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="519"> 519     {
</span><span class="l" id="520"> 520         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$where</span>)) {
</span><span class="l" id="521"> 521             <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">'WHERE '</span> . <span class="php-var">$this</span>-&gt;buildWhereArg(<span class="php-var">$where</span>);
</span><span class="l" id="522"> 522             <span class="php-var">$this</span>-&gt;whereParams = <span class="php-var">$where</span>;
</span><span class="l" id="523"> 523         } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_string</span>(<span class="php-var">$where</span>) &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$whereParams</span>)) {
</span><span class="l" id="524"> 524             <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">'WHERE '</span> . <span class="php-var">$where</span>;
</span><span class="l" id="525"> 525             <span class="php-var">$this</span>-&gt;whereParams = <span class="php-var">$whereParams</span>;
</span><span class="l" id="526"> 526         } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_string</span>(<span class="php-var">$where</span>)) {
</span><span class="l" id="527"> 527             <span class="php-comment">//$trace = debug_backtrace();</span>
</span><span class="l" id="528"> 528             <span class="php-comment">//$loc = $trace[0];</span>
</span><span class="l" id="529"> 529             <span class="php-comment">//trigger_error('you have to take care to provide escaped values for your where-string in file "'. $loc['file'] .'" on line '. $loc['line'] .'!', E_USER_WARNING);</span>
</span><span class="l" id="530"> 530 
</span><span class="l" id="531"> 531             <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">'WHERE '</span> . <span class="php-var">$where</span>;
</span><span class="l" id="532"> 532             <span class="php-var">$this</span>-&gt;whereParams = [];
</span><span class="l" id="533"> 533         } <span class="php-keyword1">else</span> {
</span><span class="l" id="534"> 534             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'expecting $where to be an array, "'</span> . <span class="php-keyword2">gettype</span>(<span class="php-var">$where</span>) . <span class="php-quote">'" given!'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="535"> 535         }
</span><span class="l" id="536"> 536 
</span><span class="l" id="537"> 537         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="538"> 538     }
</span><span class="l" id="539"> 539 
</span><span class="l" id="540"> 540     <span class="php-comment">/**
</span></span><span class="l" id="541"> 541 <span class="php-comment">     * Concats the given array to a sql condition using bound parameters.
</span></span><span class="l" id="542"> 542 <span class="php-comment">     * AND/OR opartors are alternated depending on $level.
</span></span><span class="l" id="543"> 543 <span class="php-comment">     *
</span></span><span class="l" id="544"> 544 <span class="php-comment">     * @param array $arrFields
</span></span><span class="l" id="545"> 545 <span class="php-comment">     * @param int   $level
</span></span><span class="l" id="546"> 546 <span class="php-comment">     *
</span></span><span class="l" id="547"> 547 <span class="php-comment">     * @return string
</span></span><span class="l" id="548"> 548 <span class="php-comment">     */</span>
</span><span class="l" id="549"> 549     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> buildWhereArg(<span class="php-keyword1">array</span> <span class="php-var">$arrFields</span>, <span class="php-var">$level</span> = <span class="php-num">0</span>)
</span><span class="l" id="550"> 550     {
</span><span class="l" id="551"> 551         <span class="php-keyword1">if</span> (<span class="php-var">$level</span> % <span class="php-num">2</span> == <span class="php-num">1</span>) {
</span><span class="l" id="552"> 552             <span class="php-var">$op</span> = <span class="php-quote">' OR '</span>;
</span><span class="l" id="553"> 553         } <span class="php-keyword1">else</span> {
</span><span class="l" id="554"> 554             <span class="php-var">$op</span> = <span class="php-quote">' AND '</span>;
</span><span class="l" id="555"> 555         }
</span><span class="l" id="556"> 556 
</span><span class="l" id="557"> 557         <span class="php-var">$qry</span> = <span class="php-quote">''</span>;
</span><span class="l" id="558"> 558         <span class="php-keyword1">foreach</span> (<span class="php-var">$arrFields</span> <span class="php-keyword1">as</span> <span class="php-var">$fld_name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="559"> 559             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$value</span>)) {
</span><span class="l" id="560"> 560                 <span class="php-var">$arg</span> = <span class="php-quote">'('</span> . <span class="php-var">$this</span>-&gt;buildWhereArg(<span class="php-var">$value</span>, <span class="php-var">$level</span> + <span class="php-num">1</span>) . <span class="php-quote">')'</span>;
</span><span class="l" id="561"> 561             } <span class="php-keyword1">else</span> {
</span><span class="l" id="562"> 562                 <span class="php-var">$arg</span> = <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$fld_name</span>) . <span class="php-quote">' = :'</span> . <span class="php-var">$fld_name</span>;
</span><span class="l" id="563"> 563             }
</span><span class="l" id="564"> 564 
</span><span class="l" id="565"> 565             <span class="php-keyword1">if</span> (<span class="php-var">$qry</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="566"> 566                 <span class="php-var">$qry</span> .= <span class="php-var">$op</span>;
</span><span class="l" id="567"> 567             }
</span><span class="l" id="568"> 568             <span class="php-var">$qry</span> .= <span class="php-var">$arg</span>;
</span><span class="l" id="569"> 569         }
</span><span class="l" id="570"> 570         <span class="php-keyword1">return</span> <span class="php-var">$qry</span>;
</span><span class="l" id="571"> 571     }
</span><span class="l" id="572"> 572 
</span><span class="l" id="573"> 573     <span class="php-comment">/**
</span></span><span class="l" id="574"> 574 <span class="php-comment">     * Returns the value of a column.
</span></span><span class="l" id="575"> 575 <span class="php-comment">     *
</span></span><span class="l" id="576"> 576 <span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="577"> 577 <span class="php-comment">     *
</span></span><span class="l" id="578"> 578 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="579"> 579 <span class="php-comment">     *
</span></span><span class="l" id="580"> 580 <span class="php-comment">     * @return mixed
</span></span><span class="l" id="581"> 581 <span class="php-comment">     */</span>
</span><span class="l" id="582"> 582     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getValue(<span class="php-var">$colName</span>)
</span><span class="l" id="583"> 583     {
</span><span class="l" id="584"> 584         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$colName</span>)) {
</span><span class="l" id="585"> 585             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'parameter fieldname must not be empty!'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="586"> 586         }
</span><span class="l" id="587"> 587 
</span><span class="l" id="588"> 588         <span class="php-comment">// fast fail,... value already set manually?</span>
</span><span class="l" id="589"> 589         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>])) {
</span><span class="l" id="590"> 590             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>];
</span><span class="l" id="591"> 591         }
</span><span class="l" id="592"> 592 
</span><span class="l" id="593"> 593         <span class="php-comment">// check if there is an table alias defined</span>
</span><span class="l" id="594"> 594         <span class="php-comment">// if not, try to guess the tablename</span>
</span><span class="l" id="595"> 595         <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$colName</span>, <span class="php-quote">'.'</span>) === <span class="php-keyword1">false</span>) {
</span><span class="l" id="596"> 596             <span class="php-var">$tables</span> = <span class="php-var">$this</span>-&gt;getTablenames();
</span><span class="l" id="597"> 597             <span class="php-keyword1">foreach</span> (<span class="php-var">$tables</span> <span class="php-keyword1">as</span> <span class="php-var">$table</span>) {
</span><span class="l" id="598"> 598                 <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$table</span> . <span class="php-quote">'.'</span> . <span class="php-var">$colName</span>, <span class="php-var">$this</span>-&gt;rawFieldnames)) {
</span><span class="l" id="599"> 599                     <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;fetchValue(<span class="php-var">$table</span> . <span class="php-quote">'.'</span> . <span class="php-var">$colName</span>);
</span><span class="l" id="600"> 600                 }
</span><span class="l" id="601"> 601             }
</span><span class="l" id="602"> 602         }
</span><span class="l" id="603"> 603 
</span><span class="l" id="604"> 604         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;fetchValue(<span class="php-var">$colName</span>);
</span><span class="l" id="605"> 605     }
</span><span class="l" id="606"> 606 
</span><span class="l" id="607"> 607     <span class="php-comment">/**
</span></span><span class="l" id="608"> 608 <span class="php-comment">     * Returns the array value of a (json encoded) column.
</span></span><span class="l" id="609"> 609 <span class="php-comment">     *
</span></span><span class="l" id="610"> 610 <span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="611"> 611 <span class="php-comment">     *
</span></span><span class="l" id="612"> 612 <span class="php-comment">     * @return array
</span></span><span class="l" id="613"> 613 <span class="php-comment">     */</span>
</span><span class="l" id="614"> 614     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getArrayValue(<span class="php-var">$colName</span>)
</span><span class="l" id="615"> 615     {
</span><span class="l" id="616"> 616         <span class="php-keyword1">return</span> <span class="php-keyword2">json_decode</span>(<span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$colName</span>), <span class="php-keyword1">true</span>);
</span><span class="l" id="617"> 617     }
</span><span class="l" id="618"> 618 
</span><span class="l" id="619"> 619     <span class="php-comment">/**
</span></span><span class="l" id="620"> 620 <span class="php-comment">     * Returns the unix timestamp of a datetime column.
</span></span><span class="l" id="621"> 621 <span class="php-comment">     *
</span></span><span class="l" id="622"> 622 <span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="623"> 623 <span class="php-comment">     *
</span></span><span class="l" id="624"> 624 <span class="php-comment">     * @return int|null Unix timestamp or `null` if the column is `null` or not in sql datetime format
</span></span><span class="l" id="625"> 625 <span class="php-comment">     */</span>
</span><span class="l" id="626"> 626     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getDateTimeValue(<span class="php-var">$colName</span>)
</span><span class="l" id="627"> 627     {
</span><span class="l" id="628"> 628         <span class="php-var">$value</span> = <span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$colName</span>);
</span><span class="l" id="629"> 629         <span class="php-keyword1">return</span> <span class="php-var">$value</span> ? <span class="php-keyword2">strtotime</span>(<span class="php-var">$value</span>) : <span class="php-keyword1">null</span>;
</span><span class="l" id="630"> 630     }
</span><span class="l" id="631"> 631 
</span><span class="l" id="632"> 632     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> fetchValue(<span class="php-var">$feldname</span>)
</span><span class="l" id="633"> 633     {
</span><span class="l" id="634"> 634         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$feldname</span>])) {
</span><span class="l" id="635"> 635             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;values[<span class="php-var">$feldname</span>];
</span><span class="l" id="636"> 636         }
</span><span class="l" id="637"> 637 
</span><span class="l" id="638"> 638         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;lastRow)) {
</span><span class="l" id="639"> 639             <span class="php-comment">// no row fetched, but also no query was executed before</span>
</span><span class="l" id="640"> 640             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;stmt == <span class="php-keyword1">null</span>) {
</span><span class="l" id="641"> 641                 <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="642"> 642             }
</span><span class="l" id="643"> 643             <span class="php-var">$this</span>-&gt;lastRow = <span class="php-var">$this</span>-&gt;stmt-&gt;fetch(PDO::FETCH_ASSOC);
</span><span class="l" id="644"> 644         }
</span><span class="l" id="645"> 645 
</span><span class="l" id="646"> 646         <span class="php-comment">// isset() alone doesn't work here, because values may also be null</span>
</span><span class="l" id="647"> 647         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$this</span>-&gt;lastRow) &amp;&amp; (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;lastRow[<span class="php-var">$feldname</span>]) || <span class="php-keyword2">array_key_exists</span>(<span class="php-var">$feldname</span>, <span class="php-var">$this</span>-&gt;lastRow))) {
</span><span class="l" id="648"> 648             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;lastRow[<span class="php-var">$feldname</span>];
</span><span class="l" id="649"> 649         }
</span><span class="l" id="650"> 650         <span class="php-keyword2">trigger_error</span>(<span class="php-quote">'Field "'</span> . <span class="php-var">$feldname</span> . <span class="php-quote">'" does not exist in result!'</span>, E_USER_WARNING);
</span><span class="l" id="651"> 651         <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="652"> 652     }
</span><span class="l" id="653"> 653 
</span><span class="l" id="654"> 654     <span class="php-comment">/**
</span></span><span class="l" id="655"> 655 <span class="php-comment">     * Gibt den Wert der aktuellen Zeile im ResultSet zurueck
</span></span><span class="l" id="656"> 656 <span class="php-comment">     * Falls es noch keine erste Zeile (lastRow) gibt, wird der Satzzeiger
</span></span><span class="l" id="657"> 657 <span class="php-comment">     * initialisiert. Weitere Satzwechsel mittels next().
</span></span><span class="l" id="658"> 658 <span class="php-comment">     */</span>
</span><span class="l" id="659"> 659     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getRow(<span class="php-var">$fetch_type</span> = PDO::FETCH_ASSOC)
</span><span class="l" id="660"> 660     {
</span><span class="l" id="661"> 661         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;lastRow) {
</span><span class="l" id="662"> 662             <span class="php-var">$this</span>-&gt;lastRow = <span class="php-var">$this</span>-&gt;stmt-&gt;fetch(<span class="php-var">$fetch_type</span>);
</span><span class="l" id="663"> 663         }
</span><span class="l" id="664"> 664         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;lastRow;
</span><span class="l" id="665"> 665     }
</span><span class="l" id="666"> 666 
</span><span class="l" id="667"> 667     <span class="php-comment">/**
</span></span><span class="l" id="668"> 668 <span class="php-comment">     * Prueft, ob eine Spalte im Resultset vorhanden ist.
</span></span><span class="l" id="669"> 669 <span class="php-comment">     *
</span></span><span class="l" id="670"> 670 <span class="php-comment">     * @param string $feldname Name der Spalte
</span></span><span class="l" id="671"> 671 <span class="php-comment">     *
</span></span><span class="l" id="672"> 672 <span class="php-comment">     * @return bool
</span></span><span class="l" id="673"> 673 <span class="php-comment">     */</span>
</span><span class="l" id="674"> 674     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasValue(<span class="php-var">$feldname</span>)
</span><span class="l" id="675"> 675     {
</span><span class="l" id="676"> 676         <span class="php-comment">// fast fail,... value already set manually?</span>
</span><span class="l" id="677"> 677         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$feldname</span>])) {
</span><span class="l" id="678"> 678             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="679"> 679         }
</span><span class="l" id="680"> 680 
</span><span class="l" id="681"> 681         <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$feldname</span>, <span class="php-quote">'.'</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="682"> 682             <span class="php-var">$parts</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'.'</span>, <span class="php-var">$feldname</span>);
</span><span class="l" id="683"> 683             <span class="php-keyword1">return</span> <span class="php-keyword2">in_array</span>(<span class="php-var">$parts</span>[<span class="php-num">0</span>], <span class="php-var">$this</span>-&gt;getTablenames()) &amp;&amp; <span class="php-keyword2">in_array</span>(<span class="php-var">$parts</span>[<span class="php-num">1</span>], <span class="php-var">$this</span>-&gt;getFieldnames());
</span><span class="l" id="684"> 684         }
</span><span class="l" id="685"> 685         <span class="php-keyword1">return</span> <span class="php-keyword2">in_array</span>(<span class="php-var">$feldname</span>, <span class="php-var">$this</span>-&gt;getFieldnames());
</span><span class="l" id="686"> 686     }
</span><span class="l" id="687"> 687 
</span><span class="l" id="688"> 688     <span class="php-comment">/**
</span></span><span class="l" id="689"> 689 <span class="php-comment">     * Prueft, ob das Feld mit dem Namen $feldname Null ist.
</span></span><span class="l" id="690"> 690 <span class="php-comment">     *
</span></span><span class="l" id="691"> 691 <span class="php-comment">     * Falls das Feld nicht vorhanden ist,
</span></span><span class="l" id="692"> 692 <span class="php-comment">     * wird Null zurueckgegeben, sonst True/False
</span></span><span class="l" id="693"> 693 <span class="php-comment">     */</span>
</span><span class="l" id="694"> 694     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> isNull(<span class="php-var">$feldname</span>)
</span><span class="l" id="695"> 695     {
</span><span class="l" id="696"> 696         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasValue(<span class="php-var">$feldname</span>)) {
</span><span class="l" id="697"> 697             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$feldname</span>) === <span class="php-keyword1">null</span>;
</span><span class="l" id="698"> 698         }
</span><span class="l" id="699"> 699 
</span><span class="l" id="700"> 700         <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="701"> 701     }
</span><span class="l" id="702"> 702 
</span><span class="l" id="703"> 703     <span class="php-comment">/**
</span></span><span class="l" id="704"> 704 <span class="php-comment">     * Gibt die Anzahl der Zeilen zurueck.
</span></span><span class="l" id="705"> 705 <span class="php-comment">     */</span>
</span><span class="l" id="706"> 706     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getRows()
</span><span class="l" id="707"> 707     {
</span><span class="l" id="708"> 708         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;rows;
</span><span class="l" id="709"> 709     }
</span><span class="l" id="710"> 710 
</span><span class="l" id="711"> 711     <span class="php-comment">/**
</span></span><span class="l" id="712"> 712 <span class="php-comment">     * Gibt die Anzahl der Felder/Spalten zurueck.
</span></span><span class="l" id="713"> 713 <span class="php-comment">     */</span>
</span><span class="l" id="714"> 714     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getFields()
</span><span class="l" id="715"> 715     {
</span><span class="l" id="716"> 716         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;columnCount() : <span class="php-num">0</span>;
</span><span class="l" id="717"> 717     }
</span><span class="l" id="718"> 718 
</span><span class="l" id="719"> 719     <span class="php-comment">/**
</span></span><span class="l" id="720"> 720 <span class="php-comment">     * Baut den SET bestandteil mit der
</span></span><span class="l" id="721"> 721 <span class="php-comment">     * verfuegbaren values zusammen und gibt diesen zurueck.
</span></span><span class="l" id="722"> 722 <span class="php-comment">     *
</span></span><span class="l" id="723"> 723 <span class="php-comment">     * @see setValue
</span></span><span class="l" id="724"> 724 <span class="php-comment">     */</span>
</span><span class="l" id="725"> 725     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> buildPreparedValues()
</span><span class="l" id="726"> 726     {
</span><span class="l" id="727"> 727         <span class="php-var">$qry</span> = <span class="php-quote">''</span>;
</span><span class="l" id="728"> 728         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$this</span>-&gt;values)) {
</span><span class="l" id="729"> 729             <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;values <span class="php-keyword1">as</span> <span class="php-var">$fld_name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="730"> 730                 <span class="php-keyword1">if</span> (<span class="php-var">$qry</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="731"> 731                     <span class="php-var">$qry</span> .= <span class="php-quote">', '</span>;
</span><span class="l" id="732"> 732                 }
</span><span class="l" id="733"> 733 
</span><span class="l" id="734"> 734                 <span class="php-var">$qry</span> .= <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$fld_name</span>) .<span class="php-quote">' = :'</span> . <span class="php-var">$fld_name</span>;
</span><span class="l" id="735"> 735             }
</span><span class="l" id="736"> 736         }
</span><span class="l" id="737"> 737         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$this</span>-&gt;rawValues)) {
</span><span class="l" id="738"> 738             <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;rawValues <span class="php-keyword1">as</span> <span class="php-var">$fld_name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="739"> 739                 <span class="php-keyword1">if</span> (<span class="php-var">$qry</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="740"> 740                     <span class="php-var">$qry</span> .= <span class="php-quote">', '</span>;
</span><span class="l" id="741"> 741                 }
</span><span class="l" id="742"> 742 
</span><span class="l" id="743"> 743                 <span class="php-var">$qry</span> .= <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$fld_name</span>) . <span class="php-quote">' = '</span> . <span class="php-var">$value</span>;
</span><span class="l" id="744"> 744             }
</span><span class="l" id="745"> 745         }
</span><span class="l" id="746"> 746 
</span><span class="l" id="747"> 747         <span class="php-keyword1">if</span> (<span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>) == <span class="php-quote">''</span>) {
</span><span class="l" id="748"> 748             <span class="php-comment">// FIXME</span>
</span><span class="l" id="749"> 749             <span class="php-keyword2">trigger_error</span>(<span class="php-quote">'no values given to buildPreparedValues for update(), insert() or replace()'</span>, E_USER_WARNING);
</span><span class="l" id="750"> 750         }
</span><span class="l" id="751"> 751 
</span><span class="l" id="752"> 752         <span class="php-keyword1">return</span> <span class="php-var">$qry</span>;
</span><span class="l" id="753"> 753     }
</span><span class="l" id="754"> 754 
</span><span class="l" id="755"> 755     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getWhere()
</span><span class="l" id="756"> 756     {
</span><span class="l" id="757"> 757         <span class="php-comment">// we have an custom where criteria, so we don't need to build one automatically</span>
</span><span class="l" id="758"> 758         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;wherevar != <span class="php-quote">''</span>) {
</span><span class="l" id="759"> 759             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;wherevar;
</span><span class="l" id="760"> 760         }
</span><span class="l" id="761"> 761 
</span><span class="l" id="762"> 762         <span class="php-keyword1">return</span> <span class="php-quote">''</span>;
</span><span class="l" id="763"> 763     }
</span><span class="l" id="764"> 764 
</span><span class="l" id="765"> 765     <span class="php-comment">/**
</span></span><span class="l" id="766"> 766 <span class="php-comment">     * Setzt eine Select-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="767"> 767 <span class="php-comment">     * mit den WHERE Parametern ab.
</span></span><span class="l" id="768"> 768 <span class="php-comment">     *
</span></span><span class="l" id="769"> 769 <span class="php-comment">     * @param string $fields
</span></span><span class="l" id="770"> 770 <span class="php-comment">     *
</span></span><span class="l" id="771"> 771 <span class="php-comment">     * @return $this
</span></span><span class="l" id="772"> 772 <span class="php-comment">     *
</span></span><span class="l" id="773"> 773 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="774"> 774 <span class="php-comment">     */</span>
</span><span class="l" id="775"> 775     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> select(<span class="php-var">$fields</span> = <span class="php-quote">'*'</span>)
</span><span class="l" id="776"> 776     {
</span><span class="l" id="777"> 777         <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="778"> 778             <span class="php-quote">'SELECT '</span> . <span class="php-var">$fields</span> . <span class="php-quote">' FROM '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="779"> 779             <span class="php-var">$this</span>-&gt;whereParams
</span><span class="l" id="780"> 780         );
</span><span class="l" id="781"> 781         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="782"> 782     }
</span><span class="l" id="783"> 783 
</span><span class="l" id="784"> 784     <span class="php-comment">/**
</span></span><span class="l" id="785"> 785 <span class="php-comment">     * Setzt eine Update-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="786"> 786 <span class="php-comment">     * mit den angegebenen Werten und WHERE Parametern ab.
</span></span><span class="l" id="787"> 787 <span class="php-comment">     *
</span></span><span class="l" id="788"> 788 <span class="php-comment">     * @return $this
</span></span><span class="l" id="789"> 789 <span class="php-comment">     *
</span></span><span class="l" id="790"> 790 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="791"> 791 <span class="php-comment">     */</span>
</span><span class="l" id="792"> 792     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> update()
</span><span class="l" id="793"> 793     {
</span><span class="l" id="794"> 794         <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="795"> 795             <span class="php-quote">'UPDATE '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' SET '</span> . <span class="php-var">$this</span>-&gt;buildPreparedValues() . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="796"> 796             <span class="php-keyword2">array_merge</span>(<span class="php-var">$this</span>-&gt;values, <span class="php-var">$this</span>-&gt;whereParams)
</span><span class="l" id="797"> 797         );
</span><span class="l" id="798"> 798         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="799"> 799     }
</span><span class="l" id="800"> 800 
</span><span class="l" id="801"> 801     <span class="php-comment">/**
</span></span><span class="l" id="802"> 802 <span class="php-comment">     * Setzt eine Insert-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="803"> 803 <span class="php-comment">     * mit den angegebenen Werten ab.
</span></span><span class="l" id="804"> 804 <span class="php-comment">     *
</span></span><span class="l" id="805"> 805 <span class="php-comment">     * @return $this
</span></span><span class="l" id="806"> 806 <span class="php-comment">     *
</span></span><span class="l" id="807"> 807 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="808"> 808 <span class="php-comment">     */</span>
</span><span class="l" id="809"> 809     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> insert()
</span><span class="l" id="810"> 810     {
</span><span class="l" id="811"> 811         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;records) {
</span><span class="l" id="812"> 812             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setMultiRecordQuery(<span class="php-quote">'INSERT'</span>);
</span><span class="l" id="813"> 813         }
</span><span class="l" id="814"> 814 
</span><span class="l" id="815"> 815         <span class="php-comment">// hold a copies of the query fields for later debug out (the class property will be reverted in setQuery())</span>
</span><span class="l" id="816"> 816         <span class="php-var">$tableName</span> = <span class="php-var">$this</span>-&gt;table;
</span><span class="l" id="817"> 817         <span class="php-var">$values</span> = <span class="php-var">$this</span>-&gt;values;
</span><span class="l" id="818"> 818 
</span><span class="l" id="819"> 819         <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="820"> 820             <span class="php-quote">'INSERT INTO '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' SET '</span> . <span class="php-var">$this</span>-&gt;buildPreparedValues(),
</span><span class="l" id="821"> 821             <span class="php-var">$this</span>-&gt;values
</span><span class="l" id="822"> 822         );
</span><span class="l" id="823"> 823 
</span><span class="l" id="824"> 824         <span class="php-comment">// provide debug infos, if insert is considered successfull, but no rows were inserted.</span>
</span><span class="l" id="825"> 825         <span class="php-comment">// this happens when you violate against a NOTNULL constraint</span>
</span><span class="l" id="826"> 826         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getRows() == <span class="php-num">0</span>) {
</span><span class="l" id="827"> 827             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while inserting into table "'</span> . <span class="php-var">$tableName</span> . <span class="php-quote">'" with values '</span> . <span class="php-keyword2">print_r</span>(<span class="php-var">$values</span>, <span class="php-keyword1">true</span>) . <span class="php-quote">'! Check your null/not-null constraints!'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="828"> 828         }
</span><span class="l" id="829"> 829         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="830"> 830     }
</span><span class="l" id="831"> 831 
</span><span class="l" id="832"> 832     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> insertOrUpdate()
</span><span class="l" id="833"> 833     {
</span><span class="l" id="834"> 834         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;records) {
</span><span class="l" id="835"> 835             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setMultiRecordQuery(<span class="php-quote">'INSERT'</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="836"> 836         }
</span><span class="l" id="837"> 837 
</span><span class="l" id="838"> 838         <span class="php-comment">// hold a copies of the query fields for later debug out (the class property will be reverted in setQuery())</span>
</span><span class="l" id="839"> 839         <span class="php-var">$tableName</span> = <span class="php-var">$this</span>-&gt;table;
</span><span class="l" id="840"> 840         <span class="php-var">$values</span> = <span class="php-var">$this</span>-&gt;values;
</span><span class="l" id="841"> 841 
</span><span class="l" id="842"> 842         <span class="php-var">$onDuplicateKeyUpdate</span> = <span class="php-var">$this</span>-&gt;buildOnDuplicateKeyUpdate(<span class="php-keyword2">array_keys</span>(<span class="php-keyword2">array_merge</span>(<span class="php-var">$this</span>-&gt;values, <span class="php-var">$this</span>-&gt;rawValues)));
</span><span class="l" id="843"> 843         <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="844"> 844             <span class="php-quote">'INSERT INTO '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' SET '</span> . <span class="php-var">$this</span>-&gt;buildPreparedValues() . <span class="php-quote">' '</span> . <span class="php-var">$onDuplicateKeyUpdate</span>,
</span><span class="l" id="845"> 845             <span class="php-var">$this</span>-&gt;values
</span><span class="l" id="846"> 846         );
</span><span class="l" id="847"> 847 
</span><span class="l" id="848"> 848         <span class="php-comment">// provide debug infos, if insert is considered successfull, but no rows were inserted.</span>
</span><span class="l" id="849"> 849         <span class="php-comment">// this happens when you violate against a NOTNULL constraint</span>
</span><span class="l" id="850"> 850         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getRows() == <span class="php-num">0</span>) {
</span><span class="l" id="851"> 851             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while inserting into table "'</span> . <span class="php-var">$tableName</span> . <span class="php-quote">'" with values '</span> . <span class="php-keyword2">print_r</span>(<span class="php-var">$values</span>, <span class="php-keyword1">true</span>) . <span class="php-quote">'! Check your null/not-null constraints!'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="852"> 852         }
</span><span class="l" id="853"> 853         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="854"> 854     }
</span><span class="l" id="855"> 855 
</span><span class="l" id="856"> 856     <span class="php-comment">/**
</span></span><span class="l" id="857"> 857 <span class="php-comment">     * Setzt eine Replace-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="858"> 858 <span class="php-comment">     * mit den angegebenen Werten ab.
</span></span><span class="l" id="859"> 859 <span class="php-comment">     *
</span></span><span class="l" id="860"> 860 <span class="php-comment">     * @return $this
</span></span><span class="l" id="861"> 861 <span class="php-comment">     *
</span></span><span class="l" id="862"> 862 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="863"> 863 <span class="php-comment">     */</span>
</span><span class="l" id="864"> 864     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> replace()
</span><span class="l" id="865"> 865     {
</span><span class="l" id="866"> 866         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;records) {
</span><span class="l" id="867"> 867             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setMultiRecordQuery(<span class="php-quote">'REPLACE'</span>);
</span><span class="l" id="868"> 868         }
</span><span class="l" id="869"> 869 
</span><span class="l" id="870"> 870         <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="871"> 871             <span class="php-quote">'REPLACE INTO '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' SET '</span> . <span class="php-var">$this</span>-&gt;buildPreparedValues() . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="872"> 872             <span class="php-keyword2">array_merge</span>(<span class="php-var">$this</span>-&gt;values, <span class="php-var">$this</span>-&gt;whereParams)
</span><span class="l" id="873"> 873         );
</span><span class="l" id="874"> 874         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="875"> 875     }
</span><span class="l" id="876"> 876 
</span><span class="l" id="877"> 877     <span class="php-comment">/**
</span></span><span class="l" id="878"> 878 <span class="php-comment">     * Setzt eine Delete-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="879"> 879 <span class="php-comment">     * mit den angegebenen WHERE Parametern ab.
</span></span><span class="l" id="880"> 880 <span class="php-comment">     *
</span></span><span class="l" id="881"> 881 <span class="php-comment">     * @return $this
</span></span><span class="l" id="882"> 882 <span class="php-comment">     *
</span></span><span class="l" id="883"> 883 <span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="884"> 884 <span class="php-comment">     */</span>
</span><span class="l" id="885"> 885     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">delete</span>()
</span><span class="l" id="886"> 886     {
</span><span class="l" id="887"> 887         <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="888"> 888             <span class="php-quote">'DELETE FROM '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="889"> 889             <span class="php-var">$this</span>-&gt;whereParams
</span><span class="l" id="890"> 890         );
</span><span class="l" id="891"> 891         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="892"> 892     }
</span><span class="l" id="893"> 893 
</span><span class="l" id="894"> 894     <span class="php-comment">/**
</span></span><span class="l" id="895"> 895 <span class="php-comment">     * Stellt alle Werte auf den Ursprungszustand zurueck.
</span></span><span class="l" id="896"> 896 <span class="php-comment">     *
</span></span><span class="l" id="897"> 897 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="898"> 898 <span class="php-comment">     */</span>
</span><span class="l" id="899"> 899     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> <span class="php-keyword2">flush</span>()
</span><span class="l" id="900"> 900     {
</span><span class="l" id="901"> 901         <span class="php-var">$this</span>-&gt;values = [];
</span><span class="l" id="902"> 902         <span class="php-var">$this</span>-&gt;rawValues = [];
</span><span class="l" id="903"> 903         <span class="php-var">$this</span>-&gt;records = [];
</span><span class="l" id="904"> 904         <span class="php-var">$this</span>-&gt;whereParams = [];
</span><span class="l" id="905"> 905         <span class="php-var">$this</span>-&gt;lastRow = [];
</span><span class="l" id="906"> 906         <span class="php-var">$this</span>-&gt;fieldnames = <span class="php-keyword1">null</span>;
</span><span class="l" id="907"> 907         <span class="php-var">$this</span>-&gt;rawFieldnames = <span class="php-keyword1">null</span>;
</span><span class="l" id="908"> 908         <span class="php-var">$this</span>-&gt;tablenames = <span class="php-keyword1">null</span>;
</span><span class="l" id="909"> 909 
</span><span class="l" id="910"> 910         <span class="php-var">$this</span>-&gt;table = <span class="php-quote">''</span>;
</span><span class="l" id="911"> 911         <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">''</span>;
</span><span class="l" id="912"> 912         <span class="php-var">$this</span>-&gt;counter = <span class="php-num">0</span>;
</span><span class="l" id="913"> 913         <span class="php-var">$this</span>-&gt;rows = <span class="php-num">0</span>;
</span><span class="l" id="914"> 914 
</span><span class="l" id="915"> 915         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="916"> 916     }
</span><span class="l" id="917"> 917 
</span><span class="l" id="918"> 918     <span class="php-comment">/**
</span></span><span class="l" id="919"> 919 <span class="php-comment">     * Stellt alle Values, die mit setValue() gesetzt wurden, zurueck.
</span></span><span class="l" id="920"> 920 <span class="php-comment">     *
</span></span><span class="l" id="921"> 921 <span class="php-comment">     * @see setValue(), #getValue()
</span></span><span class="l" id="922"> 922 <span class="php-comment">     *
</span></span><span class="l" id="923"> 923 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="924"> 924 <span class="php-comment">     */</span>
</span><span class="l" id="925"> 925     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> flushValues()
</span><span class="l" id="926"> 926     {
</span><span class="l" id="927"> 927         <span class="php-var">$this</span>-&gt;values = [];
</span><span class="l" id="928"> 928         <span class="php-var">$this</span>-&gt;rawValues = [];
</span><span class="l" id="929"> 929 
</span><span class="l" id="930"> 930         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="931"> 931     }
</span><span class="l" id="932"> 932 
</span><span class="l" id="933"> 933     <span class="php-comment">/*
</span></span><span class="l" id="934"> 934 <span class="php-comment">     * Prueft ob das Resultset weitere Datensaetze enthaelt
</span></span><span class="l" id="935"> 935 <span class="php-comment">     */</span>
</span><span class="l" id="936"> 936     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasNext()
</span><span class="l" id="937"> 937     {
</span><span class="l" id="938"> 938         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;counter &lt; <span class="php-var">$this</span>-&gt;rows;
</span><span class="l" id="939"> 939     }
</span><span class="l" id="940"> 940 
</span><span class="l" id="941"> 941     <span class="php-comment">/**
</span></span><span class="l" id="942"> 942 <span class="php-comment">     * Setzt den Cursor des Resultsets zurueck zum Anfang.
</span></span><span class="l" id="943"> 943 <span class="php-comment">     *
</span></span><span class="l" id="944"> 944 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="945"> 945 <span class="php-comment">     */</span>
</span><span class="l" id="946"> 946     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">reset</span>()
</span><span class="l" id="947"> 947     {
</span><span class="l" id="948"> 948         <span class="php-comment">// re-execute the statement</span>
</span><span class="l" id="949"> 949         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;stmt &amp;&amp; <span class="php-var">$this</span>-&gt;counter != <span class="php-num">0</span>) {
</span><span class="l" id="950"> 950             <span class="php-var">$this</span>-&gt;execute(<span class="php-var">$this</span>-&gt;params);
</span><span class="l" id="951"> 951             <span class="php-var">$this</span>-&gt;counter = <span class="php-num">0</span>;
</span><span class="l" id="952"> 952         }
</span><span class="l" id="953"> 953 
</span><span class="l" id="954"> 954         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="955"> 955     }
</span><span class="l" id="956"> 956 
</span><span class="l" id="957"> 957     <span class="php-comment">/**
</span></span><span class="l" id="958"> 958 <span class="php-comment">     * Gibt die letzte InsertId zurueck.
</span></span><span class="l" id="959"> 959 <span class="php-comment">     */</span>
</span><span class="l" id="960"> 960     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getLastId()
</span><span class="l" id="961"> 961     {
</span><span class="l" id="962"> 962         <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;lastInsertId();
</span><span class="l" id="963"> 963     }
</span><span class="l" id="964"> 964 
</span><span class="l" id="965"> 965     <span class="php-comment">/**
</span></span><span class="l" id="966"> 966 <span class="php-comment">     * Laedt das komplette Resultset in ein Array und gibt dieses zurueck und
</span></span><span class="l" id="967"> 967 <span class="php-comment">     * wechselt die DBID falls vorhanden.
</span></span><span class="l" id="968"> 968 <span class="php-comment">     *
</span></span><span class="l" id="969"> 969 <span class="php-comment">     * @param string $query     The sql-query
</span></span><span class="l" id="970"> 970 <span class="php-comment">     * @param array  $params    An optional array of statement parameter
</span></span><span class="l" id="971"> 971 <span class="php-comment">     * @param int    $fetchType
</span></span><span class="l" id="972"> 972 <span class="php-comment">     *
</span></span><span class="l" id="973"> 973 <span class="php-comment">     * @return array
</span></span><span class="l" id="974"> 974 <span class="php-comment">     *
</span></span><span class="l" id="975"> 975 <span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="976"> 976 <span class="php-comment">     */</span>
</span><span class="l" id="977"> 977     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getDBArray(<span class="php-var">$query</span> = <span class="php-keyword1">null</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-var">$fetchType</span> = PDO::FETCH_ASSOC)
</span><span class="l" id="978"> 978     {
</span><span class="l" id="979"> 979         <span class="php-keyword1">if</span> (!<span class="php-var">$query</span>) {
</span><span class="l" id="980"> 980             <span class="php-var">$query</span> = <span class="php-var">$this</span>-&gt;query;
</span><span class="l" id="981"> 981             <span class="php-var">$params</span> = <span class="php-var">$this</span>-&gt;params;
</span><span class="l" id="982"> 982         }
</span><span class="l" id="983"> 983 
</span><span class="l" id="984"> 984         <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="985"> 985 
</span><span class="l" id="986"> 986         <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">false</span>);
</span><span class="l" id="987"> 987         <span class="php-var">$this</span>-&gt;setDBQuery(<span class="php-var">$query</span>, <span class="php-var">$params</span>);
</span><span class="l" id="988"> 988         <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">true</span>);
</span><span class="l" id="989"> 989 
</span><span class="l" id="990"> 990         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt-&gt;fetchAll(<span class="php-var">$fetchType</span>);
</span><span class="l" id="991"> 991     }
</span><span class="l" id="992"> 992 
</span><span class="l" id="993"> 993     <span class="php-comment">/**
</span></span><span class="l" id="994"> 994 <span class="php-comment">     * Laedt das komplette Resultset in ein Array und gibt dieses zurueck.
</span></span><span class="l" id="995"> 995 <span class="php-comment">     *
</span></span><span class="l" id="996"> 996 <span class="php-comment">     * @param string $query     The sql-query
</span></span><span class="l" id="997"> 997 <span class="php-comment">     * @param array  $params    An optional array of statement parameter
</span></span><span class="l" id="998"> 998 <span class="php-comment">     * @param int    $fetchType
</span></span><span class="l" id="999"> 999 <span class="php-comment">     *
</span></span><span class="l" id="1000">1000 <span class="php-comment">     * @return array
</span></span><span class="l" id="1001">1001 <span class="php-comment">     *
</span></span><span class="l" id="1002">1002 <span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="1003">1003 <span class="php-comment">     */</span>
</span><span class="l" id="1004">1004     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getArray(<span class="php-var">$query</span> = <span class="php-keyword1">null</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-var">$fetchType</span> = PDO::FETCH_ASSOC)
</span><span class="l" id="1005">1005     {
</span><span class="l" id="1006">1006         <span class="php-keyword1">if</span> (!<span class="php-var">$query</span>) {
</span><span class="l" id="1007">1007             <span class="php-var">$query</span> = <span class="php-var">$this</span>-&gt;query;
</span><span class="l" id="1008">1008             <span class="php-var">$params</span> = <span class="php-var">$this</span>-&gt;params;
</span><span class="l" id="1009">1009         }
</span><span class="l" id="1010">1010 
</span><span class="l" id="1011">1011         <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="1012">1012 
</span><span class="l" id="1013">1013         <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">false</span>);
</span><span class="l" id="1014">1014         <span class="php-var">$this</span>-&gt;setQuery(<span class="php-var">$query</span>, <span class="php-var">$params</span>);
</span><span class="l" id="1015">1015         <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">true</span>);
</span><span class="l" id="1016">1016 
</span><span class="l" id="1017">1017         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt-&gt;fetchAll(<span class="php-var">$fetchType</span>);
</span><span class="l" id="1018">1018     }
</span><span class="l" id="1019">1019 
</span><span class="l" id="1020">1020     <span class="php-comment">/**
</span></span><span class="l" id="1021">1021 <span class="php-comment">     * Gibt die zuletzt aufgetretene Fehlernummer zurueck.
</span></span><span class="l" id="1022">1022 <span class="php-comment">     */</span>
</span><span class="l" id="1023">1023     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getErrno()
</span><span class="l" id="1024">1024     {
</span><span class="l" id="1025">1025         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;errorCode() : self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;errorCode();
</span><span class="l" id="1026">1026     }
</span><span class="l" id="1027">1027 
</span><span class="l" id="1028">1028     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getMysqlErrno()
</span><span class="l" id="1029">1029     {
</span><span class="l" id="1030">1030         <span class="php-var">$errorInfos</span> = <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;errorInfo() : self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;errorInfo();
</span><span class="l" id="1031">1031 
</span><span class="l" id="1032">1032         <span class="php-keyword1">return</span> (int) <span class="php-var">$errorInfos</span>[<span class="php-num">1</span>];
</span><span class="l" id="1033">1033     }
</span><span class="l" id="1034">1034 
</span><span class="l" id="1035">1035     <span class="php-comment">/**
</span></span><span class="l" id="1036">1036 <span class="php-comment">     * Gibt den zuletzt aufgetretene Fehler zurueck.
</span></span><span class="l" id="1037">1037 <span class="php-comment">     */</span>
</span><span class="l" id="1038">1038     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getError()
</span><span class="l" id="1039">1039     {
</span><span class="l" id="1040">1040         <span class="php-var">$errorInfos</span> = <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;errorInfo() : self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;errorInfo();
</span><span class="l" id="1041">1041         <span class="php-comment">// idx0   SQLSTATE error code (a five characters alphanumeric identifier defined in the ANSI SQL standard).</span>
</span><span class="l" id="1042">1042         <span class="php-comment">// idx1   Driver-specific error code.</span>
</span><span class="l" id="1043">1043         <span class="php-comment">// idx2   Driver-specific error message.</span>
</span><span class="l" id="1044">1044         <span class="php-keyword1">return</span> <span class="php-var">$errorInfos</span>[<span class="php-num">2</span>];
</span><span class="l" id="1045">1045     }
</span><span class="l" id="1046">1046 
</span><span class="l" id="1047">1047     <span class="php-comment">/**
</span></span><span class="l" id="1048">1048 <span class="php-comment">     * Prueft, ob ein Fehler aufgetreten ist.
</span></span><span class="l" id="1049">1049 <span class="php-comment">     */</span>
</span><span class="l" id="1050">1050     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasError()
</span><span class="l" id="1051">1051     {
</span><span class="l" id="1052">1052         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getErrno() != <span class="php-num">0</span>;
</span><span class="l" id="1053">1053     }
</span><span class="l" id="1054">1054 
</span><span class="l" id="1055">1055     <span class="php-comment">/**
</span></span><span class="l" id="1056">1056 <span class="php-comment">     * Gibt die letzte Fehlermeldung aus.
</span></span><span class="l" id="1057">1057 <span class="php-comment">     */</span>
</span><span class="l" id="1058">1058     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> printError(<span class="php-var">$qry</span>, <span class="php-var">$params</span>)
</span><span class="l" id="1059">1059     {
</span><span class="l" id="1060">1060         <span class="php-var">$errors</span>[<span class="php-quote">'debug'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="1061">1061         <span class="php-var">$errors</span>[<span class="php-quote">'query'</span>] = <span class="php-var">$qry</span>;
</span><span class="l" id="1062">1062         <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>)) {
</span><span class="l" id="1063">1063             <span class="php-var">$errors</span>[<span class="php-quote">'params'</span>] = <span class="php-var">$params</span>;
</span><span class="l" id="1064">1064         }
</span><span class="l" id="1065">1065         <span class="php-keyword1">if</span> (<span class="php-keyword2">strlen</span>(<span class="php-var">$this</span>-&gt;getRows()) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="1066">1066             <span class="php-var">$errors</span>[<span class="php-quote">'count'</span>] = <span class="php-var">$this</span>-&gt;getRows();
</span><span class="l" id="1067">1067         }
</span><span class="l" id="1068">1068         <span class="php-keyword1">if</span> (<span class="php-keyword2">strlen</span>(<span class="php-var">$this</span>-&gt;getError()) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="1069">1069             <span class="php-var">$errors</span>[<span class="php-quote">'error'</span>] = <span class="php-var">$this</span>-&gt;getError();
</span><span class="l" id="1070">1070             <span class="php-var">$errors</span>[<span class="php-quote">'ecode'</span>] = <span class="php-var">$this</span>-&gt;getErrno();
</span><span class="l" id="1071">1071         }
</span><span class="l" id="1072">1072         dump(<span class="php-var">$errors</span>);
</span><span class="l" id="1073">1073     }
</span><span class="l" id="1074">1074 
</span><span class="l" id="1075">1075     <span class="php-comment">/**
</span></span><span class="l" id="1076">1076 <span class="php-comment">     * Setzt eine Spalte auf den naechst moeglich auto_increment Wert.
</span></span><span class="l" id="1077">1077 <span class="php-comment">     *
</span></span><span class="l" id="1078">1078 <span class="php-comment">     * @param string $field    Name der Spalte
</span></span><span class="l" id="1079">1079 <span class="php-comment">     * @param int    $start_id
</span></span><span class="l" id="1080">1080 <span class="php-comment">     *
</span></span><span class="l" id="1081">1081 <span class="php-comment">     * @return int
</span></span><span class="l" id="1082">1082 <span class="php-comment">     */</span>
</span><span class="l" id="1083">1083     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setNewId(<span class="php-var">$field</span>, <span class="php-var">$start_id</span> = <span class="php-num">0</span>)
</span><span class="l" id="1084">1084     {
</span><span class="l" id="1085">1085         <span class="php-comment">// setNewId muss neues sql Objekt verwenden, da sonst bestehende informationen im Objekt ueberschrieben werden</span>
</span><span class="l" id="1086">1086         <span class="php-var">$sql</span> = self::factory();
</span><span class="l" id="1087">1087         <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SELECT '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$field</span>) . <span class="php-quote">' FROM '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' ORDER BY '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$field</span>) . <span class="php-quote">' DESC LIMIT 1'</span>);
</span><span class="l" id="1088">1088         <span class="php-keyword1">if</span> (<span class="php-var">$sql</span>-&gt;getRows() == <span class="php-num">0</span>) {
</span><span class="l" id="1089">1089             <span class="php-var">$id</span> = <span class="php-var">$start_id</span>;
</span><span class="l" id="1090">1090         } <span class="php-keyword1">else</span> {
</span><span class="l" id="1091">1091             <span class="php-var">$id</span> = <span class="php-var">$sql</span>-&gt;getValue(<span class="php-var">$field</span>);
</span><span class="l" id="1092">1092         }
</span><span class="l" id="1093">1093         ++<span class="php-var">$id</span>;
</span><span class="l" id="1094">1094         <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$field</span>, <span class="php-var">$id</span>);
</span><span class="l" id="1095">1095 
</span><span class="l" id="1096">1096         <span class="php-keyword1">return</span> <span class="php-var">$id</span>;
</span><span class="l" id="1097">1097     }
</span><span class="l" id="1098">1098 
</span><span class="l" id="1099">1099     <span class="php-comment">/**
</span></span><span class="l" id="1100">1100 <span class="php-comment">     * Gibt die Spaltennamen des ResultSets zurueck.
</span></span><span class="l" id="1101">1101 <span class="php-comment">     */</span>
</span><span class="l" id="1102">1102     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getFieldnames()
</span><span class="l" id="1103">1103     {
</span><span class="l" id="1104">1104         <span class="php-var">$this</span>-&gt;fetchMeta();
</span><span class="l" id="1105">1105         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;fieldnames;
</span><span class="l" id="1106">1106     }
</span><span class="l" id="1107">1107 
</span><span class="l" id="1108">1108     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getTablenames()
</span><span class="l" id="1109">1109     {
</span><span class="l" id="1110">1110         <span class="php-var">$this</span>-&gt;fetchMeta();
</span><span class="l" id="1111">1111         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;tablenames;
</span><span class="l" id="1112">1112     }
</span><span class="l" id="1113">1113 
</span><span class="l" id="1114">1114     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> fetchMeta()
</span><span class="l" id="1115">1115     {
</span><span class="l" id="1116">1116         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;fieldnames === <span class="php-keyword1">null</span>) {
</span><span class="l" id="1117">1117             <span class="php-var">$this</span>-&gt;rawFieldnames = [];
</span><span class="l" id="1118">1118             <span class="php-var">$this</span>-&gt;fieldnames = [];
</span><span class="l" id="1119">1119             <span class="php-var">$this</span>-&gt;tablenames = [];
</span><span class="l" id="1120">1120 
</span><span class="l" id="1121">1121             <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$this</span>-&gt;getFields(); ++<span class="php-var">$i</span>) {
</span><span class="l" id="1122">1122                 <span class="php-var">$metadata</span> = <span class="php-var">$this</span>-&gt;stmt-&gt;getColumnMeta(<span class="php-var">$i</span>);
</span><span class="l" id="1123">1123 
</span><span class="l" id="1124">1124                 <span class="php-comment">// strip table-name from column</span>
</span><span class="l" id="1125">1125                 <span class="php-var">$this</span>-&gt;fieldnames[] = <span class="php-keyword2">substr</span>(<span class="php-var">$metadata</span>[<span class="php-quote">'name'</span>], <span class="php-keyword2">strlen</span>(<span class="php-var">$metadata</span>[<span class="php-quote">'table'</span>] . <span class="php-quote">'.'</span>));
</span><span class="l" id="1126">1126                 <span class="php-var">$this</span>-&gt;rawFieldnames[] = <span class="php-var">$metadata</span>[<span class="php-quote">'name'</span>];
</span><span class="l" id="1127">1127 
</span><span class="l" id="1128">1128                 <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$metadata</span>[<span class="php-quote">'table'</span>], <span class="php-var">$this</span>-&gt;tablenames)) {
</span><span class="l" id="1129">1129                     <span class="php-var">$this</span>-&gt;tablenames[] = <span class="php-var">$metadata</span>[<span class="php-quote">'table'</span>];
</span><span class="l" id="1130">1130                 }
</span><span class="l" id="1131">1131             }
</span><span class="l" id="1132">1132         }
</span><span class="l" id="1133">1133     }
</span><span class="l" id="1134">1134 
</span><span class="l" id="1135">1135     <span class="php-comment">/**
</span></span><span class="l" id="1136">1136 <span class="php-comment">     * Escaped den uebergeben Wert fuer den DB Query.
</span></span><span class="l" id="1137">1137 <span class="php-comment">     *
</span></span><span class="l" id="1138">1138 <span class="php-comment">     * @param string $value den zu escapenden Wert
</span></span><span class="l" id="1139">1139 <span class="php-comment">     *
</span></span><span class="l" id="1140">1140 <span class="php-comment">     * @return string
</span></span><span class="l" id="1141">1141 <span class="php-comment">     */</span>
</span><span class="l" id="1142">1142     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> escape(<span class="php-var">$value</span>)
</span><span class="l" id="1143">1143     {
</span><span class="l" id="1144">1144         <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;quote(<span class="php-var">$value</span>);
</span><span class="l" id="1145">1145     }
</span><span class="l" id="1146">1146 
</span><span class="l" id="1147">1147     <span class="php-comment">/**
</span></span><span class="l" id="1148">1148 <span class="php-comment">     * Escapes and adds backsticks around.
</span></span><span class="l" id="1149">1149 <span class="php-comment">     *
</span></span><span class="l" id="1150">1150 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="1151">1151 <span class="php-comment">     *
</span></span><span class="l" id="1152">1152 <span class="php-comment">     * @return string
</span></span><span class="l" id="1153">1153 <span class="php-comment">     */</span>
</span><span class="l" id="1154">1154     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> escapeIdentifier(<span class="php-var">$name</span>)
</span><span class="l" id="1155">1155     {
</span><span class="l" id="1156">1156         <span class="php-keyword1">return</span> <span class="php-quote">'`'</span> . <span class="php-keyword2">str_replace</span>(<span class="php-quote">'`'</span>, <span class="php-quote">'``'</span>, <span class="php-var">$name</span>) . <span class="php-quote">'`'</span>;
</span><span class="l" id="1157">1157     }
</span><span class="l" id="1158">1158 
</span><span class="l" id="1159">1159     <span class="php-comment">/**
</span></span><span class="l" id="1160">1160 <span class="php-comment">     * @param string $user the name of the user who created the dataset. Defaults to the current user
</span></span><span class="l" id="1161">1161 <span class="php-comment">     *
</span></span><span class="l" id="1162">1162 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="1163">1163 <span class="php-comment">     */</span>
</span><span class="l" id="1164">1164     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> addGlobalUpdateFields(<span class="php-var">$user</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="1165">1165     {
</span><span class="l" id="1166">1166         <span class="php-keyword1">if</span> (!<span class="php-var">$user</span>) {
</span><span class="l" id="1167">1167             <span class="php-var">$user</span> = rex::getUser()-&gt;getValue(<span class="php-quote">'login'</span>);
</span><span class="l" id="1168">1168         }
</span><span class="l" id="1169">1169 
</span><span class="l" id="1170">1170         <span class="php-var">$this</span>-&gt;setDateTimeValue(<span class="php-quote">'updatedate'</span>, <span class="php-keyword2">time</span>());
</span><span class="l" id="1171">1171         <span class="php-var">$this</span>-&gt;setValue(<span class="php-quote">'updateuser'</span>, <span class="php-var">$user</span>);
</span><span class="l" id="1172">1172 
</span><span class="l" id="1173">1173         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="1174">1174     }
</span><span class="l" id="1175">1175 
</span><span class="l" id="1176">1176     <span class="php-comment">/**
</span></span><span class="l" id="1177">1177 <span class="php-comment">     * @param string $user the name of the user who updated the dataset. Defaults to the current user
</span></span><span class="l" id="1178">1178 <span class="php-comment">     *
</span></span><span class="l" id="1179">1179 <span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="1180">1180 <span class="php-comment">     */</span>
</span><span class="l" id="1181">1181     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> addGlobalCreateFields(<span class="php-var">$user</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="1182">1182     {
</span><span class="l" id="1183">1183         <span class="php-keyword1">if</span> (!<span class="php-var">$user</span>) {
</span><span class="l" id="1184">1184             <span class="php-var">$user</span> = rex::getUser()-&gt;getValue(<span class="php-quote">'login'</span>);
</span><span class="l" id="1185">1185         }
</span><span class="l" id="1186">1186 
</span><span class="l" id="1187">1187         <span class="php-var">$this</span>-&gt;setDateTimeValue(<span class="php-quote">'createdate'</span>, <span class="php-keyword2">time</span>());
</span><span class="l" id="1188">1188         <span class="php-var">$this</span>-&gt;setValue(<span class="php-quote">'createuser'</span>, <span class="php-var">$user</span>);
</span><span class="l" id="1189">1189 
</span><span class="l" id="1190">1190         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="1191">1191     }
</span><span class="l" id="1192">1192 
</span><span class="l" id="1193">1193     <span class="php-comment">/**
</span></span><span class="l" id="1194">1194 <span class="php-comment">     * Starts a database transaction.
</span></span><span class="l" id="1195">1195 <span class="php-comment">     *
</span></span><span class="l" id="1196">1196 <span class="php-comment">     * @throws rex_sql_exception when a transaction is already running
</span></span><span class="l" id="1197">1197 <span class="php-comment">     *
</span></span><span class="l" id="1198">1198 <span class="php-comment">     * @return bool Indicating whether the transaction was successfully started
</span></span><span class="l" id="1199">1199 <span class="php-comment">     */</span>
</span><span class="l" id="1200">1200     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> beginTransaction()
</span><span class="l" id="1201">1201     {
</span><span class="l" id="1202">1202         <span class="php-keyword1">if</span> (self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction()) {
</span><span class="l" id="1203">1203             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Transaction already started'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="1204">1204         }
</span><span class="l" id="1205">1205         <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;beginTransaction();
</span><span class="l" id="1206">1206     }
</span><span class="l" id="1207">1207 
</span><span class="l" id="1208">1208     <span class="php-comment">/**
</span></span><span class="l" id="1209">1209 <span class="php-comment">     * Rollback a already started database transaction.
</span></span><span class="l" id="1210">1210 <span class="php-comment">     *
</span></span><span class="l" id="1211">1211 <span class="php-comment">     * @throws rex_sql_exception when no transaction was started beforehand
</span></span><span class="l" id="1212">1212 <span class="php-comment">     *
</span></span><span class="l" id="1213">1213 <span class="php-comment">     * @return bool Indicating whether the transaction was successfully rollbacked
</span></span><span class="l" id="1214">1214 <span class="php-comment">     */</span>
</span><span class="l" id="1215">1215     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> rollBack()
</span><span class="l" id="1216">1216     {
</span><span class="l" id="1217">1217         <span class="php-keyword1">if</span> (!self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction()) {
</span><span class="l" id="1218">1218             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Unable to rollback, no transaction started before'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="1219">1219         }
</span><span class="l" id="1220">1220         <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;rollBack();
</span><span class="l" id="1221">1221     }
</span><span class="l" id="1222">1222 
</span><span class="l" id="1223">1223     <span class="php-comment">/**
</span></span><span class="l" id="1224">1224 <span class="php-comment">     * Commit a already started database transaction.
</span></span><span class="l" id="1225">1225 <span class="php-comment">     *
</span></span><span class="l" id="1226">1226 <span class="php-comment">     * @throws rex_sql_exception when no transaction was started beforehand
</span></span><span class="l" id="1227">1227 <span class="php-comment">     *
</span></span><span class="l" id="1228">1228 <span class="php-comment">     * @return bool Indicating whether the transaction was successfully committed
</span></span><span class="l" id="1229">1229 <span class="php-comment">     */</span>
</span><span class="l" id="1230">1230     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> commit()
</span><span class="l" id="1231">1231     {
</span><span class="l" id="1232">1232         <span class="php-keyword1">if</span> (!self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction()) {
</span><span class="l" id="1233">1233             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Unable to commit, no transaction started before'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="1234">1234         }
</span><span class="l" id="1235">1235         <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;commit();
</span><span class="l" id="1236">1236     }
</span><span class="l" id="1237">1237 
</span><span class="l" id="1238">1238     <span class="php-comment">/**
</span></span><span class="l" id="1239">1239 <span class="php-comment">     * @return bool Whether a transaction was already started/is already running.
</span></span><span class="l" id="1240">1240 <span class="php-comment">     */</span>
</span><span class="l" id="1241">1241     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> inTransaction()
</span><span class="l" id="1242">1242     {
</span><span class="l" id="1243">1243         <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction();
</span><span class="l" id="1244">1244     }
</span><span class="l" id="1245">1245 
</span><span class="l" id="1246">1246     <span class="php-comment">/**
</span></span><span class="l" id="1247">1247 <span class="php-comment">     * Convenience method which executes the given callable within a transaction.
</span></span><span class="l" id="1248">1248 <span class="php-comment">     *
</span></span><span class="l" id="1249">1249 <span class="php-comment">     * In case the callable throws, the transaction will automatically rolled back.
</span></span><span class="l" id="1250">1250 <span class="php-comment">     * In case no error happens, the transaction will be committed after the callable was called.
</span></span><span class="l" id="1251">1251 <span class="php-comment">     */</span>
</span><span class="l" id="1252">1252     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> transactional(<span class="php-keyword1">callable</span> <span class="php-var">$callable</span>)
</span><span class="l" id="1253">1253     {
</span><span class="l" id="1254">1254         <span class="php-var">$inTransaction</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction();
</span><span class="l" id="1255">1255         <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1256">1256             self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;beginTransaction();
</span><span class="l" id="1257">1257         }
</span><span class="l" id="1258">1258         <span class="php-keyword1">try</span> {
</span><span class="l" id="1259">1259             <span class="php-var">$result</span> = <span class="php-var">$callable</span>();
</span><span class="l" id="1260">1260             <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1261">1261                 self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;commit();
</span><span class="l" id="1262">1262             }
</span><span class="l" id="1263">1263             <span class="php-keyword1">return</span> <span class="php-var">$result</span>;
</span><span class="l" id="1264">1264         } <span class="php-keyword1">catch</span> (\Exception <span class="php-var">$e</span>) {
</span><span class="l" id="1265">1265             <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1266">1266                 self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;rollBack();
</span><span class="l" id="1267">1267             }
</span><span class="l" id="1268">1268             <span class="php-keyword1">throw</span> <span class="php-var">$e</span>;
</span><span class="l" id="1269">1269         } <span class="php-keyword1">catch</span> (\Throwable <span class="php-var">$e</span>) {
</span><span class="l" id="1270">1270             <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1271">1271                 self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;rollBack();
</span><span class="l" id="1272">1272             }
</span><span class="l" id="1273">1273             <span class="php-keyword1">throw</span> <span class="php-var">$e</span>;
</span><span class="l" id="1274">1274         }
</span><span class="l" id="1275">1275     }
</span><span class="l" id="1276">1276 
</span><span class="l" id="1277">1277     <span class="php-comment">// ----------------- iterator interface</span>
</span><span class="l" id="1278">1278 
</span><span class="l" id="1279">1279     <span class="php-comment">/**
</span></span><span class="l" id="1280">1280 <span class="php-comment">     * @see http://www.php.net/manual/en/iterator.rewind.php
</span></span><span class="l" id="1281">1281 <span class="php-comment">     */</span>
</span><span class="l" id="1282">1282     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">rewind</span>()
</span><span class="l" id="1283">1283     {
</span><span class="l" id="1284">1284         <span class="php-var">$this</span>-&gt;<span class="php-keyword2">reset</span>();
</span><span class="l" id="1285">1285     }
</span><span class="l" id="1286">1286 
</span><span class="l" id="1287">1287     <span class="php-comment">/**
</span></span><span class="l" id="1288">1288 <span class="php-comment">     * @see http://www.php.net/manual/en/iterator.current.php
</span></span><span class="l" id="1289">1289 <span class="php-comment">     *
</span></span><span class="l" id="1290">1290 <span class="php-comment">     * @return $this
</span></span><span class="l" id="1291">1291 <span class="php-comment">     */</span>
</span><span class="l" id="1292">1292     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">current</span>()
</span><span class="l" id="1293">1293     {
</span><span class="l" id="1294">1294         <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="1295">1295     }
</span><span class="l" id="1296">1296 
</span><span class="l" id="1297">1297     <span class="php-comment">/**
</span></span><span class="l" id="1298">1298 <span class="php-comment">     * @see http://www.php.net/manual/en/iterator.key.php
</span></span><span class="l" id="1299">1299 <span class="php-comment">     */</span>
</span><span class="l" id="1300">1300     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">key</span>()
</span><span class="l" id="1301">1301     {
</span><span class="l" id="1302">1302         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;counter;
</span><span class="l" id="1303">1303     }
</span><span class="l" id="1304">1304 
</span><span class="l" id="1305">1305     <span class="php-comment">/**
</span></span><span class="l" id="1306">1306 <span class="php-comment">     * @see http://www.php.net/manual/en/iterator.next.php
</span></span><span class="l" id="1307">1307 <span class="php-comment">     */</span>
</span><span class="l" id="1308">1308     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">next</span>()
</span><span class="l" id="1309">1309     {
</span><span class="l" id="1310">1310         ++<span class="php-var">$this</span>-&gt;counter;
</span><span class="l" id="1311">1311         <span class="php-var">$this</span>-&gt;lastRow = <span class="php-var">$this</span>-&gt;stmt-&gt;fetch();
</span><span class="l" id="1312">1312     }
</span><span class="l" id="1313">1313 
</span><span class="l" id="1314">1314     <span class="php-comment">/**
</span></span><span class="l" id="1315">1315 <span class="php-comment">     * @see http://www.php.net/manual/en/iterator.valid.php
</span></span><span class="l" id="1316">1316 <span class="php-comment">     */</span>
</span><span class="l" id="1317">1317     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> valid()
</span><span class="l" id="1318">1318     {
</span><span class="l" id="1319">1319         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;hasNext();
</span><span class="l" id="1320">1320     }
</span><span class="l" id="1321">1321 
</span><span class="l" id="1322">1322     <span class="php-comment">// ----------------- /iterator interface</span>
</span><span class="l" id="1323">1323 
</span><span class="l" id="1324">1324     <span class="php-comment">/**
</span></span><span class="l" id="1325">1325 <span class="php-comment">     * Erstellt das CREATE TABLE Statement um die Tabelle $table
</span></span><span class="l" id="1326">1326 <span class="php-comment">     * der Datenbankverbindung $DBID zu erstellen.
</span></span><span class="l" id="1327">1327 <span class="php-comment">     *
</span></span><span class="l" id="1328">1328 <span class="php-comment">     * @param string $table Name der Tabelle
</span></span><span class="l" id="1329">1329 <span class="php-comment">     * @param int    $DBID  Id der Datenbankverbindung
</span></span><span class="l" id="1330">1330 <span class="php-comment">     *
</span></span><span class="l" id="1331">1331 <span class="php-comment">     * @return string CREATE TABLE Sql-Statement zu erstsellung der Tabelle
</span></span><span class="l" id="1332">1332 <span class="php-comment">     */</span>
</span><span class="l" id="1333">1333     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> showCreateTable(<span class="php-var">$table</span>, <span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1334">1334     {
</span><span class="l" id="1335">1335         <span class="php-var">$sql</span> = self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1336">1336         <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SHOW CREATE TABLE '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>));
</span><span class="l" id="1337">1337 
</span><span class="l" id="1338">1338         <span class="php-keyword1">if</span> (!<span class="php-var">$sql</span>-&gt;getRows()) {
</span><span class="l" id="1339">1339             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Table "%s" does not exist.'</span>, <span class="php-var">$table</span>));
</span><span class="l" id="1340">1340         }
</span><span class="l" id="1341">1341         <span class="php-keyword1">if</span> (!<span class="php-var">$sql</span>-&gt;hasValue(<span class="php-quote">'Create Table'</span>)) {
</span><span class="l" id="1342">1342             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Table "%s" does not exist, it is a view instead.'</span>, <span class="php-var">$table</span>));
</span><span class="l" id="1343">1343         }
</span><span class="l" id="1344">1344 
</span><span class="l" id="1345">1345         <span class="php-keyword1">return</span> <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'Create Table'</span>);
</span><span class="l" id="1346">1346     }
</span><span class="l" id="1347">1347 
</span><span class="l" id="1348">1348     <span class="php-comment">/**
</span></span><span class="l" id="1349">1349 <span class="php-comment">     * Sucht alle Tabellen der Datenbankverbindung $DBID.
</span></span><span class="l" id="1350">1350 <span class="php-comment">     * Falls $tablePrefix gesetzt ist, werden nur dem Prefix entsprechende Tabellen gesucht.
</span></span><span class="l" id="1351">1351 <span class="php-comment">     *
</span></span><span class="l" id="1352">1352 <span class="php-comment">     * @param int    $DBID        Id der Datenbankverbindung
</span></span><span class="l" id="1353">1353 <span class="php-comment">     * @param string $tablePrefix Zu suchender Tabellennamen-Prefix
</span></span><span class="l" id="1354">1354 <span class="php-comment">     *
</span></span><span class="l" id="1355">1355 <span class="php-comment">     * @return array Ein Array von Tabellennamen
</span></span><span class="l" id="1356">1356 <span class="php-comment">     */</span>
</span><span class="l" id="1357">1357     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> showTables(<span class="php-var">$DBID</span> = <span class="php-num">1</span>, <span class="php-var">$tablePrefix</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="1358">1358     {
</span><span class="l" id="1359">1359         <span class="php-var">$sql</span> = self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1360">1360 
</span><span class="l" id="1361">1361         <span class="php-var">$qry</span> = <span class="php-quote">'SHOW FULL TABLES WHERE Table_type = "BASE TABLE"'</span>;
</span><span class="l" id="1362">1362         <span class="php-keyword1">if</span> (<span class="php-var">$tablePrefix</span> != <span class="php-keyword1">null</span>) {
</span><span class="l" id="1363">1363             <span class="php-comment">// replace LIKE wildcards</span>
</span><span class="l" id="1364">1364             <span class="php-var">$tablePrefix</span> = <span class="php-keyword2">str_replace</span>([<span class="php-quote">'_'</span>, <span class="php-quote">'%'</span>], [<span class="php-quote">'\_'</span>, <span class="php-quote">'\%'</span>], <span class="php-var">$tablePrefix</span>);
</span><span class="l" id="1365">1365             <span class="php-var">$column</span> = <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-quote">'Tables_in_'</span>.rex::getProperty(<span class="php-quote">'db'</span>)[<span class="php-var">$DBID</span>][<span class="php-quote">'name'</span>]);
</span><span class="l" id="1366">1366             <span class="php-var">$qry</span> .= <span class="php-quote">' AND '</span>.<span class="php-var">$column</span>.<span class="php-quote">' LIKE "'</span> . <span class="php-var">$tablePrefix</span> . <span class="php-quote">'%"'</span>;
</span><span class="l" id="1367">1367         }
</span><span class="l" id="1368">1368 
</span><span class="l" id="1369">1369         <span class="php-var">$tables</span> = <span class="php-var">$sql</span>-&gt;getArray(<span class="php-var">$qry</span>);
</span><span class="l" id="1370">1370         <span class="php-var">$tables</span> = <span class="php-keyword2">array_map</span>(<span class="php-quote">'reset'</span>, <span class="php-var">$tables</span>);
</span><span class="l" id="1371">1371 
</span><span class="l" id="1372">1372         <span class="php-keyword1">return</span> <span class="php-var">$tables</span>;
</span><span class="l" id="1373">1373     }
</span><span class="l" id="1374">1374 
</span><span class="l" id="1375">1375     <span class="php-comment">/**
</span></span><span class="l" id="1376">1376 <span class="php-comment">     * Sucht Spalteninformationen der Tabelle $table der Datenbankverbindung $DBID.
</span></span><span class="l" id="1377">1377 <span class="php-comment">     *
</span></span><span class="l" id="1378">1378 <span class="php-comment">     * Beispiel fuer den Rueckgabewert:
</span></span><span class="l" id="1379">1379 <span class="php-comment">     *
</span></span><span class="l" id="1380">1380 <span class="php-comment">     * Array (
</span></span><span class="l" id="1381">1381 <span class="php-comment">     *  [0] =&gt; Array (
</span></span><span class="l" id="1382">1382 <span class="php-comment">     *    [name] =&gt; pid
</span></span><span class="l" id="1383">1383 <span class="php-comment">     *    [type] =&gt; int(11)
</span></span><span class="l" id="1384">1384 <span class="php-comment">     *    [null] =&gt; NO
</span></span><span class="l" id="1385">1385 <span class="php-comment">     *    [key] =&gt; PRI
</span></span><span class="l" id="1386">1386 <span class="php-comment">     *    [default] =&gt;
</span></span><span class="l" id="1387">1387 <span class="php-comment">     *    [extra] =&gt; auto_increment
</span></span><span class="l" id="1388">1388 <span class="php-comment">     *  )
</span></span><span class="l" id="1389">1389 <span class="php-comment">     *  [1] =&gt; Array (
</span></span><span class="l" id="1390">1390 <span class="php-comment">     *    [name] =&gt; id
</span></span><span class="l" id="1391">1391 <span class="php-comment">     *    [type] =&gt; int(11)
</span></span><span class="l" id="1392">1392 <span class="php-comment">     *    [null] =&gt; NO
</span></span><span class="l" id="1393">1393 <span class="php-comment">     *    [key] =&gt; MUL
</span></span><span class="l" id="1394">1394 <span class="php-comment">     *    [default] =&gt;
</span></span><span class="l" id="1395">1395 <span class="php-comment">     *    [extra] =&gt;
</span></span><span class="l" id="1396">1396 <span class="php-comment">     *  )
</span></span><span class="l" id="1397">1397 <span class="php-comment">     * )
</span></span><span class="l" id="1398">1398 <span class="php-comment">     *
</span></span><span class="l" id="1399">1399 <span class="php-comment">     * @param string $table Name der Tabelle
</span></span><span class="l" id="1400">1400 <span class="php-comment">     * @param int    $DBID  Id der Datenbankverbindung
</span></span><span class="l" id="1401">1401 <span class="php-comment">     *
</span></span><span class="l" id="1402">1402 <span class="php-comment">     * @return array Ein mehrdimensionales Array das die Metadaten enthaelt
</span></span><span class="l" id="1403">1403 <span class="php-comment">     */</span>
</span><span class="l" id="1404">1404     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> showColumns(<span class="php-var">$table</span>, <span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1405">1405     {
</span><span class="l" id="1406">1406         <span class="php-var">$sql</span> = self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1407">1407         <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SHOW COLUMNS FROM '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>));
</span><span class="l" id="1408">1408 
</span><span class="l" id="1409">1409         <span class="php-var">$columns</span> = [];
</span><span class="l" id="1410">1410         <span class="php-keyword1">foreach</span> (<span class="php-var">$sql</span> <span class="php-keyword1">as</span> <span class="php-var">$col</span>) {
</span><span class="l" id="1411">1411             <span class="php-var">$columns</span>[] = [
</span><span class="l" id="1412">1412                 <span class="php-quote">'name'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Field'</span>),
</span><span class="l" id="1413">1413                 <span class="php-quote">'type'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Type'</span>),
</span><span class="l" id="1414">1414                 <span class="php-quote">'null'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Null'</span>),
</span><span class="l" id="1415">1415                 <span class="php-quote">'key'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Key'</span>),
</span><span class="l" id="1416">1416                 <span class="php-quote">'default'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Default'</span>),
</span><span class="l" id="1417">1417                 <span class="php-quote">'extra'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Extra'</span>),
</span><span class="l" id="1418">1418             ];
</span><span class="l" id="1419">1419         }
</span><span class="l" id="1420">1420 
</span><span class="l" id="1421">1421         <span class="php-keyword1">return</span> <span class="php-var">$columns</span>;
</span><span class="l" id="1422">1422     }
</span><span class="l" id="1423">1423 
</span><span class="l" id="1424">1424     <span class="php-comment">/**
</span></span><span class="l" id="1425">1425 <span class="php-comment">     * Gibt die Serverversion zurueck.
</span></span><span class="l" id="1426">1426 <span class="php-comment">     *
</span></span><span class="l" id="1427">1427 <span class="php-comment">     * Die Versionsinformation ist erst bekannt,
</span></span><span class="l" id="1428">1428 <span class="php-comment">     * nachdem der rex_sql Konstruktor einmalig erfolgreich durchlaufen wurde.
</span></span><span class="l" id="1429">1429 <span class="php-comment">     */</span>
</span><span class="l" id="1430">1430     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getServerVersion(<span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1431">1431     {
</span><span class="l" id="1432">1432         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>])) {
</span><span class="l" id="1433">1433             <span class="php-comment">// create connection if necessary</span>
</span><span class="l" id="1434">1434             self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1435">1435         }
</span><span class="l" id="1436">1436         <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>]-&gt;getAttribute(PDO::ATTR_SERVER_VERSION);
</span><span class="l" id="1437">1437     }
</span><span class="l" id="1438">1438 
</span><span class="l" id="1439">1439     <span class="php-comment">/**
</span></span><span class="l" id="1440">1440 <span class="php-comment">     * Creates a rex_sql instance.
</span></span><span class="l" id="1441">1441 <span class="php-comment">     *
</span></span><span class="l" id="1442">1442 <span class="php-comment">     * @param int $DBID
</span></span><span class="l" id="1443">1443 <span class="php-comment">     *
</span></span><span class="l" id="1444">1444 <span class="php-comment">     * @return static Returns a rex_sql instance
</span></span><span class="l" id="1445">1445 <span class="php-comment">     */</span>
</span><span class="l" id="1446">1446     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> factory(<span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1447">1447     {
</span><span class="l" id="1448">1448         <span class="php-var">$class</span> = <span class="php-keyword1">static</span>::getFactoryClass();
</span><span class="l" id="1449">1449         <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> <span class="php-var">$class</span>(<span class="php-var">$DBID</span>);
</span><span class="l" id="1450">1450     }
</span><span class="l" id="1451">1451 
</span><span class="l" id="1452">1452     <span class="php-comment">/**
</span></span><span class="l" id="1453">1453 <span class="php-comment">     * Prueft die uebergebenen Zugangsdaten auf gueltigkeit und legt ggf. die
</span></span><span class="l" id="1454">1454 <span class="php-comment">     * Datenbank an.
</span></span><span class="l" id="1455">1455 <span class="php-comment">     */</span>
</span><span class="l" id="1456">1456     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> checkDbConnection(<span class="php-var">$host</span>, <span class="php-var">$login</span>, <span class="php-var">$pw</span>, <span class="php-var">$dbname</span>, <span class="php-var">$createDb</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="1457">1457     {
</span><span class="l" id="1458">1458         <span class="php-keyword1">if</span> (!<span class="php-var">$dbname</span>) {
</span><span class="l" id="1459">1459             <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'sql_database_name_missing'</span>);
</span><span class="l" id="1460">1460         }
</span><span class="l" id="1461">1461 
</span><span class="l" id="1462">1462         <span class="php-var">$err_msg</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="1463">1463 
</span><span class="l" id="1464">1464         <span class="php-keyword1">try</span> {
</span><span class="l" id="1465">1465             self::createConnection(
</span><span class="l" id="1466">1466                 <span class="php-var">$host</span>,
</span><span class="l" id="1467">1467                 <span class="php-var">$dbname</span>,
</span><span class="l" id="1468">1468                 <span class="php-var">$login</span>,
</span><span class="l" id="1469">1469                 <span class="php-var">$pw</span>
</span><span class="l" id="1470">1470             );
</span><span class="l" id="1471">1471 
</span><span class="l" id="1472">1472             <span class="php-comment">// db connection was successfully established, but we were meant to create the db</span>
</span><span class="l" id="1473">1473             <span class="php-keyword1">if</span> (<span class="php-var">$createDb</span>) {
</span><span class="l" id="1474">1474                 <span class="php-comment">// -&gt; throw db already exists error</span>
</span><span class="l" id="1475">1475                 <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_database_already_exists'</span>);
</span><span class="l" id="1476">1476             }
</span><span class="l" id="1477">1477         } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="1478">1478             <span class="php-comment">// see mysql error codes at http://dev.mysql.com/doc/refman/5.1/de/error-messages-server.html</span>
</span><span class="l" id="1479">1479 
</span><span class="l" id="1480">1480             <span class="php-comment">// ER_BAD_HOST</span>
</span><span class="l" id="1481">1481             <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [2002]'</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="1482">1482                 <span class="php-comment">// unable to connect to db server</span>
</span><span class="l" id="1483">1483                 <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_connect_database'</span>);
</span><span class="l" id="1484">1484             }
</span><span class="l" id="1485">1485             <span class="php-comment">// ER_BAD_DB_ERROR</span>
</span><span class="l" id="1486">1486             <span class="php-keyword1">elseif</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [1049]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1487">1487                     <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[42000]'</span>) !== <span class="php-keyword1">false</span>
</span><span class="l" id="1488">1488             ) {
</span><span class="l" id="1489">1489                 <span class="php-keyword1">if</span> (<span class="php-var">$createDb</span>) {
</span><span class="l" id="1490">1490                     <span class="php-keyword1">try</span> {
</span><span class="l" id="1491">1491                         <span class="php-comment">// use the "mysql" db for the connection</span>
</span><span class="l" id="1492">1492                         <span class="php-var">$conn</span> = self::createConnection(
</span><span class="l" id="1493">1493                             <span class="php-var">$host</span>,
</span><span class="l" id="1494">1494                             <span class="php-quote">'mysql'</span>,
</span><span class="l" id="1495">1495                             <span class="php-var">$login</span>,
</span><span class="l" id="1496">1496                             <span class="php-var">$pw</span>
</span><span class="l" id="1497">1497                         );
</span><span class="l" id="1498">1498                         <span class="php-keyword1">if</span> (<span class="php-var">$conn</span>-&gt;<span class="php-keyword2">exec</span>(<span class="php-quote">'CREATE DATABASE '</span> . <span class="php-var">$dbname</span> . <span class="php-quote">' CHARACTER SET utf8 COLLATE utf8_general_ci'</span>) !== <span class="php-num">1</span>) {
</span><span class="l" id="1499">1499                             <span class="php-comment">// unable to create db</span>
</span><span class="l" id="1500">1500                             <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_create_database'</span>);
</span><span class="l" id="1501">1501                         }
</span><span class="l" id="1502">1502                     } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="1503">1503                         <span class="php-comment">// unable to find database</span>
</span><span class="l" id="1504">1504                         <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_open_database'</span>);
</span><span class="l" id="1505">1505                     }
</span><span class="l" id="1506">1506                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="1507">1507                     <span class="php-comment">// unable to find database</span>
</span><span class="l" id="1508">1508                     <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_find_database'</span>);
</span><span class="l" id="1509">1509                 }
</span><span class="l" id="1510">1510             }
</span><span class="l" id="1511">1511             <span class="php-comment">// ER_ACCESS_DENIED_ERROR</span>
</span><span class="l" id="1512">1512             <span class="php-comment">// ER_DBACCESS_DENIED_ERROR</span>
</span><span class="l" id="1513">1513             <span class="php-keyword1">elseif</span> (
</span><span class="l" id="1514">1514                 <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [1045]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1515">1515                 <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[28000]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1516">1516                 <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [1044]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1517">1517                 <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[42000]'</span>) !== <span class="php-keyword1">false</span>
</span><span class="l" id="1518">1518             ) {
</span><span class="l" id="1519">1519                 <span class="php-comment">// unable to connect to db</span>
</span><span class="l" id="1520">1520                 <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_connect_database'</span>);
</span><span class="l" id="1521">1521             }
</span><span class="l" id="1522">1522             <span class="php-comment">// ER_ACCESS_TO_SERVER_ERROR</span>
</span><span class="l" id="1523">1523             <span class="php-keyword1">elseif</span> (
</span><span class="l" id="1524">1524                 <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [2005]'</span>) !== <span class="php-keyword1">false</span>
</span><span class="l" id="1525">1525             ) {
</span><span class="l" id="1526">1526                 <span class="php-comment">// unable to connect to server</span>
</span><span class="l" id="1527">1527                 <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_connect_server'</span>);
</span><span class="l" id="1528">1528             } <span class="php-keyword1">else</span> {
</span><span class="l" id="1529">1529                 <span class="php-comment">// we didn't expected this error, so rethrow it to show it to the admin/end-user</span>
</span><span class="l" id="1530">1530                 <span class="php-keyword1">throw</span> <span class="php-var">$e</span>;
</span><span class="l" id="1531">1531             }
</span><span class="l" id="1532">1532         }
</span><span class="l" id="1533">1533 
</span><span class="l" id="1534">1534         <span class="php-comment">// close the connection</span>
</span><span class="l" id="1535">1535         <span class="php-var">$conn</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="1536">1536 
</span><span class="l" id="1537">1537         <span class="php-keyword1">return</span>  <span class="php-var">$err_msg</span>;
</span><span class="l" id="1538">1538     }
</span><span class="l" id="1539">1539 
</span><span class="l" id="1540">1540     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> setMultiRecordQuery(<span class="php-var">$verb</span>, <span class="php-var">$onDuplicateKeyUpdate</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="1541">1541     {
</span><span class="l" id="1542">1542         <span class="php-var">$fields</span> = [];
</span><span class="l" id="1543">1543 
</span><span class="l" id="1544">1544         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;records <span class="php-keyword1">as</span> <span class="php-var">$record</span>) {
</span><span class="l" id="1545">1545             <span class="php-keyword1">foreach</span> (<span class="php-var">$record</span>-&gt;values <span class="php-keyword1">as</span> <span class="php-var">$field</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="1546">1546                 <span class="php-var">$fields</span>[<span class="php-var">$field</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="1547">1547             }
</span><span class="l" id="1548">1548             <span class="php-keyword1">foreach</span> (<span class="php-var">$record</span>-&gt;rawValues <span class="php-keyword1">as</span> <span class="php-var">$field</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="1549">1549                 <span class="php-var">$fields</span>[<span class="php-var">$field</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="1550">1550             }
</span><span class="l" id="1551">1551         }
</span><span class="l" id="1552">1552 
</span><span class="l" id="1553">1553         <span class="php-var">$fields</span> = <span class="php-keyword2">array_keys</span>(<span class="php-var">$fields</span>);
</span><span class="l" id="1554">1554 
</span><span class="l" id="1555">1555         <span class="php-var">$rows</span> = [];
</span><span class="l" id="1556">1556         <span class="php-var">$params</span> = [];
</span><span class="l" id="1557">1557 
</span><span class="l" id="1558">1558         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;records <span class="php-keyword1">as</span> <span class="php-var">$record</span>) {
</span><span class="l" id="1559">1559             <span class="php-var">$row</span> = [];
</span><span class="l" id="1560">1560 
</span><span class="l" id="1561">1561             <span class="php-keyword1">foreach</span> (<span class="php-var">$fields</span> <span class="php-keyword1">as</span> <span class="php-var">$field</span>) {
</span><span class="l" id="1562">1562                 <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$record</span>-&gt;rawValues[<span class="php-var">$field</span>])) {
</span><span class="l" id="1563">1563                     <span class="php-var">$row</span>[] = <span class="php-var">$record</span>-&gt;rawValues[<span class="php-var">$field</span>];
</span><span class="l" id="1564">1564 
</span><span class="l" id="1565">1565                     <span class="php-keyword1">continue</span>;
</span><span class="l" id="1566">1566                 }
</span><span class="l" id="1567">1567 
</span><span class="l" id="1568">1568                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$record</span>-&gt;values[<span class="php-var">$field</span>]) &amp;&amp; !<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$field</span>, <span class="php-var">$this</span>-&gt;values)) {
</span><span class="l" id="1569">1569                     <span class="php-var">$row</span>[] = <span class="php-quote">'DEFAULT'</span>;
</span><span class="l" id="1570">1570 
</span><span class="l" id="1571">1571                     <span class="php-keyword1">continue</span>;
</span><span class="l" id="1572">1572                 }
</span><span class="l" id="1573">1573 
</span><span class="l" id="1574">1574                 <span class="php-var">$row</span>[] = <span class="php-quote">'?'</span>;
</span><span class="l" id="1575">1575                 <span class="php-var">$params</span>[] = <span class="php-var">$record</span>-&gt;values[<span class="php-var">$field</span>];
</span><span class="l" id="1576">1576             }
</span><span class="l" id="1577">1577 
</span><span class="l" id="1578">1578             <span class="php-var">$rows</span>[] = <span class="php-quote">'('</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">', '</span>, <span class="php-var">$row</span>).<span class="php-quote">')'</span>;
</span><span class="l" id="1579">1579         }
</span><span class="l" id="1580">1580 
</span><span class="l" id="1581">1581         <span class="php-var">$query</span> = <span class="php-var">$verb</span>.<span class="php-quote">' INTO '</span>.<span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table).<span class="php-quote">"\n"</span>;
</span><span class="l" id="1582">1582         <span class="php-var">$query</span> .= <span class="php-quote">'('</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">', '</span>, <span class="php-keyword2">array_map</span>([<span class="php-var">$this</span>, <span class="php-quote">'escapeIdentifier'</span>], <span class="php-var">$fields</span>)).<span class="php-quote">")\n"</span>;
</span><span class="l" id="1583">1583         <span class="php-var">$query</span> .= <span class="php-quote">"VALUES\n"</span>;
</span><span class="l" id="1584">1584         <span class="php-var">$query</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">",\n"</span>, <span class="php-var">$rows</span>);
</span><span class="l" id="1585">1585 
</span><span class="l" id="1586">1586         <span class="php-keyword1">if</span> (<span class="php-var">$onDuplicateKeyUpdate</span>) {
</span><span class="l" id="1587">1587             <span class="php-var">$query</span> .= <span class="php-quote">"\n"</span>.<span class="php-var">$this</span>-&gt;buildOnDuplicateKeyUpdate(<span class="php-var">$fields</span>);
</span><span class="l" id="1588">1588         }
</span><span class="l" id="1589">1589 
</span><span class="l" id="1590">1590         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setQuery(<span class="php-var">$query</span>, <span class="php-var">$params</span>);
</span><span class="l" id="1591">1591     }
</span><span class="l" id="1592">1592 
</span><span class="l" id="1593">1593     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> buildOnDuplicateKeyUpdate(<span class="php-var">$fields</span>)
</span><span class="l" id="1594">1594     {
</span><span class="l" id="1595">1595         <span class="php-var">$updates</span> = [];
</span><span class="l" id="1596">1596 
</span><span class="l" id="1597">1597         <span class="php-keyword1">foreach</span> (<span class="php-var">$fields</span> <span class="php-keyword1">as</span> <span class="php-var">$field</span>) {
</span><span class="l" id="1598">1598             <span class="php-var">$field</span> = <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$field</span>);
</span><span class="l" id="1599">1599             <span class="php-var">$updates</span>[] = <span class="php-quote">"</span><span class="php-var">$field</span><span class="php-quote"> = VALUES(</span><span class="php-var">$field</span><span class="php-quote">)"</span>;
</span><span class="l" id="1600">1600         }
</span><span class="l" id="1601">1601 
</span><span class="l" id="1602">1602         <span class="php-keyword1">return</span> <span class="php-quote">'ON DUPLICATE KEY UPDATE '</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">', '</span>, <span class="php-var">$updates</span>);
</span><span class="l" id="1603">1603     }
</span><span class="l" id="1604">1604 }
</span><span class="l" id="1605">1605 </span></code></pre>
 </body>
</html>
