<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1"><a class="l" href="#1">   1 </a><span class="xlang">&lt;?php</span>
</span><span class="l" id="2"><a class="l" href="#2">   2 </a>
</span><span class="l" id="3"><a class="l" href="#3">   3 </a><span class="php-comment">/**
</span></span><span class="l" id="4"><a class="l" href="#4">   4 </a><span class="php-comment"> * Klasse zur Verbindung und Interatkion mit der Datenbank.
</span></span><span class="l" id="5"><a class="l" href="#5">   5 </a><span class="php-comment"> *
</span></span><span class="l" id="6"><a class="l" href="#6">   6 </a><span class="php-comment"> * see http://net.tutsplus.com/tutorials/php/why-you-should-be-using-phps-pdo-for-database-access/
</span></span><span class="l" id="7"><a class="l" href="#7">   7 </a><span class="php-comment"> *
</span></span><span class="l" id="8"><a class="l" href="#8">   8 </a><span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="9"><a class="l" href="#9">   9 </a><span class="php-comment"> */</span>
</span><span class="l" id="10"><a class="l" href="#10">  10 </a><span class="php-keyword1">class</span> <a href="#rex_sql" id="rex_sql">rex_sql</a> <span class="php-keyword1">implements</span> Iterator
</span><span class="l" id="11"><a class="l" href="#11">  11 </a>{
</span><span class="l" id="12"><a class="l" href="#12">  12 </a>    <span class="php-keyword1">use</span> rex_factory_trait;
</span><span class="l" id="13"><a class="l" href="#13">  13 </a>
</span><span class="l" id="14"><a class="l" href="#14">  14 </a>    <span class="php-comment">/**
</span></span><span class="l" id="15"><a class="l" href="#15">  15 </a><span class="php-comment">     * Default SQL datetime format.
</span></span><span class="l" id="16"><a class="l" href="#16">  16 </a><span class="php-comment">     */</span>
</span><span class="l" id="17"><a class="l" href="#17">  17 </a>    <span class="php-keyword1">const</span> <a href="#FORMAT_DATETIME" id="FORMAT_DATETIME">FORMAT_DATETIME</a> = <span class="php-quote">'Y-m-d H:i:s'</span>;
</span><span class="l" id="18"><a class="l" href="#18">  18 </a>
</span><span class="l" id="19"><a class="l" href="#19">  19 </a>    <span class="php-comment">/**
</span></span><span class="l" id="20"><a class="l" href="#20">  20 </a><span class="php-comment">     * Controls query buffering.
</span></span><span class="l" id="21"><a class="l" href="#21">  21 </a><span class="php-comment">     *
</span></span><span class="l" id="22"><a class="l" href="#22">  22 </a><span class="php-comment">     * View `PDO::MYSQL_ATTR_USE_BUFFERED_QUERY` for more details.
</span></span><span class="l" id="23"><a class="l" href="#23">  23 </a><span class="php-comment">     */</span>
</span><span class="l" id="24"><a class="l" href="#24">  24 </a>    <span class="php-keyword1">const</span> <a href="#OPT_BUFFERED" id="OPT_BUFFERED">OPT_BUFFERED</a> = <span class="php-quote">'buffered'</span>;
</span><span class="l" id="25"><a class="l" href="#25">  25 </a>
</span><span class="l" id="26"><a class="l" href="#26">  26 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$debug" id="$debug">$debug</a></span>; <span class="php-comment">// debug schalter</span>
</span><span class="l" id="27"><a class="l" href="#27">  27 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$values" id="$values">$values</a></span>; <span class="php-comment">// Werte von setValue</span>
</span><span class="l" id="28"><a class="l" href="#28">  28 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$rawValues" id="$rawValues">$rawValues</a></span>; <span class="php-comment">// Werte von setRawValue</span>
</span><span class="l" id="29"><a class="l" href="#29">  29 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$fieldnames" id="$fieldnames">$fieldnames</a></span>; <span class="php-comment">// Spalten im ResultSet</span>
</span><span class="l" id="30"><a class="l" href="#30">  30 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$rawFieldnames" id="$rawFieldnames">$rawFieldnames</a></span>;
</span><span class="l" id="31"><a class="l" href="#31">  31 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$tablenames" id="$tablenames">$tablenames</a></span>; <span class="php-comment">// Tabelle im ResultSet</span>
</span><span class="l" id="32"><a class="l" href="#32">  32 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$lastRow" id="$lastRow">$lastRow</a></span>; <span class="php-comment">// Wert der zuletzt gefetchten zeile</span>
</span><span class="l" id="33"><a class="l" href="#33">  33 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$table" id="$table">$table</a></span>; <span class="php-comment">// Tabelle setzen</span>
</span><span class="l" id="34"><a class="l" href="#34">  34 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$wherevar" id="$wherevar">$wherevar</a></span>; <span class="php-comment">// WHERE Bediengung</span>
</span><span class="l" id="35"><a class="l" href="#35">  35 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$whereParams" id="$whereParams">$whereParams</a></span>; <span class="php-comment">// WHERE parameter array</span>
</span><span class="l" id="36"><a class="l" href="#36">  36 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$rows" id="$rows">$rows</a></span>; <span class="php-comment">// anzahl der treffer</span>
</span><span class="l" id="37"><a class="l" href="#37">  37 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$counter" id="$counter">$counter</a></span>; <span class="php-comment">// pointer</span>
</span><span class="l" id="38"><a class="l" href="#38">  38 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$query" id="$query">$query</a></span>; <span class="php-comment">// Die Abfrage</span>
</span><span class="l" id="39"><a class="l" href="#39">  39 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$params" id="$params">$params</a></span>; <span class="php-comment">// Die Abfrage-Parameter</span>
</span><span class="l" id="40"><a class="l" href="#40">  40 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$DBID" id="$DBID">$DBID</a></span>; <span class="php-comment">// ID der Verbindung</span>
</span><span class="l" id="41"><a class="l" href="#41">  41 </a>
</span><span class="l" id="42"><a class="l" href="#42">  42 </a>    <span class="php-comment">/**
</span></span><span class="l" id="43"><a class="l" href="#43">  43 </a><span class="php-comment">     * @var PDOStatement
</span></span><span class="l" id="44"><a class="l" href="#44">  44 </a><span class="php-comment">     */</span>
</span><span class="l" id="45"><a class="l" href="#45">  45 </a>    <span class="php-keyword1">protected</span> <span class="php-var"><a href="#$stmt" id="$stmt">$stmt</a></span>;
</span><span class="l" id="46"><a class="l" href="#46">  46 </a>
</span><span class="l" id="47"><a class="l" href="#47">  47 </a>    <span class="php-comment">/**
</span></span><span class="l" id="48"><a class="l" href="#48">  48 </a><span class="php-comment">     * @var PDO[]
</span></span><span class="l" id="49"><a class="l" href="#49">  49 </a><span class="php-comment">     */</span>
</span><span class="l" id="50"><a class="l" href="#50">  50 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var"><a href="#$pdo" id="$pdo">$pdo</a></span> = [];
</span><span class="l" id="51"><a class="l" href="#51">  51 </a>
</span><span class="l" id="52"><a class="l" href="#52">  52 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> <a href="#___construct" id="___construct">__construct</a>(<span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="53"><a class="l" href="#53">  53 </a>    {
</span><span class="l" id="54"><a class="l" href="#54">  54 </a>        <span class="php-var">$this</span>-&gt;debug = <span class="php-keyword1">false</span>;
</span><span class="l" id="55"><a class="l" href="#55">  55 </a>        <span class="php-var">$this</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span class="l" id="56"><a class="l" href="#56">  56 </a>        <span class="php-var">$this</span>-&gt;selectDB(<span class="php-var">$DBID</span>);
</span><span class="l" id="57"><a class="l" href="#57">  57 </a>    }
</span><span class="l" id="58"><a class="l" href="#58">  58 </a>
</span><span class="l" id="59"><a class="l" href="#59">  59 </a>    <span class="php-comment">/**
</span></span><span class="l" id="60"><a class="l" href="#60">  60 </a><span class="php-comment">     * Stellt die Verbindung zur Datenbank her.
</span></span><span class="l" id="61"><a class="l" href="#61">  61 </a><span class="php-comment">     */</span>
</span><span class="l" id="62"><a class="l" href="#62">  62 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> <a href="#_selectDB" id="_selectDB">selectDB</a>(<span class="php-var">$DBID</span>)
</span><span class="l" id="63"><a class="l" href="#63">  63 </a>    {
</span><span class="l" id="64"><a class="l" href="#64">  64 </a>        <span class="php-var">$this</span>-&gt;DBID = <span class="php-var">$DBID</span>;
</span><span class="l" id="65"><a class="l" href="#65">  65 </a>
</span><span class="l" id="66"><a class="l" href="#66">  66 </a>        <span class="php-keyword1">try</span> {
</span><span class="l" id="67"><a class="l" href="#67">  67 </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>])) {
</span><span class="l" id="68"><a class="l" href="#68">  68 </a>                <span class="php-var">$dbconfig</span> = rex::getProperty(<span class="php-quote">'db'</span>);
</span><span class="l" id="69"><a class="l" href="#69">  69 </a>                <span class="php-var">$conn</span> = self::createConnection(
</span><span class="l" id="70"><a class="l" href="#70">  70 </a>                    <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'host'</span>],
</span><span class="l" id="71"><a class="l" href="#71">  71 </a>                    <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'name'</span>],
</span><span class="l" id="72"><a class="l" href="#72">  72 </a>                    <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'login'</span>],
</span><span class="l" id="73"><a class="l" href="#73">  73 </a>                    <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'password'</span>],
</span><span class="l" id="74"><a class="l" href="#74">  74 </a>                    <span class="php-var">$dbconfig</span>[<span class="php-var">$DBID</span>][<span class="php-quote">'persistent'</span>]
</span><span class="l" id="75"><a class="l" href="#75">  75 </a>                );
</span><span class="l" id="76"><a class="l" href="#76">  76 </a>                self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>] = <span class="php-var">$conn</span>;
</span><span class="l" id="77"><a class="l" href="#77">  77 </a>
</span><span class="l" id="78"><a class="l" href="#78">  78 </a>                <span class="php-comment">// ggf. Strict Mode abschalten</span>
</span><span class="l" id="79"><a class="l" href="#79">  79 </a>                <span class="php-var">$this</span>-&gt;setQuery(<span class="php-quote">'SET SESSION SQL_MODE="", NAMES utf8'</span>);
</span><span class="l" id="80"><a class="l" href="#80">  80 </a>            }
</span><span class="l" id="81"><a class="l" href="#81">  81 </a>        } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="82"><a class="l" href="#82">  82 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Could not connect to database'</span>, <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="83"><a class="l" href="#83">  83 </a>        }
</span><span class="l" id="84"><a class="l" href="#84">  84 </a>    }
</span><span class="l" id="85"><a class="l" href="#85">  85 </a>
</span><span class="l" id="86"><a class="l" href="#86">  86 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_createConnection" id="_createConnection">createConnection</a>(<span class="php-var">$host</span>, <span class="php-var">$database</span>, <span class="php-var">$login</span>, <span class="php-var">$password</span>, <span class="php-var">$persistent</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="87"><a class="l" href="#87">  87 </a>    {
</span><span class="l" id="88"><a class="l" href="#88">  88 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$database</span>) {
</span><span class="l" id="89"><a class="l" href="#89">  89 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Database name can not be empty.'</span>);
</span><span class="l" id="90"><a class="l" href="#90">  90 </a>        }
</span><span class="l" id="91"><a class="l" href="#91">  91 </a>
</span><span class="l" id="92"><a class="l" href="#92">  92 </a>        <span class="php-var">$dsn</span> = <span class="php-quote">'mysql:host='</span> . <span class="php-var">$host</span> . <span class="php-quote">';dbname='</span> . <span class="php-var">$database</span>;
</span><span class="l" id="93"><a class="l" href="#93">  93 </a>        <span class="php-var">$options</span> = [
</span><span class="l" id="94"><a class="l" href="#94">  94 </a>            PDO::ATTR_PERSISTENT =&gt; (bool) <span class="php-var">$persistent</span>,
</span><span class="l" id="95"><a class="l" href="#95">  95 </a>            PDO::ATTR_FETCH_TABLE_NAMES =&gt; <span class="php-keyword1">true</span>,
</span><span class="l" id="96"><a class="l" href="#96">  96 </a>            <span class="php-comment">// PDO::ATTR_CURSOR =&gt; PDO::CURSOR_SCROLL,</span>
</span><span class="l" id="97"><a class="l" href="#97">  97 </a>            <span class="php-comment">// PDO::ATTR_EMULATE_PREPARES =&gt; true,</span>
</span><span class="l" id="98"><a class="l" href="#98">  98 </a>        ];
</span><span class="l" id="99"><a class="l" href="#99">  99 </a>
</span><span class="l" id="100"><a class="l" href="#100"> 100 </a>        <span class="php-var">$dbh</span> = @<span class="php-keyword1">new</span> PDO(<span class="php-var">$dsn</span>, <span class="php-var">$login</span>, <span class="php-var">$password</span>, <span class="php-var">$options</span>);
</span><span class="l" id="101"><a class="l" href="#101"> 101 </a>        <span class="php-var">$dbh</span>-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
</span><span class="l" id="102"><a class="l" href="#102"> 102 </a>        <span class="php-keyword1">return</span> <span class="php-var">$dbh</span>;
</span><span class="l" id="103"><a class="l" href="#103"> 103 </a>    }
</span><span class="l" id="104"><a class="l" href="#104"> 104 </a>
</span><span class="l" id="105"><a class="l" href="#105"> 105 </a>    <span class="php-comment">/**
</span></span><span class="l" id="106"><a class="l" href="#106"> 106 </a><span class="php-comment">     * Gibt die DatenbankId der Abfrage (SQL) zurueck,
</span></span><span class="l" id="107"><a class="l" href="#107"> 107 </a><span class="php-comment">     * oder false wenn die Abfrage keine DBID enthaelt.
</span></span><span class="l" id="108"><a class="l" href="#108"> 108 </a><span class="php-comment">     *
</span></span><span class="l" id="109"><a class="l" href="#109"> 109 </a><span class="php-comment">     * @param string $qry
</span></span><span class="l" id="110"><a class="l" href="#110"> 110 </a><span class="php-comment">     *
</span></span><span class="l" id="111"><a class="l" href="#111"> 111 </a><span class="php-comment">     * @return bool
</span></span><span class="l" id="112"><a class="l" href="#112"> 112 </a><span class="php-comment">     */</span>
</span><span class="l" id="113"><a class="l" href="#113"> 113 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_getQueryDBID" id="_getQueryDBID">getQueryDBID</a>(<span class="php-var">$qry</span>)
</span><span class="l" id="114"><a class="l" href="#114"> 114 </a>    {
</span><span class="l" id="115"><a class="l" href="#115"> 115 </a>        <span class="php-var">$qry</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>);
</span><span class="l" id="116"><a class="l" href="#116"> 116 </a>
</span><span class="l" id="117"><a class="l" href="#117"> 117 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/\(DB([1-9]){1}\)/i'</span>, <span class="php-var">$qry</span>, <span class="php-var">$matches</span>)) {
</span><span class="l" id="118"><a class="l" href="#118"> 118 </a>            <span class="php-keyword1">return</span> <span class="php-var">$matches</span>[<span class="php-num">1</span>];
</span><span class="l" id="119"><a class="l" href="#119"> 119 </a>        }
</span><span class="l" id="120"><a class="l" href="#120"> 120 </a>
</span><span class="l" id="121"><a class="l" href="#121"> 121 </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="122"><a class="l" href="#122"> 122 </a>    }
</span><span class="l" id="123"><a class="l" href="#123"> 123 </a>
</span><span class="l" id="124"><a class="l" href="#124"> 124 </a>    <span class="php-comment">/**
</span></span><span class="l" id="125"><a class="l" href="#125"> 125 </a><span class="php-comment">     * Entfernt die DBID aus einer Abfrage (SQL) und gibt die DBID zurueck falls
</span></span><span class="l" id="126"><a class="l" href="#126"> 126 </a><span class="php-comment">     * vorhanden, sonst false.
</span></span><span class="l" id="127"><a class="l" href="#127"> 127 </a><span class="php-comment">     *
</span></span><span class="l" id="128"><a class="l" href="#128"> 128 </a><span class="php-comment">     * @param string $qry Abfrage
</span></span><span class="l" id="129"><a class="l" href="#129"> 129 </a><span class="php-comment">     *
</span></span><span class="l" id="130"><a class="l" href="#130"> 130 </a><span class="php-comment">     * @return string
</span></span><span class="l" id="131"><a class="l" href="#131"> 131 </a><span class="php-comment">     */</span>
</span><span class="l" id="132"><a class="l" href="#132"> 132 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_stripQueryDBID" id="_stripQueryDBID">stripQueryDBID</a>(&amp;<span class="php-var">$qry</span>)
</span><span class="l" id="133"><a class="l" href="#133"> 133 </a>    {
</span><span class="l" id="134"><a class="l" href="#134"> 134 </a>        <span class="php-var">$qry</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>);
</span><span class="l" id="135"><a class="l" href="#135"> 135 </a>
</span><span class="l" id="136"><a class="l" href="#136"> 136 </a>        <span class="php-keyword1">if</span> ((<span class="php-var">$qryDBID</span> = self::getQueryDBID(<span class="php-var">$qry</span>)) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="137"><a class="l" href="#137"> 137 </a>            <span class="php-var">$qry</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$qry</span>, <span class="php-num">6</span>);
</span><span class="l" id="138"><a class="l" href="#138"> 138 </a>        }
</span><span class="l" id="139"><a class="l" href="#139"> 139 </a>
</span><span class="l" id="140"><a class="l" href="#140"> 140 </a>        <span class="php-keyword1">return</span> <span class="php-var">$qryDBID</span>;
</span><span class="l" id="141"><a class="l" href="#141"> 141 </a>    }
</span><span class="l" id="142"><a class="l" href="#142"> 142 </a>
</span><span class="l" id="143"><a class="l" href="#143"> 143 </a>    <span class="php-comment">/**
</span></span><span class="l" id="144"><a class="l" href="#144"> 144 </a><span class="php-comment">     * Gibt den Typ der Abfrage (SQL) zurueck,
</span></span><span class="l" id="145"><a class="l" href="#145"> 145 </a><span class="php-comment">     * oder false wenn die Abfrage keinen Typ enthaelt.
</span></span><span class="l" id="146"><a class="l" href="#146"> 146 </a><span class="php-comment">     *
</span></span><span class="l" id="147"><a class="l" href="#147"> 147 </a><span class="php-comment">     * Moegliche Typen:
</span></span><span class="l" id="148"><a class="l" href="#148"> 148 </a><span class="php-comment">     * - SELECT
</span></span><span class="l" id="149"><a class="l" href="#149"> 149 </a><span class="php-comment">     * - SHOW
</span></span><span class="l" id="150"><a class="l" href="#150"> 150 </a><span class="php-comment">     * - UPDATE
</span></span><span class="l" id="151"><a class="l" href="#151"> 151 </a><span class="php-comment">     * - INSERT
</span></span><span class="l" id="152"><a class="l" href="#152"> 152 </a><span class="php-comment">     * - DELETE
</span></span><span class="l" id="153"><a class="l" href="#153"> 153 </a><span class="php-comment">     * - REPLACE
</span></span><span class="l" id="154"><a class="l" href="#154"> 154 </a><span class="php-comment">     * - CREATE
</span></span><span class="l" id="155"><a class="l" href="#155"> 155 </a><span class="php-comment">     * - CALL
</span></span><span class="l" id="156"><a class="l" href="#156"> 156 </a><span class="php-comment">     * - OPTIMIZE
</span></span><span class="l" id="157"><a class="l" href="#157"> 157 </a><span class="php-comment">     *
</span></span><span class="l" id="158"><a class="l" href="#158"> 158 </a><span class="php-comment">     * @param string $qry
</span></span><span class="l" id="159"><a class="l" href="#159"> 159 </a><span class="php-comment">     *
</span></span><span class="l" id="160"><a class="l" href="#160"> 160 </a><span class="php-comment">     * @return bool|string
</span></span><span class="l" id="161"><a class="l" href="#161"> 161 </a><span class="php-comment">     */</span>
</span><span class="l" id="162"><a class="l" href="#162"> 162 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_getQueryType" id="_getQueryType">getQueryType</a>(<span class="php-var">$qry</span>)
</span><span class="l" id="163"><a class="l" href="#163"> 163 </a>    {
</span><span class="l" id="164"><a class="l" href="#164"> 164 </a>        <span class="php-var">$qry</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>);
</span><span class="l" id="165"><a class="l" href="#165"> 165 </a>        <span class="php-comment">// DBID aus dem Query herausschneiden, falls vorhanden</span>
</span><span class="l" id="166"><a class="l" href="#166"> 166 </a>        self::stripQueryDBID(<span class="php-var">$qry</span>);
</span><span class="l" id="167"><a class="l" href="#167"> 167 </a>
</span><span class="l" id="168"><a class="l" href="#168"> 168 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^(SELECT|SHOW|UPDATE|INSERT|DELETE|REPLACE|CREATE|CALL|OPTIMIZE)/i'</span>, <span class="php-var">$qry</span>, <span class="php-var">$matches</span>)) {
</span><span class="l" id="169"><a class="l" href="#169"> 169 </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">strtoupper</span>(<span class="php-var">$matches</span>[<span class="php-num">1</span>]);
</span><span class="l" id="170"><a class="l" href="#170"> 170 </a>        }
</span><span class="l" id="171"><a class="l" href="#171"> 171 </a>
</span><span class="l" id="172"><a class="l" href="#172"> 172 </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="173"><a class="l" href="#173"> 173 </a>    }
</span><span class="l" id="174"><a class="l" href="#174"> 174 </a>
</span><span class="l" id="175"><a class="l" href="#175"> 175 </a>    <span class="php-comment">/**
</span></span><span class="l" id="176"><a class="l" href="#176"> 176 </a><span class="php-comment">     * Returns a datetime string in sql datetime format (Y-m-d H:i:s) using the given timestamp or the current time
</span></span><span class="l" id="177"><a class="l" href="#177"> 177 </a><span class="php-comment">     * if no timestamp (or `null`) is given.
</span></span><span class="l" id="178"><a class="l" href="#178"> 178 </a><span class="php-comment">     *
</span></span><span class="l" id="179"><a class="l" href="#179"> 179 </a><span class="php-comment">     * @param int|null $timestamp
</span></span><span class="l" id="180"><a class="l" href="#180"> 180 </a><span class="php-comment">     *
</span></span><span class="l" id="181"><a class="l" href="#181"> 181 </a><span class="php-comment">     * @return string
</span></span><span class="l" id="182"><a class="l" href="#182"> 182 </a><span class="php-comment">     */</span>
</span><span class="l" id="183"><a class="l" href="#183"> 183 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_datetime" id="_datetime">datetime</a>(<span class="php-var">$timestamp</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="184"><a class="l" href="#184"> 184 </a>    {
</span><span class="l" id="185"><a class="l" href="#185"> 185 </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">date</span>(self::FORMAT_DATETIME, <span class="php-keyword1">null</span> === <span class="php-var">$timestamp</span> ? <span class="php-keyword2">time</span>() : <span class="php-var">$timestamp</span>);
</span><span class="l" id="186"><a class="l" href="#186"> 186 </a>    }
</span><span class="l" id="187"><a class="l" href="#187"> 187 </a>
</span><span class="l" id="188"><a class="l" href="#188"> 188 </a>    <span class="php-comment">/**
</span></span><span class="l" id="189"><a class="l" href="#189"> 189 </a><span class="php-comment">     * Setzt eine Abfrage (SQL) ab, wechselt die DBID falls vorhanden.
</span></span><span class="l" id="190"><a class="l" href="#190"> 190 </a><span class="php-comment">     *
</span></span><span class="l" id="191"><a class="l" href="#191"> 191 </a><span class="php-comment">     * @param string $query   The sql-query
</span></span><span class="l" id="192"><a class="l" href="#192"> 192 </a><span class="php-comment">     * @param array  $params  An optional array of statement parameter
</span></span><span class="l" id="193"><a class="l" href="#193"> 193 </a><span class="php-comment">     * @param array  $options For possible option keys view `rex_sql::OPT_*` constants
</span></span><span class="l" id="194"><a class="l" href="#194"> 194 </a><span class="php-comment">     *
</span></span><span class="l" id="195"><a class="l" href="#195"> 195 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="196"><a class="l" href="#196"> 196 </a><span class="php-comment">     *
</span></span><span class="l" id="197"><a class="l" href="#197"> 197 </a><span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="198"><a class="l" href="#198"> 198 </a><span class="php-comment">     */</span>
</span><span class="l" id="199"><a class="l" href="#199"> 199 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setDBQuery" id="_setDBQuery">setDBQuery</a>(<span class="php-var">$query</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-keyword1">array</span> <span class="php-var">$options</span> = [])
</span><span class="l" id="200"><a class="l" href="#200"> 200 </a>    {
</span><span class="l" id="201"><a class="l" href="#201"> 201 </a>        <span class="php-comment">// save origin connection-id</span>
</span><span class="l" id="202"><a class="l" href="#202"> 202 </a>        <span class="php-var">$oldDBID</span> = <span class="php-var">$this</span>-&gt;DBID;
</span><span class="l" id="203"><a class="l" href="#203"> 203 </a>
</span><span class="l" id="204"><a class="l" href="#204"> 204 </a>        <span class="php-comment">// change connection-id but only for this one query</span>
</span><span class="l" id="205"><a class="l" href="#205"> 205 </a>        <span class="php-keyword1">if</span> ((<span class="php-var">$qryDBID</span> = self::stripQueryDBID(<span class="php-var">$query</span>)) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="206"><a class="l" href="#206"> 206 </a>            <span class="php-var">$this</span>-&gt;selectDB(<span class="php-var">$qryDBID</span>);
</span><span class="l" id="207"><a class="l" href="#207"> 207 </a>        }
</span><span class="l" id="208"><a class="l" href="#208"> 208 </a>
</span><span class="l" id="209"><a class="l" href="#209"> 209 </a>        <span class="php-var">$this</span>-&gt;setQuery(<span class="php-var">$query</span>, <span class="php-var">$params</span>, <span class="php-var">$options</span>);
</span><span class="l" id="210"><a class="l" href="#210"> 210 </a>
</span><span class="l" id="211"><a class="l" href="#211"> 211 </a>        <span class="php-comment">// restore connection-id</span>
</span><span class="l" id="212"><a class="l" href="#212"> 212 </a>        <span class="php-var">$this</span>-&gt;DBID = <span class="php-var">$oldDBID</span>;
</span><span class="l" id="213"><a class="l" href="#213"> 213 </a>
</span><span class="l" id="214"><a class="l" href="#214"> 214 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="215"><a class="l" href="#215"> 215 </a>    }
</span><span class="l" id="216"><a class="l" href="#216"> 216 </a>
</span><span class="l" id="217"><a class="l" href="#217"> 217 </a>    <span class="php-comment">/**
</span></span><span class="l" id="218"><a class="l" href="#218"> 218 </a><span class="php-comment">     * Setzt Debugmodus an/aus.
</span></span><span class="l" id="219"><a class="l" href="#219"> 219 </a><span class="php-comment">     *
</span></span><span class="l" id="220"><a class="l" href="#220"> 220 </a><span class="php-comment">     * @param bool $debug Debug TRUE/FALSE
</span></span><span class="l" id="221"><a class="l" href="#221"> 221 </a><span class="php-comment">     *
</span></span><span class="l" id="222"><a class="l" href="#222"> 222 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="223"><a class="l" href="#223"> 223 </a><span class="php-comment">     */</span>
</span><span class="l" id="224"><a class="l" href="#224"> 224 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setDebug" id="_setDebug">setDebug</a>(<span class="php-var">$debug</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="225"><a class="l" href="#225"> 225 </a>    {
</span><span class="l" id="226"><a class="l" href="#226"> 226 </a>        <span class="php-var">$this</span>-&gt;debug = <span class="php-var">$debug</span>;
</span><span class="l" id="227"><a class="l" href="#227"> 227 </a>
</span><span class="l" id="228"><a class="l" href="#228"> 228 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="229"><a class="l" href="#229"> 229 </a>    }
</span><span class="l" id="230"><a class="l" href="#230"> 230 </a>
</span><span class="l" id="231"><a class="l" href="#231"> 231 </a>    <span class="php-comment">/**
</span></span><span class="l" id="232"><a class="l" href="#232"> 232 </a><span class="php-comment">     * Prepares a PDOStatement.
</span></span><span class="l" id="233"><a class="l" href="#233"> 233 </a><span class="php-comment">     *
</span></span><span class="l" id="234"><a class="l" href="#234"> 234 </a><span class="php-comment">     * @param string $qry A query string with placeholders
</span></span><span class="l" id="235"><a class="l" href="#235"> 235 </a><span class="php-comment">     *
</span></span><span class="l" id="236"><a class="l" href="#236"> 236 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="237"><a class="l" href="#237"> 237 </a><span class="php-comment">     *
</span></span><span class="l" id="238"><a class="l" href="#238"> 238 </a><span class="php-comment">     * @return PDOStatement The prepared statement
</span></span><span class="l" id="239"><a class="l" href="#239"> 239 </a><span class="php-comment">     */</span>
</span><span class="l" id="240"><a class="l" href="#240"> 240 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_prepareQuery" id="_prepareQuery">prepareQuery</a>(<span class="php-var">$qry</span>)
</span><span class="l" id="241"><a class="l" href="#241"> 241 </a>    {
</span><span class="l" id="242"><a class="l" href="#242"> 242 </a>        <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="243"><a class="l" href="#243"> 243 </a>        <span class="php-keyword1">try</span> {
</span><span class="l" id="244"><a class="l" href="#244"> 244 </a>            <span class="php-var">$this</span>-&gt;query = <span class="php-var">$qry</span>;
</span><span class="l" id="245"><a class="l" href="#245"> 245 </a>            <span class="php-var">$this</span>-&gt;stmt = <span class="php-var">$pdo</span>-&gt;prepare(<span class="php-var">$qry</span>);
</span><span class="l" id="246"><a class="l" href="#246"> 246 </a>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt;
</span><span class="l" id="247"><a class="l" href="#247"> 247 </a>        } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="248"><a class="l" href="#248"> 248 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while preparing statement "'</span> . <span class="php-var">$qry</span> . <span class="php-quote">'"! '</span> . <span class="php-var">$e</span>-&gt;getMessage(), <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="249"><a class="l" href="#249"> 249 </a>        }
</span><span class="l" id="250"><a class="l" href="#250"> 250 </a>    }
</span><span class="l" id="251"><a class="l" href="#251"> 251 </a>
</span><span class="l" id="252"><a class="l" href="#252"> 252 </a>    <span class="php-comment">/**
</span></span><span class="l" id="253"><a class="l" href="#253"> 253 </a><span class="php-comment">     * Executes the prepared statement with the given input parameters.
</span></span><span class="l" id="254"><a class="l" href="#254"> 254 </a><span class="php-comment">     *
</span></span><span class="l" id="255"><a class="l" href="#255"> 255 </a><span class="php-comment">     * @param array $params  Array of input parameters
</span></span><span class="l" id="256"><a class="l" href="#256"> 256 </a><span class="php-comment">     * @param array $options For possible option keys view `rex_sql::OPT_*` constants
</span></span><span class="l" id="257"><a class="l" href="#257"> 257 </a><span class="php-comment">     *
</span></span><span class="l" id="258"><a class="l" href="#258"> 258 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="259"><a class="l" href="#259"> 259 </a><span class="php-comment">     *
</span></span><span class="l" id="260"><a class="l" href="#260"> 260 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="261"><a class="l" href="#261"> 261 </a><span class="php-comment">     */</span>
</span><span class="l" id="262"><a class="l" href="#262"> 262 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_execute" id="_execute">execute</a>(<span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-keyword1">array</span> <span class="php-var">$options</span> = [])
</span><span class="l" id="263"><a class="l" href="#263"> 263 </a>    {
</span><span class="l" id="264"><a class="l" href="#264"> 264 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;stmt) {
</span><span class="l" id="265"><a class="l" href="#265"> 265 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'you need to prepare a query before calling execute()'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="266"><a class="l" href="#266"> 266 </a>        }
</span><span class="l" id="267"><a class="l" href="#267"> 267 </a>
</span><span class="l" id="268"><a class="l" href="#268"> 268 </a>        <span class="php-var">$buffered</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="269"><a class="l" href="#269"> 269 </a>        <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="270"><a class="l" href="#270"> 270 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[self::OPT_BUFFERED])) {
</span><span class="l" id="271"><a class="l" href="#271"> 271 </a>            <span class="php-var">$buffered</span> = <span class="php-var">$pdo</span>-&gt;getAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY);
</span><span class="l" id="272"><a class="l" href="#272"> 272 </a>            <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$options</span>[self::OPT_BUFFERED]);
</span><span class="l" id="273"><a class="l" href="#273"> 273 </a>        }
</span><span class="l" id="274"><a class="l" href="#274"> 274 </a>
</span><span class="l" id="275"><a class="l" href="#275"> 275 </a>        <span class="php-keyword1">try</span> {
</span><span class="l" id="276"><a class="l" href="#276"> 276 </a>            <span class="php-var">$this</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span class="l" id="277"><a class="l" href="#277"> 277 </a>            <span class="php-var">$this</span>-&gt;params = <span class="php-var">$params</span>;
</span><span class="l" id="278"><a class="l" href="#278"> 278 </a>
</span><span class="l" id="279"><a class="l" href="#279"> 279 </a>            <span class="php-var">$this</span>-&gt;stmt-&gt;execute(<span class="php-var">$params</span>);
</span><span class="l" id="280"><a class="l" href="#280"> 280 </a>            <span class="php-var">$this</span>-&gt;rows = <span class="php-var">$this</span>-&gt;stmt-&gt;rowCount();
</span><span class="l" id="281"><a class="l" href="#281"> 281 </a>        } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="282"><a class="l" href="#282"> 282 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while executing statement "'</span> . <span class="php-var">$this</span>-&gt;query . <span class="php-quote">'" using params '</span> . <span class="php-keyword2">json_encode</span>(<span class="php-var">$params</span>) . <span class="php-quote">'! '</span> . <span class="php-var">$e</span>-&gt;getMessage(), <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="283"><a class="l" href="#283"> 283 </a>        } finally {
</span><span class="l" id="284"><a class="l" href="#284"> 284 </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> !== <span class="php-var">$buffered</span>) {
</span><span class="l" id="285"><a class="l" href="#285"> 285 </a>                <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$buffered</span>);
</span><span class="l" id="286"><a class="l" href="#286"> 286 </a>            }
</span><span class="l" id="287"><a class="l" href="#287"> 287 </a>
</span><span class="l" id="288"><a class="l" href="#288"> 288 </a>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;debug) {
</span><span class="l" id="289"><a class="l" href="#289"> 289 </a>                <span class="php-var">$this</span>-&gt;printError(<span class="php-var">$this</span>-&gt;query, <span class="php-var">$params</span>);
</span><span class="l" id="290"><a class="l" href="#290"> 290 </a>            }
</span><span class="l" id="291"><a class="l" href="#291"> 291 </a>        }
</span><span class="l" id="292"><a class="l" href="#292"> 292 </a>
</span><span class="l" id="293"><a class="l" href="#293"> 293 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="294"><a class="l" href="#294"> 294 </a>    }
</span><span class="l" id="295"><a class="l" href="#295"> 295 </a>
</span><span class="l" id="296"><a class="l" href="#296"> 296 </a>    <span class="php-comment">/**
</span></span><span class="l" id="297"><a class="l" href="#297"> 297 </a><span class="php-comment">     * Executes the given sql-query.
</span></span><span class="l" id="298"><a class="l" href="#298"> 298 </a><span class="php-comment">     *
</span></span><span class="l" id="299"><a class="l" href="#299"> 299 </a><span class="php-comment">     * If parameters will be provided, a prepared statement will be executed.
</span></span><span class="l" id="300"><a class="l" href="#300"> 300 </a><span class="php-comment">     *
</span></span><span class="l" id="301"><a class="l" href="#301"> 301 </a><span class="php-comment">     * example 1:
</span></span><span class="l" id="302"><a class="l" href="#302"> 302 </a><span class="php-comment">     *    $sql-&gt;setQuery('SELECT * FROM mytable where id=:id', ['id' =&gt; 3]);
</span></span><span class="l" id="303"><a class="l" href="#303"> 303 </a><span class="php-comment">     *
</span></span><span class="l" id="304"><a class="l" href="#304"> 304 </a><span class="php-comment">     * NOTE: named-parameters/?-placeholders are not supported in LIMIT clause!
</span></span><span class="l" id="305"><a class="l" href="#305"> 305 </a><span class="php-comment">     *
</span></span><span class="l" id="306"><a class="l" href="#306"> 306 </a><span class="php-comment">     * @param string $query   The sql-query
</span></span><span class="l" id="307"><a class="l" href="#307"> 307 </a><span class="php-comment">     * @param array  $params  An optional array of statement parameter
</span></span><span class="l" id="308"><a class="l" href="#308"> 308 </a><span class="php-comment">     * @param array  $options For possible option keys view `rex_sql::OPT_*` constants
</span></span><span class="l" id="309"><a class="l" href="#309"> 309 </a><span class="php-comment">     *
</span></span><span class="l" id="310"><a class="l" href="#310"> 310 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="311"><a class="l" href="#311"> 311 </a><span class="php-comment">     *
</span></span><span class="l" id="312"><a class="l" href="#312"> 312 </a><span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="313"><a class="l" href="#313"> 313 </a><span class="php-comment">     */</span>
</span><span class="l" id="314"><a class="l" href="#314"> 314 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setQuery" id="_setQuery">setQuery</a>(<span class="php-var">$query</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-keyword1">array</span> <span class="php-var">$options</span> = [])
</span><span class="l" id="315"><a class="l" href="#315"> 315 </a>    {
</span><span class="l" id="316"><a class="l" href="#316"> 316 </a>        <span class="php-comment">// Alle Werte zuruecksetzen</span>
</span><span class="l" id="317"><a class="l" href="#317"> 317 </a>        <span class="php-var">$this</span>-&gt;<span class="php-keyword2">flush</span>();
</span><span class="l" id="318"><a class="l" href="#318"> 318 </a>        <span class="php-var">$this</span>-&gt;query = <span class="php-var">$query</span>;
</span><span class="l" id="319"><a class="l" href="#319"> 319 </a>        <span class="php-var">$this</span>-&gt;params = <span class="php-var">$params</span>;
</span><span class="l" id="320"><a class="l" href="#320"> 320 </a>        <span class="php-var">$this</span>-&gt;stmt = <span class="php-keyword1">null</span>;
</span><span class="l" id="321"><a class="l" href="#321"> 321 </a>
</span><span class="l" id="322"><a class="l" href="#322"> 322 </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>)) {
</span><span class="l" id="323"><a class="l" href="#323"> 323 </a>            <span class="php-var">$this</span>-&gt;prepareQuery(<span class="php-var">$query</span>);
</span><span class="l" id="324"><a class="l" href="#324"> 324 </a>            <span class="php-var">$this</span>-&gt;execute(<span class="php-var">$params</span>, <span class="php-var">$options</span>);
</span><span class="l" id="325"><a class="l" href="#325"> 325 </a>
</span><span class="l" id="326"><a class="l" href="#326"> 326 </a>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="327"><a class="l" href="#327"> 327 </a>        }
</span><span class="l" id="328"><a class="l" href="#328"> 328 </a>
</span><span class="l" id="329"><a class="l" href="#329"> 329 </a>        <span class="php-var">$buffered</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="330"><a class="l" href="#330"> 330 </a>        <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="331"><a class="l" href="#331"> 331 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[self::OPT_BUFFERED])) {
</span><span class="l" id="332"><a class="l" href="#332"> 332 </a>            <span class="php-var">$buffered</span> = <span class="php-var">$pdo</span>-&gt;getAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY);
</span><span class="l" id="333"><a class="l" href="#333"> 333 </a>            <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$options</span>[self::OPT_BUFFERED]);
</span><span class="l" id="334"><a class="l" href="#334"> 334 </a>        }
</span><span class="l" id="335"><a class="l" href="#335"> 335 </a>
</span><span class="l" id="336"><a class="l" href="#336"> 336 </a>        <span class="php-keyword1">try</span> {
</span><span class="l" id="337"><a class="l" href="#337"> 337 </a>            <span class="php-var">$this</span>-&gt;stmt = <span class="php-var">$pdo</span>-&gt;query(<span class="php-var">$query</span>);
</span><span class="l" id="338"><a class="l" href="#338"> 338 </a>            <span class="php-var">$this</span>-&gt;rows = <span class="php-var">$this</span>-&gt;stmt-&gt;rowCount();
</span><span class="l" id="339"><a class="l" href="#339"> 339 </a>        } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="340"><a class="l" href="#340"> 340 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while executing statement "'</span> . <span class="php-var">$query</span> . <span class="php-quote">'"! '</span> . <span class="php-var">$e</span>-&gt;getMessage(), <span class="php-var">$e</span>, <span class="php-var">$this</span>);
</span><span class="l" id="341"><a class="l" href="#341"> 341 </a>        } finally {
</span><span class="l" id="342"><a class="l" href="#342"> 342 </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> !== <span class="php-var">$buffered</span>) {
</span><span class="l" id="343"><a class="l" href="#343"> 343 </a>                <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class="php-var">$buffered</span>);
</span><span class="l" id="344"><a class="l" href="#344"> 344 </a>            }
</span><span class="l" id="345"><a class="l" href="#345"> 345 </a>
</span><span class="l" id="346"><a class="l" href="#346"> 346 </a>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;debug) {
</span><span class="l" id="347"><a class="l" href="#347"> 347 </a>                <span class="php-var">$this</span>-&gt;printError(<span class="php-var">$query</span>, <span class="php-var">$params</span>);
</span><span class="l" id="348"><a class="l" href="#348"> 348 </a>            }
</span><span class="l" id="349"><a class="l" href="#349"> 349 </a>        }
</span><span class="l" id="350"><a class="l" href="#350"> 350 </a>
</span><span class="l" id="351"><a class="l" href="#351"> 351 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="352"><a class="l" href="#352"> 352 </a>    }
</span><span class="l" id="353"><a class="l" href="#353"> 353 </a>
</span><span class="l" id="354"><a class="l" href="#354"> 354 </a>    <span class="php-comment">/**
</span></span><span class="l" id="355"><a class="l" href="#355"> 355 </a><span class="php-comment">     * Setzt den Tabellennamen.
</span></span><span class="l" id="356"><a class="l" href="#356"> 356 </a><span class="php-comment">     *
</span></span><span class="l" id="357"><a class="l" href="#357"> 357 </a><span class="php-comment">     * @param string $table Tabellenname
</span></span><span class="l" id="358"><a class="l" href="#358"> 358 </a><span class="php-comment">     *
</span></span><span class="l" id="359"><a class="l" href="#359"> 359 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="360"><a class="l" href="#360"> 360 </a><span class="php-comment">     */</span>
</span><span class="l" id="361"><a class="l" href="#361"> 361 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setTable" id="_setTable">setTable</a>(<span class="php-var">$table</span>)
</span><span class="l" id="362"><a class="l" href="#362"> 362 </a>    {
</span><span class="l" id="363"><a class="l" href="#363"> 363 </a>        <span class="php-var">$this</span>-&gt;table = <span class="php-var">$table</span>;
</span><span class="l" id="364"><a class="l" href="#364"> 364 </a>
</span><span class="l" id="365"><a class="l" href="#365"> 365 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="366"><a class="l" href="#366"> 366 </a>    }
</span><span class="l" id="367"><a class="l" href="#367"> 367 </a>
</span><span class="l" id="368"><a class="l" href="#368"> 368 </a>    <span class="php-comment">/**
</span></span><span class="l" id="369"><a class="l" href="#369"> 369 </a><span class="php-comment">     * Sets the raw value of a column.
</span></span><span class="l" id="370"><a class="l" href="#370"> 370 </a><span class="php-comment">     *
</span></span><span class="l" id="371"><a class="l" href="#371"> 371 </a><span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="372"><a class="l" href="#372"> 372 </a><span class="php-comment">     * @param string $value   The raw value
</span></span><span class="l" id="373"><a class="l" href="#373"> 373 </a><span class="php-comment">     *
</span></span><span class="l" id="374"><a class="l" href="#374"> 374 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="375"><a class="l" href="#375"> 375 </a><span class="php-comment">     */</span>
</span><span class="l" id="376"><a class="l" href="#376"> 376 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setRawValue" id="_setRawValue">setRawValue</a>(<span class="php-var">$colName</span>, <span class="php-var">$value</span>)
</span><span class="l" id="377"><a class="l" href="#377"> 377 </a>    {
</span><span class="l" id="378"><a class="l" href="#378"> 378 </a>        <span class="php-var">$this</span>-&gt;rawValues[<span class="php-var">$colName</span>] = <span class="php-var">$value</span>;
</span><span class="l" id="379"><a class="l" href="#379"> 379 </a>        <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>]);
</span><span class="l" id="380"><a class="l" href="#380"> 380 </a>
</span><span class="l" id="381"><a class="l" href="#381"> 381 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="382"><a class="l" href="#382"> 382 </a>    }
</span><span class="l" id="383"><a class="l" href="#383"> 383 </a>
</span><span class="l" id="384"><a class="l" href="#384"> 384 </a>    <span class="php-comment">/**
</span></span><span class="l" id="385"><a class="l" href="#385"> 385 </a><span class="php-comment">     * Set the value of a column.
</span></span><span class="l" id="386"><a class="l" href="#386"> 386 </a><span class="php-comment">     *
</span></span><span class="l" id="387"><a class="l" href="#387"> 387 </a><span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="388"><a class="l" href="#388"> 388 </a><span class="php-comment">     * @param mixed  $value   The value
</span></span><span class="l" id="389"><a class="l" href="#389"> 389 </a><span class="php-comment">     *
</span></span><span class="l" id="390"><a class="l" href="#390"> 390 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="391"><a class="l" href="#391"> 391 </a><span class="php-comment">     */</span>
</span><span class="l" id="392"><a class="l" href="#392"> 392 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setValue" id="_setValue">setValue</a>(<span class="php-var">$colName</span>, <span class="php-var">$value</span>)
</span><span class="l" id="393"><a class="l" href="#393"> 393 </a>    {
</span><span class="l" id="394"><a class="l" href="#394"> 394 </a>        <span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>] = <span class="php-var">$value</span>;
</span><span class="l" id="395"><a class="l" href="#395"> 395 </a>        <span class="php-keyword1">unset</span>(<span class="php-var">$this</span>-&gt;rawValues[<span class="php-var">$colName</span>]);
</span><span class="l" id="396"><a class="l" href="#396"> 396 </a>
</span><span class="l" id="397"><a class="l" href="#397"> 397 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="398"><a class="l" href="#398"> 398 </a>    }
</span><span class="l" id="399"><a class="l" href="#399"> 399 </a>
</span><span class="l" id="400"><a class="l" href="#400"> 400 </a>    <span class="php-comment">/**
</span></span><span class="l" id="401"><a class="l" href="#401"> 401 </a><span class="php-comment">     * Set the array value of a column (json encoded).
</span></span><span class="l" id="402"><a class="l" href="#402"> 402 </a><span class="php-comment">     *
</span></span><span class="l" id="403"><a class="l" href="#403"> 403 </a><span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="404"><a class="l" href="#404"> 404 </a><span class="php-comment">     * @param array  $value   The value
</span></span><span class="l" id="405"><a class="l" href="#405"> 405 </a><span class="php-comment">     *
</span></span><span class="l" id="406"><a class="l" href="#406"> 406 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="407"><a class="l" href="#407"> 407 </a><span class="php-comment">     */</span>
</span><span class="l" id="408"><a class="l" href="#408"> 408 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setArrayValue" id="_setArrayValue">setArrayValue</a>(<span class="php-var">$colName</span>, <span class="php-keyword1">array</span> <span class="php-var">$value</span>)
</span><span class="l" id="409"><a class="l" href="#409"> 409 </a>    {
</span><span class="l" id="410"><a class="l" href="#410"> 410 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$colName</span>, <span class="php-keyword2">json_encode</span>(<span class="php-var">$value</span>));
</span><span class="l" id="411"><a class="l" href="#411"> 411 </a>    }
</span><span class="l" id="412"><a class="l" href="#412"> 412 </a>
</span><span class="l" id="413"><a class="l" href="#413"> 413 </a>    <span class="php-comment">/**
</span></span><span class="l" id="414"><a class="l" href="#414"> 414 </a><span class="php-comment">     * Sets the datetime value of a column.
</span></span><span class="l" id="415"><a class="l" href="#415"> 415 </a><span class="php-comment">     *
</span></span><span class="l" id="416"><a class="l" href="#416"> 416 </a><span class="php-comment">     * @param string   $colName   Name of the column
</span></span><span class="l" id="417"><a class="l" href="#417"> 417 </a><span class="php-comment">     * @param int|null $timestamp Unix timestamp (if `null` is given, the current time is used)
</span></span><span class="l" id="418"><a class="l" href="#418"> 418 </a><span class="php-comment">     *
</span></span><span class="l" id="419"><a class="l" href="#419"> 419 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="420"><a class="l" href="#420"> 420 </a><span class="php-comment">     */</span>
</span><span class="l" id="421"><a class="l" href="#421"> 421 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setDateTimeValue" id="_setDateTimeValue">setDateTimeValue</a>(<span class="php-var">$colName</span>, <span class="php-var">$timestamp</span>)
</span><span class="l" id="422"><a class="l" href="#422"> 422 </a>    {
</span><span class="l" id="423"><a class="l" href="#423"> 423 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$colName</span>, self::datetime(<span class="php-var">$timestamp</span>));
</span><span class="l" id="424"><a class="l" href="#424"> 424 </a>    }
</span><span class="l" id="425"><a class="l" href="#425"> 425 </a>
</span><span class="l" id="426"><a class="l" href="#426"> 426 </a>    <span class="php-comment">/**
</span></span><span class="l" id="427"><a class="l" href="#427"> 427 </a><span class="php-comment">     * Setzt ein Array von Werten zugleich.
</span></span><span class="l" id="428"><a class="l" href="#428"> 428 </a><span class="php-comment">     *
</span></span><span class="l" id="429"><a class="l" href="#429"> 429 </a><span class="php-comment">     * @param array $valueArray Ein Array von Werten
</span></span><span class="l" id="430"><a class="l" href="#430"> 430 </a><span class="php-comment">     *
</span></span><span class="l" id="431"><a class="l" href="#431"> 431 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="432"><a class="l" href="#432"> 432 </a><span class="php-comment">     */</span>
</span><span class="l" id="433"><a class="l" href="#433"> 433 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setValues" id="_setValues">setValues</a>(<span class="php-keyword1">array</span> <span class="php-var">$valueArray</span>)
</span><span class="l" id="434"><a class="l" href="#434"> 434 </a>    {
</span><span class="l" id="435"><a class="l" href="#435"> 435 </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$valueArray</span> <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="436"><a class="l" href="#436"> 436 </a>            <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$name</span>, <span class="php-var">$value</span>);
</span><span class="l" id="437"><a class="l" href="#437"> 437 </a>        }
</span><span class="l" id="438"><a class="l" href="#438"> 438 </a>
</span><span class="l" id="439"><a class="l" href="#439"> 439 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="440"><a class="l" href="#440"> 440 </a>    }
</span><span class="l" id="441"><a class="l" href="#441"> 441 </a>
</span><span class="l" id="442"><a class="l" href="#442"> 442 </a>    <span class="php-comment">/**
</span></span><span class="l" id="443"><a class="l" href="#443"> 443 </a><span class="php-comment">     * Returns whether values are set inside this rex_sql object.
</span></span><span class="l" id="444"><a class="l" href="#444"> 444 </a><span class="php-comment">     *
</span></span><span class="l" id="445"><a class="l" href="#445"> 445 </a><span class="php-comment">     * @return bool True if value isset and not null, otherwise False
</span></span><span class="l" id="446"><a class="l" href="#446"> 446 </a><span class="php-comment">     */</span>
</span><span class="l" id="447"><a class="l" href="#447"> 447 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_hasValues" id="_hasValues">hasValues</a>()
</span><span class="l" id="448"><a class="l" href="#448"> 448 </a>    {
</span><span class="l" id="449"><a class="l" href="#449"> 449 </a>        <span class="php-keyword1">return</span> !<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;values);
</span><span class="l" id="450"><a class="l" href="#450"> 450 </a>    }
</span><span class="l" id="451"><a class="l" href="#451"> 451 </a>
</span><span class="l" id="452"><a class="l" href="#452"> 452 </a>    <span class="php-comment">/**
</span></span><span class="l" id="453"><a class="l" href="#453"> 453 </a><span class="php-comment">     * Prueft den Wert einer Spalte der aktuellen Zeile ob ein Wert enthalten ist.
</span></span><span class="l" id="454"><a class="l" href="#454"> 454 </a><span class="php-comment">     *
</span></span><span class="l" id="455"><a class="l" href="#455"> 455 </a><span class="php-comment">     * @param string $feld Spaltenname des zu pruefenden Feldes
</span></span><span class="l" id="456"><a class="l" href="#456"> 456 </a><span class="php-comment">     * @param string $prop Wert, der enthalten sein soll
</span></span><span class="l" id="457"><a class="l" href="#457"> 457 </a><span class="php-comment">     *
</span></span><span class="l" id="458"><a class="l" href="#458"> 458 </a><span class="php-comment">     * @return bool
</span></span><span class="l" id="459"><a class="l" href="#459"> 459 </a><span class="php-comment">     */</span>
</span><span class="l" id="460"><a class="l" href="#460"> 460 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> <a href="#_isValueOf" id="_isValueOf">isValueOf</a>(<span class="php-var">$feld</span>, <span class="php-var">$prop</span>)
</span><span class="l" id="461"><a class="l" href="#461"> 461 </a>    {
</span><span class="l" id="462"><a class="l" href="#462"> 462 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$prop</span> == <span class="php-quote">''</span>) {
</span><span class="l" id="463"><a class="l" href="#463"> 463 </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="464"><a class="l" href="#464"> 464 </a>        }
</span><span class="l" id="465"><a class="l" href="#465"> 465 </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">strpos</span>(<span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$feld</span>), <span class="php-var">$prop</span>) !== <span class="php-keyword1">false</span>;
</span><span class="l" id="466"><a class="l" href="#466"> 466 </a>    }
</span><span class="l" id="467"><a class="l" href="#467"> 467 </a>
</span><span class="l" id="468"><a class="l" href="#468"> 468 </a>    <span class="php-comment">/**
</span></span><span class="l" id="469"><a class="l" href="#469"> 469 </a><span class="php-comment">     * Setzt die WHERE Bedienung der Abfrage.
</span></span><span class="l" id="470"><a class="l" href="#470"> 470 </a><span class="php-comment">     *
</span></span><span class="l" id="471"><a class="l" href="#471"> 471 </a><span class="php-comment">     * example 1:
</span></span><span class="l" id="472"><a class="l" href="#472"> 472 </a><span class="php-comment">     *    $sql-&gt;setWhere(['id' =&gt; 3, 'field' =&gt; '']); // results in id = 3 AND field = ''
</span></span><span class="l" id="473"><a class="l" href="#473"> 473 </a><span class="php-comment">     *    $sql-&gt;setWhere([['id' =&gt; 3, 'field' =&gt; '']]); // results in id = 3 OR field = ''
</span></span><span class="l" id="474"><a class="l" href="#474"> 474 </a><span class="php-comment">     *
</span></span><span class="l" id="475"><a class="l" href="#475"> 475 </a><span class="php-comment">     * example 2:
</span></span><span class="l" id="476"><a class="l" href="#476"> 476 </a><span class="php-comment">     *    $sql-&gt;setWhere('myid = :id OR anotherfield = :field', ['id' =&gt; 3, 'field' =&gt; '']);
</span></span><span class="l" id="477"><a class="l" href="#477"> 477 </a><span class="php-comment">     *
</span></span><span class="l" id="478"><a class="l" href="#478"> 478 </a><span class="php-comment">     * example 3 (deprecated):
</span></span><span class="l" id="479"><a class="l" href="#479"> 479 </a><span class="php-comment">     *    $sql-&gt;setWhere('myid="35" OR abc="zdf"');
</span></span><span class="l" id="480"><a class="l" href="#480"> 480 </a><span class="php-comment">     *
</span></span><span class="l" id="481"><a class="l" href="#481"> 481 </a><span class="php-comment">     * @param string|array $where
</span></span><span class="l" id="482"><a class="l" href="#482"> 482 </a><span class="php-comment">     * @param array        $whereParams
</span></span><span class="l" id="483"><a class="l" href="#483"> 483 </a><span class="php-comment">     *
</span></span><span class="l" id="484"><a class="l" href="#484"> 484 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="485"><a class="l" href="#485"> 485 </a><span class="php-comment">     *
</span></span><span class="l" id="486"><a class="l" href="#486"> 486 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="487"><a class="l" href="#487"> 487 </a><span class="php-comment">     */</span>
</span><span class="l" id="488"><a class="l" href="#488"> 488 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setWhere" id="_setWhere">setWhere</a>(<span class="php-var">$where</span>, <span class="php-var">$whereParams</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="489"><a class="l" href="#489"> 489 </a>    {
</span><span class="l" id="490"><a class="l" href="#490"> 490 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$where</span>)) {
</span><span class="l" id="491"><a class="l" href="#491"> 491 </a>            <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">'WHERE '</span> . <span class="php-var">$this</span>-&gt;buildWhereArg(<span class="php-var">$where</span>);
</span><span class="l" id="492"><a class="l" href="#492"> 492 </a>            <span class="php-var">$this</span>-&gt;whereParams = <span class="php-var">$where</span>;
</span><span class="l" id="493"><a class="l" href="#493"> 493 </a>        } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_string</span>(<span class="php-var">$where</span>) &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$whereParams</span>)) {
</span><span class="l" id="494"><a class="l" href="#494"> 494 </a>            <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">'WHERE '</span> . <span class="php-var">$where</span>;
</span><span class="l" id="495"><a class="l" href="#495"> 495 </a>            <span class="php-var">$this</span>-&gt;whereParams = <span class="php-var">$whereParams</span>;
</span><span class="l" id="496"><a class="l" href="#496"> 496 </a>        } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_string</span>(<span class="php-var">$where</span>)) {
</span><span class="l" id="497"><a class="l" href="#497"> 497 </a>            <span class="php-comment">//$trace = debug_backtrace();</span>
</span><span class="l" id="498"><a class="l" href="#498"> 498 </a>            <span class="php-comment">//$loc = $trace[0];</span>
</span><span class="l" id="499"><a class="l" href="#499"> 499 </a>            <span class="php-comment">//trigger_error('you have to take care to provide escaped values for your where-string in file "'. $loc['file'] .'" on line '. $loc['line'] .'!', E_USER_WARNING);</span>
</span><span class="l" id="500"><a class="l" href="#500"> 500 </a>
</span><span class="l" id="501"><a class="l" href="#501"> 501 </a>            <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">'WHERE '</span> . <span class="php-var">$where</span>;
</span><span class="l" id="502"><a class="l" href="#502"> 502 </a>            <span class="php-var">$this</span>-&gt;whereParams = [];
</span><span class="l" id="503"><a class="l" href="#503"> 503 </a>        } <span class="php-keyword1">else</span> {
</span><span class="l" id="504"><a class="l" href="#504"> 504 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'expecting $where to be an array, "'</span> . <span class="php-keyword2">gettype</span>(<span class="php-var">$where</span>) . <span class="php-quote">'" given!'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="505"><a class="l" href="#505"> 505 </a>        }
</span><span class="l" id="506"><a class="l" href="#506"> 506 </a>
</span><span class="l" id="507"><a class="l" href="#507"> 507 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="508"><a class="l" href="#508"> 508 </a>    }
</span><span class="l" id="509"><a class="l" href="#509"> 509 </a>
</span><span class="l" id="510"><a class="l" href="#510"> 510 </a>    <span class="php-comment">/**
</span></span><span class="l" id="511"><a class="l" href="#511"> 511 </a><span class="php-comment">     * Concats the given array to a sql condition using bound parameters.
</span></span><span class="l" id="512"><a class="l" href="#512"> 512 </a><span class="php-comment">     * AND/OR opartors are alternated depending on $level.
</span></span><span class="l" id="513"><a class="l" href="#513"> 513 </a><span class="php-comment">     *
</span></span><span class="l" id="514"><a class="l" href="#514"> 514 </a><span class="php-comment">     * @param array $arrFields
</span></span><span class="l" id="515"><a class="l" href="#515"> 515 </a><span class="php-comment">     * @param int   $level
</span></span><span class="l" id="516"><a class="l" href="#516"> 516 </a><span class="php-comment">     *
</span></span><span class="l" id="517"><a class="l" href="#517"> 517 </a><span class="php-comment">     * @return string
</span></span><span class="l" id="518"><a class="l" href="#518"> 518 </a><span class="php-comment">     */</span>
</span><span class="l" id="519"><a class="l" href="#519"> 519 </a>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> <a href="#_buildWhereArg" id="_buildWhereArg">buildWhereArg</a>(<span class="php-keyword1">array</span> <span class="php-var">$arrFields</span>, <span class="php-var">$level</span> = <span class="php-num">0</span>)
</span><span class="l" id="520"><a class="l" href="#520"> 520 </a>    {
</span><span class="l" id="521"><a class="l" href="#521"> 521 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$level</span> % <span class="php-num">2</span> == <span class="php-num">1</span>) {
</span><span class="l" id="522"><a class="l" href="#522"> 522 </a>            <span class="php-var">$op</span> = <span class="php-quote">' OR '</span>;
</span><span class="l" id="523"><a class="l" href="#523"> 523 </a>        } <span class="php-keyword1">else</span> {
</span><span class="l" id="524"><a class="l" href="#524"> 524 </a>            <span class="php-var">$op</span> = <span class="php-quote">' AND '</span>;
</span><span class="l" id="525"><a class="l" href="#525"> 525 </a>        }
</span><span class="l" id="526"><a class="l" href="#526"> 526 </a>
</span><span class="l" id="527"><a class="l" href="#527"> 527 </a>        <span class="php-var">$qry</span> = <span class="php-quote">''</span>;
</span><span class="l" id="528"><a class="l" href="#528"> 528 </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$arrFields</span> <span class="php-keyword1">as</span> <span class="php-var">$fld_name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="529"><a class="l" href="#529"> 529 </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$value</span>)) {
</span><span class="l" id="530"><a class="l" href="#530"> 530 </a>                <span class="php-var">$arg</span> = <span class="php-quote">'('</span> . <span class="php-var">$this</span>-&gt;buildWhereArg(<span class="php-var">$value</span>, <span class="php-var">$level</span> + <span class="php-num">1</span>) . <span class="php-quote">')'</span>;
</span><span class="l" id="531"><a class="l" href="#531"> 531 </a>            } <span class="php-keyword1">else</span> {
</span><span class="l" id="532"><a class="l" href="#532"> 532 </a>                <span class="php-var">$arg</span> = <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$fld_name</span>) . <span class="php-quote">' = :'</span> . <span class="php-var">$fld_name</span>;
</span><span class="l" id="533"><a class="l" href="#533"> 533 </a>            }
</span><span class="l" id="534"><a class="l" href="#534"> 534 </a>
</span><span class="l" id="535"><a class="l" href="#535"> 535 </a>            <span class="php-keyword1">if</span> (<span class="php-var">$qry</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="536"><a class="l" href="#536"> 536 </a>                <span class="php-var">$qry</span> .= <span class="php-var">$op</span>;
</span><span class="l" id="537"><a class="l" href="#537"> 537 </a>            }
</span><span class="l" id="538"><a class="l" href="#538"> 538 </a>            <span class="php-var">$qry</span> .= <span class="php-var">$arg</span>;
</span><span class="l" id="539"><a class="l" href="#539"> 539 </a>        }
</span><span class="l" id="540"><a class="l" href="#540"> 540 </a>        <span class="php-keyword1">return</span> <span class="php-var">$qry</span>;
</span><span class="l" id="541"><a class="l" href="#541"> 541 </a>    }
</span><span class="l" id="542"><a class="l" href="#542"> 542 </a>
</span><span class="l" id="543"><a class="l" href="#543"> 543 </a>    <span class="php-comment">/**
</span></span><span class="l" id="544"><a class="l" href="#544"> 544 </a><span class="php-comment">     * Returns the value of a column.
</span></span><span class="l" id="545"><a class="l" href="#545"> 545 </a><span class="php-comment">     *
</span></span><span class="l" id="546"><a class="l" href="#546"> 546 </a><span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="547"><a class="l" href="#547"> 547 </a><span class="php-comment">     *
</span></span><span class="l" id="548"><a class="l" href="#548"> 548 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="549"><a class="l" href="#549"> 549 </a><span class="php-comment">     *
</span></span><span class="l" id="550"><a class="l" href="#550"> 550 </a><span class="php-comment">     * @return mixed
</span></span><span class="l" id="551"><a class="l" href="#551"> 551 </a><span class="php-comment">     */</span>
</span><span class="l" id="552"><a class="l" href="#552"> 552 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getValue" id="_getValue">getValue</a>(<span class="php-var">$colName</span>)
</span><span class="l" id="553"><a class="l" href="#553"> 553 </a>    {
</span><span class="l" id="554"><a class="l" href="#554"> 554 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$colName</span>)) {
</span><span class="l" id="555"><a class="l" href="#555"> 555 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'parameter fieldname must not be empty!'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="556"><a class="l" href="#556"> 556 </a>        }
</span><span class="l" id="557"><a class="l" href="#557"> 557 </a>
</span><span class="l" id="558"><a class="l" href="#558"> 558 </a>        <span class="php-comment">// fast fail,... value already set manually?</span>
</span><span class="l" id="559"><a class="l" href="#559"> 559 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>])) {
</span><span class="l" id="560"><a class="l" href="#560"> 560 </a>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;values[<span class="php-var">$colName</span>];
</span><span class="l" id="561"><a class="l" href="#561"> 561 </a>        }
</span><span class="l" id="562"><a class="l" href="#562"> 562 </a>
</span><span class="l" id="563"><a class="l" href="#563"> 563 </a>        <span class="php-comment">// check if there is an table alias defined</span>
</span><span class="l" id="564"><a class="l" href="#564"> 564 </a>        <span class="php-comment">// if not, try to guess the tablename</span>
</span><span class="l" id="565"><a class="l" href="#565"> 565 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$colName</span>, <span class="php-quote">'.'</span>) === <span class="php-keyword1">false</span>) {
</span><span class="l" id="566"><a class="l" href="#566"> 566 </a>            <span class="php-var">$tables</span> = <span class="php-var">$this</span>-&gt;getTablenames();
</span><span class="l" id="567"><a class="l" href="#567"> 567 </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$tables</span> <span class="php-keyword1">as</span> <span class="php-var">$table</span>) {
</span><span class="l" id="568"><a class="l" href="#568"> 568 </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$table</span> . <span class="php-quote">'.'</span> . <span class="php-var">$colName</span>, <span class="php-var">$this</span>-&gt;rawFieldnames)) {
</span><span class="l" id="569"><a class="l" href="#569"> 569 </a>                    <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;fetchValue(<span class="php-var">$table</span> . <span class="php-quote">'.'</span> . <span class="php-var">$colName</span>);
</span><span class="l" id="570"><a class="l" href="#570"> 570 </a>                }
</span><span class="l" id="571"><a class="l" href="#571"> 571 </a>            }
</span><span class="l" id="572"><a class="l" href="#572"> 572 </a>        }
</span><span class="l" id="573"><a class="l" href="#573"> 573 </a>
</span><span class="l" id="574"><a class="l" href="#574"> 574 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;fetchValue(<span class="php-var">$colName</span>);
</span><span class="l" id="575"><a class="l" href="#575"> 575 </a>    }
</span><span class="l" id="576"><a class="l" href="#576"> 576 </a>
</span><span class="l" id="577"><a class="l" href="#577"> 577 </a>    <span class="php-comment">/**
</span></span><span class="l" id="578"><a class="l" href="#578"> 578 </a><span class="php-comment">     * Returns the array value of a (json encoded) column.
</span></span><span class="l" id="579"><a class="l" href="#579"> 579 </a><span class="php-comment">     *
</span></span><span class="l" id="580"><a class="l" href="#580"> 580 </a><span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="581"><a class="l" href="#581"> 581 </a><span class="php-comment">     *
</span></span><span class="l" id="582"><a class="l" href="#582"> 582 </a><span class="php-comment">     * @return array
</span></span><span class="l" id="583"><a class="l" href="#583"> 583 </a><span class="php-comment">     */</span>
</span><span class="l" id="584"><a class="l" href="#584"> 584 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getArrayValue" id="_getArrayValue">getArrayValue</a>(<span class="php-var">$colName</span>)
</span><span class="l" id="585"><a class="l" href="#585"> 585 </a>    {
</span><span class="l" id="586"><a class="l" href="#586"> 586 </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">json_decode</span>(<span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$colName</span>), <span class="php-keyword1">true</span>);
</span><span class="l" id="587"><a class="l" href="#587"> 587 </a>    }
</span><span class="l" id="588"><a class="l" href="#588"> 588 </a>
</span><span class="l" id="589"><a class="l" href="#589"> 589 </a>    <span class="php-comment">/**
</span></span><span class="l" id="590"><a class="l" href="#590"> 590 </a><span class="php-comment">     * Returns the unix timestamp of a datetime column.
</span></span><span class="l" id="591"><a class="l" href="#591"> 591 </a><span class="php-comment">     *
</span></span><span class="l" id="592"><a class="l" href="#592"> 592 </a><span class="php-comment">     * @param string $colName Name of the column
</span></span><span class="l" id="593"><a class="l" href="#593"> 593 </a><span class="php-comment">     *
</span></span><span class="l" id="594"><a class="l" href="#594"> 594 </a><span class="php-comment">     * @return int|null Unix timestamp or `null` if the column is `null` or not in sql datetime format
</span></span><span class="l" id="595"><a class="l" href="#595"> 595 </a><span class="php-comment">     */</span>
</span><span class="l" id="596"><a class="l" href="#596"> 596 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getDateTimeValue" id="_getDateTimeValue">getDateTimeValue</a>(<span class="php-var">$colName</span>)
</span><span class="l" id="597"><a class="l" href="#597"> 597 </a>    {
</span><span class="l" id="598"><a class="l" href="#598"> 598 </a>        <span class="php-var">$value</span> = <span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$colName</span>);
</span><span class="l" id="599"><a class="l" href="#599"> 599 </a>        <span class="php-keyword1">return</span> <span class="php-var">$value</span> ? <span class="php-keyword2">strtotime</span>(<span class="php-var">$value</span>) : <span class="php-keyword1">null</span>;
</span><span class="l" id="600"><a class="l" href="#600"> 600 </a>    }
</span><span class="l" id="601"><a class="l" href="#601"> 601 </a>
</span><span class="l" id="602"><a class="l" href="#602"> 602 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> <a href="#_fetchValue" id="_fetchValue">fetchValue</a>(<span class="php-var">$feldname</span>)
</span><span class="l" id="603"><a class="l" href="#603"> 603 </a>    {
</span><span class="l" id="604"><a class="l" href="#604"> 604 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$feldname</span>])) {
</span><span class="l" id="605"><a class="l" href="#605"> 605 </a>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;values[<span class="php-var">$feldname</span>];
</span><span class="l" id="606"><a class="l" href="#606"> 606 </a>        }
</span><span class="l" id="607"><a class="l" href="#607"> 607 </a>
</span><span class="l" id="608"><a class="l" href="#608"> 608 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;lastRow)) {
</span><span class="l" id="609"><a class="l" href="#609"> 609 </a>            <span class="php-comment">// no row fetched, but also no query was executed before</span>
</span><span class="l" id="610"><a class="l" href="#610"> 610 </a>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;stmt == <span class="php-keyword1">null</span>) {
</span><span class="l" id="611"><a class="l" href="#611"> 611 </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="612"><a class="l" href="#612"> 612 </a>            }
</span><span class="l" id="613"><a class="l" href="#613"> 613 </a>            <span class="php-var">$this</span>-&gt;lastRow = <span class="php-var">$this</span>-&gt;stmt-&gt;fetch(PDO::FETCH_ASSOC);
</span><span class="l" id="614"><a class="l" href="#614"> 614 </a>        }
</span><span class="l" id="615"><a class="l" href="#615"> 615 </a>
</span><span class="l" id="616"><a class="l" href="#616"> 616 </a>        <span class="php-comment">// isset() alone doesn't work here, because values may also be null</span>
</span><span class="l" id="617"><a class="l" href="#617"> 617 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$this</span>-&gt;lastRow) &amp;&amp; (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;lastRow[<span class="php-var">$feldname</span>]) || <span class="php-keyword2">array_key_exists</span>(<span class="php-var">$feldname</span>, <span class="php-var">$this</span>-&gt;lastRow))) {
</span><span class="l" id="618"><a class="l" href="#618"> 618 </a>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;lastRow[<span class="php-var">$feldname</span>];
</span><span class="l" id="619"><a class="l" href="#619"> 619 </a>        }
</span><span class="l" id="620"><a class="l" href="#620"> 620 </a>        <span class="php-keyword2">trigger_error</span>(<span class="php-quote">'Field "'</span> . <span class="php-var">$feldname</span> . <span class="php-quote">'" does not exist in result!'</span>, E_USER_WARNING);
</span><span class="l" id="621"><a class="l" href="#621"> 621 </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="622"><a class="l" href="#622"> 622 </a>    }
</span><span class="l" id="623"><a class="l" href="#623"> 623 </a>
</span><span class="l" id="624"><a class="l" href="#624"> 624 </a>    <span class="php-comment">/**
</span></span><span class="l" id="625"><a class="l" href="#625"> 625 </a><span class="php-comment">     * Gibt den Wert der aktuellen Zeile im ResultSet zurueck
</span></span><span class="l" id="626"><a class="l" href="#626"> 626 </a><span class="php-comment">     * Falls es noch keine erste Zeile (lastRow) gibt, wird der Satzzeiger
</span></span><span class="l" id="627"><a class="l" href="#627"> 627 </a><span class="php-comment">     * initialisiert. Weitere Satzwechsel mittels next().
</span></span><span class="l" id="628"><a class="l" href="#628"> 628 </a><span class="php-comment">     */</span>
</span><span class="l" id="629"><a class="l" href="#629"> 629 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getRow" id="_getRow">getRow</a>(<span class="php-var">$fetch_type</span> = PDO::FETCH_ASSOC)
</span><span class="l" id="630"><a class="l" href="#630"> 630 </a>    {
</span><span class="l" id="631"><a class="l" href="#631"> 631 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;lastRow) {
</span><span class="l" id="632"><a class="l" href="#632"> 632 </a>            <span class="php-var">$this</span>-&gt;lastRow = <span class="php-var">$this</span>-&gt;stmt-&gt;fetch(<span class="php-var">$fetch_type</span>);
</span><span class="l" id="633"><a class="l" href="#633"> 633 </a>        }
</span><span class="l" id="634"><a class="l" href="#634"> 634 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;lastRow;
</span><span class="l" id="635"><a class="l" href="#635"> 635 </a>    }
</span><span class="l" id="636"><a class="l" href="#636"> 636 </a>
</span><span class="l" id="637"><a class="l" href="#637"> 637 </a>    <span class="php-comment">/**
</span></span><span class="l" id="638"><a class="l" href="#638"> 638 </a><span class="php-comment">     * Prueft, ob eine Spalte im Resultset vorhanden ist.
</span></span><span class="l" id="639"><a class="l" href="#639"> 639 </a><span class="php-comment">     *
</span></span><span class="l" id="640"><a class="l" href="#640"> 640 </a><span class="php-comment">     * @param string $feldname Name der Spalte
</span></span><span class="l" id="641"><a class="l" href="#641"> 641 </a><span class="php-comment">     *
</span></span><span class="l" id="642"><a class="l" href="#642"> 642 </a><span class="php-comment">     * @return bool
</span></span><span class="l" id="643"><a class="l" href="#643"> 643 </a><span class="php-comment">     */</span>
</span><span class="l" id="644"><a class="l" href="#644"> 644 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_hasValue" id="_hasValue">hasValue</a>(<span class="php-var">$feldname</span>)
</span><span class="l" id="645"><a class="l" href="#645"> 645 </a>    {
</span><span class="l" id="646"><a class="l" href="#646"> 646 </a>        <span class="php-comment">// fast fail,... value already set manually?</span>
</span><span class="l" id="647"><a class="l" href="#647"> 647 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;values[<span class="php-var">$feldname</span>])) {
</span><span class="l" id="648"><a class="l" href="#648"> 648 </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="649"><a class="l" href="#649"> 649 </a>        }
</span><span class="l" id="650"><a class="l" href="#650"> 650 </a>
</span><span class="l" id="651"><a class="l" href="#651"> 651 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$feldname</span>, <span class="php-quote">'.'</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="652"><a class="l" href="#652"> 652 </a>            <span class="php-var">$parts</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'.'</span>, <span class="php-var">$feldname</span>);
</span><span class="l" id="653"><a class="l" href="#653"> 653 </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">in_array</span>(<span class="php-var">$parts</span>[<span class="php-num">0</span>], <span class="php-var">$this</span>-&gt;getTablenames()) &amp;&amp; <span class="php-keyword2">in_array</span>(<span class="php-var">$parts</span>[<span class="php-num">1</span>], <span class="php-var">$this</span>-&gt;getFieldnames());
</span><span class="l" id="654"><a class="l" href="#654"> 654 </a>        }
</span><span class="l" id="655"><a class="l" href="#655"> 655 </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">in_array</span>(<span class="php-var">$feldname</span>, <span class="php-var">$this</span>-&gt;getFieldnames());
</span><span class="l" id="656"><a class="l" href="#656"> 656 </a>    }
</span><span class="l" id="657"><a class="l" href="#657"> 657 </a>
</span><span class="l" id="658"><a class="l" href="#658"> 658 </a>    <span class="php-comment">/**
</span></span><span class="l" id="659"><a class="l" href="#659"> 659 </a><span class="php-comment">     * Prueft, ob das Feld mit dem Namen $feldname Null ist.
</span></span><span class="l" id="660"><a class="l" href="#660"> 660 </a><span class="php-comment">     *
</span></span><span class="l" id="661"><a class="l" href="#661"> 661 </a><span class="php-comment">     * Falls das Feld nicht vorhanden ist,
</span></span><span class="l" id="662"><a class="l" href="#662"> 662 </a><span class="php-comment">     * wird Null zurueckgegeben, sonst True/False
</span></span><span class="l" id="663"><a class="l" href="#663"> 663 </a><span class="php-comment">     */</span>
</span><span class="l" id="664"><a class="l" href="#664"> 664 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_isNull" id="_isNull">isNull</a>(<span class="php-var">$feldname</span>)
</span><span class="l" id="665"><a class="l" href="#665"> 665 </a>    {
</span><span class="l" id="666"><a class="l" href="#666"> 666 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;hasValue(<span class="php-var">$feldname</span>)) {
</span><span class="l" id="667"><a class="l" href="#667"> 667 </a>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getValue(<span class="php-var">$feldname</span>) === <span class="php-keyword1">null</span>;
</span><span class="l" id="668"><a class="l" href="#668"> 668 </a>        }
</span><span class="l" id="669"><a class="l" href="#669"> 669 </a>
</span><span class="l" id="670"><a class="l" href="#670"> 670 </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="671"><a class="l" href="#671"> 671 </a>    }
</span><span class="l" id="672"><a class="l" href="#672"> 672 </a>
</span><span class="l" id="673"><a class="l" href="#673"> 673 </a>    <span class="php-comment">/**
</span></span><span class="l" id="674"><a class="l" href="#674"> 674 </a><span class="php-comment">     * Gibt die Anzahl der Zeilen zurueck.
</span></span><span class="l" id="675"><a class="l" href="#675"> 675 </a><span class="php-comment">     */</span>
</span><span class="l" id="676"><a class="l" href="#676"> 676 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getRows" id="_getRows">getRows</a>()
</span><span class="l" id="677"><a class="l" href="#677"> 677 </a>    {
</span><span class="l" id="678"><a class="l" href="#678"> 678 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;rows;
</span><span class="l" id="679"><a class="l" href="#679"> 679 </a>    }
</span><span class="l" id="680"><a class="l" href="#680"> 680 </a>
</span><span class="l" id="681"><a class="l" href="#681"> 681 </a>    <span class="php-comment">/**
</span></span><span class="l" id="682"><a class="l" href="#682"> 682 </a><span class="php-comment">     * Gibt die Anzahl der Felder/Spalten zurueck.
</span></span><span class="l" id="683"><a class="l" href="#683"> 683 </a><span class="php-comment">     */</span>
</span><span class="l" id="684"><a class="l" href="#684"> 684 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getFields" id="_getFields">getFields</a>()
</span><span class="l" id="685"><a class="l" href="#685"> 685 </a>    {
</span><span class="l" id="686"><a class="l" href="#686"> 686 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;columnCount() : <span class="php-num">0</span>;
</span><span class="l" id="687"><a class="l" href="#687"> 687 </a>    }
</span><span class="l" id="688"><a class="l" href="#688"> 688 </a>
</span><span class="l" id="689"><a class="l" href="#689"> 689 </a>    <span class="php-comment">/**
</span></span><span class="l" id="690"><a class="l" href="#690"> 690 </a><span class="php-comment">     * Baut den SET bestandteil mit der
</span></span><span class="l" id="691"><a class="l" href="#691"> 691 </a><span class="php-comment">     * verfuegbaren values zusammen und gibt diesen zurueck.
</span></span><span class="l" id="692"><a class="l" href="#692"> 692 </a><span class="php-comment">     *
</span></span><span class="l" id="693"><a class="l" href="#693"> 693 </a><span class="php-comment">     * @see setValue
</span></span><span class="l" id="694"><a class="l" href="#694"> 694 </a><span class="php-comment">     */</span>
</span><span class="l" id="695"><a class="l" href="#695"> 695 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> <a href="#_buildPreparedValues" id="_buildPreparedValues">buildPreparedValues</a>()
</span><span class="l" id="696"><a class="l" href="#696"> 696 </a>    {
</span><span class="l" id="697"><a class="l" href="#697"> 697 </a>        <span class="php-var">$qry</span> = <span class="php-quote">''</span>;
</span><span class="l" id="698"><a class="l" href="#698"> 698 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$this</span>-&gt;values)) {
</span><span class="l" id="699"><a class="l" href="#699"> 699 </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;values <span class="php-keyword1">as</span> <span class="php-var">$fld_name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="700"><a class="l" href="#700"> 700 </a>                <span class="php-keyword1">if</span> (<span class="php-var">$qry</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="701"><a class="l" href="#701"> 701 </a>                    <span class="php-var">$qry</span> .= <span class="php-quote">', '</span>;
</span><span class="l" id="702"><a class="l" href="#702"> 702 </a>                }
</span><span class="l" id="703"><a class="l" href="#703"> 703 </a>
</span><span class="l" id="704"><a class="l" href="#704"> 704 </a>                <span class="php-var">$qry</span> .= <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$fld_name</span>) .<span class="php-quote">' = :'</span> . <span class="php-var">$fld_name</span>;
</span><span class="l" id="705"><a class="l" href="#705"> 705 </a>            }
</span><span class="l" id="706"><a class="l" href="#706"> 706 </a>        }
</span><span class="l" id="707"><a class="l" href="#707"> 707 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$this</span>-&gt;rawValues)) {
</span><span class="l" id="708"><a class="l" href="#708"> 708 </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;rawValues <span class="php-keyword1">as</span> <span class="php-var">$fld_name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="709"><a class="l" href="#709"> 709 </a>                <span class="php-keyword1">if</span> (<span class="php-var">$qry</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="710"><a class="l" href="#710"> 710 </a>                    <span class="php-var">$qry</span> .= <span class="php-quote">', '</span>;
</span><span class="l" id="711"><a class="l" href="#711"> 711 </a>                }
</span><span class="l" id="712"><a class="l" href="#712"> 712 </a>
</span><span class="l" id="713"><a class="l" href="#713"> 713 </a>                <span class="php-var">$qry</span> .= <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$fld_name</span>) . <span class="php-quote">' = '</span> . <span class="php-var">$value</span>;
</span><span class="l" id="714"><a class="l" href="#714"> 714 </a>            }
</span><span class="l" id="715"><a class="l" href="#715"> 715 </a>        }
</span><span class="l" id="716"><a class="l" href="#716"> 716 </a>
</span><span class="l" id="717"><a class="l" href="#717"> 717 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">trim</span>(<span class="php-var">$qry</span>) == <span class="php-quote">''</span>) {
</span><span class="l" id="718"><a class="l" href="#718"> 718 </a>            <span class="php-comment">// FIXME</span>
</span><span class="l" id="719"><a class="l" href="#719"> 719 </a>            <span class="php-keyword2">trigger_error</span>(<span class="php-quote">'no values given to buildPreparedValues for update(), insert() or replace()'</span>, E_USER_WARNING);
</span><span class="l" id="720"><a class="l" href="#720"> 720 </a>        }
</span><span class="l" id="721"><a class="l" href="#721"> 721 </a>
</span><span class="l" id="722"><a class="l" href="#722"> 722 </a>        <span class="php-keyword1">return</span> <span class="php-var">$qry</span>;
</span><span class="l" id="723"><a class="l" href="#723"> 723 </a>    }
</span><span class="l" id="724"><a class="l" href="#724"> 724 </a>
</span><span class="l" id="725"><a class="l" href="#725"> 725 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getWhere" id="_getWhere">getWhere</a>()
</span><span class="l" id="726"><a class="l" href="#726"> 726 </a>    {
</span><span class="l" id="727"><a class="l" href="#727"> 727 </a>        <span class="php-comment">// we have an custom where criteria, so we don't need to build one automatically</span>
</span><span class="l" id="728"><a class="l" href="#728"> 728 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;wherevar != <span class="php-quote">''</span>) {
</span><span class="l" id="729"><a class="l" href="#729"> 729 </a>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;wherevar;
</span><span class="l" id="730"><a class="l" href="#730"> 730 </a>        }
</span><span class="l" id="731"><a class="l" href="#731"> 731 </a>
</span><span class="l" id="732"><a class="l" href="#732"> 732 </a>        <span class="php-keyword1">return</span> <span class="php-quote">''</span>;
</span><span class="l" id="733"><a class="l" href="#733"> 733 </a>    }
</span><span class="l" id="734"><a class="l" href="#734"> 734 </a>
</span><span class="l" id="735"><a class="l" href="#735"> 735 </a>    <span class="php-comment">/**
</span></span><span class="l" id="736"><a class="l" href="#736"> 736 </a><span class="php-comment">     * Setzt eine Select-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="737"><a class="l" href="#737"> 737 </a><span class="php-comment">     * mit den WHERE Parametern ab.
</span></span><span class="l" id="738"><a class="l" href="#738"> 738 </a><span class="php-comment">     *
</span></span><span class="l" id="739"><a class="l" href="#739"> 739 </a><span class="php-comment">     * @param string $fields
</span></span><span class="l" id="740"><a class="l" href="#740"> 740 </a><span class="php-comment">     *
</span></span><span class="l" id="741"><a class="l" href="#741"> 741 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="742"><a class="l" href="#742"> 742 </a><span class="php-comment">     *
</span></span><span class="l" id="743"><a class="l" href="#743"> 743 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="744"><a class="l" href="#744"> 744 </a><span class="php-comment">     */</span>
</span><span class="l" id="745"><a class="l" href="#745"> 745 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_select" id="_select">select</a>(<span class="php-var">$fields</span> = <span class="php-quote">'*'</span>)
</span><span class="l" id="746"><a class="l" href="#746"> 746 </a>    {
</span><span class="l" id="747"><a class="l" href="#747"> 747 </a>        <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="748"><a class="l" href="#748"> 748 </a>            <span class="php-quote">'SELECT '</span> . <span class="php-var">$fields</span> . <span class="php-quote">' FROM '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="749"><a class="l" href="#749"> 749 </a>            <span class="php-var">$this</span>-&gt;whereParams
</span><span class="l" id="750"><a class="l" href="#750"> 750 </a>        );
</span><span class="l" id="751"><a class="l" href="#751"> 751 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="752"><a class="l" href="#752"> 752 </a>    }
</span><span class="l" id="753"><a class="l" href="#753"> 753 </a>
</span><span class="l" id="754"><a class="l" href="#754"> 754 </a>    <span class="php-comment">/**
</span></span><span class="l" id="755"><a class="l" href="#755"> 755 </a><span class="php-comment">     * Setzt eine Update-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="756"><a class="l" href="#756"> 756 </a><span class="php-comment">     * mit den angegebenen Werten und WHERE Parametern ab.
</span></span><span class="l" id="757"><a class="l" href="#757"> 757 </a><span class="php-comment">     *
</span></span><span class="l" id="758"><a class="l" href="#758"> 758 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="759"><a class="l" href="#759"> 759 </a><span class="php-comment">     *
</span></span><span class="l" id="760"><a class="l" href="#760"> 760 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="761"><a class="l" href="#761"> 761 </a><span class="php-comment">     */</span>
</span><span class="l" id="762"><a class="l" href="#762"> 762 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_update" id="_update">update</a>()
</span><span class="l" id="763"><a class="l" href="#763"> 763 </a>    {
</span><span class="l" id="764"><a class="l" href="#764"> 764 </a>        <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="765"><a class="l" href="#765"> 765 </a>            <span class="php-quote">'UPDATE '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' SET '</span> . <span class="php-var">$this</span>-&gt;buildPreparedValues() . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="766"><a class="l" href="#766"> 766 </a>            <span class="php-keyword2">array_merge</span>(<span class="php-var">$this</span>-&gt;values, <span class="php-var">$this</span>-&gt;whereParams)
</span><span class="l" id="767"><a class="l" href="#767"> 767 </a>        );
</span><span class="l" id="768"><a class="l" href="#768"> 768 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="769"><a class="l" href="#769"> 769 </a>    }
</span><span class="l" id="770"><a class="l" href="#770"> 770 </a>
</span><span class="l" id="771"><a class="l" href="#771"> 771 </a>    <span class="php-comment">/**
</span></span><span class="l" id="772"><a class="l" href="#772"> 772 </a><span class="php-comment">     * Setzt eine Insert-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="773"><a class="l" href="#773"> 773 </a><span class="php-comment">     * mit den angegebenen Werten ab.
</span></span><span class="l" id="774"><a class="l" href="#774"> 774 </a><span class="php-comment">     *
</span></span><span class="l" id="775"><a class="l" href="#775"> 775 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="776"><a class="l" href="#776"> 776 </a><span class="php-comment">     *
</span></span><span class="l" id="777"><a class="l" href="#777"> 777 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="778"><a class="l" href="#778"> 778 </a><span class="php-comment">     */</span>
</span><span class="l" id="779"><a class="l" href="#779"> 779 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_insert" id="_insert">insert</a>()
</span><span class="l" id="780"><a class="l" href="#780"> 780 </a>    {
</span><span class="l" id="781"><a class="l" href="#781"> 781 </a>        <span class="php-comment">// hold a copies of the query fields for later debug out (the class property will be reverted in setQuery())</span>
</span><span class="l" id="782"><a class="l" href="#782"> 782 </a>        <span class="php-var">$tableName</span> = <span class="php-var">$this</span>-&gt;table;
</span><span class="l" id="783"><a class="l" href="#783"> 783 </a>        <span class="php-var">$values</span> = <span class="php-var">$this</span>-&gt;values;
</span><span class="l" id="784"><a class="l" href="#784"> 784 </a>
</span><span class="l" id="785"><a class="l" href="#785"> 785 </a>        <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="786"><a class="l" href="#786"> 786 </a>            <span class="php-quote">'INSERT INTO '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' SET '</span> . <span class="php-var">$this</span>-&gt;buildPreparedValues(),
</span><span class="l" id="787"><a class="l" href="#787"> 787 </a>            <span class="php-var">$this</span>-&gt;values
</span><span class="l" id="788"><a class="l" href="#788"> 788 </a>        );
</span><span class="l" id="789"><a class="l" href="#789"> 789 </a>
</span><span class="l" id="790"><a class="l" href="#790"> 790 </a>        <span class="php-comment">// provide debug infos, if insert is considered successfull, but no rows were inserted.</span>
</span><span class="l" id="791"><a class="l" href="#791"> 791 </a>        <span class="php-comment">// this happens when you violate against a NOTNULL constraint</span>
</span><span class="l" id="792"><a class="l" href="#792"> 792 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;getRows() == <span class="php-num">0</span>) {
</span><span class="l" id="793"><a class="l" href="#793"> 793 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Error while inserting into table "'</span> . <span class="php-var">$tableName</span> . <span class="php-quote">'" with values '</span> . <span class="php-keyword2">print_r</span>(<span class="php-var">$values</span>, <span class="php-keyword1">true</span>) . <span class="php-quote">'! Check your null/not-null constraints!'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="794"><a class="l" href="#794"> 794 </a>        }
</span><span class="l" id="795"><a class="l" href="#795"> 795 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="796"><a class="l" href="#796"> 796 </a>    }
</span><span class="l" id="797"><a class="l" href="#797"> 797 </a>
</span><span class="l" id="798"><a class="l" href="#798"> 798 </a>    <span class="php-comment">/**
</span></span><span class="l" id="799"><a class="l" href="#799"> 799 </a><span class="php-comment">     * Setzt eine Replace-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="800"><a class="l" href="#800"> 800 </a><span class="php-comment">     * mit den angegebenen Werten ab.
</span></span><span class="l" id="801"><a class="l" href="#801"> 801 </a><span class="php-comment">     *
</span></span><span class="l" id="802"><a class="l" href="#802"> 802 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="803"><a class="l" href="#803"> 803 </a><span class="php-comment">     *
</span></span><span class="l" id="804"><a class="l" href="#804"> 804 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="805"><a class="l" href="#805"> 805 </a><span class="php-comment">     */</span>
</span><span class="l" id="806"><a class="l" href="#806"> 806 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_replace" id="_replace">replace</a>()
</span><span class="l" id="807"><a class="l" href="#807"> 807 </a>    {
</span><span class="l" id="808"><a class="l" href="#808"> 808 </a>        <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="809"><a class="l" href="#809"> 809 </a>            <span class="php-quote">'REPLACE INTO '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' SET '</span> . <span class="php-var">$this</span>-&gt;buildPreparedValues() . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="810"><a class="l" href="#810"> 810 </a>            <span class="php-keyword2">array_merge</span>(<span class="php-var">$this</span>-&gt;values, <span class="php-var">$this</span>-&gt;whereParams)
</span><span class="l" id="811"><a class="l" href="#811"> 811 </a>        );
</span><span class="l" id="812"><a class="l" href="#812"> 812 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="813"><a class="l" href="#813"> 813 </a>    }
</span><span class="l" id="814"><a class="l" href="#814"> 814 </a>
</span><span class="l" id="815"><a class="l" href="#815"> 815 </a>    <span class="php-comment">/**
</span></span><span class="l" id="816"><a class="l" href="#816"> 816 </a><span class="php-comment">     * Setzt eine Delete-Anweisung auf die angegebene Tabelle
</span></span><span class="l" id="817"><a class="l" href="#817"> 817 </a><span class="php-comment">     * mit den angegebenen WHERE Parametern ab.
</span></span><span class="l" id="818"><a class="l" href="#818"> 818 </a><span class="php-comment">     *
</span></span><span class="l" id="819"><a class="l" href="#819"> 819 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="820"><a class="l" href="#820"> 820 </a><span class="php-comment">     *
</span></span><span class="l" id="821"><a class="l" href="#821"> 821 </a><span class="php-comment">     * @throws rex_sql_exception
</span></span><span class="l" id="822"><a class="l" href="#822"> 822 </a><span class="php-comment">     */</span>
</span><span class="l" id="823"><a class="l" href="#823"> 823 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">delete</span>()
</span><span class="l" id="824"><a class="l" href="#824"> 824 </a>    {
</span><span class="l" id="825"><a class="l" href="#825"> 825 </a>        <span class="php-var">$this</span>-&gt;setQuery(
</span><span class="l" id="826"><a class="l" href="#826"> 826 </a>            <span class="php-quote">'DELETE FROM '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' '</span> . <span class="php-var">$this</span>-&gt;getWhere(),
</span><span class="l" id="827"><a class="l" href="#827"> 827 </a>            <span class="php-var">$this</span>-&gt;whereParams
</span><span class="l" id="828"><a class="l" href="#828"> 828 </a>        );
</span><span class="l" id="829"><a class="l" href="#829"> 829 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="830"><a class="l" href="#830"> 830 </a>    }
</span><span class="l" id="831"><a class="l" href="#831"> 831 </a>
</span><span class="l" id="832"><a class="l" href="#832"> 832 </a>    <span class="php-comment">/**
</span></span><span class="l" id="833"><a class="l" href="#833"> 833 </a><span class="php-comment">     * Stellt alle Werte auf den Ursprungszustand zurueck.
</span></span><span class="l" id="834"><a class="l" href="#834"> 834 </a><span class="php-comment">     *
</span></span><span class="l" id="835"><a class="l" href="#835"> 835 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="836"><a class="l" href="#836"> 836 </a><span class="php-comment">     */</span>
</span><span class="l" id="837"><a class="l" href="#837"> 837 </a>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> <span class="php-keyword2">flush</span>()
</span><span class="l" id="838"><a class="l" href="#838"> 838 </a>    {
</span><span class="l" id="839"><a class="l" href="#839"> 839 </a>        <span class="php-var">$this</span>-&gt;values = [];
</span><span class="l" id="840"><a class="l" href="#840"> 840 </a>        <span class="php-var">$this</span>-&gt;rawValues = [];
</span><span class="l" id="841"><a class="l" href="#841"> 841 </a>        <span class="php-var">$this</span>-&gt;whereParams = [];
</span><span class="l" id="842"><a class="l" href="#842"> 842 </a>        <span class="php-var">$this</span>-&gt;lastRow = [];
</span><span class="l" id="843"><a class="l" href="#843"> 843 </a>        <span class="php-var">$this</span>-&gt;fieldnames = <span class="php-keyword1">null</span>;
</span><span class="l" id="844"><a class="l" href="#844"> 844 </a>        <span class="php-var">$this</span>-&gt;rawFieldnames = <span class="php-keyword1">null</span>;
</span><span class="l" id="845"><a class="l" href="#845"> 845 </a>        <span class="php-var">$this</span>-&gt;tablenames = <span class="php-keyword1">null</span>;
</span><span class="l" id="846"><a class="l" href="#846"> 846 </a>
</span><span class="l" id="847"><a class="l" href="#847"> 847 </a>        <span class="php-var">$this</span>-&gt;table = <span class="php-quote">''</span>;
</span><span class="l" id="848"><a class="l" href="#848"> 848 </a>        <span class="php-var">$this</span>-&gt;wherevar = <span class="php-quote">''</span>;
</span><span class="l" id="849"><a class="l" href="#849"> 849 </a>        <span class="php-var">$this</span>-&gt;counter = <span class="php-num">0</span>;
</span><span class="l" id="850"><a class="l" href="#850"> 850 </a>        <span class="php-var">$this</span>-&gt;rows = <span class="php-num">0</span>;
</span><span class="l" id="851"><a class="l" href="#851"> 851 </a>
</span><span class="l" id="852"><a class="l" href="#852"> 852 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="853"><a class="l" href="#853"> 853 </a>    }
</span><span class="l" id="854"><a class="l" href="#854"> 854 </a>
</span><span class="l" id="855"><a class="l" href="#855"> 855 </a>    <span class="php-comment">/**
</span></span><span class="l" id="856"><a class="l" href="#856"> 856 </a><span class="php-comment">     * Stellt alle Values, die mit setValue() gesetzt wurden, zurueck.
</span></span><span class="l" id="857"><a class="l" href="#857"> 857 </a><span class="php-comment">     *
</span></span><span class="l" id="858"><a class="l" href="#858"> 858 </a><span class="php-comment">     * @see setValue(), #getValue()
</span></span><span class="l" id="859"><a class="l" href="#859"> 859 </a><span class="php-comment">     *
</span></span><span class="l" id="860"><a class="l" href="#860"> 860 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="861"><a class="l" href="#861"> 861 </a><span class="php-comment">     */</span>
</span><span class="l" id="862"><a class="l" href="#862"> 862 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_flushValues" id="_flushValues">flushValues</a>()
</span><span class="l" id="863"><a class="l" href="#863"> 863 </a>    {
</span><span class="l" id="864"><a class="l" href="#864"> 864 </a>        <span class="php-var">$this</span>-&gt;values = [];
</span><span class="l" id="865"><a class="l" href="#865"> 865 </a>        <span class="php-var">$this</span>-&gt;rawValues = [];
</span><span class="l" id="866"><a class="l" href="#866"> 866 </a>
</span><span class="l" id="867"><a class="l" href="#867"> 867 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="868"><a class="l" href="#868"> 868 </a>    }
</span><span class="l" id="869"><a class="l" href="#869"> 869 </a>
</span><span class="l" id="870"><a class="l" href="#870"> 870 </a>    <span class="php-comment">/*
</span></span><span class="l" id="871"><a class="l" href="#871"> 871 </a><span class="php-comment">     * Prueft ob das Resultset weitere Datensaetze enthaelt
</span></span><span class="l" id="872"><a class="l" href="#872"> 872 </a><span class="php-comment">     */</span>
</span><span class="l" id="873"><a class="l" href="#873"> 873 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_hasNext" id="_hasNext">hasNext</a>()
</span><span class="l" id="874"><a class="l" href="#874"> 874 </a>    {
</span><span class="l" id="875"><a class="l" href="#875"> 875 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;counter &lt; <span class="php-var">$this</span>-&gt;rows;
</span><span class="l" id="876"><a class="l" href="#876"> 876 </a>    }
</span><span class="l" id="877"><a class="l" href="#877"> 877 </a>
</span><span class="l" id="878"><a class="l" href="#878"> 878 </a>    <span class="php-comment">/**
</span></span><span class="l" id="879"><a class="l" href="#879"> 879 </a><span class="php-comment">     * Setzt den Cursor des Resultsets zurueck zum Anfang.
</span></span><span class="l" id="880"><a class="l" href="#880"> 880 </a><span class="php-comment">     *
</span></span><span class="l" id="881"><a class="l" href="#881"> 881 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="882"><a class="l" href="#882"> 882 </a><span class="php-comment">     */</span>
</span><span class="l" id="883"><a class="l" href="#883"> 883 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">reset</span>()
</span><span class="l" id="884"><a class="l" href="#884"> 884 </a>    {
</span><span class="l" id="885"><a class="l" href="#885"> 885 </a>        <span class="php-comment">// re-execute the statement</span>
</span><span class="l" id="886"><a class="l" href="#886"> 886 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;stmt &amp;&amp; <span class="php-var">$this</span>-&gt;counter != <span class="php-num">0</span>) {
</span><span class="l" id="887"><a class="l" href="#887"> 887 </a>            <span class="php-var">$this</span>-&gt;execute(<span class="php-var">$this</span>-&gt;params);
</span><span class="l" id="888"><a class="l" href="#888"> 888 </a>            <span class="php-var">$this</span>-&gt;counter = <span class="php-num">0</span>;
</span><span class="l" id="889"><a class="l" href="#889"> 889 </a>        }
</span><span class="l" id="890"><a class="l" href="#890"> 890 </a>
</span><span class="l" id="891"><a class="l" href="#891"> 891 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="892"><a class="l" href="#892"> 892 </a>    }
</span><span class="l" id="893"><a class="l" href="#893"> 893 </a>
</span><span class="l" id="894"><a class="l" href="#894"> 894 </a>    <span class="php-comment">/**
</span></span><span class="l" id="895"><a class="l" href="#895"> 895 </a><span class="php-comment">     * Gibt die letzte InsertId zurueck.
</span></span><span class="l" id="896"><a class="l" href="#896"> 896 </a><span class="php-comment">     */</span>
</span><span class="l" id="897"><a class="l" href="#897"> 897 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getLastId" id="_getLastId">getLastId</a>()
</span><span class="l" id="898"><a class="l" href="#898"> 898 </a>    {
</span><span class="l" id="899"><a class="l" href="#899"> 899 </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;lastInsertId();
</span><span class="l" id="900"><a class="l" href="#900"> 900 </a>    }
</span><span class="l" id="901"><a class="l" href="#901"> 901 </a>
</span><span class="l" id="902"><a class="l" href="#902"> 902 </a>    <span class="php-comment">/**
</span></span><span class="l" id="903"><a class="l" href="#903"> 903 </a><span class="php-comment">     * Laedt das komplette Resultset in ein Array und gibt dieses zurueck und
</span></span><span class="l" id="904"><a class="l" href="#904"> 904 </a><span class="php-comment">     * wechselt die DBID falls vorhanden.
</span></span><span class="l" id="905"><a class="l" href="#905"> 905 </a><span class="php-comment">     *
</span></span><span class="l" id="906"><a class="l" href="#906"> 906 </a><span class="php-comment">     * @param string $query     The sql-query
</span></span><span class="l" id="907"><a class="l" href="#907"> 907 </a><span class="php-comment">     * @param array  $params    An optional array of statement parameter
</span></span><span class="l" id="908"><a class="l" href="#908"> 908 </a><span class="php-comment">     * @param int    $fetchType
</span></span><span class="l" id="909"><a class="l" href="#909"> 909 </a><span class="php-comment">     *
</span></span><span class="l" id="910"><a class="l" href="#910"> 910 </a><span class="php-comment">     * @return array
</span></span><span class="l" id="911"><a class="l" href="#911"> 911 </a><span class="php-comment">     *
</span></span><span class="l" id="912"><a class="l" href="#912"> 912 </a><span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="913"><a class="l" href="#913"> 913 </a><span class="php-comment">     */</span>
</span><span class="l" id="914"><a class="l" href="#914"> 914 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getDBArray" id="_getDBArray">getDBArray</a>(<span class="php-var">$query</span> = <span class="php-keyword1">null</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-var">$fetchType</span> = PDO::FETCH_ASSOC)
</span><span class="l" id="915"><a class="l" href="#915"> 915 </a>    {
</span><span class="l" id="916"><a class="l" href="#916"> 916 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$query</span>) {
</span><span class="l" id="917"><a class="l" href="#917"> 917 </a>            <span class="php-var">$query</span> = <span class="php-var">$this</span>-&gt;query;
</span><span class="l" id="918"><a class="l" href="#918"> 918 </a>            <span class="php-var">$params</span> = <span class="php-var">$this</span>-&gt;params;
</span><span class="l" id="919"><a class="l" href="#919"> 919 </a>        }
</span><span class="l" id="920"><a class="l" href="#920"> 920 </a>
</span><span class="l" id="921"><a class="l" href="#921"> 921 </a>        <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="922"><a class="l" href="#922"> 922 </a>
</span><span class="l" id="923"><a class="l" href="#923"> 923 </a>        <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">false</span>);
</span><span class="l" id="924"><a class="l" href="#924"> 924 </a>        <span class="php-var">$this</span>-&gt;setDBQuery(<span class="php-var">$query</span>, <span class="php-var">$params</span>);
</span><span class="l" id="925"><a class="l" href="#925"> 925 </a>        <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">true</span>);
</span><span class="l" id="926"><a class="l" href="#926"> 926 </a>
</span><span class="l" id="927"><a class="l" href="#927"> 927 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt-&gt;fetchAll(<span class="php-var">$fetchType</span>);
</span><span class="l" id="928"><a class="l" href="#928"> 928 </a>    }
</span><span class="l" id="929"><a class="l" href="#929"> 929 </a>
</span><span class="l" id="930"><a class="l" href="#930"> 930 </a>    <span class="php-comment">/**
</span></span><span class="l" id="931"><a class="l" href="#931"> 931 </a><span class="php-comment">     * Laedt das komplette Resultset in ein Array und gibt dieses zurueck.
</span></span><span class="l" id="932"><a class="l" href="#932"> 932 </a><span class="php-comment">     *
</span></span><span class="l" id="933"><a class="l" href="#933"> 933 </a><span class="php-comment">     * @param string $query     The sql-query
</span></span><span class="l" id="934"><a class="l" href="#934"> 934 </a><span class="php-comment">     * @param array  $params    An optional array of statement parameter
</span></span><span class="l" id="935"><a class="l" href="#935"> 935 </a><span class="php-comment">     * @param int    $fetchType
</span></span><span class="l" id="936"><a class="l" href="#936"> 936 </a><span class="php-comment">     *
</span></span><span class="l" id="937"><a class="l" href="#937"> 937 </a><span class="php-comment">     * @return array
</span></span><span class="l" id="938"><a class="l" href="#938"> 938 </a><span class="php-comment">     *
</span></span><span class="l" id="939"><a class="l" href="#939"> 939 </a><span class="php-comment">     * @throws rex_sql_exception on errors
</span></span><span class="l" id="940"><a class="l" href="#940"> 940 </a><span class="php-comment">     */</span>
</span><span class="l" id="941"><a class="l" href="#941"> 941 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getArray" id="_getArray">getArray</a>(<span class="php-var">$query</span> = <span class="php-keyword1">null</span>, <span class="php-keyword1">array</span> <span class="php-var">$params</span> = [], <span class="php-var">$fetchType</span> = PDO::FETCH_ASSOC)
</span><span class="l" id="942"><a class="l" href="#942"> 942 </a>    {
</span><span class="l" id="943"><a class="l" href="#943"> 943 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$query</span>) {
</span><span class="l" id="944"><a class="l" href="#944"> 944 </a>            <span class="php-var">$query</span> = <span class="php-var">$this</span>-&gt;query;
</span><span class="l" id="945"><a class="l" href="#945"> 945 </a>            <span class="php-var">$params</span> = <span class="php-var">$this</span>-&gt;params;
</span><span class="l" id="946"><a class="l" href="#946"> 946 </a>        }
</span><span class="l" id="947"><a class="l" href="#947"> 947 </a>
</span><span class="l" id="948"><a class="l" href="#948"> 948 </a>        <span class="php-var">$pdo</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID];
</span><span class="l" id="949"><a class="l" href="#949"> 949 </a>
</span><span class="l" id="950"><a class="l" href="#950"> 950 </a>        <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">false</span>);
</span><span class="l" id="951"><a class="l" href="#951"> 951 </a>        <span class="php-var">$this</span>-&gt;setQuery(<span class="php-var">$query</span>, <span class="php-var">$params</span>);
</span><span class="l" id="952"><a class="l" href="#952"> 952 </a>        <span class="php-var">$pdo</span>-&gt;setAttribute(PDO::ATTR_FETCH_TABLE_NAMES, <span class="php-keyword1">true</span>);
</span><span class="l" id="953"><a class="l" href="#953"> 953 </a>
</span><span class="l" id="954"><a class="l" href="#954"> 954 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt-&gt;fetchAll(<span class="php-var">$fetchType</span>);
</span><span class="l" id="955"><a class="l" href="#955"> 955 </a>    }
</span><span class="l" id="956"><a class="l" href="#956"> 956 </a>
</span><span class="l" id="957"><a class="l" href="#957"> 957 </a>    <span class="php-comment">/**
</span></span><span class="l" id="958"><a class="l" href="#958"> 958 </a><span class="php-comment">     * Gibt die zuletzt aufgetretene Fehlernummer zurueck.
</span></span><span class="l" id="959"><a class="l" href="#959"> 959 </a><span class="php-comment">     */</span>
</span><span class="l" id="960"><a class="l" href="#960"> 960 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getErrno" id="_getErrno">getErrno</a>()
</span><span class="l" id="961"><a class="l" href="#961"> 961 </a>    {
</span><span class="l" id="962"><a class="l" href="#962"> 962 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;errorCode() : self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;errorCode();
</span><span class="l" id="963"><a class="l" href="#963"> 963 </a>    }
</span><span class="l" id="964"><a class="l" href="#964"> 964 </a>
</span><span class="l" id="965"><a class="l" href="#965"> 965 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getMysqlErrno" id="_getMysqlErrno">getMysqlErrno</a>()
</span><span class="l" id="966"><a class="l" href="#966"> 966 </a>    {
</span><span class="l" id="967"><a class="l" href="#967"> 967 </a>        <span class="php-var">$errorInfos</span> = <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;errorInfo() : self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;errorInfo();
</span><span class="l" id="968"><a class="l" href="#968"> 968 </a>
</span><span class="l" id="969"><a class="l" href="#969"> 969 </a>        <span class="php-keyword1">return</span> (int) <span class="php-var">$errorInfos</span>[<span class="php-num">1</span>];
</span><span class="l" id="970"><a class="l" href="#970"> 970 </a>    }
</span><span class="l" id="971"><a class="l" href="#971"> 971 </a>
</span><span class="l" id="972"><a class="l" href="#972"> 972 </a>    <span class="php-comment">/**
</span></span><span class="l" id="973"><a class="l" href="#973"> 973 </a><span class="php-comment">     * Gibt den zuletzt aufgetretene Fehler zurueck.
</span></span><span class="l" id="974"><a class="l" href="#974"> 974 </a><span class="php-comment">     */</span>
</span><span class="l" id="975"><a class="l" href="#975"> 975 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getError" id="_getError">getError</a>()
</span><span class="l" id="976"><a class="l" href="#976"> 976 </a>    {
</span><span class="l" id="977"><a class="l" href="#977"> 977 </a>        <span class="php-var">$errorInfos</span> = <span class="php-var">$this</span>-&gt;stmt ? <span class="php-var">$this</span>-&gt;stmt-&gt;errorInfo() : self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;errorInfo();
</span><span class="l" id="978"><a class="l" href="#978"> 978 </a>        <span class="php-comment">// idx0   SQLSTATE error code (a five characters alphanumeric identifier defined in the ANSI SQL standard).</span>
</span><span class="l" id="979"><a class="l" href="#979"> 979 </a>        <span class="php-comment">// idx1   Driver-specific error code.</span>
</span><span class="l" id="980"><a class="l" href="#980"> 980 </a>        <span class="php-comment">// idx2   Driver-specific error message.</span>
</span><span class="l" id="981"><a class="l" href="#981"> 981 </a>        <span class="php-keyword1">return</span> <span class="php-var">$errorInfos</span>[<span class="php-num">2</span>];
</span><span class="l" id="982"><a class="l" href="#982"> 982 </a>    }
</span><span class="l" id="983"><a class="l" href="#983"> 983 </a>
</span><span class="l" id="984"><a class="l" href="#984"> 984 </a>    <span class="php-comment">/**
</span></span><span class="l" id="985"><a class="l" href="#985"> 985 </a><span class="php-comment">     * Prueft, ob ein Fehler aufgetreten ist.
</span></span><span class="l" id="986"><a class="l" href="#986"> 986 </a><span class="php-comment">     */</span>
</span><span class="l" id="987"><a class="l" href="#987"> 987 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_hasError" id="_hasError">hasError</a>()
</span><span class="l" id="988"><a class="l" href="#988"> 988 </a>    {
</span><span class="l" id="989"><a class="l" href="#989"> 989 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getErrno() != <span class="php-num">0</span>;
</span><span class="l" id="990"><a class="l" href="#990"> 990 </a>    }
</span><span class="l" id="991"><a class="l" href="#991"> 991 </a>
</span><span class="l" id="992"><a class="l" href="#992"> 992 </a>    <span class="php-comment">/**
</span></span><span class="l" id="993"><a class="l" href="#993"> 993 </a><span class="php-comment">     * Gibt die letzte Fehlermeldung aus.
</span></span><span class="l" id="994"><a class="l" href="#994"> 994 </a><span class="php-comment">     */</span>
</span><span class="l" id="995"><a class="l" href="#995"> 995 </a>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> <a href="#_printError" id="_printError">printError</a>(<span class="php-var">$qry</span>, <span class="php-var">$params</span>)
</span><span class="l" id="996"><a class="l" href="#996"> 996 </a>    {
</span><span class="l" id="997"><a class="l" href="#997"> 997 </a>        <span class="php-var">$errors</span>[<span class="php-quote">'debug'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="998"><a class="l" href="#998"> 998 </a>        <span class="php-var">$errors</span>[<span class="php-quote">'query'</span>] = <span class="php-var">$qry</span>;
</span><span class="l" id="999"><a class="l" href="#999"> 999 </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>)) {
</span><span class="l" id="1000"><a class="l" href="#1000">1000 </a>            <span class="php-var">$errors</span>[<span class="php-quote">'params'</span>] = <span class="php-var">$params</span>;
</span><span class="l" id="1001"><a class="l" href="#1001">1001 </a>        }
</span><span class="l" id="1002"><a class="l" href="#1002">1002 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">strlen</span>(<span class="php-var">$this</span>-&gt;getRows()) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="1003"><a class="l" href="#1003">1003 </a>            <span class="php-var">$errors</span>[<span class="php-quote">'count'</span>] = <span class="php-var">$this</span>-&gt;getRows();
</span><span class="l" id="1004"><a class="l" href="#1004">1004 </a>        }
</span><span class="l" id="1005"><a class="l" href="#1005">1005 </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">strlen</span>(<span class="php-var">$this</span>-&gt;getError()) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="1006"><a class="l" href="#1006">1006 </a>            <span class="php-var">$errors</span>[<span class="php-quote">'error'</span>] = <span class="php-var">$this</span>-&gt;getError();
</span><span class="l" id="1007"><a class="l" href="#1007">1007 </a>            <span class="php-var">$errors</span>[<span class="php-quote">'ecode'</span>] = <span class="php-var">$this</span>-&gt;getErrno();
</span><span class="l" id="1008"><a class="l" href="#1008">1008 </a>        }
</span><span class="l" id="1009"><a class="l" href="#1009">1009 </a>        dump(<span class="php-var">$errors</span>);
</span><span class="l" id="1010"><a class="l" href="#1010">1010 </a>    }
</span><span class="l" id="1011"><a class="l" href="#1011">1011 </a>
</span><span class="l" id="1012"><a class="l" href="#1012">1012 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1013"><a class="l" href="#1013">1013 </a><span class="php-comment">     * Setzt eine Spalte auf den naechst moeglich auto_increment Wert.
</span></span><span class="l" id="1014"><a class="l" href="#1014">1014 </a><span class="php-comment">     *
</span></span><span class="l" id="1015"><a class="l" href="#1015">1015 </a><span class="php-comment">     * @param string $field    Name der Spalte
</span></span><span class="l" id="1016"><a class="l" href="#1016">1016 </a><span class="php-comment">     * @param int    $start_id
</span></span><span class="l" id="1017"><a class="l" href="#1017">1017 </a><span class="php-comment">     *
</span></span><span class="l" id="1018"><a class="l" href="#1018">1018 </a><span class="php-comment">     * @return int
</span></span><span class="l" id="1019"><a class="l" href="#1019">1019 </a><span class="php-comment">     */</span>
</span><span class="l" id="1020"><a class="l" href="#1020">1020 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_setNewId" id="_setNewId">setNewId</a>(<span class="php-var">$field</span>, <span class="php-var">$start_id</span> = <span class="php-num">0</span>)
</span><span class="l" id="1021"><a class="l" href="#1021">1021 </a>    {
</span><span class="l" id="1022"><a class="l" href="#1022">1022 </a>        <span class="php-comment">// setNewId muss neues sql Objekt verwenden, da sonst bestehende informationen im Objekt ueberschrieben werden</span>
</span><span class="l" id="1023"><a class="l" href="#1023">1023 </a>        <span class="php-var">$sql</span> = self::factory();
</span><span class="l" id="1024"><a class="l" href="#1024">1024 </a>        <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SELECT '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$field</span>) . <span class="php-quote">' FROM '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$this</span>-&gt;table) . <span class="php-quote">' ORDER BY '</span> . <span class="php-var">$this</span>-&gt;escapeIdentifier(<span class="php-var">$field</span>) . <span class="php-quote">' DESC LIMIT 1'</span>);
</span><span class="l" id="1025"><a class="l" href="#1025">1025 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$sql</span>-&gt;getRows() == <span class="php-num">0</span>) {
</span><span class="l" id="1026"><a class="l" href="#1026">1026 </a>            <span class="php-var">$id</span> = <span class="php-var">$start_id</span>;
</span><span class="l" id="1027"><a class="l" href="#1027">1027 </a>        } <span class="php-keyword1">else</span> {
</span><span class="l" id="1028"><a class="l" href="#1028">1028 </a>            <span class="php-var">$id</span> = <span class="php-var">$sql</span>-&gt;getValue(<span class="php-var">$field</span>);
</span><span class="l" id="1029"><a class="l" href="#1029">1029 </a>        }
</span><span class="l" id="1030"><a class="l" href="#1030">1030 </a>        ++<span class="php-var">$id</span>;
</span><span class="l" id="1031"><a class="l" href="#1031">1031 </a>        <span class="php-var">$this</span>-&gt;setValue(<span class="php-var">$field</span>, <span class="php-var">$id</span>);
</span><span class="l" id="1032"><a class="l" href="#1032">1032 </a>
</span><span class="l" id="1033"><a class="l" href="#1033">1033 </a>        <span class="php-keyword1">return</span> <span class="php-var">$id</span>;
</span><span class="l" id="1034"><a class="l" href="#1034">1034 </a>    }
</span><span class="l" id="1035"><a class="l" href="#1035">1035 </a>
</span><span class="l" id="1036"><a class="l" href="#1036">1036 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1037"><a class="l" href="#1037">1037 </a><span class="php-comment">     * Gibt die Spaltennamen des ResultSets zurueck.
</span></span><span class="l" id="1038"><a class="l" href="#1038">1038 </a><span class="php-comment">     */</span>
</span><span class="l" id="1039"><a class="l" href="#1039">1039 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getFieldnames" id="_getFieldnames">getFieldnames</a>()
</span><span class="l" id="1040"><a class="l" href="#1040">1040 </a>    {
</span><span class="l" id="1041"><a class="l" href="#1041">1041 </a>        <span class="php-var">$this</span>-&gt;fetchMeta();
</span><span class="l" id="1042"><a class="l" href="#1042">1042 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;fieldnames;
</span><span class="l" id="1043"><a class="l" href="#1043">1043 </a>    }
</span><span class="l" id="1044"><a class="l" href="#1044">1044 </a>
</span><span class="l" id="1045"><a class="l" href="#1045">1045 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_getTablenames" id="_getTablenames">getTablenames</a>()
</span><span class="l" id="1046"><a class="l" href="#1046">1046 </a>    {
</span><span class="l" id="1047"><a class="l" href="#1047">1047 </a>        <span class="php-var">$this</span>-&gt;fetchMeta();
</span><span class="l" id="1048"><a class="l" href="#1048">1048 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;tablenames;
</span><span class="l" id="1049"><a class="l" href="#1049">1049 </a>    }
</span><span class="l" id="1050"><a class="l" href="#1050">1050 </a>
</span><span class="l" id="1051"><a class="l" href="#1051">1051 </a>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> <a href="#_fetchMeta" id="_fetchMeta">fetchMeta</a>()
</span><span class="l" id="1052"><a class="l" href="#1052">1052 </a>    {
</span><span class="l" id="1053"><a class="l" href="#1053">1053 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;fieldnames === <span class="php-keyword1">null</span>) {
</span><span class="l" id="1054"><a class="l" href="#1054">1054 </a>            <span class="php-var">$this</span>-&gt;rawFieldnames = [];
</span><span class="l" id="1055"><a class="l" href="#1055">1055 </a>            <span class="php-var">$this</span>-&gt;fieldnames = [];
</span><span class="l" id="1056"><a class="l" href="#1056">1056 </a>            <span class="php-var">$this</span>-&gt;tablenames = [];
</span><span class="l" id="1057"><a class="l" href="#1057">1057 </a>
</span><span class="l" id="1058"><a class="l" href="#1058">1058 </a>            <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$this</span>-&gt;getFields(); ++<span class="php-var">$i</span>) {
</span><span class="l" id="1059"><a class="l" href="#1059">1059 </a>                <span class="php-var">$metadata</span> = <span class="php-var">$this</span>-&gt;stmt-&gt;getColumnMeta(<span class="php-var">$i</span>);
</span><span class="l" id="1060"><a class="l" href="#1060">1060 </a>
</span><span class="l" id="1061"><a class="l" href="#1061">1061 </a>                <span class="php-comment">// strip table-name from column</span>
</span><span class="l" id="1062"><a class="l" href="#1062">1062 </a>                <span class="php-var">$this</span>-&gt;fieldnames[] = <span class="php-keyword2">substr</span>(<span class="php-var">$metadata</span>[<span class="php-quote">'name'</span>], <span class="php-keyword2">strlen</span>(<span class="php-var">$metadata</span>[<span class="php-quote">'table'</span>] . <span class="php-quote">'.'</span>));
</span><span class="l" id="1063"><a class="l" href="#1063">1063 </a>                <span class="php-var">$this</span>-&gt;rawFieldnames[] = <span class="php-var">$metadata</span>[<span class="php-quote">'name'</span>];
</span><span class="l" id="1064"><a class="l" href="#1064">1064 </a>
</span><span class="l" id="1065"><a class="l" href="#1065">1065 </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$metadata</span>[<span class="php-quote">'table'</span>], <span class="php-var">$this</span>-&gt;tablenames)) {
</span><span class="l" id="1066"><a class="l" href="#1066">1066 </a>                    <span class="php-var">$this</span>-&gt;tablenames[] = <span class="php-var">$metadata</span>[<span class="php-quote">'table'</span>];
</span><span class="l" id="1067"><a class="l" href="#1067">1067 </a>                }
</span><span class="l" id="1068"><a class="l" href="#1068">1068 </a>            }
</span><span class="l" id="1069"><a class="l" href="#1069">1069 </a>        }
</span><span class="l" id="1070"><a class="l" href="#1070">1070 </a>    }
</span><span class="l" id="1071"><a class="l" href="#1071">1071 </a>
</span><span class="l" id="1072"><a class="l" href="#1072">1072 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1073"><a class="l" href="#1073">1073 </a><span class="php-comment">     * Escaped den uebergeben Wert fuer den DB Query.
</span></span><span class="l" id="1074"><a class="l" href="#1074">1074 </a><span class="php-comment">     *
</span></span><span class="l" id="1075"><a class="l" href="#1075">1075 </a><span class="php-comment">     * @param string $value den zu escapenden Wert
</span></span><span class="l" id="1076"><a class="l" href="#1076">1076 </a><span class="php-comment">     *
</span></span><span class="l" id="1077"><a class="l" href="#1077">1077 </a><span class="php-comment">     * @return string
</span></span><span class="l" id="1078"><a class="l" href="#1078">1078 </a><span class="php-comment">     */</span>
</span><span class="l" id="1079"><a class="l" href="#1079">1079 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_escape" id="_escape">escape</a>(<span class="php-var">$value</span>)
</span><span class="l" id="1080"><a class="l" href="#1080">1080 </a>    {
</span><span class="l" id="1081"><a class="l" href="#1081">1081 </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;quote(<span class="php-var">$value</span>);
</span><span class="l" id="1082"><a class="l" href="#1082">1082 </a>    }
</span><span class="l" id="1083"><a class="l" href="#1083">1083 </a>
</span><span class="l" id="1084"><a class="l" href="#1084">1084 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1085"><a class="l" href="#1085">1085 </a><span class="php-comment">     * Escapes and adds backsticks around.
</span></span><span class="l" id="1086"><a class="l" href="#1086">1086 </a><span class="php-comment">     *
</span></span><span class="l" id="1087"><a class="l" href="#1087">1087 </a><span class="php-comment">     * @param string $name
</span></span><span class="l" id="1088"><a class="l" href="#1088">1088 </a><span class="php-comment">     *
</span></span><span class="l" id="1089"><a class="l" href="#1089">1089 </a><span class="php-comment">     * @return string
</span></span><span class="l" id="1090"><a class="l" href="#1090">1090 </a><span class="php-comment">     */</span>
</span><span class="l" id="1091"><a class="l" href="#1091">1091 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_escapeIdentifier" id="_escapeIdentifier">escapeIdentifier</a>(<span class="php-var">$name</span>)
</span><span class="l" id="1092"><a class="l" href="#1092">1092 </a>    {
</span><span class="l" id="1093"><a class="l" href="#1093">1093 </a>        <span class="php-keyword1">return</span> <span class="php-quote">'`'</span> . <span class="php-keyword2">str_replace</span>(<span class="php-quote">'`'</span>, <span class="php-quote">'``'</span>, <span class="php-var">$name</span>) . <span class="php-quote">'`'</span>;
</span><span class="l" id="1094"><a class="l" href="#1094">1094 </a>    }
</span><span class="l" id="1095"><a class="l" href="#1095">1095 </a>
</span><span class="l" id="1096"><a class="l" href="#1096">1096 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1097"><a class="l" href="#1097">1097 </a><span class="php-comment">     * @param string $user the name of the user who created the dataset. Defaults to the current user
</span></span><span class="l" id="1098"><a class="l" href="#1098">1098 </a><span class="php-comment">     *
</span></span><span class="l" id="1099"><a class="l" href="#1099">1099 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="1100"><a class="l" href="#1100">1100 </a><span class="php-comment">     */</span>
</span><span class="l" id="1101"><a class="l" href="#1101">1101 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_addGlobalUpdateFields" id="_addGlobalUpdateFields">addGlobalUpdateFields</a>(<span class="php-var">$user</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="1102"><a class="l" href="#1102">1102 </a>    {
</span><span class="l" id="1103"><a class="l" href="#1103">1103 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$user</span>) {
</span><span class="l" id="1104"><a class="l" href="#1104">1104 </a>            <span class="php-var">$user</span> = rex::getUser()-&gt;getValue(<span class="php-quote">'login'</span>);
</span><span class="l" id="1105"><a class="l" href="#1105">1105 </a>        }
</span><span class="l" id="1106"><a class="l" href="#1106">1106 </a>
</span><span class="l" id="1107"><a class="l" href="#1107">1107 </a>        <span class="php-var">$this</span>-&gt;setDateTimeValue(<span class="php-quote">'updatedate'</span>, <span class="php-keyword2">time</span>());
</span><span class="l" id="1108"><a class="l" href="#1108">1108 </a>        <span class="php-var">$this</span>-&gt;setValue(<span class="php-quote">'updateuser'</span>, <span class="php-var">$user</span>);
</span><span class="l" id="1109"><a class="l" href="#1109">1109 </a>
</span><span class="l" id="1110"><a class="l" href="#1110">1110 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="1111"><a class="l" href="#1111">1111 </a>    }
</span><span class="l" id="1112"><a class="l" href="#1112">1112 </a>
</span><span class="l" id="1113"><a class="l" href="#1113">1113 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1114"><a class="l" href="#1114">1114 </a><span class="php-comment">     * @param string $user the name of the user who updated the dataset. Defaults to the current user
</span></span><span class="l" id="1115"><a class="l" href="#1115">1115 </a><span class="php-comment">     *
</span></span><span class="l" id="1116"><a class="l" href="#1116">1116 </a><span class="php-comment">     * @return $this the current rex_sql object
</span></span><span class="l" id="1117"><a class="l" href="#1117">1117 </a><span class="php-comment">     */</span>
</span><span class="l" id="1118"><a class="l" href="#1118">1118 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_addGlobalCreateFields" id="_addGlobalCreateFields">addGlobalCreateFields</a>(<span class="php-var">$user</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="1119"><a class="l" href="#1119">1119 </a>    {
</span><span class="l" id="1120"><a class="l" href="#1120">1120 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$user</span>) {
</span><span class="l" id="1121"><a class="l" href="#1121">1121 </a>            <span class="php-var">$user</span> = rex::getUser()-&gt;getValue(<span class="php-quote">'login'</span>);
</span><span class="l" id="1122"><a class="l" href="#1122">1122 </a>        }
</span><span class="l" id="1123"><a class="l" href="#1123">1123 </a>
</span><span class="l" id="1124"><a class="l" href="#1124">1124 </a>        <span class="php-var">$this</span>-&gt;setDateTimeValue(<span class="php-quote">'createdate'</span>, <span class="php-keyword2">time</span>());
</span><span class="l" id="1125"><a class="l" href="#1125">1125 </a>        <span class="php-var">$this</span>-&gt;setValue(<span class="php-quote">'createuser'</span>, <span class="php-var">$user</span>);
</span><span class="l" id="1126"><a class="l" href="#1126">1126 </a>
</span><span class="l" id="1127"><a class="l" href="#1127">1127 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="1128"><a class="l" href="#1128">1128 </a>    }
</span><span class="l" id="1129"><a class="l" href="#1129">1129 </a>
</span><span class="l" id="1130"><a class="l" href="#1130">1130 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1131"><a class="l" href="#1131">1131 </a><span class="php-comment">     * Starts a database transaction.
</span></span><span class="l" id="1132"><a class="l" href="#1132">1132 </a><span class="php-comment">     *
</span></span><span class="l" id="1133"><a class="l" href="#1133">1133 </a><span class="php-comment">     * @throws rex_sql_exception when a transaction is already running
</span></span><span class="l" id="1134"><a class="l" href="#1134">1134 </a><span class="php-comment">     *
</span></span><span class="l" id="1135"><a class="l" href="#1135">1135 </a><span class="php-comment">     * @return bool Indicating whether the transaction was successfully started
</span></span><span class="l" id="1136"><a class="l" href="#1136">1136 </a><span class="php-comment">     */</span>
</span><span class="l" id="1137"><a class="l" href="#1137">1137 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_beginTransaction" id="_beginTransaction">beginTransaction</a>()
</span><span class="l" id="1138"><a class="l" href="#1138">1138 </a>    {
</span><span class="l" id="1139"><a class="l" href="#1139">1139 </a>        <span class="php-keyword1">if</span> (self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction()) {
</span><span class="l" id="1140"><a class="l" href="#1140">1140 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Transaction already started'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="1141"><a class="l" href="#1141">1141 </a>        }
</span><span class="l" id="1142"><a class="l" href="#1142">1142 </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;beginTransaction();
</span><span class="l" id="1143"><a class="l" href="#1143">1143 </a>    }
</span><span class="l" id="1144"><a class="l" href="#1144">1144 </a>
</span><span class="l" id="1145"><a class="l" href="#1145">1145 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1146"><a class="l" href="#1146">1146 </a><span class="php-comment">     * Rollback a already started database transaction.
</span></span><span class="l" id="1147"><a class="l" href="#1147">1147 </a><span class="php-comment">     *
</span></span><span class="l" id="1148"><a class="l" href="#1148">1148 </a><span class="php-comment">     * @throws rex_sql_exception when no transaction was started beforehand
</span></span><span class="l" id="1149"><a class="l" href="#1149">1149 </a><span class="php-comment">     *
</span></span><span class="l" id="1150"><a class="l" href="#1150">1150 </a><span class="php-comment">     * @return bool Indicating whether the transaction was successfully rollbacked
</span></span><span class="l" id="1151"><a class="l" href="#1151">1151 </a><span class="php-comment">     */</span>
</span><span class="l" id="1152"><a class="l" href="#1152">1152 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_rollBack" id="_rollBack">rollBack</a>()
</span><span class="l" id="1153"><a class="l" href="#1153">1153 </a>    {
</span><span class="l" id="1154"><a class="l" href="#1154">1154 </a>        <span class="php-keyword1">if</span> (!self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction()) {
</span><span class="l" id="1155"><a class="l" href="#1155">1155 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Unable to rollback, no transaction started before'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="1156"><a class="l" href="#1156">1156 </a>        }
</span><span class="l" id="1157"><a class="l" href="#1157">1157 </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;rollBack();
</span><span class="l" id="1158"><a class="l" href="#1158">1158 </a>    }
</span><span class="l" id="1159"><a class="l" href="#1159">1159 </a>
</span><span class="l" id="1160"><a class="l" href="#1160">1160 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1161"><a class="l" href="#1161">1161 </a><span class="php-comment">     * Commit a already started database transaction.
</span></span><span class="l" id="1162"><a class="l" href="#1162">1162 </a><span class="php-comment">     *
</span></span><span class="l" id="1163"><a class="l" href="#1163">1163 </a><span class="php-comment">     * @throws rex_sql_exception when no transaction was started beforehand
</span></span><span class="l" id="1164"><a class="l" href="#1164">1164 </a><span class="php-comment">     *
</span></span><span class="l" id="1165"><a class="l" href="#1165">1165 </a><span class="php-comment">     * @return bool Indicating whether the transaction was successfully committed
</span></span><span class="l" id="1166"><a class="l" href="#1166">1166 </a><span class="php-comment">     */</span>
</span><span class="l" id="1167"><a class="l" href="#1167">1167 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_commit" id="_commit">commit</a>()
</span><span class="l" id="1168"><a class="l" href="#1168">1168 </a>    {
</span><span class="l" id="1169"><a class="l" href="#1169">1169 </a>        <span class="php-keyword1">if</span> (!self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction()) {
</span><span class="l" id="1170"><a class="l" href="#1170">1170 </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_sql_exception(<span class="php-quote">'Unable to commit, no transaction started before'</span>, <span class="php-keyword1">null</span>, <span class="php-var">$this</span>);
</span><span class="l" id="1171"><a class="l" href="#1171">1171 </a>        }
</span><span class="l" id="1172"><a class="l" href="#1172">1172 </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;commit();
</span><span class="l" id="1173"><a class="l" href="#1173">1173 </a>    }
</span><span class="l" id="1174"><a class="l" href="#1174">1174 </a>
</span><span class="l" id="1175"><a class="l" href="#1175">1175 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1176"><a class="l" href="#1176">1176 </a><span class="php-comment">     * @return bool Whether a transaction was already started/is already running.
</span></span><span class="l" id="1177"><a class="l" href="#1177">1177 </a><span class="php-comment">     */</span>
</span><span class="l" id="1178"><a class="l" href="#1178">1178 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_inTransaction" id="_inTransaction">inTransaction</a>()
</span><span class="l" id="1179"><a class="l" href="#1179">1179 </a>    {
</span><span class="l" id="1180"><a class="l" href="#1180">1180 </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction();
</span><span class="l" id="1181"><a class="l" href="#1181">1181 </a>    }
</span><span class="l" id="1182"><a class="l" href="#1182">1182 </a>
</span><span class="l" id="1183"><a class="l" href="#1183">1183 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1184"><a class="l" href="#1184">1184 </a><span class="php-comment">     * Convenience method which executes the given callable within a transaction.
</span></span><span class="l" id="1185"><a class="l" href="#1185">1185 </a><span class="php-comment">     *
</span></span><span class="l" id="1186"><a class="l" href="#1186">1186 </a><span class="php-comment">     * In case the callable throws, the transaction will automatically rolled back.
</span></span><span class="l" id="1187"><a class="l" href="#1187">1187 </a><span class="php-comment">     * In case no error happens, the transaction will be committed after the callable was called.
</span></span><span class="l" id="1188"><a class="l" href="#1188">1188 </a><span class="php-comment">     */</span>
</span><span class="l" id="1189"><a class="l" href="#1189">1189 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_transactional" id="_transactional">transactional</a>(<span class="php-keyword1">callable</span> <span class="php-var">$callable</span>)
</span><span class="l" id="1190"><a class="l" href="#1190">1190 </a>    {
</span><span class="l" id="1191"><a class="l" href="#1191">1191 </a>        <span class="php-var">$inTransaction</span> = self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;inTransaction();
</span><span class="l" id="1192"><a class="l" href="#1192">1192 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1193"><a class="l" href="#1193">1193 </a>            self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;beginTransaction();
</span><span class="l" id="1194"><a class="l" href="#1194">1194 </a>        }
</span><span class="l" id="1195"><a class="l" href="#1195">1195 </a>        <span class="php-keyword1">try</span> {
</span><span class="l" id="1196"><a class="l" href="#1196">1196 </a>            <span class="php-var">$result</span> = <span class="php-var">$callable</span>();
</span><span class="l" id="1197"><a class="l" href="#1197">1197 </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1198"><a class="l" href="#1198">1198 </a>                self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;commit();
</span><span class="l" id="1199"><a class="l" href="#1199">1199 </a>            }
</span><span class="l" id="1200"><a class="l" href="#1200">1200 </a>            <span class="php-keyword1">return</span> <span class="php-var">$result</span>;
</span><span class="l" id="1201"><a class="l" href="#1201">1201 </a>        } <span class="php-keyword1">catch</span> (\Exception <span class="php-var">$e</span>) {
</span><span class="l" id="1202"><a class="l" href="#1202">1202 </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1203"><a class="l" href="#1203">1203 </a>                self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;rollBack();
</span><span class="l" id="1204"><a class="l" href="#1204">1204 </a>            }
</span><span class="l" id="1205"><a class="l" href="#1205">1205 </a>            <span class="php-keyword1">throw</span> <span class="php-var">$e</span>;
</span><span class="l" id="1206"><a class="l" href="#1206">1206 </a>        } <span class="php-keyword1">catch</span> (\Throwable <span class="php-var">$e</span>) {
</span><span class="l" id="1207"><a class="l" href="#1207">1207 </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$inTransaction</span>) {
</span><span class="l" id="1208"><a class="l" href="#1208">1208 </a>                self::<span class="php-var">$pdo</span>[<span class="php-var">$this</span>-&gt;DBID]-&gt;rollBack();
</span><span class="l" id="1209"><a class="l" href="#1209">1209 </a>            }
</span><span class="l" id="1210"><a class="l" href="#1210">1210 </a>            <span class="php-keyword1">throw</span> <span class="php-var">$e</span>;
</span><span class="l" id="1211"><a class="l" href="#1211">1211 </a>        }
</span><span class="l" id="1212"><a class="l" href="#1212">1212 </a>    }
</span><span class="l" id="1213"><a class="l" href="#1213">1213 </a>
</span><span class="l" id="1214"><a class="l" href="#1214">1214 </a>    <span class="php-comment">// ----------------- iterator interface</span>
</span><span class="l" id="1215"><a class="l" href="#1215">1215 </a>
</span><span class="l" id="1216"><a class="l" href="#1216">1216 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1217"><a class="l" href="#1217">1217 </a><span class="php-comment">     * @see http://www.php.net/manual/en/iterator.rewind.php
</span></span><span class="l" id="1218"><a class="l" href="#1218">1218 </a><span class="php-comment">     */</span>
</span><span class="l" id="1219"><a class="l" href="#1219">1219 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">rewind</span>()
</span><span class="l" id="1220"><a class="l" href="#1220">1220 </a>    {
</span><span class="l" id="1221"><a class="l" href="#1221">1221 </a>        <span class="php-var">$this</span>-&gt;<span class="php-keyword2">reset</span>();
</span><span class="l" id="1222"><a class="l" href="#1222">1222 </a>    }
</span><span class="l" id="1223"><a class="l" href="#1223">1223 </a>
</span><span class="l" id="1224"><a class="l" href="#1224">1224 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1225"><a class="l" href="#1225">1225 </a><span class="php-comment">     * @see http://www.php.net/manual/en/iterator.current.php
</span></span><span class="l" id="1226"><a class="l" href="#1226">1226 </a><span class="php-comment">     *
</span></span><span class="l" id="1227"><a class="l" href="#1227">1227 </a><span class="php-comment">     * @return $this
</span></span><span class="l" id="1228"><a class="l" href="#1228">1228 </a><span class="php-comment">     */</span>
</span><span class="l" id="1229"><a class="l" href="#1229">1229 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">current</span>()
</span><span class="l" id="1230"><a class="l" href="#1230">1230 </a>    {
</span><span class="l" id="1231"><a class="l" href="#1231">1231 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
</span><span class="l" id="1232"><a class="l" href="#1232">1232 </a>    }
</span><span class="l" id="1233"><a class="l" href="#1233">1233 </a>
</span><span class="l" id="1234"><a class="l" href="#1234">1234 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1235"><a class="l" href="#1235">1235 </a><span class="php-comment">     * @see http://www.php.net/manual/en/iterator.key.php
</span></span><span class="l" id="1236"><a class="l" href="#1236">1236 </a><span class="php-comment">     */</span>
</span><span class="l" id="1237"><a class="l" href="#1237">1237 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">key</span>()
</span><span class="l" id="1238"><a class="l" href="#1238">1238 </a>    {
</span><span class="l" id="1239"><a class="l" href="#1239">1239 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;counter;
</span><span class="l" id="1240"><a class="l" href="#1240">1240 </a>    }
</span><span class="l" id="1241"><a class="l" href="#1241">1241 </a>
</span><span class="l" id="1242"><a class="l" href="#1242">1242 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1243"><a class="l" href="#1243">1243 </a><span class="php-comment">     * @see http://www.php.net/manual/en/iterator.next.php
</span></span><span class="l" id="1244"><a class="l" href="#1244">1244 </a><span class="php-comment">     */</span>
</span><span class="l" id="1245"><a class="l" href="#1245">1245 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">next</span>()
</span><span class="l" id="1246"><a class="l" href="#1246">1246 </a>    {
</span><span class="l" id="1247"><a class="l" href="#1247">1247 </a>        ++<span class="php-var">$this</span>-&gt;counter;
</span><span class="l" id="1248"><a class="l" href="#1248">1248 </a>        <span class="php-var">$this</span>-&gt;lastRow = <span class="php-var">$this</span>-&gt;stmt-&gt;fetch();
</span><span class="l" id="1249"><a class="l" href="#1249">1249 </a>    }
</span><span class="l" id="1250"><a class="l" href="#1250">1250 </a>
</span><span class="l" id="1251"><a class="l" href="#1251">1251 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1252"><a class="l" href="#1252">1252 </a><span class="php-comment">     * @see http://www.php.net/manual/en/iterator.valid.php
</span></span><span class="l" id="1253"><a class="l" href="#1253">1253 </a><span class="php-comment">     */</span>
</span><span class="l" id="1254"><a class="l" href="#1254">1254 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a href="#_valid" id="_valid">valid</a>()
</span><span class="l" id="1255"><a class="l" href="#1255">1255 </a>    {
</span><span class="l" id="1256"><a class="l" href="#1256">1256 </a>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;hasNext();
</span><span class="l" id="1257"><a class="l" href="#1257">1257 </a>    }
</span><span class="l" id="1258"><a class="l" href="#1258">1258 </a>
</span><span class="l" id="1259"><a class="l" href="#1259">1259 </a>    <span class="php-comment">// ----------------- /iterator interface</span>
</span><span class="l" id="1260"><a class="l" href="#1260">1260 </a>
</span><span class="l" id="1261"><a class="l" href="#1261">1261 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1262"><a class="l" href="#1262">1262 </a><span class="php-comment">     * Erstellt das CREATE TABLE Statement um die Tabelle $table
</span></span><span class="l" id="1263"><a class="l" href="#1263">1263 </a><span class="php-comment">     * der Datenbankverbindung $DBID zu erstellen.
</span></span><span class="l" id="1264"><a class="l" href="#1264">1264 </a><span class="php-comment">     *
</span></span><span class="l" id="1265"><a class="l" href="#1265">1265 </a><span class="php-comment">     * @param string $table Name der Tabelle
</span></span><span class="l" id="1266"><a class="l" href="#1266">1266 </a><span class="php-comment">     * @param int    $DBID  Id der Datenbankverbindung
</span></span><span class="l" id="1267"><a class="l" href="#1267">1267 </a><span class="php-comment">     *
</span></span><span class="l" id="1268"><a class="l" href="#1268">1268 </a><span class="php-comment">     * @return string CREATE TABLE Sql-Statement zu erstsellung der Tabelle
</span></span><span class="l" id="1269"><a class="l" href="#1269">1269 </a><span class="php-comment">     */</span>
</span><span class="l" id="1270"><a class="l" href="#1270">1270 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_showCreateTable" id="_showCreateTable">showCreateTable</a>(<span class="php-var">$table</span>, <span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1271"><a class="l" href="#1271">1271 </a>    {
</span><span class="l" id="1272"><a class="l" href="#1272">1272 </a>        <span class="php-var">$sql</span> = self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1273"><a class="l" href="#1273">1273 </a>        <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SHOW CREATE TABLE '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>));
</span><span class="l" id="1274"><a class="l" href="#1274">1274 </a>        <span class="php-keyword1">return</span> <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'Create Table'</span>);
</span><span class="l" id="1275"><a class="l" href="#1275">1275 </a>    }
</span><span class="l" id="1276"><a class="l" href="#1276">1276 </a>
</span><span class="l" id="1277"><a class="l" href="#1277">1277 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1278"><a class="l" href="#1278">1278 </a><span class="php-comment">     * Sucht alle Tabellen der Datenbankverbindung $DBID.
</span></span><span class="l" id="1279"><a class="l" href="#1279">1279 </a><span class="php-comment">     * Falls $tablePrefix gesetzt ist, werden nur dem Prefix entsprechende Tabellen gesucht.
</span></span><span class="l" id="1280"><a class="l" href="#1280">1280 </a><span class="php-comment">     *
</span></span><span class="l" id="1281"><a class="l" href="#1281">1281 </a><span class="php-comment">     * @param int    $DBID        Id der Datenbankverbindung
</span></span><span class="l" id="1282"><a class="l" href="#1282">1282 </a><span class="php-comment">     * @param string $tablePrefix Zu suchender Tabellennamen-Prefix
</span></span><span class="l" id="1283"><a class="l" href="#1283">1283 </a><span class="php-comment">     *
</span></span><span class="l" id="1284"><a class="l" href="#1284">1284 </a><span class="php-comment">     * @return array Ein Array von Tabellennamen
</span></span><span class="l" id="1285"><a class="l" href="#1285">1285 </a><span class="php-comment">     */</span>
</span><span class="l" id="1286"><a class="l" href="#1286">1286 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_showTables" id="_showTables">showTables</a>(<span class="php-var">$DBID</span> = <span class="php-num">1</span>, <span class="php-var">$tablePrefix</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="1287"><a class="l" href="#1287">1287 </a>    {
</span><span class="l" id="1288"><a class="l" href="#1288">1288 </a>        <span class="php-var">$qry</span> = <span class="php-quote">'SHOW TABLES'</span>;
</span><span class="l" id="1289"><a class="l" href="#1289">1289 </a>        <span class="php-keyword1">if</span> (<span class="php-var">$tablePrefix</span> != <span class="php-keyword1">null</span>) {
</span><span class="l" id="1290"><a class="l" href="#1290">1290 </a>            <span class="php-comment">// replace LIKE wildcards</span>
</span><span class="l" id="1291"><a class="l" href="#1291">1291 </a>            <span class="php-var">$tablePrefix</span> = <span class="php-keyword2">str_replace</span>([<span class="php-quote">'_'</span>, <span class="php-quote">'%'</span>], [<span class="php-quote">'\_'</span>, <span class="php-quote">'\%'</span>], <span class="php-var">$tablePrefix</span>);
</span><span class="l" id="1292"><a class="l" href="#1292">1292 </a>            <span class="php-var">$qry</span> .= <span class="php-quote">' LIKE "'</span> . <span class="php-var">$tablePrefix</span> . <span class="php-quote">'%"'</span>;
</span><span class="l" id="1293"><a class="l" href="#1293">1293 </a>        }
</span><span class="l" id="1294"><a class="l" href="#1294">1294 </a>
</span><span class="l" id="1295"><a class="l" href="#1295">1295 </a>        <span class="php-var">$sql</span> = self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1296"><a class="l" href="#1296">1296 </a>        <span class="php-var">$tables</span> = <span class="php-var">$sql</span>-&gt;getArray(<span class="php-var">$qry</span>);
</span><span class="l" id="1297"><a class="l" href="#1297">1297 </a>        <span class="php-var">$tables</span> = <span class="php-keyword2">array_map</span>(<span class="php-quote">'reset'</span>, <span class="php-var">$tables</span>);
</span><span class="l" id="1298"><a class="l" href="#1298">1298 </a>
</span><span class="l" id="1299"><a class="l" href="#1299">1299 </a>        <span class="php-keyword1">return</span> <span class="php-var">$tables</span>;
</span><span class="l" id="1300"><a class="l" href="#1300">1300 </a>    }
</span><span class="l" id="1301"><a class="l" href="#1301">1301 </a>
</span><span class="l" id="1302"><a class="l" href="#1302">1302 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1303"><a class="l" href="#1303">1303 </a><span class="php-comment">     * Sucht Spalteninformationen der Tabelle $table der Datenbankverbindung $DBID.
</span></span><span class="l" id="1304"><a class="l" href="#1304">1304 </a><span class="php-comment">     *
</span></span><span class="l" id="1305"><a class="l" href="#1305">1305 </a><span class="php-comment">     * Beispiel fuer den Rueckgabewert:
</span></span><span class="l" id="1306"><a class="l" href="#1306">1306 </a><span class="php-comment">     *
</span></span><span class="l" id="1307"><a class="l" href="#1307">1307 </a><span class="php-comment">     * Array (
</span></span><span class="l" id="1308"><a class="l" href="#1308">1308 </a><span class="php-comment">     *  [0] =&gt; Array (
</span></span><span class="l" id="1309"><a class="l" href="#1309">1309 </a><span class="php-comment">     *    [name] =&gt; pid
</span></span><span class="l" id="1310"><a class="l" href="#1310">1310 </a><span class="php-comment">     *    [type] =&gt; int(11)
</span></span><span class="l" id="1311"><a class="l" href="#1311">1311 </a><span class="php-comment">     *    [null] =&gt; NO
</span></span><span class="l" id="1312"><a class="l" href="#1312">1312 </a><span class="php-comment">     *    [key] =&gt; PRI
</span></span><span class="l" id="1313"><a class="l" href="#1313">1313 </a><span class="php-comment">     *    [default] =&gt;
</span></span><span class="l" id="1314"><a class="l" href="#1314">1314 </a><span class="php-comment">     *    [extra] =&gt; auto_increment
</span></span><span class="l" id="1315"><a class="l" href="#1315">1315 </a><span class="php-comment">     *  )
</span></span><span class="l" id="1316"><a class="l" href="#1316">1316 </a><span class="php-comment">     *  [1] =&gt; Array (
</span></span><span class="l" id="1317"><a class="l" href="#1317">1317 </a><span class="php-comment">     *    [name] =&gt; id
</span></span><span class="l" id="1318"><a class="l" href="#1318">1318 </a><span class="php-comment">     *    [type] =&gt; int(11)
</span></span><span class="l" id="1319"><a class="l" href="#1319">1319 </a><span class="php-comment">     *    [null] =&gt; NO
</span></span><span class="l" id="1320"><a class="l" href="#1320">1320 </a><span class="php-comment">     *    [key] =&gt; MUL
</span></span><span class="l" id="1321"><a class="l" href="#1321">1321 </a><span class="php-comment">     *    [default] =&gt;
</span></span><span class="l" id="1322"><a class="l" href="#1322">1322 </a><span class="php-comment">     *    [extra] =&gt;
</span></span><span class="l" id="1323"><a class="l" href="#1323">1323 </a><span class="php-comment">     *  )
</span></span><span class="l" id="1324"><a class="l" href="#1324">1324 </a><span class="php-comment">     * )
</span></span><span class="l" id="1325"><a class="l" href="#1325">1325 </a><span class="php-comment">     *
</span></span><span class="l" id="1326"><a class="l" href="#1326">1326 </a><span class="php-comment">     * @param string $table Name der Tabelle
</span></span><span class="l" id="1327"><a class="l" href="#1327">1327 </a><span class="php-comment">     * @param int    $DBID  Id der Datenbankverbindung
</span></span><span class="l" id="1328"><a class="l" href="#1328">1328 </a><span class="php-comment">     *
</span></span><span class="l" id="1329"><a class="l" href="#1329">1329 </a><span class="php-comment">     * @return array Ein mehrdimensionales Array das die Metadaten enthaelt
</span></span><span class="l" id="1330"><a class="l" href="#1330">1330 </a><span class="php-comment">     */</span>
</span><span class="l" id="1331"><a class="l" href="#1331">1331 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_showColumns" id="_showColumns">showColumns</a>(<span class="php-var">$table</span>, <span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1332"><a class="l" href="#1332">1332 </a>    {
</span><span class="l" id="1333"><a class="l" href="#1333">1333 </a>        <span class="php-var">$sql</span> = self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1334"><a class="l" href="#1334">1334 </a>        <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'SHOW COLUMNS FROM '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>));
</span><span class="l" id="1335"><a class="l" href="#1335">1335 </a>
</span><span class="l" id="1336"><a class="l" href="#1336">1336 </a>        <span class="php-var">$columns</span> = [];
</span><span class="l" id="1337"><a class="l" href="#1337">1337 </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$sql</span> <span class="php-keyword1">as</span> <span class="php-var">$col</span>) {
</span><span class="l" id="1338"><a class="l" href="#1338">1338 </a>            <span class="php-var">$columns</span>[] = [
</span><span class="l" id="1339"><a class="l" href="#1339">1339 </a>                <span class="php-quote">'name'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Field'</span>),
</span><span class="l" id="1340"><a class="l" href="#1340">1340 </a>                <span class="php-quote">'type'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Type'</span>),
</span><span class="l" id="1341"><a class="l" href="#1341">1341 </a>                <span class="php-quote">'null'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Null'</span>),
</span><span class="l" id="1342"><a class="l" href="#1342">1342 </a>                <span class="php-quote">'key'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Key'</span>),
</span><span class="l" id="1343"><a class="l" href="#1343">1343 </a>                <span class="php-quote">'default'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Default'</span>),
</span><span class="l" id="1344"><a class="l" href="#1344">1344 </a>                <span class="php-quote">'extra'</span> =&gt; <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Extra'</span>),
</span><span class="l" id="1345"><a class="l" href="#1345">1345 </a>            ];
</span><span class="l" id="1346"><a class="l" href="#1346">1346 </a>        }
</span><span class="l" id="1347"><a class="l" href="#1347">1347 </a>
</span><span class="l" id="1348"><a class="l" href="#1348">1348 </a>        <span class="php-keyword1">return</span> <span class="php-var">$columns</span>;
</span><span class="l" id="1349"><a class="l" href="#1349">1349 </a>    }
</span><span class="l" id="1350"><a class="l" href="#1350">1350 </a>
</span><span class="l" id="1351"><a class="l" href="#1351">1351 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1352"><a class="l" href="#1352">1352 </a><span class="php-comment">     * Gibt die Serverversion zurueck.
</span></span><span class="l" id="1353"><a class="l" href="#1353">1353 </a><span class="php-comment">     *
</span></span><span class="l" id="1354"><a class="l" href="#1354">1354 </a><span class="php-comment">     * Die Versionsinformation ist erst bekannt,
</span></span><span class="l" id="1355"><a class="l" href="#1355">1355 </a><span class="php-comment">     * nachdem der rex_sql Konstruktor einmalig erfolgreich durchlaufen wurde.
</span></span><span class="l" id="1356"><a class="l" href="#1356">1356 </a><span class="php-comment">     */</span>
</span><span class="l" id="1357"><a class="l" href="#1357">1357 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_getServerVersion" id="_getServerVersion">getServerVersion</a>(<span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1358"><a class="l" href="#1358">1358 </a>    {
</span><span class="l" id="1359"><a class="l" href="#1359">1359 </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>])) {
</span><span class="l" id="1360"><a class="l" href="#1360">1360 </a>            <span class="php-comment">// create connection if necessary</span>
</span><span class="l" id="1361"><a class="l" href="#1361">1361 </a>            self::factory(<span class="php-var">$DBID</span>);
</span><span class="l" id="1362"><a class="l" href="#1362">1362 </a>        }
</span><span class="l" id="1363"><a class="l" href="#1363">1363 </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$pdo</span>[<span class="php-var">$DBID</span>]-&gt;getAttribute(PDO::ATTR_SERVER_VERSION);
</span><span class="l" id="1364"><a class="l" href="#1364">1364 </a>    }
</span><span class="l" id="1365"><a class="l" href="#1365">1365 </a>
</span><span class="l" id="1366"><a class="l" href="#1366">1366 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1367"><a class="l" href="#1367">1367 </a><span class="php-comment">     * Creates a rex_sql instance.
</span></span><span class="l" id="1368"><a class="l" href="#1368">1368 </a><span class="php-comment">     *
</span></span><span class="l" id="1369"><a class="l" href="#1369">1369 </a><span class="php-comment">     * @param int $DBID
</span></span><span class="l" id="1370"><a class="l" href="#1370">1370 </a><span class="php-comment">     *
</span></span><span class="l" id="1371"><a class="l" href="#1371">1371 </a><span class="php-comment">     * @return static Returns a rex_sql instance
</span></span><span class="l" id="1372"><a class="l" href="#1372">1372 </a><span class="php-comment">     */</span>
</span><span class="l" id="1373"><a class="l" href="#1373">1373 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_factory" id="_factory">factory</a>(<span class="php-var">$DBID</span> = <span class="php-num">1</span>)
</span><span class="l" id="1374"><a class="l" href="#1374">1374 </a>    {
</span><span class="l" id="1375"><a class="l" href="#1375">1375 </a>        <span class="php-var">$class</span> = <span class="php-keyword1">static</span>::getFactoryClass();
</span><span class="l" id="1376"><a class="l" href="#1376">1376 </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> <span class="php-var">$class</span>(<span class="php-var">$DBID</span>);
</span><span class="l" id="1377"><a class="l" href="#1377">1377 </a>    }
</span><span class="l" id="1378"><a class="l" href="#1378">1378 </a>
</span><span class="l" id="1379"><a class="l" href="#1379">1379 </a>    <span class="php-comment">/**
</span></span><span class="l" id="1380"><a class="l" href="#1380">1380 </a><span class="php-comment">     * Prueft die uebergebenen Zugangsdaten auf gueltigkeit und legt ggf. die
</span></span><span class="l" id="1381"><a class="l" href="#1381">1381 </a><span class="php-comment">     * Datenbank an.
</span></span><span class="l" id="1382"><a class="l" href="#1382">1382 </a><span class="php-comment">     */</span>
</span><span class="l" id="1383"><a class="l" href="#1383">1383 </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <a href="#_checkDbConnection" id="_checkDbConnection">checkDbConnection</a>(<span class="php-var">$host</span>, <span class="php-var">$login</span>, <span class="php-var">$pw</span>, <span class="php-var">$dbname</span>, <span class="php-var">$createDb</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="1384"><a class="l" href="#1384">1384 </a>    {
</span><span class="l" id="1385"><a class="l" href="#1385">1385 </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$dbname</span>) {
</span><span class="l" id="1386"><a class="l" href="#1386">1386 </a>            <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'sql_database_name_missing'</span>);
</span><span class="l" id="1387"><a class="l" href="#1387">1387 </a>        }
</span><span class="l" id="1388"><a class="l" href="#1388">1388 </a>
</span><span class="l" id="1389"><a class="l" href="#1389">1389 </a>        <span class="php-var">$err_msg</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="1390"><a class="l" href="#1390">1390 </a>
</span><span class="l" id="1391"><a class="l" href="#1391">1391 </a>        <span class="php-keyword1">try</span> {
</span><span class="l" id="1392"><a class="l" href="#1392">1392 </a>            self::createConnection(
</span><span class="l" id="1393"><a class="l" href="#1393">1393 </a>                <span class="php-var">$host</span>,
</span><span class="l" id="1394"><a class="l" href="#1394">1394 </a>                <span class="php-var">$dbname</span>,
</span><span class="l" id="1395"><a class="l" href="#1395">1395 </a>                <span class="php-var">$login</span>,
</span><span class="l" id="1396"><a class="l" href="#1396">1396 </a>                <span class="php-var">$pw</span>
</span><span class="l" id="1397"><a class="l" href="#1397">1397 </a>            );
</span><span class="l" id="1398"><a class="l" href="#1398">1398 </a>
</span><span class="l" id="1399"><a class="l" href="#1399">1399 </a>            <span class="php-comment">// db connection was successfully established, but we were meant to create the db</span>
</span><span class="l" id="1400"><a class="l" href="#1400">1400 </a>            <span class="php-keyword1">if</span> (<span class="php-var">$createDb</span>) {
</span><span class="l" id="1401"><a class="l" href="#1401">1401 </a>                <span class="php-comment">// -&gt; throw db already exists error</span>
</span><span class="l" id="1402"><a class="l" href="#1402">1402 </a>                <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_database_already_exists'</span>);
</span><span class="l" id="1403"><a class="l" href="#1403">1403 </a>            }
</span><span class="l" id="1404"><a class="l" href="#1404">1404 </a>        } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="1405"><a class="l" href="#1405">1405 </a>            <span class="php-comment">// see mysql error codes at http://dev.mysql.com/doc/refman/5.1/de/error-messages-server.html</span>
</span><span class="l" id="1406"><a class="l" href="#1406">1406 </a>
</span><span class="l" id="1407"><a class="l" href="#1407">1407 </a>            <span class="php-comment">// ER_BAD_HOST</span>
</span><span class="l" id="1408"><a class="l" href="#1408">1408 </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [2002]'</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="1409"><a class="l" href="#1409">1409 </a>                <span class="php-comment">// unable to connect to db server</span>
</span><span class="l" id="1410"><a class="l" href="#1410">1410 </a>                <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_connect_database'</span>);
</span><span class="l" id="1411"><a class="l" href="#1411">1411 </a>            }
</span><span class="l" id="1412"><a class="l" href="#1412">1412 </a>            <span class="php-comment">// ER_BAD_DB_ERROR</span>
</span><span class="l" id="1413"><a class="l" href="#1413">1413 </a>            <span class="php-keyword1">elseif</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [1049]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1414"><a class="l" href="#1414">1414 </a>                    <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[42000]'</span>) !== <span class="php-keyword1">false</span>
</span><span class="l" id="1415"><a class="l" href="#1415">1415 </a>            ) {
</span><span class="l" id="1416"><a class="l" href="#1416">1416 </a>                <span class="php-keyword1">if</span> (<span class="php-var">$createDb</span>) {
</span><span class="l" id="1417"><a class="l" href="#1417">1417 </a>                    <span class="php-keyword1">try</span> {
</span><span class="l" id="1418"><a class="l" href="#1418">1418 </a>                        <span class="php-comment">// use the "mysql" db for the connection</span>
</span><span class="l" id="1419"><a class="l" href="#1419">1419 </a>                        <span class="php-var">$conn</span> = self::createConnection(
</span><span class="l" id="1420"><a class="l" href="#1420">1420 </a>                            <span class="php-var">$host</span>,
</span><span class="l" id="1421"><a class="l" href="#1421">1421 </a>                            <span class="php-quote">'mysql'</span>,
</span><span class="l" id="1422"><a class="l" href="#1422">1422 </a>                            <span class="php-var">$login</span>,
</span><span class="l" id="1423"><a class="l" href="#1423">1423 </a>                            <span class="php-var">$pw</span>
</span><span class="l" id="1424"><a class="l" href="#1424">1424 </a>                        );
</span><span class="l" id="1425"><a class="l" href="#1425">1425 </a>                        <span class="php-keyword1">if</span> (<span class="php-var">$conn</span>-&gt;<span class="php-keyword2">exec</span>(<span class="php-quote">'CREATE DATABASE '</span> . <span class="php-var">$dbname</span> . <span class="php-quote">' CHARACTER SET utf8 COLLATE utf8_general_ci'</span>) !== <span class="php-num">1</span>) {
</span><span class="l" id="1426"><a class="l" href="#1426">1426 </a>                            <span class="php-comment">// unable to create db</span>
</span><span class="l" id="1427"><a class="l" href="#1427">1427 </a>                            <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_create_database'</span>);
</span><span class="l" id="1428"><a class="l" href="#1428">1428 </a>                        }
</span><span class="l" id="1429"><a class="l" href="#1429">1429 </a>                    } <span class="php-keyword1">catch</span> (PDOException <span class="php-var">$e</span>) {
</span><span class="l" id="1430"><a class="l" href="#1430">1430 </a>                        <span class="php-comment">// unable to find database</span>
</span><span class="l" id="1431"><a class="l" href="#1431">1431 </a>                        <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_open_database'</span>);
</span><span class="l" id="1432"><a class="l" href="#1432">1432 </a>                    }
</span><span class="l" id="1433"><a class="l" href="#1433">1433 </a>                } <span class="php-keyword1">else</span> {
</span><span class="l" id="1434"><a class="l" href="#1434">1434 </a>                    <span class="php-comment">// unable to find database</span>
</span><span class="l" id="1435"><a class="l" href="#1435">1435 </a>                    <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_find_database'</span>);
</span><span class="l" id="1436"><a class="l" href="#1436">1436 </a>                }
</span><span class="l" id="1437"><a class="l" href="#1437">1437 </a>            }
</span><span class="l" id="1438"><a class="l" href="#1438">1438 </a>            <span class="php-comment">// ER_ACCESS_DENIED_ERROR</span>
</span><span class="l" id="1439"><a class="l" href="#1439">1439 </a>            <span class="php-comment">// ER_DBACCESS_DENIED_ERROR</span>
</span><span class="l" id="1440"><a class="l" href="#1440">1440 </a>            <span class="php-keyword1">elseif</span> (
</span><span class="l" id="1441"><a class="l" href="#1441">1441 </a>                <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [1045]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1442"><a class="l" href="#1442">1442 </a>                <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[28000]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1443"><a class="l" href="#1443">1443 </a>                <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [1044]'</span>) !== <span class="php-keyword1">false</span> ||
</span><span class="l" id="1444"><a class="l" href="#1444">1444 </a>                <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[42000]'</span>) !== <span class="php-keyword1">false</span>
</span><span class="l" id="1445"><a class="l" href="#1445">1445 </a>            ) {
</span><span class="l" id="1446"><a class="l" href="#1446">1446 </a>                <span class="php-comment">// unable to connect to db</span>
</span><span class="l" id="1447"><a class="l" href="#1447">1447 </a>                <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_connect_database'</span>);
</span><span class="l" id="1448"><a class="l" href="#1448">1448 </a>            }
</span><span class="l" id="1449"><a class="l" href="#1449">1449 </a>            <span class="php-comment">// ER_ACCESS_TO_SERVER_ERROR</span>
</span><span class="l" id="1450"><a class="l" href="#1450">1450 </a>            <span class="php-keyword1">elseif</span> (
</span><span class="l" id="1451"><a class="l" href="#1451">1451 </a>                <span class="php-keyword2">strpos</span>(<span class="php-var">$e</span>-&gt;getMessage(), <span class="php-quote">'SQLSTATE[HY000] [2005]'</span>) !== <span class="php-keyword1">false</span>
</span><span class="l" id="1452"><a class="l" href="#1452">1452 </a>            ) {
</span><span class="l" id="1453"><a class="l" href="#1453">1453 </a>                <span class="php-comment">// unable to connect to server</span>
</span><span class="l" id="1454"><a class="l" href="#1454">1454 </a>                <span class="php-var">$err_msg</span> = rex_i18n::msg(<span class="php-quote">'sql_unable_to_connect_server'</span>);
</span><span class="l" id="1455"><a class="l" href="#1455">1455 </a>            } <span class="php-keyword1">else</span> {
</span><span class="l" id="1456"><a class="l" href="#1456">1456 </a>                <span class="php-comment">// we didn't expected this error, so rethrow it to show it to the admin/end-user</span>
</span><span class="l" id="1457"><a class="l" href="#1457">1457 </a>                <span class="php-keyword1">throw</span> <span class="php-var">$e</span>;
</span><span class="l" id="1458"><a class="l" href="#1458">1458 </a>            }
</span><span class="l" id="1459"><a class="l" href="#1459">1459 </a>        }
</span><span class="l" id="1460"><a class="l" href="#1460">1460 </a>
</span><span class="l" id="1461"><a class="l" href="#1461">1461 </a>        <span class="php-comment">// close the connection</span>
</span><span class="l" id="1462"><a class="l" href="#1462">1462 </a>        <span class="php-var">$conn</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="1463"><a class="l" href="#1463">1463 </a>
</span><span class="l" id="1464"><a class="l" href="#1464">1464 </a>        <span class="php-keyword1">return</span>  <span class="php-var">$err_msg</span>;
</span><span class="l" id="1465"><a class="l" href="#1465">1465 </a>    }
</span><span class="l" id="1466"><a class="l" href="#1466">1466 </a>}
</span><span class="l" id="1467"><a class="l" href="#1467">1467 </a></span></code></pre>
 </body>
</html>
