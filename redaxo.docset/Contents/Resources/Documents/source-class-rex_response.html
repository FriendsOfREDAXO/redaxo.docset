<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * HTTP1.1 Client Cache Features.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="7">  7 <span class="php-comment"> */</span>
</span><span class="l" id="8">  8 <span class="php-keyword1">class</span> rex_response
</span><span class="l" id="9">  9 {
</span><span class="l" id="10"> 10     <span class="php-keyword1">const</span> HTTP_OK = <span class="php-quote">'200 OK'</span>;
</span><span class="l" id="11"> 11     <span class="php-keyword1">const</span> HTTP_MOVED_PERMANENTLY = <span class="php-quote">'301 Moved Permanently'</span>;
</span><span class="l" id="12"> 12     <span class="php-keyword1">const</span> HTTP_NOT_MODIFIED = <span class="php-quote">'304 Not Modified'</span>;
</span><span class="l" id="13"> 13     <span class="php-keyword1">const</span> HTTP_NOT_FOUND = <span class="php-quote">'404 Not Found'</span>;
</span><span class="l" id="14"> 14     <span class="php-keyword1">const</span> HTTP_FORBIDDEN = <span class="php-quote">'403 Forbidden'</span>;
</span><span class="l" id="15"> 15     <span class="php-keyword1">const</span> HTTP_UNAUTHORIZED = <span class="php-quote">'401 Unauthorized'</span>;
</span><span class="l" id="16"> 16     <span class="php-keyword1">const</span> HTTP_INTERNAL_ERROR = <span class="php-quote">'500 Internal Server Error'</span>;
</span><span class="l" id="17"> 17     <span class="php-keyword1">const</span> HTTP_SERVICE_UNAVAILABLE = <span class="php-quote">'503 Service Unavailable'</span>;
</span><span class="l" id="18"> 18 
</span><span class="l" id="19"> 19     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$httpStatus</span> = self::HTTP_OK;
</span><span class="l" id="20"> 20     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$sentLastModified</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="21"> 21     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$sentEtag</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="22"> 22     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$sentContentType</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="23"> 23     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$sentCacheControl</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="24"> 24     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$additionalHeaders</span> = [];
</span><span class="l" id="25"> 25     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$preloadFiles</span> = [];
</span><span class="l" id="26"> 26 
</span><span class="l" id="27"> 27     <span class="php-comment">/**
</span></span><span class="l" id="28"> 28 <span class="php-comment">     * Sets the HTTP Status code.
</span></span><span class="l" id="29"> 29 <span class="php-comment">     *
</span></span><span class="l" id="30"> 30 <span class="php-comment">     * @param int $httpStatus
</span></span><span class="l" id="31"> 31 <span class="php-comment">     *
</span></span><span class="l" id="32"> 32 <span class="php-comment">     * @throws InvalidArgumentException
</span></span><span class="l" id="33"> 33 <span class="php-comment">     */</span>
</span><span class="l" id="34"> 34     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> setStatus(<span class="php-var">$httpStatus</span>)
</span><span class="l" id="35"> 35     {
</span><span class="l" id="36"> 36         <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$httpStatus</span>, <span class="php-quote">"\n"</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="37"> 37             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Illegal http-status "'</span> . <span class="php-var">$httpStatus</span> . <span class="php-quote">'", contains newlines'</span>);
</span><span class="l" id="38"> 38         }
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40         self::<span class="php-var">$httpStatus</span> = <span class="php-var">$httpStatus</span>;
</span><span class="l" id="41"> 41     }
</span><span class="l" id="42"> 42 
</span><span class="l" id="43"> 43     <span class="php-comment">/**
</span></span><span class="l" id="44"> 44 <span class="php-comment">     * Returns the HTTP Status code.
</span></span><span class="l" id="45"> 45 <span class="php-comment">     *
</span></span><span class="l" id="46"> 46 <span class="php-comment">     * @return string
</span></span><span class="l" id="47"> 47 <span class="php-comment">     */</span>
</span><span class="l" id="48"> 48     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getStatus()
</span><span class="l" id="49"> 49     {
</span><span class="l" id="50"> 50         <span class="php-keyword1">return</span> self::<span class="php-var">$httpStatus</span>;
</span><span class="l" id="51"> 51     }
</span><span class="l" id="52"> 52 
</span><span class="l" id="53"> 53     <span class="php-comment">/**
</span></span><span class="l" id="54"> 54 <span class="php-comment">     * Set a http response header. A existing header with the same name will be overridden.
</span></span><span class="l" id="55"> 55 <span class="php-comment">     *
</span></span><span class="l" id="56"> 56 <span class="php-comment">     * @param string $name
</span></span><span class="l" id="57"> 57 <span class="php-comment">     * @param string $value
</span></span><span class="l" id="58"> 58 <span class="php-comment">     */</span>
</span><span class="l" id="59"> 59     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> setHeader(<span class="php-var">$name</span>, <span class="php-var">$value</span>)
</span><span class="l" id="60"> 60     {
</span><span class="l" id="61"> 61         self::<span class="php-var">$additionalHeaders</span>[<span class="php-var">$name</span>] = <span class="php-var">$value</span>;
</span><span class="l" id="62"> 62     }
</span><span class="l" id="63"> 63 
</span><span class="l" id="64"> 64     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendAdditionalHeaders()
</span><span class="l" id="65"> 65     {
</span><span class="l" id="66"> 66         <span class="php-keyword1">foreach</span> (self::<span class="php-var">$additionalHeaders</span> <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="67"> 67             <span class="php-keyword2">header</span>(<span class="php-var">$name</span> .<span class="php-quote">': '</span> . <span class="php-var">$value</span>);
</span><span class="l" id="68"> 68         }
</span><span class="l" id="69"> 69     }
</span><span class="l" id="70"> 70 
</span><span class="l" id="71"> 71     <span class="php-comment">/**
</span></span><span class="l" id="72"> 72 <span class="php-comment">     * Set a file to be preload via http link header.
</span></span><span class="l" id="73"> 73 <span class="php-comment">     *
</span></span><span class="l" id="74"> 74 <span class="php-comment">     * @param $file
</span></span><span class="l" id="75"> 75 <span class="php-comment">     * @param $type
</span></span><span class="l" id="76"> 76 <span class="php-comment">     * @param $mimeType
</span></span><span class="l" id="77"> 77 <span class="php-comment">     */</span>
</span><span class="l" id="78"> 78     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> preload(<span class="php-var">$file</span>, <span class="php-var">$type</span>, <span class="php-var">$mimeType</span>)
</span><span class="l" id="79"> 79     {
</span><span class="l" id="80"> 80         self::<span class="php-var">$preloadFiles</span>[] = [
</span><span class="l" id="81"> 81             <span class="php-quote">'file'</span> =&gt; <span class="php-var">$file</span>,
</span><span class="l" id="82"> 82             <span class="php-quote">'type'</span> =&gt; <span class="php-var">$type</span>,
</span><span class="l" id="83"> 83             <span class="php-quote">'mimeType'</span> =&gt; <span class="php-var">$mimeType</span>,
</span><span class="l" id="84"> 84         ];
</span><span class="l" id="85"> 85     }
</span><span class="l" id="86"> 86 
</span><span class="l" id="87"> 87     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendPreloadHeaders()
</span><span class="l" id="88"> 88     {
</span><span class="l" id="89"> 89         <span class="php-keyword1">foreach</span> (self::<span class="php-var">$preloadFiles</span> <span class="php-keyword1">as</span> <span class="php-var">$preloadFile</span>) {
</span><span class="l" id="90"> 90             <span class="php-keyword2">header</span>(<span class="php-quote">'Link: &lt;'</span> . <span class="php-var">$preloadFile</span>[<span class="php-quote">'file'</span>] . <span class="php-quote">'&gt;; rel=preload; as='</span> . <span class="php-var">$preloadFile</span>[<span class="php-quote">'type'</span>] . <span class="php-quote">'; type="'</span> . <span class="php-var">$preloadFile</span>[<span class="php-quote">'mimeType'</span>].<span class="php-quote">'"; nopush'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="91"> 91         }
</span><span class="l" id="92"> 92     }
</span><span class="l" id="93"> 93 
</span><span class="l" id="94"> 94     <span class="php-comment">/**
</span></span><span class="l" id="95"> 95 <span class="php-comment">     * Redirects to a URL.
</span></span><span class="l" id="96"> 96 <span class="php-comment">     *
</span></span><span class="l" id="97"> 97 <span class="php-comment">     * NOTE: Execution will stop within this method!
</span></span><span class="l" id="98"> 98 <span class="php-comment">     *
</span></span><span class="l" id="99"> 99 <span class="php-comment">     * @param string $url URL
</span></span><span class="l" id="100">100 <span class="php-comment">     *
</span></span><span class="l" id="101">101 <span class="php-comment">     * @throws InvalidArgumentException
</span></span><span class="l" id="102">102 <span class="php-comment">     */</span>
</span><span class="l" id="103">103     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendRedirect(<span class="php-var">$url</span>)
</span><span class="l" id="104">104     {
</span><span class="l" id="105">105         <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$url</span>, <span class="php-quote">"\n"</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="106">106             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Illegal redirect url "'</span> . <span class="php-var">$url</span> . <span class="php-quote">'", contains newlines'</span>);
</span><span class="l" id="107">107         }
</span><span class="l" id="108">108 
</span><span class="l" id="109">109         self::cleanOutputBuffers();
</span><span class="l" id="110">110         self::sendAdditionalHeaders();
</span><span class="l" id="111">111         self::sendPreloadHeaders();
</span><span class="l" id="112">112 
</span><span class="l" id="113">113         <span class="php-keyword2">header</span>(<span class="php-quote">'HTTP/1.1 '</span> . self::<span class="php-var">$httpStatus</span>);
</span><span class="l" id="114">114         <span class="php-keyword2">header</span>(<span class="php-quote">'Location: '</span> . <span class="php-var">$url</span>);
</span><span class="l" id="115">115         <span class="php-keyword1">exit</span>;
</span><span class="l" id="116">116     }
</span><span class="l" id="117">117 
</span><span class="l" id="118">118     <span class="php-comment">/**
</span></span><span class="l" id="119">119 <span class="php-comment">     * Sends a file to client.
</span></span><span class="l" id="120">120 <span class="php-comment">     *
</span></span><span class="l" id="121">121 <span class="php-comment">     * @param string      $file               File path
</span></span><span class="l" id="122">122 <span class="php-comment">     * @param string      $contentType        Content type
</span></span><span class="l" id="123">123 <span class="php-comment">     * @param string      $contentDisposition Content disposition ("inline" or "attachment")
</span></span><span class="l" id="124">124 <span class="php-comment">     * @param null|string $filename           Custom Filename
</span></span><span class="l" id="125">125 <span class="php-comment">     */</span>
</span><span class="l" id="126">126     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendFile(<span class="php-var">$file</span>, <span class="php-var">$contentType</span>, <span class="php-var">$contentDisposition</span> = <span class="php-quote">'inline'</span>, <span class="php-var">$filename</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="127">127     {
</span><span class="l" id="128">128         self::cleanOutputBuffers();
</span><span class="l" id="129">129 
</span><span class="l" id="130">130         <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$file</span>)) {
</span><span class="l" id="131">131             <span class="php-keyword2">header</span>(<span class="php-quote">'HTTP/1.1 '</span> . self::HTTP_NOT_FOUND);
</span><span class="l" id="132">132             <span class="php-keyword1">exit</span>;
</span><span class="l" id="133">133         }
</span><span class="l" id="134">134 
</span><span class="l" id="135">135         <span class="php-comment">// prevent session locking while sending huge files</span>
</span><span class="l" id="136">136         <span class="php-keyword2">session_write_close</span>();
</span><span class="l" id="137">137 
</span><span class="l" id="138">138         <span class="php-keyword1">if</span> (!<span class="php-var">$filename</span>) {
</span><span class="l" id="139">139             <span class="php-var">$filename</span> = <span class="php-keyword2">basename</span>(<span class="php-var">$file</span>);
</span><span class="l" id="140">140         }
</span><span class="l" id="141">141 
</span><span class="l" id="142">142         self::sendContentType(<span class="php-var">$contentType</span>);
</span><span class="l" id="143">143         <span class="php-keyword2">header</span>(<span class="php-quote">'Content-Disposition: '</span> . <span class="php-var">$contentDisposition</span> . <span class="php-quote">'; filename="'</span> . <span class="php-var">$filename</span> . <span class="php-quote">'"'</span>);
</span><span class="l" id="144">144 
</span><span class="l" id="145">145         self::sendLastModified(<span class="php-keyword2">filemtime</span>(<span class="php-var">$file</span>));
</span><span class="l" id="146">146 
</span><span class="l" id="147">147         <span class="php-keyword2">header</span>(<span class="php-quote">'HTTP/1.1 '</span> . self::<span class="php-var">$httpStatus</span>);
</span><span class="l" id="148">148         <span class="php-keyword1">if</span> (!self::<span class="php-var">$sentCacheControl</span>) {
</span><span class="l" id="149">149             self::sendCacheControl(<span class="php-quote">'max-age=3600, must-revalidate, proxy-revalidate, private'</span>);
</span><span class="l" id="150">150         }
</span><span class="l" id="151">151 
</span><span class="l" id="152">152         <span class="php-comment">// content length schicken, damit der browser einen ladebalken anzeigen kann</span>
</span><span class="l" id="153">153         <span class="php-keyword1">if</span> (!<span class="php-keyword2">ini_get</span>(<span class="php-quote">'zlib.output_compression'</span>)) {
</span><span class="l" id="154">154             <span class="php-keyword2">header</span>(<span class="php-quote">'Content-Length: '</span> . <span class="php-keyword2">filesize</span>(<span class="php-var">$file</span>));
</span><span class="l" id="155">155         }
</span><span class="l" id="156">156 
</span><span class="l" id="157">157         self::sendAdditionalHeaders();
</span><span class="l" id="158">158         self::sendPreloadHeaders();
</span><span class="l" id="159">159 
</span><span class="l" id="160">160         <span class="php-keyword2">readfile</span>(<span class="php-var">$file</span>);
</span><span class="l" id="161">161     }
</span><span class="l" id="162">162 
</span><span class="l" id="163">163     <span class="php-comment">/**
</span></span><span class="l" id="164">164 <span class="php-comment">     * Sends a resource to the client.
</span></span><span class="l" id="165">165 <span class="php-comment">     *
</span></span><span class="l" id="166">166 <span class="php-comment">     * @param string      $content            Content
</span></span><span class="l" id="167">167 <span class="php-comment">     * @param null|string $contentType        Content type
</span></span><span class="l" id="168">168 <span class="php-comment">     * @param null|int    $lastModified       HTTP Last-Modified Timestamp
</span></span><span class="l" id="169">169 <span class="php-comment">     * @param null|string $etag               HTTP Cachekey to identify the cache
</span></span><span class="l" id="170">170 <span class="php-comment">     * @param null|string $contentDisposition Content disposition ("inline" or "attachment")
</span></span><span class="l" id="171">171 <span class="php-comment">     * @param null|string $filename           Filename
</span></span><span class="l" id="172">172 <span class="php-comment">     */</span>
</span><span class="l" id="173">173     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendResource(<span class="php-var">$content</span>, <span class="php-var">$contentType</span> = <span class="php-keyword1">null</span>, <span class="php-var">$lastModified</span> = <span class="php-keyword1">null</span>, <span class="php-var">$etag</span> = <span class="php-keyword1">null</span>, <span class="php-var">$contentDisposition</span> = <span class="php-keyword1">null</span>, <span class="php-var">$filename</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="174">174     {
</span><span class="l" id="175">175         <span class="php-keyword1">if</span> (<span class="php-var">$contentDisposition</span>) {
</span><span class="l" id="176">176             <span class="php-keyword2">header</span>(<span class="php-quote">'Content-Disposition: '</span> . <span class="php-var">$contentDisposition</span> . <span class="php-quote">'; filename="'</span> . <span class="php-var">$filename</span> . <span class="php-quote">'"'</span>);
</span><span class="l" id="177">177         }
</span><span class="l" id="178">178 
</span><span class="l" id="179">179         self::sendCacheControl(<span class="php-quote">'max-age=3600, must-revalidate, proxy-revalidate, private'</span>);
</span><span class="l" id="180">180         self::sendContent(<span class="php-var">$content</span>, <span class="php-var">$contentType</span>, <span class="php-var">$lastModified</span>, <span class="php-var">$etag</span>);
</span><span class="l" id="181">181     }
</span><span class="l" id="182">182 
</span><span class="l" id="183">183     <span class="php-comment">/**
</span></span><span class="l" id="184">184 <span class="php-comment">     * Sends a page to client.
</span></span><span class="l" id="185">185 <span class="php-comment">     *
</span></span><span class="l" id="186">186 <span class="php-comment">     * The page content can be modified by the Extension Point OUTPUT_FILTER
</span></span><span class="l" id="187">187 <span class="php-comment">     *
</span></span><span class="l" id="188">188 <span class="php-comment">     * @param string $content      Content of page
</span></span><span class="l" id="189">189 <span class="php-comment">     * @param int    $lastModified HTTP Last-Modified Timestamp
</span></span><span class="l" id="190">190 <span class="php-comment">     */</span>
</span><span class="l" id="191">191     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendPage(<span class="php-var">$content</span>, <span class="php-var">$lastModified</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="192">192     {
</span><span class="l" id="193">193         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="194">194         <span class="php-var">$content</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'OUTPUT_FILTER'</span>, <span class="php-var">$content</span>));
</span><span class="l" id="195">195 
</span><span class="l" id="196">196         <span class="php-var">$hasShutdownExtension</span> = rex_extension::isRegistered(<span class="php-quote">'RESPONSE_SHUTDOWN'</span>);
</span><span class="l" id="197">197         <span class="php-keyword1">if</span> (<span class="php-var">$hasShutdownExtension</span>) {
</span><span class="l" id="198">198             <span class="php-keyword2">header</span>(<span class="php-quote">'Connection: close'</span>);
</span><span class="l" id="199">199         }
</span><span class="l" id="200">200 
</span><span class="l" id="201">201         self::sendContent(<span class="php-var">$content</span>, <span class="php-keyword1">null</span>, <span class="php-var">$lastModified</span>);
</span><span class="l" id="202">202 
</span><span class="l" id="203">203         <span class="php-comment">// ----- EXTENSION POINT - (read only)</span>
</span><span class="l" id="204">204         <span class="php-keyword1">if</span> (<span class="php-var">$hasShutdownExtension</span>) {
</span><span class="l" id="205">205             <span class="php-comment">// unlock session</span>
</span><span class="l" id="206">206             <span class="php-keyword2">session_write_close</span>();
</span><span class="l" id="207">207 
</span><span class="l" id="208">208             rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'RESPONSE_SHUTDOWN'</span>, <span class="php-var">$content</span>, [], <span class="php-keyword1">true</span>));
</span><span class="l" id="209">209         }
</span><span class="l" id="210">210     }
</span><span class="l" id="211">211 
</span><span class="l" id="212">212     <span class="php-comment">/**
</span></span><span class="l" id="213">213 <span class="php-comment">     * Sends content to the client.
</span></span><span class="l" id="214">214 <span class="php-comment">     *
</span></span><span class="l" id="215">215 <span class="php-comment">     * @param string $content      Content
</span></span><span class="l" id="216">216 <span class="php-comment">     * @param string $contentType  Content type
</span></span><span class="l" id="217">217 <span class="php-comment">     * @param int    $lastModified HTTP Last-Modified Timestamp
</span></span><span class="l" id="218">218 <span class="php-comment">     * @param string $etag         HTTP Cachekey to identify the cache
</span></span><span class="l" id="219">219 <span class="php-comment">     */</span>
</span><span class="l" id="220">220     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendContent(<span class="php-var">$content</span>, <span class="php-var">$contentType</span> = <span class="php-keyword1">null</span>, <span class="php-var">$lastModified</span> = <span class="php-keyword1">null</span>, <span class="php-var">$etag</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="221">221     {
</span><span class="l" id="222">222         <span class="php-keyword1">if</span> (!self::<span class="php-var">$sentContentType</span>) {
</span><span class="l" id="223">223             self::sendContentType(<span class="php-var">$contentType</span>);
</span><span class="l" id="224">224         }
</span><span class="l" id="225">225         <span class="php-keyword1">if</span> (!self::<span class="php-var">$sentCacheControl</span>) {
</span><span class="l" id="226">226             self::sendCacheControl();
</span><span class="l" id="227">227         }
</span><span class="l" id="228">228 
</span><span class="l" id="229">229         <span class="php-var">$environment</span> = rex::isBackend() ? <span class="php-quote">'backend'</span> : <span class="php-quote">'frontend'</span>;
</span><span class="l" id="230">230 
</span><span class="l" id="231">231         <span class="php-keyword1">if</span> (
</span><span class="l" id="232">232             self::<span class="php-var">$httpStatus</span> == self::HTTP_OK &amp;&amp;
</span><span class="l" id="233">233             <span class="php-comment">// Safari incorrectly caches 304s as empty pages, so don't serve it 304s</span>
</span><span class="l" id="234">234             <span class="php-comment">// http://tech.vg.no/2013/10/02/ios7-bug-shows-white-page-when-getting-304-not-modified-from-server/</span>
</span><span class="l" id="235">235             <span class="php-comment">// https://bugs.webkit.org/show_bug.cgi?id=32829</span>
</span><span class="l" id="236">236             (<span class="php-keyword1">false</span> === <span class="php-keyword2">strpos</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_USER_AGENT'</span>], <span class="php-quote">'Safari'</span>) || <span class="php-keyword1">false</span> !== <span class="php-keyword2">strpos</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_USER_AGENT'</span>], <span class="php-quote">'Chrome'</span>))
</span><span class="l" id="237">237         ) {
</span><span class="l" id="238">238             <span class="php-comment">// ----- Last-Modified</span>
</span><span class="l" id="239">239             <span class="php-keyword1">if</span> (!self::<span class="php-var">$sentLastModified</span>
</span><span class="l" id="240">240                 &amp;&amp; (rex::getProperty(<span class="php-quote">'use_last_modified'</span>) === <span class="php-keyword1">true</span> || rex::getProperty(<span class="php-quote">'use_last_modified'</span>) === <span class="php-var">$environment</span>)
</span><span class="l" id="241">241             ) {
</span><span class="l" id="242">242                 self::sendLastModified(<span class="php-var">$lastModified</span>);
</span><span class="l" id="243">243             }
</span><span class="l" id="244">244 
</span><span class="l" id="245">245             <span class="php-comment">// ----- ETAG</span>
</span><span class="l" id="246">246             <span class="php-keyword1">if</span> (!self::<span class="php-var">$sentEtag</span>
</span><span class="l" id="247">247                 &amp;&amp; (rex::getProperty(<span class="php-quote">'use_etag'</span>) === <span class="php-keyword1">true</span> || rex::getProperty(<span class="php-quote">'use_etag'</span>) === <span class="php-var">$environment</span>)
</span><span class="l" id="248">248             ) {
</span><span class="l" id="249">249                 self::sendEtag(<span class="php-var">$etag</span> ?: self::<span class="php-keyword2">md5</span>(<span class="php-var">$content</span>));
</span><span class="l" id="250">250             }
</span><span class="l" id="251">251         }
</span><span class="l" id="252">252 
</span><span class="l" id="253">253         <span class="php-comment">// ----- GZIP</span>
</span><span class="l" id="254">254         <span class="php-keyword1">if</span> (rex::getProperty(<span class="php-quote">'use_gzip'</span>) === <span class="php-keyword1">true</span> || rex::getProperty(<span class="php-quote">'use_gzip'</span>) === <span class="php-var">$environment</span>) {
</span><span class="l" id="255">255             <span class="php-var">$content</span> = self::sendGzip(<span class="php-var">$content</span>);
</span><span class="l" id="256">256         }
</span><span class="l" id="257">257 
</span><span class="l" id="258">258         self::cleanOutputBuffers();
</span><span class="l" id="259">259 
</span><span class="l" id="260">260         <span class="php-keyword2">header</span>(<span class="php-quote">'HTTP/1.1 '</span> . self::<span class="php-var">$httpStatus</span>);
</span><span class="l" id="261">261 
</span><span class="l" id="262">262         <span class="php-comment">// content length schicken, damit der browser einen ladebalken anzeigen kann</span>
</span><span class="l" id="263">263         <span class="php-keyword2">header</span>(<span class="php-quote">'Content-Length: '</span> . rex_string::size(<span class="php-var">$content</span>));
</span><span class="l" id="264">264 
</span><span class="l" id="265">265         self::sendAdditionalHeaders();
</span><span class="l" id="266">266         self::sendPreloadHeaders();
</span><span class="l" id="267">267 
</span><span class="l" id="268">268         <span class="php-keyword1">echo</span> <span class="php-var">$content</span>;
</span><span class="l" id="269">269 
</span><span class="l" id="270">270         <span class="php-keyword1">if</span> (<span class="php-keyword2">function_exists</span>(<span class="php-quote">'fastcgi_finish_request'</span>)) {
</span><span class="l" id="271">271             fastcgi_finish_request();
</span><span class="l" id="272">272         }
</span><span class="l" id="273">273     }
</span><span class="l" id="274">274 
</span><span class="l" id="275">275     <span class="php-comment">/**
</span></span><span class="l" id="276">276 <span class="php-comment">     * Cleans all output buffers.
</span></span><span class="l" id="277">277 <span class="php-comment">     */</span>
</span><span class="l" id="278">278     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> cleanOutputBuffers()
</span><span class="l" id="279">279     {
</span><span class="l" id="280">280         <span class="php-keyword1">while</span> (<span class="php-keyword2">ob_get_level</span>()) {
</span><span class="l" id="281">281             <span class="php-keyword2">ob_end_clean</span>();
</span><span class="l" id="282">282         }
</span><span class="l" id="283">283     }
</span><span class="l" id="284">284 
</span><span class="l" id="285">285     <span class="php-comment">/**
</span></span><span class="l" id="286">286 <span class="php-comment">     * Sends the content type header.
</span></span><span class="l" id="287">287 <span class="php-comment">     *
</span></span><span class="l" id="288">288 <span class="php-comment">     * @param string $contentType
</span></span><span class="l" id="289">289 <span class="php-comment">     */</span>
</span><span class="l" id="290">290     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendContentType(<span class="php-var">$contentType</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="291">291     {
</span><span class="l" id="292">292         <span class="php-keyword2">header</span>(<span class="php-quote">'Content-Type: '</span> . (<span class="php-var">$contentType</span> ?: <span class="php-quote">'text/html; charset=utf-8'</span>));
</span><span class="l" id="293">293         self::<span class="php-var">$sentContentType</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="294">294     }
</span><span class="l" id="295">295 
</span><span class="l" id="296">296     <span class="php-comment">/**
</span></span><span class="l" id="297">297 <span class="php-comment">     * Sends the cache control header.
</span></span><span class="l" id="298">298 <span class="php-comment">     */</span>
</span><span class="l" id="299">299     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendCacheControl(<span class="php-var">$cacheControl</span> = <span class="php-quote">'must-revalidate, proxy-revalidate, private, no-cache, max-age=0'</span>)
</span><span class="l" id="300">300     {
</span><span class="l" id="301">301         <span class="php-keyword2">header</span>(<span class="php-quote">'Cache-Control: '</span> . <span class="php-var">$cacheControl</span>);
</span><span class="l" id="302">302         self::<span class="php-var">$sentCacheControl</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="303">303     }
</span><span class="l" id="304">304 
</span><span class="l" id="305">305     <span class="php-comment">/**
</span></span><span class="l" id="306">306 <span class="php-comment">     * Checks if content has changed by the last modified timestamp.
</span></span><span class="l" id="307">307 <span class="php-comment">     *
</span></span><span class="l" id="308">308 <span class="php-comment">     * HTTP_IF_MODIFIED_SINCE feature
</span></span><span class="l" id="309">309 <span class="php-comment">     *
</span></span><span class="l" id="310">310 <span class="php-comment">     * @param int $lastModified HTTP Last-Modified Timestamp
</span></span><span class="l" id="311">311 <span class="php-comment">     */</span>
</span><span class="l" id="312">312     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendLastModified(<span class="php-var">$lastModified</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="313">313     {
</span><span class="l" id="314">314         <span class="php-keyword1">if</span> (!<span class="php-var">$lastModified</span>) {
</span><span class="l" id="315">315             <span class="php-var">$lastModified</span> = <span class="php-keyword2">time</span>();
</span><span class="l" id="316">316         }
</span><span class="l" id="317">317 
</span><span class="l" id="318">318         <span class="php-var">$lastModified</span> = <span class="php-keyword2">gmdate</span>(<span class="php-quote">'D, d M Y H:i:s T'</span>, (float) <span class="php-var">$lastModified</span>);
</span><span class="l" id="319">319 
</span><span class="l" id="320">320         <span class="php-comment">// Sende Last-Modification time</span>
</span><span class="l" id="321">321         <span class="php-keyword2">header</span>(<span class="php-quote">'Last-Modified: '</span> . <span class="php-var">$lastModified</span>);
</span><span class="l" id="322">322 
</span><span class="l" id="323">323         <span class="php-comment">// Last-Modified Timestamp gefunden</span>
</span><span class="l" id="324">324         <span class="php-comment">// =&gt; den Browser anweisen, den Cache zu verwenden</span>
</span><span class="l" id="325">325         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_IF_MODIFIED_SINCE'</span>]) &amp;&amp; <span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_IF_MODIFIED_SINCE'</span>] == <span class="php-var">$lastModified</span>) {
</span><span class="l" id="326">326             self::cleanOutputBuffers();
</span><span class="l" id="327">327 
</span><span class="l" id="328">328             <span class="php-keyword2">header</span>(<span class="php-quote">'HTTP/1.1 '</span> . self::HTTP_NOT_MODIFIED);
</span><span class="l" id="329">329             <span class="php-keyword1">exit</span>;
</span><span class="l" id="330">330         }
</span><span class="l" id="331">331         self::<span class="php-var">$sentLastModified</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="332">332     }
</span><span class="l" id="333">333 
</span><span class="l" id="334">334     <span class="php-comment">/**
</span></span><span class="l" id="335">335 <span class="php-comment">     * Checks if content has changed by the etag cachekey.
</span></span><span class="l" id="336">336 <span class="php-comment">     *
</span></span><span class="l" id="337">337 <span class="php-comment">     * HTTP_IF_NONE_MATCH feature
</span></span><span class="l" id="338">338 <span class="php-comment">     *
</span></span><span class="l" id="339">339 <span class="php-comment">     * @param string $cacheKey HTTP Cachekey to identify the cache
</span></span><span class="l" id="340">340 <span class="php-comment">     */</span>
</span><span class="l" id="341">341     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendEtag(<span class="php-var">$cacheKey</span>)
</span><span class="l" id="342">342     {
</span><span class="l" id="343">343         <span class="php-comment">// Laut HTTP Spec muss der Etag in " sein</span>
</span><span class="l" id="344">344         <span class="php-var">$cacheKey</span> = <span class="php-quote">'"'</span> . <span class="php-var">$cacheKey</span> . <span class="php-quote">'"'</span>;
</span><span class="l" id="345">345 
</span><span class="l" id="346">346         <span class="php-comment">// Sende CacheKey als ETag</span>
</span><span class="l" id="347">347         <span class="php-keyword2">header</span>(<span class="php-quote">'ETag: '</span> . <span class="php-var">$cacheKey</span>);
</span><span class="l" id="348">348 
</span><span class="l" id="349">349         <span class="php-comment">// CacheKey gefunden</span>
</span><span class="l" id="350">350         <span class="php-comment">// =&gt; den Browser anweisen, den Cache zu verwenden</span>
</span><span class="l" id="351">351         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_IF_NONE_MATCH'</span>]) &amp;&amp; <span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_IF_NONE_MATCH'</span>] == <span class="php-var">$cacheKey</span>) {
</span><span class="l" id="352">352             self::cleanOutputBuffers();
</span><span class="l" id="353">353 
</span><span class="l" id="354">354             <span class="php-keyword2">header</span>(<span class="php-quote">'HTTP/1.1 '</span> . self::HTTP_NOT_MODIFIED);
</span><span class="l" id="355">355             <span class="php-keyword1">exit</span>;
</span><span class="l" id="356">356         }
</span><span class="l" id="357">357         self::<span class="php-var">$sentEtag</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="358">358     }
</span><span class="l" id="359">359 
</span><span class="l" id="360">360     <span class="php-comment">/**
</span></span><span class="l" id="361">361 <span class="php-comment">     * Encodes the content with GZIP/X-GZIP if the browser supports one of them.
</span></span><span class="l" id="362">362 <span class="php-comment">     *
</span></span><span class="l" id="363">363 <span class="php-comment">     * HTTP_ACCEPT_ENCODING feature
</span></span><span class="l" id="364">364 <span class="php-comment">     *
</span></span><span class="l" id="365">365 <span class="php-comment">     * @param string $content Content
</span></span><span class="l" id="366">366 <span class="php-comment">     *
</span></span><span class="l" id="367">367 <span class="php-comment">     * @return string
</span></span><span class="l" id="368">368 <span class="php-comment">     */</span>
</span><span class="l" id="369">369     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendGzip(<span class="php-var">$content</span>)
</span><span class="l" id="370">370     {
</span><span class="l" id="371">371         <span class="php-var">$enc</span> = <span class="php-quote">''</span>;
</span><span class="l" id="372">372         <span class="php-var">$encodings</span> = [];
</span><span class="l" id="373">373         <span class="php-var">$supportsGzip</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="374">374 
</span><span class="l" id="375">375         <span class="php-comment">// Check if it supports gzip</span>
</span><span class="l" id="376">376         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_ACCEPT_ENCODING'</span>])) {
</span><span class="l" id="377">377             <span class="php-var">$encodings</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-keyword2">strtolower</span>(<span class="php-keyword2">preg_replace</span>(<span class="php-quote">'/\s+/'</span>, <span class="php-quote">''</span>, <span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_ACCEPT_ENCODING'</span>])));
</span><span class="l" id="378">378         }
</span><span class="l" id="379">379 
</span><span class="l" id="380">380         <span class="php-keyword1">if</span> ((<span class="php-keyword2">in_array</span>(<span class="php-quote">'gzip'</span>, <span class="php-var">$encodings</span>) || <span class="php-keyword2">in_array</span>(<span class="php-quote">'x-gzip'</span>, <span class="php-var">$encodings</span>) || <span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'---------------'</span>]))
</span><span class="l" id="381">381             &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-quote">'ob_gzhandler'</span>)
</span><span class="l" id="382">382             &amp;&amp; !<span class="php-keyword2">ini_get</span>(<span class="php-quote">'zlib.output_compression'</span>)
</span><span class="l" id="383">383         ) {
</span><span class="l" id="384">384             <span class="php-var">$enc</span> = <span class="php-keyword2">in_array</span>(<span class="php-quote">'x-gzip'</span>, <span class="php-var">$encodings</span>) ? <span class="php-quote">'x-gzip'</span> : <span class="php-quote">'gzip'</span>;
</span><span class="l" id="385">385             <span class="php-var">$supportsGzip</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="386">386         }
</span><span class="l" id="387">387 
</span><span class="l" id="388">388         <span class="php-keyword1">if</span> (<span class="php-var">$supportsGzip</span>) {
</span><span class="l" id="389">389             <span class="php-keyword2">header</span>(<span class="php-quote">'Content-Encoding: '</span> . <span class="php-var">$enc</span>);
</span><span class="l" id="390">390             <span class="php-var">$content</span> = <span class="php-keyword2">gzencode</span>(<span class="php-var">$content</span>, <span class="php-num">9</span>, FORCE_GZIP);
</span><span class="l" id="391">391         }
</span><span class="l" id="392">392 
</span><span class="l" id="393">393         <span class="php-keyword1">return</span> <span class="php-var">$content</span>;
</span><span class="l" id="394">394     }
</span><span class="l" id="395">395 
</span><span class="l" id="396">396     <span class="php-comment">// method inspired by https://github.com/symfony/symfony/blob/master/src/Symfony/Component/HttpFoundation/Cookie.php</span>
</span><span class="l" id="397">397 
</span><span class="l" id="398">398     <span class="php-comment">/**
</span></span><span class="l" id="399">399 <span class="php-comment">     * @param string      $name    The name of the cookie
</span></span><span class="l" id="400">400 <span class="php-comment">     * @param string|null $value   The value of the cookie, a empty value to delete the cookie.
</span></span><span class="l" id="401">401 <span class="php-comment">     * @param array       $options Different cookie Options. Supported keys are:
</span></span><span class="l" id="402">402 <span class="php-comment">     *                             "expires" int|string|\DateTimeInterface The time the cookie expires
</span></span><span class="l" id="403">403 <span class="php-comment">     *                             "path" string                           The path on the server in which the cookie will be available on
</span></span><span class="l" id="404">404 <span class="php-comment">     *                             "domain" string|null                    The domain that the cookie is available to
</span></span><span class="l" id="405">405 <span class="php-comment">     *                             "secure" bool                           Whether the cookie should only be transmitted over a secure HTTPS connection from the client
</span></span><span class="l" id="406">406 <span class="php-comment">     *                             "httponly" bool                         Whether the cookie will be made accessible only through the HTTP protocol
</span></span><span class="l" id="407">407 <span class="php-comment">     *                             "samesite" string|null                  Whether the cookie will be available for cross-site requests
</span></span><span class="l" id="408">408 <span class="php-comment">     *                             "raw" bool                              Whether the cookie value should be sent with no url encoding
</span></span><span class="l" id="409">409 <span class="php-comment">     *
</span></span><span class="l" id="410">410 <span class="php-comment">     * @throws \InvalidArgumentException
</span></span><span class="l" id="411">411 <span class="php-comment">     */</span>
</span><span class="l" id="412">412     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> sendCookie(<span class="php-var">$name</span>, <span class="php-var">$value</span>, <span class="php-keyword1">array</span> <span class="php-var">$options</span> = [])
</span><span class="l" id="413">413     {
</span><span class="l" id="414">414         <span class="php-var">$expire</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[<span class="php-quote">'expires'</span>]) ? <span class="php-var">$options</span>[<span class="php-quote">'expires'</span>] : <span class="php-num">0</span>;
</span><span class="l" id="415">415         <span class="php-var">$path</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[<span class="php-quote">'path'</span>]) ? <span class="php-var">$options</span>[<span class="php-quote">'path'</span>] : <span class="php-quote">'/'</span>;
</span><span class="l" id="416">416         <span class="php-var">$domain</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[<span class="php-quote">'domain'</span>]) ? <span class="php-var">$options</span>[<span class="php-quote">'domain'</span>] : <span class="php-keyword1">null</span>;
</span><span class="l" id="417">417         <span class="php-var">$secure</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[<span class="php-quote">'secure'</span>]) ? <span class="php-var">$options</span>[<span class="php-quote">'secure'</span>] : <span class="php-keyword1">false</span>;
</span><span class="l" id="418">418         <span class="php-var">$httpOnly</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[<span class="php-quote">'httponly'</span>]) ? <span class="php-var">$options</span>[<span class="php-quote">'httponly'</span>] : <span class="php-keyword1">true</span>;
</span><span class="l" id="419">419         <span class="php-var">$sameSite</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[<span class="php-quote">'samesite'</span>]) ? <span class="php-var">$options</span>[<span class="php-quote">'samesite'</span>] : <span class="php-keyword1">null</span>;
</span><span class="l" id="420">420         <span class="php-var">$raw</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$options</span>[<span class="php-quote">'raw'</span>]) ? <span class="php-var">$options</span>[<span class="php-quote">'raw'</span>] : <span class="php-keyword1">false</span>;
</span><span class="l" id="421">421 
</span><span class="l" id="422">422         <span class="php-comment">// from PHP source code</span>
</span><span class="l" id="423">423         <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">"/[=,; \t\r\n\013\014]/"</span>, <span class="php-var">$name</span>)) {
</span><span class="l" id="424">424             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \InvalidArgumentException(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'The cookie name "%s" contains invalid characters.'</span>, <span class="php-var">$name</span>));
</span><span class="l" id="425">425         }
</span><span class="l" id="426">426         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$name</span>)) {
</span><span class="l" id="427">427             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \InvalidArgumentException(<span class="php-quote">'The cookie name cannot be empty.'</span>);
</span><span class="l" id="428">428         }
</span><span class="l" id="429">429         <span class="php-comment">// convert expiration time to a Unix timestamp</span>
</span><span class="l" id="430">430         <span class="php-keyword1">if</span> (<span class="php-var">$expire</span> <span class="php-keyword1">instanceof</span> \DateTimeInterface) {
</span><span class="l" id="431">431             <span class="php-var">$expire</span> = <span class="php-var">$expire</span>-&gt;format(<span class="php-quote">'U'</span>);
</span><span class="l" id="432">432         } <span class="php-keyword1">elseif</span> (!<span class="php-keyword2">is_numeric</span>(<span class="php-var">$expire</span>)) {
</span><span class="l" id="433">433             <span class="php-var">$expire</span> = <span class="php-keyword2">strtotime</span>(<span class="php-var">$expire</span>);
</span><span class="l" id="434">434             <span class="php-keyword1">if</span> (<span class="php-keyword1">false</span> === <span class="php-var">$expire</span>) {
</span><span class="l" id="435">435                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \InvalidArgumentException(<span class="php-quote">'The cookie expiration time is not valid.'</span>);
</span><span class="l" id="436">436             }
</span><span class="l" id="437">437         }
</span><span class="l" id="438">438 
</span><span class="l" id="439">439         <span class="php-var">$expire</span> = <span class="php-num">0</span> &lt; <span class="php-var">$expire</span> ? (int) <span class="php-var">$expire</span> : <span class="php-num">0</span>;
</span><span class="l" id="440">440         <span class="php-var">$maxAge</span> = <span class="php-var">$expire</span> - <span class="php-keyword2">time</span>();
</span><span class="l" id="441">441         <span class="php-var">$maxAge</span> = <span class="php-num">0</span> &gt;= <span class="php-var">$maxAge</span> ? <span class="php-num">0</span> : <span class="php-var">$maxAge</span>;
</span><span class="l" id="442">442         <span class="php-var">$path</span> = <span class="php-keyword1">empty</span>(<span class="php-var">$path</span>) ? <span class="php-quote">'/'</span> : <span class="php-var">$path</span>;
</span><span class="l" id="443">443 
</span><span class="l" id="444">444         <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> !== <span class="php-var">$sameSite</span>) {
</span><span class="l" id="445">445             <span class="php-var">$sameSite</span> = <span class="php-keyword2">strtolower</span>(<span class="php-var">$sameSite</span>);
</span><span class="l" id="446">446         }
</span><span class="l" id="447">447         <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$sameSite</span>, [<span class="php-quote">'lax'</span>, <span class="php-quote">'strict'</span>, <span class="php-keyword1">null</span>], <span class="php-keyword1">true</span>)) {
</span><span class="l" id="448">448             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \InvalidArgumentException(<span class="php-quote">'The "sameSite" parameter value is not valid.'</span>);
</span><span class="l" id="449">449         }
</span><span class="l" id="450">450 
</span><span class="l" id="451">451         <span class="php-var">$str</span> = <span class="php-quote">'Set-Cookie: '</span>. (<span class="php-var">$raw</span> ? <span class="php-var">$name</span> : <span class="php-keyword2">urlencode</span>(<span class="php-var">$name</span>)).<span class="php-quote">'='</span>;
</span><span class="l" id="452">452         <span class="php-keyword1">if</span> (<span class="php-quote">''</span> === (string) <span class="php-var">$value</span>) {
</span><span class="l" id="453">453             <span class="php-var">$str</span> .= <span class="php-quote">'deleted; expires='</span>.<span class="php-keyword2">gmdate</span>(<span class="php-quote">'D, d-M-Y H:i:s T'</span>, <span class="php-keyword2">time</span>() - <span class="php-num">31536001</span>).<span class="php-quote">'; Max-Age=0'</span>;
</span><span class="l" id="454">454         } <span class="php-keyword1">else</span> {
</span><span class="l" id="455">455             <span class="php-var">$str</span> .= <span class="php-var">$raw</span> ? <span class="php-var">$value</span> : <span class="php-keyword2">rawurlencode</span>(<span class="php-var">$value</span>);
</span><span class="l" id="456">456             <span class="php-keyword1">if</span> (<span class="php-num">0</span> !== <span class="php-var">$expire</span>) {
</span><span class="l" id="457">457                 <span class="php-var">$str</span> .= <span class="php-quote">'; expires='</span>.<span class="php-keyword2">gmdate</span>(<span class="php-quote">'D, d-M-Y H:i:s T'</span>, <span class="php-var">$expire</span>).<span class="php-quote">'; Max-Age='</span>.<span class="php-var">$maxAge</span>;
</span><span class="l" id="458">458             }
</span><span class="l" id="459">459         }
</span><span class="l" id="460">460         <span class="php-keyword1">if</span> (<span class="php-var">$path</span>) {
</span><span class="l" id="461">461             <span class="php-var">$str</span> .= <span class="php-quote">'; path='</span>.<span class="php-var">$path</span>;
</span><span class="l" id="462">462         }
</span><span class="l" id="463">463         <span class="php-keyword1">if</span> (<span class="php-var">$domain</span>) {
</span><span class="l" id="464">464             <span class="php-var">$str</span> .= <span class="php-quote">'; domain='</span>.<span class="php-var">$domain</span>;
</span><span class="l" id="465">465         }
</span><span class="l" id="466">466         <span class="php-keyword1">if</span> (<span class="php-var">$secure</span>) {
</span><span class="l" id="467">467             <span class="php-var">$str</span> .= <span class="php-quote">'; secure'</span>;
</span><span class="l" id="468">468         }
</span><span class="l" id="469">469         <span class="php-keyword1">if</span> (<span class="php-var">$httpOnly</span>) {
</span><span class="l" id="470">470             <span class="php-var">$str</span> .= <span class="php-quote">'; httponly'</span>;
</span><span class="l" id="471">471         }
</span><span class="l" id="472">472         <span class="php-keyword1">if</span> (<span class="php-var">$sameSite</span>) {
</span><span class="l" id="473">473             <span class="php-var">$str</span> .= <span class="php-quote">'; samesite='</span>.<span class="php-var">$sameSite</span>;
</span><span class="l" id="474">474         }
</span><span class="l" id="475">475 
</span><span class="l" id="476">476         <span class="php-keyword2">header</span>(<span class="php-var">$str</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="477">477     }
</span><span class="l" id="478">478 
</span><span class="l" id="479">479     <span class="php-comment">/**
</span></span><span class="l" id="480">480 <span class="php-comment">     * Creates the md5 checksum for the content.
</span></span><span class="l" id="481">481 <span class="php-comment">     *
</span></span><span class="l" id="482">482 <span class="php-comment">     * Dynamic content surrounded by `&lt;!--DYN--&gt;&lt;!--/DYN--&gt;` is ignored.
</span></span><span class="l" id="483">483 <span class="php-comment">     *
</span></span><span class="l" id="484">484 <span class="php-comment">     * @param string $content
</span></span><span class="l" id="485">485 <span class="php-comment">     *
</span></span><span class="l" id="486">486 <span class="php-comment">     * @return string
</span></span><span class="l" id="487">487 <span class="php-comment">     */</span>
</span><span class="l" id="488">488     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> <span class="php-keyword2">md5</span>(<span class="php-var">$content</span>)
</span><span class="l" id="489">489     {
</span><span class="l" id="490">490         <span class="php-keyword1">return</span> <span class="php-keyword2">md5</span>(<span class="php-keyword2">preg_replace</span>(<span class="php-quote">'@&lt;!--DYN--&gt;.*&lt;!--/DYN--&gt;@U'</span>, <span class="php-quote">''</span>, <span class="php-var">$content</span>));
</span><span class="l" id="491">491     }
</span><span class="l" id="492">492 
</span><span class="l" id="493">493     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> enforceHttps()
</span><span class="l" id="494">494     {
</span><span class="l" id="495">495         <span class="php-keyword1">if</span> (!rex_request::isHttps()) {
</span><span class="l" id="496">496             self::setStatus(self::HTTP_MOVED_PERMANENTLY);
</span><span class="l" id="497">497             self::sendRedirect(<span class="php-quote">'https://'</span>.<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_HOST'</span>].<span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_URI'</span>]);
</span><span class="l" id="498">498         }
</span><span class="l" id="499">499     }
</span><span class="l" id="500">500 }
</span><span class="l" id="501">501 </span></code></pre>
 </body>
</html>
