<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="5">  5 <span class="php-comment"> */</span>
</span><span class="l" id="6">  6 <span class="php-keyword1">class</span> rex_be_controller
</span><span class="l" id="7">  7 {
</span><span class="l" id="8">  8     <span class="php-comment">/**
</span></span><span class="l" id="9">  9 <span class="php-comment">     * @var string
</span></span><span class="l" id="10"> 10 <span class="php-comment">     */</span>
</span><span class="l" id="11"> 11     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$page</span>;
</span><span class="l" id="12"> 12 
</span><span class="l" id="13"> 13     <span class="php-comment">/**
</span></span><span class="l" id="14"> 14 <span class="php-comment">     * @var array
</span></span><span class="l" id="15"> 15 <span class="php-comment">     */</span>
</span><span class="l" id="16"> 16     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$pageParts</span> = [];
</span><span class="l" id="17"> 17 
</span><span class="l" id="18"> 18     <span class="php-comment">/**
</span></span><span class="l" id="19"> 19 <span class="php-comment">     * @var rex_be_page
</span></span><span class="l" id="20"> 20 <span class="php-comment">     */</span>
</span><span class="l" id="21"> 21     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$pageObject</span>;
</span><span class="l" id="22"> 22 
</span><span class="l" id="23"> 23     <span class="php-comment">/**
</span></span><span class="l" id="24"> 24 <span class="php-comment">     * @var rex_be_page[]
</span></span><span class="l" id="25"> 25 <span class="php-comment">     */</span>
</span><span class="l" id="26"> 26     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$pages</span> = [];
</span><span class="l" id="27"> 27 
</span><span class="l" id="28"> 28     <span class="php-comment">/**
</span></span><span class="l" id="29"> 29 <span class="php-comment">     * @param string $page
</span></span><span class="l" id="30"> 30 <span class="php-comment">     */</span>
</span><span class="l" id="31"> 31     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> setCurrentPage(<span class="php-var">$page</span>)
</span><span class="l" id="32"> 32     {
</span><span class="l" id="33"> 33         self::<span class="php-var">$page</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$page</span>, <span class="php-quote">'/ '</span>);
</span><span class="l" id="34"> 34         self::<span class="php-var">$pageParts</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'/'</span>, self::<span class="php-var">$page</span>);
</span><span class="l" id="35"> 35         self::<span class="php-var">$pageObject</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="36"> 36     }
</span><span class="l" id="37"> 37 
</span><span class="l" id="38"> 38     <span class="php-comment">/**
</span></span><span class="l" id="39"> 39 <span class="php-comment">     * @return string
</span></span><span class="l" id="40"> 40 <span class="php-comment">     */</span>
</span><span class="l" id="41"> 41     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getCurrentPage()
</span><span class="l" id="42"> 42     {
</span><span class="l" id="43"> 43         <span class="php-keyword1">return</span> self::<span class="php-var">$page</span>;
</span><span class="l" id="44"> 44     }
</span><span class="l" id="45"> 45 
</span><span class="l" id="46"> 46     <span class="php-comment">/**
</span></span><span class="l" id="47"> 47 <span class="php-comment">     * @param null|int    $part    Part index, beginning with 1. If $part is null, an array of all current parts will be returned
</span></span><span class="l" id="48"> 48 <span class="php-comment">     * @param null|string $default Default value
</span></span><span class="l" id="49"> 49 <span class="php-comment">     *
</span></span><span class="l" id="50"> 50 <span class="php-comment">     * @return array|string|null
</span></span><span class="l" id="51"> 51 <span class="php-comment">     */</span>
</span><span class="l" id="52"> 52     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getCurrentPagePart(<span class="php-var">$part</span> = <span class="php-keyword1">null</span>, <span class="php-var">$default</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="53"> 53     {
</span><span class="l" id="54"> 54         <span class="php-keyword1">if</span> (<span class="php-var">$part</span> === <span class="php-keyword1">null</span>) {
</span><span class="l" id="55"> 55             <span class="php-keyword1">return</span> self::<span class="php-var">$pageParts</span>;
</span><span class="l" id="56"> 56         }
</span><span class="l" id="57"> 57         --<span class="php-var">$part</span>;
</span><span class="l" id="58"> 58         <span class="php-keyword1">return</span> <span class="php-keyword1">isset</span>(self::<span class="php-var">$pageParts</span>[<span class="php-var">$part</span>]) ? self::<span class="php-var">$pageParts</span>[<span class="php-var">$part</span>] : <span class="php-var">$default</span>;
</span><span class="l" id="59"> 59     }
</span><span class="l" id="60"> 60 
</span><span class="l" id="61"> 61     <span class="php-comment">/**
</span></span><span class="l" id="62"> 62 <span class="php-comment">     * @return rex_be_page
</span></span><span class="l" id="63"> 63 <span class="php-comment">     */</span>
</span><span class="l" id="64"> 64     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getCurrentPageObject()
</span><span class="l" id="65"> 65     {
</span><span class="l" id="66"> 66         <span class="php-keyword1">if</span> (!self::<span class="php-var">$pageObject</span>) {
</span><span class="l" id="67"> 67             self::<span class="php-var">$pageObject</span> = self::getPageObject(self::getCurrentPage());
</span><span class="l" id="68"> 68         }
</span><span class="l" id="69"> 69         <span class="php-keyword1">return</span> self::<span class="php-var">$pageObject</span>;
</span><span class="l" id="70"> 70     }
</span><span class="l" id="71"> 71 
</span><span class="l" id="72"> 72     <span class="php-comment">/**
</span></span><span class="l" id="73"> 73 <span class="php-comment">     * @param string|array $page
</span></span><span class="l" id="74"> 74 <span class="php-comment">     *
</span></span><span class="l" id="75"> 75 <span class="php-comment">     * @return rex_be_page
</span></span><span class="l" id="76"> 76 <span class="php-comment">     */</span>
</span><span class="l" id="77"> 77     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getPageObject(<span class="php-var">$page</span>)
</span><span class="l" id="78"> 78     {
</span><span class="l" id="79"> 79         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$page</span>)) {
</span><span class="l" id="80"> 80             <span class="php-var">$page</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'/'</span>, <span class="php-var">$page</span>);
</span><span class="l" id="81"> 81         }
</span><span class="l" id="82"> 82         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$page</span>[<span class="php-num">0</span>]) || !<span class="php-keyword1">isset</span>(self::<span class="php-var">$pages</span>[<span class="php-var">$page</span>[<span class="php-num">0</span>]])) {
</span><span class="l" id="83"> 83             <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="84"> 84         }
</span><span class="l" id="85"> 85         <span class="php-var">$obj</span> = self::<span class="php-var">$pages</span>[<span class="php-var">$page</span>[<span class="php-num">0</span>]];
</span><span class="l" id="86"> 86         <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>, <span class="php-var">$count</span> = <span class="php-keyword2">count</span>(<span class="php-var">$page</span>); <span class="php-var">$i</span> &lt; <span class="php-var">$count</span>; ++<span class="php-var">$i</span>) {
</span><span class="l" id="87"> 87             <span class="php-keyword1">if</span> (<span class="php-var">$new</span> = <span class="php-var">$obj</span>-&gt;getSubpage(<span class="php-var">$page</span>[<span class="php-var">$i</span>])) {
</span><span class="l" id="88"> 88                 <span class="php-var">$obj</span> = <span class="php-var">$new</span>;
</span><span class="l" id="89"> 89             } <span class="php-keyword1">else</span> {
</span><span class="l" id="90"> 90                 <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="91"> 91             }
</span><span class="l" id="92"> 92         }
</span><span class="l" id="93"> 93         <span class="php-keyword1">return</span> <span class="php-var">$obj</span>;
</span><span class="l" id="94"> 94     }
</span><span class="l" id="95"> 95 
</span><span class="l" id="96"> 96     <span class="php-comment">/**
</span></span><span class="l" id="97"> 97 <span class="php-comment">     * @return rex_be_page[]
</span></span><span class="l" id="98"> 98 <span class="php-comment">     */</span>
</span><span class="l" id="99"> 99     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getPages()
</span><span class="l" id="100">100     {
</span><span class="l" id="101">101         <span class="php-keyword1">return</span> self::<span class="php-var">$pages</span>;
</span><span class="l" id="102">102     }
</span><span class="l" id="103">103 
</span><span class="l" id="104">104     <span class="php-comment">/**
</span></span><span class="l" id="105">105 <span class="php-comment">     * @param rex_be_page[] $pages
</span></span><span class="l" id="106">106 <span class="php-comment">     */</span>
</span><span class="l" id="107">107     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> setPages(<span class="php-keyword1">array</span> <span class="php-var">$pages</span>)
</span><span class="l" id="108">108     {
</span><span class="l" id="109">109         self::<span class="php-var">$pages</span> = <span class="php-var">$pages</span>;
</span><span class="l" id="110">110     }
</span><span class="l" id="111">111 
</span><span class="l" id="112">112     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getPageTitle()
</span><span class="l" id="113">113     {
</span><span class="l" id="114">114         <span class="php-var">$parts</span> = [];
</span><span class="l" id="115">115 
</span><span class="l" id="116">116         <span class="php-var">$activePageObj</span> = self::getCurrentPageObject();
</span><span class="l" id="117">117         <span class="php-keyword1">if</span> (<span class="php-var">$activePageObj</span>-&gt;getTitle()) {
</span><span class="l" id="118">118             <span class="php-var">$parts</span>[] = <span class="php-var">$activePageObj</span>-&gt;getTitle();
</span><span class="l" id="119">119         }
</span><span class="l" id="120">120         <span class="php-keyword1">if</span> (rex::getServerName()) {
</span><span class="l" id="121">121             <span class="php-var">$parts</span>[] = rex::getServerName();
</span><span class="l" id="122">122         }
</span><span class="l" id="123">123         <span class="php-var">$parts</span>[] = <span class="php-quote">'REDAXO CMS'</span>;
</span><span class="l" id="124">124 
</span><span class="l" id="125">125         <span class="php-keyword1">return</span> <span class="php-keyword2">implode</span>(<span class="php-quote">' Â· '</span>, <span class="php-var">$parts</span>);
</span><span class="l" id="126">126     }
</span><span class="l" id="127">127 
</span><span class="l" id="128">128     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getSetupPage()
</span><span class="l" id="129">129     {
</span><span class="l" id="130">130         <span class="php-var">$page</span> = <span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'setup'</span>, rex_i18n::msg(<span class="php-quote">'setup'</span>));
</span><span class="l" id="131">131         <span class="php-var">$page</span>-&gt;setPath(rex_path::core(<span class="php-quote">'pages/setup.php'</span>));
</span><span class="l" id="132">132         <span class="php-keyword1">return</span> <span class="php-var">$page</span>;
</span><span class="l" id="133">133     }
</span><span class="l" id="134">134 
</span><span class="l" id="135">135     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getLoginPage()
</span><span class="l" id="136">136     {
</span><span class="l" id="137">137         <span class="php-var">$page</span> = <span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'login'</span>, <span class="php-quote">'Login'</span>);
</span><span class="l" id="138">138         <span class="php-var">$page</span>-&gt;setPath(rex_path::core(<span class="php-quote">'pages/login.php'</span>));
</span><span class="l" id="139">139         <span class="php-var">$page</span>-&gt;setHasNavigation(<span class="php-keyword1">false</span>);
</span><span class="l" id="140">140         <span class="php-keyword1">return</span> <span class="php-var">$page</span>;
</span><span class="l" id="141">141     }
</span><span class="l" id="142">142 
</span><span class="l" id="143">143     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> appendLoggedInPages()
</span><span class="l" id="144">144     {
</span><span class="l" id="145">145         self::<span class="php-var">$pages</span>[<span class="php-quote">'profile'</span>] = (<span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'profile'</span>, rex_i18n::msg(<span class="php-quote">'profile'</span>)))
</span><span class="l" id="146">146             -&gt;setPath(rex_path::core(<span class="php-quote">'pages/profile.php'</span>))
</span><span class="l" id="147">147             -&gt;setPjax();
</span><span class="l" id="148">148 
</span><span class="l" id="149">149         self::<span class="php-var">$pages</span>[<span class="php-quote">'credits'</span>] = (<span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'credits'</span>, rex_i18n::msg(<span class="php-quote">'credits'</span>)))
</span><span class="l" id="150">150             -&gt;setPath(rex_path::core(<span class="php-quote">'pages/credits.php'</span>));
</span><span class="l" id="151">151 
</span><span class="l" id="152">152         self::<span class="php-var">$pages</span>[<span class="php-quote">'packages'</span>] = (<span class="php-keyword1">new</span> rex_be_page_main(<span class="php-quote">'system'</span>, <span class="php-quote">'packages'</span>, rex_i18n::msg(<span class="php-quote">'addons'</span>)))
</span><span class="l" id="153">153             -&gt;setPath(rex_path::core(<span class="php-quote">'pages/packages.php'</span>))
</span><span class="l" id="154">154             -&gt;setRequiredPermissions(<span class="php-quote">'isAdmin'</span>)
</span><span class="l" id="155">155             -&gt;setPrio(<span class="php-num">60</span>)
</span><span class="l" id="156">156             -&gt;setPjax()
</span><span class="l" id="157">157             -&gt;setIcon(<span class="php-quote">'rex-icon rex-icon-package-addon'</span>);
</span><span class="l" id="158">158 
</span><span class="l" id="159">159         self::<span class="php-var">$pages</span>[<span class="php-quote">'system'</span>] = (<span class="php-keyword1">new</span> rex_be_page_main(<span class="php-quote">'system'</span>, <span class="php-quote">'system'</span>, rex_i18n::msg(<span class="php-quote">'system'</span>)))
</span><span class="l" id="160">160             -&gt;setPath(rex_path::core(<span class="php-quote">'pages/system.php'</span>))
</span><span class="l" id="161">161             -&gt;setRequiredPermissions(<span class="php-quote">'isAdmin'</span>)
</span><span class="l" id="162">162             -&gt;setPrio(<span class="php-num">70</span>)
</span><span class="l" id="163">163             -&gt;setPjax()
</span><span class="l" id="164">164             -&gt;setIcon(<span class="php-quote">'rex-icon rex-icon-system'</span>)
</span><span class="l" id="165">165             -&gt;addSubpage((<span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'settings'</span>, rex_i18n::msg(<span class="php-quote">'main_preferences'</span>)))-&gt;setSubPath(rex_path::core(<span class="php-quote">'pages/system.settings.php'</span>)))
</span><span class="l" id="166">166             -&gt;addSubpage((<span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'lang'</span>, rex_i18n::msg(<span class="php-quote">'languages'</span>)))-&gt;setSubPath(rex_path::core(<span class="php-quote">'pages/system.clangs.php'</span>)))
</span><span class="l" id="167">167             -&gt;addSubpage((<span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'log'</span>, rex_i18n::msg(<span class="php-quote">'syslog'</span>)))-&gt;setSubPath(rex_path::core(<span class="php-quote">'pages/system.log.php'</span>)))
</span><span class="l" id="168">168             -&gt;addSubpage((<span class="php-keyword1">new</span> rex_be_page(<span class="php-quote">'phpinfo'</span>, <span class="php-quote">'phpinfo'</span>))
</span><span class="l" id="169">169                 -&gt;setHidden(<span class="php-keyword1">true</span>)
</span><span class="l" id="170">170                 -&gt;setHasLayout(<span class="php-keyword1">false</span>)
</span><span class="l" id="171">171                 -&gt;setPath(rex_path::core(<span class="php-quote">'pages/system.phpinfo.php'</span>))
</span><span class="l" id="172">172             );
</span><span class="l" id="173">173     }
</span><span class="l" id="174">174 
</span><span class="l" id="175">175     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> appendPackagePages()
</span><span class="l" id="176">176     {
</span><span class="l" id="177">177         <span class="php-var">$insertPages</span> = [];
</span><span class="l" id="178">178         <span class="php-var">$addons</span> = rex::isSafeMode() ? rex_addon::getSetupAddons() : rex_addon::getAvailableAddons();
</span><span class="l" id="179">179         <span class="php-keyword1">foreach</span> (<span class="php-var">$addons</span> <span class="php-keyword1">as</span> <span class="php-var">$addon</span>) {
</span><span class="l" id="180">180             <span class="php-var">$mainPage</span> = self::pageCreate(<span class="php-var">$addon</span>-&gt;getProperty(<span class="php-quote">'page'</span>), <span class="php-var">$addon</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="181">181 
</span><span class="l" id="182">182             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$pages</span> = <span class="php-var">$addon</span>-&gt;getProperty(<span class="php-quote">'pages'</span>))) {
</span><span class="l" id="183">183                 <span class="php-keyword1">foreach</span> (<span class="php-var">$pages</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$page</span>) {
</span><span class="l" id="184">184                     <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$key</span>, <span class="php-quote">'/'</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="185">185                         <span class="php-var">$insertPages</span>[<span class="php-var">$key</span>] = [<span class="php-var">$addon</span>, <span class="php-var">$page</span>];
</span><span class="l" id="186">186                     } <span class="php-keyword1">else</span> {
</span><span class="l" id="187">187                         self::pageCreate(<span class="php-var">$page</span>, <span class="php-var">$addon</span>, <span class="php-keyword1">false</span>, <span class="php-var">$mainPage</span>, <span class="php-var">$key</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="188">188                     }
</span><span class="l" id="189">189                 }
</span><span class="l" id="190">190             }
</span><span class="l" id="191">191 
</span><span class="l" id="192">192             <span class="php-comment">// handle plugins</span>
</span><span class="l" id="193">193             <span class="php-var">$plugins</span> = rex::isSafeMode() ? <span class="php-var">$addon</span>-&gt;getSystemPlugins() : <span class="php-var">$addon</span>-&gt;getAvailablePlugins();
</span><span class="l" id="194">194             <span class="php-keyword1">foreach</span> (<span class="php-var">$plugins</span> <span class="php-keyword1">as</span> <span class="php-var">$plugin</span>) {
</span><span class="l" id="195">195                 self::pageCreate(<span class="php-var">$plugin</span>-&gt;getProperty(<span class="php-quote">'page'</span>), <span class="php-var">$plugin</span>, <span class="php-keyword1">false</span>, <span class="php-var">$mainPage</span>);
</span><span class="l" id="196">196 
</span><span class="l" id="197">197                 <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$pages</span> = <span class="php-var">$plugin</span>-&gt;getProperty(<span class="php-quote">'pages'</span>))) {
</span><span class="l" id="198">198                     <span class="php-keyword1">foreach</span> (<span class="php-var">$pages</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$page</span>) {
</span><span class="l" id="199">199                         <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$key</span>, <span class="php-quote">'/'</span>) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="200">200                             <span class="php-var">$insertPages</span>[<span class="php-var">$key</span>] = [<span class="php-var">$plugin</span>, <span class="php-var">$page</span>];
</span><span class="l" id="201">201                         } <span class="php-keyword1">else</span> {
</span><span class="l" id="202">202                             self::pageCreate(<span class="php-var">$page</span>, <span class="php-var">$plugin</span>, <span class="php-keyword1">false</span>, <span class="php-var">$mainPage</span>, <span class="php-var">$key</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="203">203                         }
</span><span class="l" id="204">204                     }
</span><span class="l" id="205">205                 }
</span><span class="l" id="206">206             }
</span><span class="l" id="207">207         }
</span><span class="l" id="208">208         <span class="php-keyword1">foreach</span> (<span class="php-var">$insertPages</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$packagePage</span>) {
</span><span class="l" id="209">209             <span class="php-keyword1">list</span>(<span class="php-var">$package</span>, <span class="php-var">$page</span>) = <span class="php-var">$packagePage</span>;
</span><span class="l" id="210">210             <span class="php-var">$key</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'/'</span>, <span class="php-var">$key</span>);
</span><span class="l" id="211">211             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$pages</span>[<span class="php-var">$key</span>[<span class="php-num">0</span>]])) {
</span><span class="l" id="212">212                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="213">213             }
</span><span class="l" id="214">214             <span class="php-var">$parentPage</span> = self::<span class="php-var">$pages</span>[<span class="php-var">$key</span>[<span class="php-num">0</span>]];
</span><span class="l" id="215">215             <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>, <span class="php-var">$count</span> = <span class="php-keyword2">count</span>(<span class="php-var">$key</span>) - <span class="php-num">1</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$count</span> &amp;&amp; <span class="php-var">$parentPage</span>; ++<span class="php-var">$i</span>) {
</span><span class="l" id="216">216                 <span class="php-var">$parentPage</span> = <span class="php-var">$parentPage</span>-&gt;getSubpage(<span class="php-var">$key</span>[<span class="php-var">$i</span>]);
</span><span class="l" id="217">217             }
</span><span class="l" id="218">218             <span class="php-keyword1">if</span> (<span class="php-var">$parentPage</span>) {
</span><span class="l" id="219">219                 self::pageCreate(<span class="php-var">$page</span>, <span class="php-var">$package</span>, <span class="php-keyword1">false</span>, <span class="php-var">$parentPage</span>, <span class="php-var">$key</span>[<span class="php-var">$i</span>], <span class="php-keyword2">strtr</span>(<span class="php-var">$parentPage</span>-&gt;getFullKey(), <span class="php-quote">'/'</span>, <span class="php-quote">'.'</span>) . <span class="php-quote">'.'</span> . <span class="php-var">$key</span>[<span class="php-var">$i</span>] . <span class="php-quote">'.'</span>);
</span><span class="l" id="220">220             }
</span><span class="l" id="221">221         }
</span><span class="l" id="222">222     }
</span><span class="l" id="223">223 
</span><span class="l" id="224">224     <span class="php-comment">/**
</span></span><span class="l" id="225">225 <span class="php-comment">     * @param rex_be_page|array $page
</span></span><span class="l" id="226">226 <span class="php-comment">     * @param rex_package       $package
</span></span><span class="l" id="227">227 <span class="php-comment">     * @param bool              $createMainPage
</span></span><span class="l" id="228">228 <span class="php-comment">     * @param rex_be_page|null  $parentPage
</span></span><span class="l" id="229">229 <span class="php-comment">     * @param string            $pageKey
</span></span><span class="l" id="230">230 <span class="php-comment">     * @param bool              $prefix
</span></span><span class="l" id="231">231 <span class="php-comment">     *
</span></span><span class="l" id="232">232 <span class="php-comment">     * @return null|rex_be_page
</span></span><span class="l" id="233">233 <span class="php-comment">     */</span>
</span><span class="l" id="234">234     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> pageCreate(<span class="php-var">$page</span>, rex_package <span class="php-var">$package</span>, <span class="php-var">$createMainPage</span>, rex_be_page <span class="php-var">$parentPage</span> = <span class="php-keyword1">null</span>, <span class="php-var">$pageKey</span> = <span class="php-keyword1">null</span>, <span class="php-var">$prefix</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="235">235     {
</span><span class="l" id="236">236         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$page</span>) &amp;&amp; <span class="php-keyword1">isset</span>(<span class="php-var">$page</span>[<span class="php-quote">'title'</span>])) {
</span><span class="l" id="237">237             <span class="php-var">$pageArray</span> = <span class="php-var">$page</span>;
</span><span class="l" id="238">238             <span class="php-var">$pageKey</span> = <span class="php-var">$pageKey</span> ?: <span class="php-var">$package</span>-&gt;getName();
</span><span class="l" id="239">239             <span class="php-keyword1">if</span> (<span class="php-var">$createMainPage</span> || <span class="php-keyword1">isset</span>(<span class="php-var">$pageArray</span>[<span class="php-quote">'main'</span>]) &amp;&amp; <span class="php-var">$pageArray</span>[<span class="php-quote">'main'</span>]) {
</span><span class="l" id="240">240                 <span class="php-var">$page</span> = <span class="php-keyword1">new</span> rex_be_page_main(<span class="php-quote">'addons'</span>, <span class="php-var">$pageKey</span>, <span class="php-var">$pageArray</span>[<span class="php-quote">'title'</span>]);
</span><span class="l" id="241">241             } <span class="php-keyword1">else</span> {
</span><span class="l" id="242">242                 <span class="php-var">$page</span> = <span class="php-keyword1">new</span> rex_be_page(<span class="php-var">$pageKey</span>, <span class="php-var">$pageArray</span>[<span class="php-quote">'title'</span>]);
</span><span class="l" id="243">243             }
</span><span class="l" id="244">244             self::pageAddProperties(<span class="php-var">$page</span>, <span class="php-var">$pageArray</span>, <span class="php-var">$package</span>);
</span><span class="l" id="245">245         }
</span><span class="l" id="246">246 
</span><span class="l" id="247">247         <span class="php-keyword1">if</span> (<span class="php-var">$page</span> <span class="php-keyword1">instanceof</span> rex_be_page) {
</span><span class="l" id="248">248             <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$prefix</span>)) {
</span><span class="l" id="249">249                 <span class="php-var">$prefix</span> = <span class="php-var">$prefix</span> ? <span class="php-var">$page</span>-&gt;getKey() . <span class="php-quote">'.'</span> : <span class="php-quote">''</span>;
</span><span class="l" id="250">250             }
</span><span class="l" id="251">251             <span class="php-keyword1">if</span> (<span class="php-var">$page</span> <span class="php-keyword1">instanceof</span> rex_be_page_main) {
</span><span class="l" id="252">252                 <span class="php-keyword1">if</span> (!<span class="php-var">$page</span>-&gt;hasPath()) {
</span><span class="l" id="253">253                     <span class="php-var">$page</span>-&gt;setPath(<span class="php-var">$package</span>-&gt;getPath(<span class="php-quote">'pages/'</span> . (<span class="php-var">$prefix</span> ?: <span class="php-quote">'index.'</span>) . <span class="php-quote">'php'</span>));
</span><span class="l" id="254">254                 }
</span><span class="l" id="255">255                 self::<span class="php-var">$pages</span>[<span class="php-var">$page</span>-&gt;getKey()] = <span class="php-var">$page</span>;
</span><span class="l" id="256">256             } <span class="php-keyword1">else</span> {
</span><span class="l" id="257">257                 <span class="php-keyword1">if</span> (!<span class="php-var">$page</span>-&gt;hasSubPath()) {
</span><span class="l" id="258">258                     <span class="php-var">$page</span>-&gt;setSubPath(<span class="php-var">$package</span>-&gt;getPath(<span class="php-quote">'pages/'</span> . (<span class="php-var">$prefix</span> ?: <span class="php-quote">'index.'</span>) . <span class="php-quote">'php'</span>));
</span><span class="l" id="259">259                 }
</span><span class="l" id="260">260                 <span class="php-keyword1">if</span> (<span class="php-var">$parentPage</span>) {
</span><span class="l" id="261">261                     <span class="php-var">$parentPage</span>-&gt;addSubpage(<span class="php-var">$page</span>);
</span><span class="l" id="262">262                 }
</span><span class="l" id="263">263             }
</span><span class="l" id="264">264             self::pageSetSubPaths(<span class="php-var">$page</span>, <span class="php-var">$package</span>, <span class="php-var">$prefix</span>);
</span><span class="l" id="265">265             <span class="php-keyword1">return</span> <span class="php-var">$page</span>;
</span><span class="l" id="266">266         }
</span><span class="l" id="267">267         <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="268">268     }
</span><span class="l" id="269">269 
</span><span class="l" id="270">270     <span class="php-comment">/**
</span></span><span class="l" id="271">271 <span class="php-comment">     * @param rex_be_page $page
</span></span><span class="l" id="272">272 <span class="php-comment">     * @param rex_package $package
</span></span><span class="l" id="273">273 <span class="php-comment">     * @param string      $prefix
</span></span><span class="l" id="274">274 <span class="php-comment">     */</span>
</span><span class="l" id="275">275     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> pageSetSubPaths(rex_be_page <span class="php-var">$page</span>, rex_package <span class="php-var">$package</span>, <span class="php-var">$prefix</span> = <span class="php-quote">''</span>)
</span><span class="l" id="276">276     {
</span><span class="l" id="277">277         <span class="php-keyword1">foreach</span> (<span class="php-var">$page</span>-&gt;getSubpages() <span class="php-keyword1">as</span> <span class="php-var">$subpage</span>) {
</span><span class="l" id="278">278             <span class="php-keyword1">if</span> (!<span class="php-var">$subpage</span>-&gt;hasSubPath()) {
</span><span class="l" id="279">279                 <span class="php-var">$subpage</span>-&gt;setSubPath(<span class="php-var">$package</span>-&gt;getPath(<span class="php-quote">'pages/'</span> . <span class="php-var">$prefix</span> . <span class="php-var">$subpage</span>-&gt;getKey() . <span class="php-quote">'.php'</span>));
</span><span class="l" id="280">280             }
</span><span class="l" id="281">281             self::pageSetSubPaths(<span class="php-var">$subpage</span>, <span class="php-var">$package</span>, <span class="php-var">$prefix</span> . <span class="php-var">$subpage</span>-&gt;getKey() . <span class="php-quote">'.'</span>);
</span><span class="l" id="282">282         }
</span><span class="l" id="283">283     }
</span><span class="l" id="284">284 
</span><span class="l" id="285">285     <span class="php-comment">/**
</span></span><span class="l" id="286">286 <span class="php-comment">     * @param rex_be_page $page
</span></span><span class="l" id="287">287 <span class="php-comment">     * @param array       $properties
</span></span><span class="l" id="288">288 <span class="php-comment">     * @param rex_package $package
</span></span><span class="l" id="289">289 <span class="php-comment">     */</span>
</span><span class="l" id="290">290     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> pageAddProperties(rex_be_page <span class="php-var">$page</span>, <span class="php-keyword1">array</span> <span class="php-var">$properties</span>, rex_package <span class="php-var">$package</span>)
</span><span class="l" id="291">291     {
</span><span class="l" id="292">292         <span class="php-keyword1">foreach</span> (<span class="php-var">$properties</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$value</span>) {
</span><span class="l" id="293">293             <span class="php-keyword1">switch</span> (<span class="php-keyword2">strtolower</span>(<span class="php-var">$key</span>)) {
</span><span class="l" id="294">294                 <span class="php-keyword1">case</span> <span class="php-quote">'subpages'</span>:
</span><span class="l" id="295">295                     <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$value</span>)) {
</span><span class="l" id="296">296                         <span class="php-keyword1">foreach</span> (<span class="php-var">$value</span> <span class="php-keyword1">as</span> <span class="php-var">$pageKey</span> =&gt; <span class="php-var">$subProperties</span>) {
</span><span class="l" id="297">297                             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$subProperties</span>[<span class="php-quote">'title'</span>])) {
</span><span class="l" id="298">298                                 <span class="php-var">$subpage</span> = <span class="php-keyword1">new</span> rex_be_page(<span class="php-var">$pageKey</span>, <span class="php-var">$subProperties</span>[<span class="php-quote">'title'</span>]);
</span><span class="l" id="299">299                                 <span class="php-var">$page</span>-&gt;addSubpage(<span class="php-var">$subpage</span>);
</span><span class="l" id="300">300                                 self::pageAddProperties(<span class="php-var">$subpage</span>, <span class="php-var">$subProperties</span>, <span class="php-var">$package</span>);
</span><span class="l" id="301">301                             }
</span><span class="l" id="302">302                         }
</span><span class="l" id="303">303                     }
</span><span class="l" id="304">304                     <span class="php-keyword1">break</span>;
</span><span class="l" id="305">305 
</span><span class="l" id="306">306                 <span class="php-keyword1">case</span> <span class="php-quote">'itemattr'</span>:
</span><span class="l" id="307">307                 <span class="php-keyword1">case</span> <span class="php-quote">'linkattr'</span>:
</span><span class="l" id="308">308                     <span class="php-var">$setter</span> = [<span class="php-var">$page</span>, <span class="php-quote">'set'</span> . <span class="php-keyword2">ucfirst</span>(<span class="php-var">$key</span>)];
</span><span class="l" id="309">309                     <span class="php-keyword1">foreach</span> (<span class="php-var">$value</span> <span class="php-keyword1">as</span> <span class="php-var">$k</span> =&gt; <span class="php-var">$v</span>) {
</span><span class="l" id="310">310                         <span class="php-keyword2">call_user_func</span>(<span class="php-var">$setter</span>, <span class="php-var">$k</span>, <span class="php-var">$v</span>);
</span><span class="l" id="311">311                     }
</span><span class="l" id="312">312                     <span class="php-keyword1">break</span>;
</span><span class="l" id="313">313 
</span><span class="l" id="314">314                 <span class="php-keyword1">case</span> <span class="php-quote">'perm'</span>:
</span><span class="l" id="315">315                     <span class="php-var">$page</span>-&gt;setRequiredPermissions(<span class="php-var">$value</span>);
</span><span class="l" id="316">316                     <span class="php-keyword1">break</span>;
</span><span class="l" id="317">317 
</span><span class="l" id="318">318                 <span class="php-keyword1">case</span> <span class="php-quote">'path'</span>:
</span><span class="l" id="319">319                 <span class="php-keyword1">case</span> <span class="php-quote">'subpath'</span>:
</span><span class="l" id="320">320                     <span class="php-keyword1">if</span> (<span class="php-keyword2">file_exists</span>(<span class="php-var">$path</span> = <span class="php-var">$package</span>-&gt;getPath(<span class="php-var">$value</span>))) {
</span><span class="l" id="321">321                         <span class="php-var">$value</span> = <span class="php-var">$path</span>;
</span><span class="l" id="322">322                     }
</span><span class="l" id="323">323                     <span class="php-comment">// no break</span>
</span><span class="l" id="324">324                 <span class="php-keyword1">default</span>:
</span><span class="l" id="325">325                     <span class="php-var">$setter</span> = [<span class="php-var">$page</span>, <span class="php-quote">'add'</span> . <span class="php-keyword2">ucfirst</span>(<span class="php-var">$key</span>)];
</span><span class="l" id="326">326                     <span class="php-keyword1">if</span> (<span class="php-keyword2">is_callable</span>(<span class="php-var">$setter</span>)) {
</span><span class="l" id="327">327                         <span class="php-keyword1">foreach</span> ((<span class="php-keyword1">array</span>) <span class="php-var">$value</span> <span class="php-keyword1">as</span> <span class="php-var">$v</span>) {
</span><span class="l" id="328">328                             <span class="php-keyword2">call_user_func</span>(<span class="php-var">$setter</span>, <span class="php-var">$v</span>);
</span><span class="l" id="329">329                         }
</span><span class="l" id="330">330                         <span class="php-keyword1">break</span>;
</span><span class="l" id="331">331                     }
</span><span class="l" id="332">332                     <span class="php-var">$setter</span> = [<span class="php-var">$page</span>, <span class="php-quote">'set'</span> . <span class="php-keyword2">ucfirst</span>(<span class="php-var">$key</span>)];
</span><span class="l" id="333">333                     <span class="php-keyword1">if</span> (<span class="php-keyword2">is_callable</span>(<span class="php-var">$setter</span>)) {
</span><span class="l" id="334">334                         <span class="php-keyword2">call_user_func</span>(<span class="php-var">$setter</span>, <span class="php-var">$value</span>);
</span><span class="l" id="335">335                     }
</span><span class="l" id="336">336             }
</span><span class="l" id="337">337         }
</span><span class="l" id="338">338     }
</span><span class="l" id="339">339 
</span><span class="l" id="340">340     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> checkPagePermissions(rex_user <span class="php-var">$user</span>)
</span><span class="l" id="341">341     {
</span><span class="l" id="342">342         <span class="php-var">$check</span> = <span class="php-keyword1">function</span> (rex_be_page <span class="php-var">$page</span>) <span class="php-keyword1">use</span> (&amp;<span class="php-var">$check</span>, <span class="php-var">$user</span>) {
</span><span class="l" id="343">343             <span class="php-keyword1">if</span> (!<span class="php-var">$page</span>-&gt;checkPermission(<span class="php-var">$user</span>)) {
</span><span class="l" id="344">344                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="345">345             }
</span><span class="l" id="346">346 
</span><span class="l" id="347">347             <span class="php-var">$subpages</span> = <span class="php-var">$page</span>-&gt;getSubpages();
</span><span class="l" id="348">348             <span class="php-keyword1">foreach</span> (<span class="php-var">$subpages</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$subpage</span>) {
</span><span class="l" id="349">349                 <span class="php-keyword1">if</span> (!<span class="php-var">$check</span>(<span class="php-var">$subpage</span>)) {
</span><span class="l" id="350">350                     <span class="php-keyword1">unset</span>(<span class="php-var">$subpages</span>[<span class="php-var">$key</span>]);
</span><span class="l" id="351">351                 }
</span><span class="l" id="352">352             }
</span><span class="l" id="353">353             <span class="php-var">$page</span>-&gt;setSubpages(<span class="php-var">$subpages</span>);
</span><span class="l" id="354">354 
</span><span class="l" id="355">355             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="356">356         };
</span><span class="l" id="357">357 
</span><span class="l" id="358">358         <span class="php-keyword1">foreach</span> (self::<span class="php-var">$pages</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$page</span>) {
</span><span class="l" id="359">359             <span class="php-keyword1">if</span> (!<span class="php-var">$check</span>(<span class="php-var">$page</span>)) {
</span><span class="l" id="360">360                 <span class="php-keyword1">unset</span>(self::<span class="php-var">$pages</span>[<span class="php-var">$key</span>]);
</span><span class="l" id="361">361             }
</span><span class="l" id="362">362         }
</span><span class="l" id="363">363         self::<span class="php-var">$pageObject</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="364">364 
</span><span class="l" id="365">365         <span class="php-var">$page</span> = self::getCurrentPageObject();
</span><span class="l" id="366">366         <span class="php-comment">// --- page pruefen und benoetigte rechte checken</span>
</span><span class="l" id="367">367         <span class="php-keyword1">if</span> (!<span class="php-var">$page</span>) {
</span><span class="l" id="368">368             <span class="php-comment">// --- fallback zur user startpage -&gt; rechte checken</span>
</span><span class="l" id="369">369             <span class="php-var">$page</span> = self::getPageObject(<span class="php-var">$user</span>-&gt;getStartPage());
</span><span class="l" id="370">370             <span class="php-keyword1">if</span> (!<span class="php-var">$page</span>) {
</span><span class="l" id="371">371                 <span class="php-comment">// --- fallback zur system startpage -&gt; rechte checken</span>
</span><span class="l" id="372">372                 <span class="php-var">$page</span> = self::getPageObject(rex::getProperty(<span class="php-quote">'start_page'</span>));
</span><span class="l" id="373">373                 <span class="php-keyword1">if</span> (!<span class="php-var">$page</span>) {
</span><span class="l" id="374">374                     <span class="php-comment">// --- fallback zur profile page</span>
</span><span class="l" id="375">375                     <span class="php-var">$page</span> = self::getPageObject(<span class="php-quote">'profile'</span>);
</span><span class="l" id="376">376                 }
</span><span class="l" id="377">377             }
</span><span class="l" id="378">378             rex_response::setStatus(rex_response::HTTP_NOT_FOUND);
</span><span class="l" id="379">379             rex_response::sendRedirect(<span class="php-var">$page</span>-&gt;getHref());
</span><span class="l" id="380">380         }
</span><span class="l" id="381">381         <span class="php-keyword1">if</span> (<span class="php-var">$page</span> !== <span class="php-var">$leaf</span> = <span class="php-var">$page</span>-&gt;getFirstSubpagesLeaf()) {
</span><span class="l" id="382">382             rex_response::setStatus(rex_response::HTTP_MOVED_PERMANENTLY);
</span><span class="l" id="383">383             <span class="php-var">$url</span> = <span class="php-var">$leaf</span>-&gt;hasHref() ? <span class="php-var">$leaf</span>-&gt;getHref() : rex_context::fromGet()-&gt;getUrl([<span class="php-quote">'page'</span> =&gt; <span class="php-var">$leaf</span>-&gt;getFullKey()], <span class="php-keyword1">false</span>);
</span><span class="l" id="384">384             rex_response::sendRedirect(<span class="php-var">$url</span>);
</span><span class="l" id="385">385         }
</span><span class="l" id="386">386     }
</span><span class="l" id="387">387 
</span><span class="l" id="388">388     <span class="php-comment">/**
</span></span><span class="l" id="389">389 <span class="php-comment">     * Includes the current page. A page may be provided by the core, an addon or plugin.
</span></span><span class="l" id="390">390 <span class="php-comment">     */</span>
</span><span class="l" id="391">391     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> includeCurrentPage()
</span><span class="l" id="392">392     {
</span><span class="l" id="393">393         <span class="php-var">$currentPage</span> = self::getCurrentPageObject();
</span><span class="l" id="394">394 
</span><span class="l" id="395">395         <span class="php-keyword1">if</span> (rex_request::isPJAXRequest() &amp;&amp; !rex_request::isPJAXContainer(<span class="php-quote">'#rex-js-page-container'</span>)) {
</span><span class="l" id="396">396             <span class="php-comment">// non-core pjax containers should not have a layout.</span>
</span><span class="l" id="397">397             <span class="php-comment">// they render their whole response on their own</span>
</span><span class="l" id="398">398             <span class="php-var">$currentPage</span>-&gt;setHasLayout(<span class="php-keyword1">false</span>);
</span><span class="l" id="399">399         }
</span><span class="l" id="400">400 
</span><span class="l" id="401">401         <span class="php-keyword1">require</span> rex_path::core(<span class="php-quote">'layout/top.php'</span>);
</span><span class="l" id="402">402 
</span><span class="l" id="403">403         self::includePath(<span class="php-var">$currentPage</span>-&gt;getPath());
</span><span class="l" id="404">404 
</span><span class="l" id="405">405         <span class="php-keyword1">require</span> rex_path::core(<span class="php-quote">'layout/bottom.php'</span>);
</span><span class="l" id="406">406     }
</span><span class="l" id="407">407 
</span><span class="l" id="408">408     <span class="php-comment">/**
</span></span><span class="l" id="409">409 <span class="php-comment">     * Includes the sub-path of current page.
</span></span><span class="l" id="410">410 <span class="php-comment">     *
</span></span><span class="l" id="411">411 <span class="php-comment">     * @param array $context
</span></span><span class="l" id="412">412 <span class="php-comment">     *
</span></span><span class="l" id="413">413 <span class="php-comment">     * @return mixed
</span></span><span class="l" id="414">414 <span class="php-comment">     */</span>
</span><span class="l" id="415">415     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> includeCurrentPageSubPath(<span class="php-keyword1">array</span> <span class="php-var">$context</span> = [])
</span><span class="l" id="416">416     {
</span><span class="l" id="417">417         <span class="php-var">$path</span> = self::getCurrentPageObject()-&gt;getSubPath();
</span><span class="l" id="418">418 
</span><span class="l" id="419">419         <span class="php-keyword1">if</span> (<span class="php-quote">'.md'</span> !== <span class="php-keyword2">strtolower</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$path</span>, -<span class="php-num">3</span>))) {
</span><span class="l" id="420">420             <span class="php-keyword1">return</span> self::includePath(<span class="php-var">$path</span>, <span class="php-var">$context</span>);
</span><span class="l" id="421">421         }
</span><span class="l" id="422">422 
</span><span class="l" id="423">423         <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="424">424         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'content'</span>, rex_markdown::factory()-&gt;parse(rex_file::get(<span class="php-var">$path</span>)), <span class="php-keyword1">false</span>);
</span><span class="l" id="425">425         <span class="php-var">$content</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/page/docs.php'</span>);
</span><span class="l" id="426">426 
</span><span class="l" id="427">427         <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="428">428         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'body'</span>, <span class="php-var">$content</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="429">429         <span class="php-keyword1">echo</span> <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/page/section.php'</span>);
</span><span class="l" id="430">430     }
</span><span class="l" id="431">431 
</span><span class="l" id="432">432     <span class="php-comment">/**
</span></span><span class="l" id="433">433 <span class="php-comment">     * Includes a path in correct package context.
</span></span><span class="l" id="434">434 <span class="php-comment">     *
</span></span><span class="l" id="435">435 <span class="php-comment">     * @param string $path
</span></span><span class="l" id="436">436 <span class="php-comment">     * @param array  $context
</span></span><span class="l" id="437">437 <span class="php-comment">     *
</span></span><span class="l" id="438">438 <span class="php-comment">     * @return mixed
</span></span><span class="l" id="439">439 <span class="php-comment">     */</span>
</span><span class="l" id="440">440     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> includePath(<span class="php-var">$path</span>, <span class="php-keyword1">array</span> <span class="php-var">$context</span> = [])
</span><span class="l" id="441">441     {
</span><span class="l" id="442">442         <span class="php-var">$pattern</span> = <span class="php-quote">'@'</span> . <span class="php-keyword2">preg_quote</span>(rex_path::src(<span class="php-quote">'addons/'</span>), <span class="php-quote">'@'</span>) . <span class="php-quote">'([^/\\\]+)(?:[/\\\]plugins[/\\\]([^/\\\]+))?@'</span>;
</span><span class="l" id="443">443 
</span><span class="l" id="444">444         <span class="php-keyword1">if</span> (!<span class="php-keyword2">preg_match</span>(<span class="php-var">$pattern</span>, <span class="php-var">$path</span>, <span class="php-var">$matches</span>)) {
</span><span class="l" id="445">445             <span class="php-var">$__context</span> = <span class="php-var">$context</span>;
</span><span class="l" id="446">446             <span class="php-var">$__path</span> = <span class="php-var">$path</span>;
</span><span class="l" id="447">447             <span class="php-keyword1">unset</span>(<span class="php-var">$context</span>, <span class="php-var">$path</span>, <span class="php-var">$pattern</span>, <span class="php-var">$matches</span>);
</span><span class="l" id="448">448             <span class="php-keyword2">extract</span>(<span class="php-var">$__context</span>, EXTR_SKIP);
</span><span class="l" id="449">449             <span class="php-keyword1">return</span> <span class="php-keyword1">include</span> <span class="php-var">$__path</span>;
</span><span class="l" id="450">450         }
</span><span class="l" id="451">451 
</span><span class="l" id="452">452         <span class="php-var">$package</span> = rex_addon::get(<span class="php-var">$matches</span>[<span class="php-num">1</span>]);
</span><span class="l" id="453">453         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$matches</span>[<span class="php-num">2</span>])) {
</span><span class="l" id="454">454             <span class="php-var">$package</span> = <span class="php-var">$package</span>-&gt;getPlugin(<span class="php-var">$matches</span>[<span class="php-num">2</span>]);
</span><span class="l" id="455">455         }
</span><span class="l" id="456">456         <span class="php-keyword1">return</span> <span class="php-var">$package</span>-&gt;includeFile(<span class="php-keyword2">str_replace</span>(<span class="php-var">$package</span>-&gt;getPath(), <span class="php-quote">''</span>, <span class="php-var">$path</span>), <span class="php-var">$context</span>);
</span><span class="l" id="457">457     }
</span><span class="l" id="458">458 }
</span><span class="l" id="459">459 </span></code></pre>
 </body>
</html>
