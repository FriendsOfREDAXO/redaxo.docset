<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="5">  5 <span class="php-comment"> */</span>
</span><span class="l" id="6">  6 <span class="php-keyword1">class</span> rex_addon_manager <span class="php-keyword1">extends</span> rex_package_manager
</span><span class="l" id="7">  7 {
</span><span class="l" id="8">  8     <span class="php-comment">/**
</span></span><span class="l" id="9">  9 <span class="php-comment">     * Constructor.
</span></span><span class="l" id="10"> 10 <span class="php-comment">     *
</span></span><span class="l" id="11"> 11 <span class="php-comment">     * @param rex_addon $addon Addon
</span></span><span class="l" id="12"> 12 <span class="php-comment">     */</span>
</span><span class="l" id="13"> 13     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> __construct(rex_addon <span class="php-var">$addon</span>)
</span><span class="l" id="14"> 14     {
</span><span class="l" id="15"> 15         parent::__construct(<span class="php-var">$addon</span>, <span class="php-quote">'addon_'</span>);
</span><span class="l" id="16"> 16     }
</span><span class="l" id="17"> 17 
</span><span class="l" id="18"> 18     <span class="php-comment">/**
</span></span><span class="l" id="19"> 19 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="20"> 20 <span class="php-comment">     */</span>
</span><span class="l" id="21"> 21     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> install(<span class="php-var">$installDump</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="22"> 22     {
</span><span class="l" id="23"> 23         <span class="php-var">$installed</span> = <span class="php-var">$this</span>-&gt;package-&gt;isInstalled();
</span><span class="l" id="24"> 24         <span class="php-var">$this</span>-&gt;generatePackageOrder = <span class="php-keyword1">false</span>;
</span><span class="l" id="25"> 25         <span class="php-var">$return</span> = parent::install(<span class="php-var">$installDump</span>);
</span><span class="l" id="26"> 26         <span class="php-var">$this</span>-&gt;generatePackageOrder = <span class="php-keyword1">true</span>;
</span><span class="l" id="27"> 27 
</span><span class="l" id="28"> 28         <span class="php-keyword1">if</span> (<span class="php-keyword1">true</span> === <span class="php-var">$return</span>) {
</span><span class="l" id="29"> 29             <span class="php-keyword1">if</span> (!<span class="php-var">$installed</span>) {
</span><span class="l" id="30"> 30                 <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;package-&gt;getSystemPlugins() <span class="php-keyword1">as</span> <span class="php-var">$plugin</span>) {
</span><span class="l" id="31"> 31                     <span class="php-var">$manager</span> = rex_plugin_manager::factory(<span class="php-var">$plugin</span>);
</span><span class="l" id="32"> 32                     <span class="php-var">$manager</span>-&gt;generatePackageOrder = <span class="php-keyword1">false</span>;
</span><span class="l" id="33"> 33                     <span class="php-var">$manager</span>-&gt;install();
</span><span class="l" id="34"> 34                 }
</span><span class="l" id="35"> 35             }
</span><span class="l" id="36"> 36 
</span><span class="l" id="37"> 37             self::generatePackageOrder();
</span><span class="l" id="38"> 38         }
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40         <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="41"> 41     }
</span><span class="l" id="42"> 42 
</span><span class="l" id="43"> 43     <span class="php-comment">/**
</span></span><span class="l" id="44"> 44 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="45"> 45 <span class="php-comment">     */</span>
</span><span class="l" id="46"> 46     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> uninstall(<span class="php-var">$installDump</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="47"> 47     {
</span><span class="l" id="48"> 48         <span class="php-var">$isActivated</span> = <span class="php-var">$this</span>-&gt;package-&gt;isAvailable();
</span><span class="l" id="49"> 49         <span class="php-keyword1">if</span> (<span class="php-var">$isActivated</span> &amp;&amp; !<span class="php-var">$this</span>-&gt;deactivate()) {
</span><span class="l" id="50"> 50             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="51"> 51         }
</span><span class="l" id="52"> 52         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;package-&gt;getInstalledPlugins() <span class="php-keyword1">as</span> <span class="php-var">$plugin</span>) {
</span><span class="l" id="53"> 53             <span class="php-var">$plugin</span>-&gt;setProperty(<span class="php-quote">'status'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="54"> 54             <span class="php-var">$manager</span> = rex_plugin_manager::factory(<span class="php-var">$plugin</span>);
</span><span class="l" id="55"> 55             <span class="php-keyword1">if</span> (!<span class="php-var">$manager</span>-&gt;uninstall(<span class="php-var">$installDump</span>)) {
</span><span class="l" id="56"> 56                 <span class="php-var">$this</span>-&gt;message = <span class="php-var">$manager</span>-&gt;getMessage();
</span><span class="l" id="57"> 57                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="58"> 58             }
</span><span class="l" id="59"> 59         }
</span><span class="l" id="60"> 60         <span class="php-keyword1">return</span> parent::uninstall(<span class="php-var">$installDump</span>);
</span><span class="l" id="61"> 61     }
</span><span class="l" id="62"> 62 
</span><span class="l" id="63"> 63     <span class="php-comment">/**
</span></span><span class="l" id="64"> 64 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="65"> 65 <span class="php-comment">     */</span>
</span><span class="l" id="66"> 66     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> activate()
</span><span class="l" id="67"> 67     {
</span><span class="l" id="68"> 68         <span class="php-var">$this</span>-&gt;generatePackageOrder = <span class="php-keyword1">false</span>;
</span><span class="l" id="69"> 69         <span class="php-var">$state</span> = parent::activate();
</span><span class="l" id="70"> 70         <span class="php-var">$this</span>-&gt;generatePackageOrder = <span class="php-keyword1">true</span>;
</span><span class="l" id="71"> 71 
</span><span class="l" id="72"> 72         <span class="php-keyword1">if</span> (<span class="php-var">$state</span> !== <span class="php-keyword1">true</span>) {
</span><span class="l" id="73"> 73             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="74"> 74         }
</span><span class="l" id="75"> 75 
</span><span class="l" id="76"> 76         <span class="php-var">$plugins</span> = <span class="php-keyword1">new</span> SplObjectStorage();
</span><span class="l" id="77"> 77         <span class="php-comment">// create the managers for all available plugins</span>
</span><span class="l" id="78"> 78         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;package-&gt;getAvailablePlugins() <span class="php-keyword1">as</span> <span class="php-var">$plugin</span>) {
</span><span class="l" id="79"> 79             <span class="php-var">$plugins</span>[<span class="php-var">$plugin</span>] = rex_plugin_manager::factory(<span class="php-var">$plugin</span>);
</span><span class="l" id="80"> 80             <span class="php-var">$plugins</span>[<span class="php-var">$plugin</span>]-&gt;generatePackageOrder = <span class="php-keyword1">false</span>;
</span><span class="l" id="81"> 81         }
</span><span class="l" id="82"> 82         <span class="php-comment">// mark all plugins whose requirements are not met</span>
</span><span class="l" id="83"> 83         <span class="php-comment">// to consider dependencies among each other, iterate over all plugins until no plugin was marked in a round</span>
</span><span class="l" id="84"> 84         <span class="php-var">$deactivate</span> = [];
</span><span class="l" id="85"> 85         <span class="php-var">$finished</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="86"> 86         <span class="php-keyword1">while</span> (!<span class="php-var">$finished</span> &amp;&amp; <span class="php-keyword2">count</span>(<span class="php-var">$plugins</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="87"> 87             <span class="php-var">$finished</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="88"> 88             <span class="php-keyword1">foreach</span> (<span class="php-var">$plugins</span> <span class="php-keyword1">as</span> <span class="php-var">$plugin</span>) {
</span><span class="l" id="89"> 89                 <span class="php-var">$pluginManager</span> = <span class="php-var">$plugins</span>[<span class="php-var">$plugin</span>];
</span><span class="l" id="90"> 90                 <span class="php-keyword1">if</span> (!<span class="php-var">$pluginManager</span>-&gt;checkRequirements() || !<span class="php-var">$pluginManager</span>-&gt;checkConflicts()) {
</span><span class="l" id="91"> 91                     <span class="php-var">$plugin</span>-&gt;setProperty(<span class="php-quote">'status'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="92"> 92                     <span class="php-var">$deactivate</span>[] = <span class="php-var">$pluginManager</span>;
</span><span class="l" id="93"> 93                     <span class="php-var">$finished</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="94"> 94                     <span class="php-keyword1">unset</span>(<span class="php-var">$plugins</span>[<span class="php-var">$plugin</span>]);
</span><span class="l" id="95"> 95                 }
</span><span class="l" id="96"> 96             }
</span><span class="l" id="97"> 97         }
</span><span class="l" id="98"> 98         <span class="php-comment">// deactivate all marked plugins</span>
</span><span class="l" id="99"> 99         <span class="php-keyword1">foreach</span> (<span class="php-var">$deactivate</span> <span class="php-keyword1">as</span> <span class="php-var">$pluginManager</span>) {
</span><span class="l" id="100">100             <span class="php-var">$pluginManager</span>-&gt;deactivate();
</span><span class="l" id="101">101         }
</span><span class="l" id="102">102 
</span><span class="l" id="103">103         self::generatePackageOrder();
</span><span class="l" id="104">104 
</span><span class="l" id="105">105         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="106">106     }
</span><span class="l" id="107">107 
</span><span class="l" id="108">108     <span class="php-comment">/**
</span></span><span class="l" id="109">109 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="110">110 <span class="php-comment">     */</span>
</span><span class="l" id="111">111     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> checkDependencies()
</span><span class="l" id="112">112     {
</span><span class="l" id="113">113         <span class="php-var">$check</span> = <span class="php-var">$addonCheck</span> = parent::checkDependencies();
</span><span class="l" id="114">114         <span class="php-var">$dependencies</span> = [];
</span><span class="l" id="115">115         <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;package-&gt;getAvailablePlugins() <span class="php-keyword1">as</span> <span class="php-var">$plugin</span>) {
</span><span class="l" id="116">116             <span class="php-var">$manager</span> = rex_plugin_manager::factory(<span class="php-var">$plugin</span>);
</span><span class="l" id="117">117             <span class="php-keyword1">if</span> (!<span class="php-var">$manager</span>-&gt;checkDependencies()) {
</span><span class="l" id="118">118                 <span class="php-var">$dependencies</span>[] = <span class="php-var">$manager</span>-&gt;getMessage();
</span><span class="l" id="119">119                 <span class="php-var">$check</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="120">120             }
</span><span class="l" id="121">121         }
</span><span class="l" id="122">122         <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$dependencies</span>)) {
</span><span class="l" id="123">123             <span class="php-keyword1">if</span> (!<span class="php-var">$addonCheck</span>) {
</span><span class="l" id="124">124                 <span class="php-var">$this</span>-&gt;message .= <span class="php-quote">'&lt;br /&gt;'</span>;
</span><span class="l" id="125">125             }
</span><span class="l" id="126">126             <span class="php-var">$this</span>-&gt;message .= <span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$dependencies</span>);
</span><span class="l" id="127">127         }
</span><span class="l" id="128">128         <span class="php-keyword1">return</span> <span class="php-var">$check</span>;
</span><span class="l" id="129">129     }
</span><span class="l" id="130">130 
</span><span class="l" id="131">131     <span class="php-comment">/**
</span></span><span class="l" id="132">132 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="133">133 <span class="php-comment">     */</span>
</span><span class="l" id="134">134     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> wrongPackageId(<span class="php-var">$addonName</span>, <span class="php-var">$pluginName</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="135">135     {
</span><span class="l" id="136">136         <span class="php-keyword1">if</span> (<span class="php-var">$pluginName</span> !== <span class="php-keyword1">null</span>) {
</span><span class="l" id="137">137             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'is_plugin'</span>, <span class="php-var">$addonName</span>, <span class="php-var">$pluginName</span>);
</span><span class="l" id="138">138         }
</span><span class="l" id="139">139         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'wrong_dir_name'</span>, <span class="php-var">$addonName</span>);
</span><span class="l" id="140">140     }
</span><span class="l" id="141">141 }
</span><span class="l" id="142">142 </span></code></pre>
 </body>
</html>
