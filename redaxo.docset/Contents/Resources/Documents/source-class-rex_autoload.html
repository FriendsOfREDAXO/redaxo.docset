<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * REDAXO Autoloader.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * This class was originally copied from the Symfony Framework:
</span></span><span class="l" id="7">  7 <span class="php-comment"> * Fabien Potencier &lt;fabien.potencier@symfony-project.com&gt;
</span></span><span class="l" id="8">  8 <span class="php-comment"> *
</span></span><span class="l" id="9">  9 <span class="php-comment"> * Adjusted in very many places
</span></span><span class="l" id="10"> 10 <span class="php-comment"> *
</span></span><span class="l" id="11"> 11 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="12"> 12 <span class="php-comment"> */</span>
</span><span class="l" id="13"> 13 <span class="php-keyword1">class</span> rex_autoload
</span><span class="l" id="14"> 14 {
</span><span class="l" id="15"> 15     <span class="php-comment">/**
</span></span><span class="l" id="16"> 16 <span class="php-comment">     * @var Composer\Autoload\ClassLoader
</span></span><span class="l" id="17"> 17 <span class="php-comment">     */</span>
</span><span class="l" id="18"> 18     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$composerLoader</span>;
</span><span class="l" id="19"> 19 
</span><span class="l" id="20"> 20     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$registered</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="21"> 21     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$cacheFile</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="22"> 22     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$cacheChanged</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="23"> 23     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$reloaded</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="24"> 24     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$dirs</span> = [];
</span><span class="l" id="25"> 25     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$addedDirs</span> = [];
</span><span class="l" id="26"> 26     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-var">$classes</span> = [];
</span><span class="l" id="27"> 27 
</span><span class="l" id="28"> 28     <span class="php-comment">/**
</span></span><span class="l" id="29"> 29 <span class="php-comment">     * Register rex_autoload in spl autoloader.
</span></span><span class="l" id="30"> 30 <span class="php-comment">     */</span>
</span><span class="l" id="31"> 31     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> register()
</span><span class="l" id="32"> 32     {
</span><span class="l" id="33"> 33         <span class="php-keyword1">if</span> (self::<span class="php-var">$registered</span>) {
</span><span class="l" id="34"> 34             <span class="php-keyword1">return</span>;
</span><span class="l" id="35"> 35         }
</span><span class="l" id="36"> 36 
</span><span class="l" id="37"> 37         <span class="php-keyword2">ini_set</span>(<span class="php-quote">'unserialize_callback_func'</span>, <span class="php-quote">'spl_autoload_call'</span>);
</span><span class="l" id="38"> 38 
</span><span class="l" id="39"> 39         <span class="php-keyword1">if</span> (!self::<span class="php-var">$composerLoader</span>) {
</span><span class="l" id="40"> 40             self::<span class="php-var">$composerLoader</span> = <span class="php-keyword1">require</span> rex_path::core(<span class="php-quote">'vendor/autoload.php'</span>);
</span><span class="l" id="41"> 41             <span class="php-comment">// Unregister Composer Autoloader because we call self::$composerLoader-&gt;loadClass() manually</span>
</span><span class="l" id="42"> 42             self::<span class="php-var">$composerLoader</span>-&gt;unregister();
</span><span class="l" id="43"> 43         }
</span><span class="l" id="44"> 44 
</span><span class="l" id="45"> 45         <span class="php-keyword1">if</span> (<span class="php-keyword1">false</span> === <span class="php-keyword2">spl_autoload_register</span>([__CLASS__, <span class="php-quote">'autoload'</span>])) {
</span><span class="l" id="46"> 46             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Exception(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Unable to register %s::autoload as an autoloading method.'</span>, __CLASS__));
</span><span class="l" id="47"> 47         }
</span><span class="l" id="48"> 48 
</span><span class="l" id="49"> 49         self::<span class="php-var">$cacheFile</span> = rex_path::coreCache(<span class="php-quote">'autoload.cache'</span>);
</span><span class="l" id="50"> 50         self::loadCache();
</span><span class="l" id="51"> 51         <span class="php-keyword2">register_shutdown_function</span>([__CLASS__, <span class="php-quote">'saveCache'</span>]);
</span><span class="l" id="52"> 52 
</span><span class="l" id="53"> 53         self::<span class="php-var">$registered</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="54"> 54     }
</span><span class="l" id="55"> 55 
</span><span class="l" id="56"> 56     <span class="php-comment">/**
</span></span><span class="l" id="57"> 57 <span class="php-comment">     * Unregister rex_autoload from spl autoloader.
</span></span><span class="l" id="58"> 58 <span class="php-comment">     */</span>
</span><span class="l" id="59"> 59     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> unregister()
</span><span class="l" id="60"> 60     {
</span><span class="l" id="61"> 61         <span class="php-keyword2">spl_autoload_unregister</span>([__CLASS__, <span class="php-quote">'autoload'</span>]);
</span><span class="l" id="62"> 62         self::<span class="php-var">$registered</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="63"> 63     }
</span><span class="l" id="64"> 64 
</span><span class="l" id="65"> 65     <span class="php-comment">/**
</span></span><span class="l" id="66"> 66 <span class="php-comment">     * Handles autoloading of classes.
</span></span><span class="l" id="67"> 67 <span class="php-comment">     *
</span></span><span class="l" id="68"> 68 <span class="php-comment">     * @param string $class A class name
</span></span><span class="l" id="69"> 69 <span class="php-comment">     *
</span></span><span class="l" id="70"> 70 <span class="php-comment">     * @return bool Returns true if the class has been loaded
</span></span><span class="l" id="71"> 71 <span class="php-comment">     */</span>
</span><span class="l" id="72"> 72     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> autoload(<span class="php-var">$class</span>)
</span><span class="l" id="73"> 73     {
</span><span class="l" id="74"> 74         <span class="php-comment">// class already exists</span>
</span><span class="l" id="75"> 75         <span class="php-keyword1">if</span> (self::classExists(<span class="php-var">$class</span>)) {
</span><span class="l" id="76"> 76             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="77"> 77         }
</span><span class="l" id="78"> 78 
</span><span class="l" id="79"> 79         <span class="php-var">$force</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="80"> 80         <span class="php-var">$lowerClass</span> = <span class="php-keyword2">strtolower</span>(<span class="php-var">$class</span>);
</span><span class="l" id="81"> 81         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(self::<span class="php-var">$classes</span>[<span class="php-var">$lowerClass</span>])) {
</span><span class="l" id="82"> 82             <span class="php-var">$path</span> = rex_path::base(self::<span class="php-var">$classes</span>[<span class="php-var">$lowerClass</span>]);
</span><span class="l" id="83"> 83             <span class="php-comment">// we have a class path for the class, let's include it</span>
</span><span class="l" id="84"> 84             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_readable</span>(<span class="php-var">$path</span>)) {
</span><span class="l" id="85"> 85                 <span class="php-keyword1">require_once</span> <span class="php-var">$path</span>;
</span><span class="l" id="86"> 86                 <span class="php-keyword1">if</span> (self::classExists(<span class="php-var">$class</span>)) {
</span><span class="l" id="87"> 87                     <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="88"> 88                 }
</span><span class="l" id="89"> 89             }
</span><span class="l" id="90"> 90             <span class="php-comment">// there is a class path in cache, but the file does not exist or does not contain the class any more</span>
</span><span class="l" id="91"> 91             <span class="php-comment">// but maybe the class exists in another already known file now</span>
</span><span class="l" id="92"> 92             <span class="php-comment">// so all files have to be analysed again =&gt; $force reload</span>
</span><span class="l" id="93"> 93             <span class="php-var">$force</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="94"> 94             <span class="php-keyword1">unset</span>(self::<span class="php-var">$classes</span>[<span class="php-var">$lowerClass</span>]);
</span><span class="l" id="95"> 95             self::<span class="php-var">$cacheChanged</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="96"> 96         }
</span><span class="l" id="97"> 97 
</span><span class="l" id="98"> 98         <span class="php-comment">// Return true if class exists after calling $composerLoader</span>
</span><span class="l" id="99"> 99         <span class="php-keyword1">if</span> (self::<span class="php-var">$composerLoader</span>-&gt;loadClass(<span class="php-var">$class</span>) &amp;&amp; self::classExists(<span class="php-var">$class</span>)) {
</span><span class="l" id="100">100             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="101">101         }
</span><span class="l" id="102">102 
</span><span class="l" id="103">103         <span class="php-comment">// Class not found, so reanalyse all directories if not already done or if $force==true</span>
</span><span class="l" id="104">104         <span class="php-comment">// but only if an admin is logged in</span>
</span><span class="l" id="105">105         <span class="php-keyword1">if</span> (
</span><span class="l" id="106">106             (!self::<span class="php-var">$reloaded</span> || <span class="php-var">$force</span>) &amp;&amp;
</span><span class="l" id="107">107             (rex::getConsole() || (<span class="php-var">$user</span> = rex_backend_login::createUser()) &amp;&amp; <span class="php-var">$user</span>-&gt;isAdmin())
</span><span class="l" id="108">108         ) {
</span><span class="l" id="109">109             self::reload(<span class="php-var">$force</span>);
</span><span class="l" id="110">110             <span class="php-keyword1">return</span> self::autoload(<span class="php-var">$class</span>);
</span><span class="l" id="111">111         }
</span><span class="l" id="112">112 
</span><span class="l" id="113">113         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="114">114     }
</span><span class="l" id="115">115 
</span><span class="l" id="116">116     <span class="php-comment">/**
</span></span><span class="l" id="117">117 <span class="php-comment">     * Returns whether the given class/interface/trait exists.
</span></span><span class="l" id="118">118 <span class="php-comment">     *
</span></span><span class="l" id="119">119 <span class="php-comment">     * @param string $class
</span></span><span class="l" id="120">120 <span class="php-comment">     *
</span></span><span class="l" id="121">121 <span class="php-comment">     * @return bool
</span></span><span class="l" id="122">122 <span class="php-comment">     */</span>
</span><span class="l" id="123">123     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> classExists(<span class="php-var">$class</span>)
</span><span class="l" id="124">124     {
</span><span class="l" id="125">125         <span class="php-keyword1">return</span> <span class="php-keyword2">class_exists</span>(<span class="php-var">$class</span>, <span class="php-keyword1">false</span>) || <span class="php-keyword2">interface_exists</span>(<span class="php-var">$class</span>, <span class="php-keyword1">false</span>) || <span class="php-keyword2">trait_exists</span>(<span class="php-var">$class</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="126">126     }
</span><span class="l" id="127">127 
</span><span class="l" id="128">128     <span class="php-comment">/**
</span></span><span class="l" id="129">129 <span class="php-comment">     * Loads the cache.
</span></span><span class="l" id="130">130 <span class="php-comment">     */</span>
</span><span class="l" id="131">131     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> loadCache()
</span><span class="l" id="132">132     {
</span><span class="l" id="133">133         <span class="php-keyword1">if</span> (!self::<span class="php-var">$cacheFile</span> || !<span class="php-keyword2">is_readable</span>(self::<span class="php-var">$cacheFile</span>)) {
</span><span class="l" id="134">134             <span class="php-keyword1">return</span>;
</span><span class="l" id="135">135         }
</span><span class="l" id="136">136 
</span><span class="l" id="137">137         <span class="php-keyword1">list</span>(self::<span class="php-var">$classes</span>, self::<span class="php-var">$dirs</span>) = <span class="php-keyword2">json_decode</span>(<span class="php-keyword2">file_get_contents</span>(self::<span class="php-var">$cacheFile</span>), <span class="php-keyword1">true</span>);
</span><span class="l" id="138">138     }
</span><span class="l" id="139">139 
</span><span class="l" id="140">140     <span class="php-comment">/**
</span></span><span class="l" id="141">141 <span class="php-comment">     * Saves the cache.
</span></span><span class="l" id="142">142 <span class="php-comment">     */</span>
</span><span class="l" id="143">143     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> saveCache()
</span><span class="l" id="144">144     {
</span><span class="l" id="145">145         <span class="php-keyword1">if</span> (!self::<span class="php-var">$cacheChanged</span>) {
</span><span class="l" id="146">146             <span class="php-keyword1">return</span>;
</span><span class="l" id="147">147         }
</span><span class="l" id="148">148 
</span><span class="l" id="149">149         <span class="php-comment">// remove obsolete dirs from cache</span>
</span><span class="l" id="150">150         <span class="php-keyword1">foreach</span> (self::<span class="php-var">$dirs</span> <span class="php-keyword1">as</span> <span class="php-var">$dir</span> =&gt; <span class="php-var">$files</span>) {
</span><span class="l" id="151">151             <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$dir</span>, self::<span class="php-var">$addedDirs</span>)) {
</span><span class="l" id="152">152                 <span class="php-keyword1">unset</span>(self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>]);
</span><span class="l" id="153">153             }
</span><span class="l" id="154">154         }
</span><span class="l" id="155">155 
</span><span class="l" id="156">156         <span class="php-keyword1">if</span> (!rex_file::putCache(self::<span class="php-var">$cacheFile</span>, [self::<span class="php-var">$classes</span>, self::<span class="php-var">$dirs</span>])) {
</span><span class="l" id="157">157             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Exception(<span class="php-quote">"Unable to write autoload cachefile '"</span> . self::<span class="php-var">$cacheFile</span> . <span class="php-quote">"'!"</span>);
</span><span class="l" id="158">158         }
</span><span class="l" id="159">159         self::<span class="php-var">$cacheChanged</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="160">160     }
</span><span class="l" id="161">161 
</span><span class="l" id="162">162     <span class="php-comment">/**
</span></span><span class="l" id="163">163 <span class="php-comment">     * Reanalyses all added directories.
</span></span><span class="l" id="164">164 <span class="php-comment">     *
</span></span><span class="l" id="165">165 <span class="php-comment">     * @param bool $force If true, all files are reanalysed, otherwise only new and changed files
</span></span><span class="l" id="166">166 <span class="php-comment">     */</span>
</span><span class="l" id="167">167     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> reload(<span class="php-var">$force</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="168">168     {
</span><span class="l" id="169">169         <span class="php-keyword1">if</span> (<span class="php-var">$force</span>) {
</span><span class="l" id="170">170             self::<span class="php-var">$classes</span> = [];
</span><span class="l" id="171">171             self::<span class="php-var">$dirs</span> = [];
</span><span class="l" id="172">172         }
</span><span class="l" id="173">173         <span class="php-keyword1">foreach</span> (self::<span class="php-var">$addedDirs</span> <span class="php-keyword1">as</span> <span class="php-var">$dir</span>) {
</span><span class="l" id="174">174             self::_addDirectory(<span class="php-var">$dir</span>);
</span><span class="l" id="175">175         }
</span><span class="l" id="176">176         self::<span class="php-var">$reloaded</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="177">177     }
</span><span class="l" id="178">178 
</span><span class="l" id="179">179     <span class="php-comment">/**
</span></span><span class="l" id="180">180 <span class="php-comment">     * Removes the cache.
</span></span><span class="l" id="181">181 <span class="php-comment">     */</span>
</span><span class="l" id="182">182     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> removeCache()
</span><span class="l" id="183">183     {
</span><span class="l" id="184">184         rex_file::<span class="php-keyword2">delete</span>(self::<span class="php-var">$cacheFile</span>);
</span><span class="l" id="185">185     }
</span><span class="l" id="186">186 
</span><span class="l" id="187">187     <span class="php-comment">/**
</span></span><span class="l" id="188">188 <span class="php-comment">     * Adds a directory to the autoloading system if not yet present.
</span></span><span class="l" id="189">189 <span class="php-comment">     *
</span></span><span class="l" id="190">190 <span class="php-comment">     * @param string $dir The directory to look for classes
</span></span><span class="l" id="191">191 <span class="php-comment">     */</span>
</span><span class="l" id="192">192     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> addDirectory(<span class="php-var">$dir</span>)
</span><span class="l" id="193">193     {
</span><span class="l" id="194">194         <span class="php-var">$dir</span> = <span class="php-keyword2">rtrim</span>(<span class="php-var">$dir</span>, <span class="php-quote">'/\\'</span>) . DIRECTORY_SEPARATOR;
</span><span class="l" id="195">195         <span class="php-var">$dir</span> = self::normalizePath(<span class="php-var">$dir</span>);
</span><span class="l" id="196">196         <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$dir</span>, self::<span class="php-var">$addedDirs</span>)) {
</span><span class="l" id="197">197             <span class="php-keyword1">return</span>;
</span><span class="l" id="198">198         }
</span><span class="l" id="199">199         self::<span class="php-var">$addedDirs</span>[] = <span class="php-var">$dir</span>;
</span><span class="l" id="200">200         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>])) {
</span><span class="l" id="201">201             self::_addDirectory(<span class="php-var">$dir</span>);
</span><span class="l" id="202">202             self::<span class="php-var">$cacheChanged</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="203">203         }
</span><span class="l" id="204">204     }
</span><span class="l" id="205">205 
</span><span class="l" id="206">206     <span class="php-comment">/**
</span></span><span class="l" id="207">207 <span class="php-comment">     * Returns the classes.
</span></span><span class="l" id="208">208 <span class="php-comment">     *
</span></span><span class="l" id="209">209 <span class="php-comment">     * @return string[]
</span></span><span class="l" id="210">210 <span class="php-comment">     */</span>
</span><span class="l" id="211">211     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getClasses()
</span><span class="l" id="212">212     {
</span><span class="l" id="213">213         <span class="php-keyword1">return</span> <span class="php-keyword2">array_keys</span>(self::<span class="php-var">$classes</span>);
</span><span class="l" id="214">214     }
</span><span class="l" id="215">215 
</span><span class="l" id="216">216     <span class="php-comment">/**
</span></span><span class="l" id="217">217 <span class="php-comment">     * Returns path relative to project root.
</span></span><span class="l" id="218">218 <span class="php-comment">     *
</span></span><span class="l" id="219">219 <span class="php-comment">     * @param string $path
</span></span><span class="l" id="220">220 <span class="php-comment">     *
</span></span><span class="l" id="221">221 <span class="php-comment">     * @return string
</span></span><span class="l" id="222">222 <span class="php-comment">     */</span>
</span><span class="l" id="223">223     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> normalizePath(<span class="php-var">$path</span>)
</span><span class="l" id="224">224     {
</span><span class="l" id="225">225         <span class="php-keyword1">return</span> <span class="php-keyword2">substr</span>(<span class="php-var">$path</span>, <span class="php-keyword2">strlen</span>(rex_path::base()));
</span><span class="l" id="226">226     }
</span><span class="l" id="227">227 
</span><span class="l" id="228">228     <span class="php-comment">/**
</span></span><span class="l" id="229">229 <span class="php-comment">     * @param string $dir
</span></span><span class="l" id="230">230 <span class="php-comment">     */</span>
</span><span class="l" id="231">231     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> _addDirectory(<span class="php-var">$dir</span>)
</span><span class="l" id="232">232     {
</span><span class="l" id="233">233         <span class="php-var">$dirPath</span> = rex_path::base(<span class="php-var">$dir</span>);
</span><span class="l" id="234">234 
</span><span class="l" id="235">235         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_dir</span>(<span class="php-var">$dirPath</span>)) {
</span><span class="l" id="236">236             <span class="php-keyword1">return</span>;
</span><span class="l" id="237">237         }
</span><span class="l" id="238">238 
</span><span class="l" id="239">239         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>])) {
</span><span class="l" id="240">240             self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>] = [];
</span><span class="l" id="241">241         }
</span><span class="l" id="242">242         <span class="php-var">$files</span> = self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>];
</span><span class="l" id="243">243         <span class="php-var">$iterator</span> = <span class="php-keyword1">new</span> RecursiveIteratorIterator(<span class="php-keyword1">new</span> RecursiveDirectoryIterator(<span class="php-var">$dirPath</span>, RecursiveDirectoryIterator::SKIP_DOTS));
</span><span class="l" id="244">244         <span class="php-keyword1">foreach</span> (<span class="php-var">$iterator</span> <span class="php-keyword1">as</span> <span class="php-var">$path</span> =&gt; <span class="php-var">$file</span>) {
</span><span class="l" id="245">245             <span class="php-comment">/** @var SplFileInfo $file */</span>
</span><span class="l" id="246">246             <span class="php-keyword1">if</span> (!<span class="php-var">$file</span>-&gt;isFile() || !<span class="php-keyword2">in_array</span>(<span class="php-var">$file</span>-&gt;getExtension(), [<span class="php-quote">'php'</span>, <span class="php-quote">'inc'</span>])) {
</span><span class="l" id="247">247                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="248">248             }
</span><span class="l" id="249">249 
</span><span class="l" id="250">250             <span class="php-var">$file</span> = self::normalizePath(<span class="php-var">$path</span>);
</span><span class="l" id="251">251             <span class="php-keyword1">unset</span>(<span class="php-var">$files</span>[<span class="php-var">$file</span>]);
</span><span class="l" id="252">252             <span class="php-var">$checksum</span> = <span class="php-keyword2">md5_file</span>(<span class="php-var">$path</span>);
</span><span class="l" id="253">253             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>][<span class="php-var">$file</span>]) &amp;&amp; self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>][<span class="php-var">$file</span>] === <span class="php-var">$checksum</span>) {
</span><span class="l" id="254">254                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="255">255             }
</span><span class="l" id="256">256             self::<span class="php-var">$dirs</span>[<span class="php-var">$dir</span>][<span class="php-var">$file</span>] = <span class="php-var">$checksum</span>;
</span><span class="l" id="257">257             self::<span class="php-var">$cacheChanged</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="258">258 
</span><span class="l" id="259">259             <span class="php-var">$classes</span> = self::findClasses(<span class="php-var">$path</span>);
</span><span class="l" id="260">260             <span class="php-keyword1">foreach</span> (<span class="php-var">$classes</span> <span class="php-keyword1">as</span> <span class="php-var">$class</span>) {
</span><span class="l" id="261">261                 <span class="php-var">$class</span> = <span class="php-keyword2">strtolower</span>(<span class="php-var">$class</span>);
</span><span class="l" id="262">262                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$classes</span>[<span class="php-var">$class</span>])) {
</span><span class="l" id="263">263                     self::<span class="php-var">$classes</span>[<span class="php-var">$class</span>] = <span class="php-var">$file</span>;
</span><span class="l" id="264">264                 }
</span><span class="l" id="265">265             }
</span><span class="l" id="266">266         }
</span><span class="l" id="267">267         <span class="php-keyword1">foreach</span> (<span class="php-var">$files</span> <span class="php-keyword1">as</span> <span class="php-var">$file</span>) {
</span><span class="l" id="268">268             <span class="php-keyword1">unset</span>(self::<span class="php-var">$dirs</span>[<span class="php-var">$file</span>]);
</span><span class="l" id="269">269             self::<span class="php-var">$cacheChanged</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="270">270         }
</span><span class="l" id="271">271     }
</span><span class="l" id="272">272 
</span><span class="l" id="273">273     <span class="php-comment">/**
</span></span><span class="l" id="274">274 <span class="php-comment">     * Extract the classes in the given file.
</span></span><span class="l" id="275">275 <span class="php-comment">     *
</span></span><span class="l" id="276">276 <span class="php-comment">     * The method is copied from Composer (with little changes):
</span></span><span class="l" id="277">277 <span class="php-comment">     * https://github.com/composer/composer/blob/a2a70380c14a20b3f611d849eae7342f2e35c763/src/Composer/Autoload/ClassMapGenerator.php#L89-L146
</span></span><span class="l" id="278">278 <span class="php-comment">     *
</span></span><span class="l" id="279">279 <span class="php-comment">     * @param string $path The file to check
</span></span><span class="l" id="280">280 <span class="php-comment">     *
</span></span><span class="l" id="281">281 <span class="php-comment">     * @throws \RuntimeException
</span></span><span class="l" id="282">282 <span class="php-comment">     *
</span></span><span class="l" id="283">283 <span class="php-comment">     * @return array The found classes
</span></span><span class="l" id="284">284 <span class="php-comment">     */</span>
</span><span class="l" id="285">285     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> findClasses(<span class="php-var">$path</span>)
</span><span class="l" id="286">286     {
</span><span class="l" id="287">287         <span class="php-comment">// Use @ here instead of Silencer to actively suppress 'unhelpful' output</span>
</span><span class="l" id="288">288         <span class="php-comment">// @link https://github.com/composer/composer/pull/4886</span>
</span><span class="l" id="289">289         <span class="php-var">$contents</span> = @<span class="php-keyword2">php_strip_whitespace</span>(<span class="php-var">$path</span>);
</span><span class="l" id="290">290         <span class="php-keyword1">if</span> (!<span class="php-var">$contents</span>) {
</span><span class="l" id="291">291             <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$path</span>)) {
</span><span class="l" id="292">292                 <span class="php-var">$message</span> = <span class="php-quote">'File at "%s" does not exist, check your classmap definitions'</span>;
</span><span class="l" id="293">293             } <span class="php-keyword1">elseif</span> (!<span class="php-keyword2">is_readable</span>(<span class="php-var">$path</span>)) {
</span><span class="l" id="294">294                 <span class="php-var">$message</span> = <span class="php-quote">'File at "%s" is not readable, check its permissions'</span>;
</span><span class="l" id="295">295             } <span class="php-keyword1">elseif</span> (<span class="php-quote">''</span> === <span class="php-keyword2">trim</span>(<span class="php-keyword2">file_get_contents</span>(<span class="php-var">$path</span>))) {
</span><span class="l" id="296">296                 <span class="php-comment">// The input file was really empty and thus contains no classes</span>
</span><span class="l" id="297">297                 <span class="php-keyword1">return</span> [];
</span><span class="l" id="298">298             } <span class="php-keyword1">else</span> {
</span><span class="l" id="299">299                 <span class="php-var">$message</span> = <span class="php-quote">'File at "%s" could not be parsed as PHP, it may be binary or corrupted'</span>;
</span><span class="l" id="300">300             }
</span><span class="l" id="301">301             <span class="php-var">$error</span> = <span class="php-keyword2">error_get_last</span>();
</span><span class="l" id="302">302             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$error</span>[<span class="php-quote">'message'</span>])) {
</span><span class="l" id="303">303                 <span class="php-var">$message</span> .= PHP_EOL . <span class="php-quote">'The following message may be helpful:'</span> . PHP_EOL . <span class="php-var">$error</span>[<span class="php-quote">'message'</span>];
</span><span class="l" id="304">304             }
</span><span class="l" id="305">305             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \RuntimeException(<span class="php-keyword2">sprintf</span>(<span class="php-var">$message</span>, <span class="php-var">$path</span>));
</span><span class="l" id="306">306         }
</span><span class="l" id="307">307 
</span><span class="l" id="308">308         <span class="php-comment">// return early if there is no chance of matching anything in this file</span>
</span><span class="l" id="309">309         <span class="php-keyword1">if</span> (!<span class="php-keyword2">preg_match</span>(<span class="php-quote">'{\b(?:class|interface|trait)\s}i'</span>, <span class="php-var">$contents</span>)) {
</span><span class="l" id="310">310             <span class="php-keyword1">return</span> [];
</span><span class="l" id="311">311         }
</span><span class="l" id="312">312 
</span><span class="l" id="313">313         <span class="php-comment">// strip heredocs/nowdocs</span>
</span><span class="l" id="314">314         <span class="php-var">$contents</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'{&lt;&lt;&lt;\s*(\'?)(\w+)\\1(?:\r\n|\n|\r)(?:.*?)(?:\r\n|\n|\r)\\2(?=\r\n|\n|\r|;)}s'</span>, <span class="php-quote">'null'</span>, <span class="php-var">$contents</span>);
</span><span class="l" id="315">315         <span class="php-comment">// strip strings</span>
</span><span class="l" id="316">316         <span class="php-var">$contents</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'{"[^"\\\\]*+(\\\\.[^"\\\\]*+)*+"|\'[^\'\\\\]*+(\\\\.[^\'\\\\]*+)*+\'}s'</span>, <span class="php-quote">'null'</span>, <span class="php-var">$contents</span>);
</span><span class="l" id="317">317         <span class="php-comment">// strip leading non-php code if needed</span>
</span><span class="l" id="318">318         <span class="php-keyword1">if</span> (<span class="php-keyword2">substr</span>(<span class="php-var">$contents</span>, <span class="php-num">0</span>, <span class="php-num">2</span>) !== <span class="php-quote">'&lt;?'</span>) {
</span><span class="l" id="319">319             <span class="php-var">$contents</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'{^.+?&lt;\?}s'</span>, <span class="php-quote">'&lt;?'</span>, <span class="php-var">$contents</span>, <span class="php-num">1</span>, <span class="php-var">$replacements</span>);
</span><span class="l" id="320">320             <span class="php-keyword1">if</span> (<span class="php-var">$replacements</span> === <span class="php-num">0</span>) {
</span><span class="l" id="321">321                 <span class="php-keyword1">return</span> [];
</span><span class="l" id="322">322             }
</span><span class="l" id="323">323         }
</span><span class="l" id="324">324         <span class="php-comment">// strip non-php blocks in the file</span>
</span><span class="l" id="325">325         <span class="php-var">$contents</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'{\?&gt;.+&lt;\?}s'</span>, <span class="php-quote">'?&gt;&lt;?'</span>, <span class="php-var">$contents</span>);
</span><span class="l" id="326">326         <span class="php-comment">// strip trailing non-php code if needed</span>
</span><span class="l" id="327">327         <span class="php-var">$pos</span> = <span class="php-keyword2">strrpos</span>(<span class="php-var">$contents</span>, <span class="php-quote">'?&gt;'</span>);
</span><span class="l" id="328">328         <span class="php-keyword1">if</span> (<span class="php-keyword1">false</span> !== <span class="php-var">$pos</span> &amp;&amp; <span class="php-keyword1">false</span> === <span class="php-keyword2">strpos</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$contents</span>, <span class="php-var">$pos</span>), <span class="php-quote">'&lt;?'</span>)) {
</span><span class="l" id="329">329             <span class="php-var">$contents</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$contents</span>, <span class="php-num">0</span>, <span class="php-var">$pos</span>);
</span><span class="l" id="330">330         }
</span><span class="l" id="331">331 
</span><span class="l" id="332">332         <span class="php-keyword2">preg_match_all</span>(<span class="php-quote">'{
</span></span><span class="l" id="333">333 <span class="php-quote">            (?:
</span></span><span class="l" id="334">334 <span class="php-quote">                 \b(?&lt;![\$:&gt;])(?P&lt;type&gt;class|interface|trait) \s++ (?P&lt;name&gt;[a-zA-Z_\x7f-\xff:][a-zA-Z0-9_\x7f-\xff:\-]*+)
</span></span><span class="l" id="335">335 <span class="php-quote">               | \b(?&lt;![\$:&gt;])(?P&lt;ns&gt;namespace) (?P&lt;nsname&gt;\s++[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*+(?:\s*+\\\\\s*+[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*+)*+)? \s*+ [\{;]
</span></span><span class="l" id="336">336 <span class="php-quote">            )
</span></span><span class="l" id="337">337 <span class="php-quote">        }ix'</span>, <span class="php-var">$contents</span>, <span class="php-var">$matches</span>);
</span><span class="l" id="338">338 
</span><span class="l" id="339">339         <span class="php-var">$classes</span> = [];
</span><span class="l" id="340">340         <span class="php-var">$namespace</span> = <span class="php-quote">''</span>;
</span><span class="l" id="341">341 
</span><span class="l" id="342">342         <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>, <span class="php-var">$len</span> = <span class="php-keyword2">count</span>(<span class="php-var">$matches</span>[<span class="php-quote">'type'</span>]); <span class="php-var">$i</span> &lt; <span class="php-var">$len</span>; ++<span class="php-var">$i</span>) {
</span><span class="l" id="343">343             <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$matches</span>[<span class="php-quote">'ns'</span>][<span class="php-var">$i</span>])) {
</span><span class="l" id="344">344                 <span class="php-var">$namespace</span> = <span class="php-keyword2">str_replace</span>([<span class="php-quote">' '</span>, <span class="php-quote">"\t"</span>, <span class="php-quote">"\r"</span>, <span class="php-quote">"\n"</span>], <span class="php-quote">''</span>, <span class="php-var">$matches</span>[<span class="php-quote">'nsname'</span>][<span class="php-var">$i</span>]) . <span class="php-quote">'\\'</span>;
</span><span class="l" id="345">345             } <span class="php-keyword1">else</span> {
</span><span class="l" id="346">346                 <span class="php-var">$name</span> = <span class="php-var">$matches</span>[<span class="php-quote">'name'</span>][<span class="php-var">$i</span>];
</span><span class="l" id="347">347                 <span class="php-comment">// skip anon classes extending/implementing</span>
</span><span class="l" id="348">348                 <span class="php-keyword1">if</span> (<span class="php-var">$name</span> === <span class="php-quote">'extends'</span> || <span class="php-var">$name</span> === <span class="php-quote">'implements'</span>) {
</span><span class="l" id="349">349                     <span class="php-keyword1">continue</span>;
</span><span class="l" id="350">350                 }
</span><span class="l" id="351">351                 <span class="php-keyword1">if</span> (<span class="php-var">$name</span>[<span class="php-num">0</span>] === <span class="php-quote">':'</span>) {
</span><span class="l" id="352">352                     <span class="php-comment">// This is an XHP class, https://github.com/facebook/xhp</span>
</span><span class="l" id="353">353                     <span class="php-var">$name</span> = <span class="php-quote">'xhp'</span>.<span class="php-keyword2">substr</span>(<span class="php-keyword2">str_replace</span>([<span class="php-quote">'-'</span>, <span class="php-quote">':'</span>], [<span class="php-quote">'_'</span>, <span class="php-quote">'__'</span>], <span class="php-var">$name</span>), <span class="php-num">1</span>);
</span><span class="l" id="354">354                 } <span class="php-keyword1">elseif</span> (<span class="php-var">$matches</span>[<span class="php-quote">'type'</span>][<span class="php-var">$i</span>] === <span class="php-quote">'enum'</span>) {
</span><span class="l" id="355">355                     <span class="php-comment">// In Hack, something like:</span>
</span><span class="l" id="356">356                     <span class="php-comment">//   enum Foo: int { HERP = '123'; }</span>
</span><span class="l" id="357">357                     <span class="php-comment">// The regex above captures the colon, which isn't part of</span>
</span><span class="l" id="358">358                     <span class="php-comment">// the class name.</span>
</span><span class="l" id="359">359                     <span class="php-var">$name</span> = <span class="php-keyword2">rtrim</span>(<span class="php-var">$name</span>, <span class="php-quote">':'</span>);
</span><span class="l" id="360">360                 }
</span><span class="l" id="361">361                 <span class="php-var">$classes</span>[] = <span class="php-keyword2">ltrim</span>(<span class="php-var">$namespace</span> . <span class="php-var">$name</span>, <span class="php-quote">'\\'</span>);
</span><span class="l" id="362">362             }
</span><span class="l" id="363">363         }
</span><span class="l" id="364">364 
</span><span class="l" id="365">365         <span class="php-keyword1">return</span> <span class="php-var">$classes</span>;
</span><span class="l" id="366">366     }
</span><span class="l" id="367">367 }
</span><span class="l" id="368">368 </span></code></pre>
 </body>
</html>
