<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * @package redaxo\backup
</span></span><span class="l" id="5">  5 <span class="php-comment"> */</span>
</span><span class="l" id="6">  6 <span class="php-keyword1">class</span> rex_backup
</span><span class="l" id="7">  7 {
</span><span class="l" id="8">  8     <span class="php-keyword1">const</span> IMPORT_ARCHIVE = <span class="php-num">1</span>;
</span><span class="l" id="9">  9     <span class="php-keyword1">const</span> IMPORT_DB = <span class="php-num">2</span>;
</span><span class="l" id="10"> 10     <span class="php-keyword1">const</span> IMPORT_EVENT_PRE = <span class="php-num">3</span>;
</span><span class="l" id="11"> 11     <span class="php-keyword1">const</span> IMPORT_EVENT_POST = <span class="php-num">4</span>;
</span><span class="l" id="12"> 12 
</span><span class="l" id="13"> 13     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getDir()
</span><span class="l" id="14"> 14     {
</span><span class="l" id="15"> 15         <span class="php-var">$dir</span> = rex_path::addonData(<span class="php-quote">'backup'</span>);
</span><span class="l" id="16"> 16         rex_dir::create(<span class="php-var">$dir</span>);
</span><span class="l" id="17"> 17 
</span><span class="l" id="18"> 18         <span class="php-keyword1">return</span> <span class="php-var">$dir</span>;
</span><span class="l" id="19"> 19     }
</span><span class="l" id="20"> 20 
</span><span class="l" id="21"> 21     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getBackupFiles(<span class="php-var">$filePrefix</span>)
</span><span class="l" id="22"> 22     {
</span><span class="l" id="23"> 23         <span class="php-var">$dir</span> = self::getDir();
</span><span class="l" id="24"> 24 
</span><span class="l" id="25"> 25         <span class="php-var">$folder</span> = rex_finder::factory(<span class="php-var">$dir</span>)-&gt;filesOnly();
</span><span class="l" id="26"> 26 
</span><span class="l" id="27"> 27         <span class="php-var">$filtered</span> = [];
</span><span class="l" id="28"> 28         <span class="php-keyword1">foreach</span> (<span class="php-var">$folder</span> <span class="php-keyword1">as</span> <span class="php-var">$file</span>) {
</span><span class="l" id="29"> 29             <span class="php-var">$file</span> = <span class="php-var">$file</span>-&gt;getFilename();
</span><span class="l" id="30"> 30             <span class="php-keyword1">if</span> (<span class="php-keyword2">substr</span>(<span class="php-var">$file</span>, <span class="php-keyword2">strlen</span>(<span class="php-var">$file</span>) - <span class="php-keyword2">strlen</span>(<span class="php-var">$filePrefix</span>)) == <span class="php-var">$filePrefix</span>) {
</span><span class="l" id="31"> 31                 <span class="php-var">$filtered</span>[] = <span class="php-var">$file</span>;
</span><span class="l" id="32"> 32             }
</span><span class="l" id="33"> 33         }
</span><span class="l" id="34"> 34         <span class="php-var">$folder</span> = <span class="php-var">$filtered</span>;
</span><span class="l" id="35"> 35 
</span><span class="l" id="36"> 36         <span class="php-keyword2">usort</span>(<span class="php-var">$folder</span>, <span class="php-keyword1">function</span> (<span class="php-var">$file_a</span>, <span class="php-var">$file_b</span>) <span class="php-keyword1">use</span> (<span class="php-var">$dir</span>) {
</span><span class="l" id="37"> 37             <span class="php-var">$time_a</span> = <span class="php-keyword2">filemtime</span>(<span class="php-var">$dir</span> . <span class="php-quote">'/'</span> . <span class="php-var">$file_a</span>);
</span><span class="l" id="38"> 38             <span class="php-var">$time_b</span> = <span class="php-keyword2">filemtime</span>(<span class="php-var">$dir</span> . <span class="php-quote">'/'</span> . <span class="php-var">$file_b</span>);
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40             <span class="php-keyword1">if</span> (<span class="php-var">$time_a</span> == <span class="php-var">$time_b</span>) {
</span><span class="l" id="41"> 41                 <span class="php-keyword1">return</span> <span class="php-num">0</span>;
</span><span class="l" id="42"> 42             }
</span><span class="l" id="43"> 43 
</span><span class="l" id="44"> 44             <span class="php-keyword1">return</span> (<span class="php-var">$time_a</span> &gt; <span class="php-var">$time_b</span>) ? -<span class="php-num">1</span> : <span class="php-num">1</span>;
</span><span class="l" id="45"> 45         });
</span><span class="l" id="46"> 46 
</span><span class="l" id="47"> 47         <span class="php-keyword1">return</span> <span class="php-var">$folder</span>;
</span><span class="l" id="48"> 48     }
</span><span class="l" id="49"> 49 
</span><span class="l" id="50"> 50     <span class="php-comment">/**
</span></span><span class="l" id="51"> 51 <span class="php-comment">     * Importiert den SQL Dump $filename in die Datenbank.
</span></span><span class="l" id="52"> 52 <span class="php-comment">     *
</span></span><span class="l" id="53"> 53 <span class="php-comment">     * @param string $filename Pfad + Dateinamen zur SQL-Datei
</span></span><span class="l" id="54"> 54 <span class="php-comment">     *
</span></span><span class="l" id="55"> 55 <span class="php-comment">     * @return array Gibt ein Assoc. Array zurück.
</span></span><span class="l" id="56"> 56 <span class="php-comment">     *               'state' =&gt; boolean (Status ob fehler aufgetreten sind)
</span></span><span class="l" id="57"> 57 <span class="php-comment">     *               'message' =&gt; Evtl. Status/Fehlermeldung
</span></span><span class="l" id="58"> 58 <span class="php-comment">     */</span>
</span><span class="l" id="59"> 59     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> importDb(<span class="php-var">$filename</span>)
</span><span class="l" id="60"> 60     {
</span><span class="l" id="61"> 61         <span class="php-var">$return</span> = [];
</span><span class="l" id="62"> 62         <span class="php-var">$return</span>[<span class="php-quote">'state'</span>] = <span class="php-keyword1">false</span>;
</span><span class="l" id="63"> 63         <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = <span class="php-quote">''</span>;
</span><span class="l" id="64"> 64 
</span><span class="l" id="65"> 65         <span class="php-var">$msg</span> = <span class="php-quote">''</span>;
</span><span class="l" id="66"> 66         <span class="php-var">$error</span> = <span class="php-quote">''</span>;
</span><span class="l" id="67"> 67 
</span><span class="l" id="68"> 68         <span class="php-keyword1">if</span> (<span class="php-var">$filename</span> == <span class="php-quote">''</span> || <span class="php-keyword2">substr</span>(<span class="php-var">$filename</span>, -<span class="php-num">4</span>, <span class="php-num">4</span>) != <span class="php-quote">'.sql'</span>) {
</span><span class="l" id="69"> 69             <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = rex_i18n::msg(<span class="php-quote">'backup_no_import_file_chosen_or_wrong_version'</span>) . <span class="php-quote">'&lt;br&gt;'</span>;
</span><span class="l" id="70"> 70             <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="71"> 71         }
</span><span class="l" id="72"> 72 
</span><span class="l" id="73"> 73         <span class="php-var">$conts</span> = rex_file::get(<span class="php-var">$filename</span>);
</span><span class="l" id="74"> 74 
</span><span class="l" id="75"> 75         <span class="php-comment">// Versionsstempel prüfen</span>
</span><span class="l" id="76"> 76         <span class="php-comment">// ## Redaxo Database Dump Version x.x</span>
</span><span class="l" id="77"> 77         <span class="php-var">$mainVersion</span> = rex::getVersion(<span class="php-quote">'%s'</span>);
</span><span class="l" id="78"> 78         <span class="php-var">$version</span> = <span class="php-keyword2">strpos</span>(<span class="php-var">$conts</span>, <span class="php-quote">'## Redaxo Database Dump Version '</span> . <span class="php-var">$mainVersion</span>);
</span><span class="l" id="79"> 79         <span class="php-keyword1">if</span> (<span class="php-var">$version</span> === <span class="php-keyword1">false</span>) {
</span><span class="l" id="80"> 80             <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = rex_i18n::msg(<span class="php-quote">'backup_no_valid_import_file'</span>) . <span class="php-quote">'. [## Redaxo Database Dump Version '</span> . <span class="php-var">$mainVersion</span> . <span class="php-quote">'] is missing'</span>;
</span><span class="l" id="81"> 81             <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="82"> 82         }
</span><span class="l" id="83"> 83         <span class="php-comment">// Versionsstempel entfernen</span>
</span><span class="l" id="84"> 84         <span class="php-var">$conts</span> = <span class="php-keyword2">trim</span>(<span class="php-keyword2">str_replace</span>(<span class="php-quote">'## Redaxo Database Dump Version '</span> . <span class="php-var">$mainVersion</span>, <span class="php-quote">''</span>, <span class="php-var">$conts</span>));
</span><span class="l" id="85"> 85 
</span><span class="l" id="86"> 86         <span class="php-comment">// Prefix prüfen</span>
</span><span class="l" id="87"> 87         <span class="php-comment">// ## Prefix xxx_</span>
</span><span class="l" id="88"> 88         <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^## Prefix ([a-zA-Z0-9\_]*)/'</span>, <span class="php-var">$conts</span>, <span class="php-var">$matches</span>) &amp;&amp; <span class="php-keyword1">isset</span>(<span class="php-var">$matches</span>[<span class="php-num">1</span>])) {
</span><span class="l" id="89"> 89             <span class="php-comment">// prefix entfernen</span>
</span><span class="l" id="90"> 90             <span class="php-var">$prefix</span> = <span class="php-var">$matches</span>[<span class="php-num">1</span>];
</span><span class="l" id="91"> 91             <span class="php-var">$conts</span> = <span class="php-keyword2">trim</span>(<span class="php-keyword2">str_replace</span>(<span class="php-quote">'## Prefix '</span> . <span class="php-var">$prefix</span>, <span class="php-quote">''</span>, <span class="php-var">$conts</span>));
</span><span class="l" id="92"> 92         } <span class="php-keyword1">else</span> {
</span><span class="l" id="93"> 93             <span class="php-comment">// Prefix wurde nicht gefunden</span>
</span><span class="l" id="94"> 94             <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = rex_i18n::msg(<span class="php-quote">'backup_no_valid_import_file'</span>) . <span class="php-quote">'. [## Prefix '</span> . rex::getTablePrefix() . <span class="php-quote">'] is missing'</span>;
</span><span class="l" id="95"> 95             <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="96"> 96         }
</span><span class="l" id="97"> 97 
</span><span class="l" id="98"> 98         <span class="php-comment">// Charset prüfen</span>
</span><span class="l" id="99"> 99         <span class="php-comment">// ## charset xxx_</span>
</span><span class="l" id="100">100         <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^## charset ([a-zA-Z0-9\_\-]*)/'</span>, <span class="php-var">$conts</span>, <span class="php-var">$matches</span>) &amp;&amp; <span class="php-keyword1">isset</span>(<span class="php-var">$matches</span>[<span class="php-num">1</span>])) {
</span><span class="l" id="101">101             <span class="php-comment">// charset entfernen</span>
</span><span class="l" id="102">102             <span class="php-var">$charset</span> = <span class="php-var">$matches</span>[<span class="php-num">1</span>];
</span><span class="l" id="103">103             <span class="php-var">$conts</span> = <span class="php-keyword2">trim</span>(<span class="php-keyword2">str_replace</span>(<span class="php-quote">'## charset '</span> . <span class="php-var">$charset</span>, <span class="php-quote">''</span>, <span class="php-var">$conts</span>));
</span><span class="l" id="104">104 
</span><span class="l" id="105">105             <span class="php-var">$rexCharset</span> = <span class="php-quote">'utf-8'</span>;
</span><span class="l" id="106">106             <span class="php-keyword1">if</span> (<span class="php-var">$rexCharset</span> != <span class="php-var">$charset</span>) {
</span><span class="l" id="107">107                 <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = rex_i18n::msg(<span class="php-quote">'backup_no_valid_charset'</span>) . <span class="php-quote">'. '</span> . <span class="php-var">$rexCharset</span> . <span class="php-quote">' != '</span> . <span class="php-var">$charset</span>;
</span><span class="l" id="108">108                 <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="109">109             }
</span><span class="l" id="110">110         }
</span><span class="l" id="111">111 
</span><span class="l" id="112">112         <span class="php-comment">// Prefix im export mit dem der installation angleichen</span>
</span><span class="l" id="113">113         <span class="php-keyword1">if</span> (rex::getTablePrefix() != <span class="php-var">$prefix</span>) {
</span><span class="l" id="114">114             <span class="php-comment">// Hier case-insensitiv ersetzen, damit alle möglich Schreibweisen (TABLE TablE, tAblE,..) ersetzt werden</span>
</span><span class="l" id="115">115             <span class="php-comment">// Dies ist wichtig, da auch SQLs innerhalb von Ein/Ausgabe der Module vom rex-admin verwendet werden</span>
</span><span class="l" id="116">116             <span class="php-var">$conts</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'/(TABLES? `?)'</span> . <span class="php-keyword2">preg_quote</span>(<span class="php-var">$prefix</span>, <span class="php-quote">'/'</span>) . <span class="php-quote">'/i'</span>, <span class="php-quote">'$1'</span> . rex::getTablePrefix(), <span class="php-var">$conts</span>);
</span><span class="l" id="117">117             <span class="php-var">$conts</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'/(INTO `?)'</span>  . <span class="php-keyword2">preg_quote</span>(<span class="php-var">$prefix</span>, <span class="php-quote">'/'</span>) . <span class="php-quote">'/i'</span>, <span class="php-quote">'$1'</span> . rex::getTablePrefix(), <span class="php-var">$conts</span>);
</span><span class="l" id="118">118             <span class="php-var">$conts</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'/(EXISTS `?)'</span> . <span class="php-keyword2">preg_quote</span>(<span class="php-var">$prefix</span>, <span class="php-quote">'/'</span>) . <span class="php-quote">'/i'</span>, <span class="php-quote">'$1'</span> . rex::getTablePrefix(), <span class="php-var">$conts</span>);
</span><span class="l" id="119">119         }
</span><span class="l" id="120">120 
</span><span class="l" id="121">121         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="122">122         <span class="php-var">$filesize</span> = <span class="php-keyword2">filesize</span>(<span class="php-var">$filename</span>);
</span><span class="l" id="123">123         <span class="php-var">$msg</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_BEFORE_DB_IMPORT'</span>, <span class="php-var">$msg</span>, [
</span><span class="l" id="124">124             <span class="php-quote">'content'</span> =&gt; <span class="php-var">$conts</span>,
</span><span class="l" id="125">125             <span class="php-quote">'filename'</span> =&gt; <span class="php-var">$filename</span>,
</span><span class="l" id="126">126             <span class="php-quote">'filesize'</span> =&gt; <span class="php-var">$filesize</span>,
</span><span class="l" id="127">127         ]));
</span><span class="l" id="128">128 
</span><span class="l" id="129">129         <span class="php-comment">// require import skript to do some userside-magic</span>
</span><span class="l" id="130">130         self::importScript(<span class="php-keyword2">str_replace</span>(<span class="php-quote">'.sql'</span>, <span class="php-quote">'.php'</span>, <span class="php-var">$filename</span>), self::IMPORT_DB, self::IMPORT_EVENT_PRE);
</span><span class="l" id="131">131 
</span><span class="l" id="132">132         <span class="php-comment">// Datei aufteilen</span>
</span><span class="l" id="133">133         <span class="php-var">$lines</span> = [];
</span><span class="l" id="134">134         rex_sql_util::splitSqlFile(<span class="php-var">$lines</span>, <span class="php-var">$conts</span>, <span class="php-num">0</span>);
</span><span class="l" id="135">135 
</span><span class="l" id="136">136         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="137">137         <span class="php-keyword1">foreach</span> (<span class="php-var">$lines</span> <span class="php-keyword1">as</span> <span class="php-var">$line</span>) {
</span><span class="l" id="138">138             <span class="php-keyword1">try</span> {
</span><span class="l" id="139">139                 <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-var">$line</span>[<span class="php-quote">'query'</span>]);
</span><span class="l" id="140">140             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="141">141                 <span class="php-var">$error</span> .= <span class="php-quote">"\n"</span> . <span class="php-var">$e</span>-&gt;getMessage();
</span><span class="l" id="142">142             }
</span><span class="l" id="143">143         }
</span><span class="l" id="144">144 
</span><span class="l" id="145">145         <span class="php-keyword1">if</span> (<span class="php-var">$error</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="146">146             <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = <span class="php-keyword2">trim</span>(<span class="php-var">$error</span>);
</span><span class="l" id="147">147             <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="148">148         }
</span><span class="l" id="149">149 
</span><span class="l" id="150">150         <span class="php-var">$msg</span> .= rex_i18n::msg(<span class="php-quote">'backup_database_imported'</span>) . <span class="php-quote">'. '</span> . rex_i18n::msg(<span class="php-quote">'backup_entry_count'</span>, <span class="php-keyword2">count</span>(<span class="php-var">$lines</span>)) . <span class="php-quote">'&lt;br /&gt;'</span>;
</span><span class="l" id="151">151         <span class="php-keyword1">unset</span>(<span class="php-var">$lines</span>);
</span><span class="l" id="152">152 
</span><span class="l" id="153">153         <span class="php-comment">// prüfen, ob eine user tabelle angelegt wurde</span>
</span><span class="l" id="154">154         <span class="php-var">$tables</span> = rex_sql::showTables();
</span><span class="l" id="155">155         <span class="php-var">$user_table_found</span> = <span class="php-keyword2">in_array</span>(rex::getTablePrefix() . <span class="php-quote">'user'</span>, <span class="php-var">$tables</span>);
</span><span class="l" id="156">156 
</span><span class="l" id="157">157         <span class="php-keyword1">if</span> (!<span class="php-var">$user_table_found</span>) {
</span><span class="l" id="158">158             <span class="php-var">$create_user_table</span> = <span class="php-quote">'
</span></span><span class="l" id="159">159 <span class="php-quote">             CREATE TABLE '</span> . rex::getTablePrefix() . <span class="php-quote">'user
</span></span><span class="l" id="160">160 <span class="php-quote">             (
</span></span><span class="l" id="161">161 <span class="php-quote">                 id int(11) NOT NULL auto_increment,
</span></span><span class="l" id="162">162 <span class="php-quote">                 name varchar(255) NOT NULL,
</span></span><span class="l" id="163">163 <span class="php-quote">                 description text NOT NULL,
</span></span><span class="l" id="164">164 <span class="php-quote">                 login varchar(50) NOT NULL,
</span></span><span class="l" id="165">165 <span class="php-quote">                 psw varchar(50) NOT NULL,
</span></span><span class="l" id="166">166 <span class="php-quote">                 status varchar(5) NOT NULL,
</span></span><span class="l" id="167">167 <span class="php-quote">                 role int(11) NOT NULL,
</span></span><span class="l" id="168">168 <span class="php-quote">                 rights text NOT NULL,
</span></span><span class="l" id="169">169 <span class="php-quote">                 login_tries tinyint(4) NOT NULL DEFAULT 0,
</span></span><span class="l" id="170">170 <span class="php-quote">                 createuser varchar(255) NOT NULL,
</span></span><span class="l" id="171">171 <span class="php-quote">                 updateuser varchar(255) NOT NULL,
</span></span><span class="l" id="172">172 <span class="php-quote">                 createdate datetime NOT NULL,
</span></span><span class="l" id="173">173 <span class="php-quote">                 updatedate datetime NOT NULL,
</span></span><span class="l" id="174">174 <span class="php-quote">                 lasttrydate datetime NOT NULL,
</span></span><span class="l" id="175">175 <span class="php-quote">                 session_id varchar(255) NOT NULL,
</span></span><span class="l" id="176">176 <span class="php-quote">                 PRIMARY KEY(id)
</span></span><span class="l" id="177">177 <span class="php-quote">             ) ENGINE=InnoDB  DEFAULT CHARSET=utf8;'</span>;
</span><span class="l" id="178">178             <span class="php-var">$db</span> = rex_sql::factory();
</span><span class="l" id="179">179             <span class="php-keyword1">try</span> {
</span><span class="l" id="180">180                 <span class="php-var">$db</span>-&gt;setQuery(<span class="php-var">$create_user_table</span>);
</span><span class="l" id="181">181             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="182">182                 <span class="php-comment">// evtl vorhergehende meldungen löschen, damit nur der fehler angezeigt wird</span>
</span><span class="l" id="183">183                 <span class="php-var">$msg</span> = <span class="php-quote">''</span>;
</span><span class="l" id="184">184                 <span class="php-var">$msg</span> .= <span class="php-var">$e</span>-&gt;getMessage();
</span><span class="l" id="185">185             }
</span><span class="l" id="186">186         }
</span><span class="l" id="187">187 
</span><span class="l" id="188">188         <span class="php-var">$user_role_table_found</span> = <span class="php-keyword2">in_array</span>(rex::getTablePrefix() . <span class="php-quote">'user_role'</span>, <span class="php-var">$tables</span>);
</span><span class="l" id="189">189         <span class="php-keyword1">if</span> (!<span class="php-var">$user_role_table_found</span>) {
</span><span class="l" id="190">190             <span class="php-var">$create_user_role_table</span> = <span class="php-quote">'
</span></span><span class="l" id="191">191 <span class="php-quote">             CREATE TABLE '</span> . rex::getTablePrefix() . <span class="php-quote">'user_role
</span></span><span class="l" id="192">192 <span class="php-quote">             (
</span></span><span class="l" id="193">193 <span class="php-quote">                 id int(11) NOT NULL auto_increment,
</span></span><span class="l" id="194">194 <span class="php-quote">                 name varchar(255) NOT NULL,
</span></span><span class="l" id="195">195 <span class="php-quote">                 description text NOT NULL,
</span></span><span class="l" id="196">196 <span class="php-quote">                 rights text NOT NULL,
</span></span><span class="l" id="197">197 <span class="php-quote">                 createuser varchar(255) NOT NULL,
</span></span><span class="l" id="198">198 <span class="php-quote">                 updateuser varchar(255) NOT NULL,
</span></span><span class="l" id="199">199 <span class="php-quote">                 createdate datetime NOT NULL DEFAULT 0,
</span></span><span class="l" id="200">200 <span class="php-quote">                 updatedate datetime NOT NULL DEFAULT 0
</span></span><span class="l" id="201">201 <span class="php-quote">                 PRIMARY KEY(id)
</span></span><span class="l" id="202">202 <span class="php-quote">             ) ENGINE=InnoDB  DEFAULT CHARSET=utf8;'</span>;
</span><span class="l" id="203">203             <span class="php-var">$db</span> = rex_sql::factory();
</span><span class="l" id="204">204             <span class="php-keyword1">try</span> {
</span><span class="l" id="205">205                 <span class="php-var">$db</span>-&gt;setQuery(<span class="php-var">$create_user_role_table</span>);
</span><span class="l" id="206">206             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="207">207                 <span class="php-comment">// evtl vorhergehende meldungen löschen, damit nur der fehler angezeigt wird</span>
</span><span class="l" id="208">208                 <span class="php-var">$msg</span> = <span class="php-quote">''</span>;
</span><span class="l" id="209">209                 <span class="php-var">$msg</span> .= <span class="php-var">$e</span>-&gt;getMessage();
</span><span class="l" id="210">210             }
</span><span class="l" id="211">211         }
</span><span class="l" id="212">212 
</span><span class="l" id="213">213         <span class="php-comment">// generated neu erstellen, wenn kein Fehler aufgetreten ist</span>
</span><span class="l" id="214">214         <span class="php-keyword1">if</span> (<span class="php-var">$error</span> == <span class="php-quote">''</span>) {
</span><span class="l" id="215">215             <span class="php-comment">// delete cache before EP to avoid obsolete caches while running extensions</span>
</span><span class="l" id="216">216             rex_delete_cache();
</span><span class="l" id="217">217 
</span><span class="l" id="218">218             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="219">219             <span class="php-var">$msg</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_AFTER_DB_IMPORT'</span>, <span class="php-var">$msg</span>, [
</span><span class="l" id="220">220                 <span class="php-quote">'content'</span> =&gt; <span class="php-var">$conts</span>,
</span><span class="l" id="221">221                 <span class="php-quote">'filename'</span> =&gt; <span class="php-var">$filename</span>,
</span><span class="l" id="222">222                 <span class="php-quote">'filesize'</span> =&gt; <span class="php-var">$filesize</span>,
</span><span class="l" id="223">223             ]));
</span><span class="l" id="224">224 
</span><span class="l" id="225">225             <span class="php-comment">// require import skript to do some userside-magic</span>
</span><span class="l" id="226">226             self::importScript(<span class="php-keyword2">str_replace</span>(<span class="php-quote">'.sql'</span>, <span class="php-quote">'.php'</span>, <span class="php-var">$filename</span>), self::IMPORT_DB, self::IMPORT_EVENT_POST);
</span><span class="l" id="227">227 
</span><span class="l" id="228">228             <span class="php-comment">// delete cache again because the extensions and the php script could have changed data again</span>
</span><span class="l" id="229">229             <span class="php-var">$msg</span> .= rex_delete_cache();
</span><span class="l" id="230">230             <span class="php-var">$return</span>[<span class="php-quote">'state'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="231">231         }
</span><span class="l" id="232">232 
</span><span class="l" id="233">233         <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = <span class="php-var">$msg</span>;
</span><span class="l" id="234">234 
</span><span class="l" id="235">235         <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="236">236     }
</span><span class="l" id="237">237 
</span><span class="l" id="238">238     <span class="php-comment">/**
</span></span><span class="l" id="239">239 <span class="php-comment">     * Importiert das Tar-Archiv $filename in den Ordner /files.
</span></span><span class="l" id="240">240 <span class="php-comment">     *
</span></span><span class="l" id="241">241 <span class="php-comment">     * @param string $filename Pfad + Dateinamen zum Tar-Archiv
</span></span><span class="l" id="242">242 <span class="php-comment">     *
</span></span><span class="l" id="243">243 <span class="php-comment">     * @return array Gibt ein Assoc. Array zurück.
</span></span><span class="l" id="244">244 <span class="php-comment">     *               'state' =&gt; boolean (Status ob fehler aufgetreten sind)
</span></span><span class="l" id="245">245 <span class="php-comment">     *               'message' =&gt; Evtl. Status/Fehlermeldung
</span></span><span class="l" id="246">246 <span class="php-comment">     */</span>
</span><span class="l" id="247">247     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> importFiles(<span class="php-var">$filename</span>)
</span><span class="l" id="248">248     {
</span><span class="l" id="249">249         <span class="php-var">$return</span> = [];
</span><span class="l" id="250">250         <span class="php-var">$return</span>[<span class="php-quote">'state'</span>] = <span class="php-keyword1">false</span>;
</span><span class="l" id="251">251 
</span><span class="l" id="252">252         <span class="php-keyword1">if</span> (<span class="php-var">$filename</span> == <span class="php-quote">''</span> || <span class="php-keyword2">substr</span>(<span class="php-var">$filename</span>, -<span class="php-num">7</span>, <span class="php-num">7</span>) != <span class="php-quote">'.tar.gz'</span>) {
</span><span class="l" id="253">253             <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = rex_i18n::msg(<span class="php-quote">'backup_no_import_file_chosen'</span>) . <span class="php-quote">'&lt;br /&gt;'</span>;
</span><span class="l" id="254">254             <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="255">255         }
</span><span class="l" id="256">256 
</span><span class="l" id="257">257         <span class="php-comment">// Ordner /files komplett leeren</span>
</span><span class="l" id="258">258         rex_dir::deleteFiles(rex_path::media());
</span><span class="l" id="259">259 
</span><span class="l" id="260">260         <span class="php-var">$tar</span> = <span class="php-keyword1">new</span> rex_backup_tar();
</span><span class="l" id="261">261 
</span><span class="l" id="262">262         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="263">263         <span class="php-var">$tar</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_BEFORE_FILE_IMPORT'</span>, <span class="php-var">$tar</span>));
</span><span class="l" id="264">264 
</span><span class="l" id="265">265         <span class="php-comment">// require import skript to do some userside-magic</span>
</span><span class="l" id="266">266         self::importScript(<span class="php-keyword2">str_replace</span>(<span class="php-quote">'.tar.gz'</span>, <span class="php-quote">'.php'</span>, <span class="php-var">$filename</span>), self::IMPORT_ARCHIVE, self::IMPORT_EVENT_PRE);
</span><span class="l" id="267">267 
</span><span class="l" id="268">268         <span class="php-var">$tar</span>-&gt;openTAR(<span class="php-var">$filename</span>);
</span><span class="l" id="269">269         <span class="php-keyword1">if</span> (!<span class="php-var">$tar</span>-&gt;extractTar()) {
</span><span class="l" id="270">270             <span class="php-var">$msg</span> = rex_i18n::msg(<span class="php-quote">'backup_problem_when_extracting'</span>) . <span class="php-quote">'&lt;br /&gt;'</span>;
</span><span class="l" id="271">271             <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$tar</span>-&gt;getMessages()) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="272">272                 <span class="php-var">$msg</span> .= rex_i18n::msg(<span class="php-quote">'backup_create_dirs_manually'</span>) . <span class="php-quote">'&lt;br /&gt;'</span>;
</span><span class="l" id="273">273                 <span class="php-keyword1">foreach</span> (<span class="php-var">$tar</span>-&gt;getMessages() <span class="php-keyword1">as</span> <span class="php-var">$_message</span>) {
</span><span class="l" id="274">274                     <span class="php-var">$msg</span> .= rex_path::absolute(<span class="php-var">$_message</span>) . <span class="php-quote">'&lt;br /&gt;'</span>;
</span><span class="l" id="275">275                 }
</span><span class="l" id="276">276             }
</span><span class="l" id="277">277         } <span class="php-keyword1">else</span> {
</span><span class="l" id="278">278             <span class="php-var">$msg</span> = rex_i18n::msg(<span class="php-quote">'backup_file_imported'</span>) . <span class="php-quote">'&lt;br /&gt;'</span>;
</span><span class="l" id="279">279         }
</span><span class="l" id="280">280 
</span><span class="l" id="281">281         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="282">282         <span class="php-var">$tar</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_AFTER_FILE_IMPORT'</span>, <span class="php-var">$tar</span>));
</span><span class="l" id="283">283 
</span><span class="l" id="284">284         <span class="php-comment">// require import skript to do some userside-magic</span>
</span><span class="l" id="285">285         self::importScript(<span class="php-keyword2">str_replace</span>(<span class="php-quote">'.tar.gz'</span>, <span class="php-quote">'.php'</span>, <span class="php-var">$filename</span>), self::IMPORT_ARCHIVE, self::IMPORT_EVENT_POST);
</span><span class="l" id="286">286 
</span><span class="l" id="287">287         <span class="php-var">$return</span>[<span class="php-quote">'state'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="288">288         <span class="php-var">$return</span>[<span class="php-quote">'message'</span>] = <span class="php-var">$msg</span>;
</span><span class="l" id="289">289         <span class="php-keyword1">return</span> <span class="php-var">$return</span>;
</span><span class="l" id="290">290     }
</span><span class="l" id="291">291 
</span><span class="l" id="292">292     <span class="php-comment">/**
</span></span><span class="l" id="293">293 <span class="php-comment">     * Erstellt einen SQL Dump, der die aktuellen Datebankstruktur darstellt.
</span></span><span class="l" id="294">294 <span class="php-comment">     * Dieser wird in der Datei $filename gespeichert.
</span></span><span class="l" id="295">295 <span class="php-comment">     *
</span></span><span class="l" id="296">296 <span class="php-comment">     * @param string $filename
</span></span><span class="l" id="297">297 <span class="php-comment">     * @param array  $tables
</span></span><span class="l" id="298">298 <span class="php-comment">     *
</span></span><span class="l" id="299">299 <span class="php-comment">     * @return bool TRUE wenn ein Dump erstellt wurde, sonst FALSE
</span></span><span class="l" id="300">300 <span class="php-comment">     */</span>
</span><span class="l" id="301">301     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> exportDb(<span class="php-var">$filename</span>, <span class="php-keyword1">array</span> <span class="php-var">$tables</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="302">302     {
</span><span class="l" id="303">303         <span class="php-var">$fp</span> = @<span class="php-keyword2">tmpfile</span>();
</span><span class="l" id="304">304         <span class="php-var">$tempCacheFile</span> = <span class="php-keyword1">null</span>;
</span><span class="l" id="305">305 
</span><span class="l" id="306">306         <span class="php-comment">// in case of permission issues/misconfigured tmp-folders</span>
</span><span class="l" id="307">307         <span class="php-keyword1">if</span> (!<span class="php-var">$fp</span>) {
</span><span class="l" id="308">308             <span class="php-var">$tempCacheFile</span> = rex_path::cache(<span class="php-keyword2">basename</span>(<span class="php-var">$filename</span>));
</span><span class="l" id="309">309             <span class="php-var">$fp</span> = <span class="php-keyword2">fopen</span>(<span class="php-var">$tempCacheFile</span>, <span class="php-quote">'w'</span>);
</span><span class="l" id="310">310             <span class="php-keyword1">if</span> (!<span class="php-var">$fp</span>) {
</span><span class="l" id="311">311                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="312">312             }
</span><span class="l" id="313">313         }
</span><span class="l" id="314">314 
</span><span class="l" id="315">315         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="316">316 
</span><span class="l" id="317">317         <span class="php-var">$nl</span> = <span class="php-quote">"\n"</span>;
</span><span class="l" id="318">318         <span class="php-var">$insertSize</span> = <span class="php-num">4000</span>;
</span><span class="l" id="319">319 
</span><span class="l" id="320">320         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="321">321         rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_BEFORE_DB_EXPORT'</span>));
</span><span class="l" id="322">322 
</span><span class="l" id="323">323         <span class="php-comment">// Versionsstempel hinzufügen</span>
</span><span class="l" id="324">324         <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-quote">'## Redaxo Database Dump Version '</span> . rex::getVersion(<span class="php-quote">'%s'</span>) . <span class="php-var">$nl</span>);
</span><span class="l" id="325">325         <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-quote">'## Prefix '</span> . rex::getTablePrefix() . <span class="php-var">$nl</span>);
</span><span class="l" id="326">326         <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-quote">'## charset utf-8'</span> . <span class="php-var">$nl</span> . <span class="php-var">$nl</span>);
</span><span class="l" id="327">327         <span class="php-comment">//  fwrite($fp, '/*!40110 START TRANSACTION; */'.$nl);</span>
</span><span class="l" id="328">328 
</span><span class="l" id="329">329         <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-quote">'SET FOREIGN_KEY_CHECKS = 0;'</span> . <span class="php-var">$nl</span> . <span class="php-var">$nl</span>);
</span><span class="l" id="330">330 
</span><span class="l" id="331">331         <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> === <span class="php-var">$tables</span>) {
</span><span class="l" id="332">332             <span class="php-var">$tables</span> = [];
</span><span class="l" id="333">333             <span class="php-keyword1">foreach</span> (rex_sql::showTables(<span class="php-num">1</span>, rex::getTablePrefix()) <span class="php-keyword1">as</span> <span class="php-var">$table</span>) {
</span><span class="l" id="334">334                 <span class="php-keyword1">if</span> (<span class="php-var">$table</span> != rex::getTable(<span class="php-quote">'user'</span>) <span class="php-comment">// User Tabelle nicht exportieren</span>
</span><span class="l" id="335">335                     &amp;&amp; <span class="php-keyword2">substr</span>(<span class="php-var">$table</span>, <span class="php-num">0</span>, <span class="php-keyword2">strlen</span>(rex::getTablePrefix() . rex::getTempPrefix())) != rex::getTablePrefix() . rex::getTempPrefix()
</span><span class="l" id="336">336                 ) { <span class="php-comment">// Tabellen die mit rex_tmp_ beginnne, werden nicht exportiert!</span>
</span><span class="l" id="337">337                     <span class="php-var">$tables</span>[] = <span class="php-var">$table</span>;
</span><span class="l" id="338">338                 }
</span><span class="l" id="339">339             }
</span><span class="l" id="340">340         }
</span><span class="l" id="341">341         <span class="php-keyword1">foreach</span> (<span class="php-var">$tables</span> <span class="php-keyword1">as</span> <span class="php-var">$table</span>) {
</span><span class="l" id="342">342             <span class="php-comment">//---- export metadata</span>
</span><span class="l" id="343">343             <span class="php-var">$create</span> = rex_sql::showCreateTable(<span class="php-var">$table</span>);
</span><span class="l" id="344">344 
</span><span class="l" id="345">345             <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-quote">'DROP TABLE IF EXISTS '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>) . <span class="php-quote">';'</span> . <span class="php-var">$nl</span>);
</span><span class="l" id="346">346             <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-var">$create</span> . <span class="php-quote">';'</span> . <span class="php-var">$nl</span>);
</span><span class="l" id="347">347 
</span><span class="l" id="348">348             <span class="php-var">$fields</span> = <span class="php-var">$sql</span>-&gt;getArray(<span class="php-quote">'SHOW FIELDS FROM '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>));
</span><span class="l" id="349">349 
</span><span class="l" id="350">350             <span class="php-keyword1">foreach</span> (<span class="php-var">$fields</span> <span class="php-keyword1">as</span> &amp;<span class="php-var">$field</span>) {
</span><span class="l" id="351">351                 <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'#^(bigint|int|smallint|mediumint|tinyint|timestamp)#i'</span>, <span class="php-var">$field</span>[<span class="php-quote">'Type'</span>])) {
</span><span class="l" id="352">352                     <span class="php-var">$field</span> = <span class="php-quote">'int'</span>;
</span><span class="l" id="353">353                 } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'#^(float|double|decimal)#'</span>, <span class="php-var">$field</span>[<span class="php-quote">'Type'</span>])) {
</span><span class="l" id="354">354                     <span class="php-var">$field</span> = <span class="php-quote">'double'</span>;
</span><span class="l" id="355">355                 } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">'#^(char|varchar|text|longtext|mediumtext|tinytext)#'</span>, <span class="php-var">$field</span>[<span class="php-quote">'Type'</span>])) {
</span><span class="l" id="356">356                     <span class="php-var">$field</span> = <span class="php-quote">'string'</span>;
</span><span class="l" id="357">357                 }
</span><span class="l" id="358">358                 <span class="php-comment">// else ?</span>
</span><span class="l" id="359">359             }
</span><span class="l" id="360">360 
</span><span class="l" id="361">361             <span class="php-comment">//---- export tabledata</span>
</span><span class="l" id="362">362             <span class="php-var">$start</span> = <span class="php-num">0</span>;
</span><span class="l" id="363">363             <span class="php-var">$max</span> = <span class="php-var">$insertSize</span>;
</span><span class="l" id="364">364 
</span><span class="l" id="365">365             <span class="php-keyword1">do</span> {
</span><span class="l" id="366">366                 <span class="php-var">$array</span> = <span class="php-var">$sql</span>-&gt;getArray(<span class="php-quote">'SELECT * FROM '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>) . <span class="php-quote">' LIMIT '</span> . <span class="php-var">$start</span> . <span class="php-quote">','</span> . <span class="php-var">$max</span>, [], PDO::FETCH_NUM);
</span><span class="l" id="367">367                 <span class="php-var">$count</span> = <span class="php-var">$sql</span>-&gt;getRows();
</span><span class="l" id="368">368 
</span><span class="l" id="369">369                 <span class="php-keyword1">if</span> (<span class="php-var">$count</span> &gt; <span class="php-num">0</span> &amp;&amp; <span class="php-var">$start</span> == <span class="php-num">0</span>) {
</span><span class="l" id="370">370                     <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-var">$nl</span> . <span class="php-quote">'LOCK TABLES '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>) . <span class="php-quote">' WRITE;'</span>);
</span><span class="l" id="371">371                     <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-var">$nl</span> . <span class="php-quote">'/*!40000 ALTER TABLE '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>) . <span class="php-quote">' DISABLE KEYS */;'</span>);
</span><span class="l" id="372">372                 } <span class="php-keyword1">elseif</span> (<span class="php-var">$count</span> == <span class="php-num">0</span>) {
</span><span class="l" id="373">373                     <span class="php-keyword1">break</span>;
</span><span class="l" id="374">374                 }
</span><span class="l" id="375">375 
</span><span class="l" id="376">376                 <span class="php-var">$start</span> += <span class="php-var">$max</span>;
</span><span class="l" id="377">377                 <span class="php-var">$values</span> = [];
</span><span class="l" id="378">378 
</span><span class="l" id="379">379                 <span class="php-keyword1">foreach</span> (<span class="php-var">$array</span> <span class="php-keyword1">as</span> <span class="php-var">$row</span>) {
</span><span class="l" id="380">380                     <span class="php-var">$record</span> = [];
</span><span class="l" id="381">381 
</span><span class="l" id="382">382                     <span class="php-keyword1">foreach</span> (<span class="php-var">$fields</span> <span class="php-keyword1">as</span> <span class="php-var">$idx</span> =&gt; <span class="php-var">$type</span>) {
</span><span class="l" id="383">383                         <span class="php-var">$column</span> = <span class="php-var">$row</span>[<span class="php-var">$idx</span>];
</span><span class="l" id="384">384 
</span><span class="l" id="385">385                         <span class="php-keyword1">switch</span> (<span class="php-var">$type</span>) {
</span><span class="l" id="386">386                             <span class="php-keyword1">case</span> <span class="php-quote">'int'</span>:
</span><span class="l" id="387">387                                 <span class="php-var">$record</span>[] = (int) <span class="php-var">$column</span>;
</span><span class="l" id="388">388                                 <span class="php-keyword1">break</span>;
</span><span class="l" id="389">389                             <span class="php-keyword1">case</span> <span class="php-quote">'double'</span>:
</span><span class="l" id="390">390                                 <span class="php-var">$record</span>[] = <span class="php-keyword2">sprintf</span>(<span class="php-quote">'%.10F'</span>, (float) <span class="php-var">$column</span>);
</span><span class="l" id="391">391                                 <span class="php-keyword1">break</span>;
</span><span class="l" id="392">392                             <span class="php-keyword1">case</span> <span class="php-quote">'string'</span>:
</span><span class="l" id="393">393                             <span class="php-keyword1">default</span>:
</span><span class="l" id="394">394                                 <span class="php-var">$record</span>[] = <span class="php-var">$sql</span>-&gt;escape(<span class="php-var">$column</span>, <span class="php-quote">"'"</span>);
</span><span class="l" id="395">395                                 <span class="php-keyword1">break</span>;
</span><span class="l" id="396">396                         }
</span><span class="l" id="397">397                     }
</span><span class="l" id="398">398 
</span><span class="l" id="399">399                     <span class="php-var">$values</span>[] = <span class="php-var">$nl</span> . <span class="php-quote">'  ('</span> . <span class="php-keyword2">implode</span>(<span class="php-quote">','</span>, <span class="php-var">$record</span>) . <span class="php-quote">')'</span>;
</span><span class="l" id="400">400                 }
</span><span class="l" id="401">401 
</span><span class="l" id="402">402                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$values</span>)) {
</span><span class="l" id="403">403                     <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-var">$nl</span> . <span class="php-quote">'INSERT INTO '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>) . <span class="php-quote">' VALUES '</span> . <span class="php-keyword2">implode</span>(<span class="php-quote">','</span>, <span class="php-var">$values</span>) . <span class="php-quote">';'</span>);
</span><span class="l" id="404">404                     <span class="php-keyword1">unset</span>(<span class="php-var">$values</span>);
</span><span class="l" id="405">405                 }
</span><span class="l" id="406">406             } <span class="php-keyword1">while</span> (<span class="php-var">$count</span> &gt;= <span class="php-var">$max</span>);
</span><span class="l" id="407">407 
</span><span class="l" id="408">408             <span class="php-keyword1">if</span> (<span class="php-var">$start</span> &gt; <span class="php-num">0</span>) {
</span><span class="l" id="409">409                 <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-var">$nl</span> . <span class="php-quote">'/*!40000 ALTER TABLE '</span> . <span class="php-var">$sql</span>-&gt;escapeIdentifier(<span class="php-var">$table</span>) . <span class="php-quote">' ENABLE KEYS */;'</span>);
</span><span class="l" id="410">410                 <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-var">$nl</span> . <span class="php-quote">'UNLOCK TABLES;'</span> . <span class="php-var">$nl</span> . <span class="php-var">$nl</span>);
</span><span class="l" id="411">411             }
</span><span class="l" id="412">412         }
</span><span class="l" id="413">413 
</span><span class="l" id="414">414         <span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-quote">'SET FOREIGN_KEY_CHECKS = 1;'</span> . <span class="php-var">$nl</span>);
</span><span class="l" id="415">415 
</span><span class="l" id="416">416         <span class="php-var">$hasContent</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="417">417 
</span><span class="l" id="418">418         <span class="php-comment">// Den Dateiinhalt geben wir nur dann weiter, wenn es unbedingt notwendig ist.</span>
</span><span class="l" id="419">419         <span class="php-keyword1">if</span> (rex_extension::isRegistered(<span class="php-quote">'BACKUP_AFTER_DB_EXPORT'</span>)) {
</span><span class="l" id="420">420             <span class="php-var">$content</span> = rex_file::get(<span class="php-var">$filename</span>);
</span><span class="l" id="421">421             <span class="php-var">$hashBefore</span> = <span class="php-keyword2">md5</span>(<span class="php-var">$content</span>);
</span><span class="l" id="422">422             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="423">423             <span class="php-var">$content</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_AFTER_DB_EXPORT'</span>, <span class="php-var">$content</span>));
</span><span class="l" id="424">424             <span class="php-var">$hashAfter</span> = <span class="php-keyword2">md5</span>(<span class="php-var">$content</span>);
</span><span class="l" id="425">425 
</span><span class="l" id="426">426             <span class="php-keyword1">if</span> (<span class="php-var">$hashAfter</span> != <span class="php-var">$hashBefore</span>) {
</span><span class="l" id="427">427                 rex_file::put(<span class="php-var">$filename</span>, <span class="php-var">$content</span>);
</span><span class="l" id="428">428                 <span class="php-var">$hasContent</span> = !<span class="php-keyword1">empty</span>(<span class="php-var">$content</span>);
</span><span class="l" id="429">429                 <span class="php-keyword1">unset</span>(<span class="php-var">$content</span>);
</span><span class="l" id="430">430             }
</span><span class="l" id="431">431         }
</span><span class="l" id="432">432 
</span><span class="l" id="433">433         <span class="php-comment">// Wenn das backup vollständig und erfolgreich erzeugt werden konnte, den Export 1:1 ans Ziel kopieren.</span>
</span><span class="l" id="434">434         <span class="php-keyword1">if</span> (<span class="php-var">$tempCacheFile</span>) {
</span><span class="l" id="435">435             <span class="php-keyword2">fclose</span>(<span class="php-var">$fp</span>);
</span><span class="l" id="436">436             <span class="php-keyword2">rename</span>(<span class="php-var">$tempCacheFile</span>, <span class="php-var">$filename</span>);
</span><span class="l" id="437">437         } <span class="php-keyword1">else</span> {
</span><span class="l" id="438">438             <span class="php-var">$destination</span> = <span class="php-keyword2">fopen</span>(<span class="php-var">$filename</span>, <span class="php-quote">'w'</span>);
</span><span class="l" id="439">439             <span class="php-keyword2">rewind</span>(<span class="php-var">$fp</span>);
</span><span class="l" id="440">440             <span class="php-keyword1">if</span> (!<span class="php-var">$destination</span>) {
</span><span class="l" id="441">441                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="442">442             }
</span><span class="l" id="443">443             <span class="php-keyword2">stream_copy_to_stream</span>(<span class="php-var">$fp</span>, <span class="php-var">$destination</span>);
</span><span class="l" id="444">444             <span class="php-keyword2">fclose</span>(<span class="php-var">$fp</span>);
</span><span class="l" id="445">445             <span class="php-keyword2">fclose</span>(<span class="php-var">$destination</span>);
</span><span class="l" id="446">446         }
</span><span class="l" id="447">447 
</span><span class="l" id="448">448         <span class="php-keyword1">return</span> <span class="php-var">$hasContent</span>;
</span><span class="l" id="449">449     }
</span><span class="l" id="450">450 
</span><span class="l" id="451">451     <span class="php-comment">/**
</span></span><span class="l" id="452">452 <span class="php-comment">     * Exportiert alle Ordner $folders aus dem Verzeichnis /files.
</span></span><span class="l" id="453">453 <span class="php-comment">     *
</span></span><span class="l" id="454">454 <span class="php-comment">     * @param array $folders Array von Ordnernamen, die exportiert werden sollen
</span></span><span class="l" id="455">455 <span class="php-comment">     *
</span></span><span class="l" id="456">456 <span class="php-comment">     * @return string Inhalt des Tar-Archives als String
</span></span><span class="l" id="457">457 <span class="php-comment">     */</span>
</span><span class="l" id="458">458     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> exportFiles(<span class="php-var">$folders</span>)
</span><span class="l" id="459">459     {
</span><span class="l" id="460">460         <span class="php-var">$tar</span> = <span class="php-keyword1">new</span> rex_backup_tar();
</span><span class="l" id="461">461 
</span><span class="l" id="462">462         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="463">463         <span class="php-var">$tar</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_BEFORE_FILE_EXPORT'</span>, <span class="php-var">$tar</span>));
</span><span class="l" id="464">464 
</span><span class="l" id="465">465         <span class="php-keyword1">foreach</span> (<span class="php-var">$folders</span> <span class="php-keyword1">as</span> <span class="php-var">$item</span>) {
</span><span class="l" id="466">466             self::addFolderToTar(<span class="php-var">$tar</span>, rex_url::frontend(), <span class="php-var">$item</span>);
</span><span class="l" id="467">467         }
</span><span class="l" id="468">468 
</span><span class="l" id="469">469         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="470">470         <span class="php-var">$tar</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'BACKUP_AFTER_FILE_EXPORT'</span>, <span class="php-var">$tar</span>));
</span><span class="l" id="471">471 
</span><span class="l" id="472">472         <span class="php-keyword1">return</span> <span class="php-var">$tar</span>-&gt;toTar(<span class="php-keyword1">null</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="473">473     }
</span><span class="l" id="474">474 
</span><span class="l" id="475">475     <span class="php-comment">/**
</span></span><span class="l" id="476">476 <span class="php-comment">     * Fügt einem Tar-Archiv ein Ordner von Dateien hinzu.
</span></span><span class="l" id="477">477 <span class="php-comment">     */</span>
</span><span class="l" id="478">478     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> addFolderToTar(rex_backup_tar <span class="php-var">$tar</span>, <span class="php-var">$path</span>, <span class="php-var">$dir</span>)
</span><span class="l" id="479">479     {
</span><span class="l" id="480">480         <span class="php-var">$handle</span> = <span class="php-keyword2">opendir</span>(<span class="php-var">$path</span> . <span class="php-var">$dir</span>);
</span><span class="l" id="481">481         <span class="php-var">$isMediafolder</span> = <span class="php-keyword2">realpath</span>(<span class="php-var">$path</span> . <span class="php-var">$dir</span>) . <span class="php-quote">'/'</span> == rex_path::media();
</span><span class="l" id="482">482         <span class="php-keyword1">while</span> (<span class="php-keyword1">false</span> !== (<span class="php-var">$file</span> = <span class="php-keyword2">readdir</span>(<span class="php-var">$handle</span>))) {
</span><span class="l" id="483">483             <span class="php-comment">// Alles exportieren, außer ...</span>
</span><span class="l" id="484">484             <span class="php-comment">// - addons verzeichnis im mediafolder (wird bei addoninstallation wiedererstellt)</span>
</span><span class="l" id="485">485             <span class="php-comment">// - svn infos</span>
</span><span class="l" id="486">486             <span class="php-comment">// - tmp prefix Dateien</span>
</span><span class="l" id="487">487 
</span><span class="l" id="488">488             <span class="php-keyword1">if</span> (<span class="php-var">$file</span> == <span class="php-quote">'.'</span> || <span class="php-var">$file</span> == <span class="php-quote">'..'</span> || <span class="php-var">$file</span> == <span class="php-quote">'.svn'</span>) {
</span><span class="l" id="489">489                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="490">490             }
</span><span class="l" id="491">491 
</span><span class="l" id="492">492             <span class="php-keyword1">if</span> (<span class="php-keyword2">substr</span>(<span class="php-var">$file</span>, <span class="php-num">0</span>, <span class="php-keyword2">strlen</span>(rex::getTempPrefix())) == rex::getTempPrefix()) {
</span><span class="l" id="493">493                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="494">494             }
</span><span class="l" id="495">495 
</span><span class="l" id="496">496             <span class="php-keyword1">if</span> (<span class="php-var">$isMediafolder</span> &amp;&amp; <span class="php-var">$file</span> == <span class="php-quote">'addons'</span>) {
</span><span class="l" id="497">497                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="498">498             }
</span><span class="l" id="499">499 
</span><span class="l" id="500">500             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_dir</span>(<span class="php-var">$path</span> . <span class="php-var">$dir</span> . <span class="php-quote">'/'</span> . <span class="php-var">$file</span>)) {
</span><span class="l" id="501">501                 self::addFolderToTar(<span class="php-var">$tar</span>, <span class="php-var">$path</span> . <span class="php-var">$dir</span> . <span class="php-quote">'/'</span>, <span class="php-var">$file</span>);
</span><span class="l" id="502">502             } <span class="php-keyword1">else</span> {
</span><span class="l" id="503">503                 <span class="php-var">$tar</span>-&gt;addFile(<span class="php-var">$path</span> . <span class="php-var">$dir</span> . <span class="php-quote">'/'</span> . <span class="php-var">$file</span>);
</span><span class="l" id="504">504             }
</span><span class="l" id="505">505         }
</span><span class="l" id="506">506         <span class="php-keyword2">closedir</span>(<span class="php-var">$handle</span>);
</span><span class="l" id="507">507     }
</span><span class="l" id="508">508 
</span><span class="l" id="509">509     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> importScript(<span class="php-var">$filename</span>, <span class="php-var">$importType</span>, <span class="php-var">$eventType</span>)
</span><span class="l" id="510">510     {
</span><span class="l" id="511">511         <span class="php-keyword1">if</span> (<span class="php-keyword2">file_exists</span>(<span class="php-var">$filename</span>)) {
</span><span class="l" id="512">512             <span class="php-keyword1">require</span> <span class="php-var">$filename</span>;
</span><span class="l" id="513">513         }
</span><span class="l" id="514">514     }
</span><span class="l" id="515">515 }
</span><span class="l" id="516">516 </span></code></pre>
 </body>
</html>
