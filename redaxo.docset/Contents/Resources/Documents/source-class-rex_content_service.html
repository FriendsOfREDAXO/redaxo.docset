<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * @package redaxo\structure\content
</span></span><span class="l" id="5">  5 <span class="php-comment"> */</span>
</span><span class="l" id="6">  6 <span class="php-keyword1">class</span> rex_content_service
</span><span class="l" id="7">  7 {
</span><span class="l" id="8">  8     <span class="php-comment">/**
</span></span><span class="l" id="9">  9 <span class="php-comment">     * Verschiebt einen Slice.
</span></span><span class="l" id="10"> 10 <span class="php-comment">     *
</span></span><span class="l" id="11"> 11 <span class="php-comment">     * @param int    $slice_id  Id des Slices
</span></span><span class="l" id="12"> 12 <span class="php-comment">     * @param int    $clang     Id der Sprache
</span></span><span class="l" id="13"> 13 <span class="php-comment">     * @param string $direction Richtung in die verschoben werden soll
</span></span><span class="l" id="14"> 14 <span class="php-comment">     *
</span></span><span class="l" id="15"> 15 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="16"> 16 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="17"> 17 <span class="php-comment">     *
</span></span><span class="l" id="18"> 18 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="19"> 19 <span class="php-comment">     */</span>
</span><span class="l" id="20"> 20     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> moveSlice(<span class="php-var">$slice_id</span>, <span class="php-var">$clang</span>, <span class="php-var">$direction</span>)
</span><span class="l" id="21"> 21     {
</span><span class="l" id="22"> 22         <span class="php-comment">// ctype beachten</span>
</span><span class="l" id="23"> 23         <span class="php-comment">// verschieben / vertauschen</span>
</span><span class="l" id="24"> 24         <span class="php-comment">// article regenerieren.</span>
</span><span class="l" id="25"> 25 
</span><span class="l" id="26"> 26         <span class="php-comment">// check if slice id is valid</span>
</span><span class="l" id="27"> 27         <span class="php-var">$CM</span> = rex_sql::factory();
</span><span class="l" id="28"> 28         <span class="php-var">$CM</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice where id=? and clang_id=?'</span>, [<span class="php-var">$slice_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="29"> 29         <span class="php-keyword1">if</span> (<span class="php-var">$CM</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="30"> 30             <span class="php-comment">// origin value for later success-check</span>
</span><span class="l" id="31"> 31             <span class="php-var">$oldPriority</span> = <span class="php-var">$CM</span>-&gt;getValue(<span class="php-quote">'priority'</span>);
</span><span class="l" id="32"> 32 
</span><span class="l" id="33"> 33             <span class="php-comment">// prepare sql for later saving</span>
</span><span class="l" id="34"> 34             <span class="php-var">$upd</span> = rex_sql::factory();
</span><span class="l" id="35"> 35             <span class="php-var">$upd</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article_slice'</span>);
</span><span class="l" id="36"> 36             <span class="php-var">$upd</span>-&gt;setWhere([
</span><span class="l" id="37"> 37                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$slice_id</span>,
</span><span class="l" id="38"> 38             ]);
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40             <span class="php-comment">// some vars for later use</span>
</span><span class="l" id="41"> 41             <span class="php-var">$article_id</span> = <span class="php-var">$CM</span>-&gt;getValue(<span class="php-quote">'article_id'</span>);
</span><span class="l" id="42"> 42             <span class="php-var">$ctype</span> = <span class="php-var">$CM</span>-&gt;getValue(<span class="php-quote">'ctype_id'</span>);
</span><span class="l" id="43"> 43             <span class="php-var">$slice_revision</span> = <span class="php-var">$CM</span>-&gt;getValue(<span class="php-quote">'revision'</span>);
</span><span class="l" id="44"> 44 
</span><span class="l" id="45"> 45             rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'SLICE_MOVE'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="46"> 46                 <span class="php-quote">'direction'</span> =&gt; <span class="php-var">$direction</span>,
</span><span class="l" id="47"> 47                 <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$slice_id</span>,
</span><span class="l" id="48"> 48                 <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$article_id</span>,
</span><span class="l" id="49"> 49                 <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="50"> 50                 <span class="php-quote">'slice_revision'</span> =&gt; <span class="php-var">$slice_revision</span>,
</span><span class="l" id="51"> 51             ]));
</span><span class="l" id="52"> 52 
</span><span class="l" id="53"> 53             <span class="php-keyword1">if</span> (<span class="php-var">$direction</span> == <span class="php-quote">'moveup'</span> || <span class="php-var">$direction</span> == <span class="php-quote">'movedown'</span>) {
</span><span class="l" id="54"> 54                 <span class="php-keyword1">if</span> (<span class="php-var">$direction</span> == <span class="php-quote">'moveup'</span>) {
</span><span class="l" id="55"> 55                     <span class="php-var">$upd</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-var">$CM</span>-&gt;getValue(<span class="php-quote">'priority'</span>) - <span class="php-num">1</span>);
</span><span class="l" id="56"> 56                     <span class="php-var">$updSort</span> = <span class="php-quote">'DESC'</span>;
</span><span class="l" id="57"> 57                 } <span class="php-keyword1">elseif</span> (<span class="php-var">$direction</span> == <span class="php-quote">'movedown'</span>) {
</span><span class="l" id="58"> 58                     <span class="php-var">$upd</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-var">$CM</span>-&gt;getValue(<span class="php-quote">'priority'</span>) + <span class="php-num">1</span>);
</span><span class="l" id="59"> 59                     <span class="php-var">$updSort</span> = <span class="php-quote">'ASC'</span>;
</span><span class="l" id="60"> 60                 }
</span><span class="l" id="61"> 61                 <span class="php-var">$upd</span>-&gt;addGlobalUpdateFields(self::getUser());
</span><span class="l" id="62"> 62                 <span class="php-var">$upd</span>-&gt;update();
</span><span class="l" id="63"> 63 
</span><span class="l" id="64"> 64                 rex_sql_util::organizePriorities(
</span><span class="l" id="65"> 65                     rex::getTable(<span class="php-quote">'article_slice'</span>),
</span><span class="l" id="66"> 66                     <span class="php-quote">'priority'</span>,
</span><span class="l" id="67"> 67                     <span class="php-quote">'article_id='</span> . (int) <span class="php-var">$article_id</span> . <span class="php-quote">' AND clang_id='</span> . (int) <span class="php-var">$clang</span> . <span class="php-quote">' AND ctype_id='</span> . (int) <span class="php-var">$ctype</span> . <span class="php-quote">' AND revision='</span> . (int) <span class="php-var">$slice_revision</span>,
</span><span class="l" id="68"> 68                     <span class="php-quote">'priority, updatedate '</span> . <span class="php-var">$updSort</span>
</span><span class="l" id="69"> 69                 );
</span><span class="l" id="70"> 70 
</span><span class="l" id="71"> 71                 <span class="php-comment">// check if the slice moved at all (first cannot be moved up, last not down)</span>
</span><span class="l" id="72"> 72                 <span class="php-var">$CM</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice where id=? and clang_id=?'</span>, [<span class="php-var">$slice_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="73"> 73                 <span class="php-var">$newPriority</span> = <span class="php-var">$CM</span>-&gt;getValue(<span class="php-quote">'priority'</span>);
</span><span class="l" id="74"> 74                 <span class="php-keyword1">if</span> (<span class="php-var">$oldPriority</span> == <span class="php-var">$newPriority</span>) {
</span><span class="l" id="75"> 75                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'slice_moved_error'</span>));
</span><span class="l" id="76"> 76                 }
</span><span class="l" id="77"> 77 
</span><span class="l" id="78"> 78                 rex_article_cache::deleteContent(<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>);
</span><span class="l" id="79"> 79             } <span class="php-keyword1">else</span> {
</span><span class="l" id="80"> 80                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-quote">'rex_moveSlice: Unsupported direction "'</span> . <span class="php-var">$direction</span> . <span class="php-quote">'"!'</span>);
</span><span class="l" id="81"> 81             }
</span><span class="l" id="82"> 82         } <span class="php-keyword1">else</span> {
</span><span class="l" id="83"> 83             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'slice_moved_error'</span>));
</span><span class="l" id="84"> 84         }
</span><span class="l" id="85"> 85 
</span><span class="l" id="86"> 86         <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'slice_moved'</span>);
</span><span class="l" id="87"> 87     }
</span><span class="l" id="88"> 88 
</span><span class="l" id="89"> 89     <span class="php-comment">/**
</span></span><span class="l" id="90"> 90 <span class="php-comment">     * Löscht einen Slice.
</span></span><span class="l" id="91"> 91 <span class="php-comment">     *
</span></span><span class="l" id="92"> 92 <span class="php-comment">     * @param int $slice_id Id des Slices
</span></span><span class="l" id="93"> 93 <span class="php-comment">     *
</span></span><span class="l" id="94"> 94 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="95"> 95 <span class="php-comment">     */</span>
</span><span class="l" id="96"> 96     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> deleteSlice(<span class="php-var">$slice_id</span>)
</span><span class="l" id="97"> 97     {
</span><span class="l" id="98"> 98         <span class="php-comment">// check if slice id is valid</span>
</span><span class="l" id="99"> 99         <span class="php-var">$curr</span> = rex_sql::factory();
</span><span class="l" id="100">100         <span class="php-var">$curr</span>-&gt;setQuery(<span class="php-quote">'SELECT * FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice WHERE id=?'</span>, [<span class="php-var">$slice_id</span>]);
</span><span class="l" id="101">101         <span class="php-keyword1">if</span> (<span class="php-var">$curr</span>-&gt;getRows() != <span class="php-num">1</span>) {
</span><span class="l" id="102">102             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="103">103         }
</span><span class="l" id="104">104 
</span><span class="l" id="105">105         rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'SLICE_DELETE'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="106">106             <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$slice_id</span>,
</span><span class="l" id="107">107             <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$curr</span>-&gt;getValue(<span class="php-quote">'article_id'</span>),
</span><span class="l" id="108">108             <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$curr</span>-&gt;getValue(<span class="php-quote">'clang_id'</span>),
</span><span class="l" id="109">109             <span class="php-quote">'slice_revision'</span> =&gt; <span class="php-var">$curr</span>-&gt;getValue(<span class="php-quote">'revision'</span>),
</span><span class="l" id="110">110         ]));
</span><span class="l" id="111">111 
</span><span class="l" id="112">112         <span class="php-comment">// delete the slice</span>
</span><span class="l" id="113">113         <span class="php-var">$del</span> = rex_sql::factory();
</span><span class="l" id="114">114         <span class="php-var">$del</span>-&gt;setQuery(<span class="php-quote">'DELETE FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice WHERE id=?'</span>, [<span class="php-var">$slice_id</span>]);
</span><span class="l" id="115">115 
</span><span class="l" id="116">116         <span class="php-comment">// reorg remaining slices</span>
</span><span class="l" id="117">117         rex_sql_util::organizePriorities(
</span><span class="l" id="118">118             rex::getTable(<span class="php-quote">'article_slice'</span>),
</span><span class="l" id="119">119             <span class="php-quote">'priority'</span>,
</span><span class="l" id="120">120             <span class="php-quote">'article_id='</span> . <span class="php-var">$curr</span>-&gt;getValue(<span class="php-quote">'article_id'</span>) . <span class="php-quote">' AND clang_id='</span> . <span class="php-var">$curr</span>-&gt;getValue(<span class="php-quote">'clang_id'</span>) . <span class="php-quote">' AND ctype_id='</span> . <span class="php-var">$curr</span>-&gt;getValue(<span class="php-quote">'ctype_id'</span>) . <span class="php-quote">' AND revision='</span> . <span class="php-var">$curr</span>-&gt;getValue(<span class="php-quote">'revision'</span>),
</span><span class="l" id="121">121             <span class="php-quote">'priority'</span>
</span><span class="l" id="122">122         );
</span><span class="l" id="123">123 
</span><span class="l" id="124">124         <span class="php-comment">// check if delete was successfull</span>
</span><span class="l" id="125">125         <span class="php-keyword1">return</span> <span class="php-var">$curr</span>-&gt;getRows() == <span class="php-num">1</span>;
</span><span class="l" id="126">126     }
</span><span class="l" id="127">127 
</span><span class="l" id="128">128     <span class="php-comment">/**
</span></span><span class="l" id="129">129 <span class="php-comment">     * Kopiert die Inhalte eines Artikels in einen anderen Artikel.
</span></span><span class="l" id="130">130 <span class="php-comment">     *
</span></span><span class="l" id="131">131 <span class="php-comment">     * @param int $from_id    ArtikelId des Artikels, aus dem kopiert werden (Quell ArtikelId)
</span></span><span class="l" id="132">132 <span class="php-comment">     * @param int $to_id      ArtikelId des Artikel, in den kopiert werden sollen (Ziel ArtikelId)
</span></span><span class="l" id="133">133 <span class="php-comment">     * @param int $from_clang ClangId des Artikels, aus dem kopiert werden soll (Quell ClangId)
</span></span><span class="l" id="134">134 <span class="php-comment">     * @param int $to_clang   ClangId des Artikels, in den kopiert werden soll (Ziel ClangId)
</span></span><span class="l" id="135">135 <span class="php-comment">     * @param int $revision
</span></span><span class="l" id="136">136 <span class="php-comment">     *
</span></span><span class="l" id="137">137 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="138">138 <span class="php-comment">     */</span>
</span><span class="l" id="139">139     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> copyContent(<span class="php-var">$from_id</span>, <span class="php-var">$to_id</span>, <span class="php-var">$from_clang</span> = <span class="php-num">1</span>, <span class="php-var">$to_clang</span> = <span class="php-num">1</span>, <span class="php-var">$revision</span> = <span class="php-num">0</span>)
</span><span class="l" id="140">140     {
</span><span class="l" id="141">141         <span class="php-keyword1">if</span> (<span class="php-var">$from_id</span> == <span class="php-var">$to_id</span> &amp;&amp; <span class="php-var">$from_clang</span> == <span class="php-var">$to_clang</span>) {
</span><span class="l" id="142">142             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="143">143         }
</span><span class="l" id="144">144 
</span><span class="l" id="145">145         <span class="php-var">$gc</span> = rex_sql::factory();
</span><span class="l" id="146">146         <span class="php-var">$gc</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice where article_id=? and clang_id=? and revision=?'</span>, [<span class="php-var">$from_id</span>, <span class="php-var">$from_clang</span>, <span class="php-var">$revision</span>]);
</span><span class="l" id="147">147 
</span><span class="l" id="148">148         <span class="php-keyword1">if</span> (!<span class="php-var">$gc</span>-&gt;getRows()) {
</span><span class="l" id="149">149             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="150">150         }
</span><span class="l" id="151">151 
</span><span class="l" id="152">152         rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'ART_SLICES_COPY'</span>, <span class="php-quote">''</span>, [
</span><span class="l" id="153">153             <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$to_id</span>,
</span><span class="l" id="154">154             <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$to_clang</span>,
</span><span class="l" id="155">155             <span class="php-quote">'slice_revision'</span> =&gt; <span class="php-var">$revision</span>,
</span><span class="l" id="156">156         ]));
</span><span class="l" id="157">157 
</span><span class="l" id="158">158         <span class="php-var">$ins</span> = rex_sql::factory();
</span><span class="l" id="159">159         <span class="php-comment">//$ins-&gt;setDebug();</span>
</span><span class="l" id="160">160         <span class="php-var">$ctypes</span> = [];
</span><span class="l" id="161">161 
</span><span class="l" id="162">162         <span class="php-var">$cols</span> = rex_sql::factory();
</span><span class="l" id="163">163         <span class="php-comment">//$cols-&gt;setDebug();</span>
</span><span class="l" id="164">164         <span class="php-var">$cols</span>-&gt;setQuery(<span class="php-quote">'SHOW COLUMNS FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article_slice'</span>);
</span><span class="l" id="165">165 
</span><span class="l" id="166">166         <span class="php-var">$maxPriority</span> = rex_sql::factory()-&gt;getArray(
</span><span class="l" id="167">167             <span class="php-quote">'SELECT `ctype_id`, MAX(`priority`) as max FROM '</span> . rex::getTable(<span class="php-quote">'article_slice'</span>) . <span class="php-quote">' WHERE `article_id` = :to_id AND `clang_id` = :to_clang AND `revision` = :revision GROUP BY `ctype_id`'</span>,
</span><span class="l" id="168">168             [<span class="php-quote">'to_id'</span> =&gt; <span class="php-var">$to_id</span>, <span class="php-quote">'to_clang'</span> =&gt; <span class="php-var">$to_clang</span>, <span class="php-quote">'revision'</span> =&gt; <span class="php-var">$revision</span>]
</span><span class="l" id="169">169         );
</span><span class="l" id="170">170         <span class="php-var">$maxPriority</span> = array_column(<span class="php-var">$maxPriority</span>, <span class="php-quote">'max'</span>, <span class="php-quote">'ctype_id'</span>);
</span><span class="l" id="171">171 
</span><span class="l" id="172">172         <span class="php-var">$user</span> = self::getUser();
</span><span class="l" id="173">173 
</span><span class="l" id="174">174         <span class="php-keyword1">foreach</span> (<span class="php-var">$gc</span> <span class="php-keyword1">as</span> <span class="php-var">$slice</span>) {
</span><span class="l" id="175">175             <span class="php-keyword1">foreach</span> (<span class="php-var">$cols</span> <span class="php-keyword1">as</span> <span class="php-var">$col</span>) {
</span><span class="l" id="176">176                 <span class="php-var">$colname</span> = <span class="php-var">$col</span>-&gt;getValue(<span class="php-quote">'Field'</span>);
</span><span class="l" id="177">177                 <span class="php-keyword1">if</span> (<span class="php-var">$colname</span> == <span class="php-quote">'clang_id'</span>) {
</span><span class="l" id="178">178                     <span class="php-var">$value</span> = <span class="php-var">$to_clang</span>;
</span><span class="l" id="179">179                 } <span class="php-keyword1">elseif</span> (<span class="php-var">$colname</span> == <span class="php-quote">'article_id'</span>) {
</span><span class="l" id="180">180                     <span class="php-var">$value</span> = <span class="php-var">$to_id</span>;
</span><span class="l" id="181">181                 } <span class="php-keyword1">elseif</span> (<span class="php-var">$colname</span> == <span class="php-quote">'priority'</span>) {
</span><span class="l" id="182">182                     <span class="php-var">$ctypeId</span> = <span class="php-var">$slice</span>-&gt;getValue(<span class="php-quote">'ctype_id'</span>);
</span><span class="l" id="183">183                     <span class="php-var">$value</span> = <span class="php-var">$slice</span>-&gt;getValue(<span class="php-var">$colname</span>) + (<span class="php-keyword1">isset</span>(<span class="php-var">$maxPriority</span>[<span class="php-var">$ctypeId</span>]) ? <span class="php-var">$maxPriority</span>[<span class="php-var">$ctypeId</span>] : <span class="php-num">0</span>);
</span><span class="l" id="184">184                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="185">185                     <span class="php-var">$value</span> = <span class="php-var">$slice</span>-&gt;getValue(<span class="php-var">$colname</span>);
</span><span class="l" id="186">186                 }
</span><span class="l" id="187">187 
</span><span class="l" id="188">188                 <span class="php-comment">// collect all affected ctypes</span>
</span><span class="l" id="189">189                 <span class="php-keyword1">if</span> (<span class="php-var">$colname</span> == <span class="php-quote">'ctype_id'</span>) {
</span><span class="l" id="190">190                     <span class="php-var">$ctypes</span>[<span class="php-var">$value</span>] = <span class="php-var">$value</span>;
</span><span class="l" id="191">191                 }
</span><span class="l" id="192">192 
</span><span class="l" id="193">193                 <span class="php-keyword1">if</span> (<span class="php-var">$colname</span> != <span class="php-quote">'id'</span>) {
</span><span class="l" id="194">194                     <span class="php-var">$ins</span>-&gt;setValue(<span class="php-var">$colname</span>, <span class="php-var">$value</span>);
</span><span class="l" id="195">195                 }
</span><span class="l" id="196">196             }
</span><span class="l" id="197">197 
</span><span class="l" id="198">198             <span class="php-var">$ins</span>-&gt;addGlobalUpdateFields(<span class="php-var">$user</span>);
</span><span class="l" id="199">199             <span class="php-var">$ins</span>-&gt;addGlobalCreateFields(<span class="php-var">$user</span>);
</span><span class="l" id="200">200             <span class="php-var">$ins</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article_slice'</span>);
</span><span class="l" id="201">201             <span class="php-var">$ins</span>-&gt;insert();
</span><span class="l" id="202">202         }
</span><span class="l" id="203">203 
</span><span class="l" id="204">204         <span class="php-keyword1">foreach</span> (<span class="php-var">$ctypes</span> <span class="php-keyword1">as</span> <span class="php-var">$ctype</span>) {
</span><span class="l" id="205">205             <span class="php-comment">// reorg slices</span>
</span><span class="l" id="206">206             rex_sql_util::organizePriorities(
</span><span class="l" id="207">207                 rex::getTable(<span class="php-quote">'article_slice'</span>),
</span><span class="l" id="208">208                 <span class="php-quote">'priority'</span>,
</span><span class="l" id="209">209                 <span class="php-quote">'article_id='</span> . (int) <span class="php-var">$to_id</span> . <span class="php-quote">' AND clang_id='</span> . (int) <span class="php-var">$to_clang</span> . <span class="php-quote">' AND ctype_id='</span> . (int) <span class="php-var">$ctype</span> . <span class="php-quote">' AND revision='</span> . (int) <span class="php-var">$revision</span>,
</span><span class="l" id="210">210                 <span class="php-quote">'priority, updatedate'</span>
</span><span class="l" id="211">211             );
</span><span class="l" id="212">212         }
</span><span class="l" id="213">213 
</span><span class="l" id="214">214         rex_article_cache::deleteContent(<span class="php-var">$to_id</span>, <span class="php-var">$to_clang</span>);
</span><span class="l" id="215">215 
</span><span class="l" id="216">216         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="217">217     }
</span><span class="l" id="218">218 
</span><span class="l" id="219">219     <span class="php-comment">/**
</span></span><span class="l" id="220">220 <span class="php-comment">     * Generiert den Artikel-Cache des Artikelinhalts.
</span></span><span class="l" id="221">221 <span class="php-comment">     *
</span></span><span class="l" id="222">222 <span class="php-comment">     * @param int $article_id Id des zu generierenden Artikels
</span></span><span class="l" id="223">223 <span class="php-comment">     * @param int $clang      ClangId des Artikels
</span></span><span class="l" id="224">224 <span class="php-comment">     *
</span></span><span class="l" id="225">225 <span class="php-comment">     * @return bool TRUE bei Erfolg, FALSE wenn eine ungütlige article_id übergeben wird, sonst eine Fehlermeldung
</span></span><span class="l" id="226">226 <span class="php-comment">     */</span>
</span><span class="l" id="227">227     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> generateArticleContent(<span class="php-var">$article_id</span>, <span class="php-var">$clang</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="228">228     {
</span><span class="l" id="229">229         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$_clang</span>) {
</span><span class="l" id="230">230             <span class="php-keyword1">if</span> (<span class="php-var">$clang</span> !== <span class="php-keyword1">null</span> &amp;&amp; <span class="php-var">$clang</span> != <span class="php-var">$_clang</span>) {
</span><span class="l" id="231">231                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="232">232             }
</span><span class="l" id="233">233 
</span><span class="l" id="234">234             <span class="php-var">$CONT</span> = <span class="php-keyword1">new</span> rex_article_content_base();
</span><span class="l" id="235">235             <span class="php-var">$CONT</span>-&gt;setCLang(<span class="php-var">$_clang</span>);
</span><span class="l" id="236">236             <span class="php-var">$CONT</span>-&gt;setEval(<span class="php-keyword1">false</span>); <span class="php-comment">// Content nicht ausführen, damit in Cachedatei gespeichert werden kann</span>
</span><span class="l" id="237">237             <span class="php-keyword1">if</span> (!<span class="php-var">$CONT</span>-&gt;setArticleId(<span class="php-var">$article_id</span>)) {
</span><span class="l" id="238">238                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="239">239             }
</span><span class="l" id="240">240 
</span><span class="l" id="241">241             <span class="php-comment">// --------------------------------------------------- Artikelcontent speichern</span>
</span><span class="l" id="242">242             <span class="php-var">$article_content_file</span> = rex_path::addonCache(<span class="php-quote">'structure'</span>, <span class="php-quote">"</span><span class="php-var">$article_id</span><span class="php-quote">.</span><span class="php-var">$_clang</span><span class="php-quote">.content"</span>);
</span><span class="l" id="243">243             <span class="php-var">$article_content</span> = <span class="php-var">$CONT</span>-&gt;getArticle();
</span><span class="l" id="244">244 
</span><span class="l" id="245">245             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="246">246             <span class="php-var">$article_content</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'GENERATE_FILTER'</span>, <span class="php-var">$article_content</span>, [
</span><span class="l" id="247">247                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$article_id</span>,
</span><span class="l" id="248">248                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$_clang</span>,
</span><span class="l" id="249">249                 <span class="php-quote">'article'</span> =&gt; <span class="php-var">$CONT</span>,
</span><span class="l" id="250">250             ]));
</span><span class="l" id="251">251 
</span><span class="l" id="252">252             <span class="php-keyword1">if</span> (rex_file::put(<span class="php-var">$article_content_file</span>, <span class="php-var">$article_content</span>) === <span class="php-keyword1">false</span>) {
</span><span class="l" id="253">253                 <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'article_could_not_be_generated'</span>) . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'check_rights_in_directory'</span>) . rex_path::addonCache(<span class="php-quote">'structure'</span>);
</span><span class="l" id="254">254             }
</span><span class="l" id="255">255         }
</span><span class="l" id="256">256 
</span><span class="l" id="257">257         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="258">258     }
</span><span class="l" id="259">259 
</span><span class="l" id="260">260     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getUser()
</span><span class="l" id="261">261     {
</span><span class="l" id="262">262         <span class="php-keyword1">if</span> (rex::getUser()) {
</span><span class="l" id="263">263             <span class="php-keyword1">return</span> rex::getUser()-&gt;getLogin();
</span><span class="l" id="264">264         }
</span><span class="l" id="265">265 
</span><span class="l" id="266">266         <span class="php-keyword1">if</span> (<span class="php-keyword2">method_exists</span>(rex::<span class="php-keyword1">class</span>, <span class="php-quote">'getEnvironment'</span>)) {
</span><span class="l" id="267">267             <span class="php-keyword1">return</span> rex::getEnvironment();
</span><span class="l" id="268">268         }
</span><span class="l" id="269">269 
</span><span class="l" id="270">270         <span class="php-keyword1">return</span> <span class="php-quote">'frontend'</span>;
</span><span class="l" id="271">271     }
</span><span class="l" id="272">272 }
</span><span class="l" id="273">273 </span></code></pre>
 </body>
</html>
