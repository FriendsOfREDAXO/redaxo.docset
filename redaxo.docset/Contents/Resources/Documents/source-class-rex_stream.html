<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Stream wrapper to include variables like files (php code will be evaluated).
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * Example:
</span></span><span class="l" id="7">  7 <span class="php-comment"> * &lt;code&gt;
</span></span><span class="l" id="8">  8 <span class="php-comment"> * &lt;?php
</span></span><span class="l" id="9">  9 <span class="php-comment"> *   include rex_stream::factory('myContent', '&lt;?php echo "Hello World"; ?&gt;');
</span></span><span class="l" id="10"> 10 <span class="php-comment"> * ?&gt;
</span></span><span class="l" id="11"> 11 <span class="php-comment"> * &lt;/code&gt;
</span></span><span class="l" id="12"> 12 <span class="php-comment"> *
</span></span><span class="l" id="13"> 13 <span class="php-comment"> * @author gharlan
</span></span><span class="l" id="14"> 14 <span class="php-comment"> *
</span></span><span class="l" id="15"> 15 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="16"> 16 <span class="php-comment"> *
</span></span><span class="l" id="17"> 17 <span class="php-comment"> * @see http://www.php.net/manual/en/class.streamwrapper.php
</span></span><span class="l" id="18"> 18 <span class="php-comment"> */</span>
</span><span class="l" id="19"> 19 <span class="php-keyword1">class</span> rex_stream
</span><span class="l" id="20"> 20 {
</span><span class="l" id="21"> 21     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$useRealFiles</span>;
</span><span class="l" id="22"> 22 
</span><span class="l" id="23"> 23     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$registered</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="24"> 24     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-var">$nextContent</span> = [];
</span><span class="l" id="25"> 25 
</span><span class="l" id="26"> 26     <span class="php-keyword1">private</span> <span class="php-var">$position</span>;
</span><span class="l" id="27"> 27     <span class="php-keyword1">private</span> <span class="php-var">$content</span>;
</span><span class="l" id="28"> 28 
</span><span class="l" id="29"> 29     <span class="php-comment">/**
</span></span><span class="l" id="30"> 30 <span class="php-comment">     * Prepares a new stream.
</span></span><span class="l" id="31"> 31 <span class="php-comment">     *
</span></span><span class="l" id="32"> 32 <span class="php-comment">     * @param string $path    Virtual path which should describe the content (e.g. "template/1"), only relevant for error messages
</span></span><span class="l" id="33"> 33 <span class="php-comment">     * @param string $content Content which will be included
</span></span><span class="l" id="34"> 34 <span class="php-comment">     *
</span></span><span class="l" id="35"> 35 <span class="php-comment">     * @throws InvalidArgumentException
</span></span><span class="l" id="36"> 36 <span class="php-comment">     *
</span></span><span class="l" id="37"> 37 <span class="php-comment">     * @return string Full path with protocol (e.g. "rex:///template/1")
</span></span><span class="l" id="38"> 38 <span class="php-comment">     */</span>
</span><span class="l" id="39"> 39     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> factory(<span class="php-var">$path</span>, <span class="php-var">$content</span>)
</span><span class="l" id="40"> 40     {
</span><span class="l" id="41"> 41         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$path</span>) || <span class="php-keyword1">empty</span>(<span class="php-var">$path</span>)) {
</span><span class="l" id="42"> 42             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Expecting $path to be a string and not empty!'</span>);
</span><span class="l" id="43"> 43         }
</span><span class="l" id="44"> 44         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$content</span>)) {
</span><span class="l" id="45"> 45             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'Expecting $content to be a string!'</span>);
</span><span class="l" id="46"> 46         }
</span><span class="l" id="47"> 47 
</span><span class="l" id="48"> 48         <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> === self::<span class="php-var">$useRealFiles</span>) {
</span><span class="l" id="49"> 49             self::<span class="php-var">$useRealFiles</span> = <span class="php-keyword2">extension_loaded</span>(<span class="php-quote">'suhosin'</span>)
</span><span class="l" id="50"> 50                 &amp;&amp; !<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/(?:^|,)rex(?::|,|$)/'</span>, <span class="php-keyword2">ini_get</span>(<span class="php-quote">'suhosin.executor.include.whitelist'</span>));
</span><span class="l" id="51"> 51         }
</span><span class="l" id="52"> 52 
</span><span class="l" id="53"> 53         <span class="php-keyword1">if</span> (self::<span class="php-var">$useRealFiles</span>) {
</span><span class="l" id="54"> 54             <span class="php-var">$hash</span> = <span class="php-keyword2">substr</span>(<span class="php-keyword2">sha1</span>(<span class="php-var">$content</span>), <span class="php-num">0</span>, <span class="php-num">7</span>);
</span><span class="l" id="55"> 55             <span class="php-var">$path</span> = rex_path::coreCache(<span class="php-quote">'stream/'</span>.<span class="php-var">$path</span>.<span class="php-quote">'/'</span>.<span class="php-var">$hash</span>);
</span><span class="l" id="56"> 56 
</span><span class="l" id="57"> 57             <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$path</span>)) {
</span><span class="l" id="58"> 58                 rex_file::put(<span class="php-var">$path</span>, <span class="php-var">$content</span>);
</span><span class="l" id="59"> 59             }
</span><span class="l" id="60"> 60 
</span><span class="l" id="61"> 61             <span class="php-keyword1">return</span> <span class="php-var">$path</span>;
</span><span class="l" id="62"> 62         }
</span><span class="l" id="63"> 63 
</span><span class="l" id="64"> 64         <span class="php-keyword1">if</span> (!self::<span class="php-var">$registered</span>) {
</span><span class="l" id="65"> 65             <span class="php-keyword2">stream_wrapper_register</span>(<span class="php-quote">'rex'</span>, __CLASS__);
</span><span class="l" id="66"> 66             self::<span class="php-var">$registered</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="67"> 67         }
</span><span class="l" id="68"> 68 
</span><span class="l" id="69"> 69         <span class="php-comment">// 3 slashes needed to sidestep some server url include protections</span>
</span><span class="l" id="70"> 70         <span class="php-comment">// example: https://www.strato.de/faq/article/622/Warum-erhalte-ich-über-PHP-die-Fehlermeldung-%22Warning:-main()-…:-include(….).html</span>
</span><span class="l" id="71"> 71         <span class="php-var">$path</span> = <span class="php-quote">'rex:///'</span> . <span class="php-var">$path</span>;
</span><span class="l" id="72"> 72         self::<span class="php-var">$nextContent</span>[<span class="php-var">$path</span>] = <span class="php-var">$content</span>;
</span><span class="l" id="73"> 73 
</span><span class="l" id="74"> 74         <span class="php-keyword1">return</span> <span class="php-var">$path</span>;
</span><span class="l" id="75"> 75     }
</span><span class="l" id="76"> 76 
</span><span class="l" id="77"> 77     <span class="php-comment">/**
</span></span><span class="l" id="78"> 78 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.stream-open.php
</span></span><span class="l" id="79"> 79 <span class="php-comment">     */</span>
</span><span class="l" id="80"> 80     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_open(<span class="php-var">$path</span>, <span class="php-var">$mode</span>, <span class="php-var">$options</span>, &amp;<span class="php-var">$opened_path</span>)
</span><span class="l" id="81"> 81     {
</span><span class="l" id="82"> 82         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$nextContent</span>[<span class="php-var">$path</span>]) || !<span class="php-keyword2">is_string</span>(self::<span class="php-var">$nextContent</span>[<span class="php-var">$path</span>])) {
</span><span class="l" id="83"> 83             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="84"> 84         }
</span><span class="l" id="85"> 85 
</span><span class="l" id="86"> 86         <span class="php-var">$this</span>-&gt;position = <span class="php-num">0</span>;
</span><span class="l" id="87"> 87         <span class="php-var">$this</span>-&gt;content = self::<span class="php-var">$nextContent</span>[<span class="php-var">$path</span>];
</span><span class="l" id="88"> 88         <span class="php-comment">//unset(self::$nextContent[$path]);</span>
</span><span class="l" id="89"> 89 
</span><span class="l" id="90"> 90         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="91"> 91     }
</span><span class="l" id="92"> 92 
</span><span class="l" id="93"> 93     <span class="php-comment">/**
</span></span><span class="l" id="94"> 94 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.stream-read.php
</span></span><span class="l" id="95"> 95 <span class="php-comment">     */</span>
</span><span class="l" id="96"> 96     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_read(<span class="php-var">$count</span>)
</span><span class="l" id="97"> 97     {
</span><span class="l" id="98"> 98         <span class="php-var">$ret</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$this</span>-&gt;content, <span class="php-var">$this</span>-&gt;position, <span class="php-var">$count</span>);
</span><span class="l" id="99"> 99         <span class="php-var">$this</span>-&gt;position += <span class="php-keyword2">strlen</span>(<span class="php-var">$ret</span>);
</span><span class="l" id="100">100         <span class="php-keyword1">return</span> <span class="php-var">$ret</span>;
</span><span class="l" id="101">101     }
</span><span class="l" id="102">102 
</span><span class="l" id="103">103     <span class="php-comment">/**
</span></span><span class="l" id="104">104 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.stream-eof.php
</span></span><span class="l" id="105">105 <span class="php-comment">     */</span>
</span><span class="l" id="106">106     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_eof()
</span><span class="l" id="107">107     {
</span><span class="l" id="108">108         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;position &gt;= <span class="php-keyword2">strlen</span>(<span class="php-var">$this</span>-&gt;content);
</span><span class="l" id="109">109     }
</span><span class="l" id="110">110 
</span><span class="l" id="111">111     <span class="php-comment">/**
</span></span><span class="l" id="112">112 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.stream-seek.php
</span></span><span class="l" id="113">113 <span class="php-comment">     */</span>
</span><span class="l" id="114">114     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_seek(<span class="php-var">$offset</span>, <span class="php-var">$whence</span> = SEEK_SET)
</span><span class="l" id="115">115     {
</span><span class="l" id="116">116         <span class="php-keyword1">switch</span> (<span class="php-var">$whence</span>) {
</span><span class="l" id="117">117             <span class="php-keyword1">case</span> SEEK_SET:
</span><span class="l" id="118">118                 <span class="php-var">$this</span>-&gt;position = <span class="php-var">$offset</span>;
</span><span class="l" id="119">119                 <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="120">120             <span class="php-keyword1">case</span> SEEK_CUR:
</span><span class="l" id="121">121                 <span class="php-var">$this</span>-&gt;position += <span class="php-var">$offset</span>;
</span><span class="l" id="122">122                 <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="123">123             <span class="php-keyword1">case</span> SEEK_END:
</span><span class="l" id="124">124                 <span class="php-var">$this</span>-&gt;position = <span class="php-keyword2">strlen</span>(<span class="php-var">$this</span>-&gt;content) - <span class="php-num">1</span> + <span class="php-var">$offset</span>;
</span><span class="l" id="125">125                 <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="126">126             <span class="php-keyword1">default</span>:
</span><span class="l" id="127">127                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="128">128         }
</span><span class="l" id="129">129     }
</span><span class="l" id="130">130 
</span><span class="l" id="131">131     <span class="php-comment">/**
</span></span><span class="l" id="132">132 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.stream-tell.php
</span></span><span class="l" id="133">133 <span class="php-comment">     */</span>
</span><span class="l" id="134">134     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_tell()
</span><span class="l" id="135">135     {
</span><span class="l" id="136">136         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;position;
</span><span class="l" id="137">137     }
</span><span class="l" id="138">138 
</span><span class="l" id="139">139     <span class="php-comment">/**
</span></span><span class="l" id="140">140 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.stream-flush.php
</span></span><span class="l" id="141">141 <span class="php-comment">     */</span>
</span><span class="l" id="142">142     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_flush()
</span><span class="l" id="143">143     {
</span><span class="l" id="144">144         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="145">145     }
</span><span class="l" id="146">146 
</span><span class="l" id="147">147     <span class="php-comment">/**
</span></span><span class="l" id="148">148 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.stream-stat.php
</span></span><span class="l" id="149">149 <span class="php-comment">     */</span>
</span><span class="l" id="150">150     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_stat()
</span><span class="l" id="151">151     {
</span><span class="l" id="152">152         <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="153">153     }
</span><span class="l" id="154">154 
</span><span class="l" id="155">155     <span class="php-comment">/**
</span></span><span class="l" id="156">156 <span class="php-comment">     * @see http://www.php.net/manual/en/streamwrapper.url-stat.php
</span></span><span class="l" id="157">157 <span class="php-comment">     */</span>
</span><span class="l" id="158">158     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> url_stat()
</span><span class="l" id="159">159     {
</span><span class="l" id="160">160         <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="161">161     }
</span><span class="l" id="162">162 }
</span><span class="l" id="163">163 </span></code></pre>
 </body>
</html>
