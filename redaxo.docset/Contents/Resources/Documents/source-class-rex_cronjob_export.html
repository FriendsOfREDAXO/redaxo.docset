<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * @package redaxo\backup
</span></span><span class="l" id="5">  5 <span class="php-comment"> */</span>
</span><span class="l" id="6">  6 <span class="php-keyword1">class</span> rex_cronjob_export <span class="php-keyword1">extends</span> rex_cronjob
</span><span class="l" id="7">  7 {
</span><span class="l" id="8">  8     <span class="php-keyword1">const</span> DEFAULT_FILENAME = <span class="php-quote">'%REX_SERVER_rex%REX_VERSION_%Y%m%d_%H%M'</span>;
</span><span class="l" id="9">  9 
</span><span class="l" id="10"> 10     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> execute()
</span><span class="l" id="11"> 11     {
</span><span class="l" id="12"> 12         <span class="php-var">$filename</span> = <span class="php-var">$this</span>-&gt;getParam(<span class="php-quote">'filename'</span>, self::DEFAULT_FILENAME);
</span><span class="l" id="13"> 13         <span class="php-var">$filename</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'%REX_SERVER'</span>, <span class="php-keyword2">parse_url</span>(rex::getServer(), PHP_URL_HOST), <span class="php-var">$filename</span>);
</span><span class="l" id="14"> 14         <span class="php-var">$filename</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'%REX_VERSION'</span>, rex::getVersion(), <span class="php-var">$filename</span>);
</span><span class="l" id="15"> 15         <span class="php-var">$filename</span> = <span class="php-keyword2">strftime</span>(<span class="php-var">$filename</span>);
</span><span class="l" id="16"> 16         <span class="php-var">$file</span> = <span class="php-var">$filename</span>;
</span><span class="l" id="17"> 17         <span class="php-var">$dir</span> = rex_backup::getDir() . <span class="php-quote">'/'</span>;
</span><span class="l" id="18"> 18         <span class="php-var">$ext</span> = <span class="php-quote">'.cronjob.sql'</span>;
</span><span class="l" id="19"> 19         <span class="php-keyword1">if</span> (<span class="php-keyword2">file_exists</span>(<span class="php-var">$dir</span> . <span class="php-var">$file</span> . <span class="php-var">$ext</span>)) {
</span><span class="l" id="20"> 20             <span class="php-var">$i</span> = <span class="php-num">1</span>;
</span><span class="l" id="21"> 21             <span class="php-keyword1">while</span> (<span class="php-keyword2">file_exists</span>(<span class="php-var">$dir</span> . <span class="php-var">$file</span> . <span class="php-quote">'_'</span> . <span class="php-var">$i</span> . <span class="php-var">$ext</span>)) {
</span><span class="l" id="22"> 22                 ++<span class="php-var">$i</span>;
</span><span class="l" id="23"> 23             }
</span><span class="l" id="24"> 24             <span class="php-var">$file</span> = <span class="php-var">$file</span> . <span class="php-quote">'_'</span> . <span class="php-var">$i</span>;
</span><span class="l" id="25"> 25         }
</span><span class="l" id="26"> 26 
</span><span class="l" id="27"> 27         <span class="php-keyword1">if</span> (rex_backup::exportDb(<span class="php-var">$dir</span> . <span class="php-var">$file</span> . <span class="php-var">$ext</span>)) {
</span><span class="l" id="28"> 28             <span class="php-var">$message</span> = <span class="php-var">$file</span> . <span class="php-var">$ext</span> . <span class="php-quote">' created'</span>;
</span><span class="l" id="29"> 29 
</span><span class="l" id="30"> 30             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;delete_interval) {
</span><span class="l" id="31"> 31                 <span class="php-var">$files</span> = <span class="php-keyword2">glob</span>(rex_path::addonData(<span class="php-quote">'backup'</span>, <span class="php-quote">'*'</span>.<span class="php-var">$ext</span>));
</span><span class="l" id="32"> 32                 <span class="php-var">$backups</span> = [];
</span><span class="l" id="33"> 33                 <span class="php-var">$limit</span> = <span class="php-keyword2">strtotime</span>(<span class="php-quote">'-1 month'</span>); <span class="php-comment">// Generelle Vorhaltezeit: 1 Monat</span>
</span><span class="l" id="34"> 34 
</span><span class="l" id="35"> 35                 <span class="php-keyword1">foreach</span> (<span class="php-var">$files</span> <span class="php-keyword1">as</span> <span class="php-var">$file</span>) {
</span><span class="l" id="36"> 36                     <span class="php-var">$timestamp</span> = <span class="php-keyword2">filectime</span>(<span class="php-var">$file</span>);
</span><span class="l" id="37"> 37 
</span><span class="l" id="38"> 38                     <span class="php-keyword1">if</span> (<span class="php-var">$timestamp</span> &gt; <span class="php-var">$limit</span>) {
</span><span class="l" id="39"> 39                         <span class="php-comment">// wenn es die generelle Vorhaltezeit unterschreitet</span>
</span><span class="l" id="40"> 40                         <span class="php-keyword1">continue</span>;
</span><span class="l" id="41"> 41                     }
</span><span class="l" id="42"> 42 
</span><span class="l" id="43"> 43                     <span class="php-var">$backups</span>[<span class="php-var">$file</span>] = <span class="php-var">$timestamp</span>;
</span><span class="l" id="44"> 44                 }
</span><span class="l" id="45"> 45 
</span><span class="l" id="46"> 46                 <span class="php-keyword2">asort</span>(<span class="php-var">$backups</span>, SORT_NUMERIC);
</span><span class="l" id="47"> 47 
</span><span class="l" id="48"> 48                 <span class="php-var">$step</span> = <span class="php-quote">''</span>;
</span><span class="l" id="49"> 49                 <span class="php-var">$countDeleted</span> = <span class="php-num">0</span>;
</span><span class="l" id="50"> 50 
</span><span class="l" id="51"> 51                 <span class="php-keyword1">foreach</span> (<span class="php-var">$backups</span> <span class="php-keyword1">as</span> <span class="php-var">$backup</span> =&gt; <span class="php-var">$timestamp</span>) {
</span><span class="l" id="52"> 52                     <span class="php-var">$stepLast</span> = <span class="php-var">$step</span>;
</span><span class="l" id="53"> 53                     <span class="php-var">$step</span> = <span class="php-keyword2">date</span>(<span class="php-var">$this</span>-&gt;delete_interval, (int) <span class="php-var">$timestamp</span>);
</span><span class="l" id="54"> 54 
</span><span class="l" id="55"> 55                     <span class="php-keyword1">if</span> (<span class="php-var">$stepLast</span> !== <span class="php-var">$step</span>) {
</span><span class="l" id="56"> 56                         <span class="php-comment">// wenn es zu diesem Interval schon ein Backup gibt</span>
</span><span class="l" id="57"> 57                         <span class="php-keyword1">continue</span>;
</span><span class="l" id="58"> 58                     }
</span><span class="l" id="59"> 59 
</span><span class="l" id="60"> 60                     <span class="php-comment">// dann l√∂schen</span>
</span><span class="l" id="61"> 61                     rex_file::<span class="php-keyword2">delete</span>(<span class="php-var">$backup</span>);
</span><span class="l" id="62"> 62                     ++<span class="php-var">$countDeleted</span>;
</span><span class="l" id="63"> 63                 }
</span><span class="l" id="64"> 64 
</span><span class="l" id="65"> 65                 <span class="php-keyword1">if</span> (<span class="php-var">$countDeleted</span>) {
</span><span class="l" id="66"> 66                     <span class="php-var">$message</span> .= <span class="php-quote">', '</span>.<span class="php-var">$countDeleted</span>.<span class="php-quote">' old backups deleted'</span>;
</span><span class="l" id="67"> 67                 }
</span><span class="l" id="68"> 68             }
</span><span class="l" id="69"> 69 
</span><span class="l" id="70"> 70             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;sendmail) {
</span><span class="l" id="71"> 71                 <span class="php-keyword1">if</span> (!rex_addon::get(<span class="php-quote">'phpmailer'</span>)-&gt;isAvailable()) {
</span><span class="l" id="72"> 72                     <span class="php-var">$this</span>-&gt;setMessage(<span class="php-var">$message</span> . <span class="php-quote">', mail not sent (addon "phpmailer" isn\'t activated)'</span>);
</span><span class="l" id="73"> 73 
</span><span class="l" id="74"> 74                     <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="75"> 75                 }
</span><span class="l" id="76"> 76                 <span class="php-var">$mail</span> = <span class="php-keyword1">new</span> rex_mailer();
</span><span class="l" id="77"> 77                 <span class="php-var">$mail</span>-&gt;AddAddress(<span class="php-var">$this</span>-&gt;mailaddress);
</span><span class="l" id="78"> 78                 <span class="php-var">$mail</span>-&gt;Subject = rex_i18n::rawMsg(<span class="php-quote">'backup_mail_subject'</span>);
</span><span class="l" id="79"> 79                 <span class="php-var">$mail</span>-&gt;Body = rex_i18n::rawMsg(<span class="php-quote">'backup_mail_body'</span>, rex::getServerName());
</span><span class="l" id="80"> 80                 <span class="php-var">$mail</span>-&gt;AddAttachment(<span class="php-var">$dir</span> . <span class="php-var">$file</span> . <span class="php-var">$ext</span>, <span class="php-var">$filename</span> . <span class="php-var">$ext</span>);
</span><span class="l" id="81"> 81                 <span class="php-keyword1">if</span> (<span class="php-var">$mail</span>-&gt;Send()) {
</span><span class="l" id="82"> 82                     <span class="php-var">$this</span>-&gt;setMessage(<span class="php-var">$message</span> . <span class="php-quote">', mail sent'</span>);
</span><span class="l" id="83"> 83 
</span><span class="l" id="84"> 84                     <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="85"> 85                 }
</span><span class="l" id="86"> 86                 <span class="php-var">$this</span>-&gt;setMessage(<span class="php-var">$message</span> . <span class="php-quote">', mail not sent'</span>);
</span><span class="l" id="87"> 87 
</span><span class="l" id="88"> 88                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="89"> 89             }
</span><span class="l" id="90"> 90 
</span><span class="l" id="91"> 91             <span class="php-var">$this</span>-&gt;setMessage(<span class="php-var">$message</span>);
</span><span class="l" id="92"> 92 
</span><span class="l" id="93"> 93             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="94"> 94         }
</span><span class="l" id="95"> 95         <span class="php-var">$this</span>-&gt;setMessage(<span class="php-var">$file</span> . <span class="php-var">$ext</span> . <span class="php-quote">' not created'</span>);
</span><span class="l" id="96"> 96 
</span><span class="l" id="97"> 97         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="98"> 98     }
</span><span class="l" id="99"> 99 
</span><span class="l" id="100">100     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getTypeName()
</span><span class="l" id="101">101     {
</span><span class="l" id="102">102         <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'backup_database_export'</span>);
</span><span class="l" id="103">103     }
</span><span class="l" id="104">104 
</span><span class="l" id="105">105     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getParamFields()
</span><span class="l" id="106">106     {
</span><span class="l" id="107">107         <span class="php-var">$fields</span> = [
</span><span class="l" id="108">108             [
</span><span class="l" id="109">109                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_filename'</span>),
</span><span class="l" id="110">110                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'filename'</span>,
</span><span class="l" id="111">111                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'text'</span>,
</span><span class="l" id="112">112                 <span class="php-quote">'default'</span> =&gt; self::DEFAULT_FILENAME,
</span><span class="l" id="113">113                 <span class="php-quote">'notice'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_filename_notice'</span>),
</span><span class="l" id="114">114             ],
</span><span class="l" id="115">115             [
</span><span class="l" id="116">116                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'sendmail'</span>,
</span><span class="l" id="117">117                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'checkbox'</span>,
</span><span class="l" id="118">118                 <span class="php-quote">'options'</span> =&gt; [<span class="php-num">1</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_send_mail'</span>)],
</span><span class="l" id="119">119             ],
</span><span class="l" id="120">120         ];
</span><span class="l" id="121">121         <span class="php-keyword1">if</span> (rex_addon::get(<span class="php-quote">'phpmailer'</span>)-&gt;isAvailable()) {
</span><span class="l" id="122">122             <span class="php-var">$fields</span>[] = [
</span><span class="l" id="123">123                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_mailaddress'</span>),
</span><span class="l" id="124">124                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'mailaddress'</span>,
</span><span class="l" id="125">125                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'text'</span>,
</span><span class="l" id="126">126                 <span class="php-quote">'visible_if'</span> =&gt; [<span class="php-quote">'sendmail'</span> =&gt; <span class="php-num">1</span>],
</span><span class="l" id="127">127             ];
</span><span class="l" id="128">128         } <span class="php-keyword1">else</span> {
</span><span class="l" id="129">129             <span class="php-var">$fields</span>[<span class="php-num">1</span>][<span class="php-quote">'notice'</span>] = rex_i18n::msg(<span class="php-quote">'backup_send_mail_notice'</span>);
</span><span class="l" id="130">130             <span class="php-var">$fields</span>[<span class="php-num">1</span>][<span class="php-quote">'attributes'</span>] = [<span class="php-quote">'disabled'</span> =&gt; <span class="php-quote">'disabled'</span>];
</span><span class="l" id="131">131         }
</span><span class="l" id="132">132 
</span><span class="l" id="133">133         <span class="php-var">$fields</span>[] = [
</span><span class="l" id="134">134             <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_delete_interval'</span>),
</span><span class="l" id="135">135             <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'delete_interval'</span>,
</span><span class="l" id="136">136             <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'select'</span>,
</span><span class="l" id="137">137             <span class="php-quote">'options'</span> =&gt; [
</span><span class="l" id="138">138                 <span class="php-quote">'0'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_delete_interval_off'</span>),
</span><span class="l" id="139">139                 <span class="php-quote">'YW'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_delete_interval_weekly'</span>),
</span><span class="l" id="140">140                 <span class="php-quote">'YM'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_delete_interval_monthly'</span>), ],
</span><span class="l" id="141">141             <span class="php-quote">'default'</span> =&gt; <span class="php-quote">'YW'</span>,
</span><span class="l" id="142">142             <span class="php-quote">'notice'</span> =&gt; rex_i18n::msg(<span class="php-quote">'backup_delete_interval_notice'</span>),
</span><span class="l" id="143">143         ];
</span><span class="l" id="144">144 
</span><span class="l" id="145">145         <span class="php-keyword1">return</span> <span class="php-var">$fields</span>;
</span><span class="l" id="146">146     }
</span><span class="l" id="147">147 }
</span><span class="l" id="148">148 </span></code></pre>
 </body>
</html>
