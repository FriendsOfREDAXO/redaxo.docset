<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Funktionensammlung für die Strukturverwaltung.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @package redaxo\structure
</span></span><span class="l" id="7">  7 <span class="php-comment"> */</span>
</span><span class="l" id="8">  8 <span class="php-keyword1">class</span> rex_category_service
</span><span class="l" id="9">  9 {
</span><span class="l" id="10"> 10     <span class="php-comment">/**
</span></span><span class="l" id="11"> 11 <span class="php-comment">     * Erstellt eine neue Kategorie.
</span></span><span class="l" id="12"> 12 <span class="php-comment">     *
</span></span><span class="l" id="13"> 13 <span class="php-comment">     * @param int   $category_id KategorieId in der die neue Kategorie erstellt werden soll
</span></span><span class="l" id="14"> 14 <span class="php-comment">     * @param array $data        Array mit den Daten der Kategorie
</span></span><span class="l" id="15"> 15 <span class="php-comment">     *
</span></span><span class="l" id="16"> 16 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="17"> 17 <span class="php-comment">     *
</span></span><span class="l" id="18"> 18 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="19"> 19 <span class="php-comment">     */</span>
</span><span class="l" id="20"> 20     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> addCategory(<span class="php-var">$category_id</span>, <span class="php-keyword1">array</span> <span class="php-var">$data</span>)
</span><span class="l" id="21"> 21     {
</span><span class="l" id="22"> 22         <span class="php-var">$message</span> = <span class="php-quote">''</span>;
</span><span class="l" id="23"> 23 
</span><span class="l" id="24"> 24         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$data</span>)) {
</span><span class="l" id="25"> 25             <span class="php-keyword1">throw</span>  <span class="php-keyword1">new</span> rex_api_exception(<span class="php-quote">'Expecting $data to be an array!'</span>);
</span><span class="l" id="26"> 26         }
</span><span class="l" id="27"> 27 
</span><span class="l" id="28"> 28         self::reqKey(<span class="php-var">$data</span>, <span class="php-quote">'catpriority'</span>);
</span><span class="l" id="29"> 29         self::reqKey(<span class="php-var">$data</span>, <span class="php-quote">'catname'</span>);
</span><span class="l" id="30"> 30 
</span><span class="l" id="31"> 31         <span class="php-comment">// parent may be null, when adding in the root cat</span>
</span><span class="l" id="32"> 32         <span class="php-var">$parent</span> = rex_category::get(<span class="php-var">$category_id</span>);
</span><span class="l" id="33"> 33         <span class="php-keyword1">if</span> (<span class="php-var">$parent</span>) {
</span><span class="l" id="34"> 34             <span class="php-var">$path</span> = <span class="php-var">$parent</span>-&gt;getPath();
</span><span class="l" id="35"> 35             <span class="php-var">$path</span> .= <span class="php-var">$parent</span>-&gt;getId() . <span class="php-quote">'|'</span>;
</span><span class="l" id="36"> 36         } <span class="php-keyword1">else</span> {
</span><span class="l" id="37"> 37             <span class="php-var">$path</span> = <span class="php-quote">'|'</span>;
</span><span class="l" id="38"> 38         }
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40         <span class="php-keyword1">if</span> (<span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>] &lt;= <span class="php-num">0</span>) {
</span><span class="l" id="41"> 41             <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>] = <span class="php-num">1</span>;
</span><span class="l" id="42"> 42         }
</span><span class="l" id="43"> 43 
</span><span class="l" id="44"> 44         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'name'</span>])) {
</span><span class="l" id="45"> 45             <span class="php-var">$data</span>[<span class="php-quote">'name'</span>] = <span class="php-var">$data</span>[<span class="php-quote">'catname'</span>];
</span><span class="l" id="46"> 46         }
</span><span class="l" id="47"> 47 
</span><span class="l" id="48"> 48         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'status'</span>])) {
</span><span class="l" id="49"> 49             <span class="php-var">$data</span>[<span class="php-quote">'status'</span>] = <span class="php-num">0</span>;
</span><span class="l" id="50"> 50         }
</span><span class="l" id="51"> 51 
</span><span class="l" id="52"> 52         <span class="php-var">$contentAvailable</span> = rex_plugin::get(<span class="php-quote">'structure'</span>, <span class="php-quote">'content'</span>)-&gt;isAvailable();
</span><span class="l" id="53"> 53         <span class="php-keyword1">if</span> (<span class="php-var">$contentAvailable</span>) {
</span><span class="l" id="54"> 54             <span class="php-var">$startpageTemplates</span> = [];
</span><span class="l" id="55"> 55             <span class="php-keyword1">if</span> (<span class="php-var">$category_id</span> != <span class="php-quote">''</span>) {
</span><span class="l" id="56"> 56                 <span class="php-comment">// TemplateId vom Startartikel der jeweiligen Sprache vererben</span>
</span><span class="l" id="57"> 57                 <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="58"> 58                 <span class="php-comment">// $sql-&gt;setDebug();</span>
</span><span class="l" id="59"> 59                 <span class="php-var">$sql</span>-&gt;setQuery(<span class="php-quote">'select clang_id,template_id from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and startarticle=1'</span>, [<span class="php-var">$category_id</span>]);
</span><span class="l" id="60"> 60                 <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$sql</span>-&gt;getRows(); <span class="php-var">$i</span>++, <span class="php-var">$sql</span>-&gt;<span class="php-keyword2">next</span>()) {
</span><span class="l" id="61"> 61                     <span class="php-var">$startpageTemplates</span>[<span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'clang_id'</span>)] = <span class="php-var">$sql</span>-&gt;getValue(<span class="php-quote">'template_id'</span>);
</span><span class="l" id="62"> 62                 }
</span><span class="l" id="63"> 63             }
</span><span class="l" id="64"> 64 
</span><span class="l" id="65"> 65             <span class="php-comment">// Alle Templates der Kategorie</span>
</span><span class="l" id="66"> 66             <span class="php-var">$templates</span> = rex_template::getTemplatesForCategory(<span class="php-var">$category_id</span>);
</span><span class="l" id="67"> 67         }
</span><span class="l" id="68"> 68 
</span><span class="l" id="69"> 69         <span class="php-var">$user</span> = self::getUser();
</span><span class="l" id="70"> 70 
</span><span class="l" id="71"> 71         <span class="php-comment">// Kategorie in allen Sprachen anlegen</span>
</span><span class="l" id="72"> 72         <span class="php-var">$AART</span> = rex_sql::factory();
</span><span class="l" id="73"> 73         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$key</span>) {
</span><span class="l" id="74"> 74             <span class="php-keyword1">if</span> (<span class="php-var">$contentAvailable</span>) {
</span><span class="l" id="75"> 75                 <span class="php-var">$template_id</span> = rex_template::getDefaultId();
</span><span class="l" id="76"> 76                 <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$startpageTemplates</span>[<span class="php-var">$key</span>]) &amp;&amp; <span class="php-var">$startpageTemplates</span>[<span class="php-var">$key</span>] != <span class="php-quote">''</span>) {
</span><span class="l" id="77"> 77                     <span class="php-var">$template_id</span> = <span class="php-var">$startpageTemplates</span>[<span class="php-var">$key</span>];
</span><span class="l" id="78"> 78                 }
</span><span class="l" id="79"> 79 
</span><span class="l" id="80"> 80                 <span class="php-comment">// Wenn Template nicht vorhanden, dann entweder erlaubtes nehmen</span>
</span><span class="l" id="81"> 81                 <span class="php-comment">// oder leer setzen.</span>
</span><span class="l" id="82"> 82                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$templates</span>[<span class="php-var">$template_id</span>])) {
</span><span class="l" id="83"> 83                     <span class="php-var">$template_id</span> = <span class="php-num">0</span>;
</span><span class="l" id="84"> 84                     <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="85"> 85                         <span class="php-var">$template_id</span> = <span class="php-keyword2">key</span>(<span class="php-var">$templates</span>);
</span><span class="l" id="86"> 86                     }
</span><span class="l" id="87"> 87                 }
</span><span class="l" id="88"> 88             }
</span><span class="l" id="89"> 89 
</span><span class="l" id="90"> 90             <span class="php-var">$AART</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="91"> 91             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$id</span>)) {
</span><span class="l" id="92"> 92                 <span class="php-var">$id</span> = <span class="php-var">$AART</span>-&gt;setNewId(<span class="php-quote">'id'</span>);
</span><span class="l" id="93"> 93             } <span class="php-keyword1">else</span> {
</span><span class="l" id="94"> 94                 <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'id'</span>, <span class="php-var">$id</span>);
</span><span class="l" id="95"> 95             }
</span><span class="l" id="96"> 96 
</span><span class="l" id="97"> 97             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'clang_id'</span>, <span class="php-var">$key</span>);
</span><span class="l" id="98"> 98             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'template_id'</span>, <span class="php-var">$template_id</span>);
</span><span class="l" id="99"> 99             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'name'</span>, <span class="php-var">$data</span>[<span class="php-quote">'name'</span>]);
</span><span class="l" id="100">100             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'catname'</span>, <span class="php-var">$data</span>[<span class="php-quote">'catname'</span>]);
</span><span class="l" id="101">101             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'catpriority'</span>, <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>]);
</span><span class="l" id="102">102             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$category_id</span>);
</span><span class="l" id="103">103             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'priority'</span>, <span class="php-num">1</span>);
</span><span class="l" id="104">104             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'path'</span>, <span class="php-var">$path</span>);
</span><span class="l" id="105">105             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'startarticle'</span>, <span class="php-num">1</span>);
</span><span class="l" id="106">106             <span class="php-var">$AART</span>-&gt;setValue(<span class="php-quote">'status'</span>, <span class="php-var">$data</span>[<span class="php-quote">'status'</span>]);
</span><span class="l" id="107">107             <span class="php-var">$AART</span>-&gt;addGlobalUpdateFields(<span class="php-var">$user</span>);
</span><span class="l" id="108">108             <span class="php-var">$AART</span>-&gt;addGlobalCreateFields(<span class="php-var">$user</span>);
</span><span class="l" id="109">109 
</span><span class="l" id="110">110             <span class="php-keyword1">try</span> {
</span><span class="l" id="111">111                 <span class="php-var">$AART</span>-&gt;insert();
</span><span class="l" id="112">112 
</span><span class="l" id="113">113                 <span class="php-comment">// ----- PRIOR</span>
</span><span class="l" id="114">114                 <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>])) {
</span><span class="l" id="115">115                     self::newCatPrio(<span class="php-var">$category_id</span>, <span class="php-var">$key</span>, <span class="php-num">0</span>, <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>]);
</span><span class="l" id="116">116                 }
</span><span class="l" id="117">117 
</span><span class="l" id="118">118                 <span class="php-var">$message</span> = rex_i18n::msg(<span class="php-quote">'category_added_and_startarticle_created'</span>);
</span><span class="l" id="119">119 
</span><span class="l" id="120">120                 rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$id</span>, <span class="php-var">$key</span>);
</span><span class="l" id="121">121 
</span><span class="l" id="122">122                 <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="123">123                 <span class="php-comment">// Objekte clonen, damit diese nicht von der extension veraendert werden koennen</span>
</span><span class="l" id="124">124                 <span class="php-var">$message</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'CAT_ADDED'</span>, <span class="php-var">$message</span>, [
</span><span class="l" id="125">125                     <span class="php-quote">'category'</span> =&gt; <span class="php-keyword1">clone</span> <span class="php-var">$AART</span>,
</span><span class="l" id="126">126                     <span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>,
</span><span class="l" id="127">127                     <span class="php-quote">'parent_id'</span> =&gt; <span class="php-var">$category_id</span>,
</span><span class="l" id="128">128                     <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$key</span>,
</span><span class="l" id="129">129                     <span class="php-quote">'name'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'catname'</span>],
</span><span class="l" id="130">130                     <span class="php-quote">'priority'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>],
</span><span class="l" id="131">131                     <span class="php-quote">'path'</span> =&gt; <span class="php-var">$path</span>,
</span><span class="l" id="132">132                     <span class="php-quote">'status'</span> =&gt; <span class="php-var">$data</span>[<span class="php-quote">'status'</span>],
</span><span class="l" id="133">133                     <span class="php-quote">'article'</span> =&gt; <span class="php-keyword1">clone</span> <span class="php-var">$AART</span>,
</span><span class="l" id="134">134                     <span class="php-quote">'data'</span> =&gt; <span class="php-var">$data</span>,
</span><span class="l" id="135">135                 ]));
</span><span class="l" id="136">136             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="137">137                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-var">$e</span>);
</span><span class="l" id="138">138             }
</span><span class="l" id="139">139         }
</span><span class="l" id="140">140 
</span><span class="l" id="141">141         <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
</span><span class="l" id="142">142     }
</span><span class="l" id="143">143 
</span><span class="l" id="144">144     <span class="php-comment">/**
</span></span><span class="l" id="145">145 <span class="php-comment">     * Bearbeitet einer Kategorie.
</span></span><span class="l" id="146">146 <span class="php-comment">     *
</span></span><span class="l" id="147">147 <span class="php-comment">     * @param int   $category_id Id der Kategorie die verändert werden soll
</span></span><span class="l" id="148">148 <span class="php-comment">     * @param int   $clang       Id der Sprache
</span></span><span class="l" id="149">149 <span class="php-comment">     * @param array $data        Array mit den Daten der Kategorie
</span></span><span class="l" id="150">150 <span class="php-comment">     *
</span></span><span class="l" id="151">151 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="152">152 <span class="php-comment">     *
</span></span><span class="l" id="153">153 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="154">154 <span class="php-comment">     */</span>
</span><span class="l" id="155">155     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> editCategory(<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>, <span class="php-keyword1">array</span> <span class="php-var">$data</span>)
</span><span class="l" id="156">156     {
</span><span class="l" id="157">157         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$data</span>)) {
</span><span class="l" id="158">158             <span class="php-keyword1">throw</span>  <span class="php-keyword1">new</span> rex_api_exception(<span class="php-quote">'Expecting $data to be an array!'</span>);
</span><span class="l" id="159">159         }
</span><span class="l" id="160">160 
</span><span class="l" id="161">161         <span class="php-comment">// --- Kategorie mit alten Daten selektieren</span>
</span><span class="l" id="162">162         <span class="php-var">$thisCat</span> = rex_sql::factory();
</span><span class="l" id="163">163         <span class="php-var">$thisCat</span>-&gt;setQuery(<span class="php-quote">'SELECT * FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article WHERE startarticle=1 and id=? and clang_id=?'</span>, [<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="164">164 
</span><span class="l" id="165">165         <span class="php-comment">// --- Kategorie selbst updaten</span>
</span><span class="l" id="166">166         <span class="php-var">$EKAT</span> = rex_sql::factory();
</span><span class="l" id="167">167         <span class="php-var">$EKAT</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="168">168         <span class="php-var">$EKAT</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$category_id</span>, <span class="php-quote">'startarticle'</span> =&gt; <span class="php-num">1</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="169">169 
</span><span class="l" id="170">170         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'catname'</span>])) {
</span><span class="l" id="171">171             <span class="php-var">$EKAT</span>-&gt;setValue(<span class="php-quote">'catname'</span>, <span class="php-var">$data</span>[<span class="php-quote">'catname'</span>]);
</span><span class="l" id="172">172         }
</span><span class="l" id="173">173         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>])) {
</span><span class="l" id="174">174             <span class="php-var">$EKAT</span>-&gt;setValue(<span class="php-quote">'catpriority'</span>, <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>]);
</span><span class="l" id="175">175         }
</span><span class="l" id="176">176 
</span><span class="l" id="177">177         <span class="php-var">$user</span> = self::getUser();
</span><span class="l" id="178">178 
</span><span class="l" id="179">179         <span class="php-var">$EKAT</span>-&gt;addGlobalUpdateFields(<span class="php-var">$user</span>);
</span><span class="l" id="180">180 
</span><span class="l" id="181">181         <span class="php-keyword1">try</span> {
</span><span class="l" id="182">182             <span class="php-var">$EKAT</span>-&gt;update();
</span><span class="l" id="183">183 
</span><span class="l" id="184">184             <span class="php-comment">// --- Kategorie Kindelemente updaten</span>
</span><span class="l" id="185">185             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'catname'</span>])) {
</span><span class="l" id="186">186                 <span class="php-var">$ArtSql</span> = rex_sql::factory();
</span><span class="l" id="187">187                 <span class="php-var">$ArtSql</span>-&gt;setQuery(<span class="php-quote">'SELECT id FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article WHERE parent_id=? AND startarticle=0 AND clang_id=?'</span>, [<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="188">188 
</span><span class="l" id="189">189                 <span class="php-var">$EART</span> = rex_sql::factory();
</span><span class="l" id="190">190                 <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$ArtSql</span>-&gt;getRows(); ++<span class="php-var">$i</span>) {
</span><span class="l" id="191">191                     <span class="php-var">$EART</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="192">192                     <span class="php-var">$EART</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$ArtSql</span>-&gt;getValue(<span class="php-quote">'id'</span>), <span class="php-quote">'startarticle'</span> =&gt; <span class="php-quote">'0'</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="193">193                     <span class="php-var">$EART</span>-&gt;setValue(<span class="php-quote">'catname'</span>, <span class="php-var">$data</span>[<span class="php-quote">'catname'</span>]);
</span><span class="l" id="194">194                     <span class="php-var">$EART</span>-&gt;addGlobalUpdateFields(<span class="php-var">$user</span>);
</span><span class="l" id="195">195 
</span><span class="l" id="196">196                     <span class="php-var">$EART</span>-&gt;update();
</span><span class="l" id="197">197                     rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$ArtSql</span>-&gt;getValue(<span class="php-quote">'id'</span>), <span class="php-var">$clang</span>);
</span><span class="l" id="198">198 
</span><span class="l" id="199">199                     <span class="php-var">$ArtSql</span>-&gt;<span class="php-keyword2">next</span>();
</span><span class="l" id="200">200                 }
</span><span class="l" id="201">201             }
</span><span class="l" id="202">202 
</span><span class="l" id="203">203             <span class="php-comment">// ----- PRIOR</span>
</span><span class="l" id="204">204             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>])) {
</span><span class="l" id="205">205                 <span class="php-var">$parent_id</span> = <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="206">206                 <span class="php-var">$old_prio</span> = <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'catpriority'</span>);
</span><span class="l" id="207">207 
</span><span class="l" id="208">208                 <span class="php-keyword1">if</span> (<span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>] &lt;= <span class="php-num">0</span>) {
</span><span class="l" id="209">209                     <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>] = <span class="php-num">1</span>;
</span><span class="l" id="210">210                 }
</span><span class="l" id="211">211 
</span><span class="l" id="212">212                 rex_sql::factory()
</span><span class="l" id="213">213                     -&gt;setTable(rex::getTable(<span class="php-quote">'article'</span>))
</span><span class="l" id="214">214                     -&gt;setWhere(<span class="php-quote">'id = :id AND clang_id != :clang'</span>, [<span class="php-quote">'id'</span> =&gt; <span class="php-var">$category_id</span>, <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>])
</span><span class="l" id="215">215                     -&gt;setValue(<span class="php-quote">'catpriority'</span>, <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>])
</span><span class="l" id="216">216                     -&gt;addGlobalUpdateFields(<span class="php-var">$user</span>)
</span><span class="l" id="217">217                     -&gt;update();
</span><span class="l" id="218">218 
</span><span class="l" id="219">219                 <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clangId</span>) {
</span><span class="l" id="220">220                     self::newCatPrio(<span class="php-var">$parent_id</span>, <span class="php-var">$clangId</span>, <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>], <span class="php-var">$old_prio</span>);
</span><span class="l" id="221">221                 }
</span><span class="l" id="222">222             }
</span><span class="l" id="223">223 
</span><span class="l" id="224">224             <span class="php-var">$message</span> = rex_i18n::msg(<span class="php-quote">'category_updated'</span>);
</span><span class="l" id="225">225 
</span><span class="l" id="226">226             rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$category_id</span>);
</span><span class="l" id="227">227 
</span><span class="l" id="228">228             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="229">229             <span class="php-comment">// Objekte clonen, damit diese nicht von der extension veraendert werden koennen</span>
</span><span class="l" id="230">230             <span class="php-var">$message</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'CAT_UPDATED'</span>, <span class="php-var">$message</span>, [
</span><span class="l" id="231">231                 <span class="php-quote">'id'</span> =&gt; <span class="php-var">$category_id</span>,
</span><span class="l" id="232">232 
</span><span class="l" id="233">233                 <span class="php-quote">'category'</span> =&gt; <span class="php-keyword1">clone</span> <span class="php-var">$EKAT</span>,
</span><span class="l" id="234">234                 <span class="php-quote">'category_old'</span> =&gt; <span class="php-keyword1">clone</span> <span class="php-var">$thisCat</span>,
</span><span class="l" id="235">235                 <span class="php-quote">'article'</span> =&gt; <span class="php-keyword1">clone</span> <span class="php-var">$EKAT</span>,
</span><span class="l" id="236">236 
</span><span class="l" id="237">237                 <span class="php-quote">'parent_id'</span> =&gt; <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>),
</span><span class="l" id="238">238                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="239">239                 <span class="php-quote">'name'</span> =&gt; <span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'catname'</span>]) ? <span class="php-var">$data</span>[<span class="php-quote">'catname'</span>] : <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'catname'</span>),
</span><span class="l" id="240">240                 <span class="php-quote">'priority'</span> =&gt; <span class="php-keyword1">isset</span>(<span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>]) ? <span class="php-var">$data</span>[<span class="php-quote">'catpriority'</span>] : <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'catpriority'</span>),
</span><span class="l" id="241">241                 <span class="php-quote">'path'</span> =&gt; <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'path'</span>),
</span><span class="l" id="242">242                 <span class="php-quote">'status'</span> =&gt; <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'status'</span>),
</span><span class="l" id="243">243 
</span><span class="l" id="244">244                 <span class="php-quote">'data'</span> =&gt; <span class="php-var">$data</span>,
</span><span class="l" id="245">245             ]));
</span><span class="l" id="246">246         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="247">247             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-var">$e</span>);
</span><span class="l" id="248">248         }
</span><span class="l" id="249">249 
</span><span class="l" id="250">250         <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
</span><span class="l" id="251">251     }
</span><span class="l" id="252">252 
</span><span class="l" id="253">253     <span class="php-comment">/**
</span></span><span class="l" id="254">254 <span class="php-comment">     * Löscht eine Kategorie und reorganisiert die Prioritäten verbleibender Geschwister-Kategorien.
</span></span><span class="l" id="255">255 <span class="php-comment">     *
</span></span><span class="l" id="256">256 <span class="php-comment">     * @param int $category_id Id der Kategorie die gelöscht werden soll
</span></span><span class="l" id="257">257 <span class="php-comment">     *
</span></span><span class="l" id="258">258 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="259">259 <span class="php-comment">     *
</span></span><span class="l" id="260">260 <span class="php-comment">     * @return string Eine Statusmeldung
</span></span><span class="l" id="261">261 <span class="php-comment">     */</span>
</span><span class="l" id="262">262     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> deleteCategory(<span class="php-var">$category_id</span>)
</span><span class="l" id="263">263     {
</span><span class="l" id="264">264         <span class="php-var">$clang</span> = <span class="php-num">1</span>;
</span><span class="l" id="265">265 
</span><span class="l" id="266">266         <span class="php-var">$thisCat</span> = rex_sql::factory();
</span><span class="l" id="267">267         <span class="php-var">$thisCat</span>-&gt;setQuery(<span class="php-quote">'SELECT * FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article WHERE id=? and clang_id=?'</span>, [<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="268">268 
</span><span class="l" id="269">269         <span class="php-comment">// Prüfen ob die Kategorie existiert</span>
</span><span class="l" id="270">270         <span class="php-keyword1">if</span> (<span class="php-var">$thisCat</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="271">271             <span class="php-var">$KAT</span> = rex_sql::factory();
</span><span class="l" id="272">272             <span class="php-var">$KAT</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where parent_id=? and clang_id=? and startarticle=1'</span>, [<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="273">273             <span class="php-comment">// Prüfen ob die Kategorie noch Unterkategorien besitzt</span>
</span><span class="l" id="274">274             <span class="php-keyword1">if</span> (<span class="php-var">$KAT</span>-&gt;getRows() == <span class="php-num">0</span>) {
</span><span class="l" id="275">275                 <span class="php-var">$KAT</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where parent_id=? and clang_id=? and startarticle=0'</span>, [<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="276">276                 <span class="php-comment">// Prüfen ob die Kategorie noch Artikel besitzt (ausser dem Startartikel)</span>
</span><span class="l" id="277">277                 <span class="php-keyword1">if</span> (<span class="php-var">$KAT</span>-&gt;getRows() == <span class="php-num">0</span>) {
</span><span class="l" id="278">278                     <span class="php-var">$thisCat</span> = rex_sql::factory();
</span><span class="l" id="279">279                     <span class="php-var">$thisCat</span>-&gt;setQuery(<span class="php-quote">'SELECT * FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'article WHERE id=?'</span>, [<span class="php-var">$category_id</span>]);
</span><span class="l" id="280">280 
</span><span class="l" id="281">281                     <span class="php-var">$parent_id</span> = <span class="php-var">$thisCat</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>);
</span><span class="l" id="282">282                     <span class="php-var">$message</span> = rex_article_service::_deleteArticle(<span class="php-var">$category_id</span>);
</span><span class="l" id="283">283 
</span><span class="l" id="284">284                     <span class="php-keyword1">foreach</span> (<span class="php-var">$thisCat</span> <span class="php-keyword1">as</span> <span class="php-var">$row</span>) {
</span><span class="l" id="285">285                         <span class="php-var">$_clang</span> = <span class="php-var">$row</span>-&gt;getValue(<span class="php-quote">'clang_id'</span>);
</span><span class="l" id="286">286 
</span><span class="l" id="287">287                         <span class="php-comment">// ----- PRIOR</span>
</span><span class="l" id="288">288                         self::newCatPrio(<span class="php-var">$parent_id</span>, <span class="php-var">$_clang</span>, <span class="php-num">0</span>, <span class="php-num">1</span>);
</span><span class="l" id="289">289 
</span><span class="l" id="290">290                         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="291">291                         <span class="php-var">$message</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'CAT_DELETED'</span>, <span class="php-var">$message</span>, [
</span><span class="l" id="292">292                             <span class="php-quote">'id'</span> =&gt; <span class="php-var">$category_id</span>,
</span><span class="l" id="293">293                             <span class="php-quote">'parent_id'</span> =&gt; <span class="php-var">$parent_id</span>,
</span><span class="l" id="294">294                             <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$_clang</span>,
</span><span class="l" id="295">295                             <span class="php-quote">'name'</span> =&gt; <span class="php-var">$row</span>-&gt;getValue(<span class="php-quote">'catname'</span>),
</span><span class="l" id="296">296                             <span class="php-quote">'priority'</span> =&gt; <span class="php-var">$row</span>-&gt;getValue(<span class="php-quote">'catpriority'</span>),
</span><span class="l" id="297">297                             <span class="php-quote">'path'</span> =&gt; <span class="php-var">$row</span>-&gt;getValue(<span class="php-quote">'path'</span>),
</span><span class="l" id="298">298                             <span class="php-quote">'status'</span> =&gt; <span class="php-var">$row</span>-&gt;getValue(<span class="php-quote">'status'</span>),
</span><span class="l" id="299">299                         ]));
</span><span class="l" id="300">300                     }
</span><span class="l" id="301">301 
</span><span class="l" id="302">302                     rex_complex_perm::removeItem(<span class="php-quote">'structure'</span>, <span class="php-var">$category_id</span>);
</span><span class="l" id="303">303                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="304">304                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'category_could_not_be_deleted'</span>) . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'category_still_contains_articles'</span>));
</span><span class="l" id="305">305                 }
</span><span class="l" id="306">306             } <span class="php-keyword1">else</span> {
</span><span class="l" id="307">307                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'category_could_not_be_deleted'</span>) . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'category_still_contains_subcategories'</span>));
</span><span class="l" id="308">308             }
</span><span class="l" id="309">309         } <span class="php-keyword1">else</span> {
</span><span class="l" id="310">310             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'category_could_not_be_deleted'</span>));
</span><span class="l" id="311">311         }
</span><span class="l" id="312">312 
</span><span class="l" id="313">313         <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
</span><span class="l" id="314">314     }
</span><span class="l" id="315">315 
</span><span class="l" id="316">316     <span class="php-comment">/**
</span></span><span class="l" id="317">317 <span class="php-comment">     * Ändert den Status der Kategorie.
</span></span><span class="l" id="318">318 <span class="php-comment">     *
</span></span><span class="l" id="319">319 <span class="php-comment">     * @param int      $category_id Id der Kategorie die gelöscht werden soll
</span></span><span class="l" id="320">320 <span class="php-comment">     * @param int      $clang       Id der Sprache
</span></span><span class="l" id="321">321 <span class="php-comment">     * @param int|null $status      Status auf den die Kategorie gesetzt werden soll, oder NULL wenn zum nächsten Status weitergeschaltet werden soll
</span></span><span class="l" id="322">322 <span class="php-comment">     *
</span></span><span class="l" id="323">323 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="324">324 <span class="php-comment">     *
</span></span><span class="l" id="325">325 <span class="php-comment">     * @return int Der neue Status der Kategorie
</span></span><span class="l" id="326">326 <span class="php-comment">     */</span>
</span><span class="l" id="327">327     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> categoryStatus(<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>, <span class="php-var">$status</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="328">328     {
</span><span class="l" id="329">329         <span class="php-var">$KAT</span> = rex_sql::factory();
</span><span class="l" id="330">330         <span class="php-var">$KAT</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where id=? and clang_id=? and startarticle=1'</span>, [<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="331">331         <span class="php-keyword1">if</span> (<span class="php-var">$KAT</span>-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="332">332             <span class="php-comment">// Status wurde nicht von außen vorgegeben,</span>
</span><span class="l" id="333">333             <span class="php-comment">// =&gt; zyklisch auf den nächsten Weiterschalten</span>
</span><span class="l" id="334">334             <span class="php-keyword1">if</span> (!<span class="php-var">$status</span>) {
</span><span class="l" id="335">335                 <span class="php-var">$newstatus</span> = self::nextStatus(<span class="php-var">$KAT</span>-&gt;getValue(<span class="php-quote">'status'</span>));
</span><span class="l" id="336">336             } <span class="php-keyword1">else</span> {
</span><span class="l" id="337">337                 <span class="php-var">$newstatus</span> = <span class="php-var">$status</span>;
</span><span class="l" id="338">338             }
</span><span class="l" id="339">339 
</span><span class="l" id="340">340             <span class="php-var">$EKAT</span> = rex_sql::factory();
</span><span class="l" id="341">341             <span class="php-var">$EKAT</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="342">342             <span class="php-var">$EKAT</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$category_id</span>,  <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>, <span class="php-quote">'startarticle'</span> =&gt; <span class="php-num">1</span>]);
</span><span class="l" id="343">343             <span class="php-var">$EKAT</span>-&gt;setValue(<span class="php-quote">'status'</span>, <span class="php-var">$newstatus</span>);
</span><span class="l" id="344">344             <span class="php-var">$EKAT</span>-&gt;addGlobalCreateFields(self::getUser());
</span><span class="l" id="345">345 
</span><span class="l" id="346">346             <span class="php-keyword1">try</span> {
</span><span class="l" id="347">347                 <span class="php-var">$EKAT</span>-&gt;update();
</span><span class="l" id="348">348 
</span><span class="l" id="349">349                 rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$category_id</span>, <span class="php-var">$clang</span>);
</span><span class="l" id="350">350 
</span><span class="l" id="351">351                 <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="352">352                 rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'CAT_STATUS'</span>, <span class="php-keyword1">null</span>, [
</span><span class="l" id="353">353                     <span class="php-quote">'id'</span> =&gt; <span class="php-var">$category_id</span>,
</span><span class="l" id="354">354                     <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$clang</span>,
</span><span class="l" id="355">355                     <span class="php-quote">'status'</span> =&gt; <span class="php-var">$newstatus</span>,
</span><span class="l" id="356">356                 ]));
</span><span class="l" id="357">357             } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="358">358                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-var">$e</span>);
</span><span class="l" id="359">359             }
</span><span class="l" id="360">360         } <span class="php-keyword1">else</span> {
</span><span class="l" id="361">361             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(rex_i18n::msg(<span class="php-quote">'no_such_category'</span>));
</span><span class="l" id="362">362         }
</span><span class="l" id="363">363 
</span><span class="l" id="364">364         <span class="php-keyword1">return</span> <span class="php-var">$newstatus</span>;
</span><span class="l" id="365">365     }
</span><span class="l" id="366">366 
</span><span class="l" id="367">367     <span class="php-comment">/**
</span></span><span class="l" id="368">368 <span class="php-comment">     * Gibt alle Stati zurück, die für eine Kategorie gültig sind.
</span></span><span class="l" id="369">369 <span class="php-comment">     *
</span></span><span class="l" id="370">370 <span class="php-comment">     * @return array Array von Stati
</span></span><span class="l" id="371">371 <span class="php-comment">     */</span>
</span><span class="l" id="372">372     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> statusTypes()
</span><span class="l" id="373">373     {
</span><span class="l" id="374">374         <span class="php-keyword1">static</span> <span class="php-var">$catStatusTypes</span>;
</span><span class="l" id="375">375 
</span><span class="l" id="376">376         <span class="php-keyword1">if</span> (!<span class="php-var">$catStatusTypes</span>) {
</span><span class="l" id="377">377             <span class="php-var">$catStatusTypes</span> = [
</span><span class="l" id="378">378                 <span class="php-comment">// Name, CSS-Class, Icon</span>
</span><span class="l" id="379">379                 [rex_i18n::msg(<span class="php-quote">'status_offline'</span>), <span class="php-quote">'rex-offline'</span>, <span class="php-quote">'rex-icon-offline'</span>],
</span><span class="l" id="380">380                 [rex_i18n::msg(<span class="php-quote">'status_online'</span>), <span class="php-quote">'rex-online'</span>, <span class="php-quote">'rex-icon-online'</span>],
</span><span class="l" id="381">381             ];
</span><span class="l" id="382">382 
</span><span class="l" id="383">383             <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="384">384             <span class="php-var">$catStatusTypes</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(<span class="php-quote">'CAT_STATUS_TYPES'</span>, <span class="php-var">$catStatusTypes</span>));
</span><span class="l" id="385">385         }
</span><span class="l" id="386">386 
</span><span class="l" id="387">387         <span class="php-keyword1">return</span> <span class="php-var">$catStatusTypes</span>;
</span><span class="l" id="388">388     }
</span><span class="l" id="389">389 
</span><span class="l" id="390">390     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> nextStatus(<span class="php-var">$currentStatus</span>)
</span><span class="l" id="391">391     {
</span><span class="l" id="392">392         <span class="php-var">$catStatusTypes</span> = self::statusTypes();
</span><span class="l" id="393">393         <span class="php-keyword1">return</span> (<span class="php-var">$currentStatus</span> + <span class="php-num">1</span>) % <span class="php-keyword2">count</span>(<span class="php-var">$catStatusTypes</span>);
</span><span class="l" id="394">394     }
</span><span class="l" id="395">395 
</span><span class="l" id="396">396     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> prevStatus(<span class="php-var">$currentStatus</span>)
</span><span class="l" id="397">397     {
</span><span class="l" id="398">398         <span class="php-var">$catStatusTypes</span> = self::statusTypes();
</span><span class="l" id="399">399         <span class="php-keyword1">if</span> ((<span class="php-var">$currentStatus</span> - <span class="php-num">1</span>) &lt; <span class="php-num">0</span>) {
</span><span class="l" id="400">400             <span class="php-keyword1">return</span> <span class="php-keyword2">count</span>(<span class="php-var">$catStatusTypes</span>) - <span class="php-num">1</span>;
</span><span class="l" id="401">401         }
</span><span class="l" id="402">402 
</span><span class="l" id="403">403         <span class="php-keyword1">return</span> (<span class="php-var">$currentStatus</span> - <span class="php-num">1</span>) % <span class="php-keyword2">count</span>(<span class="php-var">$catStatusTypes</span>);
</span><span class="l" id="404">404     }
</span><span class="l" id="405">405 
</span><span class="l" id="406">406     <span class="php-comment">/**
</span></span><span class="l" id="407">407 <span class="php-comment">     * Kopiert eine Kategorie in eine andere.
</span></span><span class="l" id="408">408 <span class="php-comment">     *
</span></span><span class="l" id="409">409 <span class="php-comment">     * @param int $from_cat KategorieId der Kategorie, die kopiert werden soll (Quelle)
</span></span><span class="l" id="410">410 <span class="php-comment">     * @param int $to_cat   KategorieId der Kategorie, IN die kopiert werden soll (Ziel)
</span></span><span class="l" id="411">411 <span class="php-comment">     */</span>
</span><span class="l" id="412">412     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> copyCategory(<span class="php-var">$from_cat</span>, <span class="php-var">$to_cat</span>)
</span><span class="l" id="413">413     {
</span><span class="l" id="414">414         <span class="php-comment">// TODO rex_copyCategory implementieren</span>
</span><span class="l" id="415">415     }
</span><span class="l" id="416">416 
</span><span class="l" id="417">417     <span class="php-comment">/**
</span></span><span class="l" id="418">418 <span class="php-comment">     * Berechnet die Prios der Kategorien in einer Kategorie neu.
</span></span><span class="l" id="419">419 <span class="php-comment">     *
</span></span><span class="l" id="420">420 <span class="php-comment">     * @param int $parent_id KategorieId der Kategorie, die erneuert werden soll
</span></span><span class="l" id="421">421 <span class="php-comment">     * @param int $clang     ClangId der Kategorie, die erneuert werden soll
</span></span><span class="l" id="422">422 <span class="php-comment">     * @param int $new_prio  Neue PrioNr der Kategorie
</span></span><span class="l" id="423">423 <span class="php-comment">     * @param int $old_prio  Alte PrioNr der Kategorie
</span></span><span class="l" id="424">424 <span class="php-comment">     */</span>
</span><span class="l" id="425">425     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> newCatPrio(<span class="php-var">$parent_id</span>, <span class="php-var">$clang</span>, <span class="php-var">$new_prio</span>, <span class="php-var">$old_prio</span>)
</span><span class="l" id="426">426     {
</span><span class="l" id="427">427         <span class="php-keyword1">if</span> (<span class="php-var">$new_prio</span> != <span class="php-var">$old_prio</span>) {
</span><span class="l" id="428">428             <span class="php-keyword1">if</span> (<span class="php-var">$new_prio</span> &lt; <span class="php-var">$old_prio</span>) {
</span><span class="l" id="429">429                 <span class="php-var">$addsql</span> = <span class="php-quote">'desc'</span>;
</span><span class="l" id="430">430             } <span class="php-keyword1">else</span> {
</span><span class="l" id="431">431                 <span class="php-var">$addsql</span> = <span class="php-quote">'asc'</span>;
</span><span class="l" id="432">432             }
</span><span class="l" id="433">433 
</span><span class="l" id="434">434             rex_sql_util::organizePriorities(
</span><span class="l" id="435">435                 rex::getTable(<span class="php-quote">'article'</span>),
</span><span class="l" id="436">436                 <span class="php-quote">'catpriority'</span>,
</span><span class="l" id="437">437                 <span class="php-quote">'clang_id='</span> . (int) <span class="php-var">$clang</span> . <span class="php-quote">' AND parent_id='</span> . (int) <span class="php-var">$parent_id</span> . <span class="php-quote">' AND startarticle=1'</span>,
</span><span class="l" id="438">438                 <span class="php-quote">'catpriority,updatedate '</span> . <span class="php-var">$addsql</span>
</span><span class="l" id="439">439             );
</span><span class="l" id="440">440 
</span><span class="l" id="441">441             rex_article_cache::deleteLists(<span class="php-var">$parent_id</span>);
</span><span class="l" id="442">442         }
</span><span class="l" id="443">443     }
</span><span class="l" id="444">444 
</span><span class="l" id="445">445     <span class="php-comment">/**
</span></span><span class="l" id="446">446 <span class="php-comment">     * Verschieben einer Kategorie in eine andere.
</span></span><span class="l" id="447">447 <span class="php-comment">     *
</span></span><span class="l" id="448">448 <span class="php-comment">     * @param int $from_cat KategorieId der Kategorie, die verschoben werden soll (Quelle)
</span></span><span class="l" id="449">449 <span class="php-comment">     * @param int $to_cat   KategorieId der Kategorie, IN die verschoben werden soll (Ziel)
</span></span><span class="l" id="450">450 <span class="php-comment">     *
</span></span><span class="l" id="451">451 <span class="php-comment">     * @return bool TRUE bei Erfolg, sonst FALSE
</span></span><span class="l" id="452">452 <span class="php-comment">     */</span>
</span><span class="l" id="453">453     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> moveCategory(<span class="php-var">$from_cat</span>, <span class="php-var">$to_cat</span>)
</span><span class="l" id="454">454     {
</span><span class="l" id="455">455         <span class="php-var">$from_cat</span> = (int) <span class="php-var">$from_cat</span>;
</span><span class="l" id="456">456         <span class="php-var">$to_cat</span> = (int) <span class="php-var">$to_cat</span>;
</span><span class="l" id="457">457 
</span><span class="l" id="458">458         <span class="php-keyword1">if</span> (<span class="php-var">$from_cat</span> == <span class="php-var">$to_cat</span>) {
</span><span class="l" id="459">459             <span class="php-comment">// kann nicht in gleiche kategroie kopiert werden</span>
</span><span class="l" id="460">460             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="461">461         }
</span><span class="l" id="462">462 
</span><span class="l" id="463">463         <span class="php-comment">// kategorien vorhanden ?</span>
</span><span class="l" id="464">464         <span class="php-comment">// ist die zielkategorie im pfad der quellkategeorie ?</span>
</span><span class="l" id="465">465         <span class="php-var">$fcat</span> = rex_sql::factory();
</span><span class="l" id="466">466         <span class="php-var">$fcat</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where startarticle=1 and id=? and clang_id=?'</span>, [<span class="php-var">$from_cat</span>, rex_clang::getStartId()]);
</span><span class="l" id="467">467 
</span><span class="l" id="468">468         <span class="php-var">$tcat</span> = rex_sql::factory();
</span><span class="l" id="469">469         <span class="php-var">$tcat</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where startarticle=1 and id=? and clang_id=?'</span>, [<span class="php-var">$to_cat</span>, rex_clang::getStartId()]);
</span><span class="l" id="470">470 
</span><span class="l" id="471">471         <span class="php-keyword1">if</span> (<span class="php-var">$fcat</span>-&gt;getRows() != <span class="php-num">1</span> || (<span class="php-var">$tcat</span>-&gt;getRows() != <span class="php-num">1</span> &amp;&amp; <span class="php-var">$to_cat</span> != <span class="php-num">0</span>)) {
</span><span class="l" id="472">472             <span class="php-comment">// eine der kategorien existiert nicht</span>
</span><span class="l" id="473">473             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="474">474         }
</span><span class="l" id="475">475         <span class="php-keyword1">if</span> (<span class="php-var">$to_cat</span> &gt; <span class="php-num">0</span>) {
</span><span class="l" id="476">476             <span class="php-var">$tcats</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'|'</span>, <span class="php-var">$tcat</span>-&gt;getValue(<span class="php-quote">'path'</span>));
</span><span class="l" id="477">477             <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$from_cat</span>, <span class="php-var">$tcats</span>)) {
</span><span class="l" id="478">478                 <span class="php-comment">// zielkategorie ist in quellkategorie -&gt; nicht verschiebbar</span>
</span><span class="l" id="479">479                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="480">480             }
</span><span class="l" id="481">481         }
</span><span class="l" id="482">482 
</span><span class="l" id="483">483         <span class="php-comment">// ----- folgende cats regenerate</span>
</span><span class="l" id="484">484         <span class="php-var">$RC</span> = [];
</span><span class="l" id="485">485         <span class="php-var">$RC</span>[<span class="php-var">$fcat</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>)] = <span class="php-num">1</span>;
</span><span class="l" id="486">486         <span class="php-var">$RC</span>[<span class="php-var">$from_cat</span>] = <span class="php-num">1</span>;
</span><span class="l" id="487">487         <span class="php-var">$RC</span>[<span class="php-var">$to_cat</span>] = <span class="php-num">1</span>;
</span><span class="l" id="488">488 
</span><span class="l" id="489">489         <span class="php-keyword1">if</span> (<span class="php-var">$to_cat</span> &gt; <span class="php-num">0</span>) {
</span><span class="l" id="490">490             <span class="php-var">$to_path</span> = <span class="php-var">$tcat</span>-&gt;getValue(<span class="php-quote">'path'</span>) . <span class="php-var">$to_cat</span> . <span class="php-quote">'|'</span>;
</span><span class="l" id="491">491         } <span class="php-keyword1">else</span> {
</span><span class="l" id="492">492             <span class="php-var">$to_path</span> = <span class="php-quote">'|'</span>;
</span><span class="l" id="493">493         }
</span><span class="l" id="494">494 
</span><span class="l" id="495">495         <span class="php-var">$from_path</span> = <span class="php-var">$fcat</span>-&gt;getValue(<span class="php-quote">'path'</span>) . <span class="php-var">$from_cat</span> . <span class="php-quote">'|'</span>;
</span><span class="l" id="496">496 
</span><span class="l" id="497">497         <span class="php-var">$gcats</span> = rex_sql::factory();
</span><span class="l" id="498">498         <span class="php-comment">// $gcats-&gt;setDebug();</span>
</span><span class="l" id="499">499         <span class="php-var">$gcats</span>-&gt;setQuery(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where path like ? and clang_id=?'</span>, [<span class="php-var">$from_path</span> . <span class="php-quote">'%'</span>, rex_clang::getStartId()]);
</span><span class="l" id="500">500 
</span><span class="l" id="501">501         <span class="php-var">$up</span> = rex_sql::factory();
</span><span class="l" id="502">502         <span class="php-comment">// $up-&gt;setDebug();</span>
</span><span class="l" id="503">503         <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$gcats</span>-&gt;getRows(); ++<span class="php-var">$i</span>) {
</span><span class="l" id="504">504             <span class="php-comment">// make update</span>
</span><span class="l" id="505">505             <span class="php-var">$new_path</span> = <span class="php-var">$to_path</span> . <span class="php-var">$from_cat</span> . <span class="php-quote">'|'</span> . <span class="php-keyword2">str_replace</span>(<span class="php-var">$from_path</span>, <span class="php-quote">''</span>, <span class="php-var">$gcats</span>-&gt;getValue(<span class="php-quote">'path'</span>));
</span><span class="l" id="506">506             <span class="php-var">$icid</span> = <span class="php-var">$gcats</span>-&gt;getValue(<span class="php-quote">'id'</span>);
</span><span class="l" id="507">507 
</span><span class="l" id="508">508             <span class="php-comment">// path aendern und speichern</span>
</span><span class="l" id="509">509             <span class="php-var">$up</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="510">510             <span class="php-var">$up</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$icid</span>]);
</span><span class="l" id="511">511             <span class="php-var">$up</span>-&gt;setValue(<span class="php-quote">'path'</span>, <span class="php-var">$new_path</span>);
</span><span class="l" id="512">512             <span class="php-var">$up</span>-&gt;update();
</span><span class="l" id="513">513 
</span><span class="l" id="514">514             <span class="php-comment">// cat in gen eintragen</span>
</span><span class="l" id="515">515             <span class="php-var">$RC</span>[<span class="php-var">$icid</span>] = <span class="php-num">1</span>;
</span><span class="l" id="516">516 
</span><span class="l" id="517">517             <span class="php-var">$gcats</span>-&gt;<span class="php-keyword2">next</span>();
</span><span class="l" id="518">518         }
</span><span class="l" id="519">519 
</span><span class="l" id="520">520         <span class="php-comment">// ----- clang holen, max catprio holen und entsprechen updaten</span>
</span><span class="l" id="521">521         <span class="php-var">$gmax</span> = rex_sql::factory();
</span><span class="l" id="522">522         <span class="php-var">$up</span> = rex_sql::factory();
</span><span class="l" id="523">523         <span class="php-comment">// $up-&gt;setDebug();</span>
</span><span class="l" id="524">524         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="525">525             <span class="php-var">$gmax</span>-&gt;setQuery(<span class="php-quote">'select max(catpriority) from '</span> . rex::getTablePrefix() . <span class="php-quote">'article where parent_id=? and clang_id=?'</span>, [<span class="php-var">$to_cat</span>, <span class="php-var">$clang</span>]);
</span><span class="l" id="526">526             <span class="php-var">$catpriority</span> = (int) <span class="php-var">$gmax</span>-&gt;getValue(<span class="php-quote">'max(catpriority)'</span>);
</span><span class="l" id="527">527             <span class="php-var">$up</span>-&gt;setTable(rex::getTablePrefix() . <span class="php-quote">'article'</span>);
</span><span class="l" id="528">528             <span class="php-var">$up</span>-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$from_cat</span>, <span class="php-quote">'clang_id'</span> =&gt; <span class="php-var">$clang</span>]);
</span><span class="l" id="529">529             <span class="php-var">$up</span>-&gt;setValue(<span class="php-quote">'path'</span>, <span class="php-var">$to_path</span>);
</span><span class="l" id="530">530             <span class="php-var">$up</span>-&gt;setValue(<span class="php-quote">'parent_id'</span>, <span class="php-var">$to_cat</span>);
</span><span class="l" id="531">531             <span class="php-var">$up</span>-&gt;setValue(<span class="php-quote">'catpriority'</span>, (<span class="php-var">$catpriority</span> + <span class="php-num">1</span>));
</span><span class="l" id="532">532             <span class="php-var">$up</span>-&gt;update();
</span><span class="l" id="533">533         }
</span><span class="l" id="534">534 
</span><span class="l" id="535">535         <span class="php-comment">// ----- generiere artikel neu - ohne neue inhaltsgenerierung</span>
</span><span class="l" id="536">536         <span class="php-keyword1">foreach</span> (<span class="php-var">$RC</span> <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$key</span>) {
</span><span class="l" id="537">537             rex_article_cache::<span class="php-keyword2">delete</span>(<span class="php-var">$id</span>);
</span><span class="l" id="538">538         }
</span><span class="l" id="539">539 
</span><span class="l" id="540">540         <span class="php-keyword1">foreach</span> (rex_clang::getAllIds() <span class="php-keyword1">as</span> <span class="php-var">$clang</span>) {
</span><span class="l" id="541">541             self::newCatPrio(<span class="php-var">$fcat</span>-&gt;getValue(<span class="php-quote">'parent_id'</span>), <span class="php-var">$clang</span>, <span class="php-num">0</span>, <span class="php-num">1</span>);
</span><span class="l" id="542">542         }
</span><span class="l" id="543">543 
</span><span class="l" id="544">544         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="545">545     }
</span><span class="l" id="546">546 
</span><span class="l" id="547">547     <span class="php-comment">/**
</span></span><span class="l" id="548">548 <span class="php-comment">     * Checks whether the required array key $keyName isset.
</span></span><span class="l" id="549">549 <span class="php-comment">     *
</span></span><span class="l" id="550">550 <span class="php-comment">     * @param array  $array   The array
</span></span><span class="l" id="551">551 <span class="php-comment">     * @param string $keyName The key
</span></span><span class="l" id="552">552 <span class="php-comment">     *
</span></span><span class="l" id="553">553 <span class="php-comment">     * @throws rex_api_exception
</span></span><span class="l" id="554">554 <span class="php-comment">     */</span>
</span><span class="l" id="555">555     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> reqKey(<span class="php-keyword1">array</span> <span class="php-var">$array</span>, <span class="php-var">$keyName</span>)
</span><span class="l" id="556">556     {
</span><span class="l" id="557">557         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$array</span>[<span class="php-var">$keyName</span>])) {
</span><span class="l" id="558">558             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_api_exception(<span class="php-quote">'Missing required parameter "'</span> . <span class="php-var">$keyName</span> . <span class="php-quote">'"!'</span>);
</span><span class="l" id="559">559         }
</span><span class="l" id="560">560     }
</span><span class="l" id="561">561 
</span><span class="l" id="562">562     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> getUser()
</span><span class="l" id="563">563     {
</span><span class="l" id="564">564         <span class="php-keyword1">if</span> (rex::getUser()) {
</span><span class="l" id="565">565             <span class="php-keyword1">return</span> rex::getUser()-&gt;getLogin();
</span><span class="l" id="566">566         }
</span><span class="l" id="567">567 
</span><span class="l" id="568">568         <span class="php-keyword1">if</span> (<span class="php-keyword2">method_exists</span>(rex::<span class="php-keyword1">class</span>, <span class="php-quote">'getEnvironment'</span>)) {
</span><span class="l" id="569">569             <span class="php-keyword1">return</span> rex::getEnvironment();
</span><span class="l" id="570">570         }
</span><span class="l" id="571">571 
</span><span class="l" id="572">572         <span class="php-keyword1">return</span> <span class="php-quote">'frontend'</span>;
</span><span class="l" id="573">573     }
</span><span class="l" id="574">574 }
</span><span class="l" id="575">575 </span></code></pre>
 </body>
</html>
