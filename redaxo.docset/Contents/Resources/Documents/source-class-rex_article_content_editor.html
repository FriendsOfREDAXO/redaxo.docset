<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Erweiterung eines Artikels um slicemanagement.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @package redaxo\structure\content
</span></span><span class="l" id="7">  7 <span class="php-comment"> */</span>
</span><span class="l" id="8">  8 <span class="php-keyword1">class</span> rex_article_content_editor <span class="php-keyword1">extends</span> rex_article_content
</span><span class="l" id="9">  9 {
</span><span class="l" id="10"> 10     <span class="php-keyword1">private</span> <span class="php-var">$MODULESELECT</span>;
</span><span class="l" id="11"> 11     <span class="php-keyword1">private</span> <span class="php-var">$sliceAddPosition</span> = <span class="php-num">0</span>;
</span><span class="l" id="12"> 12 
</span><span class="l" id="13"> 13     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> __construct(<span class="php-var">$article_id</span> = <span class="php-keyword1">null</span>, <span class="php-var">$clang</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="14"> 14     {
</span><span class="l" id="15"> 15         parent::__construct(<span class="php-var">$article_id</span>, <span class="php-var">$clang</span>);
</span><span class="l" id="16"> 16     }
</span><span class="l" id="17"> 17 
</span><span class="l" id="18"> 18     <span class="php-comment">/**
</span></span><span class="l" id="19"> 19 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="20"> 20 <span class="php-comment">     */</span>
</span><span class="l" id="21"> 21     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> outputSlice(rex_sql <span class="php-var">$artDataSql</span>, <span class="php-var">$moduleIdToAdd</span>)
</span><span class="l" id="22"> 22     {
</span><span class="l" id="23"> 23         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;mode != <span class="php-quote">'edit'</span>) {
</span><span class="l" id="24"> 24             <span class="php-comment">// ----- wenn mode nicht edit</span>
</span><span class="l" id="25"> 25             <span class="php-var">$slice_content</span> = parent::outputSlice(
</span><span class="l" id="26"> 26                 <span class="php-var">$artDataSql</span>,
</span><span class="l" id="27"> 27                 <span class="php-var">$moduleIdToAdd</span>
</span><span class="l" id="28"> 28             );
</span><span class="l" id="29"> 29         } <span class="php-keyword1">else</span> {
</span><span class="l" id="30"> 30             <span class="php-var">$sliceId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.id'</span>);
</span><span class="l" id="31"> 31             <span class="php-var">$sliceCtype</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.ctype_id'</span>);
</span><span class="l" id="32"> 32 
</span><span class="l" id="33"> 33             <span class="php-var">$moduleInput</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.input'</span>);
</span><span class="l" id="34"> 34             <span class="php-var">$moduleOutput</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.output'</span>);
</span><span class="l" id="35"> 35             <span class="php-var">$moduleId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.id'</span>);
</span><span class="l" id="36"> 36 
</span><span class="l" id="37"> 37             <span class="php-comment">// ----- add select box einbauen</span>
</span><span class="l" id="38"> 38             <span class="php-var">$slice_content</span> = <span class="php-var">$this</span>-&gt;getModuleSelect(<span class="php-var">$sliceId</span>);
</span><span class="l" id="39"> 39 
</span><span class="l" id="40"> 40             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span> == <span class="php-quote">'add'</span> &amp;&amp; <span class="php-var">$this</span>-&gt;slice_id == <span class="php-var">$sliceId</span>) {
</span><span class="l" id="41"> 41                 <span class="php-var">$slice_content</span> .= <span class="php-var">$this</span>-&gt;addSlice(<span class="php-var">$sliceId</span>, <span class="php-var">$moduleIdToAdd</span>);
</span><span class="l" id="42"> 42             }
</span><span class="l" id="43"> 43 
</span><span class="l" id="44"> 44             <span class="php-var">$panel</span> = <span class="php-quote">''</span>;
</span><span class="l" id="45"> 45             <span class="php-comment">// ----- Display message at current slice</span>
</span><span class="l" id="46"> 46             <span class="php-comment">//if(rex::getUser()-&gt;getComplexPerm('modules')-&gt;hasPerm($moduleId)) {</span>
</span><span class="l" id="47"> 47             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span> != <span class="php-quote">'add'</span> &amp;&amp; <span class="php-var">$this</span>-&gt;slice_id == <span class="php-var">$sliceId</span>) {
</span><span class="l" id="48"> 48                 <span class="php-var">$msg</span> = <span class="php-quote">''</span>;
</span><span class="l" id="49"> 49                 <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;warning != <span class="php-quote">''</span>) {
</span><span class="l" id="50"> 50                     <span class="php-var">$msg</span> .= rex_view::warning(<span class="php-var">$this</span>-&gt;warning);
</span><span class="l" id="51"> 51                 }
</span><span class="l" id="52"> 52                 <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;info != <span class="php-quote">''</span>) {
</span><span class="l" id="53"> 53                     <span class="php-var">$msg</span> .= rex_view::success(<span class="php-var">$this</span>-&gt;info);
</span><span class="l" id="54"> 54                 }
</span><span class="l" id="55"> 55                 <span class="php-var">$panel</span> .= <span class="php-var">$msg</span>;
</span><span class="l" id="56"> 56             }
</span><span class="l" id="57"> 57             <span class="php-comment">//}</span>
</span><span class="l" id="58"> 58 
</span><span class="l" id="59"> 59             <span class="php-comment">// ----- EDIT/DELETE BLOCK - Wenn Rechte vorhanden</span>
</span><span class="l" id="60"> 60             <span class="php-keyword1">if</span> (rex::getUser()-&gt;getComplexPerm(<span class="php-quote">'modules'</span>)-&gt;hasPerm(<span class="php-var">$moduleId</span>)) {
</span><span class="l" id="61"> 61                 <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span> == <span class="php-quote">'edit'</span> &amp;&amp; <span class="php-var">$this</span>-&gt;slice_id == <span class="php-var">$sliceId</span>) {
</span><span class="l" id="62"> 62                     <span class="php-comment">// **************** Aktueller Slice</span>
</span><span class="l" id="63"> 63 
</span><span class="l" id="64"> 64                     <span class="php-comment">// ----- PRE VIEW ACTION [EDIT]</span>
</span><span class="l" id="65"> 65                     <span class="php-var">$action</span> = <span class="php-keyword1">new</span> rex_article_action(<span class="php-var">$moduleId</span>, <span class="php-quote">'edit'</span>, <span class="php-var">$artDataSql</span>);
</span><span class="l" id="66"> 66                     <span class="php-keyword1">if</span> (rex_request_method() == <span class="php-quote">'post'</span> &amp;&amp; rex_request(<span class="php-quote">'function'</span>, <span class="php-quote">'string'</span>) == <span class="php-quote">'edit'</span>) {
</span><span class="l" id="67"> 67                         <span class="php-var">$action</span>-&gt;setRequestValues();
</span><span class="l" id="68"> 68                     }
</span><span class="l" id="69"> 69                     <span class="php-var">$action</span>-&gt;<span class="php-keyword2">exec</span>(rex_article_action::PREVIEW);
</span><span class="l" id="70"> 70                     <span class="php-comment">// ----- / PRE VIEW ACTION</span>
</span><span class="l" id="71"> 71 
</span><span class="l" id="72"> 72                     <span class="php-var">$moduleInput</span> = <span class="php-var">$this</span>-&gt;replaceVars(<span class="php-var">$artDataSql</span>, <span class="php-var">$moduleInput</span>);
</span><span class="l" id="73"> 73                     <span class="php-keyword1">return</span> <span class="php-var">$slice_content</span> . <span class="php-var">$this</span>-&gt;editSlice(<span class="php-var">$sliceId</span>, <span class="php-var">$moduleInput</span>, <span class="php-var">$sliceCtype</span>, <span class="php-var">$moduleId</span>, <span class="php-var">$artDataSql</span>);
</span><span class="l" id="74"> 74                 }
</span><span class="l" id="75"> 75                 <span class="php-comment">// Modulinhalt ausgeben</span>
</span><span class="l" id="76"> 76                 <span class="php-var">$moduleOutput</span> = <span class="php-var">$this</span>-&gt;replaceVars(<span class="php-var">$artDataSql</span>, <span class="php-var">$moduleOutput</span>);
</span><span class="l" id="77"> 77                 <span class="php-var">$panel</span> .= <span class="php-var">$this</span>-&gt;getWrappedModuleOutput(<span class="php-var">$moduleId</span>, <span class="php-var">$moduleOutput</span>);
</span><span class="l" id="78"> 78             } <span class="php-keyword1">else</span> {
</span><span class="l" id="79"> 79                 <span class="php-comment">// ----- hat keine rechte an diesem modul, einfach ausgeben</span>
</span><span class="l" id="80"> 80                 <span class="php-var">$moduleOutput</span> = <span class="php-var">$this</span>-&gt;replaceVars(<span class="php-var">$artDataSql</span>, <span class="php-var">$moduleOutput</span>);
</span><span class="l" id="81"> 81                 <span class="php-var">$panel</span> .= <span class="php-var">$this</span>-&gt;getWrappedModuleOutput(<span class="php-var">$moduleId</span>, <span class="php-var">$moduleOutput</span>);
</span><span class="l" id="82"> 82             }
</span><span class="l" id="83"> 83 
</span><span class="l" id="84"> 84             <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="85"> 85             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'title'</span>, <span class="php-var">$this</span>-&gt;getSliceHeading(<span class="php-var">$artDataSql</span>), <span class="php-keyword1">false</span>);
</span><span class="l" id="86"> 86             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'options'</span>, <span class="php-var">$this</span>-&gt;getSliceMenu(<span class="php-var">$artDataSql</span>), <span class="php-keyword1">false</span>);
</span><span class="l" id="87"> 87             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'body'</span>, <span class="php-var">$panel</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="88"> 88             <span class="php-var">$slice_content</span> .= <span class="php-quote">'&lt;li class="rex-slice rex-slice-output" id="slice'</span>.<span class="php-var">$sliceId</span>.<span class="php-quote">'"&gt;'</span> . <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/page/section.php'</span>) . <span class="php-quote">'&lt;/li&gt;'</span>;
</span><span class="l" id="89"> 89         }
</span><span class="l" id="90"> 90 
</span><span class="l" id="91"> 91         <span class="php-keyword1">return</span> <span class="php-var">$slice_content</span>;
</span><span class="l" id="92"> 92     }
</span><span class="l" id="93"> 93 
</span><span class="l" id="94"> 94     <span class="php-comment">/**
</span></span><span class="l" id="95"> 95 <span class="php-comment">     * Returns the slice heading.
</span></span><span class="l" id="96"> 96 <span class="php-comment">     *
</span></span><span class="l" id="97"> 97 <span class="php-comment">     * @param rex_sql $artDataSql rex_sql istance containing all the slice and module information
</span></span><span class="l" id="98"> 98 <span class="php-comment">     *
</span></span><span class="l" id="99"> 99 <span class="php-comment">     * @return string
</span></span><span class="l" id="100">100 <span class="php-comment">     */</span>
</span><span class="l" id="101">101     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getSliceHeading(rex_sql <span class="php-var">$artDataSql</span>)
</span><span class="l" id="102">102     {
</span><span class="l" id="103">103         <span class="php-var">$sliceId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.id'</span>);
</span><span class="l" id="104">104         <span class="php-var">$sliceCtype</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.ctype_id'</span>);
</span><span class="l" id="105">105 
</span><span class="l" id="106">106         <span class="php-var">$moduleId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.id'</span>);
</span><span class="l" id="107">107         <span class="php-var">$moduleName</span> = rex_i18n::translate(<span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.name'</span>));
</span><span class="l" id="108">108 
</span><span class="l" id="109">109         <span class="php-keyword1">return</span> <span class="php-var">$moduleName</span>;
</span><span class="l" id="110">110     }
</span><span class="l" id="111">111 
</span><span class="l" id="112">112     <span class="php-comment">/**
</span></span><span class="l" id="113">113 <span class="php-comment">     * Returns the slice menu.
</span></span><span class="l" id="114">114 <span class="php-comment">     *
</span></span><span class="l" id="115">115 <span class="php-comment">     * @param rex_sql $artDataSql rex_sql istance containing all the slice and module information
</span></span><span class="l" id="116">116 <span class="php-comment">     *
</span></span><span class="l" id="117">117 <span class="php-comment">     * @return string
</span></span><span class="l" id="118">118 <span class="php-comment">     */</span>
</span><span class="l" id="119">119     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getSliceMenu(rex_sql <span class="php-var">$artDataSql</span>)
</span><span class="l" id="120">120     {
</span><span class="l" id="121">121         <span class="php-var">$sliceId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.id'</span>);
</span><span class="l" id="122">122         <span class="php-var">$sliceCtype</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'article_slice.ctype_id'</span>);
</span><span class="l" id="123">123 
</span><span class="l" id="124">124         <span class="php-var">$moduleId</span> = <span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.id'</span>);
</span><span class="l" id="125">125         <span class="php-var">$moduleName</span> = rex_i18n::translate(<span class="php-var">$artDataSql</span>-&gt;getValue(rex::getTablePrefix() . <span class="php-quote">'module.name'</span>));
</span><span class="l" id="126">126 
</span><span class="l" id="127">127         <span class="php-var">$context</span> = <span class="php-keyword1">new</span> rex_context([
</span><span class="l" id="128">128             <span class="php-quote">'page'</span> =&gt; rex_be_controller::getCurrentPage(),
</span><span class="l" id="129">129             <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id,
</span><span class="l" id="130">130             <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$sliceId</span>,
</span><span class="l" id="131">131             <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="132">132             <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$this</span>-&gt;ctype,
</span><span class="l" id="133">133         ]);
</span><span class="l" id="134">134         <span class="php-var">$fragment</span> = <span class="php-quote">'#slice'</span> . <span class="php-var">$sliceId</span>;
</span><span class="l" id="135">135 
</span><span class="l" id="136">136         <span class="php-var">$header_right</span> = <span class="php-quote">''</span>;
</span><span class="l" id="137">137 
</span><span class="l" id="138">138         <span class="php-var">$menu_items_action</span> = [];
</span><span class="l" id="139">139         <span class="php-var">$menu_items_move</span> = [];
</span><span class="l" id="140">140 
</span><span class="l" id="141">141         <span class="php-keyword1">if</span> (rex::getUser()-&gt;getComplexPerm(<span class="php-quote">'modules'</span>)-&gt;hasPerm(<span class="php-var">$moduleId</span>)) {
</span><span class="l" id="142">142             <span class="php-var">$templateHasModule</span> = rex_template::hasModule(<span class="php-var">$this</span>-&gt;template_attributes, <span class="php-var">$this</span>-&gt;ctype, <span class="php-var">$moduleId</span>);
</span><span class="l" id="143">143             <span class="php-keyword1">if</span> (<span class="php-var">$templateHasModule</span>) {
</span><span class="l" id="144">144                 <span class="php-comment">// edit</span>
</span><span class="l" id="145">145                 <span class="php-var">$item</span> = [];
</span><span class="l" id="146">146                 <span class="php-var">$item</span>[<span class="php-quote">'hidden_label'</span>] = rex_i18n::msg(<span class="php-quote">'module'</span>) . <span class="php-quote">' '</span> . <span class="php-var">$moduleName</span> . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'edit'</span>);
</span><span class="l" id="147">147                 <span class="php-var">$item</span>[<span class="php-quote">'url'</span>] = <span class="php-var">$context</span>-&gt;getUrl([<span class="php-quote">'function'</span> =&gt; <span class="php-quote">'edit'</span>]) . <span class="php-var">$fragment</span>;
</span><span class="l" id="148">148                 <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'class'</span>][] = <span class="php-quote">'btn-edit'</span>;
</span><span class="l" id="149">149                 <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'title'</span>] = rex_i18n::msg(<span class="php-quote">'edit'</span>);
</span><span class="l" id="150">150                 <span class="php-var">$item</span>[<span class="php-quote">'icon'</span>] = <span class="php-quote">'edit'</span>;
</span><span class="l" id="151">151                 <span class="php-var">$menu_items_action</span>[] = <span class="php-var">$item</span>;
</span><span class="l" id="152">152             }
</span><span class="l" id="153">153 
</span><span class="l" id="154">154             <span class="php-comment">// delete</span>
</span><span class="l" id="155">155             <span class="php-var">$item</span> = [];
</span><span class="l" id="156">156             <span class="php-var">$item</span>[<span class="php-quote">'hidden_label'</span>] = rex_i18n::msg(<span class="php-quote">'module'</span>) . <span class="php-quote">' '</span> . <span class="php-var">$moduleName</span> . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'delete'</span>);
</span><span class="l" id="157">157             <span class="php-var">$item</span>[<span class="php-quote">'url'</span>] = <span class="php-var">$context</span>-&gt;getUrl([<span class="php-quote">'function'</span> =&gt; <span class="php-quote">'delete'</span>, <span class="php-quote">'save'</span> =&gt; <span class="php-num">1</span>]) . <span class="php-var">$fragment</span>;
</span><span class="l" id="158">158             <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'class'</span>][] = <span class="php-quote">'btn-delete'</span>;
</span><span class="l" id="159">159             <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'title'</span>] = rex_i18n::msg(<span class="php-quote">'delete'</span>);
</span><span class="l" id="160">160             <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'data-confirm'</span>] = rex_i18n::msg(<span class="php-quote">'confirm_delete_block'</span>);
</span><span class="l" id="161">161             <span class="php-var">$item</span>[<span class="php-quote">'icon'</span>] = <span class="php-quote">'delete'</span>;
</span><span class="l" id="162">162             <span class="php-var">$menu_items_action</span>[] = <span class="php-var">$item</span>;
</span><span class="l" id="163">163 
</span><span class="l" id="164">164             <span class="php-keyword1">if</span> (<span class="php-var">$templateHasModule</span> &amp;&amp; rex::getUser()-&gt;hasPerm(<span class="php-quote">'moveSlice[]'</span>)) {
</span><span class="l" id="165">165                 <span class="php-comment">// moveup</span>
</span><span class="l" id="166">166                 <span class="php-var">$item</span> = [];
</span><span class="l" id="167">167                 <span class="php-var">$item</span>[<span class="php-quote">'hidden_label'</span>] = rex_i18n::msg(<span class="php-quote">'module'</span>) . <span class="php-quote">' '</span> . <span class="php-var">$moduleName</span> . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'move_slice_up'</span>);
</span><span class="l" id="168">168                 <span class="php-var">$item</span>[<span class="php-quote">'url'</span>] = <span class="php-var">$context</span>-&gt;getUrl([<span class="php-quote">'upd'</span> =&gt; <span class="php-keyword2">time</span>(), <span class="php-quote">'direction'</span> =&gt; <span class="php-quote">'moveup'</span>] + rex_api_content_move_slice::getUrlParams()) . <span class="php-var">$fragment</span>;
</span><span class="l" id="169">169                 <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'class'</span>][] = <span class="php-quote">'btn-move'</span>;
</span><span class="l" id="170">170                 <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'title'</span>] = rex_i18n::msg(<span class="php-quote">'move_slice_up'</span>);
</span><span class="l" id="171">171                 <span class="php-var">$item</span>[<span class="php-quote">'icon'</span>] = <span class="php-quote">'up'</span>;
</span><span class="l" id="172">172                 <span class="php-var">$menu_items_move</span>[] = <span class="php-var">$item</span>;
</span><span class="l" id="173">173 
</span><span class="l" id="174">174                 <span class="php-comment">// movedown</span>
</span><span class="l" id="175">175                 <span class="php-var">$item</span> = [];
</span><span class="l" id="176">176                 <span class="php-var">$item</span>[<span class="php-quote">'hidden_label'</span>] = rex_i18n::msg(<span class="php-quote">'module'</span>) . <span class="php-quote">' '</span> . <span class="php-var">$moduleName</span> . <span class="php-quote">' '</span> . rex_i18n::msg(<span class="php-quote">'move_slice_down'</span>);
</span><span class="l" id="177">177                 <span class="php-var">$item</span>[<span class="php-quote">'url'</span>] = <span class="php-var">$context</span>-&gt;getUrl([<span class="php-quote">'upd'</span> =&gt; <span class="php-keyword2">time</span>(), <span class="php-quote">'direction'</span> =&gt; <span class="php-quote">'movedown'</span>] + rex_api_content_move_slice::getUrlParams()) . <span class="php-var">$fragment</span>;
</span><span class="l" id="178">178                 <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'class'</span>][] = <span class="php-quote">'btn-move'</span>;
</span><span class="l" id="179">179                 <span class="php-var">$item</span>[<span class="php-quote">'attributes'</span>][<span class="php-quote">'title'</span>] = rex_i18n::msg(<span class="php-quote">'move_slice_down'</span>);
</span><span class="l" id="180">180                 <span class="php-var">$item</span>[<span class="php-quote">'icon'</span>] = <span class="php-quote">'down'</span>;
</span><span class="l" id="181">181                 <span class="php-var">$menu_items_move</span>[] = <span class="php-var">$item</span>;
</span><span class="l" id="182">182             }
</span><span class="l" id="183">183         } <span class="php-keyword1">else</span> {
</span><span class="l" id="184">184             <span class="php-var">$header_right</span> .= rex_i18n::msg(<span class="php-quote">'no_editing_rights'</span>) . <span class="php-quote">' '</span> . <span class="php-var">$moduleName</span>;
</span><span class="l" id="185">185         }
</span><span class="l" id="186">186 
</span><span class="l" id="187">187         <span class="php-comment">// ----- EXTENSION POINT</span>
</span><span class="l" id="188">188         <span class="php-var">$menu_items_ep</span> = [];
</span><span class="l" id="189">189         <span class="php-var">$menu_items_ep</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(
</span><span class="l" id="190">190             <span class="php-quote">'STRUCTURE_CONTENT_SLICE_MENU'</span>,
</span><span class="l" id="191">191                 <span class="php-var">$menu_items_ep</span>,
</span><span class="l" id="192">192             [
</span><span class="l" id="193">193                 <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id,
</span><span class="l" id="194">194                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="195">195                 <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$sliceCtype</span>,
</span><span class="l" id="196">196                 <span class="php-quote">'module_id'</span> =&gt; <span class="php-var">$moduleId</span>,
</span><span class="l" id="197">197                 <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$sliceId</span>,
</span><span class="l" id="198">198                 <span class="php-quote">'perm'</span> =&gt; rex::getUser()-&gt;getComplexPerm(<span class="php-quote">'modules'</span>)-&gt;hasPerm(<span class="php-var">$moduleId</span>),
</span><span class="l" id="199">199             ]
</span><span class="l" id="200">200         ));
</span><span class="l" id="201">201 
</span><span class="l" id="202">202         <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$menu_items_action</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="203">203             <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="204">204             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'items'</span>, <span class="php-var">$menu_items_action</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="205">205             <span class="php-var">$header_right</span> .= <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'slice_menu_action.php'</span>);
</span><span class="l" id="206">206         }
</span><span class="l" id="207">207 
</span><span class="l" id="208">208         <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$menu_items_ep</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="209">209             <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="210">210             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'items'</span>, <span class="php-var">$menu_items_ep</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="211">211             <span class="php-var">$header_right</span> .= <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'slice_menu_ep.php'</span>);
</span><span class="l" id="212">212         }
</span><span class="l" id="213">213 
</span><span class="l" id="214">214         <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$menu_items_move</span>) &gt; <span class="php-num">0</span>) {
</span><span class="l" id="215">215             <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="216">216             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'items'</span>, <span class="php-var">$menu_items_move</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="217">217             <span class="php-var">$header_right</span> .= <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'slice_menu_move.php'</span>);
</span><span class="l" id="218">218         }
</span><span class="l" id="219">219 
</span><span class="l" id="220">220         <span class="php-comment">//$header_right = $header_right != '' ? '&lt;div class="col-md-4 text-right"&gt;' . $header_right . '&lt;/div&gt;' : '';</span>
</span><span class="l" id="221">221 
</span><span class="l" id="222">222         <span class="php-keyword1">return</span> <span class="php-var">$header_right</span>;
</span><span class="l" id="223">223     }
</span><span class="l" id="224">224 
</span><span class="l" id="225">225     <span class="php-comment">/**
</span></span><span class="l" id="226">226 <span class="php-comment">     * Wraps the output of a module.
</span></span><span class="l" id="227">227 <span class="php-comment">     *
</span></span><span class="l" id="228">228 <span class="php-comment">     * @param int    $moduleId     The id of the module
</span></span><span class="l" id="229">229 <span class="php-comment">     * @param string $moduleOutput The output of the module
</span></span><span class="l" id="230">230 <span class="php-comment">     *
</span></span><span class="l" id="231">231 <span class="php-comment">     * @return string
</span></span><span class="l" id="232">232 <span class="php-comment">     */</span>
</span><span class="l" id="233">233     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getWrappedModuleOutput(<span class="php-var">$moduleId</span>, <span class="php-var">$moduleOutput</span>)
</span><span class="l" id="234">234     {
</span><span class="l" id="235">235         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getStreamOutput(<span class="php-quote">'module/'</span> . <span class="php-var">$moduleId</span> . <span class="php-quote">'/output'</span>, <span class="php-var">$moduleOutput</span>);
</span><span class="l" id="236">236     }
</span><span class="l" id="237">237 
</span><span class="l" id="238">238     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> getModuleSelect(<span class="php-var">$sliceId</span>)
</span><span class="l" id="239">239     {
</span><span class="l" id="240">240         <span class="php-comment">// ----- BLOCKAUSWAHL - SELECT</span>
</span><span class="l" id="241">241         <span class="php-var">$context</span> = <span class="php-keyword1">new</span> rex_context([
</span><span class="l" id="242">242             <span class="php-quote">'page'</span> =&gt; rex_be_controller::getCurrentPage(),
</span><span class="l" id="243">243             <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id,
</span><span class="l" id="244">244             <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="245">245             <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$this</span>-&gt;ctype,
</span><span class="l" id="246">246             <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$sliceId</span>,
</span><span class="l" id="247">247             <span class="php-quote">'function'</span> =&gt; <span class="php-quote">'add'</span>,
</span><span class="l" id="248">248         ]);
</span><span class="l" id="249">249 
</span><span class="l" id="250">250         <span class="php-var">$position</span> = ++<span class="php-var">$this</span>-&gt;sliceAddPosition;
</span><span class="l" id="251">251 
</span><span class="l" id="252">252         <span class="php-var">$items</span> = [];
</span><span class="l" id="253">253         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;MODULESELECT[<span class="php-var">$this</span>-&gt;ctype])) {
</span><span class="l" id="254">254             <span class="php-keyword1">foreach</span> (<span class="php-var">$this</span>-&gt;MODULESELECT[<span class="php-var">$this</span>-&gt;ctype] <span class="php-keyword1">as</span> <span class="php-var">$module</span>) {
</span><span class="l" id="255">255                 <span class="php-var">$item</span> = [];
</span><span class="l" id="256">256                 <span class="php-var">$item</span>[<span class="php-quote">'title'</span>] = <span class="php-var">$module</span>[<span class="php-quote">'name'</span>];
</span><span class="l" id="257">257                 <span class="php-var">$item</span>[<span class="php-quote">'href'</span>] = <span class="php-var">$context</span>-&gt;getUrl([<span class="php-quote">'module_id'</span> =&gt; <span class="php-var">$module</span>[<span class="php-quote">'id'</span>]]) . <span class="php-quote">'#slice-add-pos-'</span> . <span class="php-var">$position</span>;
</span><span class="l" id="258">258                 <span class="php-var">$items</span>[] = <span class="php-var">$item</span>;
</span><span class="l" id="259">259             }
</span><span class="l" id="260">260         }
</span><span class="l" id="261">261 
</span><span class="l" id="262">262         <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="263">263         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'block'</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="264">264         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'button_label'</span>, rex_i18n::msg(<span class="php-quote">'add_block'</span>));
</span><span class="l" id="265">265         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'items'</span>, <span class="php-var">$items</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="266">266         <span class="php-var">$select</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/dropdowns/dropdown.php'</span>);
</span><span class="l" id="267">267         <span class="php-var">$select</span> = rex_extension::registerPoint(<span class="php-keyword1">new</span> rex_extension_point(
</span><span class="l" id="268">268             <span class="php-quote">'STRUCTURE_CONTENT_MODULE_SELECT'</span>,
</span><span class="l" id="269">269                 <span class="php-var">$select</span>,
</span><span class="l" id="270">270             [
</span><span class="l" id="271">271                 <span class="php-quote">'page'</span> =&gt; rex_be_controller::getCurrentPage(),
</span><span class="l" id="272">272                 <span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id,
</span><span class="l" id="273">273                 <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang,
</span><span class="l" id="274">274                 <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$this</span>-&gt;ctype,
</span><span class="l" id="275">275                 <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$sliceId</span>,
</span><span class="l" id="276">276             ]
</span><span class="l" id="277">277         ));
</span><span class="l" id="278">278         <span class="php-keyword1">return</span> <span class="php-quote">'&lt;li class="rex-slice rex-slice-select" id="slice-add-pos-'</span> . <span class="php-var">$position</span> . <span class="php-quote">'"&gt;'</span> . <span class="php-var">$select</span> . <span class="php-quote">'&lt;/li&gt;'</span>;
</span><span class="l" id="279">279     }
</span><span class="l" id="280">280 
</span><span class="l" id="281">281     <span class="php-comment">/**
</span></span><span class="l" id="282">282 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="283">283 <span class="php-comment">     */</span>
</span><span class="l" id="284">284     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> preArticle(<span class="php-var">$articleContent</span>, <span class="php-var">$module_id</span>)
</span><span class="l" id="285">285     {
</span><span class="l" id="286">286         <span class="php-comment">// ---------- moduleselect: nur module nehmen auf die der user rechte hat</span>
</span><span class="l" id="287">287         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;mode == <span class="php-quote">'edit'</span>) {
</span><span class="l" id="288">288             <span class="php-var">$MODULE</span> = rex_sql::factory();
</span><span class="l" id="289">289             <span class="php-var">$modules</span> = <span class="php-var">$MODULE</span>-&gt;getArray(<span class="php-quote">'select * from '</span> . rex::getTablePrefix() . <span class="php-quote">'module order by name'</span>);
</span><span class="l" id="290">290 
</span><span class="l" id="291">291             <span class="php-var">$template_ctypes</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;template_attributes[<span class="php-quote">'ctype'</span>]) ? <span class="php-var">$this</span>-&gt;template_attributes[<span class="php-quote">'ctype'</span>] : [];
</span><span class="l" id="292">292             <span class="php-comment">// wenn keine ctyes definiert sind, gibt es immer den CTYPE=1</span>
</span><span class="l" id="293">293             <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$template_ctypes</span>) == <span class="php-num">0</span>) {
</span><span class="l" id="294">294                 <span class="php-var">$template_ctypes</span> = [<span class="php-num">1</span> =&gt; <span class="php-quote">'default'</span>];
</span><span class="l" id="295">295             }
</span><span class="l" id="296">296 
</span><span class="l" id="297">297             <span class="php-var">$this</span>-&gt;MODULESELECT = [];
</span><span class="l" id="298">298             <span class="php-keyword1">foreach</span> (<span class="php-var">$template_ctypes</span> <span class="php-keyword1">as</span> <span class="php-var">$ct_id</span> =&gt; <span class="php-var">$ct_name</span>) {
</span><span class="l" id="299">299                 <span class="php-keyword1">foreach</span> (<span class="php-var">$modules</span> <span class="php-keyword1">as</span> <span class="php-var">$m</span>) {
</span><span class="l" id="300">300                     <span class="php-keyword1">if</span> (rex::getUser()-&gt;getComplexPerm(<span class="php-quote">'modules'</span>)-&gt;hasPerm(<span class="php-var">$m</span>[<span class="php-quote">'id'</span>])) {
</span><span class="l" id="301">301                         <span class="php-keyword1">if</span> (rex_template::hasModule(<span class="php-var">$this</span>-&gt;template_attributes, <span class="php-var">$ct_id</span>, <span class="php-var">$m</span>[<span class="php-quote">'id'</span>])) {
</span><span class="l" id="302">302                             <span class="php-var">$this</span>-&gt;MODULESELECT[<span class="php-var">$ct_id</span>][] = [<span class="php-quote">'name'</span> =&gt; rex_i18n::translate(<span class="php-var">$m</span>[<span class="php-quote">'name'</span>], <span class="php-keyword1">false</span>), <span class="php-quote">'id'</span> =&gt; <span class="php-var">$m</span>[<span class="php-quote">'id'</span>]];
</span><span class="l" id="303">303                         }
</span><span class="l" id="304">304                     }
</span><span class="l" id="305">305                 }
</span><span class="l" id="306">306             }
</span><span class="l" id="307">307         }
</span><span class="l" id="308">308 
</span><span class="l" id="309">309         <span class="php-keyword1">return</span> parent::preArticle(<span class="php-var">$articleContent</span>, <span class="php-var">$module_id</span>);
</span><span class="l" id="310">310     }
</span><span class="l" id="311">311 
</span><span class="l" id="312">312     <span class="php-comment">/**
</span></span><span class="l" id="313">313 <span class="php-comment">     * {@inheritdoc}
</span></span><span class="l" id="314">314 <span class="php-comment">     */</span>
</span><span class="l" id="315">315     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> postArticle(<span class="php-var">$articleContent</span>, <span class="php-var">$moduleIdToAdd</span>)
</span><span class="l" id="316">316     {
</span><span class="l" id="317">317         <span class="php-comment">// special identifier for the slot behind the last slice</span>
</span><span class="l" id="318">318         <span class="php-var">$LCTSL_ID</span> = -<span class="php-num">1</span>;
</span><span class="l" id="319">319 
</span><span class="l" id="320">320         <span class="php-comment">// ----- add module im edit mode</span>
</span><span class="l" id="321">321         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;mode == <span class="php-quote">'edit'</span>) {
</span><span class="l" id="322">322             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;<span class="php-keyword1">function</span> == <span class="php-quote">'add'</span> &amp;&amp; <span class="php-var">$this</span>-&gt;slice_id == <span class="php-var">$LCTSL_ID</span>) {
</span><span class="l" id="323">323                 <span class="php-var">$slice_content</span> = <span class="php-var">$this</span>-&gt;addSlice(<span class="php-var">$LCTSL_ID</span>, <span class="php-var">$moduleIdToAdd</span>);
</span><span class="l" id="324">324             } <span class="php-keyword1">else</span> {
</span><span class="l" id="325">325                 <span class="php-comment">// ----- BLOCKAUSWAHL - SELECT</span>
</span><span class="l" id="326">326                 <span class="php-var">$slice_content</span> = <span class="php-var">$this</span>-&gt;getModuleSelect(<span class="php-var">$LCTSL_ID</span>);
</span><span class="l" id="327">327             }
</span><span class="l" id="328">328             <span class="php-var">$articleContent</span> .= <span class="php-var">$slice_content</span>;
</span><span class="l" id="329">329         }
</span><span class="l" id="330">330 
</span><span class="l" id="331">331         <span class="php-keyword1">return</span> <span class="php-var">$articleContent</span>;
</span><span class="l" id="332">332     }
</span><span class="l" id="333">333 
</span><span class="l" id="334">334     <span class="php-comment">// ----- ADD Slice</span>
</span><span class="l" id="335">335     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> addSlice(<span class="php-var">$sliceId</span>, <span class="php-var">$moduleIdToAdd</span>)
</span><span class="l" id="336">336     {
</span><span class="l" id="337">337         <span class="php-var">$MOD</span> = rex_sql::factory();
</span><span class="l" id="338">338         <span class="php-var">$MOD</span>-&gt;setQuery(<span class="php-quote">'SELECT * FROM '</span> . rex::getTablePrefix() . <span class="php-quote">'module WHERE id="'</span> . <span class="php-var">$moduleIdToAdd</span> . <span class="php-quote">'"'</span>);
</span><span class="l" id="339">339 
</span><span class="l" id="340">340         <span class="php-keyword1">if</span> (<span class="php-var">$MOD</span>-&gt;getRows() != <span class="php-num">1</span>) {
</span><span class="l" id="341">341             <span class="php-var">$slice_content</span> = rex_view::warning(rex_i18n::msg(<span class="php-quote">'module_doesnt_exist'</span>));
</span><span class="l" id="342">342         } <span class="php-keyword1">else</span> {
</span><span class="l" id="343">343             <span class="php-var">$initDataSql</span> = rex_sql::factory();
</span><span class="l" id="344">344             <span class="php-var">$initDataSql</span>
</span><span class="l" id="345">345                 -&gt;setValue(<span class="php-quote">'module_id'</span>, <span class="php-var">$moduleIdToAdd</span>)
</span><span class="l" id="346">346                 -&gt;setValue(<span class="php-quote">'ctype_id'</span>, <span class="php-var">$this</span>-&gt;ctype);
</span><span class="l" id="347">347 
</span><span class="l" id="348">348             <span class="php-comment">// ----- PRE VIEW ACTION [ADD]</span>
</span><span class="l" id="349">349             <span class="php-var">$action</span> = <span class="php-keyword1">new</span> rex_article_action(<span class="php-var">$moduleIdToAdd</span>, <span class="php-quote">'add'</span>, <span class="php-var">$initDataSql</span>);
</span><span class="l" id="350">350             <span class="php-var">$action</span>-&gt;setRequestValues();
</span><span class="l" id="351">351             <span class="php-var">$action</span>-&gt;<span class="php-keyword2">exec</span>(rex_article_action::PREVIEW);
</span><span class="l" id="352">352             <span class="php-comment">// ----- / PRE VIEW ACTION</span>
</span><span class="l" id="353">353 
</span><span class="l" id="354">354             <span class="php-var">$moduleInput</span> = <span class="php-var">$this</span>-&gt;replaceVars(<span class="php-var">$initDataSql</span>, <span class="php-var">$MOD</span>-&gt;getValue(<span class="php-quote">'input'</span>));
</span><span class="l" id="355">355 
</span><span class="l" id="356">356             <span class="php-var">$moduleInput</span> = <span class="php-var">$this</span>-&gt;getStreamOutput(<span class="php-quote">'module/'</span> . <span class="php-var">$moduleIdToAdd</span> . <span class="php-quote">'/input'</span>, <span class="php-var">$moduleInput</span>);
</span><span class="l" id="357">357 
</span><span class="l" id="358">358             <span class="php-var">$msg</span> = <span class="php-quote">''</span>;
</span><span class="l" id="359">359             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;warning != <span class="php-quote">''</span>) {
</span><span class="l" id="360">360                 <span class="php-var">$msg</span> .= rex_view::warning(<span class="php-var">$this</span>-&gt;warning);
</span><span class="l" id="361">361             }
</span><span class="l" id="362">362             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;info != <span class="php-quote">''</span>) {
</span><span class="l" id="363">363                 <span class="php-var">$msg</span> .= rex_view::success(<span class="php-var">$this</span>-&gt;info);
</span><span class="l" id="364">364             }
</span><span class="l" id="365">365 
</span><span class="l" id="366">366             <span class="php-var">$formElements</span> = [];
</span><span class="l" id="367">367 
</span><span class="l" id="368">368             <span class="php-var">$n</span> = [];
</span><span class="l" id="369">369             <span class="php-var">$n</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;a class="btn btn-abort" href="'</span> . rex_url::currentBackendPage([<span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id, <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$sliceId</span>, <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang, <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$this</span>-&gt;ctype]) . <span class="php-quote">'#slice-add-pos-'</span> . <span class="php-var">$this</span>-&gt;sliceAddPosition . <span class="php-quote">'"&gt;'</span> . rex_i18n::msg(<span class="php-quote">'form_abort'</span>) . <span class="php-quote">'&lt;/a&gt;'</span>;
</span><span class="l" id="370">370             <span class="php-var">$formElements</span>[] = <span class="php-var">$n</span>;
</span><span class="l" id="371">371 
</span><span class="l" id="372">372             <span class="php-var">$n</span> = [];
</span><span class="l" id="373">373             <span class="php-var">$n</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;button class="btn btn-save" type="submit" name="btn_save" value="1"'</span> . rex::getAccesskey(rex_i18n::msg(<span class="php-quote">'add_block'</span>), <span class="php-quote">'save'</span>) . <span class="php-quote">'&gt;'</span> . rex_i18n::msg(<span class="php-quote">'add_block'</span>) . <span class="php-quote">'&lt;/button&gt;'</span>;
</span><span class="l" id="374">374             <span class="php-var">$formElements</span>[] = <span class="php-var">$n</span>;
</span><span class="l" id="375">375 
</span><span class="l" id="376">376             <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="377">377             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'elements'</span>, <span class="php-var">$formElements</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="378">378             <span class="php-var">$slice_footer</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/form/submit.php'</span>);
</span><span class="l" id="379">379 
</span><span class="l" id="380">380             <span class="php-var">$panel</span> = <span class="php-quote">'
</span></span><span class="l" id="381">381 <span class="php-quote">                &lt;fieldset&gt;
</span></span><span class="l" id="382">382 <span class="php-quote">                    &lt;legend&gt;'</span> . rex_i18n::msg(<span class="php-quote">'add_block'</span>) . <span class="php-quote">'&lt;/legend&gt;
</span></span><span class="l" id="383">383 <span class="php-quote">                    &lt;input type="hidden" name="function" value="add" /&gt;
</span></span><span class="l" id="384">384 <span class="php-quote">                    &lt;input type="hidden" name="module_id" value="'</span> . <span class="php-var">$moduleIdToAdd</span> . <span class="php-quote">'" /&gt;
</span></span><span class="l" id="385">385 <span class="php-quote">                    &lt;input type="hidden" name="save" value="1" /&gt;
</span></span><span class="l" id="386">386 <span class="php-quote">
</span></span><span class="l" id="387">387 <span class="php-quote">                    &lt;div class="rex-slice-input"&gt;
</span></span><span class="l" id="388">388 <span class="php-quote">                        '</span> . <span class="php-var">$moduleInput</span> . <span class="php-quote">'
</span></span><span class="l" id="389">389 <span class="php-quote">                    &lt;/div&gt;
</span></span><span class="l" id="390">390 <span class="php-quote">                &lt;/fieldset&gt;
</span></span><span class="l" id="391">391 <span class="php-quote">                        '</span>;
</span><span class="l" id="392">392 
</span><span class="l" id="393">393             <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="394">394             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'before'</span>, <span class="php-var">$msg</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="395">395             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'class'</span>, <span class="php-quote">'add'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="396">396             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'title'</span>, rex_i18n::msg(<span class="php-quote">'module'</span>) . <span class="php-quote">': '</span> . rex_i18n::translate(<span class="php-var">$MOD</span>-&gt;getValue(<span class="php-quote">'name'</span>)), <span class="php-keyword1">false</span>);
</span><span class="l" id="397">397             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'body'</span>, <span class="php-var">$panel</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="398">398             <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'footer'</span>, <span class="php-var">$slice_footer</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="399">399             <span class="php-var">$slice_content</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/page/section.php'</span>);
</span><span class="l" id="400">400 
</span><span class="l" id="401">401             <span class="php-var">$slice_content</span> = <span class="php-quote">'
</span></span><span class="l" id="402">402 <span class="php-quote">                &lt;li class="rex-slice rex-slice-add"&gt;
</span></span><span class="l" id="403">403 <span class="php-quote">                    &lt;form action="'</span> . rex_url::currentBackendPage([<span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id, <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$sliceId</span>, <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang, <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$this</span>-&gt;ctype]) . <span class="php-quote">'#slice-add-pos-'</span> . <span class="php-var">$this</span>-&gt;sliceAddPosition . <span class="php-quote">'" method="post" id="REX_FORM" enctype="multipart/form-data"&gt;
</span></span><span class="l" id="404">404 <span class="php-quote">                        '</span> . <span class="php-var">$slice_content</span> . <span class="php-quote">'
</span></span><span class="l" id="405">405 <span class="php-quote">                    &lt;/form&gt;
</span></span><span class="l" id="406">406 <span class="php-quote">                    &lt;script type="text/javascript"&gt;
</span></span><span class="l" id="407">407 <span class="php-quote">                         &lt;!--
</span></span><span class="l" id="408">408 <span class="php-quote">                        jQuery(function($) {
</span></span><span class="l" id="409">409 <span class="php-quote">                            $(":input:visible:enabled:not([readonly]):first", $("#REX_FORM")).focus();
</span></span><span class="l" id="410">410 <span class="php-quote">                        });
</span></span><span class="l" id="411">411 <span class="php-quote">                         //--&gt;
</span></span><span class="l" id="412">412 <span class="php-quote">                    &lt;/script&gt;
</span></span><span class="l" id="413">413 <span class="php-quote">                &lt;/li&gt;
</span></span><span class="l" id="414">414 <span class="php-quote">                '</span>;
</span><span class="l" id="415">415         }
</span><span class="l" id="416">416 
</span><span class="l" id="417">417         <span class="php-keyword1">return</span> <span class="php-var">$slice_content</span>;
</span><span class="l" id="418">418     }
</span><span class="l" id="419">419 
</span><span class="l" id="420">420     <span class="php-comment">// ----- EDIT Slice</span>
</span><span class="l" id="421">421     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> editSlice(<span class="php-var">$RE_CONTS</span>, <span class="php-var">$RE_MODUL_IN</span>, <span class="php-var">$RE_CTYPE</span>, <span class="php-var">$RE_MODUL_ID</span>, <span class="php-var">$artDataSql</span>)
</span><span class="l" id="422">422     {
</span><span class="l" id="423">423         <span class="php-var">$msg</span> = <span class="php-quote">''</span>;
</span><span class="l" id="424">424         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;slice_id == <span class="php-var">$RE_CONTS</span>) {
</span><span class="l" id="425">425             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;warning != <span class="php-quote">''</span>) {
</span><span class="l" id="426">426                 <span class="php-var">$msg</span> .= rex_view::warning(<span class="php-var">$this</span>-&gt;warning);
</span><span class="l" id="427">427             }
</span><span class="l" id="428">428             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;info != <span class="php-quote">''</span>) {
</span><span class="l" id="429">429                 <span class="php-var">$msg</span> .= rex_view::success(<span class="php-var">$this</span>-&gt;info);
</span><span class="l" id="430">430             }
</span><span class="l" id="431">431         }
</span><span class="l" id="432">432 
</span><span class="l" id="433">433         <span class="php-var">$formElements</span> = [];
</span><span class="l" id="434">434 
</span><span class="l" id="435">435         <span class="php-var">$n</span> = [];
</span><span class="l" id="436">436         <span class="php-var">$n</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;a class="btn btn-abort" href="'</span> . rex_url::currentBackendPage([<span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id, <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$RE_CONTS</span>, <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$RE_CTYPE</span>, <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang]) . <span class="php-quote">'#slice'</span> . <span class="php-var">$RE_CONTS</span> . <span class="php-quote">'"&gt;'</span> . rex_i18n::msg(<span class="php-quote">'form_abort'</span>) . <span class="php-quote">'&lt;/a&gt;'</span>;
</span><span class="l" id="437">437         <span class="php-var">$formElements</span>[] = <span class="php-var">$n</span>;
</span><span class="l" id="438">438 
</span><span class="l" id="439">439         <span class="php-var">$n</span> = [];
</span><span class="l" id="440">440         <span class="php-var">$n</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;button class="btn btn-save" type="submit" name="btn_save" value="1"'</span> . rex::getAccesskey(rex_i18n::msg(<span class="php-quote">'save_block'</span>), <span class="php-quote">'save'</span>) . <span class="php-quote">'&gt;'</span> . rex_i18n::msg(<span class="php-quote">'save_block'</span>) . <span class="php-quote">'&lt;/button&gt;'</span>;
</span><span class="l" id="441">441         <span class="php-var">$formElements</span>[] = <span class="php-var">$n</span>;
</span><span class="l" id="442">442 
</span><span class="l" id="443">443         <span class="php-var">$n</span> = [];
</span><span class="l" id="444">444         <span class="php-var">$n</span>[<span class="php-quote">'field'</span>] = <span class="php-quote">'&lt;button class="btn btn-apply" type="submit" name="btn_update" value="1"'</span> . rex::getAccesskey(rex_i18n::msg(<span class="php-quote">'update_block'</span>), <span class="php-quote">'apply'</span>) . <span class="php-quote">'&gt;'</span> . rex_i18n::msg(<span class="php-quote">'update_block'</span>) . <span class="php-quote">'&lt;/button&gt;'</span>;
</span><span class="l" id="445">445         <span class="php-var">$formElements</span>[] = <span class="php-var">$n</span>;
</span><span class="l" id="446">446 
</span><span class="l" id="447">447         <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="448">448         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'elements'</span>, <span class="php-var">$formElements</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="449">449         <span class="php-var">$slice_footer</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/form/submit.php'</span>);
</span><span class="l" id="450">450 
</span><span class="l" id="451">451         <span class="php-var">$panel</span> = <span class="php-quote">'
</span></span><span class="l" id="452">452 <span class="php-quote">                &lt;fieldset&gt;
</span></span><span class="l" id="453">453 <span class="php-quote">                    &lt;legend&gt;'</span> . rex_i18n::msg(<span class="php-quote">'edit_block'</span>) . <span class="php-quote">'&lt;/legend&gt;
</span></span><span class="l" id="454">454 <span class="php-quote">                    &lt;input type="hidden" name="module_id" value="'</span> . <span class="php-var">$RE_MODUL_ID</span> . <span class="php-quote">'" /&gt;
</span></span><span class="l" id="455">455 <span class="php-quote">                    &lt;input type="hidden" name="save" value="1" /&gt;
</span></span><span class="l" id="456">456 <span class="php-quote">                    &lt;input type="hidden" name="update" value="0" /&gt;
</span></span><span class="l" id="457">457 <span class="php-quote">
</span></span><span class="l" id="458">458 <span class="php-quote">                    &lt;div class="rex-slice-input"&gt;
</span></span><span class="l" id="459">459 <span class="php-quote">                        '</span> . <span class="php-var">$msg</span> . <span class="php-var">$this</span>-&gt;getStreamOutput(<span class="php-quote">'module/'</span> . <span class="php-var">$RE_MODUL_ID</span> . <span class="php-quote">'/input'</span>, <span class="php-var">$RE_MODUL_IN</span>) . <span class="php-quote">'
</span></span><span class="l" id="460">460 <span class="php-quote">                    &lt;/div&gt;
</span></span><span class="l" id="461">461 <span class="php-quote">                &lt;/fieldset&gt;
</span></span><span class="l" id="462">462 <span class="php-quote">
</span></span><span class="l" id="463">463 <span class="php-quote">            &lt;/form&gt;'</span>;
</span><span class="l" id="464">464 
</span><span class="l" id="465">465         <span class="php-var">$fragment</span> = <span class="php-keyword1">new</span> rex_fragment();
</span><span class="l" id="466">466         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'class'</span>, <span class="php-quote">'edit'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="467">467         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'title'</span>, <span class="php-var">$this</span>-&gt;getSliceHeading(<span class="php-var">$artDataSql</span>), <span class="php-keyword1">false</span>);
</span><span class="l" id="468">468         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'options'</span>, <span class="php-var">$this</span>-&gt;getSliceMenu(<span class="php-var">$artDataSql</span>), <span class="php-keyword1">false</span>);
</span><span class="l" id="469">469         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'body'</span>, <span class="php-var">$panel</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="470">470         <span class="php-var">$fragment</span>-&gt;setVar(<span class="php-quote">'footer'</span>, <span class="php-var">$slice_footer</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="471">471         <span class="php-var">$slice_content</span> = <span class="php-var">$fragment</span>-&gt;parse(<span class="php-quote">'core/page/section.php'</span>);
</span><span class="l" id="472">472 
</span><span class="l" id="473">473         <span class="php-var">$slice_content</span> = <span class="php-quote">'
</span></span><span class="l" id="474">474 <span class="php-quote">            &lt;li class="rex-slice rex-slice-edit" id="slice'</span> . <span class="php-var">$RE_CONTS</span> . <span class="php-quote">'"&gt;
</span></span><span class="l" id="475">475 <span class="php-quote">                &lt;form enctype="multipart/form-data" action="'</span> . rex_url::currentBackendPage([<span class="php-quote">'article_id'</span> =&gt; <span class="php-var">$this</span>-&gt;article_id, <span class="php-quote">'slice_id'</span> =&gt; <span class="php-var">$RE_CONTS</span>, <span class="php-quote">'ctype'</span> =&gt; <span class="php-var">$RE_CTYPE</span>, <span class="php-quote">'clang'</span> =&gt; <span class="php-var">$this</span>-&gt;clang, <span class="php-quote">'function'</span> =&gt; <span class="php-quote">'edit'</span>]) . <span class="php-quote">'#slice'</span> . <span class="php-var">$RE_CONTS</span> . <span class="php-quote">'" method="post" id="REX_FORM"&gt;
</span></span><span class="l" id="476">476 <span class="php-quote">                    '</span> . <span class="php-var">$slice_content</span> . <span class="php-quote">'
</span></span><span class="l" id="477">477 <span class="php-quote">                &lt;/form&gt;
</span></span><span class="l" id="478">478 <span class="php-quote">                &lt;script type="text/javascript"&gt;
</span></span><span class="l" id="479">479 <span class="php-quote">                     &lt;!--
</span></span><span class="l" id="480">480 <span class="php-quote">                    jQuery(function($) {
</span></span><span class="l" id="481">481 <span class="php-quote">                        $(":input:visible:enabled:not([readonly]):first", $("#REX_FORM")).focus();
</span></span><span class="l" id="482">482 <span class="php-quote">                    });
</span></span><span class="l" id="483">483 <span class="php-quote">                     //--&gt;
</span></span><span class="l" id="484">484 <span class="php-quote">                &lt;/script&gt;
</span></span><span class="l" id="485">485 <span class="php-quote">            &lt;/li&gt;
</span></span><span class="l" id="486">486 <span class="php-quote">            '</span>;
</span><span class="l" id="487">487 
</span><span class="l" id="488">488         <span class="php-keyword1">return</span> <span class="php-var">$slice_content</span>;
</span><span class="l" id="489">489     }
</span><span class="l" id="490">490 }
</span><span class="l" id="491">491 </span></code></pre>
 </body>
</html>
