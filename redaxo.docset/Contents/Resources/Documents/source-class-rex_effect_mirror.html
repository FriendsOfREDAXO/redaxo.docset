<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * @package redaxo\media-manager
</span></span><span class="l" id="5">  5 <span class="php-comment"> */</span>
</span><span class="l" id="6">  6 <span class="php-keyword1">class</span> rex_effect_mirror <span class="php-keyword1">extends</span> rex_effect_abstract
</span><span class="l" id="7">  7 {
</span><span class="l" id="8">  8     <span class="php-keyword1">private</span> <span class="php-var">$script</span>;
</span><span class="l" id="9">  9 
</span><span class="l" id="10"> 10     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> __construct()
</span><span class="l" id="11"> 11     {
</span><span class="l" id="12"> 12         <span class="php-var">$this</span>-&gt;script = <span class="php-quote">'
</span></span><span class="l" id="13"> 13 <span class="php-quote">&lt;script type="text/javascript"&gt;
</span></span><span class="l" id="14"> 14 <span class="php-quote">&lt;!--
</span></span><span class="l" id="15"> 15 <span class="php-quote">
</span></span><span class="l" id="16"> 16 <span class="php-quote">(function($) {
</span></span><span class="l" id="17"> 17 <span class="php-quote">    $(function() {
</span></span><span class="l" id="18"> 18 <span class="php-quote">        var $fx_mirror_select_trans = $("#media_manager_rex_effect_mirror_set_transparent_select");
</span></span><span class="l" id="19"> 19 <span class="php-quote">        var $fx_mirror_bg_r = $("#media_manager_rex_effect_mirror_bg_r_text").parent().parent();
</span></span><span class="l" id="20"> 20 <span class="php-quote">        var $fx_mirror_bg_g = $("#media_manager_rex_effect_mirror_bg_g_text").parent().parent();
</span></span><span class="l" id="21"> 21 <span class="php-quote">        var $fx_mirror_bg_b = $("#media_manager_rex_effect_mirror_bg_b_text").parent().parent();
</span></span><span class="l" id="22"> 22 <span class="php-quote">
</span></span><span class="l" id="23"> 23 <span class="php-quote">        $fx_mirror_select_trans.change(function(){
</span></span><span class="l" id="24"> 24 <span class="php-quote">            if(jQuery(this).val() != "colored")
</span></span><span class="l" id="25"> 25 <span class="php-quote">            {
</span></span><span class="l" id="26"> 26 <span class="php-quote">                $fx_mirror_bg_r.hide();
</span></span><span class="l" id="27"> 27 <span class="php-quote">                $fx_mirror_bg_g.hide();
</span></span><span class="l" id="28"> 28 <span class="php-quote">                $fx_mirror_bg_b.hide();
</span></span><span class="l" id="29"> 29 <span class="php-quote">            }else
</span></span><span class="l" id="30"> 30 <span class="php-quote">            {
</span></span><span class="l" id="31"> 31 <span class="php-quote">                $fx_mirror_bg_r.show();
</span></span><span class="l" id="32"> 32 <span class="php-quote">                $fx_mirror_bg_g.show();
</span></span><span class="l" id="33"> 33 <span class="php-quote">                $fx_mirror_bg_b.show();
</span></span><span class="l" id="34"> 34 <span class="php-quote">            }
</span></span><span class="l" id="35"> 35 <span class="php-quote">        }).change();
</span></span><span class="l" id="36"> 36 <span class="php-quote">    });
</span></span><span class="l" id="37"> 37 <span class="php-quote">})(jQuery);
</span></span><span class="l" id="38"> 38 <span class="php-quote">
</span></span><span class="l" id="39"> 39 <span class="php-quote">//--&gt;&lt;/script&gt;'</span>;
</span><span class="l" id="40"> 40     }
</span><span class="l" id="41"> 41 
</span><span class="l" id="42"> 42     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> execute()
</span><span class="l" id="43"> 43     {
</span><span class="l" id="44"> 44         <span class="php-var">$this</span>-&gt;media-&gt;asImage();
</span><span class="l" id="45"> 45         <span class="php-var">$gdimage</span> = <span class="php-var">$this</span>-&gt;media-&gt;getImage();
</span><span class="l" id="46"> 46 
</span><span class="l" id="47"> 47         <span class="php-var">$w</span> = <span class="php-var">$this</span>-&gt;media-&gt;getWidth();
</span><span class="l" id="48"> 48         <span class="php-var">$h</span> = <span class="php-var">$this</span>-&gt;media-&gt;getHeight();
</span><span class="l" id="49"> 49 
</span><span class="l" id="50"> 50         <span class="php-keyword1">if</span> (<span class="php-keyword2">substr</span>(<span class="php-keyword2">trim</span>(<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>]), -<span class="php-num">1</span>) === <span class="php-quote">'%'</span>) {
</span><span class="l" id="51"> 51             <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>] = <span class="php-keyword2">round</span>(<span class="php-var">$h</span> * (<span class="php-keyword2">rtrim</span>(<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>], <span class="php-quote">'%'</span>) / <span class="php-num">100</span>));
</span><span class="l" id="52"> 52         } <span class="php-keyword1">else</span> {
</span><span class="l" id="53"> 53             <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>] = (int) <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>];
</span><span class="l" id="54"> 54         }
</span><span class="l" id="55"> 55         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>] &lt; <span class="php-num">1</span>) {
</span><span class="l" id="56"> 56             <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>] = <span class="php-keyword2">round</span>(<span class="php-var">$h</span> / <span class="php-num">2</span>);
</span><span class="l" id="57"> 57         }
</span><span class="l" id="58"> 58 
</span><span class="l" id="59"> 59         <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_r'</span>] = (int) <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_r'</span>];
</span><span class="l" id="60"> 60         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_r'</span>]) || <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_r'</span>] &gt; <span class="php-num">255</span> || <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_r'</span>] &lt; <span class="php-num">0</span>) {
</span><span class="l" id="61"> 61             <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_r'</span>] = <span class="php-num">255</span>;
</span><span class="l" id="62"> 62         }
</span><span class="l" id="63"> 63 
</span><span class="l" id="64"> 64         <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_g'</span>] = (int) <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_g'</span>];
</span><span class="l" id="65"> 65         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_g'</span>]) || <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_g'</span>] &gt; <span class="php-num">255</span> || <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_g'</span>] &lt; <span class="php-num">0</span>) {
</span><span class="l" id="66"> 66             <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_g'</span>] = <span class="php-num">255</span>;
</span><span class="l" id="67"> 67         }
</span><span class="l" id="68"> 68 
</span><span class="l" id="69"> 69         <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_b'</span>] = (int) <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_b'</span>];
</span><span class="l" id="70"> 70         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_b'</span>]) || <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_b'</span>] &gt; <span class="php-num">255</span> || <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_b'</span>] &lt; <span class="php-num">0</span>) {
</span><span class="l" id="71"> 71             <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_b'</span>] = <span class="php-num">255</span>;
</span><span class="l" id="72"> 72         }
</span><span class="l" id="73"> 73 
</span><span class="l" id="74"> 74         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'set_transparent'</span>] != <span class="php-quote">'colored'</span>) {
</span><span class="l" id="75"> 75             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;media-&gt;getFormat() == <span class="php-quote">'webp'</span>) {
</span><span class="l" id="76"> 76                 <span class="php-var">$this</span>-&gt;media-&gt;setFormat(<span class="php-quote">'webp'</span>);
</span><span class="l" id="77"> 77             } <span class="php-keyword1">else</span> {
</span><span class="l" id="78"> 78                 <span class="php-var">$this</span>-&gt;media-&gt;setFormat(<span class="php-quote">'png'</span>);
</span><span class="l" id="79"> 79             }
</span><span class="l" id="80"> 80         }
</span><span class="l" id="81"> 81 
</span><span class="l" id="82"> 82         <span class="php-var">$trans</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="83"> 83         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;media-&gt;getFormat() == <span class="php-quote">'png'</span> || <span class="php-var">$this</span>-&gt;media-&gt;getFormat() == <span class="php-quote">'webp'</span>) {
</span><span class="l" id="84"> 84             <span class="php-var">$trans</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="85"> 85         }
</span><span class="l" id="86"> 86 
</span><span class="l" id="87"> 87         <span class="php-var">$gdimage</span> = <span class="php-var">$this</span>-&gt;imagereflection(<span class="php-var">$gdimage</span>, <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'height'</span>], <span class="php-var">$trans</span>, [<span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_r'</span>], <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_g'</span>], <span class="php-var">$this</span>-&gt;params[<span class="php-quote">'bg_b'</span>]]);
</span><span class="l" id="88"> 88         <span class="php-var">$this</span>-&gt;media-&gt;setImage(<span class="php-var">$gdimage</span>);
</span><span class="l" id="89"> 89         <span class="php-var">$this</span>-&gt;media-&gt;refreshImageDimensions();
</span><span class="l" id="90"> 90     }
</span><span class="l" id="91"> 91 
</span><span class="l" id="92"> 92     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getName()
</span><span class="l" id="93"> 93     {
</span><span class="l" id="94"> 94         <span class="php-keyword1">return</span> rex_i18n::msg(<span class="php-quote">'media_manager_effect_mirror'</span>);
</span><span class="l" id="95"> 95     }
</span><span class="l" id="96"> 96 
</span><span class="l" id="97"> 97     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getParams()
</span><span class="l" id="98"> 98     {
</span><span class="l" id="99"> 99         <span class="php-keyword1">return</span> [
</span><span class="l" id="100">100             [
</span><span class="l" id="101">101                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'media_manager_effect_mirror_height'</span>),    <span class="php-comment">// Length in Pixel or Prozent</span>
</span><span class="l" id="102">102                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'height'</span>,
</span><span class="l" id="103">103                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'int'</span>,
</span><span class="l" id="104">104             ],
</span><span class="l" id="105">105             [
</span><span class="l" id="106">106                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'media_manager_effect_mirror_background_color'</span>),
</span><span class="l" id="107">107                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'set_transparent'</span>,
</span><span class="l" id="108">108                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'select'</span>,
</span><span class="l" id="109">109                 <span class="php-quote">'options'</span> =&gt; [<span class="php-quote">'colored'</span>, <span class="php-quote">'transparent / png24'</span>],
</span><span class="l" id="110">110                 <span class="php-quote">'default'</span> =&gt; <span class="php-quote">'colored'</span>,
</span><span class="l" id="111">111                 <span class="php-quote">'suffix'</span> =&gt; <span class="php-var">$this</span>-&gt;script,
</span><span class="l" id="112">112             ],
</span><span class="l" id="113">113 
</span><span class="l" id="114">114             [
</span><span class="l" id="115">115                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'media_manager_effect_mirror_background_r'</span>),
</span><span class="l" id="116">116                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'bg_r'</span>,
</span><span class="l" id="117">117                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'int'</span>,
</span><span class="l" id="118">118             ],
</span><span class="l" id="119">119             [
</span><span class="l" id="120">120                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'media_manager_effect_mirror_background_g'</span>),
</span><span class="l" id="121">121                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'bg_g'</span>,
</span><span class="l" id="122">122                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'int'</span>,
</span><span class="l" id="123">123             ],
</span><span class="l" id="124">124             [
</span><span class="l" id="125">125                 <span class="php-quote">'label'</span> =&gt; rex_i18n::msg(<span class="php-quote">'media_manager_effect_mirror_background_b'</span>),
</span><span class="l" id="126">126                 <span class="php-quote">'name'</span> =&gt; <span class="php-quote">'bg_b'</span>,
</span><span class="l" id="127">127                 <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'int'</span>,
</span><span class="l" id="128">128             ],
</span><span class="l" id="129">129         ];
</span><span class="l" id="130">130     }
</span><span class="l" id="131">131 
</span><span class="l" id="132">132     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> imagereflection(&amp;<span class="php-var">$src_img</span>, <span class="php-var">$reflection_height</span>, <span class="php-var">$trans</span>, <span class="php-var">$bgcolor</span>)
</span><span class="l" id="133">133     {
</span><span class="l" id="134">134         <span class="php-var">$src_height</span> = <span class="php-keyword2">imagesy</span>(<span class="php-var">$src_img</span>);
</span><span class="l" id="135">135         <span class="php-var">$src_width</span> = <span class="php-keyword2">imagesx</span>(<span class="php-var">$src_img</span>);
</span><span class="l" id="136">136         <span class="php-var">$dest_height</span> = <span class="php-var">$src_height</span> + <span class="php-var">$reflection_height</span>;
</span><span class="l" id="137">137         <span class="php-var">$dest_width</span> = <span class="php-var">$src_width</span>;
</span><span class="l" id="138">138 
</span><span class="l" id="139">139         <span class="php-var">$reflected</span> = <span class="php-keyword2">imagecreatetruecolor</span>(<span class="php-var">$dest_width</span>, <span class="php-var">$dest_height</span>);
</span><span class="l" id="140">140         <span class="php-keyword1">if</span> (<span class="php-var">$trans</span>) {
</span><span class="l" id="141">141             <span class="php-keyword2">imagealphablending</span>(<span class="php-var">$reflected</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="142">142             <span class="php-keyword2">imagesavealpha</span>(<span class="php-var">$reflected</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="143">143         } <span class="php-keyword1">else</span> {
</span><span class="l" id="144">144             <span class="php-comment">// und mit Hintergrundfarbe füllen</span>
</span><span class="l" id="145">145             <span class="php-keyword2">imagefill</span>(<span class="php-var">$reflected</span>, <span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-keyword2">imagecolorallocate</span>(<span class="php-var">$reflected</span>, <span class="php-var">$bgcolor</span>[<span class="php-num">0</span>], <span class="php-var">$bgcolor</span>[<span class="php-num">1</span>], <span class="php-var">$bgcolor</span>[<span class="php-num">2</span>]));
</span><span class="l" id="146">146         }
</span><span class="l" id="147">147 
</span><span class="l" id="148">148         <span class="php-keyword2">imagecopy</span>(<span class="php-var">$reflected</span>, <span class="php-var">$src_img</span>, <span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-var">$src_width</span>, <span class="php-var">$src_height</span>);
</span><span class="l" id="149">149         <span class="php-var">$alpha_step</span> = <span class="php-num">80</span> / <span class="php-var">$reflection_height</span>;
</span><span class="l" id="150">150         <span class="php-keyword1">for</span> (<span class="php-var">$y</span> = <span class="php-num">1</span>; <span class="php-var">$y</span> &lt;= <span class="php-var">$reflection_height</span>; ++<span class="php-var">$y</span>) {
</span><span class="l" id="151">151             <span class="php-keyword1">for</span> (<span class="php-var">$x</span> = <span class="php-num">0</span>; <span class="php-var">$x</span> &lt; <span class="php-var">$dest_width</span>; ++<span class="php-var">$x</span>) {
</span><span class="l" id="152">152                 <span class="php-var">$rgba</span> = <span class="php-keyword2">imagecolorat</span>(<span class="php-var">$src_img</span>, <span class="php-var">$x</span>, <span class="php-var">$src_height</span> - <span class="php-var">$y</span>);
</span><span class="l" id="153">153                 <span class="php-var">$alpha</span> = (<span class="php-var">$rgba</span> &amp; <span class="php-num">0x7F000000</span>) &gt;&gt; <span class="php-num">24</span>;
</span><span class="l" id="154">154                 <span class="php-var">$alpha</span> = <span class="php-keyword2">max</span>(<span class="php-var">$alpha</span>, <span class="php-num">47</span> + (<span class="php-var">$y</span> * <span class="php-var">$alpha_step</span>));
</span><span class="l" id="155">155                 <span class="php-var">$rgba</span> = <span class="php-keyword2">imagecolorsforindex</span>(<span class="php-var">$src_img</span>, <span class="php-var">$rgba</span>);
</span><span class="l" id="156">156                 <span class="php-var">$rgba</span> = <span class="php-keyword2">imagecolorallocatealpha</span>(<span class="php-var">$reflected</span>, <span class="php-var">$rgba</span>[<span class="php-quote">'red'</span>], <span class="php-var">$rgba</span>[<span class="php-quote">'green'</span>], <span class="php-var">$rgba</span>[<span class="php-quote">'blue'</span>], <span class="php-var">$alpha</span>);
</span><span class="l" id="157">157                 <span class="php-keyword2">imagesetpixel</span>(<span class="php-var">$reflected</span>, <span class="php-var">$x</span>, <span class="php-var">$src_height</span> + <span class="php-var">$y</span> - <span class="php-num">1</span>, <span class="php-var">$rgba</span>);
</span><span class="l" id="158">158             }
</span><span class="l" id="159">159         }
</span><span class="l" id="160">160 
</span><span class="l" id="161">161         <span class="php-keyword1">return</span> <span class="php-var">$reflected</span>;
</span><span class="l" id="162">162     }
</span><span class="l" id="163">163 }
</span><span class="l" id="164">164 </span></code></pre>
 </body>
</html>
