<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Escapes a variable.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * This function is adapted from code coming from Twig.
</span></span><span class="l" id="7">  7 <span class="php-comment"> * (c) Fabien Potencier
</span></span><span class="l" id="8">  8 <span class="php-comment"> * https://github.com/twigphp/Twig/blob/103cae817d68b56ddcb50c051a6ed7980d746409/lib/Twig/Extension/Core.php#L880-L1106
</span></span><span class="l" id="9">  9 <span class="php-comment"> *
</span></span><span class="l" id="10"> 10 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="11"> 11 <span class="php-comment"> *
</span></span><span class="l" id="12"> 12 <span class="php-comment"> * @param mixed  $value    The value to escape
</span></span><span class="l" id="13"> 13 <span class="php-comment"> * @param string $strategy One of "html", "html_attr", "css", "js", "url"
</span></span><span class="l" id="14"> 14 <span class="php-comment"> *
</span></span><span class="l" id="15"> 15 <span class="php-comment"> * @throws InvalidArgumentException
</span></span><span class="l" id="16"> 16 <span class="php-comment"> *
</span></span><span class="l" id="17"> 17 <span class="php-comment"> * @return mixed
</span></span><span class="l" id="18"> 18 <span class="php-comment"> */</span>
</span><span class="l" id="19"> 19 <span class="php-keyword1">function</span> rex_escape(<span class="php-var">$value</span>, <span class="php-var">$strategy</span> = <span class="php-quote">'html'</span>)
</span><span class="l" id="20"> 20 {
</span><span class="l" id="21"> 21     <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$value</span>)) {
</span><span class="l" id="22"> 22         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$value</span>)) {
</span><span class="l" id="23"> 23             <span class="php-keyword1">foreach</span> (<span class="php-var">$value</span> <span class="php-keyword1">as</span> <span class="php-var">$k</span> =&gt; <span class="php-var">$v</span>) {
</span><span class="l" id="24"> 24                 <span class="php-var">$value</span>[<span class="php-var">$k</span>] = rex_escape(<span class="php-var">$v</span>, <span class="php-var">$strategy</span>);
</span><span class="l" id="25"> 25             }
</span><span class="l" id="26"> 26 
</span><span class="l" id="27"> 27             <span class="php-keyword1">return</span> <span class="php-var">$value</span>;
</span><span class="l" id="28"> 28         }
</span><span class="l" id="29"> 29 
</span><span class="l" id="30"> 30         <span class="php-keyword1">if</span> (<span class="php-var">$value</span> <span class="php-keyword1">instanceof</span> \stdClass) {
</span><span class="l" id="31"> 31             <span class="php-keyword1">foreach</span> (<span class="php-keyword2">get_object_vars</span>(<span class="php-var">$value</span>) <span class="php-keyword1">as</span> <span class="php-var">$k</span> =&gt; <span class="php-var">$v</span>) {
</span><span class="l" id="32"> 32                 <span class="php-var">$value</span>-&gt;<span class="php-var">$k</span> = rex_escape(<span class="php-var">$v</span>, <span class="php-var">$strategy</span>);
</span><span class="l" id="33"> 33             }
</span><span class="l" id="34"> 34 
</span><span class="l" id="35"> 35             <span class="php-keyword1">return</span> <span class="php-var">$value</span>;
</span><span class="l" id="36"> 36         }
</span><span class="l" id="37"> 37 
</span><span class="l" id="38"> 38         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_object</span>(<span class="php-var">$value</span>) &amp;&amp; <span class="php-keyword2">method_exists</span>(<span class="php-var">$value</span>, <span class="php-quote">'__toString'</span>)) {
</span><span class="l" id="39"> 39             <span class="php-var">$value</span> = (string) <span class="php-var">$value</span>;
</span><span class="l" id="40"> 40         } <span class="php-keyword1">else</span> {
</span><span class="l" id="41"> 41             <span class="php-keyword1">return</span> <span class="php-var">$value</span>;
</span><span class="l" id="42"> 42         }
</span><span class="l" id="43"> 43     }
</span><span class="l" id="44"> 44 
</span><span class="l" id="45"> 45     <span class="php-var">$string</span> = <span class="php-var">$value</span>;
</span><span class="l" id="46"> 46 
</span><span class="l" id="47"> 47     <span class="php-keyword1">switch</span> (<span class="php-var">$strategy</span>) {
</span><span class="l" id="48"> 48         <span class="php-keyword1">case</span> <span class="php-quote">'html'</span>:
</span><span class="l" id="49"> 49             <span class="php-comment">// see http://php.net/htmlspecialchars</span>
</span><span class="l" id="50"> 50             <span class="php-keyword1">return</span> <span class="php-keyword2">htmlspecialchars</span>(<span class="php-var">$string</span>, ENT_QUOTES | ENT_SUBSTITUTE, <span class="php-quote">'UTF-8'</span>);
</span><span class="l" id="51"> 51 
</span><span class="l" id="52"> 52         <span class="php-keyword1">case</span> <span class="php-quote">'js'</span>:
</span><span class="l" id="53"> 53             <span class="php-comment">// escape all non-alphanumeric characters</span>
</span><span class="l" id="54"> 54             <span class="php-comment">// into their \xHH or \uHHHH representations</span>
</span><span class="l" id="55"> 55 
</span><span class="l" id="56"> 56             <span class="php-keyword1">if</span> (<span class="php-num">0</span> === <span class="php-keyword2">strlen</span>(<span class="php-var">$string</span>) ? <span class="php-keyword1">false</span> : <span class="php-num">1</span> !== <span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^./su'</span>, <span class="php-var">$string</span>)) {
</span><span class="l" id="57"> 57                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'The string to escape is not a valid UTF-8 string.'</span>);
</span><span class="l" id="58"> 58             }
</span><span class="l" id="59"> 59 
</span><span class="l" id="60"> 60             <span class="php-var">$string</span> = <span class="php-keyword2">preg_replace_callback</span>(<span class="php-quote">'#[^a-zA-Z0-9,\._]#Su'</span>, <span class="php-keyword1">function</span> (<span class="php-var">$matches</span>) {
</span><span class="l" id="61"> 61                 <span class="php-var">$char</span> = <span class="php-var">$matches</span>[<span class="php-num">0</span>];
</span><span class="l" id="62"> 62 
</span><span class="l" id="63"> 63                 <span class="php-comment">// \xHH</span>
</span><span class="l" id="64"> 64                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$char</span>[<span class="php-num">1</span>])) {
</span><span class="l" id="65"> 65                     <span class="php-keyword1">return</span> <span class="php-quote">'\\x'</span>.<span class="php-keyword2">strtoupper</span>(<span class="php-keyword2">substr</span>(<span class="php-quote">'00'</span>.<span class="php-keyword2">bin2hex</span>(<span class="php-var">$char</span>), -<span class="php-num">2</span>));
</span><span class="l" id="66"> 66                 }
</span><span class="l" id="67"> 67 
</span><span class="l" id="68"> 68                 <span class="php-comment">// \uHHHH</span>
</span><span class="l" id="69"> 69                 <span class="php-var">$char</span> = <span class="php-keyword2">mb_convert_encoding</span>(<span class="php-var">$char</span>, <span class="php-quote">'UTF-16BE'</span>, <span class="php-quote">'UTF-8'</span>);
</span><span class="l" id="70"> 70                 <span class="php-var">$char</span> = <span class="php-keyword2">strtoupper</span>(<span class="php-keyword2">bin2hex</span>(<span class="php-var">$char</span>));
</span><span class="l" id="71"> 71 
</span><span class="l" id="72"> 72                 <span class="php-keyword1">if</span> (<span class="php-num">4</span> &gt;= <span class="php-keyword2">strlen</span>(<span class="php-var">$char</span>)) {
</span><span class="l" id="73"> 73                     <span class="php-keyword1">return</span> <span class="php-keyword2">sprintf</span>(<span class="php-quote">'\u%04s'</span>, <span class="php-var">$char</span>);
</span><span class="l" id="74"> 74                 }
</span><span class="l" id="75"> 75 
</span><span class="l" id="76"> 76                 <span class="php-keyword1">return</span> <span class="php-keyword2">sprintf</span>(<span class="php-quote">'\u%04s\u%04s'</span>, <span class="php-keyword2">substr</span>(<span class="php-var">$char</span>, <span class="php-num">0</span>, -<span class="php-num">4</span>), <span class="php-keyword2">substr</span>(<span class="php-var">$char</span>, -<span class="php-num">4</span>));
</span><span class="l" id="77"> 77             }, <span class="php-var">$string</span>);
</span><span class="l" id="78"> 78 
</span><span class="l" id="79"> 79             <span class="php-keyword1">return</span> <span class="php-var">$string</span>;
</span><span class="l" id="80"> 80 
</span><span class="l" id="81"> 81         <span class="php-keyword1">case</span> <span class="php-quote">'css'</span>:
</span><span class="l" id="82"> 82             <span class="php-keyword1">if</span> (<span class="php-num">0</span> == <span class="php-keyword2">strlen</span>(<span class="php-var">$string</span>) ? <span class="php-keyword1">false</span> : <span class="php-num">1</span> !== <span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^./su'</span>, <span class="php-var">$string</span>)) {
</span><span class="l" id="83"> 83                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'The string to escape is not a valid UTF-8 string.'</span>);
</span><span class="l" id="84"> 84             }
</span><span class="l" id="85"> 85 
</span><span class="l" id="86"> 86             <span class="php-var">$string</span> = <span class="php-keyword2">preg_replace_callback</span>(<span class="php-quote">'#[^a-zA-Z0-9]#Su'</span>, <span class="php-keyword1">function</span> (<span class="php-var">$matches</span>) {
</span><span class="l" id="87"> 87                 <span class="php-var">$char</span> = <span class="php-var">$matches</span>[<span class="php-num">0</span>];
</span><span class="l" id="88"> 88 
</span><span class="l" id="89"> 89                 <span class="php-comment">// \xHH</span>
</span><span class="l" id="90"> 90                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$char</span>[<span class="php-num">1</span>])) {
</span><span class="l" id="91"> 91                     <span class="php-var">$hex</span> = <span class="php-keyword2">ltrim</span>(<span class="php-keyword2">strtoupper</span>(<span class="php-keyword2">bin2hex</span>(<span class="php-var">$char</span>)), <span class="php-quote">'0'</span>);
</span><span class="l" id="92"> 92                     <span class="php-keyword1">if</span> (<span class="php-num">0</span> === <span class="php-keyword2">strlen</span>(<span class="php-var">$hex</span>)) {
</span><span class="l" id="93"> 93                         <span class="php-var">$hex</span> = <span class="php-quote">'0'</span>;
</span><span class="l" id="94"> 94                     }
</span><span class="l" id="95"> 95 
</span><span class="l" id="96"> 96                     <span class="php-keyword1">return</span> <span class="php-quote">'\\'</span>.<span class="php-var">$hex</span>.<span class="php-quote">' '</span>;
</span><span class="l" id="97"> 97                 }
</span><span class="l" id="98"> 98 
</span><span class="l" id="99"> 99                 <span class="php-comment">// \uHHHH</span>
</span><span class="l" id="100">100                 <span class="php-var">$char</span> = <span class="php-keyword2">mb_convert_encoding</span>(<span class="php-var">$char</span>, <span class="php-quote">'UTF-16BE'</span>, <span class="php-quote">'UTF-8'</span>);
</span><span class="l" id="101">101 
</span><span class="l" id="102">102                 <span class="php-keyword1">return</span> <span class="php-quote">'\\'</span>.<span class="php-keyword2">ltrim</span>(<span class="php-keyword2">strtoupper</span>(<span class="php-keyword2">bin2hex</span>(<span class="php-var">$char</span>)), <span class="php-quote">'0'</span>).<span class="php-quote">' '</span>;
</span><span class="l" id="103">103             }, <span class="php-var">$string</span>);
</span><span class="l" id="104">104 
</span><span class="l" id="105">105             <span class="php-keyword1">return</span> <span class="php-var">$string</span>;
</span><span class="l" id="106">106 
</span><span class="l" id="107">107         <span class="php-keyword1">case</span> <span class="php-quote">'html_attr'</span>:
</span><span class="l" id="108">108             <span class="php-keyword1">if</span> (<span class="php-num">0</span> == <span class="php-keyword2">strlen</span>(<span class="php-var">$string</span>) ? <span class="php-keyword1">false</span> : <span class="php-num">1</span> !== <span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^./su'</span>, <span class="php-var">$string</span>)) {
</span><span class="l" id="109">109                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-quote">'The string to escape is not a valid UTF-8 string.'</span>);
</span><span class="l" id="110">110             }
</span><span class="l" id="111">111 
</span><span class="l" id="112">112             <span class="php-var">$string</span> = <span class="php-keyword2">preg_replace_callback</span>(<span class="php-quote">'#[^a-zA-Z0-9,\.\-_]#Su'</span>, <span class="php-keyword1">function</span> (<span class="php-var">$matches</span>) {
</span><span class="l" id="113">113                 <span class="php-comment">/**
</span></span><span class="l" id="114">114 <span class="php-comment">                 * This function is adapted from code coming from Zend Framework.
</span></span><span class="l" id="115">115 <span class="php-comment">                 *
</span></span><span class="l" id="116">116 <span class="php-comment">                 * @copyright Copyright (c) 2005-2012 Zend Technologies USA Inc. (http://www.zend.com)
</span></span><span class="l" id="117">117 <span class="php-comment">                 * @license   http://framework.zend.com/license/new-bsd New BSD License
</span></span><span class="l" id="118">118 <span class="php-comment">                 */</span>
</span><span class="l" id="119">119                 <span class="php-comment">/*
</span></span><span class="l" id="120">120 <span class="php-comment">                 * While HTML supports far more named entities, the lowest common denominator
</span></span><span class="l" id="121">121 <span class="php-comment">                 * has become HTML5's XML Serialisation which is restricted to the those named
</span></span><span class="l" id="122">122 <span class="php-comment">                 * entities that XML supports. Using HTML entities would result in this error:
</span></span><span class="l" id="123">123 <span class="php-comment">                 *     XML Parsing Error: undefined entity
</span></span><span class="l" id="124">124 <span class="php-comment">                 */</span>
</span><span class="l" id="125">125                 <span class="php-keyword1">static</span> <span class="php-var">$entityMap</span> = [
</span><span class="l" id="126">126                     <span class="php-num">34</span> =&gt; <span class="php-quote">'quot'</span>, <span class="php-comment">/* quotation mark */</span>
</span><span class="l" id="127">127                     <span class="php-num">38</span> =&gt; <span class="php-quote">'amp'</span>,  <span class="php-comment">/* ampersand */</span>
</span><span class="l" id="128">128                     <span class="php-num">60</span> =&gt; <span class="php-quote">'lt'</span>,   <span class="php-comment">/* less-than sign */</span>
</span><span class="l" id="129">129                     <span class="php-num">62</span> =&gt; <span class="php-quote">'gt'</span>,   <span class="php-comment">/* greater-than sign */</span>
</span><span class="l" id="130">130                 ];
</span><span class="l" id="131">131 
</span><span class="l" id="132">132                 <span class="php-var">$chr</span> = <span class="php-var">$matches</span>[<span class="php-num">0</span>];
</span><span class="l" id="133">133                 <span class="php-var">$ord</span> = <span class="php-keyword2">ord</span>(<span class="php-var">$chr</span>);
</span><span class="l" id="134">134 
</span><span class="l" id="135">135                 <span class="php-comment">/*
</span></span><span class="l" id="136">136 <span class="php-comment">                 * The following replaces characters undefined in HTML with the
</span></span><span class="l" id="137">137 <span class="php-comment">                 * hex entity for the Unicode replacement character.
</span></span><span class="l" id="138">138 <span class="php-comment">                 */</span>
</span><span class="l" id="139">139                 <span class="php-keyword1">if</span> ((<span class="php-var">$ord</span> &lt;= <span class="php-num">0x1f</span> &amp;&amp; <span class="php-var">$chr</span> != <span class="php-quote">"\t"</span> &amp;&amp; <span class="php-var">$chr</span> != <span class="php-quote">"\n"</span> &amp;&amp; <span class="php-var">$chr</span> != <span class="php-quote">"\r"</span>) || (<span class="php-var">$ord</span> &gt;= <span class="php-num">0x7f</span> &amp;&amp; <span class="php-var">$ord</span> &lt;= <span class="php-num">0x9f</span>)) {
</span><span class="l" id="140">140                     <span class="php-keyword1">return</span> <span class="php-quote">'&amp;#xFFFD;'</span>;
</span><span class="l" id="141">141                 }
</span><span class="l" id="142">142 
</span><span class="l" id="143">143                 <span class="php-comment">/*
</span></span><span class="l" id="144">144 <span class="php-comment">                 * Check if the current character to escape has a name entity we should
</span></span><span class="l" id="145">145 <span class="php-comment">                 * replace it with while grabbing the hex string of the character.
</span></span><span class="l" id="146">146 <span class="php-comment">                 */</span>
</span><span class="l" id="147">147                 <span class="php-keyword1">if</span> (<span class="php-keyword2">strlen</span>(<span class="php-var">$chr</span>) == <span class="php-num">1</span>) {
</span><span class="l" id="148">148                     <span class="php-var">$hex</span> = <span class="php-keyword2">strtoupper</span>(<span class="php-keyword2">substr</span>(<span class="php-quote">'00'</span>.<span class="php-keyword2">bin2hex</span>(<span class="php-var">$chr</span>), -<span class="php-num">2</span>));
</span><span class="l" id="149">149                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="150">150                     <span class="php-var">$chr</span> = <span class="php-keyword2">mb_convert_encoding</span>(<span class="php-var">$chr</span>, <span class="php-quote">'UTF-16BE'</span>, <span class="php-quote">'UTF-8'</span>);
</span><span class="l" id="151">151                     <span class="php-var">$hex</span> = <span class="php-keyword2">strtoupper</span>(<span class="php-keyword2">substr</span>(<span class="php-quote">'0000'</span>.<span class="php-keyword2">bin2hex</span>(<span class="php-var">$chr</span>), -<span class="php-num">4</span>));
</span><span class="l" id="152">152                 }
</span><span class="l" id="153">153 
</span><span class="l" id="154">154                 <span class="php-var">$int</span> = <span class="php-keyword2">hexdec</span>(<span class="php-var">$hex</span>);
</span><span class="l" id="155">155                 <span class="php-keyword1">if</span> (<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$int</span>, <span class="php-var">$entityMap</span>)) {
</span><span class="l" id="156">156                     <span class="php-keyword1">return</span> <span class="php-keyword2">sprintf</span>(<span class="php-quote">'&amp;%s;'</span>, <span class="php-var">$entityMap</span>[<span class="php-var">$int</span>]);
</span><span class="l" id="157">157                 }
</span><span class="l" id="158">158 
</span><span class="l" id="159">159                 <span class="php-comment">/*
</span></span><span class="l" id="160">160 <span class="php-comment">                 * Per OWASP recommendations, we'll use hex entities for any other
</span></span><span class="l" id="161">161 <span class="php-comment">                 * characters where a named entity does not exist.
</span></span><span class="l" id="162">162 <span class="php-comment">                 */</span>
</span><span class="l" id="163">163                 <span class="php-keyword1">return</span> <span class="php-keyword2">sprintf</span>(<span class="php-quote">'&amp;#x%s;'</span>, <span class="php-var">$hex</span>);
</span><span class="l" id="164">164             }, <span class="php-var">$string</span>);
</span><span class="l" id="165">165 
</span><span class="l" id="166">166             <span class="php-keyword1">return</span> <span class="php-var">$string</span>;
</span><span class="l" id="167">167 
</span><span class="l" id="168">168         <span class="php-keyword1">case</span> <span class="php-quote">'url'</span>:
</span><span class="l" id="169">169             <span class="php-keyword1">return</span> <span class="php-keyword2">rawurlencode</span>(<span class="php-var">$string</span>);
</span><span class="l" id="170">170 
</span><span class="l" id="171">171         <span class="php-keyword1">default</span>:
</span><span class="l" id="172">172             <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> InvalidArgumentException(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Invalid escaping strategy "%s" (valid ones: "html", "html_attr", "css", "js", "url").'</span>, <span class="php-var">$strategy</span>));
</span><span class="l" id="173">173     }
</span><span class="l" id="174">174 }
</span><span class="l" id="175">175 </span></code></pre>
 </body>
</html>
