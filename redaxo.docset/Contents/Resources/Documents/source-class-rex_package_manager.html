<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Manager class for packages.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @package redaxo\core
</span></span><span class="l" id="7">  7 <span class="php-comment"> */</span>
</span><span class="l" id="8">  8 <span class="php-keyword1">abstract</span> <span class="php-keyword1">class</span> rex_package_manager
</span><span class="l" id="9">  9 {
</span><span class="l" id="10"> 10     <span class="php-keyword1">use</span> rex_factory_trait;
</span><span class="l" id="11"> 11 
</span><span class="l" id="12"> 12     <span class="php-comment">/**
</span></span><span class="l" id="13"> 13 <span class="php-comment">     * @var rex_package
</span></span><span class="l" id="14"> 14 <span class="php-comment">     */</span>
</span><span class="l" id="15"> 15     <span class="php-keyword1">protected</span> <span class="php-var">$package</span>;
</span><span class="l" id="16"> 16 
</span><span class="l" id="17"> 17     <span class="php-keyword1">protected</span> <span class="php-var">$generatePackageOrder</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="18"> 18 
</span><span class="l" id="19"> 19     <span class="php-keyword1">protected</span> <span class="php-var">$message</span>;
</span><span class="l" id="20"> 20 
</span><span class="l" id="21"> 21     <span class="php-keyword1">private</span> <span class="php-var">$i18nPrefix</span>;
</span><span class="l" id="22"> 22 
</span><span class="l" id="23"> 23     <span class="php-comment">/**
</span></span><span class="l" id="24"> 24 <span class="php-comment">     * Constructor.
</span></span><span class="l" id="25"> 25 <span class="php-comment">     *
</span></span><span class="l" id="26"> 26 <span class="php-comment">     * @param rex_package $package    Package
</span></span><span class="l" id="27"> 27 <span class="php-comment">     * @param string      $i18nPrefix Prefix for i18n
</span></span><span class="l" id="28"> 28 <span class="php-comment">     */</span>
</span><span class="l" id="29"> 29     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> __construct(rex_package <span class="php-var">$package</span>, <span class="php-var">$i18nPrefix</span>)
</span><span class="l" id="30"> 30     {
</span><span class="l" id="31"> 31         <span class="php-var">$this</span>-&gt;package = <span class="php-var">$package</span>;
</span><span class="l" id="32"> 32         <span class="php-var">$this</span>-&gt;i18nPrefix = <span class="php-var">$i18nPrefix</span>;
</span><span class="l" id="33"> 33     }
</span><span class="l" id="34"> 34 
</span><span class="l" id="35"> 35     <span class="php-comment">/**
</span></span><span class="l" id="36"> 36 <span class="php-comment">     * Creates the manager for the package.
</span></span><span class="l" id="37"> 37 <span class="php-comment">     *
</span></span><span class="l" id="38"> 38 <span class="php-comment">     * @param rex_package $package Package
</span></span><span class="l" id="39"> 39 <span class="php-comment">     *
</span></span><span class="l" id="40"> 40 <span class="php-comment">     * @return static
</span></span><span class="l" id="41"> 41 <span class="php-comment">     */</span>
</span><span class="l" id="42"> 42     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> factory(rex_package <span class="php-var">$package</span>)
</span><span class="l" id="43"> 43     {
</span><span class="l" id="44"> 44         <span class="php-keyword1">if</span> (<span class="php-keyword2">get_called_class</span>() == __CLASS__) {
</span><span class="l" id="45"> 45             <span class="php-var">$class</span> = <span class="php-var">$package</span> <span class="php-keyword1">instanceof</span> rex_plugin ? <span class="php-quote">'rex_plugin_manager'</span> : <span class="php-quote">'rex_addon_manager'</span>;
</span><span class="l" id="46"> 46             <span class="php-keyword1">return</span> <span class="php-var">$class</span>::factory(<span class="php-var">$package</span>);
</span><span class="l" id="47"> 47         }
</span><span class="l" id="48"> 48         <span class="php-var">$class</span> = <span class="php-keyword1">static</span>::getFactoryClass();
</span><span class="l" id="49"> 49         <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> <span class="php-var">$class</span>(<span class="php-var">$package</span>);
</span><span class="l" id="50"> 50     }
</span><span class="l" id="51"> 51 
</span><span class="l" id="52"> 52     <span class="php-comment">/**
</span></span><span class="l" id="53"> 53 <span class="php-comment">     * Returns the message.
</span></span><span class="l" id="54"> 54 <span class="php-comment">     *
</span></span><span class="l" id="55"> 55 <span class="php-comment">     * @return string
</span></span><span class="l" id="56"> 56 <span class="php-comment">     */</span>
</span><span class="l" id="57"> 57     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getMessage()
</span><span class="l" id="58"> 58     {
</span><span class="l" id="59"> 59         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="60"> 60     }
</span><span class="l" id="61"> 61 
</span><span class="l" id="62"> 62     <span class="php-comment">/**
</span></span><span class="l" id="63"> 63 <span class="php-comment">     * Installs a package.
</span></span><span class="l" id="64"> 64 <span class="php-comment">     *
</span></span><span class="l" id="65"> 65 <span class="php-comment">     * @param bool $installDump When TRUE, the sql dump will be importet
</span></span><span class="l" id="66"> 66 <span class="php-comment">     *
</span></span><span class="l" id="67"> 67 <span class="php-comment">     * @throws rex_functional_exception
</span></span><span class="l" id="68"> 68 <span class="php-comment">     *
</span></span><span class="l" id="69"> 69 <span class="php-comment">     * @return bool TRUE on success, FALSE on error
</span></span><span class="l" id="70"> 70 <span class="php-comment">     */</span>
</span><span class="l" id="71"> 71     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> install(<span class="php-var">$installDump</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="72"> 72     {
</span><span class="l" id="73"> 73         <span class="php-keyword1">try</span> {
</span><span class="l" id="74"> 74             <span class="php-comment">// check package directory perms</span>
</span><span class="l" id="75"> 75             <span class="php-var">$install_dir</span> = <span class="php-var">$this</span>-&gt;package-&gt;getPath();
</span><span class="l" id="76"> 76             <span class="php-keyword1">if</span> (!rex_dir::isWritable(<span class="php-var">$install_dir</span>)) {
</span><span class="l" id="77"> 77                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'dir_not_writable'</span>, <span class="php-var">$install_dir</span>));
</span><span class="l" id="78"> 78             }
</span><span class="l" id="79"> 79 
</span><span class="l" id="80"> 80             <span class="php-comment">// check package.yml</span>
</span><span class="l" id="81"> 81             <span class="php-var">$packageFile</span> = <span class="php-var">$this</span>-&gt;package-&gt;getPath(rex_package::FILE_PACKAGE);
</span><span class="l" id="82"> 82             <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_readable</span>(<span class="php-var">$packageFile</span>)) {
</span><span class="l" id="83"> 83                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'missing_yml_file'</span>));
</span><span class="l" id="84"> 84             }
</span><span class="l" id="85"> 85             <span class="php-keyword1">try</span> {
</span><span class="l" id="86"> 86                 rex_file::getConfig(<span class="php-var">$packageFile</span>);
</span><span class="l" id="87"> 87             } <span class="php-keyword1">catch</span> (rex_yaml_parse_exception <span class="php-var">$e</span>) {
</span><span class="l" id="88"> 88                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'invalid_yml_file'</span>) . <span class="php-quote">' '</span> . <span class="php-var">$e</span>-&gt;getMessage());
</span><span class="l" id="89"> 89             }
</span><span class="l" id="90"> 90             <span class="php-var">$packageId</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'package'</span>);
</span><span class="l" id="91"> 91             <span class="php-keyword1">if</span> (<span class="php-var">$packageId</span> === <span class="php-keyword1">null</span>) {
</span><span class="l" id="92"> 92                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'missing_id'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getPackageId()));
</span><span class="l" id="93"> 93             }
</span><span class="l" id="94"> 94             <span class="php-keyword1">if</span> (<span class="php-var">$packageId</span> != <span class="php-var">$this</span>-&gt;package-&gt;getPackageId()) {
</span><span class="l" id="95"> 95                 <span class="php-var">$parts</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'/'</span>, <span class="php-var">$packageId</span>, <span class="php-num">2</span>);
</span><span class="l" id="96"> 96                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;wrongPackageId(<span class="php-var">$parts</span>[<span class="php-num">0</span>], <span class="php-keyword1">isset</span>(<span class="php-var">$parts</span>[<span class="php-num">1</span>]) ? <span class="php-var">$parts</span>[<span class="php-num">1</span>] : <span class="php-keyword1">null</span>));
</span><span class="l" id="97"> 97             }
</span><span class="l" id="98"> 98             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;package-&gt;getVersion() === <span class="php-keyword1">null</span>) {
</span><span class="l" id="99"> 99                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'missing_version'</span>));
</span><span class="l" id="100">100             }
</span><span class="l" id="101">101 
</span><span class="l" id="102">102             <span class="php-comment">// check requirements and conflicts</span>
</span><span class="l" id="103">103             <span class="php-var">$message</span> = <span class="php-quote">''</span>;
</span><span class="l" id="104">104             <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;checkRequirements()) {
</span><span class="l" id="105">105                 <span class="php-var">$message</span> = <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="106">106             }
</span><span class="l" id="107">107             <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;checkConflicts()) {
</span><span class="l" id="108">108                 <span class="php-var">$message</span> .= <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="109">109             }
</span><span class="l" id="110">110             <span class="php-keyword1">if</span> (<span class="php-var">$message</span>) {
</span><span class="l" id="111">111                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$message</span>);
</span><span class="l" id="112">112             }
</span><span class="l" id="113">113 
</span><span class="l" id="114">114             <span class="php-var">$reinstall</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'install'</span>);
</span><span class="l" id="115">115             <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'install'</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="116">116 
</span><span class="l" id="117">117             rex_autoload::addDirectory(<span class="php-var">$this</span>-&gt;package-&gt;getPath(<span class="php-quote">'lib'</span>));
</span><span class="l" id="118">118             rex_autoload::addDirectory(<span class="php-var">$this</span>-&gt;package-&gt;getPath(<span class="php-quote">'vendor'</span>));
</span><span class="l" id="119">119             rex_i18n::addDirectory(<span class="php-var">$this</span>-&gt;package-&gt;getPath(<span class="php-quote">'lang'</span>));
</span><span class="l" id="120">120 
</span><span class="l" id="121">121             <span class="php-comment">// include install.php</span>
</span><span class="l" id="122">122             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_readable</span>(<span class="php-var">$this</span>-&gt;package-&gt;getPath(rex_package::FILE_INSTALL))) {
</span><span class="l" id="123">123                 <span class="php-var">$this</span>-&gt;package-&gt;includeFile(rex_package::FILE_INSTALL);
</span><span class="l" id="124">124 
</span><span class="l" id="125">125                 <span class="php-keyword1">if</span> ((<span class="php-var">$instmsg</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'installmsg'</span>, <span class="php-quote">''</span>)) != <span class="php-quote">''</span>) {
</span><span class="l" id="126">126                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$instmsg</span>);
</span><span class="l" id="127">127                 }
</span><span class="l" id="128">128                 <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;package-&gt;isInstalled()) {
</span><span class="l" id="129">129                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'no_reason'</span>));
</span><span class="l" id="130">130                 }
</span><span class="l" id="131">131             }
</span><span class="l" id="132">132 
</span><span class="l" id="133">133             <span class="php-comment">// import install.sql</span>
</span><span class="l" id="134">134             <span class="php-var">$installSql</span> = <span class="php-var">$this</span>-&gt;package-&gt;getPath(rex_package::FILE_INSTALL_SQL);
</span><span class="l" id="135">135             <span class="php-keyword1">if</span> (<span class="php-var">$installDump</span> === <span class="php-keyword1">true</span> &amp;&amp; <span class="php-keyword2">is_readable</span>(<span class="php-var">$installSql</span>)) {
</span><span class="l" id="136">136                 rex_sql_util::importDump(<span class="php-var">$installSql</span>);
</span><span class="l" id="137">137             }
</span><span class="l" id="138">138 
</span><span class="l" id="139">139             <span class="php-keyword1">if</span> (!<span class="php-var">$reinstall</span>) {
</span><span class="l" id="140">140                 <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'status'</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="141">141             }
</span><span class="l" id="142">142             <span class="php-var">$this</span>-&gt;saveConfig();
</span><span class="l" id="143">143             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;generatePackageOrder) {
</span><span class="l" id="144">144                 self::generatePackageOrder();
</span><span class="l" id="145">145             }
</span><span class="l" id="146">146 
</span><span class="l" id="147">147             <span class="php-comment">// copy assets</span>
</span><span class="l" id="148">148             <span class="php-var">$assets</span> = <span class="php-var">$this</span>-&gt;package-&gt;getPath(<span class="php-quote">'assets'</span>);
</span><span class="l" id="149">149             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_dir</span>(<span class="php-var">$assets</span>)) {
</span><span class="l" id="150">150                 <span class="php-keyword1">if</span> (!rex_dir::<span class="php-keyword2">copy</span>(<span class="php-var">$assets</span>, <span class="php-var">$this</span>-&gt;package-&gt;getAssetsPath())) {
</span><span class="l" id="151">151                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'install_cant_copy_files'</span>));
</span><span class="l" id="152">152                 }
</span><span class="l" id="153">153             }
</span><span class="l" id="154">154 
</span><span class="l" id="155">155             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-var">$reinstall</span> ? <span class="php-quote">'reinstalled'</span> : <span class="php-quote">'installed'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName());
</span><span class="l" id="156">156 
</span><span class="l" id="157">157             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="158">158         } <span class="php-keyword1">catch</span> (rex_functional_exception <span class="php-var">$e</span>) {
</span><span class="l" id="159">159             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$e</span>-&gt;getMessage();
</span><span class="l" id="160">160         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="161">161             <span class="php-var">$this</span>-&gt;message = <span class="php-quote">'SQL error: '</span> . <span class="php-var">$e</span>-&gt;getMessage();
</span><span class="l" id="162">162         }
</span><span class="l" id="163">163 
</span><span class="l" id="164">164         <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'install'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="165">165         <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'no_install'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName()) . <span class="php-quote">'&lt;br /&gt;'</span> . <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="166">166 
</span><span class="l" id="167">167         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="168">168     }
</span><span class="l" id="169">169 
</span><span class="l" id="170">170     <span class="php-comment">/**
</span></span><span class="l" id="171">171 <span class="php-comment">     * Uninstalls a package.
</span></span><span class="l" id="172">172 <span class="php-comment">     *
</span></span><span class="l" id="173">173 <span class="php-comment">     * @param bool $installDump When TRUE, the sql dump will be importet
</span></span><span class="l" id="174">174 <span class="php-comment">     *
</span></span><span class="l" id="175">175 <span class="php-comment">     * @throws rex_functional_exception
</span></span><span class="l" id="176">176 <span class="php-comment">     *
</span></span><span class="l" id="177">177 <span class="php-comment">     * @return bool TRUE on success, FALSE on error
</span></span><span class="l" id="178">178 <span class="php-comment">     */</span>
</span><span class="l" id="179">179     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> uninstall(<span class="php-var">$installDump</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="180">180     {
</span><span class="l" id="181">181         <span class="php-var">$isActivated</span> = <span class="php-var">$this</span>-&gt;package-&gt;isAvailable();
</span><span class="l" id="182">182         <span class="php-keyword1">if</span> (<span class="php-var">$isActivated</span> &amp;&amp; !<span class="php-var">$this</span>-&gt;deactivate()) {
</span><span class="l" id="183">183             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="184">184         }
</span><span class="l" id="185">185 
</span><span class="l" id="186">186         <span class="php-keyword1">try</span> {
</span><span class="l" id="187">187             <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'install'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="188">188 
</span><span class="l" id="189">189             <span class="php-comment">// include uninstall.php</span>
</span><span class="l" id="190">190             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_readable</span>(<span class="php-var">$this</span>-&gt;package-&gt;getPath(rex_package::FILE_UNINSTALL))) {
</span><span class="l" id="191">191                 <span class="php-keyword1">if</span> (!<span class="php-var">$isActivated</span>) {
</span><span class="l" id="192">192                     rex_i18n::addDirectory(<span class="php-var">$this</span>-&gt;package-&gt;getPath(<span class="php-quote">'lang'</span>));
</span><span class="l" id="193">193                 }
</span><span class="l" id="194">194 
</span><span class="l" id="195">195                 <span class="php-var">$this</span>-&gt;package-&gt;includeFile(rex_package::FILE_UNINSTALL);
</span><span class="l" id="196">196 
</span><span class="l" id="197">197                 <span class="php-keyword1">if</span> ((<span class="php-var">$instmsg</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'installmsg'</span>, <span class="php-quote">''</span>)) != <span class="php-quote">''</span>) {
</span><span class="l" id="198">198                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$instmsg</span>);
</span><span class="l" id="199">199                 }
</span><span class="l" id="200">200                 <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;package-&gt;isInstalled()) {
</span><span class="l" id="201">201                     <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'no_reason'</span>));
</span><span class="l" id="202">202                 }
</span><span class="l" id="203">203             }
</span><span class="l" id="204">204 
</span><span class="l" id="205">205             <span class="php-comment">// import uninstall.sql</span>
</span><span class="l" id="206">206             <span class="php-var">$uninstallSql</span> = <span class="php-var">$this</span>-&gt;package-&gt;getPath(rex_package::FILE_UNINSTALL_SQL);
</span><span class="l" id="207">207             <span class="php-keyword1">if</span> (<span class="php-var">$installDump</span> === <span class="php-keyword1">true</span> &amp;&amp; <span class="php-keyword2">is_readable</span>(<span class="php-var">$uninstallSql</span>)) {
</span><span class="l" id="208">208                 rex_sql_util::importDump(<span class="php-var">$uninstallSql</span>);
</span><span class="l" id="209">209             }
</span><span class="l" id="210">210 
</span><span class="l" id="211">211             <span class="php-comment">// delete assets</span>
</span><span class="l" id="212">212             <span class="php-var">$assets</span> = <span class="php-var">$this</span>-&gt;package-&gt;getAssetsPath();
</span><span class="l" id="213">213             <span class="php-keyword1">if</span> (<span class="php-keyword2">is_dir</span>(<span class="php-var">$assets</span>) &amp;&amp; !rex_dir::<span class="php-keyword2">delete</span>(<span class="php-var">$assets</span>)) {
</span><span class="l" id="214">214                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_functional_exception(<span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'install_cant_delete_files'</span>));
</span><span class="l" id="215">215             }
</span><span class="l" id="216">216 
</span><span class="l" id="217">217             <span class="php-comment">// clear cache of package</span>
</span><span class="l" id="218">218             <span class="php-var">$this</span>-&gt;package-&gt;clearCache();
</span><span class="l" id="219">219 
</span><span class="l" id="220">220             rex_config::removeNamespace(<span class="php-var">$this</span>-&gt;package-&gt;getPackageId());
</span><span class="l" id="221">221 
</span><span class="l" id="222">222             <span class="php-var">$this</span>-&gt;saveConfig();
</span><span class="l" id="223">223             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'uninstalled'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName());
</span><span class="l" id="224">224 
</span><span class="l" id="225">225             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="226">226         } <span class="php-keyword1">catch</span> (rex_functional_exception <span class="php-var">$e</span>) {
</span><span class="l" id="227">227             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$e</span>-&gt;getMessage();
</span><span class="l" id="228">228         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="229">229             <span class="php-var">$this</span>-&gt;message = <span class="php-quote">'SQL error: '</span> . <span class="php-var">$e</span>-&gt;getMessage();
</span><span class="l" id="230">230         }
</span><span class="l" id="231">231 
</span><span class="l" id="232">232         <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'install'</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="233">233         <span class="php-keyword1">if</span> (<span class="php-var">$isActivated</span>) {
</span><span class="l" id="234">234             <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'status'</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="235">235         }
</span><span class="l" id="236">236         <span class="php-var">$this</span>-&gt;saveConfig();
</span><span class="l" id="237">237         <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'no_uninstall'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName()) . <span class="php-quote">'&lt;br /&gt;'</span> . <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="238">238 
</span><span class="l" id="239">239         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="240">240     }
</span><span class="l" id="241">241 
</span><span class="l" id="242">242     <span class="php-comment">/**
</span></span><span class="l" id="243">243 <span class="php-comment">     * Activates a package.
</span></span><span class="l" id="244">244 <span class="php-comment">     *
</span></span><span class="l" id="245">245 <span class="php-comment">     * @return bool TRUE on success, FALSE on error
</span></span><span class="l" id="246">246 <span class="php-comment">     */</span>
</span><span class="l" id="247">247     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> activate()
</span><span class="l" id="248">248     {
</span><span class="l" id="249">249         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;package-&gt;isInstalled()) {
</span><span class="l" id="250">250             <span class="php-var">$state</span> = <span class="php-quote">''</span>;
</span><span class="l" id="251">251             <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;checkRequirements()) {
</span><span class="l" id="252">252                 <span class="php-var">$state</span> .= <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="253">253             }
</span><span class="l" id="254">254             <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;checkConflicts()) {
</span><span class="l" id="255">255                 <span class="php-var">$state</span> .= <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="256">256             }
</span><span class="l" id="257">257             <span class="php-var">$state</span> = <span class="php-var">$state</span> ?: <span class="php-keyword1">true</span>;
</span><span class="l" id="258">258 
</span><span class="l" id="259">259             <span class="php-keyword1">if</span> (<span class="php-var">$state</span> === <span class="php-keyword1">true</span>) {
</span><span class="l" id="260">260                 <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'status'</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="261">261                 <span class="php-var">$this</span>-&gt;saveConfig();
</span><span class="l" id="262">262             }
</span><span class="l" id="263">263             <span class="php-keyword1">if</span> (<span class="php-var">$state</span> === <span class="php-keyword1">true</span> &amp;&amp; <span class="php-var">$this</span>-&gt;generatePackageOrder) {
</span><span class="l" id="264">264                 self::generatePackageOrder();
</span><span class="l" id="265">265             }
</span><span class="l" id="266">266         } <span class="php-keyword1">else</span> {
</span><span class="l" id="267">267             <span class="php-var">$state</span> = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'not_installed'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName());
</span><span class="l" id="268">268         }
</span><span class="l" id="269">269 
</span><span class="l" id="270">270         <span class="php-keyword1">if</span> (<span class="php-var">$state</span> !== <span class="php-keyword1">true</span>) {
</span><span class="l" id="271">271             <span class="php-comment">// error while config generation, rollback addon status</span>
</span><span class="l" id="272">272             <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'status'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="273">273             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'no_activation'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName()) . <span class="php-quote">'&lt;br /&gt;'</span> . <span class="php-var">$state</span>;
</span><span class="l" id="274">274             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="275">275         }
</span><span class="l" id="276">276 
</span><span class="l" id="277">277         <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'activated'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName());
</span><span class="l" id="278">278         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="279">279     }
</span><span class="l" id="280">280 
</span><span class="l" id="281">281     <span class="php-comment">/**
</span></span><span class="l" id="282">282 <span class="php-comment">     * Deactivates a package.
</span></span><span class="l" id="283">283 <span class="php-comment">     *
</span></span><span class="l" id="284">284 <span class="php-comment">     * @return bool TRUE on success, FALSE on error
</span></span><span class="l" id="285">285 <span class="php-comment">     */</span>
</span><span class="l" id="286">286     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> deactivate()
</span><span class="l" id="287">287     {
</span><span class="l" id="288">288         <span class="php-var">$state</span> = <span class="php-var">$this</span>-&gt;checkDependencies();
</span><span class="l" id="289">289 
</span><span class="l" id="290">290         <span class="php-keyword1">if</span> (<span class="php-var">$state</span> === <span class="php-keyword1">true</span>) {
</span><span class="l" id="291">291             <span class="php-var">$this</span>-&gt;package-&gt;setProperty(<span class="php-quote">'status'</span>, <span class="php-keyword1">false</span>);
</span><span class="l" id="292">292             <span class="php-var">$this</span>-&gt;saveConfig();
</span><span class="l" id="293">293 
</span><span class="l" id="294">294             <span class="php-comment">// clear cache of package</span>
</span><span class="l" id="295">295             <span class="php-var">$this</span>-&gt;package-&gt;clearCache();
</span><span class="l" id="296">296 
</span><span class="l" id="297">297             <span class="php-comment">// reload autoload cache when addon is deactivated,</span>
</span><span class="l" id="298">298             <span class="php-comment">// so the index doesn't contain outdated class definitions</span>
</span><span class="l" id="299">299             rex_autoload::removeCache();
</span><span class="l" id="300">300 
</span><span class="l" id="301">301             <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;generatePackageOrder) {
</span><span class="l" id="302">302                 self::generatePackageOrder();
</span><span class="l" id="303">303             }
</span><span class="l" id="304">304 
</span><span class="l" id="305">305             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'deactivated'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName());
</span><span class="l" id="306">306             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="307">307         }
</span><span class="l" id="308">308 
</span><span class="l" id="309">309         <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'no_deactivation'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName()) . <span class="php-quote">'&lt;br /&gt;'</span> . <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="310">310         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="311">311     }
</span><span class="l" id="312">312 
</span><span class="l" id="313">313     <span class="php-comment">/**
</span></span><span class="l" id="314">314 <span class="php-comment">     * Deletes a package.
</span></span><span class="l" id="315">315 <span class="php-comment">     *
</span></span><span class="l" id="316">316 <span class="php-comment">     * @return bool TRUE on success, FALSE on error
</span></span><span class="l" id="317">317 <span class="php-comment">     */</span>
</span><span class="l" id="318">318     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">delete</span>()
</span><span class="l" id="319">319     {
</span><span class="l" id="320">320         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;package-&gt;isSystemPackage()) {
</span><span class="l" id="321">321             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'systempackage_delete_not_allowed'</span>);
</span><span class="l" id="322">322             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="323">323         }
</span><span class="l" id="324">324         <span class="php-var">$state</span> = <span class="php-var">$this</span>-&gt;_delete();
</span><span class="l" id="325">325         self::synchronizeWithFileSystem();
</span><span class="l" id="326">326         <span class="php-keyword1">return</span> <span class="php-var">$state</span>;
</span><span class="l" id="327">327     }
</span><span class="l" id="328">328 
</span><span class="l" id="329">329     <span class="php-comment">/**
</span></span><span class="l" id="330">330 <span class="php-comment">     * Deletes a package.
</span></span><span class="l" id="331">331 <span class="php-comment">     *
</span></span><span class="l" id="332">332 <span class="php-comment">     * @param bool $ignoreState
</span></span><span class="l" id="333">333 <span class="php-comment">     *
</span></span><span class="l" id="334">334 <span class="php-comment">     * @return bool TRUE on success, FALSE on error
</span></span><span class="l" id="335">335 <span class="php-comment">     */</span>
</span><span class="l" id="336">336     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> _delete(<span class="php-var">$ignoreState</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="337">337     {
</span><span class="l" id="338">338         <span class="php-comment">// if package is installed, uninstall it first</span>
</span><span class="l" id="339">339         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;package-&gt;isInstalled() &amp;&amp; !<span class="php-var">$this</span>-&gt;uninstall() &amp;&amp; !<span class="php-var">$ignoreState</span>) {
</span><span class="l" id="340">340             <span class="php-comment">// message is set by uninstall()</span>
</span><span class="l" id="341">341             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="342">342         }
</span><span class="l" id="343">343 
</span><span class="l" id="344">344         <span class="php-keyword1">if</span> (!rex_dir::<span class="php-keyword2">delete</span>(<span class="php-var">$this</span>-&gt;package-&gt;getPath()) &amp;&amp; !<span class="php-var">$ignoreState</span>) {
</span><span class="l" id="345">345             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'not_deleted'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName());
</span><span class="l" id="346">346             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="347">347         }
</span><span class="l" id="348">348 
</span><span class="l" id="349">349         <span class="php-keyword1">if</span> (!<span class="php-var">$ignoreState</span>) {
</span><span class="l" id="350">350             <span class="php-var">$this</span>-&gt;saveConfig();
</span><span class="l" id="351">351             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'deleted'</span>, <span class="php-var">$this</span>-&gt;package-&gt;getName());
</span><span class="l" id="352">352         }
</span><span class="l" id="353">353 
</span><span class="l" id="354">354         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="355">355     }
</span><span class="l" id="356">356 
</span><span class="l" id="357">357     <span class="php-comment">/**
</span></span><span class="l" id="358">358 <span class="php-comment">     * @param string $addonName
</span></span><span class="l" id="359">359 <span class="php-comment">     * @param string $pluginName
</span></span><span class="l" id="360">360 <span class="php-comment">     *
</span></span><span class="l" id="361">361 <span class="php-comment">     * @return string
</span></span><span class="l" id="362">362 <span class="php-comment">     */</span>
</span><span class="l" id="363">363     <span class="php-keyword1">abstract</span> <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> wrongPackageId(<span class="php-var">$addonName</span>, <span class="php-var">$pluginName</span> = <span class="php-keyword1">null</span>);
</span><span class="l" id="364">364 
</span><span class="l" id="365">365     <span class="php-comment">/**
</span></span><span class="l" id="366">366 <span class="php-comment">     * Checks whether the requirements are met.
</span></span><span class="l" id="367">367 <span class="php-comment">     *
</span></span><span class="l" id="368">368 <span class="php-comment">     * @return bool
</span></span><span class="l" id="369">369 <span class="php-comment">     */</span>
</span><span class="l" id="370">370     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> checkRequirements()
</span><span class="l" id="371">371     {
</span><span class="l" id="372">372         <span class="php-var">$requirements</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'requires'</span>, []);
</span><span class="l" id="373">373 
</span><span class="l" id="374">374         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$requirements</span>)) {
</span><span class="l" id="375">375             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'requirement_wrong_format'</span>);
</span><span class="l" id="376">376 
</span><span class="l" id="377">377             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="378">378         }
</span><span class="l" id="379">379 
</span><span class="l" id="380">380         <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;checkRedaxoRequirement(rex::getVersion())) {
</span><span class="l" id="381">381             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="382">382         }
</span><span class="l" id="383">383 
</span><span class="l" id="384">384         <span class="php-var">$state</span> = [];
</span><span class="l" id="385">385 
</span><span class="l" id="386">386         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>])) {
</span><span class="l" id="387">387             <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>])) {
</span><span class="l" id="388">388                 <span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>] = [<span class="php-quote">'version'</span> =&gt; <span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>]];
</span><span class="l" id="389">389             }
</span><span class="l" id="390">390             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>][<span class="php-quote">'version'</span>]) &amp;&amp; !self::matchVersionConstraints(PHP_VERSION, <span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>][<span class="php-quote">'version'</span>])) {
</span><span class="l" id="391">391                 <span class="php-var">$state</span>[] = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'requirement_error_php_version'</span>, PHP_VERSION, <span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>][<span class="php-quote">'version'</span>]);
</span><span class="l" id="392">392             }
</span><span class="l" id="393">393             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>][<span class="php-quote">'extensions'</span>]) &amp;&amp; <span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>][<span class="php-quote">'extensions'</span>]) {
</span><span class="l" id="394">394                 <span class="php-var">$extensions</span> = (<span class="php-keyword1">array</span>) <span class="php-var">$requirements</span>[<span class="php-quote">'php'</span>][<span class="php-quote">'extensions'</span>];
</span><span class="l" id="395">395                 <span class="php-keyword1">foreach</span> (<span class="php-var">$extensions</span> <span class="php-keyword1">as</span> <span class="php-var">$reqExt</span>) {
</span><span class="l" id="396">396                     <span class="php-keyword1">if</span> (<span class="php-keyword2">is_string</span>(<span class="php-var">$reqExt</span>) &amp;&amp; !<span class="php-keyword2">extension_loaded</span>(<span class="php-var">$reqExt</span>)) {
</span><span class="l" id="397">397                         <span class="php-var">$state</span>[] = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'requirement_error_php_extension'</span>, <span class="php-var">$reqExt</span>);
</span><span class="l" id="398">398                     }
</span><span class="l" id="399">399                 }
</span><span class="l" id="400">400             }
</span><span class="l" id="401">401         }
</span><span class="l" id="402">402 
</span><span class="l" id="403">403         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$state</span>)) {
</span><span class="l" id="404">404             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'packages'</span>]) &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'packages'</span>])) {
</span><span class="l" id="405">405                 <span class="php-keyword1">foreach</span> (<span class="php-var">$requirements</span>[<span class="php-quote">'packages'</span>] <span class="php-keyword1">as</span> <span class="php-var">$package</span> =&gt; <span class="php-var">$_</span>) {
</span><span class="l" id="406">406                     <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;checkPackageRequirement(<span class="php-var">$package</span>)) {
</span><span class="l" id="407">407                         <span class="php-var">$state</span>[] = <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="408">408                     }
</span><span class="l" id="409">409                 }
</span><span class="l" id="410">410             }
</span><span class="l" id="411">411         }
</span><span class="l" id="412">412 
</span><span class="l" id="413">413         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$state</span>)) {
</span><span class="l" id="414">414             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="415">415         }
</span><span class="l" id="416">416         <span class="php-var">$this</span>-&gt;message = <span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$state</span>);
</span><span class="l" id="417">417         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="418">418     }
</span><span class="l" id="419">419 
</span><span class="l" id="420">420     <span class="php-comment">/**
</span></span><span class="l" id="421">421 <span class="php-comment">     * Checks whether the redaxo requirement is met.
</span></span><span class="l" id="422">422 <span class="php-comment">     *
</span></span><span class="l" id="423">423 <span class="php-comment">     * @param string $redaxoVersion REDAXO version
</span></span><span class="l" id="424">424 <span class="php-comment">     *
</span></span><span class="l" id="425">425 <span class="php-comment">     * @return bool
</span></span><span class="l" id="426">426 <span class="php-comment">     */</span>
</span><span class="l" id="427">427     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> checkRedaxoRequirement(<span class="php-var">$redaxoVersion</span>)
</span><span class="l" id="428">428     {
</span><span class="l" id="429">429         <span class="php-var">$requirements</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'requires'</span>, []);
</span><span class="l" id="430">430         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'redaxo'</span>]) &amp;&amp; !self::matchVersionConstraints(<span class="php-var">$redaxoVersion</span>, <span class="php-var">$requirements</span>[<span class="php-quote">'redaxo'</span>])) {
</span><span class="l" id="431">431             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'requirement_error_redaxo_version'</span>, <span class="php-var">$redaxoVersion</span>, <span class="php-var">$requirements</span>[<span class="php-quote">'redaxo'</span>]);
</span><span class="l" id="432">432             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="433">433         }
</span><span class="l" id="434">434         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="435">435     }
</span><span class="l" id="436">436 
</span><span class="l" id="437">437     <span class="php-comment">/**
</span></span><span class="l" id="438">438 <span class="php-comment">     * Checks whether the package requirement is met.
</span></span><span class="l" id="439">439 <span class="php-comment">     *
</span></span><span class="l" id="440">440 <span class="php-comment">     * @param string $packageId Package ID
</span></span><span class="l" id="441">441 <span class="php-comment">     *
</span></span><span class="l" id="442">442 <span class="php-comment">     * @return bool
</span></span><span class="l" id="443">443 <span class="php-comment">     */</span>
</span><span class="l" id="444">444     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> checkPackageRequirement(<span class="php-var">$packageId</span>)
</span><span class="l" id="445">445     {
</span><span class="l" id="446">446         <span class="php-var">$requirements</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'requires'</span>, []);
</span><span class="l" id="447">447         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$packageId</span>])) {
</span><span class="l" id="448">448             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="449">449         }
</span><span class="l" id="450">450         <span class="php-var">$package</span> = rex_package::get(<span class="php-var">$packageId</span>);
</span><span class="l" id="451">451         <span class="php-keyword1">if</span> (!<span class="php-var">$package</span>-&gt;isAvailable()) {
</span><span class="l" id="452">452             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'requirement_error_'</span> . <span class="php-var">$package</span>-&gt;<span class="php-keyword2">getType</span>(), <span class="php-var">$packageId</span>);
</span><span class="l" id="453">453             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="454">454         }
</span><span class="l" id="455">455         <span class="php-keyword1">if</span> (!self::matchVersionConstraints(<span class="php-var">$package</span>-&gt;getVersion(), <span class="php-var">$requirements</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$packageId</span>])) {
</span><span class="l" id="456">456             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(
</span><span class="l" id="457">457                 <span class="php-quote">'requirement_error_'</span> . <span class="php-var">$package</span>-&gt;<span class="php-keyword2">getType</span>() . <span class="php-quote">'_version'</span>,
</span><span class="l" id="458">458                 <span class="php-var">$package</span>-&gt;getPackageId(),
</span><span class="l" id="459">459                 <span class="php-var">$package</span>-&gt;getVersion(),
</span><span class="l" id="460">460                 <span class="php-var">$requirements</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$packageId</span>]
</span><span class="l" id="461">461             );
</span><span class="l" id="462">462             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="463">463         }
</span><span class="l" id="464">464         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="465">465     }
</span><span class="l" id="466">466 
</span><span class="l" id="467">467     <span class="php-comment">/**
</span></span><span class="l" id="468">468 <span class="php-comment">     * Checks whether the package is in conflict with other packages.
</span></span><span class="l" id="469">469 <span class="php-comment">     *
</span></span><span class="l" id="470">470 <span class="php-comment">     * @return bool
</span></span><span class="l" id="471">471 <span class="php-comment">     */</span>
</span><span class="l" id="472">472     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> checkConflicts()
</span><span class="l" id="473">473     {
</span><span class="l" id="474">474         <span class="php-var">$state</span> = [];
</span><span class="l" id="475">475         <span class="php-var">$conflicts</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'conflicts'</span>, []);
</span><span class="l" id="476">476 
</span><span class="l" id="477">477         <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$conflicts</span>[<span class="php-quote">'packages'</span>]) &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$conflicts</span>[<span class="php-quote">'packages'</span>])) {
</span><span class="l" id="478">478             <span class="php-keyword1">foreach</span> (<span class="php-var">$conflicts</span>[<span class="php-quote">'packages'</span>] <span class="php-keyword1">as</span> <span class="php-var">$package</span> =&gt; <span class="php-var">$_</span>) {
</span><span class="l" id="479">479                 <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;checkPackageConflict(<span class="php-var">$package</span>)) {
</span><span class="l" id="480">480                     <span class="php-var">$state</span>[] = <span class="php-var">$this</span>-&gt;message;
</span><span class="l" id="481">481                 }
</span><span class="l" id="482">482             }
</span><span class="l" id="483">483         }
</span><span class="l" id="484">484 
</span><span class="l" id="485">485         <span class="php-keyword1">foreach</span> (rex_package::getAvailablePackages() <span class="php-keyword1">as</span> <span class="php-var">$package</span>) {
</span><span class="l" id="486">486             <span class="php-var">$conflicts</span> = <span class="php-var">$package</span>-&gt;getProperty(<span class="php-quote">'conflicts'</span>, []);
</span><span class="l" id="487">487 
</span><span class="l" id="488">488             <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$conflicts</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$this</span>-&gt;package-&gt;getPackageId()])) {
</span><span class="l" id="489">489                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="490">490             }
</span><span class="l" id="491">491 
</span><span class="l" id="492">492             <span class="php-var">$constraints</span> = <span class="php-var">$conflicts</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$this</span>-&gt;package-&gt;getPackageId()];
</span><span class="l" id="493">493             <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$constraints</span>) || !<span class="php-var">$constraints</span> || <span class="php-var">$constraints</span> === <span class="php-quote">'*'</span>) {
</span><span class="l" id="494">494                 <span class="php-var">$state</span>[] = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'reverse_conflict_error_'</span> . <span class="php-var">$package</span>-&gt;<span class="php-keyword2">getType</span>(), <span class="php-var">$package</span>-&gt;getPackageId());
</span><span class="l" id="495">495             } <span class="php-keyword1">elseif</span> (self::matchVersionConstraints(<span class="php-var">$this</span>-&gt;package-&gt;getVersion(), <span class="php-var">$constraints</span>)) {
</span><span class="l" id="496">496                 <span class="php-var">$state</span>[] = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'reverse_conflict_error_'</span> . <span class="php-var">$package</span>-&gt;<span class="php-keyword2">getType</span>() . <span class="php-quote">'_version'</span>, <span class="php-var">$package</span>-&gt;getPackageId(), <span class="php-var">$constraints</span>);
</span><span class="l" id="497">497             }
</span><span class="l" id="498">498         }
</span><span class="l" id="499">499 
</span><span class="l" id="500">500         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$state</span>)) {
</span><span class="l" id="501">501             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="502">502         }
</span><span class="l" id="503">503         <span class="php-var">$this</span>-&gt;message = <span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$state</span>);
</span><span class="l" id="504">504         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="505">505     }
</span><span class="l" id="506">506 
</span><span class="l" id="507">507     <span class="php-comment">/**
</span></span><span class="l" id="508">508 <span class="php-comment">     * Checks whether the package is in conflict with another package.
</span></span><span class="l" id="509">509 <span class="php-comment">     *
</span></span><span class="l" id="510">510 <span class="php-comment">     * @param string $packageId Package ID
</span></span><span class="l" id="511">511 <span class="php-comment">     *
</span></span><span class="l" id="512">512 <span class="php-comment">     * @return bool
</span></span><span class="l" id="513">513 <span class="php-comment">     */</span>
</span><span class="l" id="514">514     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> checkPackageConflict(<span class="php-var">$packageId</span>)
</span><span class="l" id="515">515     {
</span><span class="l" id="516">516         <span class="php-var">$conflicts</span> = <span class="php-var">$this</span>-&gt;package-&gt;getProperty(<span class="php-quote">'conflicts'</span>, []);
</span><span class="l" id="517">517         <span class="php-var">$package</span> = rex_package::get(<span class="php-var">$packageId</span>);
</span><span class="l" id="518">518         <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$conflicts</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$packageId</span>]) || !<span class="php-var">$package</span>-&gt;isAvailable()) {
</span><span class="l" id="519">519             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="520">520         }
</span><span class="l" id="521">521         <span class="php-var">$constraints</span> = <span class="php-var">$conflicts</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$packageId</span>];
</span><span class="l" id="522">522         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$constraints</span>) || !<span class="php-var">$constraints</span> || <span class="php-var">$constraints</span> === <span class="php-quote">'*'</span>) {
</span><span class="l" id="523">523             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'conflict_error_'</span> . <span class="php-var">$package</span>-&gt;<span class="php-keyword2">getType</span>(), <span class="php-var">$package</span>-&gt;getPackageId());
</span><span class="l" id="524">524             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="525">525         }
</span><span class="l" id="526">526         <span class="php-keyword1">if</span> (self::matchVersionConstraints(<span class="php-var">$package</span>-&gt;getVersion(), <span class="php-var">$constraints</span>)) {
</span><span class="l" id="527">527             <span class="php-var">$this</span>-&gt;message = <span class="php-var">$this</span>-&gt;i18n(<span class="php-quote">'conflict_error_'</span> . <span class="php-var">$package</span>-&gt;<span class="php-keyword2">getType</span>() . <span class="php-quote">'_version'</span>, <span class="php-var">$package</span>-&gt;getPackageId(), <span class="php-var">$constraints</span>);
</span><span class="l" id="528">528             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="529">529         }
</span><span class="l" id="530">530         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="531">531     }
</span><span class="l" id="532">532 
</span><span class="l" id="533">533     <span class="php-comment">/**
</span></span><span class="l" id="534">534 <span class="php-comment">     * Checks if another Package which is activated, depends on the given package.
</span></span><span class="l" id="535">535 <span class="php-comment">     *
</span></span><span class="l" id="536">536 <span class="php-comment">     * @return bool
</span></span><span class="l" id="537">537 <span class="php-comment">     */</span>
</span><span class="l" id="538">538     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> checkDependencies()
</span><span class="l" id="539">539     {
</span><span class="l" id="540">540         <span class="php-var">$i18nPrefix</span> = <span class="php-quote">'package_dependencies_error_'</span>;
</span><span class="l" id="541">541         <span class="php-var">$state</span> = [];
</span><span class="l" id="542">542 
</span><span class="l" id="543">543         <span class="php-keyword1">foreach</span> (rex_package::getAvailablePackages() <span class="php-keyword1">as</span> <span class="php-var">$package</span>) {
</span><span class="l" id="544">544             <span class="php-keyword1">if</span> (<span class="php-var">$package</span> === <span class="php-var">$this</span>-&gt;package || <span class="php-var">$package</span>-&gt;getAddon() === <span class="php-var">$this</span>-&gt;package) {
</span><span class="l" id="545">545                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="546">546             }
</span><span class="l" id="547">547 
</span><span class="l" id="548">548             <span class="php-var">$requirements</span> = <span class="php-var">$package</span>-&gt;getProperty(<span class="php-quote">'requires'</span>, []);
</span><span class="l" id="549">549             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$requirements</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$this</span>-&gt;package-&gt;getPackageId()])) {
</span><span class="l" id="550">550                 <span class="php-var">$state</span>[] = rex_i18n::msg(<span class="php-var">$i18nPrefix</span> . <span class="php-var">$package</span>-&gt;<span class="php-keyword2">getType</span>(), <span class="php-var">$package</span>-&gt;getPackageId());
</span><span class="l" id="551">551             }
</span><span class="l" id="552">552         }
</span><span class="l" id="553">553 
</span><span class="l" id="554">554         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$state</span>)) {
</span><span class="l" id="555">555             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="556">556         }
</span><span class="l" id="557">557         <span class="php-var">$this</span>-&gt;message = <span class="php-keyword2">implode</span>(<span class="php-quote">'&lt;br /&gt;'</span>, <span class="php-var">$state</span>);
</span><span class="l" id="558">558         <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="559">559     }
</span><span class="l" id="560">560 
</span><span class="l" id="561">561     <span class="php-comment">/**
</span></span><span class="l" id="562">562 <span class="php-comment">     * Translates the given key.
</span></span><span class="l" id="563">563 <span class="php-comment">     *
</span></span><span class="l" id="564">564 <span class="php-comment">     * @param string $key Key
</span></span><span class="l" id="565">565 <span class="php-comment">     *
</span></span><span class="l" id="566">566 <span class="php-comment">     * @return string Tranlates text
</span></span><span class="l" id="567">567 <span class="php-comment">     */</span>
</span><span class="l" id="568">568     <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> i18n(<span class="php-var">$key</span>)
</span><span class="l" id="569">569     {
</span><span class="l" id="570">570         <span class="php-var">$args</span> = <span class="php-keyword2">func_get_args</span>();
</span><span class="l" id="571">571         <span class="php-var">$key</span> = <span class="php-var">$this</span>-&gt;i18nPrefix . <span class="php-var">$args</span>[<span class="php-num">0</span>];
</span><span class="l" id="572">572         <span class="php-keyword1">if</span> (!rex_i18n::hasMsg(<span class="php-var">$key</span>)) {
</span><span class="l" id="573">573             <span class="php-var">$key</span> = <span class="php-quote">'package_'</span> . <span class="php-var">$args</span>[<span class="php-num">0</span>];
</span><span class="l" id="574">574         }
</span><span class="l" id="575">575         <span class="php-var">$args</span>[<span class="php-num">0</span>] = <span class="php-var">$key</span>;
</span><span class="l" id="576">576 
</span><span class="l" id="577">577         <span class="php-keyword1">return</span> <span class="php-keyword2">call_user_func_array</span>([<span class="php-quote">'rex_i18n'</span>, <span class="php-quote">'msg'</span>], <span class="php-var">$args</span>);
</span><span class="l" id="578">578     }
</span><span class="l" id="579">579 
</span><span class="l" id="580">580     <span class="php-comment">/**
</span></span><span class="l" id="581">581 <span class="php-comment">     * Generates the package order.
</span></span><span class="l" id="582">582 <span class="php-comment">     */</span>
</span><span class="l" id="583">583     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> generatePackageOrder()
</span><span class="l" id="584">584     {
</span><span class="l" id="585">585         <span class="php-var">$early</span> = [];
</span><span class="l" id="586">586         <span class="php-var">$normal</span> = [];
</span><span class="l" id="587">587         <span class="php-var">$late</span> = [];
</span><span class="l" id="588">588         <span class="php-var">$requires</span> = [];
</span><span class="l" id="589">589         <span class="php-var">$add</span> = <span class="php-keyword1">function</span> (<span class="php-var">$id</span>) <span class="php-keyword1">use</span> (&amp;<span class="php-var">$add</span>, &amp;<span class="php-var">$normal</span>, &amp;<span class="php-var">$requires</span>) {
</span><span class="l" id="590">590             <span class="php-var">$normal</span>[] = <span class="php-var">$id</span>;
</span><span class="l" id="591">591             <span class="php-keyword1">unset</span>(<span class="php-var">$requires</span>[<span class="php-var">$id</span>]);
</span><span class="l" id="592">592             <span class="php-keyword1">foreach</span> (<span class="php-var">$requires</span> <span class="php-keyword1">as</span> <span class="php-var">$rp</span> =&gt; &amp;<span class="php-var">$ps</span>) {
</span><span class="l" id="593">593                 <span class="php-keyword1">unset</span>(<span class="php-var">$ps</span>[<span class="php-var">$id</span>]);
</span><span class="l" id="594">594                 <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$ps</span>)) {
</span><span class="l" id="595">595                     <span class="php-var">$add</span>(<span class="php-var">$rp</span>);
</span><span class="l" id="596">596                 }
</span><span class="l" id="597">597             }
</span><span class="l" id="598">598         };
</span><span class="l" id="599">599         <span class="php-keyword1">foreach</span> (rex_package::getAvailablePackages() <span class="php-keyword1">as</span> <span class="php-var">$package</span>) {
</span><span class="l" id="600">600             <span class="php-var">$id</span> = <span class="php-var">$package</span>-&gt;getPackageId();
</span><span class="l" id="601">601             <span class="php-var">$load</span> = <span class="php-var">$package</span>-&gt;getProperty(<span class="php-quote">'load'</span>);
</span><span class="l" id="602">602             <span class="php-keyword1">if</span> (<span class="php-var">$package</span> <span class="php-keyword1">instanceof</span> rex_plugin
</span><span class="l" id="603">603                 &amp;&amp; !<span class="php-keyword2">in_array</span>(<span class="php-var">$load</span>, [<span class="php-quote">'early'</span>, <span class="php-quote">'normal'</span>, <span class="php-quote">'late'</span>])
</span><span class="l" id="604">604                 &amp;&amp; <span class="php-keyword2">in_array</span>(<span class="php-var">$addonLoad</span> = <span class="php-var">$package</span>-&gt;getAddon()-&gt;getProperty(<span class="php-quote">'load'</span>), [<span class="php-quote">'early'</span>, <span class="php-quote">'late'</span>])
</span><span class="l" id="605">605             ) {
</span><span class="l" id="606">606                 <span class="php-var">$load</span> = <span class="php-var">$addonLoad</span>;
</span><span class="l" id="607">607             }
</span><span class="l" id="608">608             <span class="php-keyword1">if</span> (<span class="php-var">$load</span> === <span class="php-quote">'early'</span>) {
</span><span class="l" id="609">609                 <span class="php-var">$early</span>[] = <span class="php-var">$id</span>;
</span><span class="l" id="610">610             } <span class="php-keyword1">elseif</span> (<span class="php-var">$load</span> === <span class="php-quote">'late'</span>) {
</span><span class="l" id="611">611                 <span class="php-var">$late</span>[] = <span class="php-var">$id</span>;
</span><span class="l" id="612">612             } <span class="php-keyword1">else</span> {
</span><span class="l" id="613">613                 <span class="php-var">$req</span> = <span class="php-var">$package</span>-&gt;getProperty(<span class="php-quote">'requires'</span>);
</span><span class="l" id="614">614                 <span class="php-keyword1">if</span> (<span class="php-var">$package</span> <span class="php-keyword1">instanceof</span> rex_plugin) {
</span><span class="l" id="615">615                     <span class="php-var">$req</span>[<span class="php-quote">'packages'</span>][<span class="php-var">$package</span>-&gt;getAddon()-&gt;getPackageId()] = <span class="php-keyword1">true</span>;
</span><span class="l" id="616">616                 }
</span><span class="l" id="617">617                 <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$req</span>[<span class="php-quote">'packages'</span>]) &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$req</span>[<span class="php-quote">'packages'</span>])) {
</span><span class="l" id="618">618                     <span class="php-keyword1">foreach</span> (<span class="php-var">$req</span>[<span class="php-quote">'packages'</span>] <span class="php-keyword1">as</span> <span class="php-var">$packageId</span> =&gt; <span class="php-var">$reqP</span>) {
</span><span class="l" id="619">619                         <span class="php-var">$package</span> = rex_package::get(<span class="php-var">$packageId</span>);
</span><span class="l" id="620">620                         <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$package</span>, <span class="php-var">$normal</span>) &amp;&amp; !<span class="php-keyword2">in_array</span>(<span class="php-var">$package</span>-&gt;getProperty(<span class="php-quote">'load'</span>), [<span class="php-quote">'early'</span>, <span class="php-quote">'late'</span>])) {
</span><span class="l" id="621">621                             <span class="php-var">$requires</span>[<span class="php-var">$id</span>][<span class="php-var">$packageId</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="622">622                         }
</span><span class="l" id="623">623                     }
</span><span class="l" id="624">624                 }
</span><span class="l" id="625">625                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$requires</span>[<span class="php-var">$id</span>])) {
</span><span class="l" id="626">626                     <span class="php-var">$add</span>(<span class="php-var">$id</span>);
</span><span class="l" id="627">627                 }
</span><span class="l" id="628">628             }
</span><span class="l" id="629">629         }
</span><span class="l" id="630">630         rex::setConfig(<span class="php-quote">'package-order'</span>, <span class="php-keyword2">array_merge</span>(<span class="php-var">$early</span>, <span class="php-var">$normal</span>, <span class="php-keyword2">array_keys</span>(<span class="php-var">$requires</span>), <span class="php-var">$late</span>));
</span><span class="l" id="631">631     }
</span><span class="l" id="632">632 
</span><span class="l" id="633">633     <span class="php-comment">/**
</span></span><span class="l" id="634">634 <span class="php-comment">     * Saves the package config.
</span></span><span class="l" id="635">635 <span class="php-comment">     */</span>
</span><span class="l" id="636">636     <span class="php-keyword1">protected</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> saveConfig()
</span><span class="l" id="637">637     {
</span><span class="l" id="638">638         <span class="php-var">$config</span> = [];
</span><span class="l" id="639">639         <span class="php-keyword1">foreach</span> (rex_addon::getRegisteredAddons() <span class="php-keyword1">as</span> <span class="php-var">$addonName</span> =&gt; <span class="php-var">$addon</span>) {
</span><span class="l" id="640">640             <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'install'</span>] = <span class="php-var">$addon</span>-&gt;isInstalled();
</span><span class="l" id="641">641             <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'status'</span>] = <span class="php-var">$addon</span>-&gt;isAvailable();
</span><span class="l" id="642">642             <span class="php-keyword1">foreach</span> (<span class="php-var">$addon</span>-&gt;getRegisteredPlugins() <span class="php-keyword1">as</span> <span class="php-var">$pluginName</span> =&gt; <span class="php-var">$plugin</span>) {
</span><span class="l" id="643">643                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>][<span class="php-var">$pluginName</span>][<span class="php-quote">'install'</span>] = <span class="php-var">$plugin</span>-&gt;isInstalled();
</span><span class="l" id="644">644                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>][<span class="php-var">$pluginName</span>][<span class="php-quote">'status'</span>] = <span class="php-var">$plugin</span>-&gt;getProperty(<span class="php-quote">'status'</span>);
</span><span class="l" id="645">645             }
</span><span class="l" id="646">646         }
</span><span class="l" id="647">647         rex::setConfig(<span class="php-quote">'package-config'</span>, <span class="php-var">$config</span>);
</span><span class="l" id="648">648     }
</span><span class="l" id="649">649 
</span><span class="l" id="650">650     <span class="php-comment">/**
</span></span><span class="l" id="651">651 <span class="php-comment">     * Synchronizes the packages with the file system.
</span></span><span class="l" id="652">652 <span class="php-comment">     */</span>
</span><span class="l" id="653">653     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> synchronizeWithFileSystem()
</span><span class="l" id="654">654     {
</span><span class="l" id="655">655         <span class="php-var">$config</span> = rex::getConfig(<span class="php-quote">'package-config'</span>);
</span><span class="l" id="656">656         <span class="php-var">$addons</span> = self::readPackageFolder(rex_path::src(<span class="php-quote">'addons'</span>));
</span><span class="l" id="657">657         <span class="php-var">$registeredAddons</span> = <span class="php-keyword2">array_keys</span>(rex_addon::getRegisteredAddons());
</span><span class="l" id="658">658         <span class="php-keyword1">foreach</span> (<span class="php-keyword2">array_diff</span>(<span class="php-var">$registeredAddons</span>, <span class="php-var">$addons</span>) <span class="php-keyword1">as</span> <span class="php-var">$addonName</span>) {
</span><span class="l" id="659">659             <span class="php-var">$manager</span> = rex_addon_manager::factory(rex_addon::get(<span class="php-var">$addonName</span>));
</span><span class="l" id="660">660             <span class="php-var">$manager</span>-&gt;_delete(<span class="php-keyword1">true</span>);
</span><span class="l" id="661">661             <span class="php-keyword1">unset</span>(<span class="php-var">$config</span>[<span class="php-var">$addonName</span>]);
</span><span class="l" id="662">662         }
</span><span class="l" id="663">663         <span class="php-keyword1">foreach</span> (<span class="php-var">$addons</span> <span class="php-keyword1">as</span> <span class="php-var">$addonName</span>) {
</span><span class="l" id="664">664             <span class="php-keyword1">if</span> (!rex_addon::exists(<span class="php-var">$addonName</span>)) {
</span><span class="l" id="665">665                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'install'</span>] = <span class="php-keyword1">false</span>;
</span><span class="l" id="666">666                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'status'</span>] = <span class="php-keyword1">false</span>;
</span><span class="l" id="667">667                 <span class="php-var">$registeredPlugins</span> = [];
</span><span class="l" id="668">668             } <span class="php-keyword1">else</span> {
</span><span class="l" id="669">669                 <span class="php-var">$addon</span> = rex_addon::get(<span class="php-var">$addonName</span>);
</span><span class="l" id="670">670                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'install'</span>] = <span class="php-var">$addon</span>-&gt;isInstalled();
</span><span class="l" id="671">671                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'status'</span>] = <span class="php-var">$addon</span>-&gt;isAvailable();
</span><span class="l" id="672">672                 <span class="php-var">$registeredPlugins</span> = <span class="php-keyword2">array_keys</span>(<span class="php-var">$addon</span>-&gt;getRegisteredPlugins());
</span><span class="l" id="673">673             }
</span><span class="l" id="674">674             <span class="php-var">$plugins</span> = self::readPackageFolder(rex_path::addon(<span class="php-var">$addonName</span>, <span class="php-quote">'plugins'</span>));
</span><span class="l" id="675">675             <span class="php-keyword1">foreach</span> (<span class="php-keyword2">array_diff</span>(<span class="php-var">$registeredPlugins</span>, <span class="php-var">$plugins</span>) <span class="php-keyword1">as</span> <span class="php-var">$pluginName</span>) {
</span><span class="l" id="676">676                 <span class="php-var">$manager</span> = rex_plugin_manager::factory(rex_plugin::get(<span class="php-var">$addonName</span>, <span class="php-var">$pluginName</span>));
</span><span class="l" id="677">677                 <span class="php-var">$manager</span>-&gt;_delete(<span class="php-keyword1">true</span>);
</span><span class="l" id="678">678                 <span class="php-keyword1">unset</span>(<span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>][<span class="php-var">$pluginName</span>]);
</span><span class="l" id="679">679             }
</span><span class="l" id="680">680             <span class="php-keyword1">foreach</span> (<span class="php-var">$plugins</span> <span class="php-keyword1">as</span> <span class="php-var">$pluginName</span>) {
</span><span class="l" id="681">681                 <span class="php-var">$plugin</span> = rex_plugin::get(<span class="php-var">$addonName</span>, <span class="php-var">$pluginName</span>);
</span><span class="l" id="682">682                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>][<span class="php-var">$pluginName</span>][<span class="php-quote">'install'</span>] = <span class="php-var">$plugin</span>-&gt;isInstalled();
</span><span class="l" id="683">683                 <span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>][<span class="php-var">$pluginName</span>][<span class="php-quote">'status'</span>] = <span class="php-var">$plugin</span>-&gt;getProperty(<span class="php-quote">'status'</span>);
</span><span class="l" id="684">684             }
</span><span class="l" id="685">685             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>]) &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>])) {
</span><span class="l" id="686">686                 <span class="php-keyword2">ksort</span>(<span class="php-var">$config</span>[<span class="php-var">$addonName</span>][<span class="php-quote">'plugins'</span>]);
</span><span class="l" id="687">687             }
</span><span class="l" id="688">688         }
</span><span class="l" id="689">689         <span class="php-keyword2">ksort</span>(<span class="php-var">$config</span>);
</span><span class="l" id="690">690 
</span><span class="l" id="691">691         rex::setConfig(<span class="php-quote">'package-config'</span>, <span class="php-var">$config</span>);
</span><span class="l" id="692">692         rex_addon::initialize();
</span><span class="l" id="693">693     }
</span><span class="l" id="694">694 
</span><span class="l" id="695">695     <span class="php-comment">/**
</span></span><span class="l" id="696">696 <span class="php-comment">     * Checks the version of the requirement.
</span></span><span class="l" id="697">697 <span class="php-comment">     *
</span></span><span class="l" id="698">698 <span class="php-comment">     * @param string $version     Version
</span></span><span class="l" id="699">699 <span class="php-comment">     * @param string $constraints Constraint list, separated by comma
</span></span><span class="l" id="700">700 <span class="php-comment">     *
</span></span><span class="l" id="701">701 <span class="php-comment">     * @throws rex_exception
</span></span><span class="l" id="702">702 <span class="php-comment">     *
</span></span><span class="l" id="703">703 <span class="php-comment">     * @return bool
</span></span><span class="l" id="704">704 <span class="php-comment">     */</span>
</span><span class="l" id="705">705     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> matchVersionConstraints(<span class="php-var">$version</span>, <span class="php-var">$constraints</span>)
</span><span class="l" id="706">706     {
</span><span class="l" id="707">707         <span class="php-var">$rawConstraints</span> = <span class="php-keyword2">array_filter</span>(<span class="php-keyword2">array_map</span>(<span class="php-quote">'trim'</span>, <span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-var">$constraints</span>)));
</span><span class="l" id="708">708         <span class="php-var">$constraints</span> = [];
</span><span class="l" id="709">709         <span class="php-keyword1">foreach</span> (<span class="php-var">$rawConstraints</span> <span class="php-keyword1">as</span> <span class="php-var">$constraint</span>) {
</span><span class="l" id="710">710             <span class="php-keyword1">if</span> (<span class="php-var">$constraint</span> === <span class="php-quote">'*'</span>) {
</span><span class="l" id="711">711                 <span class="php-keyword1">continue</span>;
</span><span class="l" id="712">712             }
</span><span class="l" id="713">713 
</span><span class="l" id="714">714             <span class="php-keyword1">if</span> (!<span class="php-keyword2">preg_match</span>(<span class="php-quote">'/^(?&lt;op&gt;==?|&lt;=?|&gt;=?|!=|~|\^|) ?(?&lt;version&gt;\d+(?:\.\d+)*)(?&lt;wildcard&gt;\.\*)?(?&lt;prerelease&gt;[ -.]?[a-z]+(?:[ -.]?\d+)?)?$/i'</span>, <span class="php-var">$constraint</span>, <span class="php-var">$match</span>)
</span><span class="l" id="715">715                 || <span class="php-keyword1">isset</span>(<span class="php-var">$match</span>[<span class="php-quote">'wildcard'</span>]) &amp;&amp; <span class="php-var">$match</span>[<span class="php-quote">'wildcard'</span>] &amp;&amp; (<span class="php-var">$match</span>[<span class="php-quote">'op'</span>] != <span class="php-quote">''</span> || <span class="php-keyword1">isset</span>(<span class="php-var">$match</span>[<span class="php-quote">'prerelease'</span>]) &amp;&amp; <span class="php-var">$match</span>[<span class="php-quote">'prerelease'</span>])
</span><span class="l" id="716">716             ) {
</span><span class="l" id="717">717                 <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> rex_exception(<span class="php-quote">'Unknown version constraint "'</span> . <span class="php-var">$constraint</span> . <span class="php-quote">'"!'</span>);
</span><span class="l" id="718">718             }
</span><span class="l" id="719">719 
</span><span class="l" id="720">720             <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$match</span>[<span class="php-quote">'wildcard'</span>]) &amp;&amp; <span class="php-var">$match</span>[<span class="php-quote">'wildcard'</span>]) {
</span><span class="l" id="721">721                 <span class="php-var">$constraints</span>[] = [<span class="php-quote">'&gt;='</span>, <span class="php-var">$match</span>[<span class="php-quote">'version'</span>]];
</span><span class="l" id="722">722                 <span class="php-var">$pos</span> = <span class="php-keyword2">strrpos</span>(<span class="php-var">$match</span>[<span class="php-quote">'version'</span>], <span class="php-quote">'.'</span>) + <span class="php-num">1</span>;
</span><span class="l" id="723">723                 <span class="php-var">$sub</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$match</span>[<span class="php-quote">'version'</span>], <span class="php-var">$pos</span>);
</span><span class="l" id="724">724                 <span class="php-var">$constraints</span>[] = [<span class="php-quote">'&lt;'</span>, <span class="php-keyword2">substr_replace</span>(<span class="php-var">$match</span>[<span class="php-quote">'version'</span>], <span class="php-var">$sub</span> + <span class="php-num">1</span>, <span class="php-var">$pos</span>)];
</span><span class="l" id="725">725             } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$match</span>[<span class="php-quote">'op'</span>], [<span class="php-quote">'~'</span>, <span class="php-quote">'^'</span>])) {
</span><span class="l" id="726">726                 <span class="php-var">$constraints</span>[] = [<span class="php-quote">'&gt;='</span>, <span class="php-var">$match</span>[<span class="php-quote">'version'</span>] . (<span class="php-keyword1">isset</span>(<span class="php-var">$match</span>[<span class="php-quote">'prerelease'</span>]) ? <span class="php-var">$match</span>[<span class="php-quote">'prerelease'</span>] : <span class="php-quote">''</span>)];
</span><span class="l" id="727">727                 <span class="php-keyword1">if</span> (<span class="php-quote">'^'</span> === <span class="php-var">$match</span>[<span class="php-quote">'op'</span>] || <span class="php-keyword1">false</span> === <span class="php-var">$pos</span> = <span class="php-keyword2">strrpos</span>(<span class="php-var">$match</span>[<span class="php-quote">'version'</span>], <span class="php-quote">'.'</span>)) {
</span><span class="l" id="728">728                     <span class="php-var">$constraints</span>[] = [<span class="php-quote">'&lt;'</span>, (int) <span class="php-var">$match</span>[<span class="php-quote">'version'</span>] + <span class="php-num">1</span>];
</span><span class="l" id="729">729                 } <span class="php-keyword1">else</span> {
</span><span class="l" id="730">730                     <span class="php-var">$main</span> = <span class="php-quote">''</span>;
</span><span class="l" id="731">731                     <span class="php-var">$sub</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$match</span>[<span class="php-quote">'version'</span>], <span class="php-num">0</span>, <span class="php-var">$pos</span>);
</span><span class="l" id="732">732                     <span class="php-keyword1">if</span> ((<span class="php-var">$pos</span> = <span class="php-keyword2">strrpos</span>(<span class="php-var">$sub</span>, <span class="php-quote">'.'</span>)) !== <span class="php-keyword1">false</span>) {
</span><span class="l" id="733">733                         <span class="php-var">$main</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$sub</span>, <span class="php-num">0</span>, <span class="php-var">$pos</span> + <span class="php-num">1</span>);
</span><span class="l" id="734">734                         <span class="php-var">$sub</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$sub</span>, <span class="php-var">$pos</span> + <span class="php-num">1</span>);
</span><span class="l" id="735">735                     }
</span><span class="l" id="736">736                     <span class="php-var">$constraints</span>[] = [<span class="php-quote">'&lt;'</span>, <span class="php-var">$main</span> . (<span class="php-var">$sub</span> + <span class="php-num">1</span>)];
</span><span class="l" id="737">737                 }
</span><span class="l" id="738">738             } <span class="php-keyword1">else</span> {
</span><span class="l" id="739">739                 <span class="php-var">$constraints</span>[] = [<span class="php-var">$match</span>[<span class="php-quote">'op'</span>] ?: <span class="php-quote">'='</span>, <span class="php-var">$match</span>[<span class="php-quote">'version'</span>] . (<span class="php-keyword1">isset</span>(<span class="php-var">$match</span>[<span class="php-quote">'prerelease'</span>]) ? <span class="php-var">$match</span>[<span class="php-quote">'prerelease'</span>] : <span class="php-quote">''</span>)];
</span><span class="l" id="740">740             }
</span><span class="l" id="741">741         }
</span><span class="l" id="742">742 
</span><span class="l" id="743">743         <span class="php-keyword1">foreach</span> (<span class="php-var">$constraints</span> <span class="php-keyword1">as</span> <span class="php-var">$constraint</span>) {
</span><span class="l" id="744">744             <span class="php-keyword1">if</span> (!rex_string::versionCompare(<span class="php-var">$version</span>, <span class="php-var">$constraint</span>[<span class="php-num">1</span>], <span class="php-var">$constraint</span>[<span class="php-num">0</span>])) {
</span><span class="l" id="745">745                 <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="746">746             }
</span><span class="l" id="747">747         }
</span><span class="l" id="748">748 
</span><span class="l" id="749">749         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="750">750     }
</span><span class="l" id="751">751 
</span><span class="l" id="752">752     <span class="php-comment">/**
</span></span><span class="l" id="753">753 <span class="php-comment">     * Returns the subfolders of the given folder.
</span></span><span class="l" id="754">754 <span class="php-comment">     *
</span></span><span class="l" id="755">755 <span class="php-comment">     * @param string $folder Folder
</span></span><span class="l" id="756">756 <span class="php-comment">     *
</span></span><span class="l" id="757">757 <span class="php-comment">     * @return string[]
</span></span><span class="l" id="758">758 <span class="php-comment">     */</span>
</span><span class="l" id="759">759     <span class="php-keyword1">private</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> readPackageFolder(<span class="php-var">$folder</span>)
</span><span class="l" id="760">760     {
</span><span class="l" id="761">761         <span class="php-var">$packages</span> = [];
</span><span class="l" id="762">762 
</span><span class="l" id="763">763         <span class="php-keyword1">if</span> (<span class="php-keyword2">is_dir</span>(<span class="php-var">$folder</span>)) {
</span><span class="l" id="764">764             <span class="php-keyword1">foreach</span> (rex_finder::factory(<span class="php-var">$folder</span>)-&gt;dirsOnly() <span class="php-keyword1">as</span> <span class="php-var">$file</span>) {
</span><span class="l" id="765">765                 <span class="php-var">$packages</span>[] = <span class="php-var">$file</span>-&gt;getBasename();
</span><span class="l" id="766">766             }
</span><span class="l" id="767">767         }
</span><span class="l" id="768">768 
</span><span class="l" id="769">769         <span class="php-keyword1">return</span> <span class="php-var">$packages</span>;
</span><span class="l" id="770">770     }
</span><span class="l" id="771">771 }
</span><span class="l" id="772">772 </span></code></pre>
 </body>
</html>
