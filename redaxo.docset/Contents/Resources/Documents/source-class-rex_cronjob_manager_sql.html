<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="utf-8"/>
  <link href="../Assets/css/styles.css" rel="stylesheet"/>
  <script src="../Assets/js/script.js">
  </script>
 </head>
 <body>
  <pre id="source"><code><span class="l" id="1">  1 <span class="xlang">&lt;?php</span>
</span><span class="l" id="2">  2 
</span><span class="l" id="3">  3 <span class="php-comment">/**
</span></span><span class="l" id="4">  4 <span class="php-comment"> * Cronjob Addon.
</span></span><span class="l" id="5">  5 <span class="php-comment"> *
</span></span><span class="l" id="6">  6 <span class="php-comment"> * @author gharlan[at]web[dot]de Gregor Harlan
</span></span><span class="l" id="7">  7 <span class="php-comment"> *
</span></span><span class="l" id="8">  8 <span class="php-comment"> * @package redaxo\cronjob
</span></span><span class="l" id="9">  9 <span class="php-comment"> */</span>
</span><span class="l" id="10"> 10 
</span><span class="l" id="11"> 11 <span class="php-keyword1">class</span> rex_cronjob_manager_sql
</span><span class="l" id="12"> 12 {
</span><span class="l" id="13"> 13     <span class="php-keyword1">private</span> <span class="php-var">$sql</span>;
</span><span class="l" id="14"> 14     <span class="php-keyword1">private</span> <span class="php-var">$manager</span>;
</span><span class="l" id="15"> 15 
</span><span class="l" id="16"> 16     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> __construct(rex_cronjob_manager <span class="php-var">$manager</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="17"> 17     {
</span><span class="l" id="18"> 18         <span class="php-var">$this</span>-&gt;sql = rex_sql::factory();
</span><span class="l" id="19"> 19         <span class="php-comment">// $this-&gt;sql-&gt;setDebug();</span>
</span><span class="l" id="20"> 20         <span class="php-var">$this</span>-&gt;manager = <span class="php-var">$manager</span>;
</span><span class="l" id="21"> 21     }
</span><span class="l" id="22"> 22 
</span><span class="l" id="23"> 23     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> factory(rex_cronjob_manager <span class="php-var">$manager</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="24"> 24     {
</span><span class="l" id="25"> 25         <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> self(<span class="php-var">$manager</span>);
</span><span class="l" id="26"> 26     }
</span><span class="l" id="27"> 27 
</span><span class="l" id="28"> 28     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getManager()
</span><span class="l" id="29"> 29     {
</span><span class="l" id="30"> 30         <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_object</span>(<span class="php-var">$this</span>-&gt;manager)) {
</span><span class="l" id="31"> 31             <span class="php-var">$this</span>-&gt;manager = rex_cronjob_manager::factory();
</span><span class="l" id="32"> 32         }
</span><span class="l" id="33"> 33         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;manager;
</span><span class="l" id="34"> 34     }
</span><span class="l" id="35"> 35 
</span><span class="l" id="36"> 36     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasManager()
</span><span class="l" id="37"> 37     {
</span><span class="l" id="38"> 38         <span class="php-keyword1">return</span> <span class="php-keyword2">is_object</span>(<span class="php-var">$this</span>-&gt;manager);
</span><span class="l" id="39"> 39     }
</span><span class="l" id="40"> 40 
</span><span class="l" id="41"> 41     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setMessage(<span class="php-var">$message</span>)
</span><span class="l" id="42"> 42     {
</span><span class="l" id="43"> 43         <span class="php-var">$this</span>-&gt;getManager()-&gt;setMessage(<span class="php-var">$message</span>);
</span><span class="l" id="44"> 44     }
</span><span class="l" id="45"> 45 
</span><span class="l" id="46"> 46     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getMessage()
</span><span class="l" id="47"> 47     {
</span><span class="l" id="48"> 48         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getManager()-&gt;getMessage();
</span><span class="l" id="49"> 49     }
</span><span class="l" id="50"> 50 
</span><span class="l" id="51"> 51     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> hasMessage()
</span><span class="l" id="52"> 52     {
</span><span class="l" id="53"> 53         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;getManager()-&gt;hasMessage();
</span><span class="l" id="54"> 54     }
</span><span class="l" id="55"> 55 
</span><span class="l" id="56"> 56     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getName(<span class="php-var">$id</span>)
</span><span class="l" id="57"> 57     {
</span><span class="l" id="58"> 58         <span class="php-var">$this</span>-&gt;sql-&gt;setQuery(<span class="php-quote">'
</span></span><span class="l" id="59"> 59 <span class="php-quote">            SELECT  name
</span></span><span class="l" id="60"> 60 <span class="php-quote">            FROM    '</span> . REX_CRONJOB_TABLE . <span class="php-quote">'
</span></span><span class="l" id="61"> 61 <span class="php-quote">            WHERE   id = ?
</span></span><span class="l" id="62"> 62 <span class="php-quote">            LIMIT   1
</span></span><span class="l" id="63"> 63 <span class="php-quote">        '</span>, [<span class="php-var">$id</span>]);
</span><span class="l" id="64"> 64         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;sql-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="65"> 65             <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;sql-&gt;getValue(<span class="php-quote">'name'</span>);
</span><span class="l" id="66"> 66         }
</span><span class="l" id="67"> 67         <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="68"> 68     }
</span><span class="l" id="69"> 69 
</span><span class="l" id="70"> 70     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setStatus(<span class="php-var">$id</span>, <span class="php-var">$status</span>)
</span><span class="l" id="71"> 71     {
</span><span class="l" id="72"> 72         <span class="php-var">$this</span>-&gt;sql-&gt;setTable(REX_CRONJOB_TABLE);
</span><span class="l" id="73"> 73         <span class="php-var">$this</span>-&gt;sql-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>]);
</span><span class="l" id="74"> 74         <span class="php-var">$this</span>-&gt;sql-&gt;setValue(<span class="php-quote">'status'</span>, <span class="php-var">$status</span>);
</span><span class="l" id="75"> 75         <span class="php-var">$this</span>-&gt;sql-&gt;addGlobalUpdateFields();
</span><span class="l" id="76"> 76         <span class="php-keyword1">try</span> {
</span><span class="l" id="77"> 77             <span class="php-var">$this</span>-&gt;sql-&gt;update();
</span><span class="l" id="78"> 78             <span class="php-var">$success</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="79"> 79         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="80"> 80             <span class="php-var">$success</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="81"> 81         }
</span><span class="l" id="82"> 82         <span class="php-var">$this</span>-&gt;saveNextTime();
</span><span class="l" id="83"> 83         <span class="php-keyword1">return</span> <span class="php-var">$success</span>;
</span><span class="l" id="84"> 84     }
</span><span class="l" id="85"> 85 
</span><span class="l" id="86"> 86     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setExecutionStart(<span class="php-var">$id</span>, <span class="php-var">$reset</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="87"> 87     {
</span><span class="l" id="88"> 88         <span class="php-var">$this</span>-&gt;sql-&gt;setTable(REX_CRONJOB_TABLE);
</span><span class="l" id="89"> 89         <span class="php-var">$this</span>-&gt;sql-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>]);
</span><span class="l" id="90"> 90         <span class="php-var">$this</span>-&gt;sql-&gt;setDateTimeValue(<span class="php-quote">'execution_start'</span>, <span class="php-var">$reset</span> ? <span class="php-num">0</span> : <span class="php-keyword2">time</span>());
</span><span class="l" id="91"> 91         <span class="php-keyword1">try</span> {
</span><span class="l" id="92"> 92             <span class="php-var">$this</span>-&gt;sql-&gt;update();
</span><span class="l" id="93"> 93             <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="94"> 94         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="95"> 95             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="96"> 96         }
</span><span class="l" id="97"> 97     }
</span><span class="l" id="98"> 98 
</span><span class="l" id="99"> 99     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">delete</span>(<span class="php-var">$id</span>)
</span><span class="l" id="100">100     {
</span><span class="l" id="101">101         <span class="php-var">$this</span>-&gt;sql-&gt;setTable(REX_CRONJOB_TABLE);
</span><span class="l" id="102">102         <span class="php-var">$this</span>-&gt;sql-&gt;setWhere([<span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>]);
</span><span class="l" id="103">103         <span class="php-keyword1">try</span> {
</span><span class="l" id="104">104             <span class="php-var">$this</span>-&gt;sql-&gt;<span class="php-keyword2">delete</span>();
</span><span class="l" id="105">105             <span class="php-var">$success</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="106">106         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="107">107             <span class="php-var">$success</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="108">108         }
</span><span class="l" id="109">109         <span class="php-var">$this</span>-&gt;saveNextTime();
</span><span class="l" id="110">110         <span class="php-keyword1">return</span> <span class="php-var">$success</span>;
</span><span class="l" id="111">111     }
</span><span class="l" id="112">112 
</span><span class="l" id="113">113     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> check()
</span><span class="l" id="114">114     {
</span><span class="l" id="115">115         <span class="php-var">$env</span> = rex_cronjob_manager::getCurrentEnvironment();
</span><span class="l" id="116">116         <span class="php-var">$script</span> = <span class="php-quote">'script'</span> === <span class="php-var">$env</span>;
</span><span class="l" id="117">117 
</span><span class="l" id="118">118         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="119">119         <span class="php-comment">// $sql-&gt;setDebug();</span>
</span><span class="l" id="120">120 
</span><span class="l" id="121">121         <span class="php-var">$query</span> = <span class="php-quote">'
</span></span><span class="l" id="122">122 <span class="php-quote">            SELECT    id, name, type, parameters, `interval`, execution_moment
</span></span><span class="l" id="123">123 <span class="php-quote">            FROM      '</span>.REX_CRONJOB_TABLE.<span class="php-quote">'
</span></span><span class="l" id="124">124 <span class="php-quote">            WHERE     status = 1
</span></span><span class="l" id="125">125 <span class="php-quote">                AND   execution_start &lt; ?
</span></span><span class="l" id="126">126 <span class="php-quote">                AND   environment LIKE ?
</span></span><span class="l" id="127">127 <span class="php-quote">                AND   nexttime &lt;= ?
</span></span><span class="l" id="128">128 <span class="php-quote">            ORDER BY  nexttime ASC, execution_moment DESC, name ASC
</span></span><span class="l" id="129">129 <span class="php-quote">        '</span>;
</span><span class="l" id="130">130 
</span><span class="l" id="131">131         <span class="php-keyword1">if</span> (<span class="php-var">$script</span>) {
</span><span class="l" id="132">132             <span class="php-var">$minExecutionStartDiff</span> = <span class="php-num">6</span> * <span class="php-num">60</span> * <span class="php-num">60</span>;
</span><span class="l" id="133">133         } <span class="php-keyword1">else</span> {
</span><span class="l" id="134">134             <span class="php-var">$query</span> .= <span class="php-quote">' LIMIT 1'</span>;
</span><span class="l" id="135">135 
</span><span class="l" id="136">136             <span class="php-var">$minExecutionStartDiff</span> = <span class="php-num">2</span> * (<span class="php-keyword2">ini_get</span>(<span class="php-quote">'max_execution_time'</span>) ?: <span class="php-num">60</span> * <span class="php-num">60</span>);
</span><span class="l" id="137">137         }
</span><span class="l" id="138">138 
</span><span class="l" id="139">139         <span class="php-var">$jobs</span> = <span class="php-var">$sql</span>-&gt;getArray(<span class="php-var">$query</span>, [rex_sql::datetime(<span class="php-keyword2">time</span>() - <span class="php-var">$minExecutionStartDiff</span>), <span class="php-quote">'%|'</span> .<span class="php-var">$env</span>. <span class="php-quote">'|%'</span>, rex_sql::datetime()]);
</span><span class="l" id="140">140 
</span><span class="l" id="141">141         <span class="php-keyword1">if</span> (!<span class="php-var">$jobs</span>) {
</span><span class="l" id="142">142             <span class="php-var">$this</span>-&gt;saveNextTime();
</span><span class="l" id="143">143             <span class="php-keyword1">return</span>;
</span><span class="l" id="144">144         }
</span><span class="l" id="145">145 
</span><span class="l" id="146">146         <span class="php-keyword2">ignore_user_abort</span>(<span class="php-keyword1">true</span>);
</span><span class="l" id="147">147         <span class="php-keyword2">register_shutdown_function</span>(<span class="php-keyword1">function</span> () <span class="php-keyword1">use</span> (&amp;<span class="php-var">$jobs</span>) {
</span><span class="l" id="148">148             <span class="php-keyword1">foreach</span> (<span class="php-var">$jobs</span> <span class="php-keyword1">as</span> <span class="php-var">$job</span>) {
</span><span class="l" id="149">149                 <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$job</span>[<span class="php-quote">'finished'</span>])) {
</span><span class="l" id="150">150                     <span class="php-keyword1">continue</span>;
</span><span class="l" id="151">151                 }
</span><span class="l" id="152">152 
</span><span class="l" id="153">153                 <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$job</span>[<span class="php-quote">'started'</span>])) {
</span><span class="l" id="154">154                     <span class="php-var">$this</span>-&gt;setExecutionStart(<span class="php-var">$job</span>[<span class="php-quote">'id'</span>], <span class="php-keyword1">true</span>);
</span><span class="l" id="155">155                     <span class="php-keyword1">continue</span>;
</span><span class="l" id="156">156                 }
</span><span class="l" id="157">157 
</span><span class="l" id="158">158                 <span class="php-var">$manager</span> = <span class="php-var">$this</span>-&gt;getManager();
</span><span class="l" id="159">159                 <span class="php-var">$manager</span>-&gt;setCronjob(rex_cronjob::factory(<span class="php-var">$job</span>[<span class="php-quote">'type'</span>]));
</span><span class="l" id="160">160                 <span class="php-var">$manager</span>-&gt;<span class="php-keyword2">log</span>(<span class="php-keyword1">false</span>, <span class="php-keyword2">connection_status</span>() != <span class="php-num">0</span> ? <span class="php-quote">'Timeout'</span> : <span class="php-quote">'Unknown error'</span>);
</span><span class="l" id="161">161                 <span class="php-var">$this</span>-&gt;setNextTime(<span class="php-var">$job</span>[<span class="php-quote">'id'</span>], <span class="php-var">$job</span>[<span class="php-quote">'interval'</span>], <span class="php-keyword1">true</span>);
</span><span class="l" id="162">162             }
</span><span class="l" id="163">163 
</span><span class="l" id="164">164             <span class="php-var">$this</span>-&gt;saveNextTime();
</span><span class="l" id="165">165         });
</span><span class="l" id="166">166 
</span><span class="l" id="167">167         <span class="php-keyword1">foreach</span> (<span class="php-var">$jobs</span> <span class="php-keyword1">as</span> <span class="php-var">$job</span>) {
</span><span class="l" id="168">168             <span class="php-var">$this</span>-&gt;setExecutionStart(<span class="php-var">$job</span>[<span class="php-quote">'id'</span>]);
</span><span class="l" id="169">169         }
</span><span class="l" id="170">170 
</span><span class="l" id="171">171         <span class="php-keyword1">if</span> (<span class="php-var">$script</span> || <span class="php-num">1</span> == <span class="php-var">$jobs</span>[<span class="php-num">0</span>][<span class="php-quote">'execution_moment'</span>]) {
</span><span class="l" id="172">172             <span class="php-keyword1">foreach</span> (<span class="php-var">$jobs</span> <span class="php-keyword1">as</span> &amp;<span class="php-var">$job</span>) {
</span><span class="l" id="173">173                 <span class="php-var">$job</span>[<span class="php-quote">'started'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="174">174                 <span class="php-var">$this</span>-&gt;tryExecuteJob(<span class="php-var">$job</span>, <span class="php-keyword1">true</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="175">175                 <span class="php-var">$job</span>[<span class="php-quote">'finished'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="176">176             }
</span><span class="l" id="177">177             <span class="php-keyword1">return</span>;
</span><span class="l" id="178">178         }
</span><span class="l" id="179">179 
</span><span class="l" id="180">180         rex_extension::register(<span class="php-quote">'RESPONSE_SHUTDOWN'</span>, <span class="php-keyword1">function</span> () <span class="php-keyword1">use</span> (&amp;<span class="php-var">$jobs</span>) {
</span><span class="l" id="181">181             <span class="php-var">$job</span>[<span class="php-num">0</span>][<span class="php-quote">'started'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="182">182             <span class="php-var">$this</span>-&gt;tryExecuteJob(<span class="php-var">$jobs</span>[<span class="php-num">0</span>], <span class="php-keyword1">true</span>, <span class="php-keyword1">true</span>);
</span><span class="l" id="183">183             <span class="php-var">$job</span>[<span class="php-num">0</span>][<span class="php-quote">'finished'</span>] = <span class="php-keyword1">true</span>;
</span><span class="l" id="184">184         });
</span><span class="l" id="185">185     }
</span><span class="l" id="186">186 
</span><span class="l" id="187">187     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> tryExecute(<span class="php-var">$id</span>, <span class="php-var">$log</span> = <span class="php-keyword1">true</span>)
</span><span class="l" id="188">188     {
</span><span class="l" id="189">189         <span class="php-var">$sql</span> = rex_sql::factory();
</span><span class="l" id="190">190         <span class="php-var">$jobs</span> = <span class="php-var">$sql</span>-&gt;getArray(<span class="php-quote">'
</span></span><span class="l" id="191">191 <span class="php-quote">            SELECT    id, name, type, parameters, `interval`
</span></span><span class="l" id="192">192 <span class="php-quote">            FROM      '</span> . REX_CRONJOB_TABLE . <span class="php-quote">'
</span></span><span class="l" id="193">193 <span class="php-quote">            WHERE     id = ? AND environment LIKE ?
</span></span><span class="l" id="194">194 <span class="php-quote">            LIMIT     1
</span></span><span class="l" id="195">195 <span class="php-quote">        '</span>, [<span class="php-var">$id</span>, <span class="php-quote">'%|'</span> . rex_cronjob_manager::getCurrentEnvironment() . <span class="php-quote">'|%'</span>]);
</span><span class="l" id="196">196 
</span><span class="l" id="197">197         <span class="php-keyword1">if</span> (!<span class="php-var">$jobs</span>) {
</span><span class="l" id="198">198             <span class="php-var">$this</span>-&gt;getManager()-&gt;setMessage(<span class="php-quote">'Cronjob not found in database'</span>);
</span><span class="l" id="199">199             <span class="php-var">$this</span>-&gt;saveNextTime();
</span><span class="l" id="200">200             <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span class="l" id="201">201         }
</span><span class="l" id="202">202 
</span><span class="l" id="203">203         <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;tryExecuteJob(<span class="php-var">$jobs</span>[<span class="php-num">0</span>], <span class="php-var">$log</span>);
</span><span class="l" id="204">204     }
</span><span class="l" id="205">205 
</span><span class="l" id="206">206     <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> tryExecuteJob(<span class="php-keyword1">array</span> <span class="php-var">$job</span>, <span class="php-var">$log</span> = <span class="php-keyword1">true</span>, <span class="php-var">$resetExecutionStart</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="207">207     {
</span><span class="l" id="208">208         <span class="php-var">$params</span> = <span class="php-keyword2">json_decode</span>(<span class="php-var">$job</span>[<span class="php-quote">'parameters'</span>], <span class="php-keyword1">true</span>);
</span><span class="l" id="209">209         <span class="php-var">$cronjob</span> = rex_cronjob::factory(<span class="php-var">$job</span>[<span class="php-quote">'type'</span>]);
</span><span class="l" id="210">210 
</span><span class="l" id="211">211         <span class="php-var">$this</span>-&gt;setNextTime(<span class="php-var">$job</span>[<span class="php-quote">'id'</span>], <span class="php-var">$job</span>[<span class="php-quote">'interval'</span>], <span class="php-var">$resetExecutionStart</span>);
</span><span class="l" id="212">212 
</span><span class="l" id="213">213         <span class="php-var">$success</span> = <span class="php-var">$this</span>-&gt;getManager()-&gt;tryExecute(<span class="php-var">$cronjob</span>, <span class="php-var">$job</span>[<span class="php-quote">'name'</span>], <span class="php-var">$params</span>, <span class="php-var">$log</span>, <span class="php-var">$job</span>[<span class="php-quote">'id'</span>]);
</span><span class="l" id="214">214 
</span><span class="l" id="215">215         <span class="php-keyword1">return</span> <span class="php-var">$success</span>;
</span><span class="l" id="216">216     }
</span><span class="l" id="217">217 
</span><span class="l" id="218">218     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setNextTime(<span class="php-var">$id</span>, <span class="php-var">$interval</span>, <span class="php-var">$resetExecutionStart</span> = <span class="php-keyword1">false</span>)
</span><span class="l" id="219">219     {
</span><span class="l" id="220">220         <span class="php-var">$nexttime</span> = self::calculateNextTime(<span class="php-keyword2">json_decode</span>(<span class="php-var">$interval</span>, <span class="php-keyword1">true</span>));
</span><span class="l" id="221">221         <span class="php-var">$nexttime</span> = <span class="php-var">$nexttime</span> ? rex_sql::datetime(<span class="php-var">$nexttime</span>) : <span class="php-keyword1">null</span>;
</span><span class="l" id="222">222         <span class="php-var">$add</span> = <span class="php-var">$resetExecutionStart</span> ? <span class="php-quote">', execution_start = 0'</span> : <span class="php-quote">''</span>;
</span><span class="l" id="223">223         <span class="php-keyword1">try</span> {
</span><span class="l" id="224">224             <span class="php-var">$this</span>-&gt;sql-&gt;setQuery(<span class="php-quote">'
</span></span><span class="l" id="225">225 <span class="php-quote">                UPDATE  '</span> . REX_CRONJOB_TABLE . <span class="php-quote">'
</span></span><span class="l" id="226">226 <span class="php-quote">                SET     nexttime = ?'</span> . <span class="php-var">$add</span> . <span class="php-quote">'
</span></span><span class="l" id="227">227 <span class="php-quote">                WHERE   id = ?
</span></span><span class="l" id="228">228 <span class="php-quote">            '</span>, [<span class="php-var">$nexttime</span>, <span class="php-var">$id</span>]);
</span><span class="l" id="229">229             <span class="php-var">$success</span> = <span class="php-keyword1">true</span>;
</span><span class="l" id="230">230         } <span class="php-keyword1">catch</span> (rex_sql_exception <span class="php-var">$e</span>) {
</span><span class="l" id="231">231             <span class="php-var">$success</span> = <span class="php-keyword1">false</span>;
</span><span class="l" id="232">232         }
</span><span class="l" id="233">233         <span class="php-var">$this</span>-&gt;saveNextTime();
</span><span class="l" id="234">234         <span class="php-keyword1">return</span> <span class="php-var">$success</span>;
</span><span class="l" id="235">235     }
</span><span class="l" id="236">236 
</span><span class="l" id="237">237     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> getMinNextTime()
</span><span class="l" id="238">238     {
</span><span class="l" id="239">239         <span class="php-var">$this</span>-&gt;sql-&gt;setQuery(<span class="php-quote">'
</span></span><span class="l" id="240">240 <span class="php-quote">            SELECT  UNIX_TIMESTAMP(MIN(nexttime)) AS nexttime
</span></span><span class="l" id="241">241 <span class="php-quote">            FROM    '</span> . REX_CRONJOB_TABLE . <span class="php-quote">'
</span></span><span class="l" id="242">242 <span class="php-quote">            WHERE   status = 1
</span></span><span class="l" id="243">243 <span class="php-quote">        '</span>);
</span><span class="l" id="244">244         <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;sql-&gt;getRows() == <span class="php-num">1</span>) {
</span><span class="l" id="245">245             <span class="php-keyword1">return</span> (int) <span class="php-var">$this</span>-&gt;sql-&gt;getValue(<span class="php-quote">'nexttime'</span>);
</span><span class="l" id="246">246         }
</span><span class="l" id="247">247         <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="248">248     }
</span><span class="l" id="249">249 
</span><span class="l" id="250">250     <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> saveNextTime(<span class="php-var">$nexttime</span> = <span class="php-keyword1">null</span>)
</span><span class="l" id="251">251     {
</span><span class="l" id="252">252         <span class="php-keyword1">if</span> (<span class="php-var">$nexttime</span> === <span class="php-keyword1">null</span>) {
</span><span class="l" id="253">253             <span class="php-var">$nexttime</span> = <span class="php-var">$this</span>-&gt;getMinNextTime();
</span><span class="l" id="254">254         }
</span><span class="l" id="255">255         <span class="php-keyword1">if</span> (<span class="php-var">$nexttime</span> === <span class="php-keyword1">null</span>) {
</span><span class="l" id="256">256             <span class="php-var">$nexttime</span> = <span class="php-num">0</span>;
</span><span class="l" id="257">257         } <span class="php-keyword1">else</span> {
</span><span class="l" id="258">258             <span class="php-var">$nexttime</span> = <span class="php-keyword2">max</span>(<span class="php-num">1</span>, <span class="php-var">$nexttime</span>);
</span><span class="l" id="259">259         }
</span><span class="l" id="260">260 
</span><span class="l" id="261">261         rex_config::set(<span class="php-quote">'cronjob'</span>, <span class="php-quote">'nexttime'</span>, <span class="php-var">$nexttime</span>);
</span><span class="l" id="262">262         <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span class="l" id="263">263     }
</span><span class="l" id="264">264 
</span><span class="l" id="265">265     <span class="php-keyword1">public</span> <span class="php-keyword1">static</span> <span class="php-keyword1">function</span> calculateNextTime(<span class="php-keyword1">array</span> <span class="php-var">$interval</span>)
</span><span class="l" id="266">266     {
</span><span class="l" id="267">267         <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$interval</span>[<span class="php-quote">'minutes'</span>]) || <span class="php-keyword1">empty</span>(<span class="php-var">$interval</span>[<span class="php-quote">'hours'</span>]) || <span class="php-keyword1">empty</span>(<span class="php-var">$interval</span>[<span class="php-quote">'days'</span>]) || <span class="php-keyword1">empty</span>(<span class="php-var">$interval</span>[<span class="php-quote">'weekdays'</span>]) || <span class="php-keyword1">empty</span>(<span class="php-var">$interval</span>[<span class="php-quote">'months'</span>])) {
</span><span class="l" id="268">268             <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
</span><span class="l" id="269">269         }
</span><span class="l" id="270">270 
</span><span class="l" id="271">271         <span class="php-var">$date</span> = <span class="php-keyword1">new</span> \DateTime(<span class="php-quote">'+5 min'</span>);
</span><span class="l" id="272">272         <span class="php-var">$date</span>-&gt;setTime(<span class="php-var">$date</span>-&gt;format(<span class="php-quote">'H'</span>), <span class="php-keyword2">floor</span>(<span class="php-var">$date</span>-&gt;format(<span class="php-quote">'i'</span>) / <span class="php-num">5</span>) * <span class="php-num">5</span>, <span class="php-num">0</span>);
</span><span class="l" id="273">273 
</span><span class="l" id="274">274         <span class="php-var">$isValid</span> = <span class="php-keyword1">function</span> (<span class="php-var">$value</span>, <span class="php-var">$current</span>) {
</span><span class="l" id="275">275             <span class="php-keyword1">return</span> <span class="php-quote">'all'</span> === <span class="php-var">$value</span> || <span class="php-keyword2">in_array</span>(<span class="php-var">$current</span>, <span class="php-var">$value</span>);
</span><span class="l" id="276">276         };
</span><span class="l" id="277">277 
</span><span class="l" id="278">278         <span class="php-var">$validateTime</span> = <span class="php-keyword1">function</span> () <span class="php-keyword1">use</span> (<span class="php-var">$interval</span>, <span class="php-var">$date</span>, <span class="php-var">$isValid</span>) {
</span><span class="l" id="279">279             <span class="php-keyword1">while</span> (!<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'hours'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'G'</span>))) {
</span><span class="l" id="280">280                 <span class="php-var">$date</span>-&gt;modify(<span class="php-quote">'+1 hour'</span>);
</span><span class="l" id="281">281                 <span class="php-var">$date</span>-&gt;setTime(<span class="php-var">$date</span>-&gt;format(<span class="php-quote">'H'</span>), <span class="php-num">0</span>, <span class="php-num">0</span>);
</span><span class="l" id="282">282             }
</span><span class="l" id="283">283 
</span><span class="l" id="284">284             <span class="php-keyword1">while</span> (!<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'minutes'</span>], (int) <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'i'</span>))) {
</span><span class="l" id="285">285                 <span class="php-var">$date</span>-&gt;modify(<span class="php-quote">'+5 min'</span>);
</span><span class="l" id="286">286 
</span><span class="l" id="287">287                 <span class="php-keyword1">while</span> (!<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'hours'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'G'</span>))) {
</span><span class="l" id="288">288                     <span class="php-var">$date</span>-&gt;modify(<span class="php-quote">'+1 hour'</span>);
</span><span class="l" id="289">289                     <span class="php-var">$date</span>-&gt;setTime(<span class="php-var">$date</span>-&gt;format(<span class="php-quote">'H'</span>), <span class="php-num">0</span>, <span class="php-num">0</span>);
</span><span class="l" id="290">290                 }
</span><span class="l" id="291">291             }
</span><span class="l" id="292">292         };
</span><span class="l" id="293">293 
</span><span class="l" id="294">294         <span class="php-var">$validateTime</span>();
</span><span class="l" id="295">295 
</span><span class="l" id="296">296         <span class="php-keyword1">if</span> (
</span><span class="l" id="297">297             !<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'days'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'j'</span>)) ||
</span><span class="l" id="298">298             !<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'weekdays'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'w'</span>)) ||
</span><span class="l" id="299">299             !<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'months'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'n'</span>))
</span><span class="l" id="300">300         ) {
</span><span class="l" id="301">301             <span class="php-var">$date</span>-&gt;setTime(<span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-num">0</span>);
</span><span class="l" id="302">302             <span class="php-var">$validateTime</span>();
</span><span class="l" id="303">303 
</span><span class="l" id="304">304             <span class="php-keyword1">while</span> (!<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'months'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'n'</span>))) {
</span><span class="l" id="305">305                 <span class="php-var">$date</span>-&gt;modify(<span class="php-quote">'first day of next month'</span>);
</span><span class="l" id="306">306             }
</span><span class="l" id="307">307 
</span><span class="l" id="308">308             <span class="php-keyword1">while</span> (!<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'days'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'j'</span>)) || !<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'weekdays'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'w'</span>))) {
</span><span class="l" id="309">309                 <span class="php-var">$date</span>-&gt;modify(<span class="php-quote">'+1 day'</span>);
</span><span class="l" id="310">310 
</span><span class="l" id="311">311                 <span class="php-keyword1">while</span> (!<span class="php-var">$isValid</span>(<span class="php-var">$interval</span>[<span class="php-quote">'months'</span>], <span class="php-var">$date</span>-&gt;format(<span class="php-quote">'n'</span>))) {
</span><span class="l" id="312">312                     <span class="php-var">$date</span>-&gt;modify(<span class="php-quote">'first day of next month'</span>);
</span><span class="l" id="313">313                 }
</span><span class="l" id="314">314             }
</span><span class="l" id="315">315         }
</span><span class="l" id="316">316 
</span><span class="l" id="317">317         <span class="php-keyword1">return</span> <span class="php-var">$date</span>-&gt;getTimestamp();
</span><span class="l" id="318">318     }
</span><span class="l" id="319">319 }
</span><span class="l" id="320">320 </span></code></pre>
 </body>
</html>
